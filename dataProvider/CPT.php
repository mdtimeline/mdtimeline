<?php

/**
 * GaiaEHR (Electronic Health Records)
 * Copyright (C) 2013 Certun, LLC.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
class CPT {

	/**
	 * @var bool|MatchaCUP
	 */
	private $c;
	private $cm;

	function __construct() {
        if($this->c == NULL)
            $this->c = MatchaModel::setSenchaModel('App.model.administration.CPT');
            $this->cm = MatchaModel::setSenchaModel('App.model.administration.CPTmap');
	}

	public function getCPTs($params){
		if(
			(isset($params->query) && $params->query != '') ||
			(isset($params->radiology_query) && $params->radiology_query != '') )
		{
			return $this->query($params);
		}
		return $this->c->load($params)->all();
	}

	public function getCPT($params){
		return $this->c->load($params)->one();
	}

	public function addCPT($params){
		return $this->c->save($params);
	}

	public function updateCPT($params){
		return $this->c->save($params);
	}

	public function deleteCPT($params){
		return $this->c->destroy($params);
	}

    public function getCptByCode($code){
       return $this->c->load(['code' => $code])->one();
    }

    public function getCptMapByCode($code){
       return $this->cm->load(['code' => $code])->one();
    }

    public function getMappedCodeByCpt($cpt){
        return $this->cm->load(['cpt_code' => $cpt])->one();
    }

    public function getMappedCodeByCptAndModifier($cpt, $modifier = null){
        return $this->cm->load(['cpt_code' => $cpt, 'modifier' => $modifier])->one();
    }

	public function query($params){

		if(isset($params->radiology_query)){
			$query = $params->radiology_query;
		} elseif(isset($params->query)){
			$query = $params->query;
		} else{
			$query = '';
		}

		$sql = "SELECT *,
					   'CPT4' as `code_type` 
				  FROM `cpt_codes` 
				 WHERE `isRadiology` = '1' AND
				   	   `active` = '1' AND 
				 	  ( `code` LIKE :cpt_code OR
				 	  	`code_text_medium` LIKE :code_text_medium)";

		$records = $this->c->sql($sql)->all([
			':cpt_code' => $query.'%',
			':code_text_medium' => '%'.$query.'%'
		]);
		return array(
			'total' => count($records),
		    'data' => array_slice($records, $params->start, $params->limit)
		);
	}

	public function radCodes(){

		$codes = [
			'23350',
			'24220',
			'25246',
			'27093',
			'27095',
			'27370',
			'70100',
			'70110',
			'70130',
			'70150',
			'70160',
			'70200',
			'70210',
			'70220',
			'70240',
			'70250',
			'70260',
			'70328',
			'70330',
			'70336',
			'70360',
			'70450',
			'70460',
			'70470',
			'70480',
			'70481',
			'70482',
			'70486',
			'70487',
			'70488',
			'70490',
			'70491',
			'70492',
			'70496',
			'70498',
			'70540',
			'70542',
			'70543',
			'70544',
			'70545',
			'70547',
			'70548',
			'70549',
			'70551',
			'70552',
			'70553',
			'70559',
			'71010',
			'71020',
			'71021',
			'71022',
			'71030',
			'71035',
			'71101',
			'71110',
			'71111',
			'71120',
			'71130',
			'71250',
			'71260',
			'71270',
			'71275',
			'71550',
			'71551',
			'71552',
			'71555',
			'72010',
			'72040',
			'72050',
			'72052',
			'72069',
			'72070',
			'72074',
			'72080',
			'72090',
			'72100',
			'72110',
			'72125',
			'72126',
			'72127',
			'72128',
			'72129',
			'72130',
			'72131',
			'72132',
			'72133',
			'72141',
			'72142',
			'72146',
			'72147',
			'72148',
			'72149',
			'72156',
			'72157',
			'72158',
			'72170',
			'72190',
			'72191',
			'72192',
			'72193',
			'72194',
			'72195',
			'72196',
			'72197',
			'72198',
			'72200',
			'72220',
			'73000',
			'73010',
			'73030',
			'73060',
			'73070',
			'73090',
			'73100',
			'73120',
			'73140',
			'73200',
			'73202',
			'73218',
			'73219',
			'73220',
			'73221',
			'73222',
			'73223',
			'73225',
			'73500',
			'73510',
			'73520',
			'73550',
			'73560',
			'73562',
			'73564',
			'73565',
			'73590',
			'73600',
			'73610',
			'73620',
			'73630',
			'73650',
			'73700',
			'73701',
			'73702',
			'73706',
			'73718',
			'73719',
			'73720',
			'73721',
			'73722',
			'73723',
			'73725',
			'74000',
			'74010',
			'74020',
			'74022',
			'74150',
			'74160',
			'74170',
			'74174',
			'74175',
			'74176',
			'74177',
			'74178',
			'74181',
			'74182',
			'74183',
			'74185',
			'74261',
			'75557',
			'75561',
			'75574',
			'75635',
			'76140',
			'76360',
			'76376',
			'76377',
			'76390',
			'76506',
			'76536',
			'76604',
			'76645',
			'76700',
			'76705',
			'76770',
			'76775',
			'76801',
			'76802',
			'76805',
			'76810',
			'76811',
			'76812',
			'76815',
			'76816',
			'76817',
			'76818',
			'76830',
			'76856',
			'76857',
			'76870',
			'76872',
			'76880',
			'76881',
			'76882',
			'76940',
			'76942',
			'76946',
			'77012',
			'77014',
			'77072',
			'77073',
			'77074',
			'77075',
			'77076',
			'77080',
			'77081',
			'78000',
			'78001',
			'78003',
			'78006',
			'78007',
			'78010',
			'78011',
			'78012',
			'78013',
			'78014',
			'78015',
			'78016',
			'78018',
			'78020',
			'78070',
			'78071',
			'78072',
			'78075',
			'78099',
			'78102',
			'78103',
			'78104',
			'78110',
			'78111',
			'78120',
			'78121',
			'78122',
			'78130',
			'78135',
			'78140',
			'78185',
			'78190',
			'78191',
			'78195',
			'78199',
			'78201',
			'78202',
			'78205',
			'78206',
			'78215',
			'78216',
			'78223',
			'78226',
			'78227',
			'78230',
			'78231',
			'78232',
			'78252',
			'78258',
			'78261',
			'78262',
			'78264',
			'78267',
			'78268',
			'78270',
			'78271',
			'78272',
			'78278',
			'78282',
			'78290',
			'78291',
			'78299',
			'78300',
			'78305',
			'78306',
			'78315',
			'78320',
			'78350',
			'78351',
			'78399',
			'78414',
			'78428',
			'78445',
			'78451',
			'78452',
			'78453',
			'78454',
			'78456',
			'78457',
			'78458',
			'78459',
			'78460',
			'78461',
			'78465',
			'78466',
			'78468',
			'78469',
			'78472',
			'78473',
			'78478',
			'78480',
			'78481',
			'78483',
			'78491',
			'78492',
			'78494',
			'78496',
			'78499',
			'78579',
			'78580',
			'78582',
			'78584',
			'78586',
			'78587',
			'78591',
			'78593',
			'78594',
			'78596',
			'78597',
			'78598',
			'78599',
			'78600',
			'78601',
			'78605',
			'78606',
			'78607',
			'78608',
			'78609',
			'78610',
			'78615',
			'78630',
			'78635',
			'78645',
			'78647',
			'78650',
			'78660',
			'78699',
			'78700',
			'78701',
			'78704',
			'78707',
			'78708',
			'78709',
			'78710',
			'78715',
			'78725',
			'78726',
			'78730',
			'78740',
			'78761',
			'78799',
			'78800',
			'78801',
			'78802',
			'78803',
			'78804',
			'78805',
			'78806',
			'78807',
			'78808',
			'78811',
			'78812',
			'78813',
			'78814',
			'78815',
			'78816',
			'78999',
			'79001',
			'79005',
			'79101',
			'79200',
			'79300',
			'79403',
			'79440',
			'79999',
			'93015',
			'93325',
			'93880',
			'93880',
			'93925',
			'93925',
			'93926',
			'93930',
			'93930',
			'93931',
			'93970',
			'93970',
			'93971',
			'93975',
			'93975',
			'93976',
			'93978',
			'96372',
			'99070',
			'99201',
			'99203',
			'99205',
			'99211',
			'99214',
			'99215',
			'99241',
			'99243',
			'99245',
			'99281',
			'99285',
			'A9517',
			'3570F',
			'A4641',
			'A4642',
			'A9500',
			'A9502',
			'A9503',
			'A9504',
			'A9505',
			'A9507',
			'A9510',
			'A9512',
			'A9517',
			'A9521',
			'A9528',
			'A9530',
			'A9531',
			'A9537',
			'A9538',
			'A9539',
			'A9540',
			'A9541',
			'A9548',
			'A9549',
			'A9551',
			'A9552',
			'A9556',
			'A9557',
			'A9559',
			'A9560',
			'A9561',
			'A9562',
			'A9567',
			'A9569',
			'A9570',
			'A9572',
			'A9579',
			'A9579',
			'A9581',
			'A9581',
			'A9582',
			'A9600',
			'A9717',
			'G0202',
			'G0204',
			'G0206',
			'G8961',
			'G8962',
			'G8963',
			'G8964',
			'G8965',
			'G8966',
			'J0150',
			'J0151',
			'J0152',
			'J0280',
			'J0461',
			'J1120',
			'J1245',
			'J1250',
			'J1940',
			'J2785',
			'J2805',
			'J3240',
			'Q9967',
			'Q9967',
			'Q9969',
		];
		$conn = Matcha::getConn();
		foreach($codes as $code){
			$conn->exec("UPDATE cpt_codes SET isRadiology = 1 WHERE code = '{$code}' ");
		}
	}
}