DROP PROCEDURE IF EXISTS `getDiabetesMedicalAttentionForNephropathyReportByDates`;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `getDiabetesMedicalAttentionForNephropathyReportByDates`(IN provider_id INT, IN insurance_id INT, IN start_date DATE, IN end_date DATE, IN sex CHAR, IN ethnicity VARCHAR(40), IN race VARCHAR(40))
BEGIN



    DROP TABLE IF EXISTS report_ds;
    DROP TABLE IF EXISTS report_denominator_ds;
    DROP TABLE IF EXISTS report_numerator_ds;


#     SET @provider_id = 2619;
#     SET @insurance_id = 1;
#     SET @start_date = '2020-01-01';
#     SET @end_date = '2024-01-01';

    SET @provider = (SELECT CONCAT(title, ' ', lname, ', ', fname, ' ', mname, ' (NPI:', npi, ')') FROM users WHERE id = provider_id);
    SET @insurance = (SELECT CONCAT(name, ' ', ' (CODE:', insurance_companies.code, ')') FROM insurance_companies WHERE id = insurance_id);

    IF insurance_id > 0
    THEN
        CREATE TEMPORARY TABLE report_ds
        SELECT e.eid,
               e.pid,
               IF (e.lab_order_code IS NOT NULL, '1', '0') AS has_nephropaty_screening,
               IF (e.nephropathy_dx IS NOT NULL, '1', '0') AS has_nephropaty_dx,
               IF (e.medication_code IS NOT NULL, '1', '0') AS was_prescribed_or_active
        FROM (
                 SELECT enc.pid, enc.eid, po.code as lab_order_code, edx1.code as nephropathy_dx, pm.RXCUI as medication_code
                 FROM encounters as enc
                    INNER JOIN patient p ON enc.pid = p.pid
                    LEFT JOIN patient_insurances AS pi ON p.pid = pi.pid
                    INNER JOIN encounter_dx as edx ON enc.eid = edx.eid AND enc.pid = edx.pid
                    LEFT JOIN encounter_dx as edx1 ON enc.eid = edx1.eid AND enc.pid = edx1.pid AND edx1.code IN (
                    'I12.0','I12.9','I13.0','I13.10','I13.11','I13.2','I15.0','I15.1', 'N17.0','N17.1','N17.2','N17.8',
                    'N17.9','N18.1','N18.2','N18.3','N18.30','N18.31','N18.32','N18.4','N18.5','N18.6','N18.9','N19',
                    'N00.0','N00.1','N00.2','N00.3','N00.4','N00.5','N00.6','N00.7','N00.8','N00.9','N00.A','N01.0',
                    'N01.1','N01.2','N01.3','N01.4','N01.5','N01.6','N01.7','N01.8','N01.9','N01.A','N02.0','N02.1',
                    'N02.2','N02.3','N02.4','N02.5','N02.6','N02.7','N02.8','N02.9','N02.A','N03.0','N03.1','N03.2',
                    'N03.3','N03.4','N03.5','N03.6','N03.7','N03.8','N03.9','N03.A','N04.0','N04.1','N04.2','N04.3',
                    'N04.4','N04.5','N04.6','N04.7','N04.8','N04.9','N04.A','N05.0','N05.1','N05.2','N05.3','N05.4',
                    'N05.5','N05.6','N05.7','N05.8','N05.9','N05.A','N06.0','N06.1','N06.2','N06.3','N06.4','N06.5',
                    'N06.6','N06.7','N06.8','N06.9','N06.A','N07.0','N07.1','N07.2','N07.3','N07.4','N07.5','N07.6',
                    'N07.7','N07.8','N07.9','N07.A','N08','N14.0','N14.1','N14.2','N14.3','N14.4','N25.0','N25.1',
                    'N25.81','N25.89','N25.9','N26.1','N26.2','N26.9','Q60.0','Q60.1','Q60.2','Q60.3','Q60.4','Q60.5',
                    'Q60.6','Q61.00','Q61.01','Q61.02','Q61.11','Q61.19','Q61.2','Q61.3','Q61.4','Q61.5','Q61.8',
                    'Q61.9','E08.21','E08.22','E08.29','E09.21','E09.22','E09.29','E10.21','E10.22','E10.29','E11.21',
                    'E11.22','E11.29','E13.21','E13.22','E13.29','R80.1','R80.8','R80.9'
                    )
                    LEFT JOIN patient_orders as po ON enc.eid = po.eid AND enc.pid = po.pid AND po.code IN (
                    '11218-5','12842-1','13705-9','13801-6','13986-5','13992-3','14956-7','14957-5','14958-3',
                    '14959-1','1753-3','1754-1','1755-8','1757-4','17819-4','18373-1','20454-5','20621-9',
                    '21059-1','21482-5','26801-1','27298-9','2887-8','2888-6','2889-4','2890-2','29946-1',
                    '30000-4','30001-2','30003-8','32209-9','32294-1','32551-4','34366-5','35663-4','40486-3',
                    '40662-9','40663-7','43605-5','43606-3','43607-1','44292-1','47558-2','49002-9','49023-5',
                    '50209-6','50561-0','50949-7','51190-7','53121-0','53525-2','53530-2','53531-0','53532-8',
                    '56553-1','57369-1','57735-3','5804-0','58448-2','58992-9','59159-4','60678-0','63474-1',
                    '6941-9','6942-7','76401-9','77253-3','77254-1','77940-5','89998-9','89999-7','90000-1',
                    '9318-7','93746-6','95232-5','95233-3'
                    )
                    LEFT JOIN patient_medications AS pm ON enc.pid = pm.pid AND ((pm.date_ordered BETWEEN start_date AND end_date)
                    OR (pm.is_active AND pm.begin_date BETWEEN start_date AND end_date))
                    AND pm.RXCUI IN (
                    '1000001','1091646','1091652','1235144','1235151','1299859','1299871','1299890','1299896',
                    '1299897','1435624','153822','153823','1600716','1600724','1600728','1656340','1656349',
                    '1656354','197436','197437','197438','197439','197884','197885','197886','197887','198188',
                    '198189','199351','199352','199353','200094','200095','200096','200284','200285','205304',
                    '205305','205326','261962','282755','283316','283317','308962','308963','308964','310140',
                    '310792','310793','310796','310797','310809','311353','311354','312748','312749','312750',
                    '314076','314077','314203','317173','349199','349200','349201','349353','349373','349401',
                    '349405','349483','351292','351293','403853','403854','403855','477130','485471','577776',
                    '578325','578330','636042','636045','639537','722126','722131','722134','722137','730861',
                    '730866','730869','730872','802749','845488','848131','848135','848140','848145','848151',
                    '854925','854984','854988','857166','857169','857174','857183','857187','858804','858810',
                    '858813','858817','858824','858828','876514','876519','876524','876529','897781','897783',
                    '897844','897853','898342','898346','898350','898353','898356','898359','898362','898367',
                    '898372','898378','898687','898690','898719','898723','979464','979468','979471','979480',
                    '979485','979492','999967','999986','999991','999996'
                         )
              WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND enc.close_date IS NOT NULL
                AND pi.insurance_id = insurance_id
                AND (sex IS NULL OR p.sex = sex)
                AND (ethnicity IS NULL OR p.ethnicity = ethnicity)
                AND (race IS NULL OR p.race = race)
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) >= 18
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) <= 75
                AND edx.dx_type = 'F'
                AND edx.code IN ('E10.10','E10.11','E10.21','E10.22','E10.29','E10.311','E10.319','E10.321','E10.3211',
                                 'E10.3212','E10.3213','E10.3219','E10.329','E10.3291','E10.3292','E10.3293','E10.3299',
                                 'E10.331','E10.3311','E10.3312','E10.3313','E10.3319','E10.339','E10.3391','E10.3392',
                                 'E10.3393','E10.3399','E10.341','E10.3411','E10.3412','E10.3413','E10.3419','E10.349',
                                 'E10.3491','E10.3492','E10.3493','E10.3499','E10.351','E10.3511','E10.3512','E10.3513',
                                 'E10.3519','E10.3521','E10.3522','E10.3523','E10.3529','E10.3531','E10.3532','E10.3533',
                                 'E10.3539','E10.3541','E10.3542','E10.3543','E10.3549','E10.3551','E10.3552','E10.3553',
                                 'E10.3559','E10.359','E10.3591','E10.3592','E10.3593','E10.3599','E10.36','E10.37X1',
                                 'E10.37X2','E10.37X3','E10.37X9','E10.39','E10.40','E10.41','E10.42','E10.43','E10.44',
                                 'E10.49','E10.51','E10.52','E10.59','E10.610','E10.618','E10.620','E10.621','E10.622',
                                 'E10.628','E10.630','E10.638','E10.641','E10.649','E10.65','E10.69','E10.8','E10.9',
                                 'E11.00','E11.01','E11.10','E11.11','E11.21','E11.22','E11.29','E11.311','E11.319',
                                 'E11.321','E11.3211','E11.3212','E11.3213','E11.3219','E11.329','E11.3291','E11.3292',
                                 'E11.3293','E11.3299','E11.331','E11.3311','E11.3312','E11.3313','E11.3319','E11.339',
                                 'E11.3391','E11.3392','E11.3393','E11.3399','E11.341','E11.3411','E11.3412','E11.3413',
                                 'E11.3419','E11.349','E11.3491','E11.3492','E11.3493','E11.3499','E11.351','E11.3511',
                                 'E11.3512','E11.3513','E11.3519','E11.3521','E11.3522','E11.3523','E11.3529','E11.3531',
                                 'E11.3532','E11.3533','E11.3539','E11.3541','E11.3542','E11.3543','E11.3549','E11.3551',
                                 'E11.3552','E11.3553','E11.3559','E11.359','E11.3591','E11.3592','E11.3593','E11.3599',
                                 'E11.36','E11.37X1','E11.37X2','E11.37X3','E11.37X9','E11.39','E11.40','E11.41','E11.42',
                                 'E11.43','E11.44','E11.49','E11.51','E11.52','E11.59','E11.610','E11.618','E11.620',
                                 'E11.621','E11.622','E11.628','E11.630','E11.638','E11.641','E11.649','E11.65','E11.69',
                                 'E11.8','E11.9','E13.00','E13.01','E13.10','E13.11','E13.21','E13.22','E13.29','E13.311',
                                 'E13.319','E13.321','E13.3211','E13.3212','E13.3213','E13.3219','E13.329','E13.3291',
                                 'E13.3292','E13.3293','E13.3299','E13.331','E13.3311','E13.3312','E13.3313','E13.3319',
                                 'E13.339','E13.3391','E13.3392','E13.3393','E13.3399','E13.341','E13.3411','E13.3412',
                                 'E13.3413','E13.3419','E13.349','E13.3491','E13.3492','E13.3493','E13.3499','E13.351',
                                 'E13.3511','E13.3512','E13.3513','E13.3519','E13.3521','E13.3522','E13.3523','E13.3529',
                                 'E13.3531','E13.3532','E13.3533','E13.3539','E13.3541','E13.3542','E13.3543','E13.3549',
                                 'E13.3551','E13.3552','E13.3553','E13.3559','E13.359','E13.3591','E13.3592','E13.3593',
                                 'E13.3599','E13.36','E13.37X1','E13.37X2','E13.37X3','E13.37X9','E13.39','E13.40',
                                 'E13.41','E13.42','E13.43','E13.44','E13.49','E13.51','E13.52','E13.59','E13.610',
                                 'E13.618','E13.620','E13.621','E13.622','E13.628','E13.630','E13.638','E13.641','E13.649',
                                 'E13.65','E13.69','E13.8','E13.9','O24.011','O24.012','O24.013','O24.019','O24.02','O24.03',
                                 'O24.111','O24.112','O24.113','O24.119','O24.12','O24.13','O24.311','O24.312','O24.313',
                                 'O24.319','O24.32','O24.33','O24.811','O24.812','O24.813','O24.819','O24.82','O24.83'))e;

    ELSE
        CREATE TEMPORARY TABLE report_ds
        SELECT e.eid,
               e.pid,
               IF (e.lab_order_code IS NOT NULL, '1', '0') AS has_nephropaty_screening,
               IF (e.nephropathy_dx IS NOT NULL, '1', '0') AS has_nephropaty_dx,
               IF (e.medication_code IS NOT NULL, '1', '0') AS was_prescribed_or_active
        FROM (
              SELECT enc.pid, enc.eid, po.code as lab_order_code, edx1.code as nephropathy_dx, pm.RXCUI as medication_code
              FROM encounters as enc
                  INNER JOIN patient p ON enc.pid = p.pid
                  INNER JOIN encounter_dx as edx ON enc.eid = edx.eid AND enc.pid = edx.pid
                  LEFT JOIN encounter_dx as edx1 ON enc.eid = edx1.eid AND enc.pid = edx1.pid AND edx1.code IN (
                  'I12.0','I12.9','I13.0','I13.10','I13.11','I13.2','I15.0','I15.1', 'N17.0','N17.1','N17.2','N17.8',
                  'N17.9','N18.1','N18.2','N18.3','N18.30','N18.31','N18.32','N18.4','N18.5','N18.6','N18.9','N19',
                  'N00.0','N00.1','N00.2','N00.3','N00.4','N00.5','N00.6','N00.7','N00.8','N00.9','N00.A','N01.0',
                  'N01.1','N01.2','N01.3','N01.4','N01.5','N01.6','N01.7','N01.8','N01.9','N01.A','N02.0','N02.1',
                  'N02.2','N02.3','N02.4','N02.5','N02.6','N02.7','N02.8','N02.9','N02.A','N03.0','N03.1','N03.2',
                  'N03.3','N03.4','N03.5','N03.6','N03.7','N03.8','N03.9','N03.A','N04.0','N04.1','N04.2','N04.3',
                  'N04.4','N04.5','N04.6','N04.7','N04.8','N04.9','N04.A','N05.0','N05.1','N05.2','N05.3','N05.4',
                  'N05.5','N05.6','N05.7','N05.8','N05.9','N05.A','N06.0','N06.1','N06.2','N06.3','N06.4','N06.5',
                  'N06.6','N06.7','N06.8','N06.9','N06.A','N07.0','N07.1','N07.2','N07.3','N07.4','N07.5','N07.6',
                  'N07.7','N07.8','N07.9','N07.A','N08','N14.0','N14.1','N14.2','N14.3','N14.4','N25.0','N25.1',
                  'N25.81','N25.89','N25.9','N26.1','N26.2','N26.9','Q60.0','Q60.1','Q60.2','Q60.3','Q60.4','Q60.5',
                  'Q60.6','Q61.00','Q61.01','Q61.02','Q61.11','Q61.19','Q61.2','Q61.3','Q61.4','Q61.5','Q61.8',
                  'Q61.9','E08.21','E08.22','E08.29','E09.21','E09.22','E09.29','E10.21','E10.22','E10.29','E11.21',
                  'E11.22','E11.29','E13.21','E13.22','E13.29','R80.1','R80.8','R80.9'
                  )
                  LEFT JOIN patient_orders as po ON enc.eid = po.eid AND enc.pid = po.pid AND po.code IN (
                  '11218-5','12842-1','13705-9','13801-6','13986-5','13992-3','14956-7','14957-5','14958-3',
                  '14959-1','1753-3','1754-1','1755-8','1757-4','17819-4','18373-1','20454-5','20621-9',
                  '21059-1','21482-5','26801-1','27298-9','2887-8','2888-6','2889-4','2890-2','29946-1',
                  '30000-4','30001-2','30003-8','32209-9','32294-1','32551-4','34366-5','35663-4','40486-3',
                  '40662-9','40663-7','43605-5','43606-3','43607-1','44292-1','47558-2','49002-9','49023-5',
                  '50209-6','50561-0','50949-7','51190-7','53121-0','53525-2','53530-2','53531-0','53532-8',
                  '56553-1','57369-1','57735-3','5804-0','58448-2','58992-9','59159-4','60678-0','63474-1',
                  '6941-9','6942-7','76401-9','77253-3','77254-1','77940-5','89998-9','89999-7','90000-1',
                  '9318-7','93746-6','95232-5','95233-3'
                  )
                  LEFT JOIN patient_medications AS pm ON enc.pid = pm.pid AND ((pm.date_ordered BETWEEN start_date AND end_date)
                  OR (pm.is_active AND pm.begin_date BETWEEN start_date AND end_date))
                  AND pm.RXCUI IN (
                  '1000001','1091646','1091652','1235144','1235151','1299859','1299871','1299890','1299896',
                  '1299897','1435624','153822','153823','1600716','1600724','1600728','1656340','1656349',
                  '1656354','197436','197437','197438','197439','197884','197885','197886','197887','198188',
                  '198189','199351','199352','199353','200094','200095','200096','200284','200285','205304',
                  '205305','205326','261962','282755','283316','283317','308962','308963','308964','310140',
                  '310792','310793','310796','310797','310809','311353','311354','312748','312749','312750',
                  '314076','314077','314203','317173','349199','349200','349201','349353','349373','349401',
                  '349405','349483','351292','351293','403853','403854','403855','477130','485471','577776',
                  '578325','578330','636042','636045','639537','722126','722131','722134','722137','730861',
                  '730866','730869','730872','802749','845488','848131','848135','848140','848145','848151',
                  '854925','854984','854988','857166','857169','857174','857183','857187','858804','858810',
                  '858813','858817','858824','858828','876514','876519','876524','876529','897781','897783',
                  '897844','897853','898342','898346','898350','898353','898356','898359','898362','898367',
                  '898372','898378','898687','898690','898719','898723','979464','979468','979471','979480',
                  '979485','979492','999967','999986','999991','999996'
                  )
              WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND enc.close_date IS NOT NULL
                AND (sex IS NULL OR p.sex = sex)
                AND (ethnicity IS NULL OR p.ethnicity = ethnicity)
                AND (race IS NULL OR p.race = race)
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) >= 18
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) <= 75
                AND edx.dx_type = 'F'
                AND edx.code IN ('E10.10','E10.11','E10.21','E10.22','E10.29','E10.311','E10.319','E10.321','E10.3211',
                  'E10.3212','E10.3213','E10.3219','E10.329','E10.3291','E10.3292','E10.3293','E10.3299',
                  'E10.331','E10.3311','E10.3312','E10.3313','E10.3319','E10.339','E10.3391','E10.3392',
                  'E10.3393','E10.3399','E10.341','E10.3411','E10.3412','E10.3413','E10.3419','E10.349',
                  'E10.3491','E10.3492','E10.3493','E10.3499','E10.351','E10.3511','E10.3512','E10.3513',
                  'E10.3519','E10.3521','E10.3522','E10.3523','E10.3529','E10.3531','E10.3532','E10.3533',
                  'E10.3539','E10.3541','E10.3542','E10.3543','E10.3549','E10.3551','E10.3552','E10.3553',
                  'E10.3559','E10.359','E10.3591','E10.3592','E10.3593','E10.3599','E10.36','E10.37X1',
                  'E10.37X2','E10.37X3','E10.37X9','E10.39','E10.40','E10.41','E10.42','E10.43','E10.44',
                  'E10.49','E10.51','E10.52','E10.59','E10.610','E10.618','E10.620','E10.621','E10.622',
                  'E10.628','E10.630','E10.638','E10.641','E10.649','E10.65','E10.69','E10.8','E10.9',
                  'E11.00','E11.01','E11.10','E11.11','E11.21','E11.22','E11.29','E11.311','E11.319',
                  'E11.321','E11.3211','E11.3212','E11.3213','E11.3219','E11.329','E11.3291','E11.3292',
                  'E11.3293','E11.3299','E11.331','E11.3311','E11.3312','E11.3313','E11.3319','E11.339',
                  'E11.3391','E11.3392','E11.3393','E11.3399','E11.341','E11.3411','E11.3412','E11.3413',
                  'E11.3419','E11.349','E11.3491','E11.3492','E11.3493','E11.3499','E11.351','E11.3511',
                  'E11.3512','E11.3513','E11.3519','E11.3521','E11.3522','E11.3523','E11.3529','E11.3531',
                  'E11.3532','E11.3533','E11.3539','E11.3541','E11.3542','E11.3543','E11.3549','E11.3551',
                  'E11.3552','E11.3553','E11.3559','E11.359','E11.3591','E11.3592','E11.3593','E11.3599',
                  'E11.36','E11.37X1','E11.37X2','E11.37X3','E11.37X9','E11.39','E11.40','E11.41','E11.42',
                  'E11.43','E11.44','E11.49','E11.51','E11.52','E11.59','E11.610','E11.618','E11.620',
                  'E11.621','E11.622','E11.628','E11.630','E11.638','E11.641','E11.649','E11.65','E11.69',
                  'E11.8','E11.9','E13.00','E13.01','E13.10','E13.11','E13.21','E13.22','E13.29','E13.311',
                  'E13.319','E13.321','E13.3211','E13.3212','E13.3213','E13.3219','E13.329','E13.3291',
                  'E13.3292','E13.3293','E13.3299','E13.331','E13.3311','E13.3312','E13.3313','E13.3319',
                  'E13.339','E13.3391','E13.3392','E13.3393','E13.3399','E13.341','E13.3411','E13.3412',
                  'E13.3413','E13.3419','E13.349','E13.3491','E13.3492','E13.3493','E13.3499','E13.351',
                  'E13.3511','E13.3512','E13.3513','E13.3519','E13.3521','E13.3522','E13.3523','E13.3529',
                  'E13.3531','E13.3532','E13.3533','E13.3539','E13.3541','E13.3542','E13.3543','E13.3549',
                  'E13.3551','E13.3552','E13.3553','E13.3559','E13.359','E13.3591','E13.3592','E13.3593',
                  'E13.3599','E13.36','E13.37X1','E13.37X2','E13.37X3','E13.37X9','E13.39','E13.40',
                  'E13.41','E13.42','E13.43','E13.44','E13.49','E13.51','E13.52','E13.59','E13.610',
                  'E13.618','E13.620','E13.621','E13.622','E13.628','E13.630','E13.638','E13.641','E13.649',
                  'E13.65','E13.69','E13.8','E13.9','O24.011','O24.012','O24.013','O24.019','O24.02','O24.03',
                  'O24.111','O24.112','O24.113','O24.119','O24.12','O24.13','O24.311','O24.312','O24.313',
                  'O24.319','O24.32','O24.33','O24.811','O24.812','O24.813','O24.819','O24.82','O24.83'))e;

    END IF;


        CREATE TEMPORARY TABLE report_denominator_ds
        SELECT 1 as `value`, pid FROM report_ds GROUP BY pid;

        CREATE TEMPORARY TABLE report_numerator_ds
        SELECT 1 as `value`, pid FROM report_ds
        WHERE (was_prescribed_or_active = '1' OR
               has_nephropaty_screening = '1' OR
               has_nephropaty_dx = '1') GROUP BY pid;

        SET @denominator = (SELECT sum(`value`) FROM report_denominator_ds);
        SET @numerator = (SELECT sum(`value`) FROM report_numerator_ds);
        SET @denominator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_denominator_ds GROUP BY pid) as d);
        SET @numerator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_numerator_ds GROUP BY pid) as n);

        SELECT
            @provider as provider,
            @insurance as insurance,
            'MIPS' as title,
            @denominator as denominator,
            @denominator_pids as denominator_pids,
            @numerator as numerator,
            @numerator_pids as numerator_pids;

END$$

DELIMITER ;
