DROP PROCEDURE IF EXISTS `getHIVScreeningReportByDates`;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `getHIVScreeningReportByDates`(IN provider_id INT, IN insurance_id INT, IN start_date DATE, IN end_date DATE, IN sex CHAR, IN ethnicity VARCHAR(40), IN race VARCHAR(40))
BEGIN

    DROP TABLE IF EXISTS report_ds;
    DROP TABLE IF EXISTS report_denominator_ds;
    DROP TABLE IF EXISTS report_numerator_ds;

#     SET @provider_id = 2619;
#     SET @insurance_id = 1;
#     SET @start_date = '2020-01-01';
#     SET @end_date = '2024-01-01';

    SET @provider = (SELECT CONCAT(title, ' ', lname, ', ', fname, ' ', mname, ' (NPI:', npi, ')') FROM users WHERE id = provider_id);
    SET @insurance = (SELECT CONCAT(name, ' ', ' (CODE:', insurance_companies.code, ')') FROM insurance_companies WHERE id = insurance_id);

    IF insurance_id > 0
    THEN
        CREATE TEMPORARY TABLE report_ds
        SELECT e.eid,
               e.pid,
               IF(e.code IS NOT NULL,'1', '0') as has_HIV_test_performed
        FROM (SELECT enc.eid, enc.pid, o.code
              FROM encounters as enc
                       INNER JOIN patient p ON enc.pid = p.pid
                       INNER JOIN patient_insurances AS pi ON p.pid = pi.pid
                       LEFT JOIN patient_order_results o ON o.pid = enc.pid and code IN (
                         '10901-7','10902-5','11078-3','11079-1','11080-9','11081-7',
                         '11082-5','12855-3','12856-1','12857-9','12858-7','12859-5',
                         '12870-2','12871-0','12872-8','12875-1','12876-9','12893-4',
                         '12894-2','12895-9','13499-9','13920-4','14092-1','14126-7',
                         '16132-3','16974-8','16975-5','16976-3','16977-1','16978-9',
                         '16979-7','18396-2','19110-6','21007-0','21331-4','21332-2',
                         '21334-8','21335-5','21336-3','21337-1','21338-9','21339-7',
                         '21340-5','22356-0','22357-8','22358-6','24012-7','28004-0',
                         '28052-9','29327-4','29893-5','30361-0','31072-2','31073-0',
                         '31201-7','31430-2','32571-2','32602-5','32827-8','32842-7',
                         '33508-3','33660-2','33806-1','33807-9','33866-5','34591-8',
                         '34592-6','35437-3','35438-1','35439-9','35440-7','35441-5',
                         '35442-3','35443-1','35444-9','35445-6','35446-4','35447-2',
                         '35448-0','35449-8','35450-6','35452-2','35564-4','35565-1',
                         '40437-6','40438-4','40439-2','40732-0','40733-8','41143-9',
                         '41144-7','41145-4','41290-8','42339-2','42600-7','42627-0',
                         '42768-2','43008-2','43009-0','43010-8','43011-6','43012-4',
                         '43013-2','43185-8','43599-0','44531-2','44532-0','44533-8',
                         '44607-0','44872-0','44873-8','45212-8','47029-4','48345-3',
                         '48346-1','49483-1','49580-4','49718-0','49905-3','49965-7',
                         '51786-2','51866-2','5220-9','5221-7','5222-5','5223-3',
                         '5224-1','5225-8','53379-4','53601-1','54086-4','56888-1',
                         '57974-8','57975-5','57976-3','57977-1','57978-9','58900-2',
                         '62456-9','68961-2','69668-2','73905-2','73906-0','75622-1',
                         '75666-8','77685-6','7917-8','7918-6','7919-4','80203-3',
                         '80387-4','81641-3','83101-6','85037-0','85686-4','86233-4',
                         '86657-4','89365-1','89374-3','9660-2','9661-0','9662-8',
                         '9663-6','9664-4','9665-1','9666-9','9667-7','9668-5','9669-3',
                         '9821-0', '75622-1'
                )
                       LEFT JOIN patient_active_problems pap ON pap.pid = enc.pid
                       LEFT JOIN encounter_dx edx ON edx.pid = enc.pid
              WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND enc.close_date IS NOT NULL
                AND (sex IS NULL OR p.sex = sex)
                AND (ethnicity IS NULL OR p.ethnicity = ethnicity)
                AND (race IS NULL OR p.race = race)
                AND pi.insurance_id = insurance_id
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) >= 15
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) <= 65
                AND IFNULL(pap.code, 1) NOT IN (
                   '10746341000119109','10755671000119100','111880001','15928141000119107',
                   '165816005','186706006','186707002','186708007','230180003','230202002',
                   '230598008','235009000','235726002','236406007','240103002','276665006',
                   '276666007','315019000','397763006','398329009','402901009','405631006',
                   '406109008','40780007','414604009','416729007','420244003','420281004',
                   '420302007','420308006','420321004','420384005','420395004','420403001',
                   '420452002','420524008','420543008','420544002','420549007','420554003',
                   '420614009','420658009','420687005','420691000','420718004','420721002',
                   '420764009','420774007','420787001','420801006','420818005','420877009',
                   '420900006','420938005','420945005','421020000','421023003','421047005',
                   '421077004','421102007','421230000','421272004','421283008','421312009',
                   '421315006','421394009','421403008','421415007','421431004','421454008',
                   '421460008','421508002','421529006','421571007','421597001','421660003',
                   '421671002','421695000','421706001','421708000','421710003','421766003',
                   '421827003','421851008','421874007','421883002','421929001','421983003',
                   '421998001','422003001','422012004','422089004','422127002','422136003',
                   '422177004','422189002','422194002','422282000','422337001','432218001',
                   '442537007','442662004','445945000','48794007','52079000','62479008',
                   '697904001','697965002','699433000','700053002','713260006','713275003',
                   '713278001','713297001','713298006','713299003','713300006','713316008',
                   '713318009','713320007','713325002','713339002','713340000','713341001',
                   '713342008','713349004','713444005','713445006','713446007','713483007',
                   '713484001','713487008','713488003','713489006','713490002','713491003',
                   '713497004','713503007','713504001','713505000','713506004','713507008',
                   '713508003','713510001','713511002','713523008','713526000','713527009',
                   '713530002','713531003','713532005','713533000','713543002','713544008',
                   '713545009','713546005','713570009','713571008','713572001','713695001',
                   '713696000','713718006','713722001','713729005','713730000','713731001',
                   '713732008','713733003','713734009','713742005','713844000','713845004',
                   '713880000','713881001','713887002','713897006','713964006','713967004',
                   '714083007','714464009','719522009','721166000','722557007','733834006',
                   '733835007','735521001','735522008','735523003','735524009','735525005',
                   '735526006','735527002','735528007','771119002','771126002','771127006',
                   '79019005','80191000119101','81000119104','838377003','840442003',
                   '840498003','86406008','87117006','90681000119107','90691000119105',
                   '91947003','91948008'
                )
                AND IFNULL(edx.code,1) NOT IN ('B20','B97.35','V08','Z21')) e;
    ELSE
        CREATE TEMPORARY TABLE report_ds
        SELECT e.eid,
               e.pid,
               IF(e.code IS NOT NULL,'1', '0') as has_HIV_test_performed
        FROM (SELECT enc.eid, enc.pid, o.code
              FROM encounters as enc
                       INNER JOIN patient p ON enc.pid = p.pid
                       LEFT JOIN patient_order_results o ON o.pid = enc.pid and code IN (
                         '10901-7','10902-5','11078-3','11079-1','11080-9','11081-7',
                         '11082-5','12855-3','12856-1','12857-9','12858-7','12859-5',
                         '12870-2','12871-0','12872-8','12875-1','12876-9','12893-4',
                         '12894-2','12895-9','13499-9','13920-4','14092-1','14126-7',
                         '16132-3','16974-8','16975-5','16976-3','16977-1','16978-9',
                         '16979-7','18396-2','19110-6','21007-0','21331-4','21332-2',
                         '21334-8','21335-5','21336-3','21337-1','21338-9','21339-7',
                         '21340-5','22356-0','22357-8','22358-6','24012-7','28004-0',
                         '28052-9','29327-4','29893-5','30361-0','31072-2','31073-0',
                         '31201-7','31430-2','32571-2','32602-5','32827-8','32842-7',
                         '33508-3','33660-2','33806-1','33807-9','33866-5','34591-8',
                         '34592-6','35437-3','35438-1','35439-9','35440-7','35441-5',
                         '35442-3','35443-1','35444-9','35445-6','35446-4','35447-2',
                         '35448-0','35449-8','35450-6','35452-2','35564-4','35565-1',
                         '40437-6','40438-4','40439-2','40732-0','40733-8','41143-9',
                         '41144-7','41145-4','41290-8','42339-2','42600-7','42627-0',
                         '42768-2','43008-2','43009-0','43010-8','43011-6','43012-4',
                         '43013-2','43185-8','43599-0','44531-2','44532-0','44533-8',
                         '44607-0','44872-0','44873-8','45212-8','47029-4','48345-3',
                         '48346-1','49483-1','49580-4','49718-0','49905-3','49965-7',
                         '51786-2','51866-2','5220-9','5221-7','5222-5','5223-3',
                         '5224-1','5225-8','53379-4','53601-1','54086-4','56888-1',
                         '57974-8','57975-5','57976-3','57977-1','57978-9','58900-2',
                         '62456-9','68961-2','69668-2','73905-2','73906-0','75622-1',
                         '75666-8','77685-6','7917-8','7918-6','7919-4','80203-3',
                         '80387-4','81641-3','83101-6','85037-0','85686-4','86233-4',
                         '86657-4','89365-1','89374-3','9660-2','9661-0','9662-8',
                         '9663-6','9664-4','9665-1','9666-9','9667-7','9668-5','9669-3',
                         '9821-0', '75622-1'
                  )
                       LEFT JOIN patient_active_problems pap ON pap.pid = enc.pid
                       LEFT JOIN encounter_dx edx ON edx.pid = enc.pid
              WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND enc.close_date IS NOT NULL
                AND (sex IS NULL OR p.sex = sex)
                AND (ethnicity IS NULL OR p.ethnicity = ethnicity)
                AND (race IS NULL OR p.race = race)
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) >= 15
                AND YEAR(start_date) - YEAR(p.DOB) - (RIGHT(start_date, 5) < RIGHT(p.DOB, 5)) <= 65
                AND IFNULL(pap.code, 1) NOT IN (
                   '10746341000119109','10755671000119100','111880001','15928141000119107',
                   '165816005','186706006','186707002','186708007','230180003','230202002',
                   '230598008','235009000','235726002','236406007','240103002','276665006',
                   '276666007','315019000','397763006','398329009','402901009','405631006',
                   '406109008','40780007','414604009','416729007','420244003','420281004',
                   '420302007','420308006','420321004','420384005','420395004','420403001',
                   '420452002','420524008','420543008','420544002','420549007','420554003',
                   '420614009','420658009','420687005','420691000','420718004','420721002',
                   '420764009','420774007','420787001','420801006','420818005','420877009',
                   '420900006','420938005','420945005','421020000','421023003','421047005',
                   '421077004','421102007','421230000','421272004','421283008','421312009',
                   '421315006','421394009','421403008','421415007','421431004','421454008',
                   '421460008','421508002','421529006','421571007','421597001','421660003',
                   '421671002','421695000','421706001','421708000','421710003','421766003',
                   '421827003','421851008','421874007','421883002','421929001','421983003',
                   '421998001','422003001','422012004','422089004','422127002','422136003',
                   '422177004','422189002','422194002','422282000','422337001','432218001',
                   '442537007','442662004','445945000','48794007','52079000','62479008',
                   '697904001','697965002','699433000','700053002','713260006','713275003',
                   '713278001','713297001','713298006','713299003','713300006','713316008',
                   '713318009','713320007','713325002','713339002','713340000','713341001',
                   '713342008','713349004','713444005','713445006','713446007','713483007',
                   '713484001','713487008','713488003','713489006','713490002','713491003',
                   '713497004','713503007','713504001','713505000','713506004','713507008',
                   '713508003','713510001','713511002','713523008','713526000','713527009',
                   '713530002','713531003','713532005','713533000','713543002','713544008',
                   '713545009','713546005','713570009','713571008','713572001','713695001',
                   '713696000','713718006','713722001','713729005','713730000','713731001',
                   '713732008','713733003','713734009','713742005','713844000','713845004',
                   '713880000','713881001','713887002','713897006','713964006','713967004',
                   '714083007','714464009','719522009','721166000','722557007','733834006',
                   '733835007','735521001','735522008','735523003','735524009','735525005',
                   '735526006','735527002','735528007','771119002','771126002','771127006',
                   '79019005','80191000119101','81000119104','838377003','840442003',
                   '840498003','86406008','87117006','90681000119107','90691000119105',
                   '91947003','91948008'
                )
                AND IFNULL(edx.code,1) NOT IN ('B20','B97.35','V08','Z21')) e;
    END IF;


        CREATE TEMPORARY TABLE report_denominator_ds
        SELECT 1 as `value`, pid FROM report_ds  GROUP BY pid;

        CREATE TEMPORARY TABLE report_numerator_ds
        SELECT 1 as `value`, pid FROM report_ds WHERE has_HIV_test_performed = '1' GROUP BY pid;

        SET @denominator = (SELECT sum(`value`) FROM report_denominator_ds);
        SET @numerator = (SELECT sum(`value`) FROM report_numerator_ds);
        SET @denominator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_denominator_ds GROUP BY pid) as d);
        SET @numerator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_numerator_ds GROUP BY pid) as n);

        SELECT
            @provider as provider,
            @insurance as insurance,
            'MIPS' as title,
            @denominator as denominator,
            @denominator_pids as denominator_pids,
            @numerator as numerator,
            @numerator_pids as numerator_pids;

END$$

DELIMITER ;