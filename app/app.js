Ext.define('Ext.ux.SlidingPager', {
    requires: [
        'Ext.slider.Single',
        'Ext.slider.Tip'
    ],

    /**
     * Creates new SlidingPager.
     * @param {Object} config Configuration options
     */
    constructor : function(config) {
        if (config) {
            Ext.apply(this, config);
        }
    },

    init : function(pbar){
        var idx = pbar.items.indexOf(pbar.child("#inputItem")),
            slider;

        Ext.each(pbar.items.getRange(idx - 2, idx + 2), function(c){
            c.hide();
        });

        slider = Ext.create('Ext.slider.Single', {
            width: 114,
            minValue: 1,
            maxValue: 1,
            hideLabel: true,
            tipText: function(thumb) {
                return Ext.String.format('Page <b>{0}</b> of <b>{1}</b>', thumb.value, thumb.slider.maxValue);
            },
            listeners: {
                changecomplete: function(s, v){
                    pbar.store.loadPage(v);
                }
            }
        });

        pbar.insert(idx + 1, slider);

        pbar.on({
            change: function(pb, data){
                slider.setMaxValue(data ? data.pageCount : 1);
                slider.setValue(data ? data.currentPage : 1);
            }
        });
    }
});

Ext.define('Ext.ux.PreviewPlugin', {
    extend: 'Ext.AbstractPlugin',
    alias: 'plugin.preview',
    requires: ['Ext.grid.feature.RowBody', 'Ext.grid.feature.RowWrap'],
    
    // private, css class to use to hide the body
    hideBodyCls: 'x-grid-row-body-hidden',
    
    /**
     * @cfg {String} bodyField
     * Field to display in the preview. Must be a field within the Model definition
     * that the store is using.
     */
    bodyField: '',
    
    /**
     * @cfg {Boolean} previewExpanded
     */
    previewExpanded: true,
    
    setCmp: function(grid) {
        this.callParent(arguments);
        
        var bodyField   = this.bodyField,
            hideBodyCls = this.hideBodyCls,
            features    = [{
                ftype: 'rowbody',
                getAdditionalData: function(data, idx, record, orig, view) {
                    var getAdditionalData = Ext.grid.feature.RowBody.prototype.getAdditionalData,
                        additionalData = {
                            rowBody: data[bodyField],
                            rowBodyCls: grid.previewExpanded ? '' : hideBodyCls
                        };
                        
                    if (getAdditionalData) {
                        Ext.apply(additionalData, getAdditionalData.apply(this, arguments));
                    }
                    return additionalData;
                }
            }, {
                ftype: 'rowwrap'
            }];
        
        grid.previewExpanded = this.previewExpanded;
        if (!grid.features) {
            grid.features = [];
        }
        grid.features = features.concat(grid.features);
    },
    
    /**
     * Toggle between the preview being expanded/hidden
     * @param {Boolean} expanded Pass true to expand the record and false to not show the preview.
     */
    toggleExpanded: function(expanded) {
        var view = this.getCmp();
        this.previewExpanded = view.previewExpanded = expanded;
        view.refresh();
    }
});
Ext.define('Ext.ux.form.SearchField', {
    extend: 'Ext.form.field.Trigger',

    alias: 'widget.searchfield',

    trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',

    trigger2Cls: Ext.baseCSSPrefix + 'form-search-trigger',

    hasSearch : false,
    paramName : 'query',

    initComponent: function() {
        var me = this;

        me.callParent(arguments);
        me.on('specialkey', function(f, e){
            if (e.getKey() == e.ENTER) {
                me.onTrigger2Click();
            }
        });

        // We're going to use filtering
        me.store.remoteFilter = true;

        // Set up the proxy to encode the filter in the simplest way as a name/value pair

        // If the Store has not been *configured* with a filterParam property, then use our filter parameter name
        if (!me.store.proxy.hasOwnProperty('filterParam')) {
            me.store.proxy.filterParam = me.paramName;
        }
        me.store.proxy.encodeFilters = function(filters) {
            return filters[0].value;
        }
    },

    afterRender: function(){
        this.callParent();
        this.triggerCell.item(0).setDisplayed(false);
    },

    onTrigger1Click : function(){
        var me = this;

        if (me.hasSearch) {
            me.setValue('');
            me.store.clearFilter();
            me.hasSearch = false;
            me.triggerCell.item(0).setDisplayed(false);
            me.updateLayout();
        }
    },

    onTrigger2Click : function(){
        var me = this,
            value = me.getValue();

        if (value.length > 0) {
            // Param name is ignored here since we use custom encoding in the proxy.
            // id is used by the Store to replace any previous filter
            me.store.filter({
                id: me.paramName,
                property: me.paramName,
                value: value
            });
            me.hasSearch = true;
            me.triggerCell.item(0).setDisplayed(true);
            me.updateLayout();
        }
    }
});
Ext.define('Ext.ux.statusbar.StatusBar', {
    extend: 'Ext.toolbar.Toolbar',
    alternateClassName: 'Ext.ux.StatusBar',
    alias: 'widget.statusbar',
    requires: ['Ext.toolbar.TextItem'],
    /**
     * @cfg {String} statusAlign
     * The alignment of the status element within the overall StatusBar layout.  When the StatusBar is rendered,
     * it creates an internal div containing the status text and icon.  Any additional Toolbar items added in the
     * StatusBar's {@link #cfg-items} config, or added via {@link #method-add} or any of the supported add* methods, will be
     * rendered, in added order, to the opposite side.  The status element is greedy, so it will automatically
     * expand to take up all sapce left over by any other items.  Example usage:
     *
     *     // Create a left-aligned status bar containing a button,
     *     // separator and text item that will be right-aligned (default):
     *     Ext.create('Ext.Panel', {
     *         title: 'StatusBar',
     *         // etc.
     *         bbar: Ext.create('Ext.ux.statusbar.StatusBar', {
     *             defaultText: 'Default status text',
     *             id: 'status-id',
     *             items: [{
     *                 text: 'A Button'
     *             }, '-', 'Plain Text']
     *         })
     *     });
     *
     *     // By adding the statusAlign config, this will create the
     *     // exact same toolbar, except the status and toolbar item
     *     // layout will be reversed from the previous example:
     *     Ext.create('Ext.Panel', {
     *         title: 'StatusBar',
     *         // etc.
     *         bbar: Ext.create('Ext.ux.statusbar.StatusBar', {
     *             defaultText: 'Default status text',
     *             id: 'status-id',
     *             statusAlign: 'right',
     *             items: [{
     *                 text: 'A Button'
     *             }, '-', 'Plain Text']
     *         })
     *     });
     */
    /**
     * @cfg {String} [defaultText='']
     * The default {@link #text} value.  This will be used anytime the status bar is cleared with the
     * `useDefaults:true` option.
     */
    /**
     * @cfg {String} [defaultIconCls='']
     * The default {@link #iconCls} value (see the iconCls docs for additional details about customizing the icon).
     * This will be used anytime the status bar is cleared with the `useDefaults:true` option.
     */
    /**
     * @cfg {String} text
     * A string that will be <b>initially</b> set as the status message.  This string
     * will be set as innerHTML (html tags are accepted) for the toolbar item.
     * If not specified, the value set for {@link #defaultText} will be used.
     */
    /**
     * @cfg {String} [iconCls='']
     * A CSS class that will be **initially** set as the status bar icon and is
     * expected to provide a background image.
     *
     * Example usage:
     *
     *     // Example CSS rule:
     *     .x-statusbar .x-status-custom {
     *         padding-left: 25px;
     *         background: transparent url(images/custom-icon.gif) no-repeat 3px 2px;
     *     }
     *
     *     // Setting a default icon:
     *     var sb = Ext.create('Ext.ux.statusbar.StatusBar', {
     *         defaultIconCls: 'x-status-custom'
     *     });
     *
     *     // Changing the icon:
     *     sb.setStatus({
     *         text: 'New status',
     *         iconCls: 'x-status-custom'
     *     });
     */

    /**
     * @cfg {String} cls
     * The base class applied to the containing element for this component on render.
     */
    cls : 'x-statusbar',
    /**
     * @cfg {String} busyIconCls
     * The default {@link #iconCls} applied when calling {@link #showBusy}.
     * It can be overridden at any time by passing the `iconCls` argument into {@link #showBusy}.
     */
    busyIconCls : 'x-status-busy',
    /**
     * @cfg {String} busyText
     * The default {@link #text} applied when calling {@link #showBusy}.
     * It can be overridden at any time by passing the `text` argument into {@link #showBusy}.
     */
    busyText : 'Loading...',
    /**
     * @cfg {Number} autoClear
     * The number of milliseconds to wait after setting the status via
     * {@link #setStatus} before automatically clearing the status text and icon.
     * Note that this only applies when passing the `clear` argument to {@link #setStatus}
     * since that is the only way to defer clearing the status.  This can
     * be overridden by specifying a different `wait` value in {@link #setStatus}.
     * Calls to {@link #clearStatus} always clear the status bar immediately and ignore this value.
     */
    autoClear : 5000,

    /**
     * @cfg {String} emptyText
     * The text string to use if no text has been set. If there are no other items in
     * the toolbar using an empty string (`''`) for this value would end up in the toolbar
     * height collapsing since the empty string will not maintain the toolbar height.
     * Use `''` if the toolbar should collapse in height vertically when no text is
     * specified and there are no other items in the toolbar.
     */
    emptyText : '&#160;',

    // private
    activeThreadId : 0,

    // private
    initComponent : function(){
        var right = this.statusAlign === 'right';

        this.callParent(arguments);
        this.currIconCls = this.iconCls || this.defaultIconCls;
        this.statusEl = Ext.create('Ext.toolbar.TextItem', {
            cls: 'x-status-text ' + (this.currIconCls || ''),
            text: this.text || this.defaultText || ''
        });

        if (right) {
            this.cls += ' x-status-right';
            this.add('->');
            this.add(this.statusEl);
        } else {
            this.insert(0, this.statusEl);
            this.insert(1, '->');
        }
    },

    /**
     * Sets the status {@link #text} and/or {@link #iconCls}. Also supports automatically clearing the
     * status that was set after a specified interval.
     *
     * Example usage:
     *
     *     // Simple call to update the text
     *     statusBar.setStatus('New status');
     *
     *     // Set the status and icon, auto-clearing with default options:
     *     statusBar.setStatus({
     *         text: 'New status',
     *         iconCls: 'x-status-custom',
     *         clear: true
     *     });
     *
     *     // Auto-clear with custom options:
     *     statusBar.setStatus({
     *         text: 'New status',
     *         iconCls: 'x-status-custom',
     *         clear: {
     *             wait: 8000,
     *             anim: false,
     *             useDefaults: false
     *         }
     *     });
     *
     * @param {Object/String} config A config object specifying what status to set, or a string assumed
     * to be the status text (and all other options are defaulted as explained below). A config
     * object containing any or all of the following properties can be passed:
     *
     * @param {String} config.text The status text to display.  If not specified, any current
     * status text will remain unchanged.
     *
     * @param {String} config.iconCls The CSS class used to customize the status icon (see
     * {@link #iconCls} for details). If not specified, any current iconCls will remain unchanged.
     *
     * @param {Boolean/Number/Object} config.clear Allows you to set an internal callback that will
     * automatically clear the status text and iconCls after a specified amount of time has passed. If clear is not
     * specified, the new status will not be auto-cleared and will stay until updated again or cleared using
     * {@link #clearStatus}. If `true` is passed, the status will be cleared using {@link #autoClear},
     * {@link #defaultText} and {@link #defaultIconCls} via a fade out animation. If a numeric value is passed,
     * it will be used as the callback interval (in milliseconds), overriding the {@link #autoClear} value.
     * All other options will be defaulted as with the boolean option.  To customize any other options,
     * you can pass an object in the format:
     * 
     * @param {Number} config.clear.wait The number of milliseconds to wait before clearing
     * (defaults to {@link #autoClear}).
     * @param {Boolean} config.clear.anim False to clear the status immediately once the callback
     * executes (defaults to true which fades the status out).
     * @param {Boolean} config.clear.useDefaults False to completely clear the status text and iconCls
     * (defaults to true which uses {@link #defaultText} and {@link #defaultIconCls}).
     *
     * @return {Ext.ux.statusbar.StatusBar} this
     */
    setStatus : function(o) {
        var me = this;

        o = o || {};
        Ext.suspendLayouts();
        if (Ext.isString(o)) {
            o = {text:o};
        }
        if (o.text !== undefined) {
            me.setText(o.text);
        }
        if (o.iconCls !== undefined) {
            me.setIcon(o.iconCls);
        }

        if (o.clear) {
            var c = o.clear,
                wait = me.autoClear,
                defaults = {useDefaults: true, anim: true};

            if (Ext.isObject(c)) {
                c = Ext.applyIf(c, defaults);
                if (c.wait) {
                    wait = c.wait;
                }
            } else if (Ext.isNumber(c)) {
                wait = c;
                c = defaults;
            } else if (Ext.isBoolean(c)) {
                c = defaults;
            }

            c.threadId = this.activeThreadId;
            Ext.defer(me.clearStatus, wait, me, [c]);
        }
        Ext.resumeLayouts(true);
        return me;
    },

    /**
     * Clears the status {@link #text} and {@link #iconCls}. Also supports clearing via an optional fade out animation.
     *
     * @param {Object} [config] A config object containing any or all of the following properties.  If this
     * object is not specified the status will be cleared using the defaults below:
     * @param {Boolean} config.anim True to clear the status by fading out the status element (defaults
     * to false which clears immediately).
     * @param {Boolean} config.useDefaults True to reset the text and icon using {@link #defaultText} and
     * {@link #defaultIconCls} (defaults to false which sets the text to '' and removes any existing icon class).
     *
     * @return {Ext.ux.statusbar.StatusBar} this
     */
    clearStatus : function(o) {
        o = o || {};

        var me = this,
            statusEl = me.statusEl;

        if (o.threadId && o.threadId !== me.activeThreadId) {
            // this means the current call was made internally, but a newer
            // thread has set a message since this call was deferred.  Since
            // we don't want to overwrite a newer message just ignore.
            return me;
        }

        var text = o.useDefaults ? me.defaultText : me.emptyText,
            iconCls = o.useDefaults ? (me.defaultIconCls ? me.defaultIconCls : '') : '';

        if (o.anim) {
            // animate the statusEl Ext.Element
            statusEl.el.puff({
                remove: false,
                useDisplay: true,
                callback: function() {
                    statusEl.el.show();
                    me.setStatus({
                        text: text,
                        iconCls: iconCls
                    });
                }
            });
        } else {
             me.setStatus({
                 text: text,
                 iconCls: iconCls
             });
        }
        return me;
    },

    /**
     * Convenience method for setting the status text directly.  For more flexible options see {@link #setStatus}.
     * @param {String} text (optional) The text to set (defaults to '')
     * @return {Ext.ux.statusbar.StatusBar} this
     */
    setText : function(text) {
        var me = this;
        me.activeThreadId++;
        me.text = text || '';
        if (me.rendered) {
            me.statusEl.setText(me.text);
        }
        return me;
    },

    /**
     * Returns the current status text.
     * @return {String} The status text
     */
    getText : function(){
        return this.text;
    },

    /**
     * Convenience method for setting the status icon directly.  For more flexible options see {@link #setStatus}.
     * See {@link #iconCls} for complete details about customizing the icon.
     * @param {String} iconCls (optional) The icon class to set (defaults to '', and any current icon class is removed)
     * @return {Ext.ux.statusbar.StatusBar} this
     */
    setIcon : function(cls) {
        var me = this;

        me.activeThreadId++;
        cls = cls || '';

        if (me.rendered) {
            if (me.currIconCls) {
                me.statusEl.removeCls(me.currIconCls);
                me.currIconCls = null;
            }
            if (cls.length > 0) {
                me.statusEl.addCls(cls);
                me.currIconCls = cls;
            }
        } else {
            me.currIconCls = cls;
        }
        return me;
    },

    /**
     * Convenience method for setting the status text and icon to special values that are pre-configured to indicate
     * a "busy" state, usually for loading or processing activities.
     *
     * @param {Object/String} config (optional) A config object in the same format supported by {@link #setStatus}, or a
     * string to use as the status text (in which case all other options for setStatus will be defaulted).  Use the
     * `text` and/or `iconCls` properties on the config to override the default {@link #busyText}
     * and {@link #busyIconCls} settings. If the config argument is not specified, {@link #busyText} and
     * {@link #busyIconCls} will be used in conjunction with all of the default options for {@link #setStatus}.
     * @return {Ext.ux.statusbar.StatusBar} this
     */
    showBusy : function(o){
        if (Ext.isString(o)) {
            o = { text: o };
        }
        o = Ext.applyIf(o || {}, {
            text: this.busyText,
            iconCls: this.busyIconCls
        });
        return this.setStatus(o);
    }
});

Ext.define('Ext.ux.LiveSearchGridPanel', {
    extend: 'Ext.grid.Panel',
    requires: [
        'Ext.toolbar.TextItem',
        'Ext.form.field.Checkbox',
        'Ext.form.field.Text',
        'Ext.ux.statusbar.StatusBar'
    ],
    
    /**
     * @private
     * search value initialization
     */
    searchValue: null,
    
    /**
     * @private
     * The row indexes where matching strings are found. (used by previous and next buttons)
     */
    indexes: [],
    
    /**
     * @private
     * The row index of the first search, it could change if next or previous buttons are used.
     */
    currentIndex: null,
    
    /**
     * @private
     * The generated regular expression used for searching.
     */
    searchRegExp: null,
    
    /**
     * @private
     * Case sensitive mode.
     */
    caseSensitive: false,
    
    /**
     * @private
     * Regular expression mode.
     */
    regExpMode: false,
    
    /**
     * @cfg {String} matchCls
     * The matched string css classe.
     */
    matchCls: 'x-livesearch-match',
    
    defaultStatusText: 'Nothing Found',
    
    // Component initialization override: adds the top and bottom toolbars and setup headers renderer.
    initComponent: function() {
        var me = this;
        me.tbar = ['Search',{
                 xtype: 'textfield',
                 name: 'searchField',
                 hideLabel: true,
                 width: 200,
                 listeners: {
                     change: {
                         fn: me.onTextFieldChange,
                         scope: this,
                         buffer: 100
                     }
                 }
            }, {
                xtype: 'button',
                text: '&lt;',
                tooltip: 'Find Previous Row',
                handler: me.onPreviousClick,
                scope: me
            },{
                xtype: 'button',
                text: '&gt;',
                tooltip: 'Find Next Row',
                handler: me.onNextClick,
                scope: me
            }, '-', {
                xtype: 'checkbox',
                hideLabel: true,
                margin: '0 0 0 4px',
                handler: me.regExpToggle,
                scope: me                
            }, 'Regular expression', {
                xtype: 'checkbox',
                hideLabel: true,
                margin: '0 0 0 4px',
                handler: me.caseSensitiveToggle,
                scope: me
            }, 'Case sensitive'];

        me.bbar = Ext.create('Ext.ux.StatusBar', {
            defaultText: me.defaultStatusText,
            name: 'searchStatusBar'
        });
        
        me.callParent(arguments);
    },
    
    // afterRender override: it adds textfield and statusbar reference and start monitoring keydown events in textfield input 
    afterRender: function() {
        var me = this;
        me.callParent(arguments);
        me.textField = me.down('textfield[name=searchField]');
        me.statusBar = me.down('statusbar[name=searchStatusBar]');
    },
    // detects html tag
    tagsRe: /<[^>]*>/gm,
    
    // DEL ASCII code
    tagsProtect: '\x0f',
    
    // detects regexp reserved word
    regExpProtect: /\\|\/|\+|\\|\.|\[|\]|\{|\}|\?|\$|\*|\^|\|/gm,
    
    /**
     * In normal mode it returns the value with protected regexp characters.
     * In regular expression mode it returns the raw value except if the regexp is invalid.
     * @return {String} The value to process or null if the textfield value is blank or invalid.
     * @private
     */
    getSearchValue: function() {
        var me = this,
            value = me.textField.getValue();
            
        if (value === '') {
            return null;
        }
        if (!me.regExpMode) {
            value = value.replace(me.regExpProtect, function(m) {
                return '\\' + m;
            });
        } else {
            try {
                new RegExp(value);
            } catch (error) {
                me.statusBar.setStatus({
                    text: error.message,
                    iconCls: 'x-status-error'
                });
                return null;
            }
            // this is stupid
            if (value === '^' || value === '$') {
                return null;
            }
        }

        return value;
    },
    
    /**
     * Finds all strings that matches the searched value in each grid cells.
     * @private
     */
     onTextFieldChange: function() {
         var me = this,
             count = 0;

         me.view.refresh();
         // reset the statusbar
         me.statusBar.setStatus({
             text: me.defaultStatusText,
             iconCls: ''
         });

         me.searchValue = me.getSearchValue();
         me.indexes = [];
         me.currentIndex = null;

         if (me.searchValue !== null) {
             me.searchRegExp = new RegExp(me.searchValue, 'g' + (me.caseSensitive ? '' : 'i'));
             
             
             me.store.each(function(record, idx) {
                 var td = Ext.fly(me.view.getNode(idx)).down('td'),
                     cell, matches, cellHTML;
                 while(td) {
                     cell = td.down('.x-grid-cell-inner');
                     matches = cell.dom.innerHTML.match(me.tagsRe);
                     cellHTML = cell.dom.innerHTML.replace(me.tagsRe, me.tagsProtect);
                     
                     // populate indexes array, set currentIndex, and replace wrap matched string in a span
                     cellHTML = cellHTML.replace(me.searchRegExp, function(m) {
                        count += 1;
                        if (Ext.Array.indexOf(me.indexes, idx) === -1) {
                            me.indexes.push(idx);
                        }
                        if (me.currentIndex === null) {
                            me.currentIndex = idx;
                        }
                        return '<span class="' + me.matchCls + '">' + m + '</span>';
                     });
                     // restore protected tags
                     Ext.each(matches, function(match) {
                        cellHTML = cellHTML.replace(me.tagsProtect, match); 
                     });
                     // update cell html
                     cell.dom.innerHTML = cellHTML;
                     td = td.next();
                 }
             }, me);

             // results found
             if (me.currentIndex !== null) {
                 me.getSelectionModel().select(me.currentIndex);
                 me.statusBar.setStatus({
                     text: count + ' matche(s) found.',
                     iconCls: 'x-status-valid'
                 });
             }
         }

         // no results found
         if (me.currentIndex === null) {
             me.getSelectionModel().deselectAll();
         }

         // force textfield focus
         me.textField.focus();
     },
    
    /**
     * Selects the previous row containing a match.
     * @private
     */   
    onPreviousClick: function() {
        var me = this,
            idx;
            
        if ((idx = Ext.Array.indexOf(me.indexes, me.currentIndex)) !== -1) {
            me.currentIndex = me.indexes[idx - 1] || me.indexes[me.indexes.length - 1];
            me.getSelectionModel().select(me.currentIndex);
         }
    },
    
    /**
     * Selects the next row containing a match.
     * @private
     */    
    onNextClick: function() {
         var me = this,
             idx;
             
         if ((idx = Ext.Array.indexOf(me.indexes, me.currentIndex)) !== -1) {
            me.currentIndex = me.indexes[idx + 1] || me.indexes[0];
            me.getSelectionModel().select(me.currentIndex);
         }
    },
    
    /**
     * Switch to case sensitive mode.
     * @private
     */    
    caseSensitiveToggle: function(checkbox, checked) {
        this.caseSensitive = checked;
        this.onTextFieldChange();
    },
    
    /**
     * Switch to regular expression mode
     * @private
     */
    regExpToggle: function(checkbox, checked) {
        this.regExpMode = checked;
        this.onTextFieldChange();
    }
});
/*!
 * Ext JS Library 4.0
 * Copyright(c) 2006-2011 Sencha Inc.
 * licensing@sencha.com
 * http://www.sencha.com/license
 */

/**
 * Barebones iframe implementation. For serious iframe work, see the
 * ManagedIFrame extension
 * (http://www.sencha.com/forum/showthread.php?71961).
 */
Ext.define('Ext.ux.IFrame', {
    extend: 'Ext.Component',

    alias: 'widget.uxiframe',

    loadMask: 'Loading...',

    src: 'about:blank',

    renderTpl: [
        '<iframe src="{src}" name="{frameName}" width="100%" height="100%" frameborder="0"></iframe>'
    ],

    initComponent: function () {
        this.callParent();

        this.frameName = this.frameName || this.id + '-frame';

        this.addEvents(
            'beforeload',
            'load'
        );

        Ext.apply(this.renderSelectors, {
            iframeEl: 'iframe'
        });
    },

    initEvents : function() {
        var me = this;
        me.callParent();
        me.iframeEl.on('load', me.onLoad, me);
    },

    initRenderData: function() {
        return Ext.apply(this.callParent(), {
            src: this.src,
            frameName: this.frameName
        });
    },

    getBody: function() {
        var doc = this.getDoc();
        return doc.body || doc.documentElement;
    },

    getDoc: function() {
        try {
            return this.getWin().document;
        } catch (ex) {
            return null;
        }
    },

    getWin: function() {
        var me = this,
            name = me.frameName,
            win = Ext.isIE
                ? me.iframeEl.dom.contentWindow
                : window.frames[name];
        return win;
    },

    getFrame: function() {
        var me = this;
        return me.iframeEl.dom;
    },

    beforeDestroy: function () {
        this.cleanupListeners(true);
        this.callParent();
    },
    
    cleanupListeners: function(destroying){
        var doc, prop;

        if (this.rendered) {
            try {
                doc = this.getDoc();
                if (doc) {
                    Ext.EventManager.removeAll(doc);
                    if (destroying) {
                        for (prop in doc) {
                            if (doc.hasOwnProperty && doc.hasOwnProperty(prop)) {
                                delete doc[prop];
                            }
                        }
                    }
                }
            } catch(e) { }
        }
    },

    onLoad: function() {
        var me = this,
            doc = me.getDoc(),
            fn = me.onRelayedEvent;

        if (doc) {
            try {
                Ext.EventManager.removeAll(doc);

                // These events need to be relayed from the inner document (where they stop
                // bubbling) up to the outer document. This has to be done at the DOM level so
                // the event reaches listeners on elements like the document body. The effected
                // mechanisms that depend on this bubbling behavior are listed to the right
                // of the event.
                Ext.EventManager.on(doc, {
                    mousedown: fn, // menu dismisal (MenuManager) and Window onMouseDown (toFront)
                    mousemove: fn, // window resize drag detection
                    mouseup: fn,   // window resize termination
                    click: fn,     // not sure, but just to be safe
                    dblclick: fn,  // not sure again
                    scope: me
                });
            } catch(e) {
                // cannot do this xss
            }

            // We need to be sure we remove all our events from the iframe on unload or we're going to LEAK!
            Ext.EventManager.on(this.getWin(), 'beforeunload', me.cleanupListeners, me);

            this.el.unmask();
            this.fireEvent('load', this);

        } else if(me.src && me.src != '') {

            this.el.unmask();
            this.fireEvent('error', this);
        }


    },

    onRelayedEvent: function (event) {
        // relay event from the iframe's document to the document that owns the iframe...

        var iframeEl = this.iframeEl,

            // Get the left-based iframe position
            iframeXY = Ext.Element.getTrueXY(iframeEl),
            originalEventXY = event.getXY(),

            // Get the left-based XY position.
            // This is because the consumer of the injected event (Ext.EventManager) will
            // perform its own RTL normalization.
            eventXY = Ext.EventManager.getPageXY(event.browserEvent);

        // the event from the inner document has XY relative to that document's origin,
        // so adjust it to use the origin of the iframe in the outer document:
        event.xy = [iframeXY[0] + eventXY[0], iframeXY[1] + eventXY[1]];

        event.injectEvent(iframeEl); // blame the iframe for the event...

        event.xy = originalEventXY; // restore the original XY (just for safety)
    },

    load: function (src) {
        var me = this,
            text = me.loadMask,
            frame = me.getFrame();

        if (me.fireEvent('beforeload', me, src) !== false) {
            if (text && me.el) {
                me.el.mask(text);
            }

            frame.src = me.src = (src || me.src);
        }
    }
});

Ext.define('Ext.ux.DataTip', function(DataTip) {

//  Target the body (if the host is a Panel), or, if there is no body, the main Element.
    function onHostRender() {
        var e = this.isXType('panel') ? this.body : this.el;
        if (this.dataTip.renderToTarget) {
            this.dataTip.render(e);
        }
        this.dataTip.setTarget(e);
    }

    function updateTip(tip, data) {
        if (tip.rendered) {
            if (tip.host.fireEvent('beforeshowtip', tip.eventHost, tip, data) === false) {
                return false;
            }
            tip.update(data);
        } else {
            if (Ext.isString(data)) {
                tip.html = data;
            } else {
                tip.data = data;
            }
        }
    }

    function beforeViewTipShow(tip) {
        var rec = this.view.getRecord(tip.triggerElement),
            data;

        if (rec) {
            data = tip.initialConfig.data ? Ext.apply(tip.initialConfig.data, rec.data) : rec.data;
            return updateTip(tip, data);
        } else {
            return false;
        }
    }

    function beforeFormTipShow(tip) {
        var field = Ext.getCmp(tip.triggerElement.id);
        if (field && (field.tooltip || tip.tpl)) {
            return updateTip(tip, field.tooltip || field);
        } else {
            return false;
        }
    }

    return {
        extend: 'Ext.tip.ToolTip',

        mixins: {
            plugin: 'Ext.AbstractPlugin'
        },

        alias: 'plugin.datatip',

        lockableScope: 'both',

        constructor: function(config) {
            var me = this;
            me.callParent([config]);
            me.mixins.plugin.constructor.call(me, config);
        },

        init: function(host) {
            var me = this;

            me.mixins.plugin.init.call(me, host);
            host.dataTip = me;
            me.host = host;

            if (host.isXType('tablepanel')) {
                me.view = host.getView();
                if (host.ownerLockable) {
                    me.host = host.ownerLockable;
                }
                me.delegate = me.delegate || me.view.getDataRowSelector();
                me.on('beforeshow', beforeViewTipShow);
            } else if (host.isXType('dataview')) {
                me.view = me.host;
                me.delegate = me.delegate || host.itemSelector;
                me.on('beforeshow', beforeViewTipShow);
            } else if (host.isXType('form')) {
                me.delegate = '.' + Ext.form.Labelable.prototype.formItemCls;
                me.on('beforeshow', beforeFormTipShow);
            } else if (host.isXType('combobox')) {
                me.view = host.getPicker();
                me.delegate = me.delegate || me.view.getItemSelector();
                me.on('beforeshow', beforeViewTipShow);
            }
            if (host.rendered) {
                onHostRender.call(host);
            } else {
                host.onRender = Ext.Function.createSequence(host.onRender, onHostRender);
            }
        }
    };
});
Ext.define('Ext.ux.BoxReorderer', {
    mixins: {
        observable: 'Ext.util.Observable'
    },

    /**
     * @cfg {String} itemSelector
     * A {@link Ext.DomQuery DomQuery} selector which identifies the encapsulating elements of child
     * Components which participate in reordering.
     */
    itemSelector: '.x-box-item',

    /**
     * @cfg {Mixed} animate
     * If truthy, child reordering is animated so that moved boxes slide smoothly into position.
     * If this option is numeric, it is used as the animation duration in milliseconds.
     */
    animate: 100,

    constructor: function() {
        this.addEvents(
            /**
             * @event StartDrag
             * Fires when dragging of a child Component begins.
             * @param {Ext.ux.BoxReorderer} this
             * @param {Ext.container.Container} container The owning Container
             * @param {Ext.Component} dragCmp The Component being dragged
             * @param {Number} idx The start index of the Component being dragged.
             */
             'StartDrag',
            /**
             * @event Drag
             * Fires during dragging of a child Component.
             * @param {Ext.ux.BoxReorderer} this
             * @param {Ext.container.Container} container The owning Container
             * @param {Ext.Component} dragCmp The Component being dragged
             * @param {Number} startIdx The index position from which the Component was initially dragged.
             * @param {Number} idx The current closest index to which the Component would drop.
             */
             'Drag',
            /**
             * @event ChangeIndex
             * Fires when dragging of a child Component causes its drop index to change.
             * @param {Ext.ux.BoxReorderer} this
             * @param {Ext.container.Container} container The owning Container
             * @param {Ext.Component} dragCmp The Component being dragged
             * @param {Number} startIdx The index position from which the Component was initially dragged.
             * @param {Number} idx The current closest index to which the Component would drop.
             */
             'ChangeIndex',
            /**
             * @event Drop
             * Fires when a child Component is dropped at a new index position.
             * @param {Ext.ux.BoxReorderer} this
             * @param {Ext.container.Container} container The owning Container
             * @param {Ext.Component} dragCmp The Component being dropped
             * @param {Number} startIdx The index position from which the Component was initially dragged.
             * @param {Number} idx The index at which the Component is being dropped.
             */
             'Drop'
        );
        this.mixins.observable.constructor.apply(this, arguments);
    },

    init: function(container) {
        var me = this;
 
        me.container = container;
 
        // Set our animatePolicy to animate the start position (ie x for HBox, y for VBox)
        me.animatePolicy = {};
        me.animatePolicy[container.getLayout().names.x] = true;
        
        

        // Initialize the DD on first layout, when the innerCt has been created.
        me.container.on({
            scope: me,
            boxready: me.afterFirstLayout,
            beforedestroy: me.onContainerDestroy
        });
    },

    /**
     * @private Clear up on Container destroy
     */
    onContainerDestroy: function() {
        var dd = this.dd;
        if (dd) {
            dd.unreg();
            this.dd = null;
        }
    },

    afterFirstLayout: function() {
        var me = this,
            layout = me.container.getLayout(),
            names = layout.names,
            dd;
            
        // Create a DD instance. Poke the handlers in.
        // TODO: Ext5's DD classes should apply config to themselves.
        // TODO: Ext5's DD classes should not use init internally because it collides with use as a plugin
        // TODO: Ext5's DD classes should be Observable.
        // TODO: When all the above are trus, this plugin should extend the DD class.
        dd = me.dd = Ext.create('Ext.dd.DD', layout.innerCt, me.container.id + '-reorderer');
        Ext.apply(dd, {
            animate: me.animate,
            reorderer: me,
            container: me.container,
            getDragCmp: this.getDragCmp,
            clickValidator: Ext.Function.createInterceptor(dd.clickValidator, me.clickValidator, me, false),
            onMouseDown: me.onMouseDown,
            startDrag: me.startDrag,
            onDrag: me.onDrag,
            endDrag: me.endDrag,
            getNewIndex: me.getNewIndex,
            doSwap: me.doSwap,
            findReorderable: me.findReorderable
        });

        // Decide which dimension we are measuring, and which measurement metric defines
        // the *start* of the box depending upon orientation.
        dd.dim = names.width;
        dd.startAttr = names.beforeX;
        dd.endAttr = names.afterX;
    },

    getDragCmp: function(e) {
        return this.container.getChildByElement(e.getTarget(this.itemSelector, 10));
    },

    // check if the clicked component is reorderable
    clickValidator: function(e) {
        var cmp = this.getDragCmp(e);

        // If cmp is null, this expression MUST be coerced to boolean so that createInterceptor is able to test it against false
        return !!(cmp && cmp.reorderable !== false);
    },

    onMouseDown: function(e) {
        var me = this,
            container = me.container,
            containerBox,
            cmpEl,
            cmpBox;

        // Ascertain which child Component is being mousedowned
        me.dragCmp = me.getDragCmp(e);
        if (me.dragCmp) {
            cmpEl = me.dragCmp.getEl();
            me.startIndex = me.curIndex = container.items.indexOf(me.dragCmp);

            // Start position of dragged Component
            cmpBox = cmpEl.getBox();

            // Last tracked start position
            me.lastPos = cmpBox[this.startAttr];

            // Calculate constraints depending upon orientation
            // Calculate offset from mouse to dragEl position
            containerBox = container.el.getBox();
            if (me.dim === 'width') {
                me.minX = containerBox.left;
                me.maxX = containerBox.right - cmpBox.width;
                me.minY = me.maxY = cmpBox.top;
                me.deltaX = e.getPageX() - cmpBox.left;
            } else {
                me.minY = containerBox.top;
                me.maxY = containerBox.bottom - cmpBox.height;
                me.minX = me.maxX = cmpBox.left;
                me.deltaY = e.getPageY() - cmpBox.top;
            }
            me.constrainY = me.constrainX = true;
        }
    },

    startDrag: function() {
        var me = this,
            dragCmp = me.dragCmp;
            
        if (dragCmp) {
            // For the entire duration of dragging the *Element*, defeat any positioning and animation of the dragged *Component*
            dragCmp.setPosition = Ext.emptyFn;
            dragCmp.animate = false;

            // Animate the BoxLayout just for the duration of the drag operation.
            if (me.animate) {
                me.container.getLayout().animatePolicy = me.reorderer.animatePolicy;
            }
            // We drag the Component element
            me.dragElId = dragCmp.getEl().id;
            me.reorderer.fireEvent('StartDrag', me, me.container, dragCmp, me.curIndex);
            // Suspend events, and set the disabled flag so that the mousedown and mouseup events
            // that are going to take place do not cause any other UI interaction.
            dragCmp.suspendEvents();
            dragCmp.disabled = true;
            dragCmp.el.setStyle('zIndex', 100);
        } else {
            me.dragElId = null;
        }
    },

    /**
     * @private
     * Find next or previous reorderable component index.
     * @param {Number} newIndex The initial drop index.
     * @return {Number} The index of the reorderable component.
     */
    findReorderable: function(newIndex) {
        var me = this,
            items = me.container.items,
            newItem;

        if (items.getAt(newIndex).reorderable === false) {
            newItem = items.getAt(newIndex);
            if (newIndex > me.startIndex) {
                 while(newItem && newItem.reorderable === false) {
                    newIndex++;
                    newItem = items.getAt(newIndex);
                }
            } else {
                while(newItem && newItem.reorderable === false) {
                    newIndex--;
                    newItem = items.getAt(newIndex);
                }
            }
        }

        newIndex = Math.min(Math.max(newIndex, 0), items.getCount() - 1);

        if (items.getAt(newIndex).reorderable === false) {
            return -1;
        }
        return newIndex;
    },

    /**
     * @private
     * Swap 2 components.
     * @param {Number} newIndex The initial drop index.
     */
    doSwap: function(newIndex) {
        var me = this,
            items = me.container.items,
            container = me.container,
            wasRoot = me.container._isLayoutRoot,
            orig, dest, tmpIndex, temp;

        newIndex = me.findReorderable(newIndex);

        if (newIndex === -1) {
            return;
        }

        me.reorderer.fireEvent('ChangeIndex', me, container, me.dragCmp, me.startIndex, newIndex);
        orig = items.getAt(me.curIndex);
        dest = items.getAt(newIndex);
        items.remove(orig);
        tmpIndex = Math.min(Math.max(newIndex, 0), items.getCount() - 1);
        items.insert(tmpIndex, orig);
        items.remove(dest);
        items.insert(me.curIndex, dest);

        // Make the Box Container the topmost layout participant during the layout.
        container._isLayoutRoot = true;
        container.updateLayout();
        container._isLayoutRoot = wasRoot;
        me.curIndex = newIndex;
    },

    onDrag: function(e) {
        var me = this,
            newIndex;

        newIndex = me.getNewIndex(e.getPoint());
        if ((newIndex !== undefined)) {
            me.reorderer.fireEvent('Drag', me, me.container, me.dragCmp, me.startIndex, me.curIndex);
            me.doSwap(newIndex);
        }

    },

    endDrag: function(e) {
        if (e) {
            e.stopEvent();
        }
        var me = this,
            layout = me.container.getLayout(),
            temp;

        if (me.dragCmp) {
            delete me.dragElId;

            // Reinstate the Component's positioning method after mouseup, and allow the layout system to animate it.
            delete me.dragCmp.setPosition;
            me.dragCmp.animate = true;
            
            // Ensure the lastBox is correct for the animation system to restore to when it creates the "from" animation frame
            me.dragCmp.lastBox[layout.names.x] = me.dragCmp.getPosition(true)[layout.names.widthIndex];

            // Make the Box Container the topmost layout participant during the layout.
            me.container._isLayoutRoot = true;
            me.container.updateLayout();
            me.container._isLayoutRoot = undefined;
            
            // Attempt to hook into the afteranimate event of the drag Component to call the cleanup
            temp = Ext.fx.Manager.getFxQueue(me.dragCmp.el.id)[0];
            if (temp) {
                temp.on({
                    afteranimate: me.reorderer.afterBoxReflow,
                    scope: me
                });
            } 
            // If not animated, clean up after the mouseup has happened so that we don't click the thing being dragged
            else {
                Ext.Function.defer(me.reorderer.afterBoxReflow, 1, me);
            }

            if (me.animate) {
                delete layout.animatePolicy;
            }
            me.reorderer.fireEvent('drop', me, me.container, me.dragCmp, me.startIndex, me.curIndex);
        }
    },

    /**
     * @private
     * Called after the boxes have been reflowed after the drop.
     * Re-enabled the dragged Component.
     */
    afterBoxReflow: function() {
        var me = this;
        me.dragCmp.el.setStyle('zIndex', '');
        me.dragCmp.disabled = false;
        me.dragCmp.resumeEvents();
    },

    /**
     * @private
     * Calculate drop index based upon the dragEl's position.
     */
    getNewIndex: function(pointerPos) {
        var me = this,
            dragEl = me.getDragEl(),
            dragBox = Ext.fly(dragEl).getBox(),
            targetEl,
            targetBox,
            targetMidpoint,
            i = 0,
            it = me.container.items.items,
            ln = it.length,
            lastPos = me.lastPos;

        me.lastPos = dragBox[me.startAttr];

        for (; i < ln; i++) {
            targetEl = it[i].getEl();

            // Only look for a drop point if this found item is an item according to our selector
            if (targetEl.is(me.reorderer.itemSelector)) {
                targetBox = targetEl.getBox();
                targetMidpoint = targetBox[me.startAttr] + (targetBox[me.dim] >> 1);
                if (i < me.curIndex) {
                    if ((dragBox[me.startAttr] < lastPos) && (dragBox[me.startAttr] < (targetMidpoint - 5))) {
                        return i;
                    }
                } else if (i > me.curIndex) {
                    if ((dragBox[me.startAttr] > lastPos) && (dragBox[me.endAttr] > (targetMidpoint + 5))) {
                        return i;
                    }
                }
            }
        }
    }
});

Ext.define('Ext.ux.ToolbarDroppable', {

    /**
     * Creates new ToolbarDroppable.
     * @param {Object} config Config options.
     */
    constructor: function(config) {
      Ext.apply(this, config);
    },

    /**
     * Initializes the plugin and saves a reference to the toolbar
     * @param {Ext.toolbar.Toolbar} toolbar The toolbar instance
     */
    init: function(toolbar) {
      /**
       * @property toolbar
       * @type Ext.toolbar.Toolbar
       * The toolbar instance that this plugin is tied to
       */
      this.toolbar = toolbar;

      this.toolbar.on({
          scope : this,
          render: this.createDropTarget
      });
    },

    /**
     * Creates a drop target on the toolbar
     */
    createDropTarget: function() {
        /**
         * @property dropTarget
         * @type Ext.dd.DropTarget
         * The drop target attached to the toolbar instance
         */
        this.dropTarget = Ext.create('Ext.dd.DropTarget', this.toolbar.getEl(), {
            notifyOver: Ext.Function.bind(this.notifyOver, this),
            notifyDrop: Ext.Function.bind(this.notifyDrop, this)
        });
    },

    /**
     * Adds the given DD Group to the drop target
     * @param {String} ddGroup The DD Group
     */
    addDDGroup: function(ddGroup) {
        this.dropTarget.addToGroup(ddGroup);
    },

    /**
     * Calculates the location on the toolbar to create the new sorter button based on the XY of the
     * drag event
     * @param {Ext.EventObject} e The event object
     * @return {Number} The index at which to insert the new button
     */    
    calculateEntryIndex: function(e) {
        var entryIndex = 0,
            toolbar = this.toolbar,
            items = toolbar.items.items,
            count = items.length,
            xHover = e.getXY()[0],
            index = 0,
            el, xTotal, width, midpoint;
 
        for (; index < count; index++) {
            el = items[index].getEl();
            xTotal = el.getXY()[0];
            width = el.getWidth();
            midpoint = xTotal + width / 2;
 
            if (xHover < midpoint) {
                entryIndex = index; 
                break;
            } else {
                entryIndex = index + 1;
            }
       }
       return entryIndex;
    },

    /**
     * Returns true if the drop is allowed on the drop target. This function can be overridden
     * and defaults to simply return true
     * @param {Object} data Arbitrary data from the drag source
     * @return {Boolean} True if the drop is allowed
     */
    canDrop: function(data) {
        return true;
    },

    /**
     * Custom notifyOver method which will be used in the plugin's internal DropTarget
     * @return {String} The CSS class to add
     */
    notifyOver: function(dragSource, event, data) {
        return this.canDrop.apply(this, arguments) ? this.dropTarget.dropAllowed : this.dropTarget.dropNotAllowed;
    },

    /**
     * Called when the drop has been made. Creates the new toolbar item, places it at the correct location
     * and calls the afterLayout callback.
     */
    notifyDrop: function(dragSource, event, data) {
        var canAdd = this.canDrop(dragSource, event, data),
            tbar   = this.toolbar;

        if (canAdd) {
            var entryIndex = this.calculateEntryIndex(event);

            tbar.insert(entryIndex, this.createItem(data));
            tbar.doLayout();

            this.afterLayout();
        }

        return canAdd;
    },

    /**
     * Creates the new toolbar item based on drop data. This method must be implemented by the plugin instance
     * @param {Object} data Arbitrary data from the drop
     * @return {Mixed} An item that can be added to a toolbar
     */
    createItem: function(data) {
        //<debug>
        Ext.Error.raise("The createItem method must be implemented in the ToolbarDroppable plugin");
        //</debug>
    },

    /**
     * Called after a new button has been created and added to the toolbar. Add any required cleanup logic here
     */
    afterLayout: Ext.emptyFn
});

/**
 * Default state model.
 *
 * This implementation only contains <key,value> pairs. This model contains no relation to the actual user session.
 */
Ext.define('App.ux.state.Model', {

    extend: 'Ext.data.Model',

    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'uid',
            type: 'int'
        },
        {
            name: 'name',
            type: 'string'
        },
        {
            name: 'value',
            type: 'string'
        }
    ]

});
/**
 * Default state store.
 *
 * This implementation relies on a simple remote HTTP based storage.
 */
Ext.define('App.ux.state.Store', {

    extend  : 'Ext.data.Store',
    requires: [ 'App.ux.state.Model' ],

    model: 'App.ux.state.Model',

    pageSize: -1,

    proxy: {
        type  : 'direct',
        api: {
            read: 'AppState.AppStateGet',
            create: 'AppState.AppStateSet',
            update: 'AppState.AppStateSet',
            destroy: 'AppState.AppStateUnSet',
        },
        reader: {
            type: 'json',
            root: 'data',
        },
        writer: {
            type: 'json'
        }
    }

});
/**
 * A StateProvider solution for Ext JS applications using backend driven states via HTTP.
 *
 * The default configuration enables buffering to avoid multiple write requests.
 */
Ext.define('App.ux.state.HttpProvider', {

    extend: 'Ext.state.Provider',

    requires: [ 'App.ux.state.Store' ],

    uses: [ 'Ext.state.Provider', 'Ext.util.Observable' ],

    /**
     * The internal store.
     */
    store: null,

    /**
     * If set to true (not default), the store will be loaded at startup.
     */
    storeSyncOnLoadEnabled: false,

    /**
     * If set to true (default), the store's write event will be buffered to avoid multiple calls at the same time.
     */
    buffered: true,

    /**
     * Defines the buffer time (in milliseconds) for the buffered store.
     */
    writeBuffer: 2000,

    /**
     * Callback which will be called on the first store load. This requires storeSyncOnLoadEnabled = true.
     */
    onFirstLoad: Ext.emptyFn,

    constructor: function (config) {
        config = config || {};
        var me = this;
        Ext.apply(me, config);

        if (!me.store) {
            me.store = me.buildStore();
        }

        /**
         * Unless we found a better solution, the following lines ensure that the component's constructor will be
         * returned only if the store was loaded the first time.
         *
         * See also: http://www.sencha.com/forum/showthread.php?141207
         */
        if (me.storeSyncOnLoadEnabled) {
            // Have to block in order to load the store before leaving the
            // constructor, otherwise, the first query may be against an
            // empty store. There must be a better way...
            var oldValue = Ext.data.Connection.prototype.async;
            Ext.data.Connection.prototype.async = false;
            me.store.load({
                callback: me.onFirstLoad
            });
            Ext.data.Connection.prototype.async = oldValue;
        }

        // Call super
        me.callParent(arguments);

        if (me.buffered) {
            me.on({
                'statechange': {
                    scope : me,
                    buffer: me.writeBuffer,
                    fn    : me.sync
                }
            });
        } else {
            me.on({
                'statechange': {
                    scope: me,
                    fn   : me.sync
                }
            });
        }
    },

    set: function (name, value) {
        var me = this, pos = me.store.findExact('name', name), row;

        if (pos > -1) {
            row = me.store.getAt(pos);
            row.set('value', me.encodeValue(value));
        } else {
            me.store.add({
                uid : app.user.id,
                name : name,
                value: me.encodeValue(value)
            });
        }

        me.fireEvent('statechange', me, name, value);
    },

    get: function (name, defaultValue) {
        var me = this, pos = me.store.findExact('name', name), row, value;
        if (pos > -1) {
            row = me.store.getAt(pos);
            value = me.decodeValue(row.get('value'));
        } else {
            value = defaultValue;
        }
        return value;
    },

    clear: function (name) {
        var me = this, pos = me.store.findExact('name', name);
        if (pos > -1) {
            me.store.removeAt(pos);
            me.fireEvent('statechange', me, name, null);
        }
    },

    sync: function () {
        this.store.sync();
    },

    buildStore: function () {
        return Ext.create('App.ux.state.Store');
    }

});
Ext.define('App.ux.HelpBtn', {
	extend: 'Ext.button.Button',
	xtype: 'helpbutton',
	icon: 'resources/images/icons/icohelp.png',
	tooltip: _('help_document'),
	hrefTarget: '_blank',
	href: 'about:blank',
});

Ext.define('App.ux.ActivityMonitor', {
	singleton: true,
	controller: null,
	ui: null,
	runner: null,
	task: null,
	lastActive: null,
	locked: false,
	ready: false,
	verbose: false,
	interval: (1000 * 60), //1 minute
	maxLock: (1000 * 60 * 10), //1 minutes
	maxInactive: (1000 * 60 * 5), //5 minutes

	init: function(config){
		if(!config){
			config = {};
		}

		Ext.apply(this, config, {
			runner: new Ext.util.TaskRunner(),
			ui: Ext.getBody(),
			task: {
				run: this.monitorUI,
				interval: config.interval || this.interval,
				scope: this
			}
		});
		this.ready = true;
	},

	isReady: function(){
		return this.ready;
	},

	isActive: Ext.emptyFn,
	isInactive: Ext.emptyFn,
	isLock: Ext.emptyFn,
	isUnLock: Ext.emptyFn,

	start: function(){
		if(!this.isReady()){
			this.log('Please run ActivityMonitor.init()');
			return false;
		}

		this.ui.on('mousemove', this.captureActivity, this);
		this.ui.on('keydown', this.captureActivity, this);

		this.lastActive = new Date();
		this.log('ActivityMonitor has been started.');

		this.runner.start(this.task);

		return true;
	},

	stop: function(){
		if(!this.isReady()){
			this.log('Please run ActivityMonitor.init()');
			return false;
		}

		this.runner.stop(this.task);
		this.lastActive = null;

		this.ui.un('mousemove', this.captureActivity);
		this.ui.un('keydown', this.captureActivity);

		this.log('ActivityMonitor has been stopped.');

		return true;
	},

	captureActivity: function(){
		if(this.controller.logoutWarinigWindow) {
			this.controller.cancelAutoLogout();
		}

		if(this.locked){
			this.isUnLock();
			this.locked = false;
		}

		this.lastActive = new Date();
	},

	monitorUI: function(){
		var now = new Date(), inactive = (now - this.lastActive);

		if(!this.locked && inactive >= this.maxLock){
			this.log('MAXIMUM LOCK TIME HAS BEEN REACHED');
			this.locked = true;
			this.isLock();
		}

		if(inactive >= this.maxInactive){
			this.log('MAXIMUM INACTIVE TIME HAS BEEN REACHED');
			this.stop();

			this.isInactive();
		}else{
			this.log('CURRENTLY INACTIVE FOR ' + Math.floor(inactive / 1000) + ' SECONDS)');
			this.isActive();
		}
	},

	log: function(msg){
		if(this.verbose){
			window.console.log(msg);
		}
	}
});

/*!
 * Ext.ux.RatingField
 *
 * Copyright 2011, Dan Harabagiu
 * Licenced under the Apache License Version 2.0
 * See LICENSE
 *
 *
 * Version : 0.1 - Initial coding
 * Version : 0.2
 *  - Added Field reset button
 *  - Added CSS class for reset button
 *  - Added reset function for the field
 *  - Minimum number of stars is 2
 *  - On creation default value is now 0, was null
 *  - Option to choose left / right for the reset button position
 */
/*global Ext : false, */
Ext.define('App.ux.RatingField', {
	extend: 'Ext.form.field.Number',
	alias: 'widget.ratingField',
	componentCls: 'x-form-rating',
	ratingClassReset: "ux-rating-reset",
	starCls: 'ux-rating-star',
	margin: '4 10',
	/**
	 * @cfg {Number} numberOfStars
	 *
	 */
	numberOfStars: 5,

	/**
	 * @cfg {Number} minValue
	 * css Number of stars to display
	 */
	minValue: 0,

	/**
	 * @cfg {Number} maxValue
	 *
	 */
	maxValue: 5,

	/**
	 * @cfg {Number} split
	 * number of split per star (to show a gradual selection)
	 */
	split: 1,

	/**
	 * @cfg {Number} canReset
	 * true to show a reset button
	 */
	canReset: true,

	/**
	 * @cfg {Number} resetPosition
	 * position of reset button when canReset is true. Whatever is not equal to 'right' is considered as 'left'
	 */
	resetPosition: "right",

	/**
	 * @cfg {Number} emptyText
	 *
	 */
	emptyText: '',

	/**
	 * @cfg {Number} keyNavEnabled
	 * when set to true, special keys (arrows, space and del) are  enabled to set value on focus.
	 */
	keyNavEnabled: true,

	/**
	 * @cfg {Object} titles
	 * Object used when setting titles to stars. In example below, star values from 0 to 1.4 would carry 'poor' as a title, from 1.4 to 3, 'medium', etc
	 */
	/*titles: {
	 '0': 'poor',
	 '1.4': 'medium',
	 '3': 'excellent',
	 '5': 'perfect'
	 },*/
	initComponent: function () {
		var me = this;
		Ext.applyIf(me, {
			maxValue: 5,
			minValue: 0,
			split: 1,
			numberOfStars: 5,
			titles: {}
		});
		var tempVal = [],
			hasTitle,
			name,
			split = me.split,
			width = 16 / split,
			nb = me.numberOfStars,
			len = nb * split - 1,
			minValue = me.minValue,
			maxValue = me.maxValue,
			val, title, i;

		for (name in me.titles) {
			tempVal.push({
				val: name * 1,
				title: me.titles[name]
			});
		}
		hasTitle = !!tempVal.length;
		Ext.Array.sort(tempVal, function (a, b) {
			return a.val > b.val;
		});

		//me.step = (maxValue - minValue) / len;
		me.stars = [];
		me.values = [];
		me.titles = [];
		me.starWidth = width;
		if (!me.value) {
			me.value = minValue;
		}
		for (i = 0; i <= len; i++) {
			val = i + 1;
			if (hasTitle) {
				if (tempVal.length && (tempVal[1].val <= val)) {
					tempVal = tempVal.slice(1);
				}
				title = tempVal[0].title;
			} else {
				title = val;
			}
			me.stars.push({
				key: val,
				title: title,
				margin: (i % split) * width
			});
			me.values.push(val);
			me.titles.push(title);
		}
		me.msgTarget = 'side';
		me.starClsOn = me.starCls + '-on';
		me.starClsHover = me.starCls + '-hover';
		me.starClsFocus = me.starCls + '-focus';
		me.callParent();

	},
	setValue: function (val) {
		var me = this;
		me.callParent(arguments);
		me.afterSetValue(eval(val));
	},
	afterSetValue: function (val) {
		var me = this;
		if (me.rendered) {
			var index = me.getValueIndex(val);
			if (index === -1) {
				if (me.canReset) {
					me.resetEl.setOpacity(0.5);
				}
				me.fillNone();
				me.selected = -1;
			} else if (index !== me.selected) {
				if (me.canReset) {
					me.resetEl.setOpacity(0.99);
				}
				me.selected = index;
				me.fillTo(index, false);

			}
		}
	},
	getValueIndex: function (val) {
		var me = this;
		if (val == me.emptyText || !Ext.isDefined(val) || (val > me.maxValue) || (val < me.minValue)) {
			return -1
		}
		var ret = me.values.indexOf(val);
		if (ret > -1) {
			return ret
		}
		return Ext.each(me.values, function (v, i) {
			if (v >= val) {
				return false
			}
		});
	},

	addFocusListener: function () {
		var me = this;
		if (!me.focusListenerAdded) {
			me.focusEl.on({
				focus: me.onFocus,
				blur: me.onBlur,
				scope: me
			});
			me.focusListenerAdded = true;
		}
	},
	onFocus: function () {
		var me = this;
		if (me.isReactive()) {
			me.bodyEl.addCls(me.starClsFocus)
		}
	},
	onBlur: function () {
		var me = this
		me.bodyEl.removeCls(me.starClsFocus)
	},
	afterRender: function (ct, position) {
		var me = this,
			rightPos = me.resetPosition == 'right',
			cancel = '<div class="reset-el ' + me.ratingClassReset + '" title="reset" style="margin-' + (rightPos ? 'left' : 'right') + ':5px;"></div>';

		me.callParent();
		var tpl = new Ext.XTemplate(
			'<div class="ux-rating-container ux-rating-clearfix" tabIndex="'+ me.tabIndex +'">',
			rightPos ? '' : cancel,
			'<tpl for=".">',
			'<div key="{key}" class="', me.starCls, '" style="width: ', me.starWidth, 'px;">',
			'<a title="{title}" style="margin-left: -{margin}px;">{key}</a>',
			'</div>',
			'</tpl>',
			'<input type="hidden" name="', me.getName(), '" class="input-el" tabIndex="'+ me.tabIndex +'"></hidden>',
			rightPos ? cancel : '',
			'<a class="focus-el" tabIndex="0"></a>',
			'</div>',

			{
				compiled: true
			});

		me.stars = tpl.overwrite(me.bodyEl, me.stars, true).query('.' + me.starCls);
		me.focusEl = Ext.get(Ext.query('a.focus-el', me.bodyEl.dom[0]));
		me.inputEl = Ext.get(Ext.query('input.input-el', me.bodyEl.dom)[0]);
		me.resetEl = Ext.get(Ext.query('div.reset-el', me.bodyEl.dom)[0]);
	},
	initEvents: function () {
		var me = this;
		me.callParent(arguments);
		me.bodyEl.on({
			click: me.onStarClick,
			mouseover: me.onStarOver,
			mouseout: me.onStarOut,
			scope: me,
			delegate: 'div.ux-rating-star'
		});
		if (me.canReset) {
			me.resetEl.visibilityMode = Ext.Element.DISPLAY;
			me.resetEl.hover(
                function () {
                    if (me.isReactive() && me.getValue() > 0) {
                        Ext.fly(this).addCls('ux-rating-reset-hover');
                    }
			    },
                function () {
                    if (me.isReactive()) {
                        Ext.fly(this).removeCls('ux-rating-reset-hover');
                    }
			    }
            );

			me.resetEl.on('click', me.reset, me);
		}
		// Init arrow keys amd space/del for reseting
		if (me.keyNavEnabled) {
			me.spinnerKeyNav = new Ext.util.KeyNav(me.focusEl, {
				scope: me,
				up: me.spinUp,
				down: me.spinDown,
				right: me.spinUp,
				left: me.spinDown,
				space: me.reset,
				del: me.reset
			});
		}
		me.setValue(me.value)
	},
	reset: function (ev, t) {
		if (this.isReactive() && this.getValue() > 0) {
			this.setValue(0);
			this.fireEvent('click', this, 0);
		}
	},

	isReactive: function () {
		return !this.readOnly && !this.disabled
	},
	onStarClick: function (e, t) {
		var me = this, val;
		if (me.isReactive()){
			val = me.values[me.stars.indexOf(t)];
			me.setValue(val);
			me.fireEvent('click', me, val);
		}
	},
	onStarOver: function (e, t) {
		if (this.isReactive()) {
			this.fillTo(this.stars.indexOf(t), true);
		}
	},
	onStarOut: function (e, t) {
		if (this.isReactive()) {
			this.fillTo(this.selected);
		}
	},
	fillTo: function (index, hover) {
		var me = this;
		if (index != -1) {
			var addCls = hover ? me.starClsHover : me.starClsOn;
			var removeCls = hover ? me.starClsOn : me.starClsHover;

			// We add a css class to each star up until the selected one
			Ext.each(me.stars.slice(0, index + 1), function () {
				Ext.fly(this).removeCls(removeCls).addCls(addCls);
			});

			// And then remove the same class from all the stars after this one
			Ext.each(me.stars.slice(index + 1), function () {
				Ext.fly(this).removeCls([removeCls, addCls]);
			});
		} else {
			me.fillNone();
		}
	},
	fillNone: function () {
		this.bodyEl.select('.ux-rating-star').removeCls(['ux-rating-star-hover', 'ux-rating-star-on']);
	}
});
Ext.define('App.ux.LiveICDXSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.liveicdxsearch',
	hideLabel: true,

	triggerTip: _('click_to_clear_selection'),
	spObj: '',
	spForm: '',
	spExtraParam: '',
	qtip: _('clearable_combo_box'),
	trigger1Class: 'x-form-select-trigger',
	trigger2Class: 'x-form-clear-trigger',

	displayField: 'code_text', // this should be code
	valueField: 'code',

	emptyText: _('search') + '...',
	typeAhead: false,
	minChars: 1,
	anchor: '100%',

	listConfig: {
		loadingText: _('searching') + '...',
		getInnerTpl: function(){
			return '<div class="search-item">{code_type} <span style="font-weight: bold;">{code}</span>: {code_text} - ({occurrences})</div>';
		}
	},

	initComponent: function(){
		var me = this;

		Ext.define('liveICDXSearchModel' + this.id, {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'id', type: 'int' },
				{ name: 'code', type: 'string' },
				{ name: 'xcode', type: 'string' },
				{ name: 'code_text', type: 'string' },
				{ name: 'code_type', type: 'string' },
				{ name: 'occurrences', type: 'int' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'DiagnosisCodes.ICDCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveICDXSearchModel' + this.id,
			pageSize: 1000,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store
		});

		me.callParent();

		me.on('select', me.addOccurrence);
	},

	addOccurrence: function (cmb, records) {
		if(records.length > 0 && records[0].get('code') !== ''){
			DiagnosisCodes.addOccurrence(records[0].get('code'));
		}
	},

	onRender: function(ct, position){
        var trigger2,
            id = this.getId();
		this.callParent(arguments);
		this.triggerConfig = {
			tag: 'div',
			cls: 'x-form-twin-triggers',
			style: 'display:block;',
			cn: [
				{
					tag: "img",
					style: Ext.isIE ? 'margin-left:0;height:21px' : '',
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					cls: "x-form-trigger " + this.trigger2Class
				}
			]
		};
		this.triggerEl.replaceWith(this.triggerConfig);
		this.triggerEl.on('mouseup', function(e){
			if(e.target.name == "trigger2" + id){
				this.reset();
				this.oldValue = null;
				if(this.spObj !== '' && this.spExtraParam !== ''){
					Ext.getCmp(this.spObj).store.setExtraParam(this.spExtraParam, '');
					Ext.getCmp(this.spObj).store.load()
				}
				if(this.spForm !== ''){
					Ext.getCmp(this.spForm).getForm().reset();
				}
			}

		}, this);
		trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	}
});

Ext.define('App.ux.LiveCPTSearch', {
	extend: 'Ext.form.field.ComboBox',
	xtype: 'livecptsearch',
	hideLabel: true,
	triggerTip: _('click_to_clear_selection'),
	spObj: '',
	spForm: '',
	spExtraParam: '',
	displayField: 'code_text_medium',
	valueField: 'code',
	qtip: _('clearable_combo_box'),
	trigger1Class: 'x-form-select-trigger',
	trigger2Class: 'x-form-clear-trigger',
    hideTrigger: true,
	initComponent: function(){
		var me = this;

		Ext.define('liveCPTSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'id' },
				{ name: 'eid' },
				{ name: 'code', type: 'strig' },
				{ name: 'code_text', type: 'string' },
				{ name: 'code_text_medium', type: 'string' },
				{ name: 'code_type', type: 'string', defaultValue: 'CPT' },
				{ name: 'place_of_service', type: 'string' },
				{ name: 'emergency', type: 'string' },
				{ name: 'charge', type: 'string' },
				{ name: 'days_of_units', type: 'string' },
				{ name: 'essdt_plan', type: 'string' },
				{ name: 'modifiers', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Services.liveCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				},
				extraParams: {
					code_type: 'cpt'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveCPTSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			emptyText: _('search') + '...',
			typeAhead: false,
			minChars: 1,
			anchor: '100%',
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item">{code}: {code_text_medium}</div>';
				}
			},
			pageSize: 25
		});

		me.callParent();
	},

	onRender: function(ct, position){

	    var me = this;

        me.callParent(arguments);
		var id = me.getId();
        me.triggerConfig = {
			tag: 'div',
			cls: 'x-form-twin-triggers',
			style: 'display:block;',
			cn: [
				{
					tag: "img",
					style: Ext.isIE ? 'margin-left:0;height:21px' : '',
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					cls: "x-form-trigger " + me.trigger2Class
				}
			]
		};
        me.triggerEl.replaceWith(me.triggerConfig);
        me.triggerEl.on('mouseup', function(e){
			if(e.target.name == "trigger2" + id){
                me.clearValue();
                // me.reset();
                me.oldValue = null;
				if(me.spObj !== '' && me.spExtraParam !== ''){
					Ext.getCmp(me.spObj).store.setExtraParam(me.spExtraParam, '');
					Ext.getCmp(me.spObj).store.load()
				}
				if(me.spForm !== ''){
					Ext.getCmp(me.spForm).getForm().reset();
				}
			}
		});
		var trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	}
});
Ext.define('App.ux.AbstractPanel', {

    calculatePercent:function(percent, value){
        return 100 * ( percent / value );
    },

	setReadOnly:function(readOnly){
		var forms = this.query('form');

		for(var j = 0; j < forms.length; j++) {
			var form = forms[j], items;
			if(form.readOnly != readOnly){
				form.readOnly = readOnly;
				items = form.getForm().getFields().items;
				for(var k = 0; k < items.length; k++){
					items[k].setReadOnly(readOnly);
				}
			}
		}
		return readOnly;
	},

	setButtonsDisabled:function(buttons, disabled){
		var disable = disabled || app.patient.readOnly;
		for(var i = 0; i < buttons.length; i++) {
			var btn = buttons[i];
			if(btn.disabled != disable){
				btn.disabled = disable;
				btn.setDisabled(disable)
			}
		}
	},

	goBack: function() {
		app.nav.goBack();
	},

	checkIfCurrPatient: function() {
		return app.getCurrPatient();
	},

	patientInfoAlert: function() {
		var patient = app.getCurrPatient();

		Ext.Msg.alert(_('status'), _('patient') + ': ' + patient.name + ' (' + patient.pid + ')');
	},

	currPatientError: function() {
		Ext.Msg.show({
			title  : 'Oops! ' + _('no_patient_selected'),
			msg    : _('select_patient_patient_live_search'),
			scope  : this,
			buttons: Ext.Msg.OK,
			icon   : Ext.Msg.ERROR,
			fn     : function() {
				this.goBack();
			}
		});
	},

    getFormItems: function(formPanel, formToRender, callback) {
	    if(formPanel) formPanel.removeAll();
	    FormLayoutEngine.getFields({formToRender: formToRender}, function(provider, response) {
            var items = eval(response.result),
                form = formPanel ? formPanel.add(items) : false;
	        if(typeof callback == 'function') callback(formPanel, items, true);
	        return form;
        });
    },

	boolRenderer: function(val) {
		if(val == '1' || val == true || val == 'true') {
			return '<div style="margin-left:auto; margin-right:auto; width:16"><img src="resources/images/icons/yes.png" /></div>';
		} else if(val == '0' || val == false || val == 'false') {
			return '<div style="margin-left:auto; margin-right:auto; width:16"><img src="resources/images/icons/no.png" /></div>';
		}
		return val;
	},

	alertRenderer: function(val) {
		if(val == '1' || val == true || val == 'true') {
			return '<img style="padding-left: 13px" src="resources/images/icons/no.png" />';
		} else if(val == '0' || val == false || val == 'false') {
			return '<img style="padding-left: 13px" src="resources/images/icons/yes.png" />';
		}
		return val;
	},

    warnRenderer:function(val, metaData, record){
	    var toolTip = record.data.warningMsg ? record.data.warningMsg : '';

        if(val == '1' || val == true || val == 'true') {
            return '<img src="resources/images/icons/icoImportant.png" ' + toolTip + ' />';
        }else{
            return val;
        }
    },

	onExpandRemoveMask: function(cmb) {
		cmb.picker.loadMask.destroy()
	},

	strToLowerUnderscores: function(str) {
		return str.toLowerCase().replace(/ /gi, "_");
	},

	getCurrPatient: function() {
		return app.getCurrPatient();
	},

	getApp: function() {
		return app.getApp();
	},

	msg: function(title, format) {
		app.msg(title, format)
	},

	alert:function(msg, icon) {
		app.alert(msg,icon)
	},

    passwordVerificationWin:function(callback){
        var msg = Ext.Msg.prompt(_('password_verification'), _('please_enter_your_password') + ':', function(btn, password) {
            callback(btn, password);
        });
        var f = msg.textField.getInputId();
        document.getElementById(f).type = 'password';
        return msg;
    },
    getPageHeader:function(){
        return this.getComponent('RenderPanel-header');
    },
    getPageBodyContainer:function(){
        return this.getComponent('RenderPanel-body-container');
    },
    getPageBody:function(){
        return this.getPageBodyContainer().down('panel');
    }

});

Ext.define('App.ux.LiveImmunizationSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'immunizationlivesearch',
	hideLabel: true,
	displayField: 'name',
	valueField: 'cvx_code',
	emptyText: _('immunization_search') + '...',
	typeAhead: true,
	minChars: 1,
	initComponent: function(){
		var me = this;

		Ext.define('liveImmunizationSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'id', type: 'int'},
				{name: 'cvx_code', type: 'string'},
				{name: 'name', type: 'string'},
				{name: 'description', type: 'string'},
				{name: 'note', type: 'string'},
				{name: 'status', type: 'string'},
				{name: 'update_date', type: 'date', dateFormat: 'Y-m-d H:i:s'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Immunizations.getImmunizationLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveImmunizationSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item">CVX - {cvx_code}: <span style="font-weight: normal;" class="list-status-{status}">{name} ({status})</span></div>';
				}
			},
			pageSize: 10
		});

		me.callParent();
	}
});

Ext.define('App.ux.LiveLabsSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'labslivetsearch',
	hideLabel: true,

	initComponent: function(){
		var me = this;

		Ext.define('liveLoincSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'id' },
				{ name: 'loinc_name' },
				{ name: 'loinc_number' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Laboratories.getLabLoincLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveLoincSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			displayField: 'loinc_name',
			valueField: 'loinc_name',
			emptyText: _('laboratories_search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 1,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{loinc_name} ({loinc_number})</h3></div>';
				}
			},
			pageSize: 10
		});

		me.callParent();
	}
});

Ext.define('App.ux.LiveCDTSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.cdtlivetsearch',
	hideLabel: true,

	initComponent: function(){
		var me = this;

		Ext.define('liveCDTSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'id' },
				{ name: 'code' },
				{ name: 'text' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Medical.getCDTLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveCDTSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			displayField: 'text',
			valueField: 'code',
			emptyText: _('search_for_a_CDT') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 1,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{code}<span style="font-weight: normal"> ({text}) </span></h3></div>';
				}
			},
			pageSize: 10
		});

		me.callParent();
	}
});

Ext.define('App.ux.LiveRXNORMAllergySearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.rxnormallergylivetsearch',
	hideLabel: true,
	displayField: 'STR',
	valueField: 'STR',
	initComponent: function(){
		var me = this;

		Ext.define('liveRXNORMAllergySearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'RXCUI', type: 'auto'},
				{name: 'CODE', type: 'auto'},
				{name: 'STR', type: 'auto'},
				{name: 'DST', type: 'auto'},
				{name: 'DRT', type: 'auto'},
				{name: 'DDF', type: 'auto'},
				{name: 'DDFA', type: 'auto'},
				{name: 'RXN_QUANTITY', type: 'auto'},
				{name: 'SAB', type: 'auto'},
				{name: 'RXAUI', type: 'auto'},
				{name: 'CodeType', defaultValue: 'RXNORM'},
				{name: 'occurrences', type: 'int'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Rxnorm.getRXNORMAllergyLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveRXNORMAllergySearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			emptyText: _('allergy_search')+'...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 3,
            maxLength: 255,
			listConfig: {
				loadingText: _('searching')+'...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{STR}<span style="font-weight: normal"> ({RXCUI}) ({occurrences}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', me.addOccurrence);
	},

	addOccurrence: function (cmb, records) {
		if (records.length > 0 && records[0].get('RXCUI') !== '') {
			Rxnorm.addOccurrence(records[0].get('RXCUI'));
		}
	}
});

Ext.define('App.ux.LiveSigsSearch', {
	extend: 'Ext.form.field.ComboBox',
	alias: 'widget.livesigssearch',

	initComponent: function(){
		var me = this;

		Ext.define('liveSigsSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'option_value', type: 'string' },
				{ name: 'option_name', type: 'string'    }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Prescriptions.getSigCodesByQuery'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveSigsSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(me, {
			store: me.store,
			displayField: 'option_value',
			valueField: 'option_value',
			emptyText: _('search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 1,
			anchor: '100%',
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item">{option_value} ({option_name})</div>';
				}
			},
			//				pageSize:25,
			listeners: {
				scope: me,
				beforeselect: me.onBeforeSigSelect,
				select: me.onBeSigSelect
			}
		});

		me.callParent(arguments);
	},

	onBeforeSigSelect: function(cmb, record){
		//say(cmb);
		//say(record);
	},

	onBeSigSelect: function(cmb, record){
		//say(cmb);
		//say(record);
	}


});

Ext.define('App.ux.LivePatientSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.patienlivetsearch',
	hideLabel: true,
	displayField: 'fullname',
	valueField: 'pid',
	emptyText: _('search_for_a_patient') + '...',
	maxLength: 40,
    queryMode: 'remote',
    allowBlank: true,
	typeAhead: false,
    forceSelection: false,
    allowOnlyWhitespace: true,
	hideTrigger: true,
    validateBlank: true,
    submitValue: true,
	minChars: 1,
	queryDelay: 500,
	resetEnabled: false,
	newPatientEnabled: false,
	newPatientCallback: undefined,
	initComponent: function(){
		var me = this;

		Ext.define('patientLiveSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'pid',
					type: 'int'
				},
				{
					name: 'pubpid',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'email',
					type: 'string'
				},
				{
					name: 'phone_mobile',
					type: 'string'
				},
				{
					name: 'phone_mobile',
					type: 'string'
				},
				{
					name: 'phone_home',
					type: 'string'
				},
				{
					name: 'fullname',
					type: 'string',
					convert: function(v, record){
						return record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname
					}
				},
				{
					name: 'hl7_fullname',
					type: 'string',
					convert: function(v, record){
						var name = [ record.data.lname ];
						if(record.data.fname){
							name.push(record.data.fname);
						}
						if(record.data.mname){
							name.push(record.data.mname);
						}
						return name.join('^');
					}
				},
				{
					name: 'DOB',
					type: 'date',
					dateFormat: 'Y-m-d H:i:s'
				},
				{
					name: 'sex',
					type: 'string'
				},
				{
					name: 'SS',
					type: 'string'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Patient.patientLiveSearch'
				},
                writer:{
                    writeAllFields: true
                },
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'patientLiveSearchModel',
			pageSize: 15,
			autoLoad: false
		});

		Ext.apply(me, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				minWidth: 600,
				maxHeight: 600,
				getInnerTpl: function(){
					var pid = (eval(g('display_pubpid')) ? 'pubpid' : 'pid');
					return '<div class="search-item">' +
						'<div style="float: right; font-size: 10px;">#{' + pid + '}</div>' +
						'<div style="font-weight: bold;">{fullname}&nbsp;&nbsp;-&nbsp;&nbsp;{[Ext.Date.format(values.DOB, g("date_display_format"))]} ({[app.getAge(values.DOB)[\'years\']]}Y)</div> ' +
						'</div>';
				}
			},
			pageSize: 15
		});

		if(this.resetEnabled){
			me.hideTrigger = false;
			me.triggerTip = _('click_to_clear_selection');
			me.spObj = '';
			me.spForm ='';
			me.spExtraParam = '';
			me.qtip = _('clearable_combo_box');
			me.trigger1Class = 'x-form-select-trigger';
			me.trigger2Class = 'x-form-clear-trigger';
		}

		me.callParent();

		me.on('render', function (){
			me.getPicker().down('toolbar').insert(0,{
				xtype: 'button',
				text: _('new_patient'),
				cls: 'btnGreenBackground',
				itemId: 'SearchNewPatientBtn',
				newPatientCallback: function (patient){
					if(me.newPatientCallback){
						me.newPatientCallback(me, patient);
					}
				},
				handler: function (){
					me.reset();
					me.picker.hide();
				}
			});

			//me.inputEl.dom.setAttribute('autocomplete', Ext.isChrome ? 'none' : 'false');
		});
	},

	onRender: function(ct, position){
		var id = this.getId();
		var trigger2;
		this.callParent(arguments);

		if(!this.resetEnabled){
			return;
		}

		this.triggerConfig = {
			tag: 'div',
			cls: 'x-form-twin-triggers',
			style: 'display:block;',
			cn: [
				{
					tag: "img",
					style: Ext.isIE ? 'margin-left:0;height:21px' : '',
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					cls: "x-form-trigger " + this.trigger2Class
				}
			]
		};
		this.triggerEl.replaceWith(this.triggerConfig);
		this.triggerEl.on('mouseup', function(e){
			if(e.target.name == "trigger2" + id){
				this.reset();
				this.fireEvent('reset', this);
			}
		}, this);
		trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	}
});

Ext.define('App.ux.LiveRadsSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'radslivetsearch',
	hideLabel: true,

	initComponent: function(){
		var me = this;

		Ext.define('liveRadLoincSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'id' },
				{ name: 'loinc_name' },
				{ name: 'loinc_number' },
				{ name: 'code_type', defaultValue: 'LOINC' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Laboratories.getRadLoincLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveRadLoincSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			displayField: 'loinc_name',
			valueField: 'loinc_name',
			emptyText: _('radiology_search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 1,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{loinc_name} ({loinc_number})</h3></div>';
				}
			},
			pageSize: 10
		});

		me.callParent();
	}
});

Ext.define('App.ux.LiveReferringPhysicianSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'referringphysicianlivetsearch',
	hideLabel: true,
	displayField: 'fullname',
	valueField: 'id',
	emptyText: _('search_for_a_physician') + '...',
    queryMode: 'remote',
    allowBlank: true,
	typeAhead: false,
    forceSelection: false,
    allowOnlyWhitespace: true,
    validateBlank: true,
    submitValue: true,
	minChars: 0,
	queryDelay: 200,
	enableAddTrigger: true,
	trigger1Cls: 'x-form-add-trigger',
	trigger2Cls: 'x-form-clear-trigger',
	hideTrigger1: false,
	onTrigger1Click: function () {
		if(a('allow_add_referring_physician')){
			app.fireEvent('referringproviderddbtnclick', this, this.findRecordByValue(this.getValue()));
		}else{
			app.msg(_('oops'), 'Not Authorized', true)
		}
	},
	onTrigger2Click: function () {
		this.reset();
		this.oldValue = null;
		this.fireEvent('fieldreset', this);
	},

	initComponent: function(){
		var me = this;

		Ext.define('referringPhysicianLiveSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'organization_name',
					type: 'string'
				},
				{
					name: 'fullname',
					type: 'string',
					convert: function(v, record){
						if(record.data.lname){
							return record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname
						}else{
							return record.data.organization_name
						}
					}
				},
				{
					name: 'upin',
					type: 'string'
				},
				{
					name: 'lic',
					type: 'string'
				},
				{
					name: 'npi',
					type: 'string'
				},
                {
                    name: 'ssn',
                    type: 'string'
                },
                {
                    name: 'taxonomy',
                    type: 'string'
                },
                {
                    name: 'email',
                    type: 'string'
                },
                {
                    name: 'direct_address',
                    type: 'string'
                },
                {
                    name: 'phone_number',
                    type: 'string'
                },
                {
                    name: 'fax_number',
                    type: 'string'
                },
                {
                    name: 'cel_number',
                    type: 'string'
                }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'ReferringProviders.referringPhysicianLiveSearch'
				},
                writer:{
                    writeAllFields: true
                },
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'referringPhysicianLiveSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(me, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3><span>{fullname}</span></h3><b>NPI:</b> {npi} <b>LIC.:</b> {lic}</div>';
				}
			},
			pageSize: 10
		});

		me.callParent();

		me.on('change', me.onReferringValueChange, me);
	},

	onReferringValueChange: function (field, value) {
		if(!Ext.isNumber(value) || value == '0') return;
		var me = this;

		App.model.administration.ReferringProvider.load(value, {
			success: function(referring) {
				if(me.store.getById(referring.get('id')) !== null) return;
				me.store.add(referring.data);
				me.setValue(value);
			}
		});
	}
});

Ext.define('App.ux.LiveUserSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.userlivetsearch',
	hideLabel: true,
	displayField: 'fullname',
	valueField: 'id',
	emptyText: _('search_for_a_user') + '...',
	maxLength: 40,
	typeAhead: false,
    queryMode: 'remote',
    allowBlank: true,
    minChars: 1,
	queryDelay: 200,
	acl: null,

    triggerTip: _('click_to_clear_selection'),
    spObj: '',
    spForm: '',
    spExtraParam: '',
    qtip: _('clearable_combo_box'),
    trigger1Class: 'x-form-select-trigger',
    trigger2Class: 'x-form-clear-trigger',

    listConfig: {
        loadingText: _('searching') + '...',
        getInnerTpl: function(){
            return '<div class="search-item">{fullname} <b>({role})</b></div>'
        }
    },

	initComponent: function(){
		var me = this;

		Ext.define('userLiveSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'code',
					type: 'string'
				},
				{
					name: 'role',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'fullname',
					type: 'string',
					convert: function(v, record){
						return record.data.fname + ' ' + record.data.mname + ' ' + record.data.lname
					}
				}
			]
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'userLiveSearchModel',
			pageSize: 10,
			autoLoad: false,
			proxy: {
				type: 'direct',
				api: {
					read: 'User.userLiveSearch'
				},
				extraParams: {
					acl: me.acl
				},
				reader: {
					root: 'data'
				},
                writer: {
                    writeAllFields: true
                }
			}
		});

		Ext.apply(me, {
			store: me.store,
			pageSize: 10
		});

		me.callParent();
	},

    onRender: function(ct, position){
        var id = this.getId();
        var trigger2;
        this.callParent(arguments);
        this.triggerConfig = {
            tag: 'div',
            cls: 'x-form-twin-triggers',
            style: 'display:block;',
            cn: [
                {
                    tag: "img",
                    style: Ext.isIE ? 'margin-left:0;height:21px' : '',
                    src: Ext.BLANK_IMAGE_URL,
                    id: "trigger2" + id,
                    name: "trigger2" + id,
                    cls: "x-form-trigger " + this.trigger2Class
                }
            ]
        };
        this.triggerEl.replaceWith(this.triggerConfig);
        this.triggerEl.on('mouseup', function(e){
            if(e.target.name == "trigger2" + id){
                this.reset();
                this.fireEvent('reset', this);
            }
        }, this);
        trigger2 = Ext.get("trigger2" + id);
        trigger2.addClsOnOver('x-form-trigger-over');
    }

});

(function(){

	var Element = Ext.core.Element,
		DomHelper = Ext.core.DomHelper,
		slice = Array.prototype.slice;

	/**
	 * @class App.ux.ManagedIframe
	 * @extends Ext.Component
	 */
	Ext.define('App.ux.ManagedIframe', {

		/* Begin Definitions */
		extend: 'Ext.Component',
		alias: 'widget.miframe',

		/* End Definitions */

		hideMode: Ext.isIE ? 'display' : 'nosize',

		/*
		 * @cfg {Boolean} autoScroll True to set overflow:auto on the nested iframe.
		 * If False, overflow is forced to hidden.
		 * Note: set to undefined to control overflow-x/y via the frameStyle config option
		 */
		autoScroll: true,

		/*
		 * @cfg {String/Object} frameStyle (optional) Style string or object configuration representing
		 * the desired style attributes to apply to the embedded IFRAME.
		 * @default 'height:100%; width:100%;'
		 */
		frameStyle: null,

		frameConfig: undefined,

		frameCls: 'ux-miframe',

		shimCls: 'ux-miframe-shim',

		shimUrl: Ext.BLANK_IMAGE_URL,

		/*
		 * @cfg {Boolean} eventsFollowFrameLinks True to raise the 'dataavailable' event anytime
		 * the frame document is reloaded (including when the user follows a link to another page)
		 * Note: the load event is always fired
		 * @default true
		 */
		eventsFollowFrameLinks: true,

		/*
		 * @cfg {String} src (optional) Uri to load into the frame
		 */
		src: 'about:blank',

		/*
		 * @cfg {Boolean} autoMask True to display a loadMask during page content changes
		 */
		autoMask: false,

		/*
		 * @cfg {String} maskMessage default message text rendered during masking operations
		 */
		maskMessage: 'Loading...',

		/*
		 * @cfg {String} resetUrl (optional) Uri to load into the frame during initialization only
		 * @default undefined
		 */
		resetUrl: undefined,

		ariaRole: 'presentation',

		unsupportedText: 'Frames are disabled',

		/*
		 * Bubble frame events to upstream containers
		 */
		//bubbleEvents: ['dataavailable', 'load', 'unload', 'scroll', 'reset'],

		initComponent: function(){

			var me = this;
			me.frameStyle = Ext.isString(me.frameStyle)
				? Element.parseStyles(me.frameStyle)
				: me.frameStyle || {};

			me.frameName = me.frameName || me.getId();

			//			delete me.autoEl;

			me.autoEl = me.autoEl || {              //generate the necessary markup for shimming and noframes support
				cn: [
					Ext.applyIf(me.frameConfig || {},
						{
							tag: 'iframe',
							cls: me.frameCls,
							style: Ext.apply(
								{
									"height": "100%",
									"width": "100%"
								},
								me.frameStyle
							),
							// sandbox: 'allow-scripts allow-modals allow-forms allow-presentation allow-same-origin',
							frameBorder: 'no',
							role: me.ariaRole,
							name: me.frameName
						}
					),
					{
						tag: 'noframes',
						html: me.unsupportedText
					},
					{
						tag: 'img',
						cls: me.shimCls,
						galleryimg: "no",
						style: "position:absolute;top:0;left:0;display:none;z-index:20;height:100%;width:100%;",
						src: me.shimUrl
					}
				]
			};

			this.callParent();

		},

		renderSelectors: {
			frameElement: 'iframe.ux-miframe',
			frameShim: 'img.ux-miframe-shim'
		},

		iframeMessageListener: function(event){

			if(event.origin !== window.location.origin) return;
			if(!event.data.match) return;
			if(!event.data.match(/^documentedit/)) return;

			var data = event.data.replace(/^documentedit/, '');
			app.fireEvent('documentedit', eval('(' + data + ')'));
		},

		afterRender: function(container){
			var me = this, frame;
			me.callParent();

			if(me.iframeMessageListener){
				if (window.addEventListener){
					window.addEventListener("message", me.iframeMessageListener, false);
				} else {
					window.attachEvent("onmessage", me.iframeMessageListener);
				}
			}

			if(me.frameShim){
				me.frameShim.autoBoxAdjust = false;
				me.frameShim.setVisibilityMode(Element.DISPLAY);
			}

			if(frame = me.frameElement){
				frame = me.frameElement = new App.ux.ManagedIframe.Element(frame.dom);

				//Suppress dataavailable event chatter during initialization
				frame.eventsFollowFrameLinks = false;

				frame.on({
					dataavailable: me.onFrameDataAvailable,
					scope: me
				});

				if(this.autoLoad){
					frame.isReset = Ext.isIE;
					frame.eventsFollowFrameLinks = !!me.eventsFollowFrameLinks;
				}else{

					Ext.Function.defer(
						frame.reset,
						100,        //permit layout to quiesce
						frame,
						[
							me.resetUrl,
							function(){
								var me = this;
								frame.eventsFollowFrameLinks = !!me.eventsFollowFrameLinks;
								if(me.src || me.defaultSrc){
									me.setSrc();
								}else if(me.data || me.html){
									me.update(me.data || me.html);
								}
							},
							me
						]
					);
				}
			}
		},

		// private
		getContentTarget: function(){
			return this.frameElement;
		},

		getActionEl: function(){
			return this.frameElement || this.el;
		},

		/*
		 * @private
		 */
		onFrameDataAvailable: function(e){
			if(this.autoMask){
				this.setLoading(false);
			}
		},

		/*
		 * Setter - Changes the current src attribute of the IFRAME, applying a loadMask
		 * over the frame (if autoMask is true)
		 * Note: call without the uri argument to simply refresh the frame with the current src value
		 * @param {Function} callback (Optional) A callback function invoked when the
		 *            frame document has been fully loaded.
		 * @param {Object} scope (Optional) scope by which the callback function is
		 *            invoked.
		 */
		setSrc: function(uri, callback, scope){
			var me = this;
			uri = uri || me.src || me.defaultSrc;
			if(uri && me.rendered && me.frameElement){

				if(me.autoMask && me.isVisible(true)){
					me.setLoading(me.maskMessage || '', true);
				}

				me.frameElement.setSrc(uri, false, callback, scope);
			}
			me.src = uri;
			return me;
		},

		setLoading: function(load){
			var me = this;

			if(load !== false){
				me.el.mask(me.maskMessage || '');
			}else{
				me.el.unmask();
			}
		},

		/**
		 * contentEl is NOT supported, but tpl/data, and html ARE.
		 * @private
		 */
		initContent: function(){
			var me = this,
				content = me.data || me.html;

			if(me.contentEl && Ext.isDefined(Ext.global.console)){
				Ext.global.console.warn('App.ux.ManagedIframe: \'contentEl\' is not supported by this class.');
			}

			// Make sure this.tpl is an instantiated XTemplate
			if(me.tpl){
				me.setTpl(me.tpl);
			}

			delete me.contentEl;
		},

		setTpl: function(tpl){
			this.tpl = (tpl && !tpl.isTemplate) ? Ext.create('Ext.XTemplate', tpl) : tpl;
			return this;
		},

		/**
		 * Update(replacing) the document content of the IFRAME.
		 * @param {Mixed} htmlOrData
		 * If this component has been configured with a template via the tpl config
		 * then it will use this argument as data to populate the frame.
		 * If this component was not configured with a template, the components
		 * content area (iframe) will be updated via App.ux.ManagedIframe.Element update
		 * @param {Boolean} loadScripts (optional) Defaults to false
		 * @param {Function} callback (optional) Callback to execute when scripts have finished loading
		 * @param {Object} scope (optional) execution context of the the callback
		 */
		update: function(htmlOrData, loadScripts, callback, scope){
			var me = this,
				content = htmlOrData;

			if(me.tpl && Ext.isArray(content) || Ext.isObject(content)){
				me.data = content;
				content = me.tpl.apply(content || {});
			}

			if(me.rendered){
				me.autoMask &&
				me.isVisible(true) &&
				me.setLoading(me.maskMessage || '');

				var frame = me.getContentTarget();
				Ext.defer(
					function(){
						frame.update(content, loadScripts, callback, scope);
						//Ext.defer(this.setLoading, 100, this, [false]);
					},
					me.autoMask ? 100 : 10,
					me,
					[ ]
				);

			}
			return me;
		},

		/**
		 * Sets the overflow on the IFRAME element of the component.
		 * @param {Boolean} scroll True to allow the IFRAME to auto scroll.
		 * @return {App.ux.ManagedIframe.Component} this
		 */
		setAutoScroll: function(scroll){
			var me = this,
				targetEl;
			if(Ext.isDefined(scroll)){  //permits frameStyle overrides
				scroll = !!scroll;
				if(me.rendered && (targetEl = me.getContentTarget())){
					targetEl.setStyle('overflow', scroll ? 'auto' : 'hidden');
				}
				me.autoScroll = scroll;
			}
			return me;
		},

		/*
		 *   Toggle the transparent shim on/off
		 */
		toggleShim: function(enabled){
			var me = this;
			if(me.frameShim){
				me.frameShim[enabled ? 'show' : 'hide']();
			}
			return me.frameShim;
		},

		onDestroy: function(){
			var me = this, frame;
			if(frame = me.frameElement){
				frame.remove();
			}
			me.deleteMembers('frameElement', 'frameShim');

			if(me.iframeMessageListener){
				if (window.addEventListener){
					removeEventListener("message", me.iframeMessageListener, false);
				} else {
					detachEvent("onmessage", me.iframeMessageListener);
				}
			}


			me.callParent();
		}

	});

	var MIF = App.ux.ManagedIframe,
		EC = Ext.cache,
		DOC = window.document,

	// @private add/remove Listeners
		addListener = function(){
			var handler;
			if(window.addEventListener){
				handler = function F(el, eventName, fn, capture){
					el.addEventListener(eventName, fn, !!capture);
				};
			}else if(window.attachEvent){
				handler = function F(el, eventName, fn, capture){
					el.attachEvent("on" + eventName, fn);
				};
			}else{
				handler = function F(){
				};
			}
			var F = null; //Gbg collect
			return handler;
		}(),
		removeListener = function(){
			var handler;
			if(window.removeEventListener){
				handler = function F(el, eventName, fn, capture){
					el.removeEventListener(eventName, fn, (capture));
				};
			}else if(window.detachEvent){
				handler = function F(el, eventName, fn){
					el.detachEvent("on" + eventName, fn);
				};
			}else{
				handler = function F(){
				};
			}
			var F = null; //Gbg collect
			return handler;
		}();

	Ext.define('App.ux.ManagedIframe.Element', {

		/* Begin Definitions */
		extend: 'Ext.core.Element',
		alias: 'widget.miframeelement',
		/* End Definitions */

		visibilityMode: Element.ASCLASS,   //nosize for hiding

		eventsFollowFrameLinks: true,

		focusOnLoad: Ext.isIE,

		constructor: function(element){
			var id,
				dom = (typeof element == "string")
					? DOC.getElementById(element)
					: (element || {}).dom || element;

			if(!dom){
				return null;
			}

			id = dom.id;

			/**
			 * The DOM element
			 * @type HTMLElement
			 */
			this.dom = dom;

			/**
			 * The DOM element ID
			 * @type String
			 */
			this.id = id || Ext.id(dom);

			this.dom.name = this.dom.name || this.id;
			window.frames[this.dom.name] = this.dom;

			this.dom.manager = this;
			this._flyweights = {};

			if(EC[this.id] && EC[this.id].el){
				EC[this.id].el = this;
			}else{
				Element.addToCache(this);
			}

			/*
			 * Sets up the events required to maintain the state machine
			 */
			// Hook the Iframes loaded/state handlers
			Ext.isGecko || Ext.isWebkit || this.on(
				(Ext.isOpera) ? 'DOMFrameContentLoaded' : 'readystatechange',
				this.loadHandler,
				this,
				/**
				 * Opera still fires LOAD events for images within the FRAME as well,
				 * so we'll buffer hopefully catching one of the later events
				 */
				Ext.isOpera ? {buffer: this.operaLoadBuffer || 2000} : null
			);

			this.on({
				'dataavailable': function(e, target){
					//set current frameAction for downstream listeners
					e && Ext.apply(e, {
						frameAction: this._frameAction,
						frameResetting: this.isReset
					});
				},
				load: this.loadHandler,
				scope: this

			});

		},

		/**
		 * If sufficient privilege exists, returns the frame's current document
		 * as an HTMLElement.
		 * @param {Boolean} assertAccess (optional) False to return the document regardless of
		 what domain served the page.
		 * @return {HTMLElement} The frame document or false if access to document object was denied.
		 */
		getFrameDocument: function(assertAccess){
			var win = this.getWindow(), doc = null;
			try{
				doc = win.contentDocument || this.dom.contentDocument || window.frames[this.dom.name].document || win.document;
			}catch(gdEx){
				doc = false; // signifies probable access restriction
			}
			return  doc || false;
		},

		/**
		 * Returns the frame's current HTML document object as an
		 * {@link Ext.Element}.
		 * @return {Ext.Element} The document
		 */
		getDoc: function(){
			return this.fly(this.getFrameDocument());
		},

		/**
		 * If sufficient privilege exists, returns the frame's current document
		 * body as an HTMLElement.
		 *
		 * @return {Ext.Element} The frame document body or Null if access to
		 *         document object was denied.
		 */
		getBody: function(){
			var d;
			return (d = this.getFrameDocument()) ? this.get(d.body) : null;
		},

		/*
		 * Convert an HTMLElement (by id or reference) to a Flyweight Element
		 */
		get: function(el){
			return this.fly(el);
		},

		fly: function(el, named){
			var me = this,
				ret = null,
				doc = me.getFrameDocument(),
				id;

			if(!doc || !el){
				return ret;
			}
			named = named || '_global';
			el = Ext.getDom(el, false, doc);
			if(el){

				/* Note: this does two things:
				 * 1) properly asserts the window/document id's
				 * 2) initializes event caches for foreign Flyweights
				 */
				id = Ext.EventManager.getId(el);

				/*
				 * maintain a Frame-localized cache of Flyweights
				 */
				(me._flyweights[id] = me._flyweights[id] || new MIF.Element.Flyweight()).dom = el;
				ret = me._flyweights[id];
			}
			return ret;
		},

		/**
		 * Creates a {@link Ext.CompositeElement} for child nodes based on the
		 * passed CSS selector (the selector should not contain an id).
		 *
		 * @param {String} selector The CSS selector
		 * @return {Ext.CompositeElement/Ext.CompositeElementLite} The composite element
		 */
		select: function(selector){
			var d;
			return (d = this.getFrameDocument()) ? Element.select(selector, false, d) : d = null;
		},

		/**
		 * Selects frame document child nodes based on the passed CSS selector
		 * (the selector should not contain an id).
		 *
		 * @param {String} selector The CSS selector
		 * @return {Array} An array of the matched nodes
		 */
		query: function(selector){
			var d;
			return (d = this.getFrameDocument()) ? Ext.DomQuery.select(selector, d) : d = null;
		},

		/**
		 * Attempt to retrieve the frames current URI via frame's document object
		 * @return {string} The frame document's current URI or the last know URI if permission was denied.
		 */
		getDocumentURI: function(){

			var URI, d;
			try{
				URI = this.src && (d = this.getFrameDocument()) ? d.location.href : null;
			}catch(ex){
			} // will fail on NON-same-origin domains
			return URI || (Ext.isFunction(this.src) ? this.src() : this.src);
		},

		/**
		 * Attempt to retrieve the frames current URI via frame's Window object
		 * @return {string} The frame document's current URI or the last know URI if permission was denied.
		 */
		getWindowURI: function(){
			var URI, w, me = this;
			try{
				URI = (w = me.getWindow()) ? w.location.href : null;
			}catch(ex){
			} // will fail on NON-same-origin domains
			return URI || (Ext.isFunction(me.src) ? me.src() : me.src);

		},

		/**
		 * Returns the frame's current window object.
		 * @return {Window} The frame Window object.
		 */
		getWindow: function(){
			var dom = this.dom, win = null;
			try{
				win = dom.contentWindow || window.frames[dom.name] || null;
			}catch(gwEx){
			}
			return win;
		},

		/**

		 * Scrolls a frame document's child element into view within the passed container.
		 * Note:
		 * @param {String} child The id of the element to scroll into view.
		 * @param {Mixed} container (optional) The container element to scroll (defaults to the frame's document.body).  Should be a
		 * string (id), dom node, or Ext.Element reference with an overflow style setting.
		 * @param {Boolean} hscroll (optional) False to disable horizontal scroll (defaults to true)
		 * @return {App.ux.ManagedIframe.Element} this
		 */
		scrollChildIntoView: function(child, container, hscroll){
			var me = this,
				doc = me.getFrameDocument(),
				f;
			if(doc){
				container = (container ? Ext.getDom(container, true, doc) : null) || (!Ext.isWebKit && Ext.isDocumentStrict(doc) ? doc.documentElement : doc.body);
				if(f = me.fly(child)){
					f.scrollIntoView(container, hscroll);
				}
			}
			return me;
		},

		/**
		 * @private
		 * Evaluate the Iframes readyState/load event to determine its
		 * 'load' state, and raise the 'dataavailable' and other events when
		 * applicable.
		 */
		loadHandler: function(e, target, options){
			e = e || {};
			var me = this,
				rstatus = (e.type == 'readystatechange') ? (me.dom || {}).readyState : e.type;

			//console.info('LH ' ,  rstatus , ' follows:',me.eventsFollowFrameLinks, ' isReset:', me.isReset, ' action:',me._frameAction );
			if(me.eventsFollowFrameLinks || me._frameAction || me.isReset){

				me.isReset && e.stopEvent && e.stopEvent();
				switch(rstatus){

					case 'domready' : // MIF
					case 'DOMFrameContentLoaded' :

						me._onDocReady(rstatus, e);
						me.fireDOMEvent('domready', null, {message: e.message});
						break;

					case 'interactive':   // IE/ Legacy Opera
						me.domReady = me.loaded = false;
						me.isReset || me.assertOnReady();  //for IE, begin polling here as IE7 holds the DOM a bit longer
						break;
					case 'complete' :
						me.loaded = true;
						me.fireDOMEvent('complete', null, {message: e.message});
						break;
					case 'load' : // Gecko, Opera, IE
						me.loaded = true;
						Ext.apply(e, {
							frameAction: me._frameAction,
							frameResetting: me.isReset
						});
						me._onDocLoaded(rstatus, e);
						me.dispatchCallbacks(e, target, options);
						break;

					case 'error':
						me.fireDOMEvent('error', null, {message: e.message});
						me._frameAction = false;
						break;
					default :
				}

				me.frameState = rstatus;
			}

		},

		/*
		 *  @private DOM Ready handler
		 */
		_onDocReady: function(status, e){
			var me = this;

			me.domReady = true;

			try{
				if(!me.isReset && me.focusOnLoad){
					me.focus();
				}
			}catch(ex){
			}

			//raise internal private event regardless of state.
			me.fireDOMEvent('datasetchanged');

			if(!me.isReset && !me.domReadyFired && me._renderHooks()){

				// Only raise if sandBox injection succeeded (same origin)
				if(!me.isReset){  //but never during a reset
					me.domReadyFired = true;
					me.fireDOMEvent('dataavailable');
				}
			}
		},

		_onDocLoaded: function(status, e){
			var me = this;
			/*
			 * this is necessary to permit other browsers a chance to raise dataavailable during
			 * page transitions (eventsFollowFrameLinks)
			 */
			!me.isReset && (!me._frameAction || me.eventsFollowFrameLinks) && !me.domReady && me._onDocReady();
			me._frameAction = me.domReadyFired = me.isReset = me.domReady = false;
			me._targetURI = null;
		},

		/*
		 * @private DOM Event Factory
		 */
		createEvent: document.createEvent ?
			function(eventName, eventClass, fromE, options){   //DOM2 Event interfaces
				options = options || { bubbles: true, cancelable: false };
				eventClass = eventClass || 'Event';
				var evt = document.createEvent(eventClass);
				evt.initEvent(eventName, !!Ext.value(options.bubbles, true), !!Ext.value(options.cancelable, false));
				return evt;
			} :
			function(eventName, eventClass, fromE, options){   //IE-style Events
				options = options || { type: 'on' + eventName, bubbles: true, cancelable: false };
				var evt = document.createEventObject(fromE);
				return Ext.apply(evt, options);
			},

		/*
		 * @private DOM Event Dispatch
		 */
		dispatchEvent: document.createEvent ?
			function(e, eventName, options){
				return this.dom ? !this.dom.dispatchEvent(e) : null;
			} :
			function(e, eventName, options){
				return this.dom ? this.dom.fireEvent('on' + eventName, e) : null;
			},

		/*
		 *  Dispatch a new (or copied) Generic event with the current Element as the event target
		 */
		fireDOMEvent: function(eventName, e, args){
			return this.dispatchEvent(
				this.createEvent(eventName, null, e, args),
				eventName, args
			);
		},

		/**
		 * @private execScript sandbox and messaging interface
		 */
		_renderHooks: function(){

			var me = this;
			me._windowContext = null;
			Ext.destroy(me.CSS);
			delete me.CSS;
			me._hooked = false;
			try{
				if(me.writeScript(
						'(function(){(window.hostMIF = parent.document.getElementById("' + me.id +
						'").manager)._windowContext='
						+ (Ext.isIE
						? 'window'
						: '{eval:function(s){return new Function("return ("+s+")")();}}')
						+ ';})()')){

					var w,
						al = addListener,
						p = me._frameProxy || (me._frameProxy = Ext.bind(MIF.Element.eventProxy, me)),
						doc = me.getFrameDocument();

					/*
					 * Route all desired events through the proxy for normalization
					 */
					if(doc && (w = me.getWindow())){
						al(Ext.isIE ? doc.body || doc.documentElement : w, 'focus', p);
						al(Ext.isIE ? doc.body || doc.documentElement : w, 'blur', p);
						al(w, 'resize', p);
						al(w, 'beforeunload', p);
						//al(Ext.supports.Event('scroll', doc) ? doc : w, 'scroll', p);
					}

					// doc && (this.CSS = new Ext.ux.ManagedIFrame.CSS(doc));
				}

			}catch(ex){
			}
			return (me._hooked = me.domWritable());
		},

		/**
		 * Returns the general 'DOM modification capability' (same-origin status) of the frame.
		 * @return {Boolean} accessible If True, the frame's inner DOM can be manipulated, queried, and
		 * Event Listeners set.
		 */
		domWritable: function(){
			return !!this._windowContext && !!this.getFrameDocument(); //test access
		},

		/** @private : clear all event listeners and Sandbox hooks
		 * This returns the Element to an un-managed state.
		 */
		_unHook: function(){
			var me = this;
			if(me._hooked){
				try{
					me._windowContext && (me._windowContext.hostMIF = null);
				}catch(uhex){
				}
				me._windowContext = null;
				var w,
					rl = removeListener,
					p = me._frameProxy,
					doc = me.getFrameDocument();

				if(p && doc && (w = me.getWindow())){
					rl(Ext.isIE ? doc.body || doc.documentElement : w, 'focus', p);
					rl(Ext.isIE ? doc.body || doc.documentElement : w, 'blur', p);
					rl(w, 'resize', p);
					rl(w, 'beforeunload', p);
					//rl(Ext.supports.Event('scroll', doc) ? doc : w, 'scroll', p);
				}

			}
			me._flyweights = {};
			//doc && Element.clearDocumentCache(doc.id);

			Ext.destroy(me.CSS);
			delete me.CSS;
			me._frameAction = me.domReady = me.domFired = me._hooked = false;
		},

		/**
		 * Loads the frame Element with the response from a form submit to the
		 * specified URL with the ManagedIframe.Element as it's submit target.
		 *
		 * @param {Object} submitCfg A config object containing any of the following options:
		 * <pre><code>
		 *      myIframe.submitAsTarget({
         *         form : formPanel.form,  //optional Ext.FormPanel, Ext form element, or HTMLFormElement
         *         url: &quot;your-url.php&quot;,
         *         action : (see url) ,
         *         params: {param1: &quot;foo&quot;, param2: &quot;bar&quot;}, // or URL encoded string or function that returns either
         *         callback: yourFunction,  //optional, called with the signature (event, target, evOptions)
         *         scope: yourObject, // optional scope for the callback
         *         method: 'POST', //optional form.method
         *         encoding : "multipart/form-data" //optional, default = HTMLForm default
         *      });
		 *
		 * </code></pre>
		 * @return {Ext.ux.ManagedIFrame.Element} this
		 *
		 */
		submitAsTarget: function(submitCfg){

			var opt = submitCfg || {},
				doc = this.getParentDocument(),
				form = Ext.getDom(
					opt.form ? opt.form.form || opt.form : null, false, doc) ||
					Ext.DomHelper.append(doc.body, {
						tag: 'form',
						cls: 'x-hide-offsets x-mif-form',
						encoding: 'multipart/form-data'
					}),
				formFly = Ext.fly(form, '_dynaForm'),
				formState = {
					target: form.target || '',
					method: form.method || '',
					encoding: form.encoding || '',
					enctype: form.enctype || '',
					action: form.action || ''
				},
				encoding = opt.encoding || form.encoding,
				method = opt.method || form.method || 'POST';

			formFly.set({
				target: this.dom.name,
				method: method,
				encoding: encoding,
				action: opt.url || opt.action || form.action
			});

			if(method == 'POST' || !!opt.enctype){
				formFly.set({enctype: opt.enctype || form.enctype || encoding});
			}

			var hiddens, hd, ps;
			// add any additional dynamic params
			if(opt.params && (ps = Ext.isFunction(opt.params) ? opt.params() : opt.params)){
				hiddens = [];

				Ext.iterate(ps = typeof ps == 'string' ? Ext.urlDecode(ps, false) : ps,
					function(n, v){

						Ext.fly(hd = D.createElement('input')).set({
							type: 'hidden',
							name: n,
							value: v
						});
						form.appendChild(hd);
						hiddens.push(hd);
					});
			}

			Ext.isFunction(opt.callback) &&  //use the internal event to dispatch the callback
			this.on('datasetchanged', opt.callback, opt.scope || this, {single: true, submitOptions: opt});

			this._frameAction = true;
			this._targetURI = location.href;

			form.submit();

			// remove dynamic inputs
			hiddens && Ext.each(hiddens, Ext.removeNode, Ext);

			//Remove if dynamically generated, restore state otherwise
			if(formFly.hasClass('x-mif-form')){
				formFly.remove();
			}else{
				formFly.set(formState);
			}

			formFly = null;
			return this;
		},

		/**
		 * @cfg {String} resetUrl Frame document reset string for use with the {@link #Ext.ux.ManagedIFrame.Element-reset} method.
		 * Defaults:<p> For IE on SSL domains - the current value of Ext.SSL_SECURE_URL<p> "about:blank" for all others.
		 */
		resetUrl: (function(){
			return Ext.isIE && Ext.isSecure ? Ext.SSL_SECURE_URL : 'about:blank';
		})(),

		/**
		 * Sets the embedded Iframe src property. Note: invoke the function with
		 * no arguments to refresh the iframe based on the current src value.
		 *
		 * @param {String/Function} url (Optional) A string or reference to a Function that
		 *            returns a URI string when called
		 * @param {Boolean} discardUrl (Optional) If not passed as <tt>false</tt>
		 *            the URL of this action becomes the default SRC attribute
		 *            for this iframe, and will be subsequently used in future
		 *            setSrc calls (emulates autoRefresh by calling setSrc
		 *            without params).
		 * @param {Function} callback (Optional) A callback function invoked when the
		 *            frame document has been fully loaded.
		 * @param {Object} scope (Optional) scope by which the callback function is
		 *            invoked.
		 */
		setSrc: function(url, discardUrl, callback, scope){

			var src = url || this.src || this.resetUrl;
			Ext.isFunction(callback) && this.queueCallback(callback, scope || this);
			(discardUrl !== true) && (this.src = src);
			var s = this._targetURI = (Ext.isFunction(src) ? src() || '' : src);
			try{
				this._frameAction = true; // signal listening now
				this.dom.src = s;
				Ext.isIE || this.assertOnReady();
			}catch(ex){

			}
			return this;
		},

		/**
		 * Sets the embedded Iframe location using its replace method (precluding a history update).
		 * Note: invoke the function with no arguments to refresh the iframe based on the current src value.
		 *
		 * @param {String/Function} url (Optional) A string or reference to a Function that
		 *            returns a URI string when called
		 * @param {Boolean} discardUrl (Optional) If not passed as <tt>false</tt>
		 *            the URL of this action becomes the default SRC attribute
		 *            for this iframe, and will be subsequently used in future
		 *            setSrc calls (emulates autoRefresh by calling setSrc
		 *            without params).
		 * @param {Function} callback (Optional) A callback function invoked when the
		 *            frame document has been fully loaded.
		 * @param {Object} scope (Optional) scope by which the callback function is
		 *            invoked.
		 *
		 */
		setLocation: function(url, discardUrl, callback, scope){

			var me = this,
				src = url || me.src || me.resetUrl;
			me._unHook();
			Ext.isFunction(callback) && me.queueCallback(callback, scope);
			var s = me._targetURI = (Ext.isFunction(src) ? src() || '' : src);
			if(discardUrl !== true){
				me.src = src;
			}

			try{
				me._frameAction = true; // signal listening now
				me.getWindow().location.replace(s);
				Ext.isIE || me.assertOnReady();
			}catch(ex){
			}
			return me;
		},

		/**
		 * Resets the frame to a neutral (blank document) state
		 *
		 * @param {String}
		 *            src (Optional) A specific reset string (eg. 'about:blank')
		 *            to use for resetting the frame.
		 * @param {Function}
		 *            callback (Optional) A callback function invoked when the
		 *            frame reset is complete.
		 * @param {Object}
		 *            scope (Optional) scope by which the callback function is
		 *            invoked.
		 */
		reset: function(src, callback, scope){

			var me = this,
				s = src,
				win;

			me._unHook();
			if(win = me.getWindow()){
				me.isReset = me._frameAction = true;
				Ext.isFunction(callback) && me.queueCallback(callback, scope);

				Ext.isFunction(src) && ( s = src());
				s = me._targetURI = Ext.isEmpty(s, true) ? me.resetUrl : s;
				win.location.href = s;
			}
			return me;
		},

		queueCallback: function(fn, scope){
			var me = this;
			me.callbacks = me.callbacks || [];
			me.callbacks.push(scope ? Ext.bind(fn, scope || me) : fn);
			return me;
		},

		dispatchCallbacks: function(e, target, options){
			var me = this;
			if(me.callbacks && me.callbacks.length){
				while(me.callbacks.length){
					me.callbacks.shift()(e, target, options);
				}
			}
		},

		/**
		 * @private
		 * Regular Expression filter pattern for script tag removal.
		 * @cfg {regexp} scriptRE script removal RegeXp
		 * Default: "/(?:<script.*?>)((\n|\r|.)*?)(?:<\/script>)/gi"
		 */
		scriptRE: /(?:<script.*?>)((\n|\r|.)*?)(?:<\/script>)/gi,

		/**
		 * Write(replacing) string content into the IFrames document structure
		 * @param {String} content The new content
		 * @param {Boolean} loadScripts
		 * (optional) true to also render and process embedded scripts
		 * @param {Function} callback (Optional) A callback function invoked when the
		 * frame document has been written and fully loaded. @param {Object}
		 * scope (Optional) scope by which the callback function is invoked.
		 */
		update: function(content, loadScripts, callback, scope){

			var me = this;
			content = DomHelper.markup(content || '');

			content = (loadScripts !== false) ? content : content.replace(me.scriptRE, "");
			var doc;
			if((doc = me.getFrameDocument()) && !!content.length){
				me._unHook();
				me.src = null;
				Ext.isFunction(callback) && me.queueCallback(callback, scope || this);

				me._targetURI = null;
				me._frameAction = true;
				doc.open();
				doc.write(content);
				me.assertOnReady();
				doc.close();

			}else{
				Ext.callback(callback, scope || me);
			}

			return me;
		},

		/**
		 * Executes a Midas command on the current document, current selection, or the given range.
		 * @param {String} command The command string to execute in the frame's document context.
		 * @param {Booloean} userInterface (optional) True to enable user interface (if supported by the command)
		 * @param {Mixed} value (optional)
		 * @param {Boolean} validate If true, the command is validated to ensure it's invocation is permitted.
		 * @return {Boolean} indication whether command execution succeeded
		 */
		execCommand: function(command, userInterface, value, validate){

			var doc, assert;
			if((doc = this.getFrameDocument()) && !!command){
				try{
					Ext.isIE && this.focus();
					assert = validate && Ext.isFunction(doc.queryCommandEnabled)
						? doc.queryCommandEnabled(command)
						: true;

					return assert && doc.execCommand(command, !!userInterface, value);
				}catch(eex){
					return false;
				}
			}
			return false;
		},

		/**
		 * Sets the current DesignMode attribute of the Frame's document
		 * @param {Boolean/String} active True (or "on"), to enable designMode
		 *
		 */
		setDesignMode: function(active){
			var doc;
			if(doc = this.getFrameDocument()){
				doc.designMode = (/on|true/i).test(String(active)) ? 'On' : 'Off';
			}
			return this;
		},

		/**
		 * Print the contents of the Iframes (if we own the document)
		 * @return {Ext.ux.ManagedIFrame.Element} this
		 */
		print: function(){
			try{
				var win;
				if(win = this.getWindow()){
					Ext.isIE && win.focus();
					win.print();
				}
			}catch(ex){
				//<debug>
				var Err = this.statics().Error;
				Err.raise(
					{
                        msg: Err.message.printexception || ex.description || ex.message,
						error: ex,
						win: win
					}
				);
				//</debug>
			}
			return this;
		},

		/**
		 * Write a script block into the iframe's document
		 * @param {String} block A valid (executable) script source block.
		 * @param {object} attributes Additional Script tag attributes to apply to the script
		 * Element (for other language specs [vbscript, Javascript] etc.) <p>
		 * Note: writeScript will only work after a successful iframe.(Updater)
		 * update or after same-domain document has been hooked, otherwise an
		 * exception is raised.
		 */
		writeScript: function(block, attributes){

			attributes = Ext.apply({}, attributes || {}, {
				type: "text/javascript",
				text: block
			});

			try{
				var head, script, doc = this.getFrameDocument();
				if(doc && typeof doc.getElementsByTagName != 'undefined'){
					if(!(head = doc.getElementsByTagName("head")[0])){
						// some browsers (Webkit, Safari) do not auto-create
						// head elements during document.write
						head = doc.createElement("head");
						doc.getElementsByTagName("html")[0].appendChild(head);
					}
					if(head && (script = doc.createElement("script"))){
						for(var attrib in attributes){
							if(attributes.hasOwnProperty(attrib) && attrib in script){
								script[attrib] = attributes[attrib];
							}
						}
						return !!head.appendChild(script);
					}
				}

			}catch(ex){
			}finally{
				script = head = null;
			}
			return false;
		},

		/**
		 * eval a javascript code block(string) within the context of the
		 * Iframes' window object.
		 * @param {String} block A valid ('eval'able) script source block.
		 * @param {Boolean} useDOM  if true, inserts the function
		 * into a dynamic script tag, false does a simple eval on the function
		 * definition. (useful for debugging) <p> Note: will only work after a
		 * successful iframe.(Updater) update or after same-domain document has
		 * been hooked, otherwise an exception is raised.
		 * @return {Mixed}
		 */
		execScript: function(block, useDOM){
			var me = this;
			try{
				if(me.domWritable()){
					if(useDOM){
						me.writeScript(block);
					}else{
						return me._windowContext.eval(block);
					}
				}else{
					var Err = this.statics().Error;
					throw new Err(
						{ msg: Err.message['execscript-secure-context'],
							script: block
						}
					);
				}
			}catch(ex){
				return false;
			}
			return true;
		},

		/**
		 * Eval a function definition into the iframe window context.
		 * @param {String/Object} fn Name of the function or function map
		 * object: {name:'encodeHTML',fn:Ext.util.Format.htmlEncode}
		 * @param {Boolean} useDOM  if true, inserts the fn into a dynamic script tag,
		 * false does a simple eval on the function definition
		 * @param {Boolean} invokeIt if true, the function specified is also executed in the
		 * Window context of the frame. Function arguments are not supported.
		 * @example <pre><code> var trim = function(s){ return s.replace(/^\s+|\s+$/g,''); };
		 * iframe.loadFunction('trim');
		 * iframe.loadFunction({name:'myTrim',fn:String.prototype.trim || trim});</code></pre>
		 */
		loadFunction: function(fn, useDOM, invokeIt){
			var name = fn.name || fn,
				fnSrc = fn.fn || window[fn];

			name && fnSrc && this.execScript(name + '=' + fnSrc, useDOM); // fn.toString coercion
			invokeIt && this.execScript(name + '()'); // no args only
		},

		/**
		 * @private
		 * Poll the Iframes document structure to determine DOM ready
		 * state, and raise the 'domready' event when applicable.
		 */
		assertOnReady: function(){

			if(Ext.isGecko || this.isReset){
				return;
			}
			// initialise the counter
			var n = 0, frame = this, domReady = false,
				body, l, doc,
				max = this.domReadyRetries || 5000, //default max 5 seconds
				atTarget = false,
				startLocation = (this.getFrameDocument() || {location: {}}).location.href,
				fileSize, href,
				notDefined = /undefined|unknown/i,

				assertion = function(targetURI){ // DOM polling for IE and others
					if(this.domReady){
						return;
					}
					if(doc = this.getFrameDocument()){

						// wait for location.href transition
						// null href is a 'same-origin' document access violation,
						// this assumes the DOM is built when the browser updates it
						href = doc.location.href || '';
						atTarget = !targetURI || (href && (href != startLocation || href.indexOf(targetURI) > -1));

						/*
						 * On IE, when !(Transfer-Encoding: chunked), document.fileSize is populated when
						 * the DOM is ready
						 */
						fileSize = 0;
						try{  //IE/Webkit/Opera? will report the fileSize of the document when the DOM is ready
							fileSize = notDefined.test(typeof doc.fileSize) ? 0 : parseFloat(doc.fileSize);
						}catch(errFilesize){
						}

						domReady = (!!fileSize) || (atTarget && (body = doc.body) && !!(body.innerHTML || '').length );

						if(domReady){
							return frame.loadHandler.call(frame, { type: 'domready'});
						}
					}
					frame.loaded || (++n > max) || Ext.defer(assertion, 2, frame, slice.call(arguments, 0)); // try again
				};
			//console.log('seeking ', frame._targetURI, startLocation);
			assertion.call(frame, frame._targetURI);
		},

		/**
		 * Tries to focus the element. Any exceptions are caught and ignored.
		 * @param {Number} defer (optional) Milliseconds to defer the focus
		 * @return {App.ux.ManagedIframe.Element} this
		 */
		focus: function(defer){
			var me = this,
				w = me.getWindow();
			if(w){
				try{
					if(Number(defer)){
						Ext.defer(me.focus, defer, me, [null]);
					}else{
						w.focus();
					}
				}catch(e){
				}
			}
			w = null;
			return me;
		},

		/**
		 * Tries to blur the element. Any exceptions are caught and ignored.
		 * @return {App.ux.ManagedIframe.Element} this
		 */
		blur: function(){
			var me = this,
				w = me.getWindow();
			if(w){
				try{
					w.blur();
				}catch(e){
				}
			}
			w = null;
			return me;
		},

		/**
		 * <p>Removes this element's dom reference.  Note that event and cache removal is handled at {@link Ext#removeNode Ext.removeNode}</p>
		 */
		remove: function(){
			var me = this,
				dom = me.dom;
			if(dom){
				me.reset();
				Ext.removeNode(dom);
				delete me.dom;
			}
		},

		statics: {

			addMethods: function(o){
				Ext.apply(MIF.Element.prototype, o);
			},

			/** @private
			 * @static
			 * DOMFrameReadyHandler -- Dispatches the captured event to the target MIF.Element
			 */
			DOMFrameReadyHandler: function(e, target){
				var frame;
				try{
					frame = e.target ? e.target.manager : null;
				}catch(rhEx){        //nested (foreign) iframes will throw when accessing target
				}
				if(frame){
					frame.loadHandler.call(frame, e);
				}
			},

			/** @private
			 * @static
			 * Frame document event proxy
			 */
			eventProxy: function(e){
				if(!e) return;

				var evr,
					eventClass;

				if(!e['eventPhase'] || (e['eventPhase'] == (e['AT_TARGET'] || 2))){

					switch(e.type){
						case 'blur':
						case 'focus':
							eventClass = 'UIEvents';
						case 'resize':
							if(Ext.isIE)break;   //IE handles (blur, focus, resize) on the IFRAME itself, so
						// let's not fire them twice.
						case 'scroll':

							//relay subscribed events to the Element instance
							evr = this.dispatchEvent(
								this.createEvent(e.type, eventClass || 'HTMLEvents'),
								e.type
							);
							break;

						case 'unload':
						case 'beforeunload':
							this._unHook();  // same-domain unloads should unhook for next document rendering

					}

				}
				return evr;
			},

			Flyweight: Element.Flyweight,

			/*
			 * Returns the document context of the passed HTMLElement, window, or document object
			 * @return {HTMLDocument}
			 */
			getParentDocument: Element.getParentDocument,

			isDocumentStrict: function(doc){
				return (doc && doc.compatMode && doc.compatMode != "BackCompat");
			},

			/**
			 * Retrieves the document height
			 * @static
			 * @return {Number} documentHeight
			 */
			getDocumentHeight: function(win){
				win = win || window;
				var doc = this.getParentDocument(win);
				return Math.max(!this.isDocumentStrict(doc) ? doc.body.scrollHeight : doc.documentElement.scrollHeight, this.getViewportHeight(win));
			},

			/**
			 * Retrieves the document width
			 * @static
			 * @return {Number} documentWidth
			 */
			getDocumentWidth: function(win){
				win = win || window;
				var doc = this.getParentDocument(win);
				return Math.max(!this.isDocumentStrict(doc) ? doc.body.scrollWidth : doc.documentElement.scrollWidth, this.getViewportWidth(win));
			},

			/**
			 * Retrieves the viewport height of the window.
			 * @static
			 * @return {Number} viewportHeight
			 */
			getViewportHeight: function(win){
				return (win || window).innerHeight;
			},

			/**
			 * Retrieves the viewport width of the window.
			 * @static
			 * @return {Number} viewportWidth
			 */
			getViewportWidth: function(win){
				return (win || window).innerWidth;
			},

			/**
			 * Retrieves the viewport size of the window.
			 * @static
			 * @return {Object} object containing width and height properties
			 */
			getViewSize: function(win){
				win = win || window;
				return {
					width: this.getViewportWidth(win),
					height: this.getViewportHeight(win)
				};
			},

			/**
			 * Returns the top Element that is located at the passed coordinates
			 * @static
			 * @param {Number} x The x coordinate
			 * @param {Number} x The y coordinate
			 * @param {HTMLElement} doc The targeted document context
			 * @return {FlyWeight} The found Element
			 */
			fromPoint: function(x, y, doc){
				doc = this.getParentDocument(doc || document);
				return doc ? Ext.fly(doc.elementFromPoint(x, y), '_fromPoint') : null;
			}

		}
	});

	Ext.define('App.ux.ManagedIframe.Error', {
		extend: 'Ext.Error',
		name: 'App.ux.ManagedIframe.Error',
		statics: {
			raise: Ext.Error.raise,
			ignore: false,
			handle: function(){
				return this.ignore;
			},
			message: {
				'execscript-secure-context': 'An attempt was made at script execution within a document context with restricted access.',
				'printexception': 'An Error was encountered attempting the print the frame contents (document access is likely restricted).'
			}
		}
	});

	//Give MIFElement a static reference to the Error class
	MIF.Element.addStatics(
		{Error: App.ux.ManagedIframe.Error}
	);

	// for Gecko and any who might support it later
	if(window.addEventListener){

		window.addEventListener("DOMFrameContentLoaded", MIF.Element.DOMFrameReadyHandler, false);

		Ext.EventManager.on(window, 'beforeunload', function(){
			window.removeEventListener("DOMFrameContentLoaded", MIF.Element.DOMFrameReadyHandler, false);
		});
	}

}());

Ext.define('App.ux.NodeDisabled',
	{
		alias:'plugin.nodedisabled',
		extend:'Ext.AbstractPlugin'

		//configurables
		/**
		 * @cfg {String} disabledCls
		 * The CSS class applied when the {@link Ext.data.Model} of the node has a 'disabled' field with a true value.
		 */,
		disabledCls:'tree-node-disabled'
		/**
		 * @cfg {Boolean} preventSelection
		 * True to prevent selection of a node that is disabled. Default true.
		 */,
		preventSelection:true

		/**
		 * @cfg {Boolean} preventChecking
		 * True to prevent checking of a node that is disabled. Default true.
		 */,
		preventChecking:true

		//properties

		/**
		 * @private
		 * @param {Ext.tree.Panel} tree
		 */,
		init:function(tree){
			var me = this, view = tree.getView(), origFn, origScope;

			me.callParent(arguments);

			origFn = view.getRowClass;
			if(origFn){
				origScope = view.scope || me;
				Ext.apply(view,{
					getRowClass:function(){
						var v1, v2;
						v1 = origFn.apply(origScope, arguments) || '';
						v2 = me.getRowClass.apply(me, arguments) || '';
						return (v1 && v2) ? v1 + ' ' + v2 : v1 + v2;
					}
				});
			}else{
				Ext.apply(view,{
					getRowClass:Ext.Function.bind(me.getRowClass, me)
				});
			}

			if(me.preventSelection){
				tree.getSelectionModel().on('beforeselect', me.onBeforeNodeSelect, me);
			}

			if(me.preventChecking){
				tree.on('checkchange', me.checkchange, me);
			}
		}// eof init
		/**
		 * Returns a properly typed result.
		 * @return {Ext.tree.Panel}
		 */,
		getCmp:function(){
			return this.callParent(arguments);
		}//eof getCmp
		/**
		 * @private
		 * @param {Ext.data.Model} record
		 * @param {Number} index
		 * @param {Object} rowParams
		 * @param {Ext.data.Store} ds
		 * @return {String}
		 */,
		getRowClass:function(record, index, rowParams, ds){
			return record.get('disabled') ? this.disabledCls : '';
		}//eof getRowClass
		/**
		 * @private
		 * @param {Ext.selection.TreeModel} sm
		 * @param {Ext.data.Model} node
		 * @return {Boolean}
		 */,
		onBeforeNodeSelect:function(sm, node){
			if(node.get('disabled')){
				return false;
			}
		}//eof onBeforeNodeSelect
		/**
		 * @event checkchange
		 * Fires when a node with a checkbox's checked property changes
		 * @param {Ext.data.Model} node The node who's checked property was changed
		 * @param {Boolean} checked The node's new checked state
		 */,
		checkchange:function(node, checked){
			if(node.get('disabled')){
				node.set('checked', !checked);
			}
		}//eof checkchange
	});
//eo class

//end of file
Ext.define('App.ux.PhotoIdWindow',
{
	extend : 'Ext.window.Window',
	alias : 'widget.photoidwindow',
	height : 320,
	width : 320,
	layout : 'fit',
	renderTo : document.body,
	initComponent : function()
	{
		var me = this;

		window.webcam.set_api_url('dataProvider/WebCamImgHandler.php');
		window.webcam.set_swf_url('lib/jpegcam/htdocs/webcam.swf');
		window.webcam.set_quality(100);
		// JPEG quality (1 - 100)
		window.webcam.set_shutter_sound(true, 'lib/jpegcam/htdocs/shutter.mp3');
		// play shutter click sound
		window.webcam.set_hook('onComplete', 'onWebCamComplete');

		Ext.apply(me,
		{
			html : window.webcam.get_html(320, 320),
			buttons : [
			{
				text : _('capture'),
				iconCls : 'save',
				handler : me.captureToCanvas
			},
			{
				text : _('cancel'),
				scope : me,
				handler : function()
				{
					this.close();
				}
			}]
		});
		me.callParent(arguments);
	},

	captureToCanvas : function()
	{
		window.webcam.snap();
	}
}); 
Ext.define('App.ux.PatientEncounterCombo', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.patientEncounterCombo',
	hideLabel: true,
	displayField: 'display_string',
	valueField: 'eid',
	emptyText: _('select') + '...',
	width: 400,
	editable: false,
	queryMode: 'local',
	includeAllSelection: true,
	initComponent: function(){
		var me = this;

		Ext.define('patientEncounterComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'eid',
					type: 'string'
				},
				{
					name: 'brief_description',
					type: 'string'
				},
				{
					name: 'service_date',
					type: 'date',
					dateFormat: 'Y-m-d H:i:s'
				},
				{
					name: 'close_date',
					type: 'date',
					dateFormat: 'Y-m-d H:i:s'
				},
				{
					name: 'display_string',
					type: 'string',
					convert: function(v, record){
						return Ext.Date.format(record.data.service_date, g("date_time_display_format")) + ' - ' + Ext.String.ellipsis(record.data.brief_description, 25);
					}
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Encounter.getEncounters'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'patientEncounterComboModel',
			pageSize: 500,
			autoLoad: false,
			sorters: [
				{
					property: 'service_date',
					direction: 'ASC'
				}
			],
			listeners: {
				load: function () {
					if(!me.includeAllSelection) return;
                    me.store.insert(0,{
                        eid: 'no_enc',
                        brief_description: _('no_encounters'),
                        service_date: '0000-00-00'
                    });
					me.store.insert(0,{
                        eid: 'all_enc',
						brief_description: _('all_encounters'),
						service_date: '0000-00-00'
					});
				}
			}
		});

		me.callParent();

	}

});

Ext.define('App.ux.RenderPanel', {
	extend: 'Ext.container.Container',
	alias: 'widget.renderpanel',
	cls: 'RenderPanel',
	layout: 'border',
	frame: false,
	border: false,
	pageLayout: 'fit',
	pageBody: [],
	pageTitle: '',
	pageButtons: null,
	pageTBar: null,
	pageBBar: null,
	pagePadding: null,
	showRating: false,
	pageAutoScroll: false,

	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			items: [
				me.mainHeader = Ext.widget('container', {
					cls: 'RenderPanel-header',
					itemId: 'RenderPanel-header',
					region: 'north',
					layout: 'hbox',
					height: 30
				}),
				{
					cls: 'RenderPanel-body-container',
					itemId: 'RenderPanel-body-container',
					xtype: 'container',
					region: 'center',
					layout: 'fit',
					padding: this.pagePadding == null ? 5 : this.pagePadding,
					items: [
						me.mainBoddy = Ext.widget('panel', {
							cls: 'RenderPanel-body',
							frame: true,
							border: false,
							itemId: 'pageLayout',
							defaults: { frame: false, border: false, autoScroll: true },
							autoScroll: me.pageAutoScroll,
							layout: me.pageLayout,
							items: me.pageBody,
							tbar: me.pageTBar,
							bbar: me.pageBBar,
							buttons: me.pageButtons
						})
					]
				}
			]
		});

		me.pageTitleDiv = me.mainHeader.add(
			Ext.widget('container', {
				cls: 'panel_title',
				html: me.pageTitle
			})
		);

		me.pageReadOnlyDiv = me.mainHeader.add(
			Ext.widget('container') // placeholder
		);

		if(me.showRating){
			me.pageRankingDiv = me.mainHeader.add(
				Ext.widget('ratingField', {
					flex: 1,
					listeners: {
						scope: me,
						click: function(field, val){
							Patient.setPatientRating({pid: app.patient.pid, rating: val}, function(){
								app.msg(_('sweet'), _('record_saved'))
							});
						}
					}
				})
			);
		}

		me.pageTimerDiv = me.mainHeader.add(
			Ext.widget('container', {
				width: 200
			})
		);

		me.callParent(arguments);
	},

	updateTitle: function(pageTitle, readOnly, timer){
		this.pageTitleDiv.update(pageTitle);
		this.pageReadOnlyDiv.update(readOnly ? _('read_only') : '');
		this.pageTimerDiv.update(timer);
	},

	getPageHeader: function(){
		return this.getComponent('RenderPanel-header');
	},

	getPageBodyContainer: function(){
		return this.getComponent('RenderPanel-body-container');
	},

	getPageBody: function(){
		return this.mainBoddy;
	},

	onActive: function(callback){
		if(typeof callback == 'function') callback(true);
	}


});

Ext.define('App.ux.form.fields.Checkbox', {
	extend        : 'Ext.form.field.Checkbox',
	alias         : 'widget.mitos.checkbox',
	inputValue    : '1',
	uncheckedValue: '0'
});
Ext.define('App.ux.form.fields.ColorPicker', {
    extend: 'Ext.form.field.Trigger',
    alias: 'widget.colorcombo',
    triggerTip: 'Please select a color.',
    onTriggerClick: function(){
        var me = this;
        picker = Ext.create('Ext.picker.Color', {
            pickerField: this,
            ownerCt: this,
            renderTo: document.body,
            floating: true,
            hidden: true,
            focusOnShow: true,
            style: {
                backgroundColor: "#fff"
            },
            listeners: {
                scope: this,
                select: function(field, value, opts){
                    me.setValue('#' + value);
                    me.inputEl.setStyle({backgroundColor: value});
                    picker.hide();
                },
                show: function(field, opts){
                    field.getEl().monitorMouseLeave(500, field.hide, field);
                }
            }
        });
        picker.alignTo(me.inputEl, 'tl-bl?');
        picker.show(me.inputEl);
    }
});
Ext.define('App.ux.form.fields.Help', {
    extend       : 'Ext.Img',
    alias        : 'widget.helpbutton',
    src          : 'resources/images/icons/icohelp.png',
    height       : 16,
    width        : 16,
    margin       : '3 10',
    helpMsg      : _('help_message'),
    initComponent: function() {
        var me = this;
        me.listeners = {
            render: function(c) {
                me.setToolTip(c.getEl());
            }
        };
        me.callParent();
    },

    setToolTip: function(el) {
        Ext.create('Ext.tip.ToolTip', {
            target      : el,
            dismissDelay: 0,
            html        : this.helpMsg
        });
    }
});
Ext.define('App.ux.form.fields.CheckBoxWithText', {
	extend: 'Ext.form.FieldContainer',
	mixins: {
		field: 'Ext.form.field.Field'
	},
	xtype: 'checkboxwithtext',
	layout: 'hbox',
	boxLabel: 'boxLabel',
	emptyText: '',
	readOnly: false,
//	combineErrors: true,
	msgTarget: 'under',
	width: 400,

	inputValue: '1',
	uncheckedValue: '0',

	textField1: undefined,
	textField2: undefined,

	initComponent: function(){
		var me = this;

		me.items = me.items || [];

		me.items = [
			{
				xtype:'checkbox',
				boxLabel: me.boxLabel,
				submitValue: false,
				inputValue: me.inputValue,
				width: 150,
				margin: '0 10 0 0'
			}
		];

		me.textField1 = me.textField1 || {
			xtype:'textField1'
		};

		Ext.apply(me.textField1 , {
			submitValue: false,
			flex: 1,
			hidden: true,
			emptyText: me.emptyText
		});

		me.items.push(me.textField1);


		if(me.textField2){

			Ext.apply(me.textField2 , {
				submitValue: false,
				flex: 1,
				hidden: true,
				emptyText: me.emptyText
			});

			me.items.push(me.textField2);
		}

		if(me.layout == 'vbox') me.height = 44;

		me.callParent();

		me.chekboxField = me.items.items[0];
		me.textField1 = me.items.items[1];
		me.chekboxField.on('change', me.settextField1, me);


		if(me.items.items[2]){
			me.textField2 = me.items.items[2];
			me.chekboxField.on('change', me.settextField2, me);
		}

		me.initField();
	},

	settextField1: function(checkbox, value){

		if(!this.textField1) return;

		var body = this.up('window').body,
			scroll = body.getScroll();

		if(value == 0 || value == 'off' || value == false){
			if(this.textField1.reset) this.textField1.reset();
			this.textField1.hide();
			this.textField1.disable();
		}else{
			this.textField1.show();
			this.textField1.enable();
		}

		body.scrollTo('top', scroll.top, false);

	},

	settextField2: function(checkbox, value){

		if(!this.textField2) return;

		var body = this.up('window').body,
			scroll = body.getScroll();

		if(value == 0 || value == 'off' || value == false){
			if(this.textField2.reset) this.textField2.reset();
			this.textField2.hide();
			this.textField2.disable();
		}else{
			this.textField2.show();
			this.textField2.enable();
		}

		body.scrollTo('top', scroll.top, false);

	},

	getValue: function(){
		var value = '',
			ckValue = this.chekboxField.getSubmitValue(),
			txtValue = this.textField1.getSubmitValue() || '';

		if(ckValue) {
			value = ckValue + '~' + txtValue;

			if(this.textField2){
				value += ('~' + (this.textField2.getSubmitValue() || ''));
			}
		}

		return value;
	},

	getSubmitValue: function(){
		return this.getValue();
	},

	setValue: function(value){
		if(value && value.split){
			var val = value.split('~');
			this.chekboxField.setValue(val[0] || 0);
			this.textField1.setValue(val[1] || '');

			if(this.textField2){
				this.textField1.setValue(val[2] || '');
			}

			return;
		}
		this.chekboxField.setValue(0);
		this.textField1.setValue('');
		if(this.textField2) this.textField2.setValue('');
	},

	// Bug? A field-mixin submits the data from getValue, not getSubmitValue
	getSubmitData: function(){
		var me = this,
			data = null;
		if(!me.disabled && me.submitValue && !me.isFileUpload()){
			data = {};
			data[me.getName()] = '' + me.getSubmitValue();
		}
		return data;
	},

	setReadOnly: function(value){
		this.chekboxField.setReadOnly(value);
		this.textField1.setReadOnly(value);
		if(this.textField2) this.textField2.setReadOnly(value);
	},

	isValid: function(){
		return this.chekboxField.isValid() && this.textField1.isValid();
	}
});

Ext.define('App.ux.form.fields.Currency',{
    extend: 'Ext.form.field.Number', //Extending the NumberField
    alias: 'widget.mitos.currency', //Defining the xtype,
    currencySymbol: g('gbl_currency_symbol'),
    useThousandSeparator: true,
    thousandSeparator: ',',
    alwaysDisplayDecimals: true,
    fieldStyle: 'text-align: right;',
    hideTrigger: true,

    initComponent: function () {
        if(this.useThousandSeparator && this.decimalSeparator == ',' && this.thousandSeparator == ','){
            this.thousandSeparator = '.';
        }else if (this.allowDecimals && this.thousandSeparator == '.' && this.decimalSeparator == '.'){
            this.decimalSeparator = ',';
        }
        this.callParent(arguments);
    },

    setValue: function (value) {
        App.ux.form.fields.Currency.superclass.setValue.call(this, value != null ? value.toString().replace('.', this.decimalSeparator) : value);

        this.setRawValue(this.getFormattedValue(this.getValue()));
    },

    getFormattedValue: function (value) {
        if(Ext.isEmpty(value) || !this.hasFormat()){
            return value;
        }else{
            var neg = null;

            value = ( neg = value < 0) ? value * -1 : value;
            value = this.allowDecimals && this.alwaysDisplayDecimals ? value.toFixed(this.decimalPrecision) : value;

            if(this.useThousandSeparator) {
                if(this.useThousandSeparator && Ext.isEmpty(this.thousandSeparator)){
                    throw ('NumberFormatException: invalid thousandSeparator, property must has a valid character.');
                }

                if(this.thousandSeparator == this.decimalSeparator){
                    throw ('NumberFormatException: invalid thousandSeparator, thousand separator must be different from decimalSeparator.');
                }

                value = value.toString();

                var ps = value.split('.');
                ps[1] = ps[1] ? ps[1] : null;

                var whole = ps[0];

                var r = /(\d+)(\d{3})/;

                var ts = this.thousandSeparator;

                while (r.test(whole))
                    whole = whole.replace(r, '$1' + ts + '$2');

                value = whole + (ps[1] ? this.decimalSeparator + ps[1] : '');
            }

            return Ext.String.format('{0}{1}{2}', ( neg ? '-' : ''), (Ext.isEmpty(this.currencySymbol) ? '' : this.currencySymbol), value);
        }
    },
    /**
     * overrides parseValue to remove the format applied by this class
     */
    parseValue: function (value) {
        //Replace the currency symbol and thousand separator
        return App.ux.form.fields.Currency.superclass.parseValue.call(this, this.removeFormat(value));
    },
    /**
     * Remove only the format added by this class to let the superclass validate with it's rules.
     * @param {Object} value
     */
    removeFormat: function (value) {
        if (Ext.isEmpty(value) || !this.hasFormat())
            return value;
        else {
			value = value.toString().replace(this.currencySymbol, '');

            value = this.useThousandSeparator ? value.replace(new RegExp('[' + this.thousandSeparator + ']', 'g'), '') : value;

            return value;
        }
    },
    /**
     * Remove the format before validating the the value.
     * @param {Number} value
     */
    getErrors: function (value) {
        return App.ux.form.fields.Currency.superclass.getErrors.call(this, this.removeFormat(value));
    },

    hasFormat: function () {
        return this.decimalSeparator != '.' || (this.useThousandSeparator == true && this.getRawValue() != null) || !Ext.isEmpty(this.currencySymbol) || this.alwaysDisplayDecimals;
    },
    /**
     * Display the numeric value with the fixed decimal precision and without the format using the setRawValue, don't need to do a setValue because we don't want a double
     * formatting and process of the value because beforeBlur perform a getRawValue and then a setValue.
     */
    onFocus: function () {
        this.setRawValue(this.removeFormat(this.getRawValue()));

        this.callParent(arguments);
    }
});
Ext.define('App.ux.form.fields.Percent',{
    extend: 'Ext.form.field.Number', //Extending the NumberField
    alias: 'widget.mitos.percent', //Defining the xtype,
    currencySymbol: '%',
    useThousandSeparator: false,
    thousandSeparator: ',',
    alwaysDisplayDecimals: true,
    fieldStyle: 'text-align: right;',
    hideTrigger: true,

    initComponent: function () {
        if (this.useThousandSeparator && this.decimalSeparator == ',' && this.thousandSeparator == ','){
            this.thousandSeparator = '.';
        }else if(this.allowDecimals && this.thousandSeparator == '.' && this.decimalSeparator == '.'){
            this.decimalSeparator = ',';
        }
        this.callParent(arguments);
    },

    setValue: function (value) {
        App.ux.form.fields.Currency.superclass.setValue.call(this, value != null ? value.toString().replace('.', this.decimalSeparator) : value);

        this.setRawValue(this.getFormattedValue(this.getValue()));
    },

    getFormattedValue: function (value) {
        if (Ext.isEmpty(value) || !this.hasFormat()){
            return value;
        }else{
            var neg = null;

            value = ( neg = value < 0) ? value * -1 : value;
            value = this.allowDecimals && this.alwaysDisplayDecimals ? value.toFixed(this.decimalPrecision) : value;

            if (this.useThousandSeparator) {
                if(this.useThousandSeparator && Ext.isEmpty(this.thousandSeparator)){
                    throw ('NumberFormatException: invalid thousandSeparator, property must has a valid character.');
                }

                if(this.thousandSeparator == this.decimalSeparator){
                    throw ('NumberFormatException: invalid thousandSeparator, thousand separator must be different from decimalSeparator.');
                }

                value = value.toString();

                var ps = value.split('.');
                ps[1] = ps[1] ? ps[1] : null;

                var whole = ps[0];

                var r = /(\d+)(\d{3})/;

                var ts = this.thousandSeparator;

                while (r.test(whole))
                    whole = whole.replace(r, '$1' + ts + '$2');

                value = whole + (ps[1] ? this.decimalSeparator + ps[1] : '');
            }

            return Ext.String.format('{0}{1}{2}', (neg ? '-' : ''), value, (Ext.isEmpty(this.currencySymbol) ? '' : this.currencySymbol));
        }
    },
    /**
     * overrides parseValue to remove the format applied by this class
     */
    parseValue: function (value) {
        //Replace the currency symbol and thousand separator
        return App.ux.form.fields.Currency.superclass.parseValue.call(this, this.removeFormat(value));
    },
    /**
     * Remove only the format added by this class to let the superclass validate with it's rules.
     * @param {Object} value
     */
    removeFormat: function (value) {
        if (Ext.isEmpty(value) || !this.hasFormat()){
            return value;
        }else{
            value = value.toString().replace(this.currencySymbol, '');

            value = this.useThousandSeparator ? value.replace(new RegExp('[' + this.thousandSeparator + ']', 'g'), '') : value;

            return value;
        }
    },
    /**
     * Remove the format before validating the the value.
     * @param {Number} value
     */
    getErrors: function (value) {
        return App.ux.form.fields.Currency.superclass.getErrors.call(this, this.removeFormat(value));
    },

    hasFormat: function () {
        return this.decimalSeparator != '.' || (this.useThousandSeparator == true && this.getRawValue() != null) || !Ext.isEmpty(this.currencySymbol) || this.alwaysDisplayDecimals;
    },
    /**
     * Display the numeric value with the fixed decimal precision and without the format using the setRawValue, don't need to do a setValue because we don't want a double
     * formatting and process of the value because beforeBlur perform a getRawValue and then a setValue.
     */
    onFocus: function () {
        this.setRawValue(this.removeFormat(this.getRawValue()));

        this.callParent(arguments);
    }
});
Ext.define('App.ux.form.fields.MultiText', {
	extend: 'Ext.form.FieldContainer',
	xtype: 'multitextfield',
	layout: {
		type:'vbox',
		align: 'stretch'
	},
	name: null,
	numbers: true,
	initComponent: function(){
		var me = this;

		me.lastField = null;

		me.callParent();
		me.addField();
	},

	addField:function(value){
		var me = this;

		me.lastField = me.add({
			xtype:'textfield',
			name: '_' + me.name,
			anchor: '100%',
			value: value || '',
			labelWidth: 20,
			margin: '0 0 5 0',
			enableKeyEvents: true
		});
		if(me.numbers) me.lastField.setFieldLabel((me.items.items.indexOf(me.lastField) + 1).toString());
		me.lastField.on('keyup', this.onFieldKeyUp, this);

	},

	onFieldKeyUp:function(field, e){
		if(e.getKey() == e.TAB) return;

		var me = this,
			index = me.items.items.indexOf(field),
			totals =  me.items.items.length,
			isLast = (index + 1) == totals,
			isNextToLast = (index + 2) == totals;

		if(isLast && field.getValue().length > 0 && this.lastField == field && !(e.getKey() == e.DELETE || e.getKey() == e.BACKSPACE)){
			this.addField();
			me.doLayout();
		}else if(isNextToLast && field.getValue().length == 0 && me.lastField != field){
			me.remove(me.lastField);
			me.doLayout();
			me.lastField = field;
		}
	},

	setValue:function(data){
		var me = this;

		me.removeAll(true);

		if(Ext.isString(data) && data != ''){
			me.addField(data);
		}else if(Ext.isArray(data)){
			for(var i=0; i < data.length; i++){
				me.addField(data[i]);
			}
		}
		me.addField('');
	},

	getValue:function(){
		var me = this,
			values = me.up('form').getForm().getValues()['_' + me.name];
		if(values[values.length - 1] == '') Ext.Array.erase(values, values.length - 1, 1);
		return values;
	}
});
Ext.define('App.ux.form.fields.CustomTrigger', {
	extend: 'Ext.form.field.Trigger',
	alias: 'widget.customtrigger',
	hideLabel    : true,
	triggerTip: _('click_to_clear_selection'),
	qtip: _('clearable_combo_box'),
	trigger1Class:'x-form-select-trigger',
	trigger2Class:'x-form-clear-trigger',

	onRender:function (ct, position) {
		this.callParent(arguments);
		var id = this.getId();

		this.triggerConfig = {
			tag:'div', cls:'x-form-twin-triggers', style:'display:block;', cn:[
				{tag:"img", style:Ext.isIE ? 'margin-left:0;height:21px' : '', src:Ext.BLANK_IMAGE_URL, id:"trigger2" + id, name:"trigger2" + id, cls:"x-form-trigger " + this.trigger2Class}
			]};
		this.triggerEl.replaceWith(this.triggerConfig);
		this.triggerEl.on('mouseup', function() {
			this.destroy();
		}, this);
		var trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	}
});
Ext.define('App.ux.form.fields.Switch',{
    extend: 'Ext.slider.Single',

    xtype: 'switchfield',
    cls: 'switch-field-slider',
    onValue: 'true',
    offValue: 'false',
    neutralValue: null,
    width: 150,
    value: null,
    increment: 1,
    minValue: 0,
    maxValue: 2,
    animate: false,
    labelWidth: 150,
    mapSliderToValue: {},
    mapValueToSlider: {},
    boxLabel: '',
    boxLabelCls: Ext.baseCSSPrefix + 'form-cb-label',
    boxLabelAlign: 'after',

    initComponent: function () {
        var me = this;

        me.mapSliderToValue['0'] = me.offValue;
        me.mapSliderToValue['1'] = null;
        me.mapSliderToValue['2'] = me.onValue;

        me.mapValueToSlider[me.offValue] = 0;
        me.mapValueToSlider['null'] = 1;
        me.mapValueToSlider[me.onValue] = 2;

        if(me.boxLabel){
            me.on('render', me.doBoxLabel, me);
        }
        me.on('change', me.onSliderValueChange, me);

        me.callParent(arguments);
        me.onSliderValueChange(me, me.mapValueToSlider[me.value]);

    },

    doBoxLabel: function(){
        this.inputRow.appendChild({
            tag: 'td',
            width: this.labelWidth,
            html: Ext.String.format('<label class="{0} {0}-{1}" style="width:100%;">{2}</label>',
                this.boxLabelCls, this.boxLabelAlign, this.boxLabel)
        });
    },

    onSliderValueChange: function(slider, value){
        if(value === 0){
            this.addCls('switch-field-off');
            this.removeCls('switch-field-on');
        }else if(value === 2){
            this.addCls('switch-field-on');
            this.removeCls('switch-field-off');
        }else{
            this.removeCls('switch-field-off');
            this.removeCls('switch-field-on');
        }
    },

    getSubmitData: function() {
        var data = {};
        data[this.getName()] = this.getValue();
        return data;
    },

    getValue: function() {
        // just returns the value of the first thumb, which should be the only one in a single slider
        return this.mapSliderToValue[this.callParent([0])];
    },

    /**
     * Programmatically sets the value of the Slider. Ensures that the value is constrained within the minValue and
     * maxValue.
     * @param {Number} value The value to set the slider to. (This will be constrained within minValue and maxValue)
     * @param {Boolean} [animate] Turn on or off animation
     */
    setValue: function(value, animate) {

         var args = arguments,
            len  = args.length;

        if(len === 0 || args[0] === undefined || value === undefined){
            args[0] = 1;
        }

        var mapValue = this.mapValueToSlider[args[0]];

        if(mapValue !== undefined){
            args[0] = mapValue;
        }

        this.onSliderValueChange(this, args[0]);

        return this.callParent(args);
    },


});
Ext.define('App.ux.form.fields.DateTime', {
	extend: 'Ext.form.FieldContainer',
	mixins: {
		field: 'Ext.form.field.Field'
	},
	alias: 'widget.mitos.datetime',

	combineErrors: true,
	layout: 'hbox',
	readOnly: false,
	allowBlank: true,

	/**
	 * @cfg {String} dateFormat
	 * The default is 'Y-m-d'
	 */
	dateFormat: g('date_display_format'),
	dateSubmitFormat: 'Y-m-d',
	/**
	 * @cfg {String} timeFormat
	 * The default is 'H:i:s'
	 */
	timeFormat: 'g:i a',
	/**
	 * @cfg {String} dateTimeFormat
	 * The format used when submitting the combined value.
	 * Defaults to 'Y-m-d H:i:s'
	 */
	dateTimeFormat: 'Y-m-d H:i:s',
	/**
	 * @cfg {Object} dateConfig
	 * Additional config options for the date field.
	 */
	dateConfig: {},
	/**
	 * @cfg {Object} timeConfig
	 * Additional config options for the time field.
	 */
	timeConfig: {},


	// properties

	dateValue: null, // Holds the actual date
	/**
	 * @property dateField
	 * @type Ext.form.field.Date
	 */
	dateField: null,
	/**
	 * @property timeField
	 * @type Ext.form.field.Time
	 */
	timeField: null,

	initComponent: function () {
		var me = this;
		me.items = me.items || [];

		me.dateConfig.allowBlank = me.allowBlank;

		me.dateField = Ext.create('Ext.form.field.Date', Ext.apply({
			format: me.dateFormat,
			submitFormat: me.dateSubmitFormat,
			flex: 1,
			emptyText: _('date'),
			margin: 0,
			submitValue: false
		}, me.dateConfig));
		me.items.push(me.dateField);

		me.timeField = Ext.create('Ext.form.field.Time', Ext.apply({
			format: me.timeFormat,
			flex: 1,
			emptyText: _('time'),
			margin: 0,
			submitValue: false
		}, me.timeConfig));
		me.items.push(me.timeField);

		for (var i = 0; i < me.items.length; i++) {
			me.items[i].on('focus', Ext.bind(me.onItemFocus, me));
			me.items[i].on('blur', Ext.bind(me.onItemBlur, me));
			me.items[i].on('specialkey', function (field, event) {
				var key = event.getKey(),
					tab = key == event.TAB;

				if (tab && me.focussedItem == me.dateField) {
					event.stopEvent();
					me.timeField.focus();
					return;
				}

				me.fireEvent('specialkey', field, event);
			});
		}

		if (me.layout == 'vbox') me.height = 44;

		me.callParent();

		// this dummy is necessary because Ext.Editor will not check whether an inputEl is present or not
//		this.inputEl = {
//			dom         : {},
//			swallowEvent: function() {
//			}
//		};

		me.initField();
	},

	focus: function () {
		this.callParent();
		this.dateField.focus();
	},

	onItemFocus: function (item) {
		if (this.blurTask) this.blurTask.cancel();
		this.focussedItem = item;
	},

	onItemBlur: function (item) {
		var me = this;
		if (item != me.focussedItem) return;
		// 100ms to focus a new item that belongs to us, otherwise we will assume the user left the field
		me.blurTask = new Ext.util.DelayedTask(function () {
			me.fireEvent('blur', me);
		});
		me.blurTask.delay(100);
	},

	getValue: function () {
		var value = null,
			date = this.dateField.getSubmitValue(),
			time = this.timeField.getSubmitValue();

		if (date) {
			if (time) {
				var format = this.getFormat();
				value = Ext.Date.parse(date + ' ' + time, format);
			}
			else {
				value = this.dateField.getValue();
			}
		}
		return value;
	},

	getSubmitValue: function () {
		var value = this.getValue();
		return value ? Ext.Date.format(value, this.dateTimeFormat) : null;
	},

	setValue: function (value) {
		if (Ext.isString(value)) {
			value = Ext.Date.parse(value, this.dateTimeFormat);
		}
		this.dateField.setValue(value);
		this.timeField.reset();
		this.timeField.setValue(value);
	},

	getFormat: function () {
		return (this.dateField.submitFormat || this.dateField.format) + " " + (this.timeField.submitFormat || this.timeField.format);
	},

	// Bug? A field-mixin submits the data from getValue, not getSubmitValue
	getSubmitData: function () {
		var me = this,
			data = null;
		if (!me.disabled && me.submitValue && !me.isFileUpload()) {
			data = {};
			data[me.getName()] = '' + me.getSubmitValue();
		}
		return data;
	},

	setReadOnly: function (value) {
		this.dateField.setReadOnly(value);
		this.timeField.setReadOnly(value);
	},

	setMaxValue: function (date) {
		this.dateField.setMaxValue(date);
	}
});

//eo file
Ext.define('App.ux.form.fields.PhysicalExamField', {
	extend: 'Ext.form.FieldContainer',
	xtype: 'physicalexamfield',

	labelAlign: 'top',
	isFormField: true,
	submitValue: true,
	name: undefined,

	getName: function (){
		return this.name;
	},
	validate: function (){
		return true;
	},
	isValid: function (){
		return true;
	},
	isDirty: function (){
		return false;
	},
	initComponent:function(){

		var me = this;

			// 'itemId',
			// 'action',
			// 'name',
			// 'width',
			// 'fieldLabel',
			// 'boxLabel',
			// 'inputValue',
			// 'fieldLabel',
			// 'hideLabel',
			// 'labelWidth',
			// 'margin',
			// 'code'

		me.items = [
			{
				xtype: 'checkbox',
				boxLabel: 'Normal ' + me.boxLabel,
				action: 'normal',
				inputValue: true,
				uncheckedValue: false,
				submitValue: false
			},
			{
				xtype: 'container',
				layout: 'hbox',
				items: [
					{
						xtype: 'checkbox',
						boxLabel: 'ABN: ',
						action: 'abnormal',
						inputValue: true,
						uncheckedValue: false,
						submitValue: false
					},
					{
						xtype: 'textfield',
						margin: '0 0 0 5',
						width: 200,
						action: 'abnormalnote',
						submitValue: false
					}
				]
			}
		]

		me.callParent();

		me.normalCk = me.down('checkbox[action=normal]');
		me.abnormalCk = me.down('checkbox[action=abnormal]');
		me.abnormalNote = me.down('textfield[action=abnormalnote]');

		me.normalCk.on('change', function (newValue){

			if(me.normalCk.ignoreChange === true){
				return;
			}

			me.abnormalCk.ignoreChange = true
			me.abnormalCk.setValue(!newValue);
			me.abnormalCk.ignoreChange = false
		});

		me.abnormalCk.on('change', function (newValue){

			if(me.abnormalCk.ignoreChange === true){
				return;
			}

			me.normalCk.ignoreChange = true
			me.normalCk.setValue(!newValue);
			me.normalCk.ignoreChange = false
		});

	},

	getSubmitData: function (){
		return this.getValue();
	},

	getValue: function (){
		var v = {}

		v[this.name] = {
			label: this.fieldLabel,
			normal: this.normalCk.getValue(),
			abnormal: this.abnormalCk.getValue(),
			abnormal_note: this.abnormalNote.getValue(),
		}
		return v;

	},

	setValue: function (value){
		var me = this;

		say(value);

		me.normalCk.ignoreChange = true;
		me.abnormalCk.ignoreChange = true;

		me.normalCk.setValue(value.normal);
		me.abnormalCk.setValue(value.abnormal);
		me.abnormalNote.setValue(value.abnormal_note);

		me.normalCk.ignoreChange = false;
		me.abnormalCk.ignoreChange = false;

	}

});


Ext.define('App.ux.grid.DeleteColumn', {
	extend: 'Ext.grid.column.Action',
	xtype: 'griddeletecolumn',
	icon: 'resources/images/icons/delete.png',  // Use a URL in the icon config
	tooltip: _('delete'),
	acl: '*',
	width: 30,
	forceSync: true,
	handler: function(grid, rowIndex, colIndex, item, e, record) {
		var me = this,
			acl = Ext.isString(this.acl) ? a(this.acl) : eval(this.acl),
			eid = record.get('eid');

		say(eid);

		if(eid !== app.patient.eid && eid !== 0 && !Ext.isEmpty(eid)){
			app.msg(_('oops'), _('remove_encounter_related_error'), true);
			return;
		}

		if(acl !== true) {
			app.msg(_('oops'), _('permission_denied'), true);
			return;
		}

		var store = grid.store;
		store.remove(record);

		if(store.autoSync || me.forceSync){
			Ext.Msg.show({
				title:_('wait'),
				msg: _('delete_record_confirmation'),
				buttons: Ext.Msg.YESNO,
				icon: Ext.Msg.QUESTION,
				fn: function(btn){
					if(btn === 'yes'){
						if(!store.autoSync && me.forceSync){
							store.sync({
								callback: function () {
									app.msg(_('sweet'), _('record_removed'), 'yellow');
								}
							});
						}else {
							app.msg(_('sweet'), _('record_removed'), 'yellow');
						}
					}else{
						store.rejectChanges();
					}
				}
			});
		}
	}
});

Ext.define('App.ux.form.fields.plugin.BadgeText', {
	extend: 'Ext.AbstractPlugin',
	alias: 'plugin.badgetext',

	disableBg: 'gray',
	enableBg: 'red',
	textSize: 15,
	textColor: 'white',
	defaultText: ' ',
	disableOpacity: 0,
	align: 'left',
	text: ' ',
	disable: true,
	button: null,
	/**
	 *
	 * @param button
	 */
	init: function(button){

		var me = this;

		me.button = button;
		me.text = me.defaultText;

		button.on('render', me.addBadgeEl, me);

		Ext.apply(button,{

			setBadgeText:function(text){

				me.disable = typeof text == 'undefined' || text === me.defaultText;
				me.text = !me.disable ? text : me.defaultText;
				if (button.rendered) {
					button.badgeEl.update(text.toString ? text.toString() : text);
					if (Ext.isStrict && Ext.isIE8) {
						button.el.repaint();
					}
					me.setDisabled(me.disable);
				}
				return button;
			},

			getBadgeText:function(){
				return me.text;
			}


		});

	},

	/**
	 *
	 * @param button
	 */
	addBadgeEl: function(button){
		var me = this,
			styles = {
				'position': 'absolute',
				'background-color': me.disableBg,
				'font-size': me.textSize + 'px',
				'color': me.textColor,
				'padding': '1px 5px',
				'index': 50,
				'top': '-3px',
				'border-radius': '15px',
				'font-weight': 'bold',
				'text-shadow': 'rgba(0, 0, 0, 0.5) 0 -0.08em 0',
				'box-shadow': 'rgba(0, 0, 0, 0.3) 0 0.1em 0.1em',
				'cursor':'pointer'
			};

		if(me.align == 'left'){
			styles.left = '-3px';
		}else{
			styles.right = '-3px';
		}

		button.badgeEl = Ext.DomHelper.append(button.el, { tag:'div', cls:'badgeText x-unselectable'}, true);
		button.badgeEl.setOpacity(me.disableOpacity);
		button.badgeEl.setStyle(styles);
		button.badgeEl.update(me.text.toString ? me.text.toString() : me.text);

		button.el.setStyle({
			overflow: 'hidden'
		});

	},

	/**
	 *
	 */
	onBadgeClick:function(){
		var me = this;
		me.button.fireEvent('badgeclick', me.button, me.text)
	},

	/**
	 *
	 * @param disable
	 */
	setDisabled:function(disable){
		var me = this;

		me.button.badgeEl.setStyle({
			'background-color': (disable ? me.disableBg : me.enableBg),
			//'color': (disable ? 'black' : 'white'),
			'opacity': (disable ? me.disableOpacity : 1)
		});

		me.button.badgeEl.clearListeners();
		if(!disable) me.button.badgeEl.on('click', me.onBadgeClick, me, { preventDefault: true, stopEvent:true });

	}
});
Ext.define('App.ux.grid.EventHistory',{
    extend: 'Ext.grid.Panel',
    alias : 'widget.mitos.eventhistorygrid',
    initComponent:function(){
        Ext.apply(this,{
            columns: [
                { header: _('date'),  dataIndex: 'date', width: 140, renderer: Ext.util.Format.dateRenderer('Y-m-d g:i:s a') },
                { header: _('user'),  dataIndex: 'user', width: 150 },
                { header: _('event'), dataIndex: 'event', flex: 1 }
            ]
        },null);

        this.callParent(arguments);
    }
});
Ext.define('App.ux.form.fields.plugin.ReadOnlyLabel', {
	extend: 'Ext.AbstractPlugin',
	alias: 'plugin.readonlylabel',

	align: 'right',

	text: _('read_only'),
	textBg: 'red',
	textSize: '14',
	textColor: 'white',
	textOpacity: .4,

	/**
	 *
	 * @param field
	 */
	init: function(field){
		var  me = this;

		field.on('render', me.onRender, me);
		field.on('writeablechange', me.setReadOnly, me);

	},

	setReadOnly: function(field, readOnly){
		field.readOnlyEl.setVisible(readOnly);
	},

	onRender: function(field){
		this.addReadOnlyEl(field);
		this.setReadOnly(field, field.readOnly);
	},

	/**
	 *
	 * @param field
	 */
	addReadOnlyEl: function(field){
		var me = this,
			styles = {
				'position': 'absolute',
				'background-color': me.textBg,
				'font-size': me.textSize + 'px',
				'color': me.textColor,
				'padding': '5px 10px',
				'index': 50,
				'top': '10px',
				'border-radius': '5px',
				'visibility': 'hidden'
			};

		if(me.align == 'left'){
			styles.left = '10px';
		}else{
			styles.right = '10px';
		}

		field.readOnlyEl = Ext.DomHelper.append(field.el, { tag:'div', cls:'badgeText x-unselectable'}, true);
		field.readOnlyEl.setOpacity(me.textOpacity);
		field.readOnlyEl.setStyle(styles);
		field.readOnlyEl.update(me.text.toString ? me.text.toString() : me.text);

	}

});
Ext.define('App.ux.form.Panel', {
	extend   : 'Ext.form.Panel',
	alias    : 'widget.mitos.form',
	bodyStyle: 'padding: 10px;',
	autoWidth: true,
	border   : false
});
Ext.define('App.ux.form.AdvanceForm', {
    extend: 'Ext.AbstractPlugin',
    alias: 'plugin.advanceform',
    /**
     * @cfg {Boolean} syncAcl
     * Sync access control, true to allow the store to sync.
     */
    syncAcl: true,
    /**
     * @cfg {Boolean} autoSync
     * True to autosave the form every time values is change, Default to false.
     */
    autoSync: false,
    /**
     * @cfg {Boolean} enabled
     */
    enabled: true,
    /**
     * True to add a tool component to the form panel. Default to true.
     * @cfg {Boolean} autoSyncTool
     */
    autoSyncTool:true,
    /**
     * @cfg {int} syncDelay
     * Autosave de delay to sync the form store. Default to 3000.
     */
    syncDelay: 3000,
    /**
     * Init function
     * @param form
     */
    init: function(form){
        this.callParent(arguments);
        form.advanceFormPlugin = this;
        this.formPanel = form;
        this.formPanel.autoSync = this.autoSync;
        this.formPanel.on('beforerender', this.setFieldEvent, this);
        this.form = this.formPanel.getForm();
        this.form.loadRecord = this.loadRecord;
        if(this.autoSyncTool) this.addTool();
    },
    /**
     * Overrides the form basic loadRecord()
     * @param record
     * @return {*|Ext.form.Basic|Ext.form.Basic|Ext.form.Basic|Ext.form.Basic|Ext.form.Basic|Ext.form.Basic}
     */
    loadRecord: function(record){
        var form = this,
	        formPanel = form.owner,
	        plugin = this.owner.advanceFormPlugin,
	        rec;

	    if(!record) return form;

	    form.isLoading = true;
        form._record = record;
        plugin.setFormFieldsClean(false);
        record.store.on('write', plugin.onStoreWrite, plugin);
        record.store.on('beforesync', function(store, operation){
            formPanel.fireEvent('beforesync', store, operation);
        }, plugin);
        record.store.on('update', function(store, operation){
            formPanel.fireEvent('update', store, operation);
        }, plugin);
        form.setValues(record.data);
        formPanel.fireEvent('recordloaded', form, record);
        form.isLoading = false;
        return form;
    },
    /**
     * After store write clean form fields and fire write event on form
     * @param store
     * @param operation
     */
    onStoreWrite: function(store, operation){
        this.setFormFieldsClean();
        this.formPanel.fireEvent('write', store, operation);
        app.msg('Sweet!', 'Record Saved');
        delete this.bufferSyncFormFn;
    },
    /**
     * Set on keyup or handler based on xtype
     * @param form
     */
    setFieldEvent: function(form){
        var fields = form.getForm().getFields().items;
        for(var i = 0; i < fields.length; i++){
            if(fields[i].xtype === 'textfield' || fields[i].xtype === 'textarea'|| fields[i].xtype === 'textareafield'){
                fields[i].enableKeyEvents = true;
                fields[i].on('keyup', this.setFieldCondition, this);
	            fields[i].on('change', this.setFieldCondition, this);
            }else if(fields[i].xtype === 'radiofield' || fields[i].xtype === 'checkbox' || fields[i].xtype === 'switchfield'){
                fields[i].scope = this;
                fields[i].handler = this.setFieldCondition;
	            fields[i].on('change', this.setFieldCondition, this);
            }else if(fields[i].xtype === 'datefield'){
                fields[i].on('select', this.setFieldCondition, this);
	            fields[i].on('change', this.setFieldCondition, this);
            }else{
                fields[i].on('select', this.setFieldCondition, this);
            }
        }
    },
    /**
     * Set field condition dirty or clean based on field getSubmitValue()
     * @param field
     */
    setFieldCondition: function(field){
        if(!this.enabled) return;

        var me = this,
	        record = me.form.getRecord(),
	        store = record ? record.store : null,
	        obj = {},
	        valueChanged,
	        el = me.getFieldEl(field);

	    if(store == null) return;

        if((!me.form.isLoading && field.xtype !== 'radiofield') || (!me.form.isLoading && field.xtype === 'radiofield' && field.checked)){
            obj[field.name] = field.getSubmitValue();
            record.set(obj);
            valueChanged = (Object.getOwnPropertyNames(record.getChanges()).length !== 0);
            if(valueChanged === true){
                me.setFieldDirty(field, el, true);
            }else{
                me.setFieldDirty(field, el, false);
            }
            if(this.formPanel.autoSync && this.syncAcl){
                if(typeof me.bufferSyncFormFn === 'undefined'){
                    me.bufferSyncFormFn = Ext.Function.createBuffered(function(){
                        store.sync();
                    }, me.syncDelay);
                    me.bufferSyncFormFn();
                }else{
                    if(valueChanged === true){
                        me.bufferSyncFormFn();
                    }else{
                        me.setFormFieldsClean();
                        delete me.bufferSyncFormFn;
                    }
                }
            }
        }
    },
    /**
     * Set field background if dirty == true
     * @param field
     * @param el
     * @param dirty
     */
    setFieldDirty: function(field, el, dirty){

        if((field.el.hasChanged && !dirty) || (!field.el.hasChanged && dirty)){

        	var elToStyle = field.xtype === 'textarea' ? field.inputEl.el : field.el;

            field.el.hasChanged = dirty;

            if(dirty){
                elToStyle.setStyle({'background-image': 'none', backgroundColor: 'FFDDDD'});
            }else {
                elToStyle.setStyle({'background-image': null, backgroundColor: null});
            }
        }
    },
    /**
     * Get the field main element to change background.
     * Some fields are managed different.
     * @param field
     * @return {*}
     */
    getFieldEl: function(field){
        if(field.xtype == 'textfield' || field.xtype == 'textareafield'){
            return field.inputEl;
        }else if(field.xtype == 'radiofield'){
            return field.ownerCt.el;
        }else if(field.xtype == 'checkbox'){
            return field.el;
        }else{
            return field.el; // leave this for now
        }
    },
    /**
     * This will set all the fields that has change
     */
    setFormFieldsClean: function(){
        var me = this, fields = me.form.getFields().items, el;
        for(var i = 0; i < fields.length; i++){
            el = me.getFieldEl(fields[i]);
            if(typeof fields[i].el != 'undefined' && fields[i].el.hasChanged){
                me.setFieldDirty(fields[i], el, false);
            }
        }
    },

    addTool:function(){
        var me = this,
            bar = me.formPanel.getDockedItems()[0],
            cls = me.formPanel.autoSync ? 'autosave' : '';

        if(bar && me.autoSyncTool){
            bar.insert((bar.items.length -1), Ext.create('Ext.panel.Tool',{
                type:'save',
                cls:cls,
                tooltip: 'Autosave',
                handler: function(event, toolEl, panel, tool){
                    me.formPanel.autoSync = !me.formPanel.autoSync;
                    if(me.formPanel.autoSync){
                        tool.addCls('autosave');
                    }else{
                        tool.removeCls('autosave');
                    }
                    app.msg('Sweet!','AutoSave is ' + (me.formPanel.autoSync ? 'On' : 'Off'));
                }
            }));
        }
    }
});

Ext.define('App.ux.combo.ActiveFacilities', {
	extend: 'Ext.form.ComboBox',
	xtype: 'activefacilitiescombo',
	storeAutoLoad: true,
	editable: false,
	queryMode: 'local',
	valueField: 'option_value',
	displayField: 'option_name',
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		Ext.define('ActiveFacilitiesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'option_name',
					type: 'string'
				},
				{
					name: 'option_value',
					type: 'int'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getActiveFacilities'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ActiveFacilitiesComboModel',
			autoLoad: me.storeAutoLoad
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.window.voidComment',{
    extend:'Ext.window.Window',
    xtype: 'voidcommentwindow',
    itemId: 'VoidCommentWindow',
    alias:'widget.voidwindow',
    closable: false,
    frame: false,
    frameHeader: false,
    title: _('void_comment'),
    init: function() {
        var me = this;
    },
    items:[
        {
            xtype:'textfield',
            itemId:'VOIDComment',
            name: 'void_comment',
            allowBlank: false,
            hideLabel: true,
            grow: true,
            growMax: 600
        }
    ],
    buttons:[
        {
            xtype:'button',
            action:'save',
            text: _('save')
        },
        {
            xtype:'button',
            action:'cancel',
            text: _('cancel'),
            listeners:
            {
                click: function( btn ) { me.close(); }
            }
        }
    ]
});

Ext.define('App.ux.grid.SlidingPagerAndPageSize', {
	requires: [
		'Ext.slider.Single',
		'Ext.slider.Tip'
	],

	/**
	 * Creates new SlidingPager.
	 * @param {Object} config Configuration options
	 */
	constructor : function(config) {
		if (config) {
			Ext.apply(this, config);
		}
	},

	init : function(pbar){
		var me = this,
			idx = pbar.items.indexOf(pbar.child("#inputItem")),
			slider, page_size;

		Ext.each(pbar.items.getRange(idx - 2, idx + 2), function(c){
			c.hide();
		});

		slider = Ext.create('Ext.slider.Single', {
			width: 114,
			minValue: 1,
			maxValue: 1,
			hideLabel: true,
			tipText: function(thumb) {
				return Ext.String.format('Page <b>{0}</b> of <b>{1}</b>', thumb.value, thumb.slider.maxValue);
			},
			listeners: {
				changecomplete: function(s, v){
					pbar.store.loadPage(v);
				}
			}
		});

		page_size = Ext.create('Ext.form.field.ComboBox', {
			width: 120,
			value: pbar.pageSize,
			editable: false,
			fieldLabel: 'Page Size',
			labelWidth: 55,
			labelAlign: 'right',
			store: [
				10,25,50,100,500,1000,2000,4000
			],
			listeners: {
				select: function(c){
					pbar.pageSize = c.getValue();
					pbar.store.pageSize = c.getValue();
					pbar.store.loadPage(1);
				}
			}
		});

		pbar.insert(idx + 1, slider);
		pbar.insert(idx + 6, page_size);

		pbar.on({
			change: function(pb, data){
				slider.setMaxValue(data ? data.pageCount : 1);
				slider.setValue(data ? data.currentPage : 1);
			}
		});
	}

});
Ext.define('App.ux.combo.ActiveInsurances', {
	extend: 'Ext.form.ComboBox',
	xtype: 'activeinsurancescombo',
	editable: false,
	displayField: 'option_name',
	valueField: 'option_value',
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		// *************************************************************************************
		// Structure, data for Insurance Payer Types
		// AJAX -> component_data.ejs.php
		// *************************************************************************************

		Ext.define('ActiveInsurancesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'option_name',
					type: 'string'
				},
				{
					name: 'option_value',
					type: 'int'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getActiveInsurances'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ActiveInsurancesComboModel',
			autoLoad: true
		});

		me.callParent();
	}
}); 
Ext.define('App.ux.combo.AclPermissions', {
	extend: 'Ext.form.ComboBox',
	xtype: 'aclpermissions',
	typeAhead: true,
	typeAheadDelay: 50,
	queryMode: 'local',
	displayField: 'display_text',
	valueField: 'perm_key',
	emptyText: _('acl_permission'),
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{name: 'perm_key', type: 'string'},
				{name: 'perm_name', type: 'string'},
				{name: 'perm_cat', type: 'string'},
				{
					name: 'display_text',
					type: 'string',
					convert: function (v,r){
						return Ext.String.format('{0}: {1}', r.get('perm_cat'), r.get('perm_name'));
					}
				}
			],
			sorters: [
				{
					property: 'perm_cat',
					direction: 'ASC'
				},
				{
					property: 'perm_name',
					direction: 'ASC'
				}
			],
			remoteSort: true,
			pageSize: 2000,
			autoLoad: true,
			proxy: {
				type: 'direct',
				api: {
					read: 'ACL.getAclPermissions'
				},
				reader: {
					type: 'json'
				}
			},
			listeners: {
				load: function () {
					this.insert(0, [{perm_key: '*', perm_name: 'No Restriction', perm_cat: 'NONE' }]);
				}
			}
		});

		me.callParent(arguments);
	}
});

// Currently has the following issues:
// - Does not handle postEditValue
// - Fields without editors need to sync with their values in Store
// - starting to edit another record while already editing and dirty should probably prevent it
// - aggregating validation messages
// - tabIndex is not managed bc we leave elements in dom, and simply move via positioning
// - layout issues when changing sizes/width while hidden (layout bug)

/**
 * @class Ext.grid.RowEditor
 * @extends Ext.form.Panel
 *
 * Internal utility class used to provide row editing functionality. For developers, they should use
 * the RowEditing plugin to use this functionality with a grid.
 *
 * @ignore
 */
Ext.define('App.ux.grid.RowFormEditor', {
	extend: 'Ext.form.Panel',
	requires: [
		'Ext.tip.ToolTip',
		'Ext.util.HashMap',
		'Ext.util.KeyNav'
	],

	saveBtnText  : 'Update',
	cancelBtnText: 'Cancel',
	removeBtnText: 'Remove',
	errorsText: 'Errors',
	dirtyText: 'Commit Cancel Your Changes',

	lastScrollLeft: 0,
	lastScrollTop: 0,
	bodyPadding: 5,
	padding:'0 0 5 0',
	border: false,
	saveBtnEnabled:false,
	buttonAlign:'center',
	// Change the hideMode to offsets so that we get accurate measurements when
	// the roweditor is hidden for laying out things like a TriggerField.
	hideMode: 'offsets',
	errorSummary: false,

	style:'background-color:#E0E0E0',

	initComponent: function () {
		var me = this,
			form, plugin;

		me.cls = Ext.baseCSSPrefix + 'grid-row-editor grid-row-form-editor';
		me.currRowH = null;
		plugin = me.editingPlugin;
		me.items = plugin.items;
		me.fieldDefaults = plugin.fieldDefaults;

		var buttons = [{
			action: 'update',
			xtype: 'button',
			itemId: 'update',
			handler: plugin.completeEdit,
			scope: plugin,
			text: me.saveBtnText,
			disabled: !me.isValid
		},
			{
				xtype: 'button',
				itemId: 'cancel',
				handler: plugin.cancelEdit,
				scope: plugin,
				text: me.cancelBtnText
			}];
		if (plugin.enableRemove) {
			buttons.push({
				xtype: 'button',
				itemId: 'remove',
				handler: plugin.completeRemove,
				scope: plugin,
				text: me.removeBtnText
			});
		}

		me.dockedItems = [{
			xtype: 'toolbar',
			dock: 'bottom',
			ui: 'footer',
			margin: 0,
			layout:{
				pack: 'center'
			},
			cls: 'x-grid-row-editor x-panel-body',
			style:'border-top:none !important',
			defaults: {
				minWidth: Ext.panel.Panel.prototype.minButtonWidth
			},
			items: buttons
		}];

		me.callParent(arguments);
		form = me.getForm();
		me.setFields();
		form.trackResetOnLoad = true;
		me.floatingButtons = me.getDockedItems('toolbar[dock="bottom"]')[0];
	},

	onFieldValueChange: function() {
		var me = this,
			form = me.getForm(),
			valid = form.isValid(), btn;

		if (me.errorSummary && me.isVisible()) {
			me[valid ? 'hideToolTip' : 'showToolTip']();
		}

		btn = me.query('button[action="update"]')[0];
		if (btn){
			btn.setDisabled(!valid);
		}
		me.isValid = valid;
	},

	afterRender: function() {
		var me = this,
			plugin = me.editingPlugin,
			grid = plugin.grid,
			view = grid.lockable ? grid.normalGrid.view : grid.view;

		me.callParent(arguments);


		me.scrollingView = view;
		me.scrollingViewEl = view.el;
		me.mon(me.renderTo, 'scroll', me.onCtScroll, me, { buffer: 100 });

		// Prevent from bubbling click events to the grid view
		me.mon(me.el, {
			click: Ext.emptyFn,
			stopPropagation: true
		});

		me.el.swallowEvent([
			'keypress',
			'keydown'
		]);

		me.keyNav = new Ext.util.KeyNav(me.el, {
			//enter: plugin.completeEdit,
			esc: plugin.onEscKey,
			scope: plugin
		});

		me.mon(plugin.view, {
			beforerefresh: me.onBeforeViewRefresh,
			refresh: me.onViewRefresh,
			scope: me
		});
	},

	onBeforeViewRefresh: function(view) {
		var me = this,
			viewDom = view.el.dom;

		if (me.el.dom.parentNode === viewDom) {
			viewDom.removeChild(me.el.dom);
		}
	},

	onViewRefresh: function(view) {
		var me = this,
			viewDom = view.el.dom,
			context = me.context,
			idx;

		viewDom.appendChild(me.el.dom);

		// Recover our row node after a view refresh
		if (context && (idx = context.store.indexOf(context.record)) >= 0) {
			context.row = view.getNode(idx);
			me.reposition();
			if (me.tooltip && me.tooltip.isVisible()) {
				me.tooltip.setTarget(context.row);
			}
		} else {
			me.editingPlugin.cancelEdit();
		}
	},

	onCtScroll: function(e, target) {
		var me = this,
			scrollTop  = target.scrollTop,
			scrollLeft = target.scrollLeft;

		if (scrollTop !== me.lastScrollTop) {
			me.lastScrollTop = scrollTop;
			if ((me.tooltip && me.tooltip.isVisible()) || me.hiddenTip) {
				me.repositionTip();
			}
		}
		if (scrollLeft !== me.lastScrollLeft) {
			me.lastScrollLeft = scrollLeft;
			me.reposition();
		}
	},

	reposition: function (animateConfig) {

		if(this.currRowH) this.currRow.setHeight(this.currRowH);

		var me = this,
			context = me.context,
			row = context && Ext.get(context.row),
		//btns = me.getFloatingButtons(),
		//btnEl = btns.el,
			grid = me.editingPlugin.grid,
			viewEl = grid.view.el,
			scroller = grid.verticalScroller,


		// always get data from ColumnModel as its what drives
		// the GridView's sizing
			mainBodyWidth = grid.headerCt.getFullWidth(),
			scrollerWidth = grid.getWidth(),

		// use the minimum as the columns may not fill up the entire grid
		// width
			width = Math.min(mainBodyWidth, scrollerWidth),
			scrollLeft = grid.view.el.dom.scrollLeft,
		//btnWidth = btns.getWidth(),
		//left = (width - btnWidth) / 2 + scrollLeft,
			y, rowH, newHeight,

			invalidateScroller = function() {
				if (scroller) {
					scroller.invalidate();
					btnEl.scrollIntoView(viewEl, false);
				}
				if (animateConfig && animateConfig.callback) {
					animateConfig.callback.call(animateConfig.scope || me);
				}
			};

		// need to set both top/left
		if (row && Ext.isElement(row.dom)) {
			// Bring our row into view if necessary, so a row editor that's already
			// visible and animated to the row will appear smooth
			row.scrollIntoView(viewEl, false);

			// Get the y position of the row relative to its top-most static parent.
			// offsetTop will be relative to the table, and is incorrect
			// when mixed with certain grid features (e.g., grouping).
			y = row.getXY()[1] + 19;


			me.currRowH = row.getHeight();
			me.currRow = row;

			row.setHeight(me.getHeight() + 19);

			// IE doesn't set the height quite right.
			// This isn't a border-box issue, it even happens
			// in IE8 and IE7 quirks.
			// TODO: Test in IE9!
			if (Ext.isIE) {
				newHeight += 2;
			}

			if (animateConfig) {
				var animObj = {
					to: {
						y: y
					},
					duration: animateConfig.duration || 125,
					listeners: {
						afteranimate: function() {
							invalidateScroller();
							y = row.getXY()[1] + 19;
							me.el.setY(y);
						}
					}
				};
				me.animate(animObj);
			} else {
				me.el.setY(y);
				invalidateScroller();
			}
		}
		if (me.getWidth() != mainBodyWidth) {
			me.setWidth(mainBodyWidth);
		}
		//btnEl.setLeft(left);
	},

	resizeEditor:function(){

		if(this.currRowH) this.currRow.setHeight(this.currRowH);

		var me = this,
			context = me.context,
			row = context && Ext.get(context.row),
		//btns = me.getFloatingButtons(),
		//btnEl = btns.el,
			grid = me.editingPlugin.grid,
			viewEl = grid.view.el,
			scroller = grid.verticalScroller,


		// always get data from ColumnModel as its what drives
		// the GridView's sizing
			mainBodyWidth = grid.headerCt.getFullWidth(),
			scrollerWidth = grid.getWidth(),

		// use the minimum as the columns may not fill up the entire grid
		// width
			width = Math.min(mainBodyWidth, scrollerWidth),
			scrollLeft = grid.view.el.dom.scrollLeft,
		//btnWidth = btns.getWidth(),
		//left = (width - btnWidth) / 2 + scrollLeft,
			y, rowH, newHeight;


		// need to set both top/left
		if (row && Ext.isElement(row.dom)) {
			// Bring our row into view if necessary, so a row editor that's already
			// visible and animated to the row will appear smooth
			row.scrollIntoView(viewEl, false);

			// Get the y position of the row relative to its top-most static parent.
			// offsetTop will be relative to the table, and is incorrect
			// when mixed with certain grid features (e.g., grouping).
			y = row.getXY()[1] + 19;


			me.currRowH = row.getHeight();
			me.currRow = row;

			row.setHeight(me.getHeight() + 19);

			// IE doesn't set the height quite right.
			// This isn't a border-box issue, it even happens
			// in IE8 and IE7 quirks.
			// TODO: Test in IE9!
			if (Ext.isIE) {
				newHeight += 2;
			}

		}
		if (me.getWidth() != mainBodyWidth) {
			me.setWidth(mainBodyWidth);
		}
	},

	getGridStores:function(){
		var me = this,
			grids = me.query('grid'),
			stores = [];
		for(var i=0; i < grids.length; i++){
			stores.push(grids[i].store);
		}
		return stores;
	},

	syncChildStoresChanges:function(){
		var me = this,
			stores = me.getGridStores();
		for(var i=0; i < stores.length; i++){
			stores[i].sync();
		}
	},

	rejectChildStoresChanges:function(){
		var me = this,
			stores = me.getGridStores();
		for(var i=0; i < stores.length; i++){
			stores[i].rejectChanges();
		}
	},

	getEditor: function(fieldInfo) {
		var me = this;

		if (Ext.isNumber(fieldInfo)) {
			// Query only form fields. This just future-proofs us in case we add
			// other components to RowEditor later on.  Don't want to mess with
			// indices.
			return me.query('>[isFormField]')[fieldInfo];
		} else if (fieldInfo instanceof Ext.grid.column.Column) {
			return fieldInfo.getEditor();
		}
		return false;
	},

	setFields: function(column) {
		var me = this,
			form = me.getForm(),
			fields = form.getFields().items,
			containers = me.query('container');

        for(var i=0; i < fields.length; i++){
            me.mon(fields[i], 'change', me.onFieldValueChange, me);
        }
        for(var k=0; k < containers.length; k++){
            me.mon(containers[k], 'resize', me.resizeEditor, me);
        }
	},

	loadRecord: function(record) {
		var me = this,
			form = me.getForm(),
			updateBtn = me.query('button[action="update"]')[0],
			saveTxt = record.phantom ? 'Save' : 'Update';

		me.editingPlugin.fireEvent('beforerecordload', me, record);

		form.loadRecord(record);

		me.editingPlugin.fireEvent('recordload', me, record);

		// change the save btn text to update is the record is a phantom (new)
		updateBtn.setText(saveTxt);

		if(me.saveBtnEnabled) updateBtn.setDisabled(!me.saveBtnEnabled);

		if(this.errorSummary){
			if (form.isValid()) {
				me.hideToolTip();
			} else {
				me.showToolTip();
			}
		}
		// render display fields so they honor the column renderer/template
		Ext.Array.forEach(me.query('>displayfield'), function(field) {
			me.renderColumnData(field, record);
		}, me);
	},

	renderColumnData: function(field, record) {
		var me = this,
			grid = me.editingPlugin.grid,
			headerCt = grid.headerCt,
			view = grid.view,
			store = view.store,
			form = me.getForm();

		form.loadRecord(record);
	},

	beforeEdit: function() {
		var me = this;

		me.getGridStores();

		if (me.isVisible() && !me.autoCancel && me.isDirty()) {
			me.showToolTip();
			return false;
		}
	},

	/**
	 * Start editing the specified grid at the specified position.
	 * @param {Ext.data.Model} record The Store data record which backs the row to be edited.
	 * @param {Ext.data.Model} columnHeader The Column object defining the column to be edited.
	 */
	startEdit: function(record, columnHeader) {
		var me = this,
			grid = me.editingPlugin.grid,
			view = grid.getView(),
			store = grid.store,
			context = me.context = Ext.apply(me.editingPlugin.context, {
				view: grid.getView(),
				store: store
			});

//		make sure our row is selected before editing
		context.grid.getSelectionModel().select(record);

		// Reload the record data
		me.loadRecord(record);

		if (!me.isVisible()) {
			me.show();
			me.focusContextCell();
		} else {
			me.reposition({
				callback: this.focusContextCell
			});
		}
	},

	// Focus the cell on start edit based upon the current context
	focusContextCell: function() {
		var field = this.getEditor(this.context.colIdx);
		if (field && field.focus) {
			field.focus();
		}
	},

	cancelEdit: function() {
		var me = this,
			form = me.getForm();
		me.rejectChildStoresChanges();
		me.hide();
		form.clearInvalid();
		form.reset();
	},

	completeEdit: function() {
		var me = this,
			form = me.getForm();

		if (!form.isValid()) {
			return;
		}

		me.context.record.set(me.context.newValues);

		if(me.editingPlugin.autoSync){
			me.context.record.store.sync({
				callback:function(){
					me.fireEvent('sync', me, me.context);
				}
			});
		}
		me.syncChildStoresChanges();
		me.hide();
		return true;
	},

	completeRemove:function(){
		var me = this,
			form = me.getForm(),
			view = me.context.view,
			store = me.context.store,
			record = view.getSelectionModel().getLastSelected();
		if(view.panel.fireEvent('beforeremove', me, store, record)){
			Ext.Msg.show({
				title:'WAIT!!!',
				msg: 'Are you sure you want to remove this record?',
				buttons: Ext.Msg.YESNO,
				icon: Ext.Msg.QUESTION,
				scope:me,
				fn: function(btn){
					if (btn == 'yes'){
						if(record.parentNode){
							record.parentNode.removeChild(record);
						}else{
							store.remove(record);
						}
						view.panel.fireEvent('remove', me, store, record);
						me.hide();
						form.clearInvalid();
						form.reset();
						if(me.editingPlugin.autoSync){
							store.sync({
								callback:function(){
									me.fireEvent('sync', me, me.context);
								}
							});
						}
					}
				}
			});
		}
	},

	onShow: function() {
		var me = this;
		me.callParent(arguments);
		me.reposition();
	},

	onHide: function() {
		var me = this;
		me.callParent(arguments);
		me.hideToolTip();
		me.invalidateScroller();
		if (me.context) {
			me.context.view.focus();
			me.context = null;
		}
		me.currRow.setHeight(me.currRowH);
		me.currRowH = null;
	},

	isDirty: function() {
		var me = this,
			form = me.getForm();
		return form.isDirty();
	},

	getToolTip: function() {
		return this.tooltip || (this.tooltip = new Ext.tip.ToolTip({
			cls: Ext.baseCSSPrefix + 'grid-row-editor-errors',
			title: this.errorsText,
			autoHide: false,
			closable: true,
			closeAction: 'disable',
			anchor: 'left',
			anchorToTarget: false
		}));
	},

	hideToolTip: function() {
		var me = this,
			tip = me.getToolTip();
		if (tip.rendered) {
			tip.disable();
		}
		me.hiddenTip = false;
	},

	showToolTip: function() {
		var me = this,
			tip = me.getToolTip();

		tip.showAt([0, 0]);
		tip.update(me.getErrors());
		me.repositionTip();
		tip.enable();
	},

	repositionTip: function() {
		var me = this,
			tip = me.getToolTip(),
			context = me.context,
			row = Ext.get(context.row),
			viewEl = me.scrollingViewEl,
			viewHeight = viewEl.dom.clientHeight,
			viewTop = me.lastScrollTop,
			viewBottom = viewTop + viewHeight,
			rowHeight = row.getHeight(),
			rowTop = row.getOffsetsTo(me.context.view.body)[1],
			rowBottom = rowTop + rowHeight;

		if (rowBottom > viewTop && rowTop < viewBottom) {
			tip.showAt(tip.getAlignToXY(viewEl, 'tl-tr', [15, row.getOffsetsTo(viewEl)[1]]));
			me.hiddenTip = false;
		} else {
			tip.hide();
			me.hiddenTip = true;
		}
	},

	getErrors: function() {
		var me        = this,
			errors    = [],
			fields    = me.query('[isFormField]'),
			length    = fields.length,
			i;

		for (i = 0; i < length; i++) {
			errors = errors.concat(
				Ext.Array.map(fields[i].getErrors(), me.createErrorListItem)
			);
		}

		// Only complain about unsaved changes if all the fields are valid
		if (!errors.length && !me.autoCancel && me.isDirty()) {
			errors[0] = me.createErrorListItem(me.dirtyText);
		}

		return '<ul class="' + Ext.plainListCls + '">' + errors.join('') + '</ul>';
	},

	createErrorListItem: function(e) {
		return '<li class="' + Ext.baseCSSPrefix + 'grid-row-editor-errors-item">' + e + '</li>';
	},

	invalidateScroller: function() {
		var me = this,
			context = me.context,
			scroller = context.grid.verticalScroller;

		if (scroller) {
			scroller.invalidate();
		}
	}
});
Ext.define('App.ux.combo.AllergiesSeverity', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.allergiesseveritycombo',
	initComponent: function() {
		var me = this;

		Ext.define('allergiesseverityModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 84
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'allergiesseverityModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.AllergiesAbdominal',{
		extend: 'Ext.form.ComboBox',
		alias: 'widget.mitos.allergiesabdominalcombo',
		initComponent: function(){
			var me = this;

			Ext.define('allergiesabdominalModel',{
				extend: 'Ext.data.Model',
				fields: [
					{
						name: 'option_name',
						type: 'string'
					},
					{
						name: 'option_value',
						type: 'string'
					}
				],
				proxy: {
					type: 'direct',
					api: {
						read: 'CombosData.getOptionsByListId'
					}
				}
			});
            
			Ext.apply(this,{
				editable: false,
				queryMode: 'local',
				displayField: 'option_name',
				valueField: 'option_value',
				emptyText: _('select'),
				store: Ext.create('Ext.data.Store',{
					model: 'allergiesabdominalModel',
					autoLoad: false
				})
			});
			me.callParent(arguments);
		}
	});
Ext.define('App.ux.combo.ActiveProviders', {
	extend: 'Ext.form.ComboBox',
	xtype: 'activeproviderscombo',
	displayField: 'option_name',
	valueField: 'option_value',
	editable: false,
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		Ext.define('ActiveProvidersModel' + this.id, {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'fullname',
					type: 'string',
					convert: function(v, record){
						return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
					}
				},
				{
					name: 'option_name',
					type: 'string',
					convert: function(v, record){
						return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
					}
				},
				{
					name: 'option_value',
					type: 'int',
					convert: function(v, record){
						return record.data.id;
					}
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'User.getActiveProviders'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ActiveProvidersModel' + this.id,
			autoLoad: true
		});

		me.callParent(arguments);
	}
}); 
Ext.define('App.ux.combo.AllergiesMetals', {
	extend: 'Ext.form.ComboBox',
	xtype: 'allergiesmetalcombo',
	editable: false,
	queryMode: 'local',
	displayField: 'Term',
	valueField: 'ConceptId',
	emptyText: _('select'),
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: true,
			fields: [
				{ name: 'ConceptId', type: 'string' },
				{ name: 'Term', type: 'string' },
				{ name: 'CodeType', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'SnomedCodes.getMetalAllergiesCodes'
				}
			}
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Allergies',
{
	extend : 'Ext.form.ComboBox',
	alias : 'widget.mitos.allergiescombo',
	initComponent : function()
	{
		var me = this;

		Ext.define('AllergiesComboModel',
		{
			extend : 'Ext.data.Model',
			fields : [
			{
				name : 'id',
				type : 'int'
			},
			{
				name : 'allergy_name'
			},
			{
				name : 'allergy_type',
				type : 'string'
			}],
			proxy :
			{
				type : 'direct',
				api :
				{
					read : CombosData.getAllergiesByType
				}
			}
		});

		me.store = Ext.create('Ext.data.Store',
		{
			model : 'AllergiesComboModel',
			autoLoad : false
		});

		Ext.apply(this,
		{
			editable : false,
			queryMode : 'local',
			displayField : 'allergy_name',
			valueField : 'allergy_name',
			emptyText : _('select'),
			store : me.store
		}, null);
		me.callParent(arguments);
	}
}); 
Ext.define('App.ux.combo.AllergiesLocation', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.allergieslocationcombo',
	initComponent: function() {
		var me = this;

		Ext.define('allergieslocationModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 79
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'allergieslocationModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.CalendarCategories', {
	extend      : 'Ext.form.ComboBox',
	alias       : 'widget.mitos.calcategoriescombobox',
	editable    : false,
	displayField: 'catname',
	valueField  : 'catid',
	emptyText   : _('select'),

	initComponent: function() {
		var me = this;

		Ext.define('CalendarCategoriesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'catid', type: 'int'},
				{name: 'catname', type: 'string'}
			],
			idProperty: 'catid',
			proxy : {
				type: 'direct',
				api : {
					read: CombosData.getCalendarCategories
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'CalendarCategoriesModel',
			autoLoad: true
		});


		Ext.apply(this, {
			store: me.store
		}, null);
		me.callParent();
	}
}); 
Ext.define('App.ux.combo.CodesTypes', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.codestypescombo',
	initComponent: function(){
		var me = this;

		Ext.define('CodesTypesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 56
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'CodesTypesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			valueField: 'option_value',
			displayField: 'option_name',
			emptyText: _('select'),
			store: me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Authorizations',
{
	extend : 'Ext.form.ComboBox',
	alias : 'widget.mitos.authorizationscombo',
	initComponent : function()
	{
		var me = this;

		Ext.define('AuthorizationsModel',
		{
			extend : 'Ext.data.Model',
			fields : [
			{
				name : 'id',
				type : 'int'
			},
			{
				name : 'name',
				type : 'string'
			}],
			proxy :
			{
				type : 'direct',
				api :
				{
					read : CombosData.getAuthorizations
				}
			}
		});

		me.store = Ext.create('Ext.data.Store',
		{
			model : 'AuthorizationsModel',
			autoLoad : true
		});

		Ext.apply(this,
		{
			editable : false,
			queryMode : 'local',
			valueField : 'id',
			displayField : 'name',
			emptyText : _('select'),
			store : me.store
		}, null);

		me.callParent(arguments);
	}
}); 
Ext.define('App.ux.combo.AllergiesTypes', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.allergiestypescombo',
	initComponent: function(){
		var me = this;

		Ext.define('AllergiesTypesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'allergy_type', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getAllergyTypes'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'AllergiesTypesComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable: false,
			//queryMode   : 'local',
			displayField: 'allergy_type',
			valueField: 'allergy_type',
			emptyText: _('select'),
			store: me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.BillingFacilities', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.billingfacilitiescombo',
	initComponent: function() {
		var me = this;

		Ext.define('BillingFacilitiesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'int' }
			],
			proxy : {
				type: 'direct',
				api : {
					read: 'CombosData.getBillingFacilities'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'BillingFacilitiesComboModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			valueField  : 'option_value',
			displayField: 'option_name',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.CalendarStatus', {
	extend: 'Ext.form.ComboBox',
	alias : 'widget.mitos.calstatuscombobox',
	name  : 'status',

	initComponent: function() {
		var me = this;

		Ext.define('CalendarStatusModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 30
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'CalendarStatusModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent();
	} // end initComponent
}); 
Ext.define('App.ux.combo.ComboOptionListSimple', {
    extend: 'Ext.form.ComboBox',
    alias: 'widget.gaiaehr.listcombosimple',
    displayField: 'option_name',
    valueField: 'option_value',
    emptyText: _('select'),
    forceSelection: false,
    editable: false,

    /**
     * List ID
     */
    list: null,

    /**
     * List Key
     */
    list_key: null,

    /**
     * Auto Load Store
     */
    loadStore: true,
    /**
     * value data type
     */
    valueDataType: 'string',


    initComponent: function () {
        var me = this,
            model = me.id + 'ComboOptionModel';

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'option_name',
                    type: 'string'
                },
                {
                    name: 'option_value',
                    type: me.valueDataType
                }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: me.list,
                    list_key: me.list_key
                }
            },
            idProperty: 'option_value'
        });

        me.store = Ext.create('Ext.data.Store', {
            model: model,
            autoLoad: me.loadStore
        });

        me.callParent(arguments);

    }
});

Ext.define('App.ux.combo.EncounterICDS', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.encountericdscombo',
	initComponent: function(){
		var me = this;

		Ext.define('EncounterICDXComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'code',
					type: 'string'
				},
				{
					name: 'code_type',
					type: 'string'
				},
				{
					name: 'short_desc',
					type: 'string'
				},
				{
					name: 'code_and_code_type',
					type: 'string',
					convert: function(v, record){
						return record.data.code_type + ':' + record.data.code;
					}
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Encounter.getEncounterDxs'
				}
			}
		});

		Ext.apply(this, {
			queryMode: 'local',
			editable: false,
			multiSelect: true,
			displayField: 'code_and_code_type',
			valueField: 'code_and_code_type',
			emptyText: _('select'),
			store: Ext.create('Ext.data.Store', {
				model: 'EncounterICDXComboModel',
				autoLoad: false
			}),
			listConfig: {
				getInnerTpl: function(){
					return '<span style="font-weight:bold">{code}</span> - {short_desc}</div>';
				}
			}
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.CVXManufacturers', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.cvxmanufacturerscombo',
	initComponent: function() {
		var me = this;

		Ext.define('CVXManufacturersComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'mvx_code', type: 'string'},
				{name: 'manufacturer', type: 'string'}
			],
			proxy : {
				type: 'direct',
				api : {
					read: Immunizations.getMvx
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'CVXManufacturersComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable    : false,
			valueField  : 'mvx_code',
			displayField: 'manufacturer',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.CVXManufacturersForCvx', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.cvxmanufacturersforcvxcombo',

	initComponent: function(){
		var me = this;

		Ext.define('CVXManufacturersForCvxComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'mvx_code', type: 'string'},
				{name: 'manufacturer', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Immunizations.getMvxForCvx'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'CVXManufacturersForCvxComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			queryMode: 'local',
			valueField: 'mvx_code',
			displayField: 'manufacturer',
			emptyText: _('select'),
			store: me.store
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.ComboOptionList', {
    extend: 'Ext.form.ComboBox',
    alias: 'widget.gaiaehr.listcombo',
    displayField: 'option_value',
    valueField: 'option_value',
    emptyText: _('select'),
    forceSelection: false,
    editable: false,

	/**
	 * List by Key
	 */
	listKey: null,

    /**
     * List ID
     */
    list: null,
    /**
     * Auto Load Store
     */
    loadStore: false,
    /**
     * value data type
     */
    valueDataType: 'string',


    initComponent: function () {
        var me = this,
            model = me.id + 'ComboOptionModel';

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'option_name',
                    type: 'string'
                },
                {
                    name: 'option_value',
                    type: me.valueDataType
                },
                {
                    name: 'code',
                    type: 'string'
                },
                {
                    name: 'code_type',
                    type: 'string'
                },
                {
                    name: 'color',
                    type: 'string'
                },
                {
                    name: 'extraListClass',
                    type: 'string'
                }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: me.list,
	                list_key: me.listKey
                }
            },
            idProperty: 'option_value'
        });

        me.store = Ext.create('Ext.data.Store', {
            model: model,
            autoLoad: me.loadStore
        });

        me.listConfig = {
            itemTpl: new Ext.XTemplate(
                '<tpl>' +
                '   <div style="white-space: nowrap;">{option_value} (<span style="font-weight: bold;">{option_name}</span>)</div>',
                '</tpl>'
            )
        };

        me.callParent(arguments);

    }
});

Ext.define('App.ux.combo.Combo', {
    extend: 'Ext.form.ComboBox',
    alias: 'widget.gaiaehr.combo',
    displayField: 'option_name',
    valueField: 'option_value',
    emptyText: _('select'),
    forceSelection: false,
	editable: true,

	/**
	 * List by Key
	 */
	listKey: null,
    /**
     * List ID
     */
    list: null,
    /**
     * Auto Load Store
     */
    loadStore: false,
    /**
     * value data type
     */
    valueDataType: 'string',
	/**
     *
	 */
	resetable: false,

	addUnknownOption: false,


    initComponent: function () {
        var me = this,
            model = me.id + 'ComboModel';

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'option_name',
                    type: 'string'
                },
                {
                    name: 'option_value',
                    type: me.valueDataType
                },
                {
                    name: 'code',
                    type: 'string'
                },
                {
                    name: 'code_type',
                    type: 'string'
                },
                {
                    name: 'color',
                    type: 'string'
                },
                {
                    name: 'extraListClass',
                    type: 'string'
                },
                {
                    name: 'bg_color',
                    type: 'string',
                    convert: function (v, record) {
                        if (record.data.code_type == 'bgcolor') {
                            var bg_color = record ? record.data.code : '#FFFFFF';
                            record.set({color: me.getContrastYIQ(bg_color), extraListClass: 'listwith'});
                            return bg_color;
                        }
                    }

                }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: me.list,
	                list_key: me.listKey
                }
            },
            idProperty: 'option_value'
        });

        me.store = Ext.create('Ext.data.Store', {
            model: model,
            autoLoad: me.loadStore
        });

	    me.store.on('load', function (store, records) {

	    	if(me.addUnknownOption){
			    store.insert(0, {
				    bg_color: undefined,
				    code: "UNK",
				    code_type: "UNK",
				    color: "",
				    extraListClass: "",
				    option_name: "UNKNOWN",
				    option_value: "UNK"
			    });
		    }

            me.fireEvent('load', me, store, records)
	    });

        me.listConfig = {
            itemTpl: new Ext.XTemplate(
                '<tpl if="this.hasColorBg(code_type)">' +
                '   <div class="combo-list-icon" style="background-color:{bg_color}">&#160;</div>{option_name}',
                '<tpl else>' +
                '   {option_name}',
                '</tpl>',
                {
                    hasColorBg: function (code_type) {
                        return code_type == 'bgcolor';
                    }
                }
            )
        };

        if(me.resetable){
	        me.trigger1Class = 'x-form-select-trigger';
            me.trigger2Class = 'x-form-clear-trigger';
        }

        me.callParent(arguments);

        me.on('change', function (cmb, value) {
            me.setFieldBgColor(cmb, value);
        });
    },

	onRender: function(ct, position){
		this.callParent(arguments);

		if(!this.resetable) return;

		var id = this.getId();
		this.triggerConfig = {
			tag: 'div',
			cls: 'x-form-twin-triggers',
			style: 'display:block;',
			cn: [
				{
					tag: "img",
					style: Ext.isIE ? 'margin-left:0;height:21px' : '',
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					cls: "x-form-trigger " + this.trigger2Class
				}
			]
		};
		this.triggerEl.replaceWith(this.triggerConfig);

		this.triggerEl.on('mouseup', function(e){
			if(e.target.name == "trigger2" + id){
				this.reset();
				// this.oldValue = null;
				// if(this.spObj !== '' && this.spExtraParam !== ''){
				// 	Ext.getCmp(this.spObj).store.setExtraParam(this.spExtraParam, '');
				// 	Ext.getCmp(this.spObj).store.load()
				// }
				// if(this.spForm !== ''){
				// 	Ext.getCmp(this.spForm).getForm().reset();
				// }
				this.fireEvent('fieldreset', this);
			}

		}, this);

		var trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	},

    setFieldBgColor: function (cmb, value) {

        var me = this;

        if(value == null) return;

        Ext.Function.defer(function () {

            var store = cmb.getStore();

            if(!store) return;

            var record = cmb.findRecordByValue(value);

            if (store.isLoading()) {
                cmb.tries = cmb.tries ? cmb.tries + 1 : 1;
                if (cmb.tries > 2) return;

                Ext.Function.defer(function () {
                    me.setFieldBgColor(cmb, value);
                }, 1000);
            } else {
                if (record !== false && record.data.code_type == 'bgcolor') {
                    cmb.inputEl.setStyle({
                        'background-color': record.data.bg_color,
                        'background-image': 'none',
                        'color': record.data.color
                    });
                } else {
                    cmb.tries = cmb.tries ? cmb.tries + 1 : 1;
                    if (cmb.tries > 2) return;

                    Ext.Function.defer(function () {
                        me.setFieldBgColor(cmb, value);
                    }, 1000);
                }
            }
        }, 100);
    },

    getContrastYIQ: function (hexcolor) {
        if (hexcolor[0] != '#') {
            hexcolor = this.getHexColor(hexcolor);
        }
        hexcolor = hexcolor.replace('#', '');

        var r = parseInt(hexcolor.substr(0, 2), 16);
        var g = parseInt(hexcolor.substr(2, 2), 16);
        var b = parseInt(hexcolor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 129) ? 'black' : 'white';
    },

    getHexColor: function (n) {
        n = n.toLowerCase();
        var nar = {
                "aliceblue": "#f0f8ff",
                "antiquewhite": "#faebd7",
                "aqua": "#00ffff",
                "aquamarine": "#7fffd4",
                "azure": "#f0ffff",
                "beige": "#f5f5dc",
                "bisque": "#ffe4c4",
                "black": "#000000",
                "blanchedalmond": "#ffebcd",
                "blue": "#0000ff",
                "blueviolet": "#8a2be2",
                "brown": "#a52a2a",
                "burlywood": "#deb887",
                "cadetblue": "#5f9ea0",
                "chartreuse": "#7fff00",
                "chocolate": "#d2691e",
                "coral": "#ff7f50",
                "cornflowerblue": "#6495ed",
                "cornsilk": "#fff8dc",
                "crimson": "#dc143c",
                "cyan": "#00ffff",
                "darkblue": "#00008b",
                "darkcyan": "#008b8b",
                "darkgoldenrod": "#b8860b",
                "darkgray": "#a9a9a9",
                "darkgrey": "#a9a9a9",
                "darkgreen": "#006400",
                "darkkhaki": "#bdb76b",
                "darkmagenta": "#8b008b",
                "darkolivegreen": "#556b2f",
                "darkorange": "#ff8c00",
                "darkorchid": "#9932cc",
                "darkred": "#8b0000",
                "darksalmon": "#e9967a",
                "darkseagreen": "#8fbc8f",
                "darkslateblue": "#483d8b",
                "darkslategray": "#2f4f4f",
                "darkslategrey": "#2f4f4f",
                "darkturquoise": "#00ced1",
                "darkviolet": "#9400d3",
                "deeppink": "#ff1493",
                "deepskyblue": "#00bfff",
                "dimgray": "#696969",
                "dimgrey": "#696969",
                "dodgerblue": "#1e90ff",
                "firebrick": "#b22222",
                "floralwhite": "#fffaf0",
                "forestgreen": "#228b22",
                "fuchsia": "#ff00ff",
                "gainsboro": "#dcdcdc",
                "ghostwhite": "#f8f8ff",
                "gold": "#ffd700",
                "goldenrod": "#daa520",
                "gray": "#808080",
                "grey": "#808080",
                "green": "#008000",
                "greenyellow": "#adff2f",
                "honeydew": "#f0fff0",
                "hotpink": "#ff69b4",
                "indianred": "#cd5c5c",
                "indigo": "#4b0082",
                "ivory": "#fffff0",
                "khaki": "#f0e68c",
                "lavender": "#e6e6fa",
                "lavenderblush": "#fff0f5",
                "lawngreen": "#7cfc00",
                "lemonchiffon": "#fffacd",
                "lightblue": "#add8e6",
                "lightcoral": "#f08080",
                "lightcyan": "#e0ffff",
                "lightgoldenrodyellow": "#fafad2",
                "lightgray": "#d3d3d3",
                "lightgrey": "#d3d3d3",
                "lightgreen": "#90ee90",
                "lightpink": "#ffb6c1",
                "lightsalmon": "#ffa07a",
                "lightseagreen": "#20b2aa",
                "lightskyblue": "#87cefa",
                "lightslategray": "#778899",
                "lightslategrey": "#778899",
                "lightsteelblue": "#b0c4de",
                "lightyellow": "#ffffe0",
                "lime": "#00ff00",
                "limegreen": "#32cd32",
                "linen": "#faf0e6",
                "magenta": "#ff00ff",
                "maroon": "#800000",
                "mediumaquamarine": "#66cdaa",
                "mediumblue": "#0000cd",
                "mediumorchid": "#ba55d3",
                "mediumpurple": "#9370d8",
                "mediumseagreen": "#3cb371",
                "mediumslateblue": "#7b68ee",
                "mediumspringgreen": "#00fa9a",
                "mediumturquoise": "#48d1cc",
                "mediumvioletred": "#c71585",
                "midnightblue": "#191970",
                "mintcream": "#f5fffa",
                "mistyrose": "#ffe4e1",
                "moccasin": "#ffe4b5",
                "navajowhite": "#ffdead",
                "navy": "#000080",
                "oldlace": "#fdf5e6",
                "olive": "#808000",
                "olivedrab": "#6b8e23",
                "orange": "#ffa500",
                "orangered": "#ff4500",
                "orchid": "#da70d6",
                "palegoldenrod": "#eee8aa",
                "palegreen": "#98fb98",
                "paleturquoise": "#afeeee",
                "palevioletred": "#d87093",
                "papayawhip": "#ffefd5",
                "peachpuff": "#ffdab9",
                "peru": "#cd853f",
                "pink": "#ffc0cb",
                "plum": "#dda0dd",
                "powderblue": "#b0e0e6",
                "purple": "#800080",
                "red": "#ff0000",
                "rosybrown": "#bc8f8f",
                "royalblue": "#4169e1",
                "saddlebrown": "#8b4513",
                "salmon": "#fa8072",
                "sandybrown": "#f4a460",
                "seagreen": "#2e8b57",
                "seashell": "#fff5ee",
                "sienna": "#a0522d",
                "silver": "#c0c0c0",
                "skyblue": "#87ceeb",
                "slateblue": "#6a5acd",
                "slategray": "#708090",
                "slategrey": "#708090",
                "snow": "#fffafa",
                "springgreen": "#00ff7f",
                "steelblue": "#4682b4",
                "tan": "#d2b48c",
                "teal": "#008080",
                "thistle": "#d8bfd8",
                "tomato": "#ff6347",
                "turquoise": "#40e0d0",
                "violet": "#ee82ee",
                "wheat": "#f5deb3",
                "white": "#ffffff",
                "whitesmoke": "#f5f5f5",
                "yellow": "#ffff00",
                "yellowgreen": "#9acd32"
            },
            r = nar[n];
        if (r === undefined) {
            return "Invalid Color Name";
        }

        return r;
    }


});

Ext.define('App.ux.combo.FloorPlanAreas', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.floorplanareascombo',
	initComponent: function(){
		var me = this;

		Ext.define('FloorPlanAreasModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'title', type: 'string' },
				{name: 'id', type: 'int' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getFloorPlanAreas'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'FloorPlanAreasModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'title',
			valueField: 'id',
			emptyText: _('select'),
			store: me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Facilities', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.facilitiescombo',
	editable: false,
	queryMode: 'local',
	valueField: 'id',
	displayField: 'name',
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		Ext.define('FacilitiesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'id', type: 'int'},
				{name: 'name', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getFacilities'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'FacilitiesComboModel',
			autoLoad: true
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.FollowUp', {
    extend       : 'Ext.form.ComboBox',
    alias        : 'widget.mitos.followupcombo',
    initComponent: function() {
        var me = this;

        Ext.define('FollowUpModel', {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy : {
                type       : 'direct',
                api        : {
                    read: CombosData.getOptionsByListId
                },
                extraParams: {
                    list_id: 90
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model   : 'FollowUpModel',
            autoLoad: true
        });

        Ext.apply(this, {
            editable    : false,
            queryMode   : 'local',
            displayField: 'option_name',
            valueField  : 'option_value',
            emptyText   : _('select'),
            store       : me.store
        }, null);
        me.callParent(arguments);
    }
});

Ext.define('App.ux.combo.EncounterPriority', {
	extend: 'App.ux.combo.Combo',
	xtype: 'encounterprioritycombo',
	editable: false,
	queryMode: 'local',
	displayField: 'option_name',
	valueField: 'option_value',
	emptyText: _('priority'),
	list: 94,
	loadStore: true
});
Ext.define('App.ux.combo.Ethnicity', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.ethnicitycombo',
	tpl: Ext.create('Ext.XTemplate',
		'<tpl for=".">',
		'<div class="x-boundlist-item">{indent_index} <b>{code_description}</b> [{code}]</div>',
		'</tpl>'
	),
	typeAhead: true,
	typeAheadDelay: 50,
	queryMode: 'local',
	displayField: 'code_description',
	valueField: 'code',
	emptyText: _('ethnicity'),
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{name: 'code', type: 'string'},
				{name: 'code_type', type: 'string'},
				{name: 'code_description', type: 'string'},
				{
					name: 'indent_index',
					type: 'int',
					convert: function (v) {
						var str = '';
						while(v > 0){ str += '----'; v--; }
						return str.trim();
					}
				}
			],
			autoLoad: true,
			proxy: {
				type: 'ajax',
				url: 'resources/code_sets/HL7v3-Ethnicity.json',
				reader: {
					type: 'json'
				}
			},
			listeners: {
				load: function () {
					this.insert(0, [{code: 'ASKU', code_type: 'CDA', code_description: 'Declined to specify' }]);

				}
			}
		});

		me.callParent(arguments);
	}
});

Ext.define('App.ux.combo.Languages', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.languagescombo',
	editable: false,
	valueField: 'code',
	displayField: 'description',
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: false,
			fields: [
				{name: 'code', type: 'string'},
				{name: 'description', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'i18nRouter.getAvailableLanguages'
				}
			}
		});

		me.callParent();
	}
});

Ext.define('App.ux.combo.LabsTypes', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.labstypescombo',
	initComponent: function() {
		var me = this;

		Ext.define('LabsTypesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'id'},
				{name: 'code_text_short' },
				{name: 'parent_name', type: 'string' },
				{name: 'loinc_name', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: Laboratories.getActiveLaboratoryTypes
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'LabsTypesComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable    : false,
			displayField: 'loinc_name',
			valueField  : 'loinc_name',
			emptyText   : _('select'),
			store       : me.store
		});
		me.callParent(arguments);
	}
});

Ext.define('App.ux.combo.MedicalIssues', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.medicalissuescombo',
	initComponent: function() {
		var me = this;

		Ext.define('MedicalIssuesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 75
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'MedicalIssuesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Medications', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.medicationscombo',
	initComponent: function() {
		var me = this;

		Ext.define('MedicationsModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 74
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'MedicationsModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.InsurancePayerType', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.insurancepayertypecombo',
	initComponent: function() {
		var me = this;

		// *************************************************************************************
		// Structure, data for Insurance Payer Types
		// AJAX -> component_data.ejs.php
		// *************************************************************************************
		me.store = Ext.create('Ext.data.Store', {
			fields: ['id', 'name'],
			data  : [
				{"id": "1", "name": _('all')},
				{"id": "16", "name": _('other_hcfa')},
				{"id": "MB", "name": _('medicare_part_b')},
				{"id": "MC", "name": _('medicaid')},
				{"id": "CH", "name": _('champusva')},
				{"id": "CH", "name": _('champus')},
				{"id": "BL", "name": _('blue_cross_blue_shield')},
				{"id": "16", "name": _('feca')},
				{"id": "09", "name": _('self_pay')},
				{"id": "10", "name": _('central_certification')},
				{"id": "11", "name": _('other_nonfederal_programs')},
				{"id": "12", "name": _('ppo')},
				{"id": "13", "name": _('pos')},
				{"id": "14", "name": _('epo')},
				{"id": "15", "name": _('indemnity_insurance')},
				{"id": "16", "name": _('hmo')},
				{"id": "AM", "name": _('automobile_medical')},
				{"id": "CI", "name": _('commercial_insurance')},
				{"id": "DS", "name": _('disability')},
				{"id": "HM", "name": _('health_maintenance_organization')},
				{"id": "LI", "name": _('liability')},
				{"id": "LM", "name": _('liability_medical')},
				{"id": "OF", "name": _('other_federal_program')},
				{"id": "TV", "name": _('title_v')},
				{"id": "VA", "name": _('veterans_administration_plan')},
				{"id": "WC", "name": _('workers_compensation_health_plan')},
				{"id": "ZZ", "name": _('mutually_defined')}
			]
		});

		Ext.apply(this, {
			name        : 'freeb_type',
			editable    : false,
			displayField: 'name',
			valueField  : 'id',
			queryMode   : 'local',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent();
	}
});
Ext.define('App.ux.combo.LabObservations', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.labobservationscombo',
	initComponent: function() {
		var me = this;

		Ext.define('labObservationsComboModel', {
			extend: 'Ext.data.Model',
			fields: [
              		{name: 'label' },
              		{name: 'name' },
              		{name: 'unit' },
              		{name: 'range_start' },
              		{name: 'range_end' },
              		{name: 'threshold' },
              		{name: 'notes' }
			],
			proxy : {
				type  : 'direct',
				api   : {
					read: 'Services.getAllLabObservations'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'labObservationsComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			store       : me.store,
			displayField: 'label',
			valueField  : 'id',
			emptyText   : _('select_existing_observation'),
            editable    : false,
            width: 810,
			listConfig  : {
				getInnerTpl: function() {
					return '<div>' +
                        '<span style="width:200px;display:inline-block;"><span style="font-weight:bold;">' + _('Label') + ':</span> {label},</span>' +
                        '<span style="width:90px;display:inline-block;"><span style="font-weight:bold;">' + _('unit') + ':</span> {unit},</span>' +
                        '<span style="width:150px;display:inline-block;"><span style="font-weight:bold;">' + _('range_start') + ':</span> {range_start},</span>' +
                        '<span style="width:130px;display:inline-block;"><span style="font-weight:bold;">' + _('range_end') + ':</span> {range_end},</span>' +
                        '<span style="width:100px;display:inline-block;"><span style="font-weight:bold;">' + _('threshold') + ':</span> {threshold}</span>' +
                        '</div>';
				}
			}
		}, null);

		me.callParent();
	}

});
Ext.define('App.ux.combo.Lists', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.listscombo',
	width        : 250,
	iconCls      : 'icoListOptions',
	initComponent: function() {
		var me = this;

		Ext.define('ListComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'id'},
				{name: 'title', type: 'string' }
			],
			proxy : {
				type: 'direct',
				api : {
					read: CombosData.getLists
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'ListComboModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			valueField  : 'id',
			displayField: 'title',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.MsgStatus', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.msgstatuscombo',
	initComponent: function() {
		var me = this;

		Ext.define('MsgStatusModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 45
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'MsgStatusModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent();
	} // end initComponent
});
Ext.define('App.ux.combo.MsgNoteType', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.msgnotetypecombo',
	initComponent: function() {
		var me = this;

		Ext.define('MsgNoteTypeModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 28
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'MsgNoteTypeModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent();
	} // end initComponent
});
Ext.define('App.ux.combo.Outcome', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.outcomecombo',
	initComponent: function() {
		var me = this;

		Ext.define('OutcomeModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 27
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'OutcomeModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Occurrence', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.occurrencecombo',
	initComponent: function(){
		var me = this;

		Ext.define('OccurrenceModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 26
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'OccurrenceModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		});
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Outcome2', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.outcome2combo',
	initComponent: function(){
		var me = this;

		Ext.define('Outcome2model', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 74
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'Outcome2model',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		});
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PayingEntity', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.payingentitycombo',
	initComponent: function() {
		var me = this;

		Ext.define('PayingEntityModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 54
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PayingEntityModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});

Ext.define('App.ux.combo.PaymentCategory', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.paymentcategorycombo',
	initComponent: function() {
		var me = this;

		Ext.define('PaymentCategoryModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 49
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PaymentCategoryModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PaymentMethod', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.paymentmethodcombo',
	initComponent: function() {
		var me = this;

		Ext.define('PaymentMethodModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 51
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PaymentMethodModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PrescriptionHowTo', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.prescriptionhowto',
	initComponent: function(){
		var me = this;

		Ext.define('PrescriptionHowTomodel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 88
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'PrescriptionHowTomodel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.posCodes', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.poscodescombo',
	initComponent: function(){
		var me = this;

		Ext.define('PosCodesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'code',
					type: 'string'
				},
				{
					name: 'title',
					type: 'string',
					convert: function(v, record){
						return record.data.code + ' - '+ v;
					}
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getPosCodes'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'PosCodesModel',
			autoLoad: true
		});

		Ext.apply(me, {
			editable: false,
			queryMode: 'local',
			valueField: 'code',
			displayField: 'title',
			emptyText: _('select'),
			store: me.store
		});

		me.callParent();
	}
});
Ext.define('App.ux.combo.Pharmacies', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.pharmaciescombo',
	initComponent: function(){
		var me = this;

		Ext.define('PharmaciesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name'},
				{name: 'option_value'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getActivePharmacies'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'PharmaciesComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable: false,
			//queryMode   : 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PrescriptionOften', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.prescriptionoften',
	initComponent: function() {
		var me = this;

		Ext.define('PrescriptionOftenmodel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 86
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PrescriptionOftenmodel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Providers', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.providerscombo',
	editable: false,
	queryMode: 'local',
	displayField: 'name',
	valueField: 'id',
	emptyText: _('select'),

	initComponent: function(){
		var me = this;

		Ext.define('ProvidersComboBoxModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'email',
					type: 'string'
				},
				{
					name: 'mobile',
					type: 'string'
				},
				{
					name: 'name',
					type: 'string',
					convert: function (v, r) {
						return Ext.String.format('{0}, {1} {2}',
								r.get('lname'), r.get('fname'), r.get('mname')
							);
					}
				},
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'User.getProviders'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ProvidersComboBoxModel',
			autoLoad: true
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.ProceduresBodySites', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.proceduresbodysitescombo',
	initComponent: function() {
		var me = this;

		Ext.define('ProceduresBodySitesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 34
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'ProceduresBodySitesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PreventiveCareTypes', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.preventivecaretypescombo',
	initComponent: function() {
		var me = this;

		Ext.define('PreventiveCareTypesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 78
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PreventiveCareTypesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			valueField  : 'option_value',
			displayField: 'option_name',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PrescriptionTypes', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.prescriptiontypes',
	initComponent: function(){
		var me = this;

		Ext.define('PrescriptionTypesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getOptionsByListId'
				},
				extraParams: {
					list_id: 89
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'PrescriptionTypesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		});
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.PrescriptionWhen', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.prescriptionwhen',
	initComponent: function() {
		var me = this;

		Ext.define('PrescriptionWhenmodel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 87
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'PrescriptionWhenmodel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.model.administration.PrinterCombo', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'string'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'printer_description',
			type: 'string'
		},
		{
			name: 'local',
			type: 'bool'
		},
		{
			name: 'facility_id',
			type: 'int'
		},
		{
			name: 'active',
			type: 'bool'
		},
		{
			name: 'display_value',
			convert: function (v, r) {
				if (r.get('local')) {
					return r.get('name') + ' (local)';
				}
				return r.get('printer_description') + ' (remote)';
			}
		}
	]
});
Ext.define('App.store.administration.PrinterCombo', {
	extend: 'Ext.data.Store',
	requires: ['App.model.administration.PrinterCombo'],
	model: 'App.model.administration.PrinterCombo'
});
Ext.define('App.ux.form.fields.CheckBoxWithFamilyRelation', {
	extend: 'App.ux.form.fields.CheckBoxWithText',
	xtype: 'checkboxwithfamilyhistory',

	initComponent:function(){

		var me = this;
		
		me.textField1 = {
			xtype: 'fieldcontainer',
			layout: {
				type: 'vbox',
				align: 'stretch'
			},
			getSubmitValue: function () {
				var values = [];

				this.items.each(function (item) {

					var relation_cmb  = item.getComponent(0),
						relation_store = relation_cmb.store,
						relation_record = relation_store.getById(relation_cmb.getSubmitValue()),
						note  = item.getComponent(1).getValue();

					if(!relation_record) return;

					values.push(Ext.String.format(
						'{0}:{1}:{2}:{3}',
						relation_record.get('code_type'),
						relation_record.get('code'),
						relation_record.get('option_name'),
						note
					));

				});

				return values.join(',');

			},
			getValue: function () {
				return this.getSubmitValue();
			},
			setValue: function () {

			},
			isValid: function () {

			}
		};

		me.inputValue = me.code || '1';
		me.callParent();
		me.addRelationField();

	},

	addRelationField: function () {
		var me = this;

		me.textField1.add({
			xtype: 'fieldcontainer',
			action: 'fieldscontainer',
			layout: {
				type: 'hbox',
				align: 'stretch'
			},
			items: [
				{
					xtype: 'gaiaehr.combo',
					fieldLabel: _('relation'),
					labelAlign: 'right',
					action: 'relationcmb',
					labelWidth: 100,
					list: 109,
					allowBlank: false,
					loadStore: true,
					editable: false,
					resetable: true,
					value: '',
					isEmpty: true,
					submitValue: false,
					listeners: {
						select: me.onRelationComoSelect,
						fieldreset: me.onRelationComoReset,
						scope: me
					}
				},
				{
					xtype: 'textfield',
					fieldLabel: _('note'),
					labelAlign: 'right',
					labelWidth: 80,
					flex: 1
				}
			]
		});
	},

	onRelationComoReset: function (cmb) {

		say('onRelationComoReset');
		if(this.textField1.items.length === 1) return;
		this.textField1.remove(cmb.up('fieldcontainer'))
	},

	onRelationComoSelect: function (cmb, selection) {
		if(selection.length > 0){
			cmb.isEmpty = false;
		}

		var fieldcontainer = cmb.up('fieldcontainer'),
			emptyfields = this.textField1.query('[action=relationcmb][isEmpty]');

		if(selection.length > 0 && emptyfields.length === 0){
			this.addRelationField();
		}
	},

	getValue: function(){
		var value = '',
			ckValue = this.chekboxField.getSubmitValue(),
			txtValue;

		if(ckValue != '0'){
			ckValue += ':' + this.chekboxField.boxLabel;
			txtValue = this.textField1.getSubmitValue();
		} else {
			txtValue = '0';
		}

		if(ckValue) {
			value = ckValue + '~' + txtValue;

			if(this.textField2){
				value += '~' + this.textField2.getSubmitValue() || '';
			}
		}


		say('getValue');
		say(value);


		return value;
	},

	setValue: function(value){
		// if(value && value.split){
		// 	var val = value.split('~');
		// 	this.chekboxField.setValue(val[0] || 0);
		//
		// 	if(val[1] != '0' && val[1].split){
		// 		var relation = val[1].split(':');
		// 		this.textField1.select(relation[1] || relation[0] || '');
		// 	} else {
		// 		this.textField1.setValue('');
		// 	}
		//
		// 	if(this.textField2 && val[2]){
		// 		this.textField2.setValue(val[2]) || '';
		// 	}
		//
		// 	return;
		// }
		// this.chekboxField.setValue(0);
		// this.textField1.setValue('');
		// if(this.textField2) this.textField2.setValue('');

	}
});

/**
 * The Ext.grid.plugin.RowEditing plugin injects editing at a row level for a Grid. When editing begins,
 * a small floating dialog will be shown for the appropriate row. Each editable column will show a field
 * for editing. There is a button to save or cancel all changes for the edit.
 *
 * The field that will be used for the editor is defined at the
 * {@link Ext.grid.column.Column#editor editor}. The editor can be a field instance or a field configuration.
 * If an editor is not specified for a particular column then that column won't be editable and the value of
 * the column will be displayed.
 *
 * The editor may be shared for each column in the grid, or a different one may be specified for each column.
 * An appropriate field type should be chosen to match the data structure that it will be editing. For example,
 * to edit a date, it would be useful to specify {@link Ext.form.field.Date} as the editor.
 *
 *     @example
 *     Ext.create('Ext.data.Store', {
 *         storeId:'simpsonsStore',
 *         fields:['name', 'email', 'phone'],
 *         data: [
 *             {"name":"Lisa", "email":"lisa@simpsons.com", "phone":"555-111-1224"},
 *             {"name":"Bart", "email":"bart@simpsons.com", "phone":"555--222-1234"},
 *             {"name":"Homer", "email":"home@simpsons.com", "phone":"555-222-1244"},
 *             {"name":"Marge", "email":"marge@simpsons.com", "phone":"555-222-1254"}
 *         ]
 *     });
 *
 *     Ext.create('Ext.grid.Panel', {
 *         title: 'Simpsons',
 *         store: Ext.data.StoreManager.lookup('simpsonsStore'),
 *         columns: [
 *             {header: 'Name',  dataIndex: 'name', editor: 'textfield'},
 *             {header: 'Email', dataIndex: 'email', flex:1,
 *                 editor: {
 *                     xtype: 'textfield',
 *                     allowBlank: false
 *                 }
 *             },
 *             {header: 'Phone', dataIndex: 'phone'}
 *         ],
 *         selType: 'rowmodel',
 *         plugins: [
 *             Ext.create('Ext.grid.plugin.RowEditing', {
 *                 clicksToEdit: 1
 *             })
 *         ],
 *         height: 200,
 *         width: 400,
 *         renderTo: Ext.getBody()
 *     });
 */
Ext.define('App.ux.grid.RowFormEditing', {
	extend: 'Ext.grid.plugin.Editing',
	alias: 'plugin.rowformediting',
	requires: [
		'App.ux.grid.RowFormEditor'
	],

	lockableScope: 'top',

	editStyle: 'row',

	enableRemove: false,
	enableAddBtn: false,
	addBtnText: 'Add',
	addBtnIconCls: null,
	toolbarDock: 'top',

	fieldDefaults: {},

	saveBtnEnabled: false,
	/**
	 * @cfg {Boolean} autoSync
	 * True to automatically Sync any pending changes during complete edit method.
	 * False to force the user to explicitly sync all pending changes. Defaults to true.
	 */
	autoSync: true,
	/**
	 * @cfg {Boolean} autoCancel
	 * True to automatically cancel any pending changes when the row editor begins editing a new row.
	 * False to force the user to explicitly cancel the pending changes. Defaults to true.
	 */
	autoCancel: true,

	/**
	 * @cfg {Number} clicksToMoveEditor
	 * The number of clicks to move the row editor to a new row while it is visible and actively editing another row.
	 * This will default to the same value as {@link Ext.grid.plugin.Editing#clicksToEdit clicksToEdit}.
	 */

	/**
	 * @cfg {Boolean} errorSummary
	 * True to show a {@link Ext.tip.ToolTip tooltip} that summarizes all validation errors present
	 * in the row editor. Set to false to prevent the tooltip from showing. Defaults to true.
	 */
	errorSummary: false,

	/**
	 * @event beforeedit
	 * Fires before row editing is triggered.
	 *
	 * @param {Ext.grid.plugin.Editing} editor
	 * @param {Object} e An edit event with the following properties:
	 *
	 * - grid - The grid this editor is on
	 * - view - The grid view
	 * - store - The grid store
	 * - record - The record being edited
	 * - row - The grid table row
	 * - column - The grid {@link Ext.grid.column.Column Column} defining the column that initiated the edit
	 * - rowIdx - The row index that is being edited
	 * - colIdx - The column index that initiated the edit
	 * - cancel - Set this to true to cancel the edit or return false from your handler.
	 */

	/**
	 * @event canceledit
	 * Fires when the user has started editing a row but then cancelled the edit
	 * @param {Object} grid The grid
	 */

	/**
	 * @event edit
	 * Fires after a row is edited. Usage example:
	 *
	 *     grid.on('edit', function(editor, e) {
     *         // commit the changes right after editing finished
     *         e.record.commit();
     *     };
	 *
	 * @param {Ext.grid.plugin.Editing} editor
	 * @param {Object} e An edit event with the following properties:
	 *
	 * - grid - The grid this editor is on
	 * - view - The grid view
	 * - store - The grid store
	 * - record - The record being edited
	 * - row - The grid table row
	 * - column - The grid {@link Ext.grid.column.Column Column} defining the column that initiated the edit
	 * - rowIdx - The row index that is being edited
	 * - colIdx - The column index that initiated the edit
	 */
	/**
	 * @event validateedit
	 * Fires after a cell is edited, but before the value is set in the record. Return false to cancel the change. The
	 * edit event object has the following properties
	 *
	 * Usage example showing how to remove the red triangle (dirty record indicator) from some records (not all). By
	 * observing the grid's validateedit event, it can be cancelled if the edit occurs on a targeted row (for example)
	 * and then setting the field's new value in the Record directly:
	 *
	 *     grid.on('validateedit', function(editor, e) {
     *       var myTargetRow = 6;
     *
     *       if (e.rowIdx == myTargetRow) {
     *         e.cancel = true;
     *         e.record.data[e.field]
     *
     * - grid - The grid this editor is on
     * - view - The grid view
     * - store - The grid store
     * - record - The record being edited
     * - row - The grid table row
     * - column - The grid {@link Ext.grid.column.Column Column} defining the column that initiated the edit
	 * - rowIdx - The row index that is being edited
	 * - colIdx - The column index that initiated the edit
	 * - cancel - Set this to true to cancel the edit or return false from your handler.
	 */

	constructor: function(){
		var me = this;
		me.callParent(arguments);

		if(!me.clicksToMoveEditor){
			me.clicksToMoveEditor = me.clicksToEdit;
		}

		me.autoCancel = !!me.autoCancel;
	},

	init: function(grid){
		var me = this,
            t;
		me.callParent(arguments);

		if(me.enableAddBtn){
			t = grid.getDockedItems('toolbar[dock="' + me.toolbarDock + '"]')[0] ||
				grid.addDocked({ xtype: 'toolbar', dock: me.toolbarDock })[0];

			t.add({
				xtype: 'button',
				text: me.addBtnText,
				iconCls: me.addBtnIconCls,
				handler: me.doAddRecord,
				scope: me
			});

		}

		me.grid.on('beforeselect', me.editHandler, me);
		me.grid.on('beforecellclick', me.editHandler, me);
		me.grid.on('beforecelldblclick', me.editHandler, me);
		me.grid.on('beforecellmousedown', me.editHandler, me);
	},

	editHandler: function(){
		return !this.editing;
	},

	doAddRecord: function(){
		var me = this,
			grid = me.grid,
			store = grid.store;

		me.cancelEdit();
		store.insert(0, {});
		me.startEdit(0, 0);

	},

	//    init: function(grid) {
	//        this.callParent([grid]);
	//    },

	/**
	 * @private
	 * AbstractComponent calls destroy on all its plugins at destroy time.
	 */
	destroy: function(){
		var me = this;
		Ext.destroy(me.editor);
		me.callParent(arguments);
	},

	/**
	 * Starts editing the specified record, using the specified Column definition to define which field is being edited.
	 * @param {Ext.data.Model} record The Store data record which backs the row to be edited.
	 * @param {Ext.data.Model} columnHeader The Column object defining the column to be edited.
	 * @return {Boolean} `true` if editing was started, `false` otherwise.
	 */
	startEdit: function(record, columnHeader){
		var me = this,
			editor = me.getEditor(),
			context;

		if(editor.beforeEdit() !== false){
			context = me.callParent(arguments);
			if(context){
				me.context = context;

				// If editing one side of a lockable grid, cancel any edit on the other side.
				if(me.lockingPartner){
					me.lockingPartner.cancelEdit();
				}
				editor.startEdit(context.record, context.column, context);
				return true;
			}
		}
		return false;
	},

	// private
	cancelEdit: function(){
		var me = this;

		if(me.editing){
			me.getEditor().cancelEdit();
			me.callParent(arguments);

			if(me.autoCancel) me.view.store.rejectChanges();

			me.fireEvent('canceledit', me.context);
			return;
		}
		// If we aren't editing, return true to allow the event to bubble
		return true;
	},

	// private
	completeEdit: function(){
		var me = this;

		if(me.editing && me.validateEdit()){
			me.editing = false;
			me.fireEvent('edit', me, me.context);
		}
	},

	completeRemove: function(){
		var me = this;

		if(me.editing){
			me.getEditor().completeRemove();
			me.fireEvent('completeremove', me, me.context);
		}

	},

	// private
	validateEdit: function(){
		var me = this,
			editor = me.editor,
			context = me.context,
			record = context.record,
			originalValues = {},
			newValues = editor.getForm().getValues();


		Ext.Object.each(newValues, function(key){
			originalValues[key] = record.get(key);
		});

		Ext.apply(context, {
			newValues: newValues,
			originalValues: originalValues
		});

		return me.fireEvent('validateedit', me, context) !== false && !context.cancel && me.getEditor().completeEdit();
	},

	// private
	getEditor: function(){
		var me = this;

		if(!me.editor){
			me.editor = me.initEditor();
		}
		return me.editor;
	},

	// @private
	initEditor: function(){
		return new App.ux.grid.RowFormEditor(this.initEditorConfig());
	},

	initEditorConfig: function(){
		var me = this,
			grid = me.grid,
			view = me.view,
			headerCt = grid.headerCt,
			btns = ['saveBtnText', 'cancelBtnText', 'errorsText', 'dirtyText'],
			b,
			bLen = btns.length,
			cfg = {
				autoCancel: me.autoCancel,
				errorSummary: me.errorSummary,
				saveBtnEnabled: me.disableValidation,
				fields: headerCt.getGridColumns(),
				hidden: true,
				view: view,
				// keep a reference..
				editingPlugin: me,
				renderTo: view.el
			},
			item;

		for(b = 0; b < bLen; b++){
			item = btns[b];

			if(Ext.isDefined(me[item])){
				cfg[item] = me[item];
			}
		}
		return cfg;
	},

	// private
	initEditTriggers: function(){
		var me = this,
			moveEditorEvent = me.clicksToMoveEditor === 1 ? 'click' : 'dblclick';

		me.callParent(arguments);

		if(me.clicksToMoveEditor !== me.clicksToEdit){
			me.mon(me.view, 'cell' + moveEditorEvent, me.moveEditorByClick, me);
		}
	},

	startEditByClick: function(){
		var me = this;
		if(!me.editing || me.clicksToMoveEditor === me.clicksToEdit){
			me.callParent(arguments);
		}
	},

	moveEditorByClick: function(){
		var me = this;
		if(me.editing){
			me.superclass.onCellClick.apply(me, arguments);
		}
	},

	onCellClick: function(view, cell, colIdx, record, row, rowIdx, e){
		var me = this;

		if(me.autoCancel){
			me.view.store.rejectChanges();
			if(me.editor) me.editor.rejectChildStoresChanges();
		}
		me.callParent(arguments);
	},

	// private
	setColumnField: function(column, field){
		var me = this;
		editor.removeField(column);
		me.callParent(arguments);
		me.getEditor().setField(column.field, column);
	}
});

Ext.define('App.ux.combo.Sex', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.gaiaehr.sexcombo',
	initComponent: function() {
		var me = this;

		Ext.define('Sexmodel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 19
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'Sexmodel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('sex'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});

Ext.define('App.ux.combo.Race', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.racecombo',
	tpl: Ext.create('Ext.XTemplate',
		'<tpl for=".">',
		'<div class="x-boundlist-item">{indent_index} <b>{code_description}</b> [{code}]</div>',
		'</tpl>'
	),
	typeAhead: true,
	typeAheadDelay: 50,
	queryMode: 'local',
	displayField: 'code_description',
	valueField: 'code',
	emptyText: _('race'),
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{name: 'code', type: 'string'},
				{name: 'code_type', type: 'string'},
				{name: 'code_description', type: 'string'},
				{
					name: 'indent_index',
					type: 'int',
					convert: function (v) {
						var str = '';
						while(v > 0){ str += '----'; v--; }
						return str.trim();
					}
				},
			],
			autoLoad: true,
			proxy: {
				type: 'ajax',
				url: 'resources/code_sets/HL7v3-Race.json',
				reader: {
					type: 'json'
				}
			},
			listeners: {
				load: function () {
					this.insert(0, [{code: 'ASKU', code_type: 'CDA', code_description: 'Declined to specify' }]);
				}
			}
		});

		me.callParent(arguments);
	}
});

Ext.define('App.ux.combo.SmokingStatus', {
	extend: 'App.ux.combo.Combo',
	alias: 'widget.mitos.smokingstatuscombo',
	list: 58,
	loadStore: true
});
Ext.define('App.ux.combo.Surgery', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.surgerycombo',
	initComponent: function() {
		var me = this;

		Ext.define('SurgeryModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 76
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'SurgeryModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Roles', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.rolescombo',
	editable: false,
	queryMode: 'local',
	valueField: 'id',
	displayField: 'role_name',
	emptyText: _('select'),
	includeAllOption: false,
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: true,
			fields: [
				{name: 'id', type: 'int'},
				{name: 'role_name', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getRoles'
				},
				extraParams: {
					includeAllOption: me.includeAllOption
				}
			}
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.TaxId', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.taxidcombo',
	initComponent: function() {
		var me = this;

		Ext.define('TaxIdsModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_id', type: 'string' },
				{name: 'title', type: 'string' }
			],
			proxy : {
				type: 'direct',
				api : {
					read: CombosData.getTaxIds
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'TaxIdsModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'title',
			valueField  : 'option_id',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent();
	} // end initComponent
});
Ext.define('App.ux.combo.Templates', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.documentstemplatescombo',
	initComponent: function(){
		var me = this;

		Ext.define('DocumentsTemplatesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'body',
					type: 'string'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getTemplatesTypes'
				}
			}
		});

		Ext.apply(this, {
			editable: false,
			displayField: 'title',
			valueField: 'id',
			queryMode: 'local',
			emptyText: _('select'),
			store: Ext.create('Ext.data.Store', {
				model: 'DocumentsTemplatesComboModel',
				autoLoad: false
			})
		});

		me.callParent(arguments);

		me.listeners = {
			scope: me,
			beforerender:function(){
				me.getStore().load();
			}
		}
	}
});
Ext.define('App.ux.combo.TransmitMethod', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.transmitmethodcombo',
	initComponent: function() {
		var me = this;


		me.storeTrsmit = Ext.create('Ext.data.Store', {
			fields: ['id', 'name'],
			data  : [
				{"id": "1", "name": "Print"},
				{"id": "2", "name": "Email"},
				{"id": "3", "name": "Email"}
			]
		});

		Ext.apply(this, {
			name        : 'transmit_method',
			editable    : false,
			displayField: 'name',
			valueField  : 'id',
			queryMode   : 'local',
			emptyText   : _('select'),
			store       : me.storeTrsmit
		}, null);
		me.callParent();
	} // end initComponent
});
Ext.define('App.ux.combo.Titles', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.titlescombo',
	initComponent: function() {
		var me = this;

		Ext.define('TitlesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 22
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'TitlesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Themes', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.themescombo',
	initComponent: function(){
		var me = this;

		Ext.define('ThemesComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{ name: 'name', type: 'string' },
				{ name: 'value', type: 'string' }
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getThemes'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ThemesComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable: false,
			valueField: 'value',
			displayField: 'name',
			emptyText: _('select'),
			store: me.store
		}, null);
		me.callParent();
	}
});
Ext.define('App.ux.combo.Time', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.timecombo',
	initComponent: function() {
		var me = this;

		Ext.define('Timemodel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 77
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'Timemodel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Types', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.typescombobox',
	initComponent: function() {
		var me = this;

		// *************************************************************************************
		// Structure, data for Types
		// AJAX -> component_data.ejs.php
		// *************************************************************************************


		Ext.define('TypesModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 32
				}

			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'TypesModel',
			autoLoad: true
		});

		Ext.apply(this, {
			name        : 'abook_type',
			editable    : false,
			displayField: 'option_name',
			valueField  : 'option_value',
			queryMode   : 'local',
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.ComboEvents', {
    extend: 'Ext.form.ComboBox',
    alias: 'widget.eventlist',
    displayField: 'event',
    valueField: 'event',
    forceSelection: false,
    editable: false,

    /**
     * List ID
     */
    list: null,
    /**
     * Auto Load Store
     */
    loadStore: false,
    /**
     * value data type
     */
    valueDataType: 'string',

    initComponent: function () {
        var me = this,
            model = me.id + 'ComboEventListModel';

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'event',
                    type: 'string'
                }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getEventList'
                }
            },
            idProperty: 'event'
        });

        me.store = Ext.create('Ext.data.Store', {
            model: model,
            autoLoad: me.loadStore
        });

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        me.callParent(arguments);

    }
});

Ext.define('App.ux.combo.Units', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.unitscombo',
	initComponent: function() {
		var me = this;

		Ext.define('UnitsModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 38
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'UnitsModel',
			autoLoad: true
		});

		Ext.apply(this, {
			//editable    : false,
			queryMode   : 'local',
			valueField  : 'option_value',
			displayField: 'option_name',
			//emptyText   : 'Select',
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.ComboTable', {
    extend: 'Ext.form.ComboBox',
    alias: 'widget.tablelist',
    displayField: 'table_name',
    valueField: 'table_name',
    forceSelection: false,
    editable: false,

    /**
     * List ID
     */
    list: null,
    /**
     * Auto Load Store
     */
    loadStore: false,
    /**
     * value data type
     */
    valueDataType: 'string',


    initComponent: function () {
        var me = this,
            model = me.id + 'ComboTableListModel';

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'table_name',
                    type: 'string'
                }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getTableList'
                }
            },
            idProperty: 'table_name'
        });

        me.store = Ext.create('Ext.data.Store', {
            model: model,
            autoLoad: me.loadStore
        });

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        me.callParent(arguments);

    }
});

Ext.define('App.ux.combo.YesNoNa', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.yesnonacombo',
	initComponent: function() {
		var me = this;

		Ext.define('yesnonaModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 93
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'yesnonaModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.ux.combo.Users', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.userscombo',
	acl: null,
	includeAllOption: false,
	editable: false,
	queryMode: 'local',
	valueField: 'id',
	displayField: 'name',
	emptyText: _('select'),

	initComponent: function(){
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: true,
			fields: [
				{name: 'id', type: 'int'},
				{name: 'name', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getUsers'
				},
				extraParams: {
					acl: me.acl,
					includeAllOption: me.includeAllOption
				}
			}
		});

		me.callParent();
	}
})
;
Ext.define('App.ux.window.Window', {
	extend       : 'Ext.window.Window',
	autoHeight   : true,
	modal        : true,
	border       : true,
	autoScroll   : true,
	resizable    : false,
	closeAction  : 'hide',
	initComponent: function() {
		this.callParent(arguments);
	},

	updateTitle: function(pageTitle, readOnly) {
		this.setTitle(pageTitle + (readOnly ? '[ Read Only ]' : ''));
	},

	setReadOnly: function() {
		var forms = this.query('form'),
			readOnly = app.patient.readOnly,
            j,
            form,
            k,
            items;
		for(j = 0; j < forms.length; j++) {
			form = forms[j], items;
			if(form.readOnly != readOnly){
				form.readOnly = readOnly;
				items = form.getForm().getFields().items;
				for(k = 0; k < items.length; k++) {
					items[k].setReadOnly(readOnly);
				}
			}
		}
		return readOnly;
	},

	setButtonsDisabled:function(buttons){
		var disable = app.patient.readOnly,
            i,
            btn;
		for(i = 0; i < buttons.length; i++) {
			btn = buttons[i];
			if(btn.disabled != disable){
				btn.disabled = disable;
				btn.setDisabled(disable)
			}
		}
	},

	checkIfCurrPatient: function() {
		return app.getCurrPatient();
	},

	patientInfoAlert: function() {
		var patient = app.getCurrPatient();

		Ext.Msg.alert(_('status'), _('patient') + ': ' + patient.name + ' (' + patient.pid + ')');
	},

	currPatientError: function() {
		Ext.Msg.show({
			title  : _('oops') + ' ' + _('no_patient_selected'),
			msg    : _('select_patient_patient_live_search'),
			scope  : this,
			buttons: Ext.Msg.OK,
			icon   : Ext.Msg.ERROR,
			fn     : function() {
				this.goBack();
			}
		});
	},

	getFormItems: function(formPanel, formToRender, callback) {
        var items;

		formPanel.removeAll();
		FormLayoutEngine.getFields({formToRender: formToRender}, function(provider, response) {
			items = eval(response.result);
			formPanel.add(items);
			formPanel.fireEvent('formitemsadded', formPanel);
			if(typeof callback == 'function') {
				callback(formPanel, items, true);
			}
		});
	},

	boolRenderer: function(val) {
		if(val == '1' || val == true || val == 'true') {
			return '<img style="padding-left: 13px" src="resources/images/icons/yes.png" />';
		} else if(val == '0' || val == false || val == 'false') {
			return '<img style="padding-left: 13px" src="resources/images/icons/no.png" />';
		}
		return val;
	},

	alertRenderer: function(val) {
		if(val == '1' || val == true || val == 'true') {
			return '<img style="padding-left: 13px" src="resources/images/icons/no.png" />';
		} else if(val == '0' || val == false || val == 'false') {
			return '<img style="padding-left: 13px" src="resources/images/icons/yes.png" />';
		}
		return val;
	},

	warnRenderer:function(val, metaData, record){
        var toolTip = record.data.warningMsg ? ' data-qtip="'+record.data.warningMsg+'" ' : '';
        if(val == '1' || val == true || val == 'true') {
            return '<img src="resources/images/icons/icoImportant.png" ' + toolTip + ' />';
        }
    },

	onExpandRemoveMask: function(cmb) {
		cmb.picker.loadMask.destroy()
	},

	strToLowerUnderscores: function(str) {
		return str.toLowerCase().replace(/ /gi, "_");
	},
	getCurrPatient: function() {
		return app.getCurrPatient();
	},

	getApp: function() {
		return app.getApp();
	},

	msg: function(title, format) {
		app.msg(title, format)
	},

	passwordVerificationWin: function(callback) {
        var msg, f;
		msg = Ext.Msg.prompt(_('password_verification'), _('please_enter_your_password') + ':', function(btn, password) {
			callback(btn, password);
		});
		f = msg.textField.getInputId();
		document.getElementById(f).type = 'password';
		return msg;
	}
});

Ext.define('App.ux.combo.YesNo', {
	extend       : 'Ext.form.ComboBox',
	alias        : 'widget.mitos.yesnocombo',
	initComponent: function() {
		var me = this;

		Ext.define('yesnoModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'option_name', type: 'string' },
				{name: 'option_value', type: 'string' }
			],
			proxy : {
				type       : 'direct',
				api        : {
					read: CombosData.getOptionsByListId
				},
				extraParams: {
					list_id: 23
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model   : 'yesnoModel',
			autoLoad: true
		});

		Ext.apply(this, {
			editable    : false,
			queryMode   : 'local',
			displayField: 'option_name',
			valueField  : 'option_value',
			emptyText   : _('select'),
			store       : me.store
		}, null);
		me.callParent(arguments);
	}
});
Ext.define('App.view.search.PatientSearch',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelPatientSearch',
	pageTitle : _('advance_patient_search'),
	pageLayout : 'border',
	uses : ['Ext.grid.Panel'],
	initComponent : function()
	{
		var me = this;

		me.form = Ext.create('Ext.form.FormPanel',
		{
			region : 'north',
			height : 200,
			bodyPadding : 10,
			margin : '0 0 3 0',
			buttonAlign : 'left',
			items : [
			{
				xtype : 'fieldcontainer',
				fieldLabel : _('name'),
				layout : 'hbox',
				defaults :
				{
					margin : '0 5 0 0'
				},
				items : [
				{
					xtype : 'textfield',
					emptyText : _('first_name'),
					name : 'fname'
				},
				{
					xtype : 'textfield',
					emptyText : _('middle_name'),
					name : 'mname'
				},
				{
					xtype : 'textfield',
					emptyText : _('last_name'),
					name : 'lname'
				}]
			}],

			buttons : [
			{
				text : _('search'),
				iconCls : 'save',
				handler : function()
				{
					//TODO: Finish me.
				}
			}, '-',
			{
				text : _('reset'),
				iconCls : 'save',
				tooltip : _('hide_selected_office_note'),
				handler : function()
				{
					//TODO: Finish me.
				}
			}]
		});
		
		me.grid = Ext.create('Ext.grid.Panel',
		{
			region : 'center',
			//store    : me.store,
			columns : [
			{
				header : 'id',
				sortable : false,
				dataIndex : 'id',
				hidden : true
			},
			{
				width : 150,
				header : _('date'),
				sortable : true,
				dataIndex : 'date',
				renderer : Ext.util.Format.dateRenderer('Y-m-d H:i:s')
			},
			{
				width : 150,
				header : _('user'),
				sortable : true,
				dataIndex : 'user'
			},
			{
				flex : 1,
				header : _('note'),
				sortable : true,
				dataIndex : 'body'
			}],
			tbar : Ext.create('Ext.PagingToolbar',
			{
				store : me.store,
				displayInfo : true,
				emptyMsg : _('no_office_notes_to_display'),
				plugins : Ext.create('Ext.ux.SlidingPager',
				{
				})
			})
		});
		// END GRID
		me.pageBody = [me.form, me.grid];
		me.callParent(arguments);
	}, // end of initComponent
	
	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		callback(true);
	}
});
//ens oNotesPage class
Ext.define('App.ux.button.Print', {
	extend: 'Ext.button.Split',
	xtype: 'printbutton',
	text: 'Print',
	numberOfCopies: 1,
	menu: [
		{
			text: 'Print 2 Copies',
			numberOfCopies: 2,
			handler: function(b){
				b.up('button').fireEvent('click', b);
			}
		},
		{
			text: 'Print 3 Copies',
			numberOfCopies: 3,
			handler: function(b){
				b.up('button').fireEvent('click', b);
			}
		}
	]
});

Ext.define('App.model.administration.MedicationInstruction', {
    extend: 'Ext.data.Model',
    table: {
        name: 'rxinstructions'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'rxcui',
            type: 'string',
            index: true
        },
        {
            name: 'occurrence',
            type: 'int',
            index: true
        },
        {
            name: 'instruction',
            type: 'string',
            len: 140
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Rxnorm.getMedicationInstructions',
            create: 'Rxnorm.addMedicationInstruction',
            update: 'Rxnorm.updateMedicationInstructions',
            destroy: 'Rxnorm.destroyMedicationInstructions'
        },
        remoteGroup: false
    }
});


Ext.define('App.ux.combo.ComboResettable', {
	extend: 'Ext.form.ComboBox',
	xtype: 'comboresettable',
	triggerTip: _('click_to_clear_selection'),
	spObj: '',
	spForm: '',
	spExtraParam: '',
	qtip: _('clearable_combo_box'),

	trigger1Class: 'x-form-select-trigger',
	trigger2Class: 'x-form-clear-trigger',

	onRender: function(ct, position){
		this.callParent(arguments);
		var id = this.getId();
		this.triggerConfig = {
			tag: 'div',
			cls: 'x-form-twin-triggers',
			style: 'display:block;',
			cn: [
				{
					tag: "img",
					style: Ext.isIE ? 'margin-left:0;height:21px' : '',
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					cls: "x-form-trigger " + this.trigger2Class
				}
			]
		};
		this.triggerEl.replaceWith(this.triggerConfig);

		this.triggerEl.on('mouseup', function(e){
			if(e.target.name == "trigger2" + id){
				this.reset();
				this.oldValue = null;
				if(this.spObj !== '' && this.spExtraParam !== ''){
					Ext.getCmp(this.spObj).store.setExtraParam(this.spExtraParam, '');
					Ext.getCmp(this.spObj).store.load()
				}
				if(this.spForm !== ''){
					Ext.getCmp(this.spForm).getForm().reset();
				}
				this.fireEvent('fieldreset', this);
			}

		}, this);

		var trigger2 = Ext.get("trigger2" + id);
		trigger2.addClsOnOver('x-form-trigger-over');
	}
}); 
Ext.define('App.ux.grid.LiveSearchGridPanel', {
	extend: 'Ext.grid.Panel',

	xtype: 'gridlivesearch',
	requires: [
		'Ext.toolbar.TextItem',
		'Ext.form.field.Checkbox',
		'Ext.form.field.Text',
		'Ext.ux.statusbar.StatusBar'
	],

	/**
	 * @private
	 * search value initialization
	 */
	searchValue: null,

	/**
	 * @private
	 * The row indexes where matching strings are found. (used by previous and next buttons)
	 */
	indexes: [],

	/**
	 * @private
	 * The row index of the first search, it could change if next or previous buttons are used.
	 */
	currentIndex: null,

	/**
	 * @private
	 * The generated regular expression used for searching.
	 */
	searchRegExp: null,

	/**
	 * @private
	 * Case sensitive mode.
	 */
	caseSensitive: false,

	/**
	 * @private
	 * Regular expression mode.
	 */
	regExpMode: false,

	/**
	 * @cfg {String} matchCls
	 * The matched string css classe.
	 */
	matchCls: 'x-livesearch-match',

	defaultStatusText: 'Nothing Found',

	searchBuffer: 100,

	filterStore: false,

	// Component initialization override: adds the top and bottom toolbars and setup headers renderer.
	initComponent: function(){
		var me = this;

		me.onTextFieldChangeBuffer = Ext.Function.createBuffered(me.onTextFieldChange, me.searchBuffer, me)

		me.callParent(arguments);

		me.addDocked({
			xtype: 'toolbar',
			dock: 'top',
			items: [
				_('search'),
				{
					xtype: 'textfield',
					name: 'searchField',
					hideLabel: true,
					width: 200,
					listeners: {
						change: {
							fn: me.onTextFieldChangeBuffer,
							scope: this,
							buffer: 100
						}
					}
				},
				'-',
				{
					xtype: 'button',
					text: '&lt;',
					tooltip: 'Find Previous Row',
					handler: me.onPreviousClick,
					scope: me
				},
				{
					xtype: 'button',
					text: '&gt;',
					tooltip: 'Find Next Row',
					handler: me.onNextClick,
					scope: me
				},
				'-',
				'->',
				'-',
				{
					xtype: 'tbtext',
					text: me.defaultStatusText,
					action: 'searchStatus',
					scope: me
				}
			]
		});
	},

	// afterRender override: it adds textfield and statusbar reference and start monitoring keydown events in textfield input
	afterRender: function(){
		var me = this;
		me.callParent(arguments);
		me.textField = me.down('textfield[name=searchField]');
		me.statusBar = me.down('tbtext[action=searchStatus]');
	},
	// detects html tag
	tagsRe: /<[^>]*>/gm,

	// DEL ASCII code
	tagsProtect: '\x0f',

	// detects regexp reserved word
	regExpProtect: /\\|\/|\+|\\|\.|\[|\]|\{|\}|\?|\$|\*|\^|\|/gm,

	/**
	 * In normal mode it returns the value with protected regexp characters.
	 * In regular expression mode it returns the raw value except if the regexp is invalid.
	 * @return {String} The value to process or null if the textfield value is blank or invalid.
	 * @private
	 */
	getSearchValue: function(){
		var me = this,
			value = me.textField.getValue();

		if(value === ''){
			return null;
		}
		if(!me.regExpMode){
			value = value.replace(me.regExpProtect, function(m){
				return '\\' + m;
			});
		}else{
			try{
				new RegExp(value);
			}catch(error){
				me.statusBar.setText(error.message);
				return null;
			}
			// this is stupid
			if(value === '^' || value === '$'){
				return null;
			}
		}

		return value;
	},

	/**
	 * Finds all strings that matches the searched value in each grid cells.
	 * @private
	 */
	onTextFieldChange: function(){
		var me = this,
			count = 0;

		me.view.refresh();
		// reset the statusbar
		me.statusBar.setText(me.defaultStatusText);

		me.searchValue = me.getSearchValue();
		me.indexes = [];
		me.currentIndex = null;

		if(me.filterStore) {
			me.store.clearFilter();
		}

		if(me.searchValue !== null){
			me.searchRegExp = new RegExp(me.searchValue, 'g' + (me.caseSensitive ? '' : 'i'));

			me.store.each(function(record, idx){

				var fly = Ext.fly(me.view.getNode(record)),
					td, cell, matches, cellHTML, is_row_checker;

				if(fly == null) return;

				td = fly.down('td');

				while(td){

					if(td == null){
						break;
					}

					is_row_checker = false;

					cell = td.down('.x-grid-cell-inner');
					matches = cell.dom.innerHTML.match(me.tagsRe);
					cellHTML = cell.dom.innerHTML.replace(me.tagsRe, me.tagsProtect);

					if(matches){
						for(var i = 0; i < matches.length; i++){
							if(matches[i].indexOf('x-grid-row-checker') !== -1){
								is_row_checker = true;
								break;
							}
						}
					}


					if(!is_row_checker){
						// populate indexes array, set currentIndex, and replace wrap matched string in a span
						cellHTML = cellHTML.replace(me.searchRegExp, function(m){
							count += 1;
							if(Ext.Array.indexOf(me.indexes, record) === -1){
								me.indexes.push(record);
							}
							if(me.currentIndex === null){
								me.currentIndex = record;
							}

							return '<span class="' + me.matchCls + '">' + m + '</span>';
						});

						// restore protected tags
						Ext.each(matches, function(match){
							cellHTML = cellHTML.replace(me.tagsProtect, match);
						});
						// update cell html
						cell.dom.innerHTML = cellHTML;
					}
					td = td.next();
				}

			}, me);

			if(me.filterStore){
				me.store.filterBy(function (rec, id){
					return Ext.Array.contains(me.indexes, rec);
				}, me);
			}


			// results found
			if(me.currentIndex !== null){
				//me.getSelectionModel().select(me.currentIndex);
				me.statusBar.setText(count + ' matche(s) found.');
			}
		}

		// no results found
		if(me.currentIndex === null){
			//me.getSelectionModel().deselectAll();
		}

		// force textfield focus
		me.textField.focus();
	},

	/**
	 * Selects the previous row containing a match.
	 * @private
	 */
	onPreviousClick: function(){
		var me = this,
			idx;

		if((idx = Ext.Array.indexOf(me.indexes, me.currentIndex)) !== -1){
			me.currentIndex = me.indexes[idx - 1] || me.indexes[me.indexes.length - 1];
			me.getSelectionModel().select(me.currentIndex);
		}
	},

	/**
	 * Selects the next row containing a match.
	 * @private
	 */
	onNextClick: function(){
		var me = this,
			idx;

		if((idx = Ext.Array.indexOf(me.indexes, me.currentIndex)) !== -1){
			me.currentIndex = me.indexes[idx + 1] || me.indexes[0];
			me.getSelectionModel().select(me.currentIndex);
		}
	},

	/**
	 * Switch to case sensitive mode.
	 * @private
	 */
	caseSensitiveToggle: function(checkbox, checked){
		this.caseSensitive = checked;
		this.onTextFieldChange();
	},

	/**
	 * Switch to regular expression mode
	 * @private
	 */
	regExpToggle: function(checkbox, checked){
		this.regExpMode = checked;
		this.onTextFieldChange();
	}
});
Ext.define('App.ux.LiveRXNORMSearch', {
	extend: 'Ext.form.ComboBox',
	requires:[
		'App.model.administration.MedicationInstruction'
	],
	alias: 'widget.rxnormlivetsearch',
    itemId: 'RxNormLiveSearch',
	hideLabel: true,
	displayField: 'STR',
	valueField: 'RXCUI',
	initComponent: function(){
		var me = this;

		Ext.define('liveRXNORMSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'RXCUI',
					type: 'string'
				},
				{
					name: 'CODE',
					type: 'string'
				},
                {
                    name: 'GS_CODE',
                    type: 'string'
                },
				{
					name: 'NDC',
					type: 'string'
				},
				{
					name: 'STR',
					type: 'string',
					convert: function(v){
						v = v.replace(/\(.*\) | \(.*\)|\(.*\)/g, '');
						v = v.replace(/[\[\]]/g, '');
						v = v.replace(/\+/g, '');
						return v;
					}
				},
				{
					name: 'TTY',
					type: 'auto'
				},
				{
					name: 'DST',
					type: 'auto'
				},
				{
					name: 'DRT',
					type: 'auto'
				},
				{
					name: 'DDF',
					type: 'auto'
				},
				{
					name: 'DDFA',
					type: 'auto'
				},
				{
					name: 'RXN_QUANTITY',
					type: 'auto'
				},
				{
					name: 'SAB',
					type: 'auto'
				},
				{
					name: 'RXAUI',
					type: 'auto'
				},
				{
					name: 'CodeType',
					defaultValue: 'RXNORM'
				},
				{name: 'occurrences', type: 'int'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Rxnorm.getRXNORMLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			},
			hasMany: [
				{
					model: 'App.model.administration.MedicationInstruction',
					name: 'instructions',
					primaryKey: 'RXCUI',
					foreignKey: 'rxcui'
				}
			]
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveRXNORMSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			emptyText: _('medication_search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 3,
            maxLength: 255,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item {[values.TTY == "SCD" ? "lightGreenBg" : "" ]}"><b>{STR}</b><br>RxNorm: {RXCUI} NDC: {NDC} ({occurrences})</div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', me.addOccurrence);
	},

	addOccurrence: function (cmb, records) {
		if (records.length > 0 && records[0].get('RXCUI') !== '') {
			Rxnorm.addOccurrence(records[0].get('RXCUI'));
		}
	}
});

Ext.define('App.ux.combo.FloorPlanZones', {
	extend: 'App.ux.combo.ComboResettable',
	xtype: 'floorplanazonescombo',
	editable: false,
	//queryMode: 'local',
	displayField: 'title',
	valueField: 'id',
	emptyText: _('all'),
	initComponent: function () {
		if(!this.store){
			this.store = Ext.create('App.store.administration.FloorPlanZones',{
				autoLoad: false,
				remoteFilter: false
			});
		}
		this.callParent();
	}

});
Ext.define('App.ux.combo.Printers', {
    extend: 'App.ux.combo.ComboResettable',
    xtype: 'printerscombo',
    editable: false,
    queryMode: 'local',
    displayField: 'display_value',
    valueField: 'id',
    emptyText: _('select'),
    width: 200,
    stateful: true,
    stateId: 'PrinterComboState',
    store: Ext.create('App.store.administration.PrinterCombo'),
    // store: Ext.create('Ext.data.Store', {
    //     fields: [
    //         {
    //             name: 'id',
    //             type: 'string'
    //         },
    //         {name: 'name', type: 'string'},
    //         {name: 'printer_description', type: 'string'},
    //         {name: 'local', type: 'bool'},
    //         {name: 'facility_id', type: 'int'},
    //         {name: 'active', type: 'bool'},
    //         {
    //             name: 'display_value',
    //             convert: function (v, r) {
    //                 if (r.get('local')) {
    //                     return r.get('name') + ' (local)';
    //                 }
    //                 return r.get('printer_description') + ' (remote)';
    //             }
    //         }
    //     ],
    //     remoteFilter: false
    // }),

    showAllPrinters: function () {
        this.store.clearFilter();
    },
    showRemotePrinters: function () {
        this.store.clearFilter(true);
        this.store.filter({
            property: 'local',
            value: false
        });
    },
    showLocalPrinters: function () {
        this.store.clearFilter(true);
        this.store.filter({
            property: 'local',
            value: true
        });
    },
    showPrintersByFacility: function () {
        this.store.clearFilter(true);
        this.store.filter(
            {
                filterFn: function (item) {
                    return (item.get("facility_id") === app.user.facility && item.get("active")) || item.get('local');
                }
            },
            {
                property: 'local',
                value: true
            });
    }

});
Ext.define('App.model.miscellaneous.AddressBook', {
	extend: 'Ext.data.Model',
	table: {
		name: 'address_book',
		comment: 'Address Book'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string',
			len: 10
		},
		{
			name: 'fname',
			type: 'string',
			len: 80,
			index: true
		},
		{
			name: 'mname',
			type: 'string',
			len: 80,
			index: true
		},
		{
			name: 'lname',
			type: 'string',
			len: 80,
			index: true
		},
		{
			name: 'email',
			type: 'string',
			len: 100,
			index: true
		},
		{
			name: 'direct_address',
			type: 'string',
			len: 150,
			index: true
		},
		{
			name: 'url',
			type: 'string',
			len: 150
		},
		{
			name: 'organization',
			type: 'string',
			len: 160
		},
		{
			name: 'street',
			type: 'string',
			len: 180
		},
		{
			name: 'street_cont',
			type: 'string',
			len: 180
		},
		{
			name: 'city',
			type: 'string',
			len: 80,
			index: true
		},
		{
			name: 'state',
			type: 'string',
			len: 100,
			index: true
		},
		{
			name: 'zip',
			type: 'string',
			len: 15,
			index: true
		},
		{
			name: 'country',
			type: 'string',
			len: 160
		},
		{
			name: 'phone',
			type: 'string',
			len: 20,
			index: true
		},
		{
			name: 'phone2',
			type: 'string',
			len: 20
		},
		{
			name: 'mobile',
			type: 'string',
			len: 20,
			comment: 'cell phone'
		},
		{
			name: 'fax',
			type: 'string',
			len: 20
		},
		{
			name: 'fullname',
			type: 'string',
			store: false,
			convert: function(v, record){
				return record.data.fname + ' ' + record.data.mname + ' ' + record.data.lname;
			}
		},
		{
			name: 'notes',
			type: 'string',
			len: 600
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AddressBook.getContacts',
			create: 'AddressBook.addContact',
			update: 'AddressBook.updateContact',
			destroy: 'AddressBook.destroyContact'
		},
		reader: {
			totalProperty: 'totals',
			root: 'data'
		}
	}
});
Ext.define('App.model.patient.CarePlanGoal', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_care_plan_goals',
		comment: 'Patient Care Plan Goals'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'goal',
			type: 'string',
			len: 300
		},
		{
			name: 'goal_code',
			type: 'string',
			len: 20
		},
		{
			name: 'goal_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'instructions',
			type: 'string',
			len: 500
		},
		{
			name: 'plan_date',
			type: 'date',
			dateFormat: 'Y-m-d',
			dataType: 'date'
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'CarePlanGoals.getPatientCarePlanGoals',
			create: 'CarePlanGoals.addPatientCarePlanGoal',
			update: 'CarePlanGoals.updatePatientCarePlanGoal',
			destroy: 'CarePlanGoals.destroyPatientCarePlanGoal'
		}
	}
});


Ext.define('App.model.patient.CognitiveAndFunctionalStatus', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_cognitive_functional_status',
		comment: 'Patient Cognitive Functional Status'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'category',
			type: 'string',
			len: 20
		},
		{
			name: 'category_code',
			type: 'string',
			len: 20
		},
		{
			name: 'category_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'code',
			type: 'string',
			len: 20
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'status',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code',
			type: 'string',
			len: 40
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'note',
			type: 'string',
			len: 500
		},
		{
			name: 'begin_date',
			type: 'date',
			dateFormat: 'Y-m-d',
			dataType: 'date'
		},
		{
			name: 'end_date',
			type: 'date',
			dateFormat: 'Y-m-d',
			dataType: 'date'
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'CognitiveAndFunctionalStatus.getPatientCognitiveAndFunctionalStatuses',
			create: 'CognitiveAndFunctionalStatus.addPatientCognitiveAndFunctionalStatus',
			update: 'CognitiveAndFunctionalStatus.updateCognitiveAndFunctionalStatus',
			destroy: 'CognitiveAndFunctionalStatus.destroyCognitiveAndFunctionalStatus'
		}
	}
});
Ext.define('App.model.patient.SmokeStatus', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_smoke_status',
		comment: 'Patient Smoke status'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true,
			comment: 'encounter id'
		},
		{
			name: 'pid',
			type: 'int',
			index: true,
			comment: 'patient ID'
		},
		{
			name: 'status',
			type: 'string',
			len: 80
		},
		{
			name: 'status_code',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'counseling',
			type: 'bool',
			comment: '1 if counseling received'
		},
		{
			name: 'counseling_text',
			type: 'string',
			len: 80
		},
		{
			name: 'counseling_code',
			type: 'string',
			len: 20
		},
		{
			name: 'counseling_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'start_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'user ID who created the record'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'user ID who updated the record'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'SocialHistory.getSmokeStatus',
			create: 'SocialHistory.addSmokeStatus',
			update: 'SocialHistory.updateSmokeStatus',
			destroy: 'SocialHistory.destroySmokeStatus'
		}
	}
});
Ext.define('App.model.administration.ActiveProblems', {
	extend: 'Ext.data.Model',
	table: {
		name: 'activeproblems',
		comment: 'Active Problems'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Active Problems ID'
		},
		{
			name: 'code_text',
			type: 'string'
		},
		{
			name: 'code',
			type: 'string'
		}
	]

});
Ext.define('App.model.administration.Applications', {
	extend: 'Ext.data.Model',
	table: {
		name: 'applications',
		comment: 'Applications'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Applications ID'
		},
		{
			name: 'app_name',
			type: 'string',
			len: 120
		},
		{
			name: 'pvt_key',
			type: 'string',
			len: 80
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Applications.getApplications',
			create: 'Applications.addApplication',
			update: 'Applications.updateApplication',
			destroy: 'Applications.deleteApplication'
		}
	}
});
Ext.define('App.model.administration.DefaultDocuments', {
	extend: 'Ext.data.Model',
	table: {
		name: 'defaultdocuments',
		comment: 'Default Documents'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Default Documents ID'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'body',
			type: 'string'
		},
		{
			name: 'template_type',
			type: 'string'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}

	]
});
Ext.define('App.model.administration.DocumentsTemplates', {
	extend: 'Ext.data.Model',
	table: {
		name: 'documents_templates',
		comment: 'Documents Templates',
		data: 'App.data.administration.DocumentTemplates'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Documentation Templates ID'
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'title',
			type: 'string',
			len: 50
		},
		{
			name: 'template_type',
			type: 'string',
			len: 50
		},
		{
			name: 'body',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'to be replace by created_date'
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'updated_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'created_by_uid',
			type: 'int'
		},
		{
			name: 'updated_by_uid',
			type: 'int'
		},
		{
			name: 'facility_name',
			type: 'string',
			store: false
		}
	]
});
Ext.define('App.model.administration.DocumentToken', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Documentation Token ID'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'token',
			type: 'string'
		}
	]
});
Ext.define('App.model.administration.ExternalDataLoads', {
	extend: 'Ext.data.Model',
	table: {
		name: 'externaldataloads',
		comment: 'External Data Loads'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'External Data Loads ID'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'version',
			type: 'string'
		},
		{
			name: 'path',
			type: 'string'
		},
		{
			name: 'basename',
			type: 'string'
		},
		{
			name: 'codeType',
			type: 'string'
		}
	]
});
Ext.define('App.model.administration.Facility', {
	extend: 'Ext.data.Model',
	table: {
		name: 'facility',
		comment: 'Facilities'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 15
		},
		{
			name: 'name',
			type: 'string',
			len: 60,
			comment: 'Facility Name'
		},
		{
			name: 'legal_name',
			type: 'string',
			len: 60
		},
		{
			name: 'lname',
			type: 'string',
			len: 35
		},
		{
			name: 'fname',
			type: 'string',
			len: 35
		},
		{
			name: 'mname',
			type: 'string',
			len: 35
		},
		{
			name: 'facility_entity',
			type: 'string',
			len: 1
		},
		{
			name: 'attn',
			type: 'string',
			len: 80
		},
		{
			name: 'region',
			type: 'string',
			len: 45
		},
		{
			name: 'phone',
			type: 'string',
			len: 25
		},
		{
			name: 'fax',
			type: 'string',
			len: 25
		},
		{
			name: 'email',
			type: 'string',
			len: 180
		},
		{
			name: 'address',
			type: 'string',
			len: 55
		},
		{
			name: 'address_cont',
			type: 'string',
			len: 55
		},
		{
			name: 'city',
			type: 'string',
			len: 30
		},
		{
			name: 'state',
			type: 'string',
			len: 2
		},
		{
			name: 'postal_code',
			type: 'string',
			len: 15
		},
		{
			name: 'country_code',
			type: 'string',
			len: 3
		},
        {
            name: 'postal_address',
            type: 'string',
            len: 55
        },
        {
            name: 'postal_address_cont',
            type: 'string',
            len: 55
        },
        {
            name: 'postal_city',
            type: 'string',
            len: 30
        },
        {
            name: 'postal_state',
            type: 'string',
            len: 2
        },
        {
            name: 'postal_zip_code',
            type: 'string',
            len: 15
        },
        {
            name: 'postal_country_code',
            type: 'string',
            len: 3
        },
		{
			name: 'billing_location',
			type: 'bool'
		},
		{
			name: 'pos_code',
			type: 'string',
			len: 2
		},
		{
			name: 'service_loc_code',
			type: 'string',
			len: 10
		},
		{
			name: 'ein',
			type: 'string',
			len: 15
		},
		{
			name: 'clia',
			type: 'string',
			len: 15
		},
		{
			name: 'fda',
			type: 'string',
			len: 15
		},
		{
			name: 'npi',
			type: 'string',
			len: 15
		},
		{
			name: 'ess',
			type: 'string',
			len: 15
		},
        {
            name: 'external_id',
            type: 'string',
            len: 25
        },
        {
            name: 'global_id',
            type: 'string',
            len: 50
        },
		{
			name: 'coordinates',
			type: 'string',
			len: 120
		},
		{
			name: 'active',
			type: 'bool'
		},
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Facilities.getFacilities',
			create: 'Facilities.addFacility',
			update: 'Facilities.updateFacility',
			destroy: 'Facilities.deleteFacility'
		}
	},
	reader: {
		totalProperty: 'total',
		root: 'data'
	}
});

Ext.define('App.model.administration.FloorPlans', {
	extend: 'Ext.data.Model',
	table: {
		name: 'floor_plans',
		comment: 'Floor Plans',
		data: 'App.data.administration.FloorPlans'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Floor Plans ID'
		},
		{
			name: 'title',
			type: 'string',
			len: 180,
			comment: 'Floor Title'
		},
		{
			name: 'facility_id',
			type: 'int',
			comment: 'facility ID',
			index: true
		},
		{
			name: 'active',
			type: 'bool',
			comment: 'Active Floor Plan?',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'FloorPlans.getFloorPlans',
			create: 'FloorPlans.createFloorPlan',
			update: 'FloorPlans.updateFloorPlan',
			destroy: 'FloorPlans.removeFloorPlan'
		}
	}
});
Ext.define('App.model.administration.FacilityStructure', {
	extend: 'Ext.data.Model',
	table: {
		name: 'facility_structures',
		comment: 'Facilities Dept and Specialties'
	},
	fields: [
		{
			name: 'id',
			type: 'string'
		},
		{
			name: 'fid',
			type: 'int',
			index: true
		},
		{
			name: 'parentId',
			type: 'string',
			index: true
		},
		{
			name: 'foreign_id',
			type: 'int',
			index: true
		},
		{
			name: 'foreign_type',
			type: 'string',
			len: 1,
			index: true,
			comment: 'D = department S = specialty'
		},
		{
			name: 'active',
			type: 'bool'
		},
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
		{
			name: 'leaf',
			type: 'bool',
			store: false,
			convert: function(v, record){
				return record.data.foreign_type == 'S';
			}
		},
		{
			name: 'text',
			type: 'string',
			store: false
		}
	],
	idProperty: 'id',
	proxy: {
		type: 'direct',
		api: {
			read: 'Facilities.getFacilityConfigs',
			create: 'Facilities.addFacilityConfig',
			update: 'Facilities.updateFacilityConfig',
			destroy: 'Facilities.deleteFacilityConfig'
		},
		writer: {
			writeAllFields: true
		}
	}
});

Ext.define('App.model.administration.FloorPlanZones', {
	extend: 'Ext.data.Model',
	table: {
		name: 'floor_plans_zones',
		comment: 'Floor Plan Zones'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Floor Plan Zones ID'
		},
		{
			name: 'floor_plan_id',
			type: 'int',
			index: true
		},
		{
			name: 'code',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'title',
			type: 'string',
			len: 180
		},
		{
			name: 'type',
			type: 'string',
			len: 100
		},
		{
			name: 'bg_color',
			type: 'string',
			lem: 10,
			useNull: true
		},
		{
			name: 'border_color',
			type: 'string',
			lem: 10,
			useNull: true
		},
		{
			name: 'scale',
			type: 'string',
			lem: 30,
			defaultValue: 'medium'
		},
		{
			name: 'width',
			type: 'int',
			useNull: true
		},
		{
			name: 'height',
			type: 'int',
			useNull: true
		},
		{
			name: 'x',
			type: 'int'
		},
		{
			name: 'y',
			type: 'int'
		},
		{
			name: 'show_priority_color',
			type: 'bool'
		},
		{
			name: 'show_patient_preview',
			type: 'bool'
		},
		{
			name: 'is_multi_patient',
			type: 'bool'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'FloorPlans.getFloorPlanZones',
			create: 'FloorPlans.createFloorPlanZone',
			update: 'FloorPlans.updateFloorPlanZone',
			destroy: 'FloorPlans.removeFloorPlanZone'
		}
	}
});
Ext.define('App.model.administration.FormListOptions', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Form List Options ID'
		},
		{
			name: 'option_name',
			type: 'string'
		},
		{
			name: 'option_value',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'CombosData.getOptionsByListId'
		}
	}
});
Ext.define('App.model.administration.FormsList', {
	extend: 'Ext.data.Model',
	table: {
		name: 'forms_layout',
		comment: 'Form List'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'name',
			type: 'string',
			len: 80
		},
		{
			name: 'form_data',
			type: 'string',
			len: 80
		},
		{
			name: 'model',
			type: 'string',
			len: 80
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'FormLayoutBuilder.getForms'
		}
	}
});
Ext.define('App.model.administration.Globals', {
	extend: 'Ext.data.Model',
	table: {
		name: 'globals',
		comment: 'Global Settings'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'gl_name',
			type: 'string',
			comment: 'Global Setting Unique Name or Key'
		},
		{
			name: 'gl_value',
			type: 'string',
			comment: 'Global Setting Value'
		},
		{
			name: 'gl_category',
			type: 'string',
			comment: 'Category'
		},
		{
			name: 'gl_index',
			type: 'int',
			comment: 'Global Setting Index'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Globals.getGlobals',
			update: 'Globals.updateGlobals'
		},
		remoteGroup: false
	}
});
Ext.define('App.model.administration.HeadersAndFooters', {
    extend: 'Ext.data.Model',
    table: {
        name: 'headersandfooters',
        comment: 'Headers And Footers'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Headers and Footers ID'
        },
        {
            name: 'title',
            type: 'string'
        },
        {
            name: 'template_type',
            type: 'string'
        },
        {
            name: 'body',
            type: 'string'
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }

    ]
});
Ext.define('App.model.administration.ImmunizationRelations', {
    extend: 'Ext.data.Model',
    table: {
        name: 'immunizationrelations',
        comment: 'Immunization Relations'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Immunization Relations ID'
        },
        {
            name: 'immunization_id',
            type: 'int'
        },
        {
            name: 'foreign_id',
            type: 'int'
        },
        {
            name: 'code'
        },
        {
            name: 'code_text',
            type: 'string'
        },
        {
            name: 'code_type'
        }

    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'PreventiveCare.getRelations',
            create: 'PreventiveCare.addRelations',
            destroy: 'PreventiveCare.removeRelations'
        },
        writer: {
            writeAllFields: true
        }
    }
});
Ext.define('App.model.administration.InsuranceCompany', {
	extend: 'Ext.data.Model',
	table: {
		name: 'insurance_companies',
		comment: 'Insurance Companies'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 50,
			index: true,
			comment: 'use to reference the insurance to another software'
		},
		{
			name: 'name',
			type: 'string',
			len: 60
		},
		{
			name: 'attn',
			type: 'string',
			len: 60
		},
		{
			name: 'address1',
			type: 'string',
			len: 55
		},
		{
			name: 'address2',
			type: 'string',
			len: 55
		},
		{
			name: 'city',
			type: 'string',
			len: 30
		},
		{
			name: 'state',
			type: 'string',
			len: 2
		},
		{
			name: 'zip_code',
			type: 'string',
			len: 15
		},
		{
			name: 'country',
			type: 'string',
			len: 3
		},
		{
			name: 'phone1',
			type: 'string',
			len: 25
		},
		{
			name: 'phone2',
			type: 'string',
			len: 25
		},
		{
			name: 'fax',
			type: 'string',
			len: 25
		},
		{
			name: 'active',
			type: 'bool'
		},
		{
			name: 'dx_type',
			type: 'string',
			len: 5
		},

        {
            name: 'external_id',
            type: 'string',
            len: 25
        },
        {
            name: 'global_id',
            type: 'string',
            len: 50
        },

        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
		{
			name: 'address_full',
			type: 'string',
			convert: function(v, record){
				return record.data.address1 + ' ' +  record.data.address2 + ' ' +  record.data.city + ' ' +  record.data.state + ', ' +  record.data.zip_code;
			},
			store: false
		},
		{
			name: 'combo_text',
			type: 'string',
            sort: true,
			convert: function(v, record){
				// return record.data.id + ': ' + (record.data.name ? record.data.name : ' * ' ) + ' ' + (!record.data.active ? ('(' +  _('inactive') + ')') : '') ;
				return (record.data.name ? record.data.name : ' * ' ) + ' ' + (!record.data.active ? ('(' +  _('inactive') + ')') : '') ;
			},
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Insurance.getInsuranceCompanies',
			create: 'Insurance.addInsuranceCompany',
			update: 'Insurance.updateInsuranceCompany'
		},
		reader: {
			root: 'data'
		}
	}
});
Ext.define('App.model.administration.LabObservations', {
	extend: 'Ext.data.Model',
	table: {
		name: 'labs_panels',
		comment: 'Laboratory Observations'
	},
	fields: [
		{name: 'id', type: 'string', comment: 'LOINC'},
		{name: 'code_text_short', type: 'string' },
		{name: 'parent_id', type: 'int', dataType: 'bigint' },
		{name: 'parent_loinc', type: 'string', dataType: 'text' },
		{name: 'parent_name', type: 'string', dataType: 'text'  },
		{name: 'sequence', type: 'string', dataType: 'text' },
		{name: 'loinc_number', type: 'string', dataType: 'text' },
		{name: 'loinc_name', type: 'string', dataType: 'text' },
		{name: 'default_unit', type: 'string' },
		{name: 'range_start', type: 'string' },
		{name: 'range_end', type: 'string' },
		{name: 'required_in_panel', type: 'string', dataType: 'text' },
		{name: 'description', type: 'string', dataType: 'text' },
		{name: 'active', type: 'bool' }
	]
});
Ext.define('App.model.administration.Laboratories', {
	extend: 'Ext.data.Model',
	table: {
		name: 'laboratories',
		comment: 'Laboratories Grid'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Laboratory ID'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'transmit_method',
			type: 'string'
		},
		{
			name: 'email',
			type: 'string'
		},
		{
			name: 'address_id',
			type: 'int'
		},
		{
			name: 'line1',
			type: 'string',
			store: false
		},
		{
			name: 'line2',
			type: 'string',
			store: false
		},
		{
			name: 'city',
			type: 'string',
			store: false
		},
		{
			name: 'state',
			type: 'string',
			store: false
		},
		{
			name: 'zip',
			type: 'string',
			store: false
		},
		{
			name: 'plus_four',
			type: 'string',
			store: false
		},
		{
			name: 'country',
			type: 'string',
			store: false
		},
		{
			name: 'address_full',
			type: 'string',
			store: false
		},
		{
			name: 'phone_id',
			type: 'int'
		},
		{
			name: 'phone_country_code',
			type: 'string',
			store: false
		},
		{
			name: 'phone_area_code',
			type: 'string',
			store: false
		},
		{
			name: 'phone_prefix',
			type: 'string',
			store: false
		},
		{
			name: 'phone_number',
			type: 'string',
			store: false
		},
		{
			name: 'phone_full',
			type: 'string',
			store: false
		},
		{
			name: 'fax_id',
			type: 'int'
		},
		{
			name: 'fax_country_code',
			type: 'string',
			store: false
		},
		{
			name: 'fax_area_code',
			type: 'string',
			store: false
		},
		{
			name: 'fax_prefix',
			type: 'string',
			store: false
		},
		{
			name: 'fax_number',
			type: 'string',
			store: false
		},
		{
			name: 'fax_full',
			type: 'string',
			store: false
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Practice.getLaboratories',
			create: 'Practice.addLaboratory',
			update: 'Practice.updateLaboratory'
		}
	}
});
Ext.define('App.model.administration.LayoutTree', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'string'
		},
		{
			name: 'parentId',
			type: 'string'
		},
		{
			name: 'text',
			type: 'string'
		},
		{
			name: 'index',
			type: 'int',
			mapping: 'x_index'
		},
		{
			name: 'text',
			type: 'string'
		},
		{
			name: 'index',
			type: 'int'
		},
		{
			name: 'xtype',
			type: 'string'
		},
		{
			name: 'form_id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'fieldLabel',
			type: 'string'
		},
		{
			name: 'emptyText',
			type: 'string'
		},
		{
			name: 'labelWidth',
			type: 'string'
		},
		{
			name: 'hideLabel',
			type: 'bool',
			useNull: true,
			defaultValue: null
		},
		{
			name: 'layout',
			type: 'string'
		},
		{
			name: 'width',
			type: 'string'
		},
		{
			name: 'height',
			type: 'string'
		},
		{
			name: 'anchor',
			type: 'string'
		},
		{
			name: 'margin',
			type: 'string'
		},
		{
			name: 'flex',
			type: 'string'
		},
		{
			name: 'collapsible',
			type: 'bool',
			useNull: true,
			defaultValue: null
		},
		{
			name: 'checkboxToggle',
			type: 'bool',
			useNull: true,
			defaultValue: null
		},
		{
			name: 'collapsed',
			type: 'bool',
			useNull: true,
			defaultValue: null
		},
		{
			name: 'inputValue',
			type: 'string'
		},
		{
			name: 'allowBlank',
			type: 'string'
		},
		{
			name: 'value',
			type: 'string'
		},
		{
			name: 'minLength',
			type: 'string'
		},
		{
			name: 'maxLength',
			type: 'string'
		},
		{
			name: 'maxValue',
			type: 'string'
		},
		{
			name: 'minValue',
			type: 'string'
		},
		{
			name: 'columnWidth',
			type: 'string'
		},
		{
			name: 'columns',
			type: 'string'
		},
		{
			name: 'boxLabel',
			type: 'string'
		},
		{
			name: 'grow',
			type: 'bool',
			useNull: true,
			defaultValue: null
		},
		{
			name: 'growMin',
			type: 'string'
		},

		{
			name: 'growMax',
			type: 'string'
		},
		{
			name: 'increment',
			type: 'string'
		},
		{
			name: 'code',
			type: 'string'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'list_id',
			type: 'string'
		},
		{
			name: 'itemId',
			type: 'string'
		},
		{
			name: 'action',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'FormLayoutBuilder.getFormFieldsTree',
			create: 'FormLayoutBuilder.createFormField',
			update: 'FormLayoutBuilder.updateFormField',
			destroy: 'FormLayoutBuilder.removeFormField'
		},
		writer: {
			writeAllFields: true
		}
	}
});
Ext.define('App.model.administration.ListOptions', {
    extend: 'Ext.data.Model',
    table: {
        name: 'combo_lists_options',
        comment: 'Combo List Options'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'List Options ID'
        },
        {
            name: 'list_id',
            type: 'int',
	        index: true,
            comment: 'List ID'
        },
        {
            name: 'list_key',
            type: 'string',
	        index: true,
	        len: 40
        },
        {
            name: 'option_value',
            type: 'string',
            index: true,
            comment: 'Value'
        },
        {
            name: 'option_name',
            type: 'string',
            comment: 'Name'
        },
        {
            name: 'code',
            type: 'string',
            len: 15,
            index: true,
            comment: 'value code'
        },
        {
            name: 'code_type',
            type: 'string',
            len: 10,
            comment: 'CPT4 LOINC SNOMEDCT ICD9 ICD10 RXNORM'
        },
        {
            name: 'seq',
            type: 'int',
            comment: 'Sequence'
        },
        {
            name: 'notes',
            type: 'string',
            comment: 'Notes'
        },
        {
            name: 'active',
            type: 'bool',
            comment: 'Active?'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Lists.getOptions',
            create: 'Lists.addOption',
            update: 'Lists.updateOption'
        }
    }
});
Ext.define('App.model.administration.Lists', {
    extend: 'Ext.data.Model',
    table: {
        name: 'combo_lists',
        comment: 'Combo List'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'List Options ID'
        },
        {
            name: 'list_key',
            type: 'string',
            comment: 'List key for this list'
        },
        {
            name: 'title',
            type: 'string',
            comment: 'Title of the combo'
        },
        {
            name: 'active',
            type: 'bool',
            comment: 'Active?'
        },
        {
            name: 'in_use',
            type: 'bool',
            persist: false
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Lists.getLists',
            create: 'Lists.addList',
            update: 'Lists.updateList',
            destroy: 'Lists.deleteList'
        }
    }
});

Ext.define('App.model.administration.Medications', {
    extend: 'Ext.data.Model',
    fields: [
        {
            name: 'RXCUI',
            type: 'auto'
        },
        {
            name: 'CODE',
            type: 'auto'
        },
        {
            name: 'STR',
            type: 'auto'
        },
        {
            name: 'DST',
            type: 'auto'
        },
        {
            name: 'DRT',
            type: 'auto'
        },
        {
            name: 'DDF',
            type: 'auto'
        },
        {
            name: 'DDFA',
            type: 'auto'
        },
        {
            name: 'RXN_QUANTITY',
            type: 'auto'
        },
        {
            name: 'SAB',
            type: 'auto'
        },
        {
            name: 'RXAUI',
            type: 'auto'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Rxnorm.getRXNORMList'
        },
        reader: {
            totalProperty: 'totals',
            root: 'data'
        },
        filterParam: 'query',
        encodeFilters: function (filters) {
            return filters[0].value;
        }
    }
});
Ext.define('App.model.administration.Modules', {
	extend: 'Ext.data.Model',
	table: {
		name: 'modules',
		comment: 'Modules'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string',
			len: 80
		},
		{
			name: 'name',
			type: 'string',
			len: 100
		},
		{
			name: 'description',
			type: 'string'
		},
		{
			name: 'enable',
			type: 'bool'
		},
		{
			name: 'installed_version',
			type: 'string',
			len: 20
		},
		{
			name: 'sql_version',
			type: 'string',
			len: 20
		},
		{
			name: 'required_core_version',
			type: 'string',
			len: 20
		},
		{
			name: 'licensekey',
			type: 'string'
		},
		{
			name: 'localkey',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Modules.getActiveModules',
			update: 'Modules.updateModule'
		},
		writer: {
			writeAllFields: true
		}
	}
});
Ext.define('App.model.administration.ParentFields', {
    extend: 'Ext.data.Model',
    table: {
        name: 'parentfields',
        comment: 'Parent Fields'
    },
    fields: [
        {
            name: 'name',
            type: 'string'
        },
        {
            name: 'value',
            type: 'string'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'FormLayoutBuilder.getParentFields'
        }
    }
});
Ext.define('App.model.administration.Pharmacies', {
    extend: 'Ext.data.Model',
    table: {
        name: 'pharmacies',
        comment: 'Pharmacies'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'name',
            type: 'string'
        },
        {
            name: 'transmit_method',
            type: 'string'
        },
        {
            name: 'email',
            type: 'string'
        },
        {
            name: 'address_id',
            type: 'int'
        },
        {
            name: 'line1',
            type: 'string',
            store: false
        },
        {
            name: 'line2',
            type: 'string',
            store: false
        },
        {
            name: 'city',
            type: 'string',
            store: false
        },
        {
            name: 'state',
            type: 'string',
            store: false
        },
        {
            name: 'zip',
            type: 'string',
            store: false
        },
        {
            name: 'plus_four',
            type: 'string',
            store: false
        },
        {
            name: 'country',
            type: 'string',
            store: false
        },
        {
            name: 'address_full',
            type: 'string',
            store: false
        },
        {
            name: 'phone_id',
            type: 'int'
        },
        {
            name: 'phone_country_code',
            type: 'string',
            store: false
        },
        {
            name: 'phone_country_code',
            type: 'string',
            store: false
        },
        {
            name: 'phone_area_code',
            type: 'string',
            store: false
        },
        {
            name: 'phone_prefix',
            type: 'string',
            store: false
        },
        {
            name: 'phone_number',
            type: 'string',
            store: false
        },
        {
            name: 'phone_full',
            type: 'string',
            store: false
        },
        {
            name: 'fax_id',
            type: 'int'
        },
        {
            name: 'fax_country_code',
            type: 'string',
            store: false
        },
        {
            name: 'fax_area_code',
            type: 'string',
            store: false
        },
        {
            name: 'fax_prefix',
            type: 'string',
            store: false
        },
        {
            name: 'fax_number',
            type: 'string',
            store: false
        },
        {
            name: 'fax_full',
            type: 'string',
            store: false
        },
        {
            name: 'active',
            type: 'bool'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Practice.getPharmacies',
            create: 'Practice.addPharmacy',
            update: 'Practice.updatePharmacy'
        },
        writer: {
            writeAllFields: true
        }
    }
});

Ext.define('App.model.administration.PreventiveCare', {
    extend: 'Ext.data.Model',
    table: {
        name: 'preventivecare',
        comment: 'Preventive Care'
    },
    fields: [
        {name: 'id', type: 'int'},
        {name: 'pid', type: 'int'},
        {name: 'preventive_care_id', type: 'int'},
        {name: 'uid', type: 'int'},
        {name: 'description', type: 'string'},
        {name: 'age_start', type: 'string'},
        {name: 'age_end', type: 'string'},
        {name: 'sex', type: 'string'},
        {name: 'pregnant', type: 'bool'},
        {name: 'frequency', type: 'string'},
        {name: 'category_id', type: 'string'},
        {name: 'code', type: 'string'},
        {name: 'coding_system', type: 'string'},
        {name: 'dismiss', type: 'bool'},
        {name: 'frequency_type', type: 'string'},
        {name: 'reason', type: 'string'},
        {name: 'times_to_perform', type: 'string'},
        {name: 'doc_url1', type: 'string'},
        {name: 'doc_url2', type: 'string'},
        {name: 'doc_url3', type: 'string'},
        {name: 'active', type: 'bool'}
    ]

});
Ext.define('App.model.administration.PreventiveCareActiveProblems', {
	extend: 'Ext.data.Model',
	table: {
		name: 'preventivecareactiveproblems',
		comment: 'Preventive Care Active Problems'
	},
	fields: [
		{name: 'guideline_id', type: 'int'},
		{name: 'code', type: 'string'},
		{name: 'code_text', type: 'string'}
	]

});
Ext.define('App.model.administration.PreventiveCareLabs', {
	extend: 'Ext.data.Model',
	table: {
		name: 'preventivecarelabs',
		comment: 'Preventive Care Labs'
	},
	fields: [
		{name: 'id', type: 'int'},
		{name: 'value_name', type: 'string'},
		{name: 'greater_than', type: 'string'},
		{name: 'less_than', type: 'string'},
		{name: 'equal_to', type: 'string'},
		{name: 'code', type: 'string'},
		{name: 'preventive_care_id', type: 'string'}
	]

});
Ext.define('App.model.administration.PreventiveCareMedications', {
	extend: 'Ext.data.Model',
	table: {
		name: 'preventivecaremedications',
		comment: 'Preventive Care Medications'
	},
	fields: [
		{name: 'guideline_id', type: 'int'},
		{name: 'code', type: 'string'},
		{name: 'code_text', type: 'string'}
	]

});
Ext.define('App.model.administration.ProviderCredentialization', {
    extend: 'Ext.data.Model',
    table: {
        name: 'provider_credentializations'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'provider_id',
            type: 'int',
            index: true
        },
        {
            name: 'insurance_company_id',
            type: 'int',
            index: true
        },
        {
            name: 'insurance_company_name',
            type: 'string',
            store: false
        },
        {
            name: 'start_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d',
            index: true
        },
        {
            name: 'end_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d',
            index: true
        },
        {
            name: 'credentialization_notes',
            type: 'string'
        },
        {
            name: 'active',
            type: 'bool',
            store: false,
            convert: function (v, record) {
                var now = new Date();
                return record.data.start_date <= now && record.data.end_date >= now
            }
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Providers.getProviderCredentializations',
            create: 'Providers.addProviderCredentialization',
            update: 'Providers.updateProviderCredentialization',
            destroy: 'Providers.deleteProviderCredentialization'
        },
        reader: {
            root: 'data'
        }
    }
});
Ext.define('App.model.administration.ReferringProviderFacility', {
	extend: 'Ext.data.Model',
	table: {
		name: 'referring_providers_facilities'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'referring_provider_id',
			type: 'int',
			index: true
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'name',
			type: 'string',
			len: 60
		},
		{
			name: 'address',
			type: 'string',
			len: 55
		},
		{
			name: 'address_cont',
			type: 'string',
			len: 55
		},
		{
			name: 'city',
			type: 'string',
			len: 30
		},
		{
			name: 'state',
			type: 'string',
			len: 2
		},
		{
			name: 'postal_code',
			type: 'string',
			len: 15
		},
		{
			name: 'country',
			type: 'string',
			len: 3
		},
		{
			name: 'email',
			type: 'string',
			len: 180
		},
		{
			name: 'phone_number',
			type: 'string',
			len: 25
		},
		{
			name: 'fax_number',
			type: 'string',
			len: 25
		},
		{
			name: 'notes',
			type: 'string',
			len: 600
		},
		{
			name: 'is_default',
			type: 'bool'
		},
		{
			name: 'active',
			type: 'bool'
		},
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ReferringProviders.getReferringProviderFacilities',
			create: 'ReferringProviders.addReferringProviderFacility',
			update: 'ReferringProviders.updateReferringProviderFacility',
			destroy: 'ReferringProviders.deleteReferringProviderFacility'
		}
	}
});

Ext.define('App.model.administration.Services', {
	extend: 'Ext.data.Model',
	table: {
		name: 'services',
		comment: 'Services'
	},
	fields: [
		{name: 'id', type: 'string', comment: 'Services ID'},
		{name: 'code_text', type: 'string'},
		{name: 'sg_code', type: 'string'},
		{name: 'long_desc', type: 'string'},
		{name: 'code_text_short', type: 'string'},
		{name: 'code', type: 'string'},
		{name: 'code_type', type: 'string'},
		{name: 'modifier', type: 'string'},
		{name: 'units', type: 'string'},
		{name: 'fee', type: 'int'},
		{name: 'superbill', type: 'string'},
		{name: 'related_code', type: 'string'},
		{name: 'taxrates', type: 'string'},
		{name: 'active', type: 'bool'},
		{name: 'reportable', type: 'string'},
		{name: 'has_children', type: 'bool'},
		////////////////////////////////////
		{name: 'sex', type: 'string'},
		{name: 'age_start', type: 'int'},
		{name: 'age_end', type: 'int'},
		{name: 'times_to_perform', type: 'int'},
		{name: 'frequency_number', type: 'int'},
		{name: 'frequency_time', type: 'string'},
		{name: 'pregnant', type: 'bool'},
		{name: 'only_once', type: 'bool'},
		{name: 'active_problems', type: 'string'},
		{name: 'medications', type: 'string'},
		{name: 'labs', type: 'string'},
		{name: 'has_children', type: 'bool'},
		{name: 'class', type: 'string'}
	]

});
Ext.define('App.model.administration.Specialty', {
	extend: 'Ext.data.Model',
	table: {
		name: 'specialties',
		comment: 'Providers Specialties'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 5,
			index: true
		},
		{
			name: 'title',
			type: 'string',
			len: 100
		},
		{
			name: 'taxonomy',
			type: 'string',
			len: 15
		},
		{
			name: 'modality',
			type: 'string',
			len: 50
		},
        {
            name: 'medical_education',
            type: 'string'
        },
        {
            name: 'modality',
            type: 'string',
            len: 50
        },
		{
			name: 'isFda',
			type: 'bool'
		},

        {
            name: 'external_id',
            type: 'string',
            len: 25
        },
        {
            name: 'global_id',
            type: 'string',
            len: 50
        },
		{
			name: 'active',
			type: 'bool'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
        {
            name: 'text_details',
            type: 'string',
            convert: function(v, record){
                return record.data.id + ': ' + record.data.title;
            },
            store: false
        },
        {
            name: 'combo_text',
            type: 'string',
            convert: function(v, record){
                return record.data.id + ': ' + record.data.title + ' ' + (record.data.active ? ('(' + _('not_active') + ')') : '');
            },
            store: false
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Specialties.getSpecialties',
			create: 'Specialties.addSpecialty',
			update: 'Specialties.updateSpecialty'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.model.administration.EncounterTemplatePanel', {
	extend: 'Ext.data.Model',
	table: {
		name: 'template_panels'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'specialty_id',
			type: 'int',
			index: true
		},
		{
			name: 'description',
			type: 'string',
			len: 300
		},
		{
			name: 'sex',
			type: 'string',
			len: 1,
			index: true
		},
		{
			name: 'order',
			type: 'int'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'TemplatePanels.getTemplatePanels',
			create: 'TemplatePanels.createTemplatePanel',
			update: 'TemplatePanels.updateTemplatePanel',
			destroy: 'TemplatePanels.deleteTemplatePanel'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	},
	hasMany: [
		{
			model: 'App.model.administration.EncounterTemplatePanelTemplate',
			name: 'templates',
			foreignKey: 'panel_id',
			storeConfig: {
				groupField: 'template_type'
			}
		}
	]
});
Ext.define('App.model.administration.EncounterTemplatePanelTemplate', {
	extend: 'Ext.data.Model',
	table: {
		name: 'template_panels_templates'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'panel_id',
			type: 'int'
		},
		{
			name: 'template_type',
			type: 'string',
			len: 80,
			comment: 'rx lab rad etc'
		},
		{
			name: 'description',
			type: 'string',
			len: 300
		},
		{
			name: 'template_data',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'TemplatePanels.getTemplatePanelTemplates',
			create: 'TemplatePanels.createTemplatePanelTemplate',
			update: 'TemplatePanels.updateTemplatePanelTemplate',
			destroy: 'TemplatePanels.deleteTemplatePanelTemplate'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});

Ext.define('App.model.administration.TransactionLog', {
    extend: 'Ext.data.Model',
    table: {
        name: 'audit_transaction_log'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s',
            comment: 'Date of the event'
        },
        {
            name: 'pid',
            type: 'int',
            comment: 'Patient ID'
        },
        {
            name: 'eid',
            type: 'int',
            comment: 'Encounter ID'
        },
        {
            name: 'uid',
            type: 'int',
            comment: 'User ID'
        },
        {
            name: 'fid',
            type: 'int',
            comment: 'Facility ID'
        },
        {
            name: 'pk',
            type: 'string',
            comment: 'Primary Key'
        },
        {
            name: 'category',
            type: 'string',
            len: 50
        },
        {
            name: 'event',
            type: 'string',
            len: 100,
            comment: 'Event UPDATE INSERT DELETE'
        },
        {
            name: 'table_name',
            type: 'string',
            len: 60
        },
        {
            name: 'sql_string',
            type: 'string',
            dataType: 'mediumtext'
        },
        {
            name: 'data',
            type: 'array',
            dataType: 'mediumtext',
            convert: function (v, record) {
                return record.serializeEventData(v);
            },
            comment: 'serialized data'
        },
        {
            name: 'ip',
            type: 'string',
            len: 40
        },
        {
            name: 'user_title',
            type: 'string',
            store: false
        },
        {
            name: 'user_fname',
            type: 'string',
            store: false
        },
        {
            name: 'user_mname',
            type: 'string',
            store: false
        },
        {
            name: 'user_lname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_title',
            type: 'string',
            store: false
        },
        {
            name: 'patient_fname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_mname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_lname',
            type: 'string',
            store: false
        },
        {
            name: 'user_name',
            type: 'string',
            convert: function (v, record) {
                var str = '';
                if (record.data.user_lname) str += record.data.user_lname + ', ';
                if (record.data.user_fname) str += record.data.user_fname + ' ';
                if (record.data.user_mname) str += record.data.user_mname;
                return str;
            },
            store: false
        },
        {
            name: 'patient_name',
            type: 'string',
            convert: function (v, record) {
                var str = '';
	            if (record.data.patient_lname) str += record.data.patient_lname + ', ';
                if (record.data.patient_fname) str += record.data.patient_fname + ' ';
                if (record.data.patient_mname) str += record.data.patient_mname;
                return str;
            },
            store: false
        },
        {
            name: 'valid',
            type: 'bool',
            store: false
        },
        {
            name: 'checksum',
            type: 'string',
            len: 80
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'TransactionLog.getTransactionLog'
        },
        reader: {
            root: 'data'
        }
    },
    serializeEventData: function (data) {
        var str = '';
        Ext.Object.each(data, function (key, value) {
            str += key + ' - ' + value + '<br>';
        });
        return str;
    }
});

Ext.define('App.model.administration.EncounterEventHistory', {
    extend: 'Ext.data.Model',
    table: {
        name: 'encounter_event_history',
        comment: 'Encounter Event History'
    },
    fields: [
        {
            name: 'c',
            type: 'int',
            comment: 'Encounter Event History ID'
        },
        {
            name: 'eid',
            type: 'int',
            comment: 'Encounter ID',
            index: true
        },
        {
            name: 'pid',
            type: 'int',
            comment: 'Patient ID',
            index: true
        },
        {
            name: 'uid',
            type: 'int',
            comment: 'User ID',
            index: true
        },
        {
            name: 'fid',
            type: 'int',
            comment: 'Facility ID',
            index: true
        },
        {
            name: 'event',
            type: 'string',
            len: 200,
            comment: 'Event description'
        },
        {
            name: 'user_title',
            type: 'string',
            store: false
        },
        {
            name: 'user_fname',
            type: 'string',
            store: false
        },
        {
            name: 'user_mname',
            type: 'string',
            store: false
        },
        {
            name: 'user_lname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_title',
            type: 'string',
            store: false
        },
        {
            name: 'patient_fname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_mname',
            type: 'string',
            store: false
        },
        {
            name: 'patient_lname',
            type: 'string',
            store: false
        },
        {
            name: 'user_name',
            type: 'string',
            store: false,
            convert: function(v, record){
                var str = '';
                if(record.data.user_title) str += record.data.user_title + ' ';
                if(record.data.user_fname) str += record.data.user_fname + ' ';
                if(record.data.user_mname) str += record.data.user_mname + ' ';
                if(record.data.user_lname) str += record.data.user_lname;
                return str;
            }
        },
        {
            name: 'patient_name',
            type: 'string',
            store: false,
            convert: function(v, record){
                var str = '';
                if(record.data.patient_title) str += record.data.patient_title + ' ';
                if(record.data.patient_fname) str += record.data.patient_fname + ' ';
                if(record.data.patient_mname) str += record.data.patient_mname + ' ';
                if(record.data.patient_lname) str += record.data.patient_lname;
                return str;
            }
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s',
            comment: 'Date of the event'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'EncounterEventHistory.getLogs',
            create: 'EncounterEventHistory.setLog',
            update: 'EncounterEventHistory.setLog'
        },
        reader: {
            totalProperty: 'totals',
            root: 'data'
        }
    }
});

Ext.define('App.model.administration.XtypesComboModel', {
    extend: 'Ext.data.Model',
    table: {
        name: 'xtypescombo',
        comment: 'XTYPE Combos'
    },
    fields: [
        {
            name: 'id',
            type: 'string'
        },
        {
            name: 'name',
            type: 'string'
        },
        {
            name: 'value',
            type: 'string'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'CombosData.getFiledXtypes'
        }
    },
    autoLoad: true
});
Ext.define('App.model.administration.User', {
	extend: 'Ext.data.Model',
	table: {
		name: 'users',
		comment: 'User accounts'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'global_id',
			type: 'string',
			len: 40
		},
		{
			name: 'external_id',
			type: 'string',
			len: 80
		},
		{
			name: 'code',
			type: 'string',
			len: 40
		},
		{
			name: 'providerCode',
			type: 'string',
			len: 40
		},
		{
			name: 'role_id',
			type: 'int',
			comment: 'acl_user_roles relation'
		},
		{
			name: 'facility_id',
			type: 'int',
			comment: 'default facility',
			index: true
		},
		{
			name: 'department_id',
			type: 'int',
			comment: 'default department',
			index: true
		},
		{
			name: 'warehouse_id',
			type: 'int',
			comment: 'default warehouse'
		},
		{
			name: 'username',
			type: 'string',
			comment: 'username',
			len: 40,
			index: true
		},
		{
			name: 'password',
			type: 'string',
			comment: 'password',
			dataType: 'blob',
			encrypt: true
		},
		{
			name: 'pwd_history1',
			type: 'string',
			comment: 'first password history backwards',
			dataType: 'blob',
			encrypt: true
		},
		{
			name: 'pwd_history2',
			type: 'string',
			comment: 'second password history backwards',
			dataType: 'blob',
			encrypt: true
		},
		{
			name: 'password_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'password_force_reset',
			type: 'bool'
		},
		{
			name: 'title',
			type: 'string',
			comment: 'title (Mr. Mrs.)',
			len: 10
		},
		{
			name: 'fname',
			type: 'string',
			comment: 'first name',
			len: 80,
			index: true
		},
		{
			name: 'mname',
			type: 'string',
			comment: 'middle name',
			len: 80,
			index: true
		},
		{
			name: 'lname',
			type: 'string',
			comment: 'last name',
			len: 120,
			index: true
		},
		{
			name: 'signature',
			type: 'string',
			len: 100
		},
		{
			name: 'pin',
			type: 'string',
			comment: 'pin number',
			useNull: true,
			len: 10
		},
		{
			name: 'npi',
			type: 'string',
			comment: 'National Provider Identifier',
			len: 15,
			index: true
		},
		{
			name: 'lic',
			type: 'string',
			len: 80
		},
		{
			name: 'ess',
			type: 'string',
			len: 10
		},
		{
			name: 'upin',
			type: 'string',
			len: 80
		},
		{
			name: 'fedtaxid',
			type: 'string',
			comment: 'federal tax id',
			len: 80
		},
		{
			name: 'feddrugid',
			type: 'string',
			comment: 'federal drug id',
			len: 80
		},
		{
			name: 'statedrugid',
			type: 'string',
			comment: 'state tax id',
			len: 80
		},
		{
			name: 'notes',
			type: 'string',
			len: 300
		},
		{
			name: 'email',
			type: 'string',
			len: 150,
			index: true
		},
		{
			name: 'specialty',
			type: 'array',
			comment: 'specialty',
			len: 80
		},
		{
			name: 'medical_education',
			type: 'string',
			len: 1
		},
		{
			name: 'taxonomy',
			type: 'string',
			comment: 'taxonomy',
			defaultValue: '207Q00000X',
			len: 15,
			index: true
		},
		{
			name: 'calendar',
			type: 'bool',
			comment: 'has calendar? 0=no 1=yes',
			index: true
		},
		{
			name: 'authorized',
			type: 'bool'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		},
		{
			name: 'direct_address',
			type: 'string',
			comment: 'direct_address',
			len: 150,
			index: true
		},
		{
			name: 'city',
			type: 'string',
			len: 55
		},
		{
			name: 'state',
			type: 'string',
			len: 55
		},
		{
			name: 'postal_code',
			type: 'string',
			len: 15
		},
		{
			name: 'street',
			type: 'string',
			len: 55
		},
		{
			name: 'street_cont',
			type: 'string',
			len: 55
		},
		{
			name: 'country_code',
			type: 'string',
			len: 15
		},
		{
			name: 'phone',
			type: 'string',
			len: 80
		},
		{
			name: 'mobile',
			type: 'string',
			len: 80
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'create user ID'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'update user ID'
		},
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'is_attending',
			type: 'bool',
			index: true
		},
		{
			name: 'is_resident',
			type: 'bool',
			index: true
		},
		{
			name: 'default_attending',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'fullname',
			type: 'string',
			comment: 'title full name',
			store: false
		},
		{
			name: 'shortname',
			type: 'string',
			comment: 'title and last name',
			store: false
		},
		{
			name: 'role',
			type: 'string',
			store: false
		},
		{
			name: 'department',
			type: 'string',
			store: false
		},
		{
			name: 'authy_id',
			type: 'string',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'User.getUsers',
			create: 'User.addUser',
			update: 'User.updateUser'
		},
		reader: {
			root: 'data'
		}
	},
	hasMany: [
		{
			model: 'App.model.Phones',
			name: 'phones',
			primaryKey: 'id',
			foreignKey: 'use_id'
		},
		{
			model: 'App.model.Address',
			name: 'address',
			primaryKey: 'id',
			foreignKey: 'use_id'
		}
	]
});

Ext.define('App.model.administration.IpAccessLog', {
	extend: 'Ext.data.Model',
	table: {
		name: 'ip_access_log'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'ip',
			type: 'string',
			len: 40
		},
		{
			name: 'country_code',
			type: 'string',
			len: 130
		},
		{
			name: 'event',
			type: 'string',
			len: 10
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'IpAccessRules.getIpAccessLogs'
		},
		reader: {
			totalProperty: 'total',
			root: 'data'
		}
	}
});
Ext.define('App.model.administration.IpAccessRule', {
	extend: 'Ext.data.Model',
	table: {
		name: 'ip_access_rules'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'ip',
			type: 'string',
			len: 40
		},
		{
			name: 'ip_from',
			type: 'string',
			len: 40
		},
		{
			name: 'ip_to',
			type: 'string',
			len: 40
		},
		{
			name: 'country_code',
			type: 'string',
			len: 50
		},
        {
            name: 'country_name',
            type: 'string',
            len: 100
        },
        {
            name: 'country',
            type: 'string',
            store: false,
            convert: function (v, record) {
                return record.data.country_name + '('+record.data.country_code+')';
            }
        },
		{
			name: 'rule',
			type: 'string',
			len: 10
		},
		{
			name: 'weight',
			type: 'int',
			index: true
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'IpAccessRules.getIpAccessRules',
			create: 'IpAccessRules.createIpAccessRule',
			update: 'IpAccessRules.updateIpAccessRule'
		},
        writer: {
            writeAllFields: true
        },
		reader: {
			totalProperty: 'total',
			root: 'data'
		}
	}
});

Ext.define('App.model.administration.CronJob', {
    extend: 'Ext.data.Model',
    table: {
        name: 'cronjob',
        comment: 'Holds all the available scripts that runs on the background.'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'name',
            type: 'string',
            dataType: 'varchar',
            len: 45
        },
        {
            name: 'filename',
            type: 'string',
            dataType: 'varchar',
            len: 45
        },
        {
            name: 'minute',
            dataType: 'varchar',
            len: 3
        },
        {
            name: 'hour',
            dataType: 'varchar',
            len: 3
        },
        {
            name: 'month_day',
            dataType: 'varchar',
            len: 3
        },
        {
            name: 'month',
            dataType: 'varchar',
            len: 3
        },
        {
            name: 'week_day',
            dataType: 'varchar',
            len: 3
        },
        {
            name: 'pid',
            dataType: 'varchar',
            len: 10
        },
        {
            name: 'running',
            type: 'bool'
        },
        {
            name: 'last_run_date',
            type: 'date'
        },
        {
            name: 'elapsed',
            type: 'string',
            store: false
        },
        {
            name: 'timeout',
            type: 'int'
        },
        {
            name: 'params',
            type: 'string',
            len: 50
        },
        {
            name: 'active',
            type: 'bool'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'CronJob.getCronJob',
            update: 'CronJob.updateCronJob'
        },
        reader: {
            root: 'data'
        }
    }
});

Ext.define('App.model.miscellaneous.OfficeNotes', {
	extend: 'Ext.data.Model',
	table: {
		name: 'office_notes',
		comment: 'Office Notes'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Office Notes ID'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'body',
			type: 'string'
		},
		{
			name: 'user',
			type: 'string'
		},
		{
			name: 'facility_id',
			type: 'string'
		},
		{
			name: 'activity',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'OfficeNotes.getOfficeNotes',
			create: 'OfficeNotes.addOfficeNotes',
			update: 'OfficeNotes.updateOfficeNotes'
		}
	}
});
Ext.define('App.model.miscellaneous.Amendment', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_amendments'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'portal_id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'amendment_type',
			type: 'string',
			len: 1,
			comment: 'P = patient or D = Doctor or O = organization'
		},
		{
			name: 'amendment_data',
			type: 'array',
			dataType: 'mediumtext'
		},
		{
			name: 'amendment_message',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'amendment_status',
			type: 'string',
			len: 1,
			comment: 'W = waiting or A = approved or D = denied or C = canceled'
		},
		{
			name: 'response_message',
			type: 'string',
			len: 500,
			comment: 'denial or approval reason'
		},
		{
			name: 'is_read',
			type: 'bool'
		},
		{
			name: 'is_viewed',
			type: 'bool'
		},
		{
			name: 'is_synced',
			type: 'bool'
		},
		{
			name: 'assigned_to_uid',
			type: 'int'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'response_uid',
			type: 'int'
		},
		{
			name: 'approved_by',
			type: 'string',
			len: 80
		},
		{
			name: 'assigned_date',
			type: 'date',
			comment: 'Assigned date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'response_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'cancel_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'cancel_by',
			type: 'string',
			len: 15,
			comment: 'U for user P patient and ID'
		},
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'responded_by',
			type: 'string',
			store: false,
			convert: function(v, record){
				if(record.data.amendment_status === 'A' || record.data.amendment_status === 'D'){
					return record.data.response_title + ' ' + record.data.response_fname + ' ' + record.data.response_mname + ' ' + record.data.response_lname;
				}else{
					return '';
				}
			}
		},
		{
			name: 'response_title',
			type: 'string',
			store: false
		},
		{
			name: 'response_fname',
			type: 'string',
			store: false
		},
		{
			name: 'response_mname',
			type: 'string',
			store: false
		},
		{
			name: 'response_lname',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Amendments.getAmendments',
			create: 'Amendments.addAmendment',
			update: 'Amendments.updateAmendment'
		},
		reader: {
			root: 'data'
		}
	}
});
Ext.define('App.model.account.VoucherLine', {
	extend: 'Ext.data.Model',
	table: {
		name: 'accvoucherline',
		comment: 'Voucher / Receipt'
	},
	//	triggers:[
	//		{
	//			name: 'onVoucherLineDelete',
	//			time: 'after',
	//			event: 'delete',
	//			definition:'UPDATE accvoucher SET `status` = \'changed\' WHERE id = {voucherId} AND date = [new Date()]'
	//		},
	//		{
	//			name: 'onVoucherLineInsert',
	//			time: 'AFTER',
	//			event: 'INSERT',
	//			definition:'UPDATE accvoucher SET `status` = \'changed\' WHERE id = {voucherId}'
	//		}
	//	],
	fields: [
		{name: 'id', type: 'int'},
		{name: 'createUid', type: 'int'},
		{name: 'createDate', type: 'date', dateFormat: 'Y-m-d H:i:s'},
		{name: 'writeUid', type: 'int'},
		{name: 'writeDate', type: 'date', dateFormat: 'Y-m-d H:i:s'},

		{name: 'voucherId', type: 'int', comment: 'Voucher'},
		{name: 'accountId', type: 'int', comment: 'Account'},
		{name: 'moveLineId', type: 'int', comment: 'Journal Item'},
		//      {name: 'companyId',             type: 'int', comment:'Company (Not Used)'},
		//      {name: 'accountAnalyticId',     type: 'int', comment:'Analytic Account (Not Used)'},

		{name: 'reconcile', type: 'bool', defaultValue: false, comment: 'Full Reconcile'},

		{name: 'code', type: 'string', comment: 'COPAY/CPT/HCPCS/SKU codes'},
		{name: 'name', type: 'string', comment: 'Description'},
		{name: 'type', type: 'string', comment: 'debit/credit'},

		{name: 'amountUnreconciled', type: 'float', comment: 'Open Balance'},
		{name: 'amountUntax', type: 'float', comment: 'Untax Amount'},
		{name: 'amountOriginal', type: 'float', comment: 'Default Amount'},
		{name: 'amount', type: 'float', comment: 'Amount'}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AccVoucher.getVoucherLines',
			create: 'AccVoucher.addVoucherLine',
			update: 'AccVoucher.updateVoucherLine',
			destroy: 'AccVoucher.destroyVoucherLine'
		}
	},
	associations: [
		{
			type: 'belongsTo',
			model: 'App.model.account.Voucher',
			foreignKey: 'voucherId',
			setterName: 'setVoucher',
			getterName: 'getVoucher'
		}
	]
});
Ext.define('App.model.account.Voucher', {
	extend: 'Ext.data.Model',
	table: {
		name: 'accvoucher',
		comment: 'Voucher / Receipt'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'createUid',
			type: 'int'},
		{
			name: 'createDate',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'},
		{
			name: 'writeUid',
			type: 'int'},
		{
			name: 'writeDate',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'},
		{
			name: 'dateDue',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'Due Date'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'Date'
		},
		{
			name: 'encounterId',
			type: 'int',
			comment: 'Encounter'
		},
		{
			name: 'accountId',
			type: 'int',
			comment: 'Account'},
		{
			name: 'journalId',
			type: 'int',
			comment: 'Journal'},
		{
			name: 'moveId',
			type: 'int',
			comment: 'Account Entry'
		},
		{
			name: 'active',
			type: 'bool',
			defaultValue: true,
			comment: 'Active?'
		},
		{
			name: 'comment',
			type: 'string',
			comment: 'Comment'
		},
		{
			name: 'reference',
			type: 'string',
			comment: 'Ref'
		},
		{
			name: 'number',
			type: 'string',
			comment: 'Number'
		},
		{
			name: 'notes',
			type: 'string',
			mapping: 'narration',
			comment: 'Notes'
		},
		{
			name: 'status',
			type: 'string',
			mapping: 'state',
			comment: 'Status'
		},
		{
			name: 'type',
			type: 'string',
			comment: 'visit/product/office'
		},
		{
			name: 'amount',
			type: 'float',
			defaultValue: 0.00,
			comment: 'Total Amount'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AccVoucher.getVoucher',
			create: 'AccVoucher.addVoucher',
			update: 'AccVoucher.updateVoucher',
			destroy: 'AccVoucher.destroyVoucher'
		}
	},
	hasMany: [
		{
			model: 'App.model.account.VoucherLine',
			name: 'voucherlines',
			foreignKey: 'voucherId'
		}
	]
});
Ext.define('App.model.documents.AdministrativeDocuments', {
	extend: 'Ext.data.Model',
	table: {
		name: 'administrative_documents',
		comment: 'Administrative Documents Storage'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'belongs_to',
			type: 'string',
			len: 75,
			useNull: true,
			index: true
		},
		{
			name: 'belongs_to_id',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'docType',
			type: 'string',
			index: true
		},
		{
			name: 'docTypeCode',
			type: 'string',
			len: 20,
			index: true
		},
		{
			name: 'filesystem_id',
			type: 'int',
			index: true
		},
		{
			name: 'path',
			type: 'string'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'MEDIUMTEXT'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'hash',
			type: 'string'
		},
		{
			name: 'encrypted',
			type: 'bool',
			defaultValue: 0
		},
		{
			name: 'entered_in_error',
			type: 'bool',
			defaultValue: 0
		},
		{
			name: 'error_note',
			type: 'string',
			len: 300
		},
		{
			name: 'groupDate',
			type: 'string',
			store: false,
			convert: function(v, record){
				return Ext.util.Format.date(record.get('date'), g('date_display_format'));
			}
		},
		{
			name: 'document_instance',
			type: 'string',
			len: 10
		},
		{
			name: 'document',
			type: 'string',
			dataType: 'longblob'
		},
		{
			name: 'document_id',
			type: 'int'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DocumentHandler.getAdministrativeDocuments',
			create: 'DocumentHandler.addAdministrativeDocument',
			update: 'DocumentHandler.updateAdministrativeDocument'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});


Ext.define('App.model.fees.Billing',
	{
		extend: 'Ext.data.Model',
		table: {
			name: 'billing',
			comment: 'Billing'
		},
		fields: [
			{
				name: 'eid',
				type: 'int '
			},
			{
				name: 'pid',
				type: 'int'
			},
			{
				name: 'patientName',
				type: 'string'
			},
			{
				name: 'primaryProvider',
				type: 'string'
			},
			{
				name: 'encounterProvider',
				type: 'string'
			},
			{
				name: 'supervisorProvider',
				type: 'string'
			},
			{
				name: 'facility',
				type: 'string'
			},
			{
				name: 'billing_facility',
				type: 'string'
			},
			{
				name: 'service_date',
				type: 'date'
			},
			{
				name: 'close_date',
				type: 'date'
			},
			{
				name: 'billing_stage',
				type: 'int'
			},
			{
				name: 'dxCodes',
				type: 'auto'
			}
		],
		proxy: {
			type: 'direct',
			api: {
				read: 'Fees.getFilterEncountersBillingData'
			},
			reader: {
				root: 'encounters',
				totalProperty: 'totals'
			}
		}

	});

Ext.define('App.model.patient.EncounterService', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_services'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'reference_type',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'reference_id',
			type: 'int',
			index: true
		},
		{
			name: 'billing_reference',
			type: 'string',
			len: 20,
			index: true
		},
		{
			name: 'code',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'code_type',
			type: 'string',
			len: 40
		},
		{
			name: 'code_text',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'units',
			type: 'int',
			len: 5
		},
		{
			name: 'tooth',
			type: 'string',
			len: 10
		},
		{
			name: 'surface',
			type: 'string',
			len: 5
		},
		{
			name: 'cavity_quadrant',
			type: 'string',
			len: 2
		},
		{
			name: 'modifiers',
			type: 'array'
		},
		{
			name: 'dx_group_id',
			type: 'int'
		},
		{
			name: 'dx_pointers',
			type: 'array'
		},
		{
			name: 'status',
			type: 'string',
			len: 20
		},
        {
            name: 'financial_class',
            type: 'string',
            len: 4
        },
        {
            name: 'financial_name',
            type: 'string',
            len: 4,
            store: false
        },
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'date_create',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'date_update',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Services.getEncounterServices',
			create: 'Services.addEncounterService',
			update: 'Services.updateEncounterService',
			destroy: 'Services.removeEncounterService'
		},
		writer: {
			writeAllFields: true
		}
	}
});
// Created dynamically by Matcha::connect
// Create date: 2013-07-28 18:48:17

Ext.define('App.model.patient.Vitals', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_vitals'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Vital ID'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'auth_uid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'weight_lbs',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'weight_kg',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'height_in',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'height_cm',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'bp_systolic',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'bp_diastolic',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'pulse',
			type: 'int',
			useNull: true,
			len: 10,
			convert: function(v){
				return v > 0 ? v : null;
			}
		},
		{
			name: 'respiration',
			type: 'int',
			useNull: true,
			len: 10,
			convert: function(v){
				return v > 0 ? v : null;
			}
		},
		{
			name: 'temp_f',
			type: 'float',
			useNull: true,
			len: 10,
			convert: function(v){
				return v > 0 ? v : null;
			}
		},
		{
			name: 'temp_c',
			type: 'float',
			useNull: true,
			len: 10,
			convert: function(v){
				return v > 0 ? v : null;
			}
		},
		{
			name: 'temp_location',
			type: 'string',
			len: 40
		},
		{
			name: 'oxygen_saturation',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'oxygen_inhaled_concentration',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'head_circumference_in',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'head_circumference_cm',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'waist_circumference_in',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'waist_circumference_cm',
			type: 'float',
			useNull: true,
			len: 10
		},
		{
			name: 'bmi',
			type: 'float',
			useNull: true,
			len: 10,
			convert: function(v){
				return v > 0 ? v : null;
			}
		},
		{
			name: 'bmi_status',
			type: 'string',
			useNull: true,
			len: 20
		},
		{
			name: 'other_notes',
			type: 'string',
			len: 600
		},
		{
			name: 'bp_systolic_normal',
			type: 'int',
			defaultValue: 120,
			store: false
		},
		{
			name: 'bp_diastolic_normal',
			type: 'int',
			defaultValue: 80,
			store: false
		},
		{
			name: 'group_field',
			type: 'string',
			store: false,
			convert: function(v, record){
				return record.get('eid') === app.patient.eid ? 'Encounter Vitals' : 'History';
			}
		},
		{
			name: 'administer_by',
			type: 'string',
			store: false
		},
		{
			name: 'authorized_by',
			type: 'string',
			store: false
		},
		{
			name: 'patient_record_number',
			type: 'string',
			store: false
		},
		{
			name: 'patient_fname',
			type: 'string',
			store: false
		},
		{
			name: 'patient_mname',
			type: 'string',
			store: false
		},
		{
			name: 'patient_lname',
			type: 'string',
			store: false
		},
		{
			name: 'administer_fname',
			type: 'string',
			store: false
		},
		{
			name: 'administer_mname',
			type: 'string',
			store: false
		},
		{
			name: 'administer_lname',
			type: 'string',
			store: false
		},
		{
			name: 'authorized_fname',
			type: 'string',
			store: false
		},
		{
			name: 'authorized_mname',
			type: 'string',
			store: false
		},
		{
			name: 'authorized_name',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Vitals.getVitals',
			create: 'Vitals.addVitals',
			update: 'Vitals.updateVitals',
			destroy: 'Vitals.removeVitals'
		},
		writer: {
			writeAllFields: true
		}
	}
});

Ext.define('App.model.patient.HCFAOptions', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_1500_options'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'employment_related',
			type: 'bool'
		},
		{
			name: 'auto_accident',
			type: 'bool'
		},
		{
			name: 'state',
			type: 'string',
			len: 80
		},
		{
			name: 'other_accident',
			type: 'bool'
		},
		{
			name: 'similar_illness_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'unable_to_work_from',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'unable_to_work_to',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'hops_date_to',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'out_lab_used',
			type: 'bool'
		},
		{
			name: 'amount_charges',
			type: 'string',
			len: 10
		},
		{
			name: 'medicaid_resubmission_code',
			type: 'string',
			len: 15
		},
		{
			name: 'medicaid_original_reference_number',
			type: 'string',
			len: 60
		},
		{
			name: 'prior_authorization_number',
			type: 'string',
			len: 60
		},
		{
			name: 'replacement_claim',
			type: 'bool'
		},
		{
			name: 'notes',
			type: 'string',
			dataType: 'text'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			update: 'Encounter.updateHCFA'
		}
	},
	belongsTo: {
		model: 'App.model.patient.Encounter',
		foreignKey: 'eid'
	}
});
Ext.define('App.model.fees.PaymentTransactions',
	{
		extend: 'Ext.data.Model',
		table: {
			name: 'paymenttransactions',
			comment: 'Payment Transactions'
		},
		fields: [],
		proxy: {
			type: 'direct',
			api: {
				read: 'Fees.getPaymentsBySearch'
			},
			reader: {
				root: 'rows',
				totalProperty: 'totals'
			}
		}
	});
Ext.define('App.model.patient.ReviewOfSystems', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_review_of_systems',
		comment: 'Review of system'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'weight_change',
			type: 'bool'
		},
		{
			name: 'weakness',
			type: 'bool'
		},
		{
			name: 'fatigue',
			type: 'bool'
		},
		{
			name: 'anorexia',
			type: 'bool'
		},
		{
			name: 'fever',
			type: 'bool'
		},
		{
			name: 'chills',
			type: 'bool'
		},
		{
			name: 'night_sweats',
			type: 'bool'
		},
		{
			name: 'insomnia',
			type: 'bool'
		},
		{
			name: 'irritability',
			type: 'bool'
		},
		{
			name: 'heat_or_cold',
			type: 'bool'
		},
		{
			name: 'intolerance',
			type: 'bool'
		},
		{
			name: 'change_in_vision',
			type: 'bool'
		},
		{
			name: 'eye_pain',
			type: 'bool'
		},
		{
			name: 'family_history_of_glaucoma',
			type: 'bool'
		},
		{
			name: 'irritation',
			type: 'bool'
		},
		{
			name: 'redness',
			type: 'bool'
		},
		{
			name: 'excessive_tearing',
			type: 'bool'
		},
		{
			name: 'double_vision',
			type: 'bool'
		},
		{
			name: 'blind_spots',
			type: 'bool'
		},
		{
			name: 'photophobia',
			type: 'bool'
		},
		{
			name: 'hearing_loss',
			type: 'bool'
		},
		{
			name: 'discharge',
			type: 'bool'
		},
		{
			name: 'pain',
			type: 'bool'
		},
		{
			name: 'vertigo',
			type: 'bool'
		},
		{
			name: 'tinnitus',
			type: 'bool'
		},
		{
			name: 'frequent_colds',
			type: 'bool'
		},
		{
			name: 'sore_throat',
			type: 'bool'
		},
		{
			name: 'sinus_problems',
			type: 'bool'
		},
		{
			name: 'post_nasal_drip',
			type: 'bool'
		},
		{
			name: 'nosebleed',
			type: 'bool'
		},
		{
			name: 'snoring',
			type: 'bool'
		},
		{
			name: 'apnea',
			type: 'bool'
		},
		{
			name: 'breast_mass',
			type: 'bool'
		},
		{
			name: 'abnormal_mammogram',
			type: 'bool'
		},
		{
			name: 'biopsy',
			type: 'bool'
		},
		{
			name: 'cough',
			type: 'bool'
		},
		{
			name: 'sputum',
			type: 'bool'
		},
		{
			name: 'shortness_of_breath',
			type: 'bool'
		},
		{
			name: 'wheezing',
			type: 'bool'
		},
		{
			name: 'hemoptysis',
			type: 'bool'
		},
		{
			name: 'asthma',
			type: 'bool'
		},
		{
			name: 'copd',
			type: 'bool'
		},
		{
			name: 'thyroid_problems',
			type: 'bool'
		},
		{
			name: 'diabetes',
			type: 'bool'
		},
		{
			name: 'abnormal_blood_test',
			type: 'bool'
		},
		{
			name: 'chest_pain',
			type: 'bool'
		},
		{
			name: 'palpitation',
			type: 'bool'
		},
		{
			name: 'syncope',
			type: 'bool'
		},
		{
			name: 'pnd',
			type: 'bool'
		},
		{
			name: 'doe',
			type: 'bool'
		},
		{
			name: 'orthopnea',
			type: 'bool'
		},
		{
			name: 'peripheral',
			type: 'bool'
		},
		{
			name: 'edema',
			type: 'bool'
		},
		{
			name: 'leg_pain_cramping',
			type: 'bool'
		},
		{
			name: 'arrythmia',
			type: 'bool'
		},
		{
			name: 'heart_problem',
			type: 'bool'
		},
		{
			name: 'history_of_heart_murmur',
			type: 'bool'
		},
		{
			name: 'polyuria',
			type: 'bool'
		},
		{
			name: 'polydypsia',
			type: 'bool'
		},
		{
			name: 'dysuria',
			type: 'bool'
		},
		{
			name: 'hematuria',
			type: 'bool'
		},
		{
			name: 'frequency',
			type: 'bool'
		},
		{
			name: 'urgency',
			type: 'bool'
		},
		{
			name: 'utis',
			type: 'bool'
		},
		{
			name: 'incontinence',
			type: 'bool'
		},
		{
			name: 'renal_stones',
			type: 'bool'
		},
		{
			name: 'hesitancy',
			type: 'bool'
		},
		{
			name: 'dribbling',
			type: 'bool'
		},
		{
			name: 'stream',
			type: 'bool'
		},
		{
			name: 'nocturia',
			type: 'bool'
		},
		{
			name: 'erections',
			type: 'bool'
		},
		{
			name: 'ejaculations',
			type: 'bool'
		},
		{
			name: 'cancer',
			type: 'bool'
		},
		{
			name: 'psoriasis',
			type: 'bool'
		},
		{
			name: 'acne',
			type: 'bool'
		},
		{
			name: 'disease',
			type: 'bool'
		},
		{
			name: 'other',
			type: 'bool'
		},
		{
			name: 'anemia',
			type: 'bool'
		},
		{
			name: 'hiv',
			type: 'bool'
		},
		{
			name: 'f_h_blood_problems',
			type: 'bool'
		},
		{
			name: 'hai_status',
			type: 'bool'
		},
		{
			name: 'allergies',
			type: 'bool'
		},
		{
			name: 'bleeding_problems',
			type: 'bool'
		},
		{
			name: 'frequent_illness',
			type: 'bool'
		},
		{
			name: 'dysphagia',
			type: 'bool'
		},
		{
			name: 'heartburn',
			type: 'bool'
		},
		{
			name: 'food_intolerance',
			type: 'bool'
		},
		{
			name: 'belching',
			type: 'bool'
		},
		{
			name: 'bloating',
			type: 'bool'
		},
		{
			name: 'flatulence',
			type: 'bool'
		},
		{
			name: 'nausea',
			type: 'bool'
		},
		{
			name: 'vomiting',
			type: 'bool'
		},
		{
			name: 'jaundice',
			type: 'bool'
		},
		{
			name: 'h_o_hepatitis',
			type: 'bool'
		},
		{
			name: 'hematemesis',
			type: 'bool'
		},
		{
			name: 'diarrhea',
			type: 'bool'
		},
		{
			name: 'hematochezia',
			type: 'bool'
		},
		{
			name: 'changed_bowel',
			type: 'bool'
		},
		{
			name: 'constipation',
			type: 'bool'
		},
		{
			name: 'female_g',
			type: 'bool'
		},
		{
			name: 'female_p',
			type: 'bool'
		},
		{
			name: 'female_ap',
			type: 'bool'
		},
		{
			name: 'lmp',
			type: 'bool'
		},
		{
			name: 'female_lc',
			type: 'bool'
		},
		{
			name: 'menopause',
			type: 'bool'
		},
		{
			name: 'flow',
			type: 'bool'
		},
		{
			name: 'abnormal_hair_growth',
			type: 'bool'
		},
		{
			name: 'menarche',
			type: 'bool'
		},
		{
			name: 'symptoms',
			type: 'bool'
		},
		{
			name: 'f_h_female_hirsutism_striae',
			type: 'bool'
		},
		{
			name: 'anxiety',
			type: 'bool'
		},
		{
			name: 'depression',
			type: 'bool'
		},
		{
			name: 'psychiatric_medication',
			type: 'bool'
		},
		{
			name: 'social_difficulties',
			type: 'bool'
		},
		{
			name: 'psychiatric_diagnosis',
			type: 'bool'
		},
		{
			name: 'fms',
			type: 'bool'
		},
		{
			name: 'swelling',
			type: 'bool'
		},
		{
			name: 'warm',
			type: 'bool'
		},
		{
			name: 'muscle',
			type: 'bool'
		},
		{
			name: 'stiffness',
			type: 'bool'
		},
		{
			name: 'aches',
			type: 'bool'
		},
		{
			name: 'arthritis',
			type: 'bool'
		},
		{
			name: 'chronic_joint_pain',
			type: 'bool'
		},
		{
			name: 'loc',
			type: 'bool'
		},
		{
			name: 'stroke',
			type: 'bool'
		},
		{
			name: 'paralysis',
			type: 'bool'
		},
		{
			name: 'tia',
			type: 'bool'
		},
		{
			name: 'numbness',
			type: 'bool'
		},
		{
			name: 'memory_problems',
			type: 'bool'
		},
		{
			name: 'seizures',
			type: 'bool'
		},
		{
			name: 'intellectual_decline',
			type: 'bool'
		},
		{
			name: 'dementia',
			type: 'bool'
		},
		{
			name: 'headache',
			type: 'bool'
		},
		{
			name: 'cons_weakness',
			type: 'bool'
		},
		{
			name: 'brest_discharge',
			type: 'bool'
		},
		{
			name: 'fem_frequency',
			type: 'bool'
		},
		{
			name: 'notes',
			type: 'string',
			dataType: 'mediumtext'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			update: 'Encounter.updateReviewOfSystems'
		}
	},
	belongsTo: {
		model: 'App.model.patient.Encounter',
		foreignKey: 'eid'
	}
});

Ext.define('App.model.patient.FamilyHistory',{
    extend: 'Ext.data.Model',
    table: {
        name: 'patient_family_history'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'pid',
            type: 'int',
            index: true
        },
        {
            name: 'eid',
            type: 'int',
            index: true
        },
        {
            name: 'condition',
            type: 'string',
            len: 60
        },
        {
            name: 'condition_code',
            type: 'string',
            len: 60
        },
        {
            name: 'condition_code_type',
            type: 'string',
            len: 60
        },
        {
            name: 'relation',
            type: 'string',
            len: 60
        },
        {
            name: 'relation_code',
            type: 'string',
            len: 60
        },
        {
            name: 'relation_code_type',
            type: 'string',
            len: 60
        },
        {
            name: 'notes',
            type: 'string',
            dataType: 'TEXT'
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'FamilyHistory.getFamilyHistory',
            create: 'FamilyHistory.addFamilyHistory',
            update: 'FamilyHistory.updateFamilyHistory'
        },
        remoteGroup: false
    },
    belongsTo: {
        model: 'App.model.patient.Encounter',
        foreignKey: 'eid'
    },
    parsed_data: {
        primaryKey: 'id',
        fields: [
            'id',
            'pid',
            'eid',
            'condition',
            'condition_code',
            'condition_code_type',
            'relation',
            'relation_code',
            'relation_code_type',
            'notes',
            'create_uid',
            'update_uid',
            'create_date',
            'update_date'
        ],
        encryptedFields: false,
        phantomFields: false,
        arrayFields: false,
        fieldsProperties: {
            id: {
                name: 'id',
                type: 'int'
            },
            pid: {
                name: 'pid',
                type: 'int',
                index: true
            },
            eid: {
                name: 'eid',
                type: 'int',
                index: true
            },
            condition: {
                name: 'condition',
                type: 'string',
                len: 60
            },
            condition_code: {
                name: 'condition_code',
                type: 'string',
                len: 60
            },
            condition_code_type: {
                name: 'condition_code_type',
                type: 'string',
                len: 60
            },
            relation: {
                name: 'relation',
                type: 'string',
                len: 60
            },
            relation_code: {
                name: 'relation_code',
                type: 'string',
                len: 60
            },
            relation_code_type: {
                name: 'relation_code_type',
                type: 'string',
                len: 60
            },
            notes: {
                name: 'notes',
                type: 'string',
                dataType: 'TEXT'
            },
            create_uid: {
                name: 'create_uid',
                type: 'int'
            },
            update_uid: {
                name: 'update_uid',
                type: 'int'
            },
            create_date: {
                name: 'create_date',
                type: 'date',
                dateFormat: 'Y-m-d H:i:s'
            },
            update_date: {
                name: 'update_date',
                type: 'date',
                dateFormat: 'Y-m-d H:i:s'
            }
        }
    }
});

Ext.define('App.model.fees.Checkout',
	{
		extend: 'Ext.data.Model',
		table: {
			name: 'checkout',
			comment: 'Checkout'
		},
		fields: [
			{
				name: 'id',
				type: 'int',
				comment: 'Checkout ID'
			},
			{
				name: 'time',
				type: 'string'
			},
			{
				name: 'follow_up_facility',
				type: 'string'
			},
			{
				name: 'note',
				type: 'string'
			},
			{
				name: 'reminder',
				type: 'string'
			},
			{
				name: 'patient_name',
				type: 'string'
			},
			{
				name: 'encounter_number',
				type: 'int'
			},
			{
				name: 'transaction_facility',
				type: 'string'
			},
			{
				name: 'transaction_number',
				type: 'int'
			},
			{
				name: 'transaction_date',
				type: 'date',
				dateFormat: 'Y-m-d H:i:s'
			},
			{
				name: 'payment_amount',
				type: 'string'
			},
			{
				name: 'paying_entity',
				type: 'string'
			},
			{
				name: 'post_to_date',
				type: 'date',
				dateFormat: 'Y-m-d H:i:s'
			},
			{
				name: 'check_number',
				type: 'int'
			}
		],
		proxy: {
			type: 'direct',
			api: {
				read: 'Fees.getPaymentsBySearch'
			},
			reader: {
				root: 'rows',
				totalProperty: 'totals'
			}
		}
	});
Ext.define('App.model.navigation.Navigation', {
	extend: 'Ext.data.Model',
	fields: [
		{
            name: 'text',
            type: 'string'
        },
		{
            name: 'disabled',
            type: 'bool',
            defaultValue: false
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Navigation.getNavigation'
		}
	}
});
Ext.define('App.model.fees.EncountersPayments',
	{
		extend: 'Ext.data.Model',
		table: {
			name: 'encounterspayments',
			comment: 'Encounters Payments'
		},
		fields: [
			{
				name: 'id',
				type: 'int',
				dataType: 'bigint',
				len: 20,
				primaryKey: true,
				autoIncrement: true,
				allowNull: false,
				store: true,
				comment: 'Encounter Payments ID'
			},
			{
				name: 'paying_entity',
				type: 'string'
			},
			{
				name: 'payment_from',
				type: 'string'
			},
			{
				name: 'no',
				type: 'int'
			},
			{
				name: 'payment_method',
				type: 'string'
			},
			{
				name: 'pay_to',
				type: 'string'
			},
			{
				name: 'amount',
				type: 'string'
			},
			{
				name: 'date_from',
				type: 'date',
				dateFormat: 'Y-m-d H:i:s'
			},
			{
				name: 'date_to',
				type: 'date',
				dateFormat: 'Y-m-d H:i:s'
			},
			{
				name: 'note',
				type: 'string'
			}
		],
		proxy: {
			type: 'direct',
			api: {
				read: 'Fees.getPaymentsBySearch'
			},
			reader: {
				root: 'rows',
				totalProperty: 'totals'
			}
		}
	});
Ext.define('App.model.patient.Dictation', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_dictation'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'dictation',
			type: 'string',
			dataType: 'longtext'
		},
		{
			name: 'additional_notes',
			type: 'string',
			dataType: 'longtext'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Dictation.getDictations',
			create: 'Dictation.addDictation',
			update: 'Dictation.updateDictation'
		}
	},
	belongsTo: {
		model: 'App.model.patient.Encounter',
		foreignKey: 'eid'
	}
});
Ext.define('App.model.patient.PhysicalExam', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_physical_exams'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'exam_data',
			type: 'array'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PhysicalExams.getPhysicalExams',
			create: 'PhysicalExams.addPhysicalExam',
			update: 'PhysicalExams.updatePhysicalExam'
		},
		writer: {
			writeAllFields: true
		}
	}

});

Ext.define('App.model.patient.encounter.Procedures', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_procedures',
		comment: 'Patient Encounter Procedures'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'performer_id',
			type: 'int'
		},
		{
			name: 'procedure_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'code',
			type: 'string',
			len: 40
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'status_code',
			type: 'string',
			len: 40
		},
		{
			name: 'status_code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'target_site_code',
			type: 'string',
			len: 40
		},
		{
			name: 'target_site_code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'target_site_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
		{
			name: 'encounter_dx_id',
			type: 'int'
		},
		{
			name: 'observation',
			type: 'string'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Procedures.loadProcedures',
			create: 'Procedures.saveProcedure',
			update: 'Procedures.saveProcedure',
			destroy: 'Procedures.destroyProcedure'
		}
	}
});

Ext.define('App.model.patient.EducationResource', {
	extend: 'Ext.data.Model',
	requires: [

	],
	table: {
		name: 'patient_education_resources'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string',
			len: 300
		},
		{
			name: 'url',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'snippet',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'organization_name',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'provided_date',
			type: 'date',
			dateFormat: 'Y-m-d'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'EducationResources.getPatientEducationResources',
			create: 'EducationResources.addPatientEducationResource',
			update: 'EducationResources.updatePatientEducationResource',
			destroy: 'EducationResources.destroyPatientEducationResource'
		},
		remoteGroup: false
	}
});

Ext.define('App.model.patient.AppointmentRequest', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_appointment_requests'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'appointment_id',
			type: 'int'
		},
		{
			name: 'requested_uid',
			type: 'int'
		},
		{
			name: 'approved_uid',
			type: 'int'
		},
		{
			name: 'is_approved',
			type: 'bool',
			persist: false,
			convert: function(v, record){
				return record.data.approved_uid > 1;
			}
		},
		{
			name: 'requested_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'approved_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'notes',
			type: 'string'
		},
		{
			name: 'procedure1',
			type: 'string',
			len: 180
		},
		{
			name: 'procedure1_code',
			type: 'string',
			len: 10
		},
		{
			name: 'procedure1_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'procedure2',
			type: 'string',
			len: 180
		},
		{
			name: 'procedure2_code',
			type: 'string',
			len: 10
		},
		{
			name: 'procedure2_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'procedure3',
			type: 'string',
			len: 180
		},
		{
			name: 'procedure3_code',
			type: 'string',
			len: 10
		},
		{
			name: 'procedure3_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AppointmentRequest.getAppointmentRequests',
			create: 'AppointmentRequest.addAppointmentRequest',
			update: 'AppointmentRequest.updateAppointmentRequest',
			destroy: 'AppointmentRequest.deleteAppointmentRequest'
		}
	}
});

Ext.define('App.model.patient.AdvanceDirective', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_advance_directives'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'code',
			type: 'string',
			len: 80
		},
		{
			name: 'code_text',
			type: 'string',
			len: 160
		},
		{
			name: 'code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code',
			type: 'string',
			len: 80
		},
		{
			name: 'status_code_text',
			type: 'string',
			len: 160
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'notes',
			len: 300,
			type: 'string'
		},
		{
			name: 'start_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'end_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'verified_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'verified_uid',
			type: 'int'
		},
		{
			name: 'created_uid',
			type: 'int'
		},
		{
			name: 'updated_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			defaultValue: 'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AdvanceDirective.getPatientAdvanceDirectives',
			create: 'AdvanceDirective.addPatientAdvanceDirective',
			update: 'AdvanceDirective.updatePatientAdvanceDirective'
		}
	}
});
Ext.define('App.model.patient.Dental', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Dental Data ID'},
		{
			name: 'eid',
			type: 'int'},
		{
			name: 'pid',
			type: 'int'},
		{
			name: 'created_uid',
			type: 'int'},
		{
			name: 'updated_uid',
			type: 'int'},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'cdt_code',
			type: 'string'},
		{
			name: 'description',
			type: 'string'},
		{
			name: 'begin_date',
			type: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'ocurrence',
			type: 'string'
		},
		{
			name: 'referred_by',
			type: 'string'
		},
		{
			name: 'outcome',
			type: 'string'
		},
		{
			name: 'destination',
			type: 'string'
		},
		{
			name: 'alert',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Medical.getPatientDental',
			create: 'Medical.addPatientDental',
			update: 'Medical.updatePatientDental'
		}
	}
});
Ext.define('App.model.patient.Allergies', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_allergies',
		comment: 'Patient Allergies'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'allergy_type',
			type: 'string',
			len: 80
		},
		{
			name: 'allergy_type_code',
			type: 'string',
			len: 20
		},
		{
			name: 'allergy_type_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'allergy',
			len: 80,
			type: 'string'
		},
		{
			name: 'allergy_code',
			type: 'string',
			len: 20,
			comment: 'RxNORM RXCUI code if food allergy'
		},
		{
			name: 'allergy_code_type',
			len: 20,
			type: 'string'
		},
		{
			name: 'location',
			len: 80,
			type: 'string'
		},
		{
			name: 'reaction',
			len: 80,
			type: 'string'
		},
		{
			name: 'reaction_code',
			len: 20,
			type: 'string'
		},
		{
			name: 'reaction_code_type',
			len: 20,
			type: 'string'
		},
		{
			name: 'severity',
			len: 80,
			type: 'string'
		},
		{
			name: 'severity_code',
			len: 20,
			type: 'string'
		},
		{
			name: 'severity_code_type',
			len: 20,
			type: 'string'
		},
		{
			name: 'status',
			len: 15,
			type: 'string'
		},
		{
			name: 'status_code',
			len: 20,
			type: 'string'
		},
		{
			name: 'status_code_type',
			len: 20,
			type: 'string'
		},
		{
			name: 'begin_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'reconciled',
			type: 'bool',
			index: true
		},
		{
			name: 'reconciled_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'active',
			type: 'bool',
			store: false,
			convert: function(v, record){
				return record.data.end_date == '' || record.data.end_date == null;
			}
		},
		{
			name: 'created_uid',
			type: 'int'
		},
		{
			name: 'updated_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			defaultValue: 'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
		},
		{
			name: 'source',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Allergies.getPatientAllergies',
			create: 'Allergies.addPatientAllergy',
			update: 'Allergies.updatePatientAllergy'
		}
	}
});
Ext.define('App.model.patient.CptCodes', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'CPY Code ID'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string'
		},
		{
			name: 'code_text',
			type: 'string'
		},
		{
			name: 'code_text_medium',
			type: 'string'
		},
		{
			name: 'place_of_service',
			type: 'string'
		},
		{
			name: 'emergency',
			type: 'bool'
		},
		{
			name: 'charge',
			type: 'string'
		},
		{
			name: 'days_of_units',
			type: 'string'
		},
		{
			name: 'essdt_plan',
			type: 'string'
		},
		{
			name: 'modifiers',
			type: 'string'
		},
		{
			name: 'status',
			type: 'int',
			defaultValue: 0
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Services.getCptCodes',
			create: 'Services.addCptCode',
			update: 'Services.updateCptCode',
			destroy: 'Services.deleteCptCode'
		},
		reader: {
			root: 'rows',
			totalProperty: 'totals'
		}
	}
});

Ext.define('App.model.patient.Disclosures', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_disclosures',
		comment: 'Disclosures'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'type',
			type: 'string',
			len: 25
		},{
			name: 'recipient',
			type: 'string',
			len: 25
		},
		{
			name: 'status',
			type: 'string',
			len: 25
		},
		{
			name: 'description',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'request_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			useNull: true
		},
		{
			name: 'fulfil_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			useNull: true
		},
		{
			name: 'pickup_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			useNull: true
		},
		{
			name: 'pickup_signature',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'active',
			type: 'bool'
		},
		{
			name: 'document_inventory',
			type: 'string',
			store: false
		},
		{
			name: 'document_inventory_ids',
			type: 'string',
			store: false
		},
		{
			name: 'document_inventory_count',
			type: 'int',
			store: false
		},
		{
			name: 'document_file_paths',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Disclosure.getDisclosures',
			create: 'Disclosure.addDisclosure',
			update: 'Disclosure.updateDisclosure'
		}
	}
});


Ext.define('App.model.patient.DismissedAlerts', {
	extend: 'Ext.data.Model',

	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Dismissed Alerts ID'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'},
		{
			name: 'preventive_care_id',
			type: 'int'},
		{
			name: 'reason',
			type: 'string'
		},
		{
			name: 'observation',
			type: 'string'
		},
		{
			name: 'dismiss',
			type: 'bool'
		},
		{
			name: 'description',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PreventiveCare.getPreventiveCareDismissedAlertsByPid',
			update: 'PreventiveCare.updatePreventiveCareDismissedAlertsByPid'
		}
	}
});
Ext.define('App.model.patient.CheckoutAlertArea', {
	extend: 'Ext.data.Model',
	table: {
		name: 'checkoutalertarea',
		comment: 'Checkout Alert Area'
	},
	fields: [
		{name: 'id', type: 'int', comment: 'Checkout Alert ID'},
		{name: 'alert', type: 'string'},
		{name: 'alertType', type: 'int'}

	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Encounter.checkoutAlerts'
		}
	}
});
Ext.define('App.model.patient.DoctorsNote', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_doctors_notes'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'template_id',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'order_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'from_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'to_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'restrictions',
			type: 'array'
		},
		{
			name: 'string_restrictions',
			type: 'string',
			store: false,
			convert: function(v, record){
				if(!record.data.restrictions){
					return '';
				}else if(record.data.restrictions.join){
					return record.data.restrictions.join(', ');
				}else{
					return record.data.restrictions;
				}
			}
		},
		{
			name: 'group_date',
			type: 'date',
			dateFormat: 'Y-m-d',
			store: false,
			convert: function(v, record){
				return Ext.Date.format(record.data.date, 'Y-m-d');
			}
		},
		{
			name: 'comments',
			type: 'string',
			dataType: 'text'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DoctorsNotes.getDoctorsNotes',
			create: 'DoctorsNotes.addDoctorsNote',
			update: 'DoctorsNotes.updateDoctorsNote',
			destroy: 'DoctorsNotes.destroyDoctorsNote'
		}
	}
});
Ext.define('App.model.patient.EventHistory', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_history'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Event History ID'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'user',
			type: 'string',
			len: 80
		},
		{
			name: 'event',
			type: 'string',
			len: 600
		}
	]
});


Ext.define('App.model.patient.ImmunizationCheck', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Immunization Check ID'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'code',
			type: 'int'
		},
		{
			name: 'vaccine_name',
			type: 'string'
		},
		{
			name: 'alert',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Immunizations.getPatientImmunizations'
		}
	}
});
Ext.define('App.model.patient.CVXCodes', {
	extend: 'Ext.data.Model',
	table: {
		name: 'cvx_codes',
		comment: 'Immunizations  CVX'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Immunization ID'
		},
		{
			name: 'cvx_code',
			type: 'int',
			len: 10
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'description',
			type: 'string',
			dataType: 'text'
		},

		{
			name: 'note',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'status',
			type: 'string',
			len: 25
		},
		{
			name: 'quick_form',
			type: 'bool',
			index: true
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Immunizations.getImmunizationsList'
		}
	}
});
Ext.define('App.model.patient.Encounter', {
	extend: 'Ext.data.Model',
	requires: [
		'App.model.patient.PhysicalExam'
	],
	table: {
		name: 'encounters',
		comment: 'Encounter Data'
	},
	fields: [
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'parent_eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'rid',
			type: 'string',
			len: 80,
			comment: 'reference ID'
		},
		{
			name: 'open_uid',
			type: 'int',
			index: true
		},
		{
			name: 'provider_uid',
			type: 'int',
			index: true
		},
		{
			name: 'supervisor_uid',
			type: 'int',
			index: true
		},
		{
			name: 'requires_supervisor',
			type: 'bool',
			index: true,
			defaultValue: false
		},
		{
			name: 'technician_uid',
			type: 'int',
			useNull: true,
			index: true
		},
		{
			name: 'specialty_id',
			type: 'int',
			useNull: true,
			index: true
		},
		{
			name: 'is_private',
			type: 'bool',
			index: true
		},
		{
			name: 'service_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'close_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'onset_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'priority',
			type: 'string',
			len: 60
		},
		{
			name: 'brief_description',
			type: 'string',
			len: 600,
			comment: 'chief complaint'
		},
		{
			name: 'visit_category',
			type: 'string',
			len: 80
		},
		{
			name: 'visit_category_code',
			type: 'string',
			len: 20
		},
		{
			name: 'visit_category_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'facility',
			type: 'int',
			len: 1,
			index: true
		},
		{
			name: 'facility_name',
			type: 'string',
			store: false
		},
		{
			name: 'billing_stage',
			type: 'int',
			len: 1,
			index: true
		},
		{
			name: 'followup_time',
			type: 'string',
			len: 25
		},
		{
			name: 'followup_facility',
			type: 'string',
			len: 80
		},
		{
			name: 'review_immunizations',
			type: 'bool'
		},
		{
			name: 'review_allergies',
			type: 'bool'
		},
		{
			name: 'review_active_problems',
			type: 'bool'
		},
		{
			name: 'review_alcohol',
			type: 'string',
			len: 40
		},
		{
			name: 'review_smoke',
			type: 'bool'
		},
		{
			name: 'review_pregnant',
			type: 'string',
			len: 40
		},
		{
			name: 'review_surgery',
			type: 'bool'
		},
		{
			name: 'review_dental',
			type: 'bool'
		},
		{
			name: 'review_medications',
			type: 'bool'
		},
		{
			name: 'review_advance_directives',
			type: 'bool'
		},
		{
			name: 'review_implantable_devices',
			type: 'bool'
		},
		{
			name: 'review_pain_scales',
			type: 'bool'
		},
		{
			name: 'message',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'patient_class',
			type: 'string'
		},
		{
			name: 'referring_physician',
			type: 'int',
			useNull: true
		},
		{
			name: 'patient_education_given',
			type: 'bool'
		},
        {
            name: 'medication_reconciliations',
            type: 'bool'
        },
        {
            name: 'medication_reconciliations_date',
	        type: 'date',
	        dateFormat: 'Y-m-d'
        },
        {
            name: 'summary_care_provided',
            type: 'bool'
        },
        {
            name: 'summary_care_requested',
            type: 'bool'
        },
        {
            name: 'provider_title',
            type: 'string',
	        store: false
        },
        {
            name: 'provider_fname',
            type: 'string',
	        store: false
        },
        {
            name: 'provider_mname',
            type: 'string',
	        store: false
        },
        {
            name: 'provider_lname',
            type: 'string',
	        store: false
        },
        {
            name: 'provider_npi',
            type: 'string',
	        store: false
        },
        {
            name: 'provider_signature',
            type: 'string',
	        store: false
        },
        {
            name: 'referring_physician_fname',
            type: 'string',
	        store: false
        },
        {
            name: 'referring_physician_mname',
            type: 'string',
	        store: false
        },
        {
            name: 'referring_physician_lname',
            type: 'string',
	        store: false
        },
        {
            name: 'referring_physician_npi',
            type: 'string',
	        store: false
        },
        {
            name: 'referring_physician_phone',
            type: 'string',
	        store: false
        }
	],
	idProperty: 'eid',
	proxy: {
		type: 'direct',
		api: {
			read: 'Encounter.getEncounters',
			create: 'Encounter.createEncounter',
			update: 'Encounter.updateEncounter'
		},
		reader: {
			root: 'encounter'
		}
	},
	hasMany: [
		{
			model: 'App.model.patient.ReviewOfSystems',
			name: 'reviewofsystems',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.FamilyHistory',
			name: 'familyhistory',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.SOAP',
			name: 'soap',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.HCFAOptions',
			name: 'hcfaoptions',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.EncounterService',
			name: 'services',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.AppointmentRequest',
			name: 'appointmentrequests',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.EducationResource',
			name: 'educationresources',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.PhysicalExam',
			name: 'physicalexams',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.Dictation',
			name: 'dictation',
			primaryKey: 'eid',
			foreignKey: 'eid'
		}
	],

	isPrivate: function(){
		return this.get('is_private');
	},

	isClose: function(){
		return typeof this.data.close_date != 'undefined' && this.data.close_date != null;
	},

	isSigned: function(){
		return typeof this.data.provider_uid != 'undefined' && this.data.provider_uid != null && this.data.provider_uid != 0;
	},

	isCoSigned: function(){
		return typeof this.data.supervisor_uid != 'undefined' && this.data.supervisor_uid != null && this.data.supervisor_uid != 0;
	}
});

Ext.define('App.model.patient.LaboratoryTypes', {
	extend: 'Ext.data.Model',
	fields: [
		{
            name: 'id',
            type: 'int',
            comment: 'Laboratory Types ID'
        },
		{
            name: 'label',
            type: 'string'
        },
		{
            name: 'fields'
        }

	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Laboratories.getActiveLaboratoryTypes'
		}
	}
});


Ext.define('App.model.patient.MeaningfulUseAlert', {
	extend: 'Ext.data.Model',
	table: {
		name: 'meaningfulusealert',
		comment: 'Meaningful Use Alert'
	},
	fields: [
		{
            name: 'id',
            type: 'int',
            comment: 'Meaningful Use Alert ID'
        },
		{
            name: 'name',
            type: 'string'
        },
		{
            name: 'val',
            type: 'bool'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Patient.getMeaningfulUserAlertByPid'
		}
	}
});


Ext.define('App.model.patient.Notes', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_notes'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'body',
			type: 'string'
		},
		{
			name: 'type',
			type: 'string'
		},
		{
			name: 'list_key',
			type: 'string'
		},
		{
			name: 'user_fname',
			type: 'string',
			store: false
		},
		{
			name: 'user_mname',
			type: 'string',
			store: false
		},
		{
			name: 'user_lname',
			type: 'string',
			store: false
		},
		{
			name: 'update_user_fname',
			type: 'string',
			store: false
		},
		{
			name: 'update_user_mname',
			type: 'string',
			store: false
		},
		{
			name: 'update_user_lname',
			type: 'string',
			store: false
		},
		{
			name: 'user_name',
			type: 'string',
			convert: function (v, r){
				return Ext.String.format('{0}, {1} {2}',
					r.get('user_lname'),
					r.get('user_fname'),
					r.get('user_mname')
				)
			},
			store: false
		},
		{
			name: 'update_user_name',
			type: 'string',
			convert: function (v, r){
				return Ext.String.format('{0}, {1} {2}',
					r.get('update_user_lname'),
					r.get('update_user_fname'),
					r.get('update_user_mname')
				)
			},
			store: false
		},
        {
            name: 'external_id',
            type: 'string'
        },
        {
            name: 'global_id',
            type: 'string'
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Notes.getNotes',
			create: 'Notes.addNote',
			update: 'Notes.updateNote',
			destroy: 'Notes.destroyNote'
		},
		reader: {
			root: 'data'
		},
		writer:{
			writeAllFields: true
		}
	}
});


Ext.define('App.model.patient.PatientContacts', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_contacts',
		comment: 'Patient Contacts'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
            index: true
		},
		{
			name: 'pid',
			type: 'int'
		},
        {
            name: 'uid',
            type: 'int'
        },
		{
			name: 'first_name',
			type: 'string',
			len: 100
		},
        {
            name: 'middle_name',
            type: 'string',
            len: 100
        },
        {
            name: 'last_name',
            type: 'string',
            len: 100
        },
        {
            name: 'fullname',
            type: 'string',
            store: false,
            convert: function(v, record){
                return record.data.first_name + ' ' + record.data.middle_name  + ' ' + record.data.last_name;
            }
        },
		{
			name: 'relationship',
			type: 'string',
            len: 20
		},
        {
            name: 'relationship_name',
            type: 'string',
            len: 20,
            store: false
        },
		{
			name: 'street_mailing_address',
			type: 'string',
            len: 200
		},
        {
            name: 'city',
            type: 'string',
            len: 70
        },
        {
            name: 'state',
            type: 'string',
            len: 70
        },
        {
            name: 'zip',
            type: 'string',
            len: 20
        },
        {
            name: 'country',
            type: 'string',
            len:20
        },
        {
            name: 'phone_use_code',
            type: 'string',
            len: 17
        },
        {
            name: 'phone_area_code',
            type: 'string',
            len: 17
        },
        {
            name: 'phone_local_number',
            type: 'string',
            len: 17
        },
        {
            name: 'phone_compiled',
            type: 'string',
            store: false,
            convert: function(v, record){
                return record.data.phone_use_code+
                '('+
                record.data.phone_area_code+
                ')'+
                record.data.phone_local_number;
            }
        },
        {
            name: 'contact_role',
            type: 'string',
            len: 17
        },
        {
            name: 'publicity',
            type: 'string',
            len: 3

        },
        {
            name: 'active',
            type: 'bool'
        },
        {
            name: 'created_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
	],
    idProperty: 'id',
	proxy: {
		type: 'direct',
		api: {
			read: 'PatientContacts.getContacts',
			create: 'PatientContacts.addContact',
			update: 'PatientContacts.updateContact'
		}
	}
});


Ext.define('App.model.patient.Medications', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_medications',
		comment: 'Patient Medications'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'ref_order',
			type: 'string',
			len: 100,
			comment: 'reference order number'
		},
		{
			name: 'STR',
			type: 'string',
			len: 180
		},
		{
			name: 'CODE',
			type: 'string',
			len: 40
		},
		{
			name: 'RXCUI',
			type: 'string',
			len: 40
		},
        {
            name: 'GS_CODE',
            type: 'string',
            len: 40,
            comment: 'Gold Standard code'
        },
		{
			name: 'NDC',
			type: 'string',
			len: 40
		},
		{
			name: 'TTY',
			type: 'string',
			len: 10
		},
		{
			name: 'dxs',
			type: 'array'
		},
		{
			name: 'dose',
			type: 'string',
			len: 180
		},
		{
			name: 'form',
			type: 'string',
			len: 80
		},
		{
			name: 'route',
			type: 'string',
			len: 80
		},
		{
			name: 'directions',
			type: 'string'
		},
		{
			name: 'dispense',
			type: 'string',
			len: 80
		},
		{
			name: 'refill',
			type: 'string',
			len: 80
		},
		{
			name: 'potency_code',
			type: 'string',
			len: 10
		},
		{
			name: 'days_supply',
			type: 'int',
			useNull: true
		},
		{
			name: 'daw',
			type: 'bool',
			useNull: true,
			comment: 'Dispensed As Written'
		},
		{
			name: 'notes',
			type: 'string',
			len: 210
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
		{
			name: 'system_notes',
			type: 'string',
			len: 210
		},
		{
			name: 'requires_prescription',
			type: 'bool'
		},
		{
			name: 'is_active',
			type: 'bool'
		},
		{
			name: 'is_controlled',
			type: 'bool'
		},
		{
			name: 'is_compound',
			type: 'bool'
		},
		{
			name: 'is_supply',
			type: 'bool'
		},
		{
			name: 'prescription_id',
			type: 'int'
		},
		{
			name: 'referred_by',
			type: 'string',
			len: 180
		},
		{
			name: 'administer_in_house',
			type: 'bool'
		},
		{
			name: 'administered_uid',
			type: 'int'
		},
		{
			name: 'administered_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'administered_by',
			type: 'string',
			store: false,
			convert: function(v, record){
				return record.data.title + ' ' + record.data.fname + ' ' + record.data.mname + ' ' + record.data.lname;
			}
		},
		{
			name: 'title',
			type: 'string',
			store: false
		},
		{
			name: 'fname',
			type: 'string',
			store: false
		},
		{
			name: 'mname',
			type: 'string',
			store: false
		},
		{
			name: 'lname',
			type: 'string',
			store: false
		},
		{
			name: 'date_ordered',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'begin_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'reconciled',
			type: 'bool',
			index: true
		},
		{
			name: 'reconciled_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'active',
			type: 'bool',
			store: false,
			convert: function(v, record){
				return record.data.end_date === null;
			}
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
        {
            name: 'overridden',
            type: 'bool',
            comment: 'This is used by the Drug-To-Drug Interactions (MODULE)'
        },
        {
            name: 'source',
            type: 'string',
            store: false
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Medications.getPatientMedications',
			create: 'Medications.addPatientMedication',
			update: 'Medications.updatePatientMedication',
			destroy: 'Medications.destroyPatientMedication'
		},
        writer: {
            writeAllFields: true
        },
		remoteGroup: false
	}
});


Ext.define('App.model.patient.Insurance',{
    extend: 'Ext.data.Model',
    table: {
        name: 'patient_insurances',
        comment: 'Patient Insurances'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'external_id',
            type: 'string',
            len: 80,
            index: true
        },
        {
            name: 'code',
            type: 'string',
            len: 40,
            index: true
        },
        {
            name: 'ins_synonym',
            type: 'string',
            len: 15,
            store: false
        },
        {
            name: 'ins_name',
            type: 'string',
            store: false
        },
        {
            name: 'pid',
            type: 'int',
            index: true
        },
        {
            name: 'insurance_id',
            type: 'int',
	        useNull: true,
            index: true
        },
        {
            name: 'insurance_type',
            type: 'string',
            comment: 'P = primary S = supplemental C =complementary',
            len: 1,
            index: true
        },
        {
            name: 'effective_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'expiration_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'group_number',
            type: 'string',
            comment: 'group number',
            len: 40
        },
	    {
		    name: 'policy_number',
		    type: 'string',
		    len: 40
	    },
	    {
		    name: 'rx_member_id',
		    type: 'string',
		    len: 40
	    },
	    {
		    name: 'rx_group',
		    type: 'string',
		    len: 40
	    },
	    {
		    name: 'rx_bin',
		    type: 'string',
		    len: 40
	    },
	    {
		    name: 'rx_pcn',
		    type: 'string',
		    len: 40
	    },
        {
            name: 'cover_description',
            type: 'string',
            len: 50
        },
	    {
		    name: 'card_first_name',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'card_middle_name',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'card_last_name',
		    type: 'string',
		    len: 80
	    },
        {
            name: 'subscriber_policy_number',
            type: 'string',
            len: 40
        },
        {
            name: 'subscriber_title',
            type: 'string',
            len: 10
        },
        {
            name: 'subscriber_given_name',
            type: 'string',
            len: 35
        },
        {
            name: 'subscriber_middle_name',
            type: 'string',
            len: 25
        },
        {
            name: 'subscriber_surname',
            type: 'string',
            len: 60
        },
        {
            name: 'subscriber_relationship',
            type: 'string',
            len: 1
        },
        {
            name: 'subscriber_sex',
            type: 'string',
            len: 1
        },
        {
            name: 'subscriber_dob',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'subscriber_ss',
            type: 'string',
            len: 10
        },
        {
            name: 'subscriber_street',
            type: 'string',
            len: 110
        },
        {
            name: 'subscriber_street_cont',
            type: 'string',
            len: 110
        },
        {
            name: 'subscriber_city',
            type: 'string',
            len: 30
        },
        {
            name: 'subscriber_state',
            type: 'string',
            len: 2
        },
        {
            name: 'subscriber_country',
            type: 'string',
            len: 3
        },
        {
            name: 'subscriber_postal_code',
            type: 'string',
            len: 15
        },
        {
            name: 'subscriber_phone',
            type: 'string',
            len: 25
        },
        {
            name: 'subscriber_employer',
            type: 'string',
            len: 60
        },
        {
            name: 'display_order',
            type: 'int',
            len: 3
        },
        {
            name: 'notes',
            type: 'string',
            len: 320
        },
        {
            name: 'cover_exceptions',
            type: 'string'
        },
        {
            name: 'deductible',
            type: 'string'
        },
        {
            name: 'msp_insurance_type',
            type: 'string'
        },
        {
            name: 'image',
            type: 'string',
            dataType: 'mediumtext',
            comment: 'insurance image base64 string'
        },
        {
            name: 'active',
            type: 'bool'
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Insurance.getInsurances',
            create: 'Insurance.addInsurance',
            update: 'Insurance.updateInsurance'
        },
        writer: {
            writeAllFields: true
        }
    },
    associations: [
        {
            type: 'belongsTo',
            model: 'App.model.patient.Patient',
            associationKey: 'pid',
            foreignKey: 'pid'
        }
    ]
});

Ext.define('App.model.patient.PatientArrivalLog', {
	extend: 'Ext.data.Model',
	fields: [
		{
            name: 'id',
            type: 'int',
            comment: 'Patient Arrival Log ID'
        },
		{
            name: 'area_id',
            type: 'int'
        },
		{
            name: 'pid',
            type: 'int'
        },
		{
            name: 'time',
            type: 'string'
        },
		{
            name: 'name',
            type: 'string'
        },
		{
            name: 'status',
            type: 'string'
        },
		{
            name: 'area',
            type: 'string'
        },
		{
            name: 'warning',
            type: 'bool'
        },
		{
            name: 'warningMsg',
            type: 'string'
        },
		{
            name: 'isNew',
            type: 'bool'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PoolArea.getPatientsArrivalLog',
			create: 'PoolArea.addPatientArrivalLog',
			update: 'PoolArea.updatePatientArrivalLog',
			destroy: 'PoolArea.removePatientArrivalLog'
		},
		writer: {
			writeAllFields: true
		}
	}
});
Ext.define('App.model.patient.PatientActiveProblem', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_active_problems',
		comment: 'Active Problems'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'code',
			type: 'string',
			len: 80
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'begin_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'occurrence',
			type: 'string'
		},
		{
			name: 'referred_by',
			type: 'string'
		},
		{
			name: 'status',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'problem_type',
			type: 'string',
			len: 20
		},
		{
			name: 'problem_type_code',
			type: 'string',
			len: 20
		},
		{
			name: 'problem_type_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'note',
			type: 'string',
			len: 300
		},
		{
			name: 'reconciled',
			type: 'bool',
			index: true
		},
		{
			name: 'reconciled_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'active',
			type: 'bool',
			store: false,
			convert: function(v, record){
				return record.data.end_date == '' || record.data.end_date == null
			}
		},
		{
			name: 'created_uid',
			type: 'int'
		},
		{
			name: 'updated_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'source',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ActiveProblems.getPatientActiveProblems',
			create: 'ActiveProblems.addPatientActiveProblem',
			update: 'ActiveProblems.updatePatientActiveProblem',
			destroy: 'ActiveProblems.destroyPatientActiveProblem'
		}
	}
});

Ext.define('App.model.patient.PatientDocuments', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_documents',
		comment: 'Patient Documents Storage'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'global_id',
			type: 'string',
			len: 40,
			useNull: true,
			index: true
		},
		{
			name: 'code',
			type: 'string',
			len: 120,
			comment: 'external reference id',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'docType',
			type: 'string',
			index: true
		},
		{
			name: 'docTypeCode',
			type: 'string',
			len: 20,
			index: true
		},
		{
			name: 'filesystem_id',
			type: 'int',
			index: true
		},
		{
			name: 'path',
			type: 'string'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'MEDIUMTEXT'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'hash',
			type: 'string'
		},
		{
			name: 'encrypted',
			type: 'bool',
			defaultValue: 0
		},
		{
			name: 'entered_in_error',
			type: 'bool',
			defaultValue: 0
		},
		{
			name: 'error_note',
			type: 'string',
			len: 300
		},
		{
			name: 'groupDate',
			type: 'string',
			store: false,
			convert: function(v, record){
				return Ext.util.Format.date(record.get('date'), g('date_display_format'));
			}
		},
		{
			name: 'document_instance',
			type: 'string',
			len: 10
		},
		{
			name: 'document_id',
			type: 'int'
		},
		{
			name: 'document',
			type: 'string',
			dataType: 'longblob'
		},
		{
			name: 'site',
			type: 'string',
			store: false,
			useNull: true
		},
		{
			name: 'pubpid',
			type: 'string',
			store: false
		},
		{
			name: 'order_number',
			type: 'string',
			store: false
		},
		{
			name: 'accession_number',
			type: 'string',
			store: false
		},
		{
			name: 'disabled_selection',
			type: 'bool',
			persist: false,
			defaultValue: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DocumentHandler.getPatientDocuments',
			create: 'DocumentHandler.addPatientDocument',
			update: 'DocumentHandler.updatePatientDocument'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});


Ext.define('App.model.patient.PatientLabsResults', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patientlabsresults',
		comment: 'Patient Labs Results'
	},
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Patient Labs Results ID'
        },
        {
            name: 'pid',
            type: 'int'
        },
        {
            name: 'uid',
            type: 'int'
        },
        {
            name: 'auth_uid',
            type: 'int'
        },
        {
            name: 'eid',
            type: 'int'
        },
        {
            name: 'document_id',
            type: 'int'
        },
        {
            name: 'document_url'
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:s:i'
        },
        {
            name: 'data'
        },
        {
            name: 'columns'
        },
        {
            name: 'parent_id'
        }
    ],
	proxy: {
		type: 'direct',
		api: {
			read: 'Medical.getPatientLabsResults',
			create: 'Medical.addPatientLabsResult',
			update: 'Medical.updatePatientLabsResult',
			destroy: 'Medical.deletePatientLabsResult'
		}
	}
});
Ext.define('App.model.patient.PatientCalendarEvents', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patientcalendarevents',
		comment: 'Patient Calendar Events'
	},
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Patient Calendar Event ID'
        },
        {
            name: 'user_id',
            type: 'int'
        },
        {
            name: 'category',
            type: 'int'
        },
        {
            name: 'facility',
            type: 'int'
        },
        {
            name: 'billing_facillity',
            type: 'int'
        },
        {
            name: 'patient_id',
            type: 'int'
        },
        {
            name: 'title',
            type: 'string'
        },
        {
            name: 'status',
            type: 'string'
        },
        {
            name: 'start',
            type: 'date',
            dateFormat: 'Y-m-d H:s:i'
        },
        {
            name: 'end',
            type: 'date',
            dateFormat: 'Y-m-d H:s:i'
        },
        {
            name: 'data',
            type: 'string'
        },
        {
            name: 'rrule',
            type: 'string'
        },
        {
            name: 'loc',
            type: 'string'
        },
        {
            name: 'notes',
            type: 'string'
        },
        {
            name: 'url',
            type: 'string'
        },
        {
            name: 'ad',
            type: 'string'
        }
    ],
	proxy: {
		type: 'direct',
		api: {
			read: 'Calendar.getPatientFutureEvents'
		}
	}
});
Ext.define('App.model.patient.PatientImmunization', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_immunizations',
		comment: 'Patient Immunization'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Patient Immunization ID'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'ndc',
			type: 'string',
			len: 25
		},
		{
			name: 'code',
			type: 'string',
			len: 20
		},
		{
			name: 'code_type',
			type: 'string',
			defaultValue: 'CVX',
			len: 15
		},
		{
			name: 'vaccine_name',
			type: 'string',
			len: 300
		},
		{
			name: 'lot_number',
			type: 'string',
			len: 60
		},
		{
			name: 'administer_amount',
			type: 'string',
			len: 40
		},
		{
			name: 'administer_units',
			type: 'string',
			len: 40
		},
		{
			name: 'administered_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'exp_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'administered_uid',
			type: 'int'
		},
		{
			name: 'administered_by',
			type: 'string',
			store: false,
			convert: function(v, record){
				return record.data.administered_title + ' ' +
					record.data.administered_fname + ' ' +
					(record.data.administered_mname || '') + ' ' +
					record.data.administered_lname;
			}
		},
		{
			name: 'administered_title',
			type: 'string',
			store: false
		},
		{
			name: 'administered_fname',
			type: 'string',
			store: false
		},
		{
			name: 'administered_mname',
			type: 'string',
			store: false
		},
		{
			name: 'administered_lname',
			type: 'string',
			store: false
		},
		{
			name: 'route',
			type: 'string',
			len: 40
		},
		{
			name: 'administration_site',
			type: 'string',
			len: 40
		},
		{
			name: 'manufacturer',
			type: 'string',
			len: 180
		},
		{
			name: 'education_resource_1_id',
			type: 'int'
		},
		{
			name: 'education_resource_2_id',
			type: 'int'
		},
		{
			name: 'education_resource_3_id',
			type: 'int'
		},
		{
			name: 'education_presented_1_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'education_presented_2_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'education_presented_3_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'vfc_code',
			type: 'string',
			len: 40
		},
		{
			name: 'information_source_code',
			type: 'string',
			len: 10
		},
		{
			name: 'refusal_reason_code',
			type: 'string',
			len: 10
		},
        {
            name: 'is_presumed_immunity',
            type: 'bool'
        },
        {
            name: 'presumed_immunity_code',
	        type: 'string',
	        len: 20
        },
		{
			name: 'note',
			type: 'string',
			len: 300
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'created_uid',
			type: 'int'
		},
		{
			name: 'updated_uid',
			type: 'int'
		},
		{
			name: 'status',
			type: 'string',
			len: 40
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
		{
			name: 'is_error',
			type: 'bool'
		},
		{
			name: 'error_note',
			type: 'string',
			len: 300
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Immunizations.getPatientImmunizations',
			create: 'Immunizations.addPatientImmunization',
			update: 'Immunizations.updatePatientImmunization'
		}
	}
});
Ext.define('App.model.patient.PatientsPrescriptionMedications', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_medications',
		comment: 'Patient Medications'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'prescription_id',
			type: 'int'
		},
		{
			name: 'STR',
			type: 'string',
			len: 180
		},
		{
			name: 'CODE',
			type: 'string',
			len: 40
		},
		{
			name: 'RXCUI',
			type: 'string',
			len: 40
		},
		{
			name: 'NDC',
			type: 'string',
			len: 40
		},
		{
			name: 'dxs',
			type: 'string'
		},
		{
			name: 'dose',
			type: 'string',
			len: 180
		},
		{
			name: 'form',
			type: 'string',
			len: 80
		},
		{
			name: 'route',
			type: 'string',
			len: 80
		},
		{
			name: 'directions',
			type: 'string'
		},
		{
			name: 'dispense',
			type: 'string',
			len: 80
		},
		{
			name: 'refill',
			type: 'string',
			len: 80
		},
		{
			name: 'daw',
			type: 'bool'
		},
		{
			name: 'notes',
			type: 'string',
			len: 300
		},
		{
			name: 'referred_by',
			type: 'string',
			len: 180
		},
		{
			name: 'date_ordered',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'begin_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'end_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'active',
			type: 'bool',
			store: false,
			convert: function(v, record){
				return record.data.end_date == null;
			}
		}
	]
});
Ext.define('App.model.patient.PatientsLabOrderItems', {
	extend: 'Ext.data.Model',
	fields: [
		{
            name: 'id',
            type: 'int'
        },
		{
            name: 'loinc',
            type: 'string'
        },
		{
            name: 'title',
            type: 'string'
        }
	]
});
Ext.define('App.model.patient.PatientsOrderObservation', {
	extend: 'Ext.data.TreeModel',
	table: {
		name: 'patient_order_results_observations',
		comment: 'Order Result Observations OBX'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'result_id',
			type: 'int',
			index: true,
			comment: 'Result ID'
		},
        {
            name: 'parent_id',
            type: 'int',
            index: true,
            comment: 'Parent ID'
        },
		{
			name: 'code',
			type: 'string',
			comment: 'OBX 3',
			index: true
		},
		{
			name: 'code_text',
			type: 'string',
			comment: 'OBX 3'
		},
		{
			name: 'code_type',
			type: 'string',
			comment: 'OBX 3'
		},
		{
			name: 'value',
			type: 'string',
			comment: 'OBX 5'
		},
		{
			name: 'units',
			type: 'string',
			comment: 'OBX 6'
		},
		{
			name: 'reference_rage',
			type: 'string',
			comment: 'OBX 7'
		},
		{
			name: 'probability',
			type: 'string',
			comment: 'OBX 9'
		},
		{
			name: 'abnormal_flag',
			type: 'string',
			comment: 'OBX 8'
		},
		{
			name: 'nature_of_abnormal',
			type: 'string',
			comment: 'OBX 10'
		},
		{
			name: 'observation_result_status',
			type: 'string',
			comment: 'OBX 11'
		},
		{
			name: 'date_rage_values',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'OBX 12 Effective Date of Reference Range Values'
		},
		{
			name: 'date_observation',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'OBX 14'
		},
		{
			name: 'observer',
			type: 'string',
			comment: 'OBX 16'
		},
		{
			name: 'performing_org_name',
			type: 'string',
			comment: 'OBX 23'
		},
		{
			name: 'performing_org_address',
			type: 'string',
			comment: 'OBX 24'
		},
		{
			name: 'observer',
			type: 'string',
			comment: 'OBX 16'
		},
		{
			name: 'date_analysis',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'OBX 19'
		},
		{
			name: 'notes',
			type: 'string',
			comment: 'OBX NTE segments'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Orders.getOrderResultObservations',
			create: 'Orders.addOrderResultObservations',
			update: 'Orders.updateOrderResultObservations',
			destroy: 'Orders.deleteOrderResultObservations'
		},
		remoteGroup: false
	}
});

Ext.define('App.model.patient.PatientSocialHistory', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_social_history',
		comment: 'Patient Social History'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true,
			comment: 'encounter id'
		},
		{
			name: 'pid',
			type: 'int',
			index: true,
			comment: 'patient ID'
		},
		{
			name: 'category_code',
			type: 'string',
			len: 25
		},
		{
			name: 'category_code_type',
			type: 'string',
			defaultValue: 'SNOMEDCT',
			len: 20
		},
		{
			name: 'category_code_text',
			len: 120,
			type: 'string'
		},
		{
			name: 'observation',
			type: 'string',
			len: 400,
			comment: 'clinical observation for this history'
		},
		{
			name: 'observation_code',
			type: 'string',
			len: 20
		},
		{
			name: 'observation_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'start_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'same as CCD low time'
		},
		{
			name: 'end_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'same as CCD high time'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'user ID who created the record'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'user ID who updated the record'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'SocialHistory.getSocialHistories',
			create: 'SocialHistory.addSocialHistory',
			update: 'SocialHistory.updateSocialHistory',
			destroy: 'SocialHistory.destroySocialHistory'
		},
		remoteGroup: false
	}
});
Ext.define('App.model.patient.PatientsOrderResult', {
	extend: 'Ext.data.Model',
	requires: [
		'App.model.patient.PatientsOrderObservation'
	],
	table: {
		name: 'patient_order_results',
		comment: 'Patients Results OBR'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'study_uid',
			type: 'string',
			index: true,
			len: 160,
			comment: 'ID for external integration. Usually used for radilogy studies'
		},
		{
			name: 'ordered_uid',
			type: 'int',
			index: true
		},
		{
			name: 'signed_uid',
			type: 'int',
			index: true
		},
		{
			name: 'order_id',
			type: 'int',
			index: true,
			comment: 'OBR-2'
		},
		{
			name: 'code',
			type: 'string',
			len: 40
		},
		{
			name: 'code_text',
			type: 'string',
			len: 150
		},
		{
			name: 'code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'performer_order_id',
			type: 'string',
			len: 50,
			index: true,
			comment: 'OBR-3'
		},
		{
			name: 'performer_id',
			type: 'int',
			index: true
		},
		{
			name: 'performer_name',
			type: 'string',
			len: 150
		},
		{
			name: 'performer_address',
			type: 'string',
			len: 200
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'result_date',
			type: 'date',
			dateFormat: 'Y-m-d',
			index: true
		},
		{
			name: 'observation_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'result_status',
			type: 'string',
			len: 40
		},
		{
			name: 'reason_code',
			type: 'string',
			len: 40
		},
		{
			name: 'specimen_code',
			type: 'string',
			len: 40
		},
		{
			name: 'specimen_text',
			type: 'string',
			len: 180
		},
		{
			name: 'specimen_code_type',
			type: 'string',
			len: 40
		},
		{
			name: 'report_body',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'documentId',
			type: 'string',
			comment: 'this is the document or hl7 message id - example -> doc|123 or hl7|123',
			len: 40
		},
		{
			name: 'upload',
			type: 'string',
			store: false
		},
        {
            name: 'void',
            type: 'bool',
            defaultValue: false,
            comment: 'VOID the order'
        },
        {
            name: 'void_comment',
            type: 'string',
            comment: 'VOID comments',
            len: 100
        },
		{
			name: 'specimen_notes',
			type: 'string',
			len: 600
		},
		{
			name: 'study_link',
			type: 'string',
			len: 600
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Orders.getOrderResults',
			create: 'Orders.addOrderResults',
			update: 'Orders.updateOrderResults',
			destroy: 'Orders.deleteOrderResults'
		},
		remoteGroup: false
	},
	associations: [
		{
			type: 'hasMany',
			model: 'App.model.patient.PatientsOrderObservation',
			name: 'observations',
            primaryKey: 'id',
			foreignKey: 'result_id',
			storeConfig: {
				type: 'tree',
				autoLoad: false,
				clearOnLoad: true
			}
		},
		{
			type: 'belongsTo',
			model: 'App.model.patient.PatientsOrders',
			getterName: 'getOrder',
			setterName: 'setOrder',
			primaryKey: 'id',
			foreignKey: 'order_id'
		}
	]

});

Ext.define('App.model.patient.PatientsOrders', {
	extend: 'Ext.data.Model',
	requires: [
		'App.model.patient.PatientsOrderResult'
	],
	table: {
		name: 'patient_orders',
		comment: 'Patients Orders'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true,
			comment: 'encounter id'
		},
		{
			name: 'pid',
			type: 'int',
			index: true,
			comment: 'patient ID'
		},
		{
			name: 'uid',
			type: 'int',
			comment: 'user ID who created the order'
		},
		{
			name: 'hl7_recipient_id',
			type: 'int',
			comment: 'laboratory id if electronic request'
		},
		{
			name: 'code',
			type: 'string',
			len: 25,
			comment: 'Order code'
		},
		{
			name: 'code_type',
			type: 'string',
			defaultValue: 'LOINC',
			len: 15,
			comment: 'Order code type LOINC'
		},
		{
			name: 'description',
			type: 'string',
			comment: 'Order Text Description'
		},
		{
			name: 'date_ordered',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'when the order was generated',
			index: true
		},
		{
			name: 'date_collected',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			comment: 'when the results were collected',
			index: true
		},
		{
			name: 'priority',
			type: 'string',
			len: 25,
			comment: 'order priority',
			index: true
		},
		{
			name: 'status',
			type: 'string',
			len: 25,
			comment: 'order status',
			index: true
		},
		{
			name: 'order_type',
			type: 'string',
			comment: 'Order is radiology or laboratory.',
			index: true
		},
        {
            name: 'type',
            type: 'string',
            store: false,
            convert: function(v, record)
            {
                switch(record.data.order_type)
                {
                    case 'lab':
                        return _('laboratory');
                        break;
                    case 'rad':
                        return _('radiology');
                        break;
                }
            }
        },
		{
			name: 'note',
			type: 'string'
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
        {
            name: 'void',
            type: 'boolean',
            defaultValue: false,
            comment: 'VOID the Order'
        },
        {
            name: 'void_comment',
            type: 'string',
            comment: 'VOID Comments',
            len: 100
        },
		{
			name: 'is_external_order',
			type: 'boolean',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Orders.getPatientOrders',
			create: 'Orders.addPatientOrder',
			update: 'Orders.updatePatientOrder',
			destroy: 'Orders.deletePatientOrder'
		},
		remoteGroup: false
	},
	associations: [
		{
			type: 'hasMany',
			model: 'App.model.patient.PatientsOrderResult',
			name: 'results',
			foreignKey: 'order_id'
		}
	]
});

Ext.define('App.model.patient.PatientsPrescriptions', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'Patient Prescription ID'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'created_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		} ,
		{
			name: 'note',
			type: 'string'
		},
		{
			name: 'document_id',
			type: 'int'
		},
		{
			name: 'docUrl',
			type: 'string'
		},
		{
			name: 'medications'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Prescriptions.getPrescriptions',
			create: 'Prescriptions.addPrescription',
			update: 'Prescriptions.updatePrescription'
		}
	}
});
Ext.define('App.model.patient.Referral', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_referrals',
		comment: 'Patients Referrals'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true,
			comment: 'encounter id'
		},
		{
			name: 'pid',
			type: 'int',
			index: true,
			comment: 'patient ID'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'user ID who created the referral'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'user ID who updated the referral'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'referral_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'service_text',
			type: 'string',
			len: 300
		},
		{
			name: 'service_code',
			type: 'string',
			len: 10
		},
		{
			name: 'service_code_type',
			type: 'string',
			comment: 'CPT SNOMED',
			len: 10
		},
		{
			name: 'referal_reason',
			type: 'string',
			len: 1000
		},
		{
			name: 'diagnosis_text',
			type: 'string',
			len: 300
		},
		{
			name: 'diagnosis_code',
			type: 'string',
			len: 10
		},
		{
			name: 'diagnosis_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'is_external_referral',
			type: 'bool'
		},
		{
			name: 'refer_by',
			type: 'string',
			len: 80
		},
		{
			name: 'refer_by_text',
			type: 'string',
			len: 120
		},
		{
			name: 'refer_to',
			type: 'string',
			len: 80
		},
		{
			name: 'refer_to_text',
			type: 'string',
			len: 120
		},
		{
			name: 'risk_level',
			type: 'string',
			len: 20
		},
		{
			name: 'send_record',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Referrals.getPatientReferrals',
			create: 'Referrals.addPatientReferral',
			update: 'Referrals.updatePatientReferral',
			destroy: 'Referrals.deletePatientReferral'
		},
		remoteGroup: false
	}
});

Ext.define('App.model.patient.PatientsXrayCtOrders', {
	extend: 'Ext.data.Model',
	fields: [
		{
            name: 'id',
            type: 'int',
            comment: 'Patients XrayCt Orders ID'
        },
		{
            name: 'eid',
            type: 'int'
        },
		{
            name: 'pid',
            type: 'int'
        },
		{
            name: 'uid',
            type: 'int'
        },
		{
            name: 'description',
            type: 'string' },
		{
            name: 'date_created',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
		{
            name: 'laboratory_id',
            type: 'int'
        },
		{
            name: 'document_id',
            type: 'int'
        },
		{
            name: 'order_type',
            type: 'string',
            defaultValue: 'rad'
        },
		{
            name: 'order_items',
            type: 'string'
        },
		{
            name: 'note',
            type: 'string'
        },
		{
            name: 'docUrl',
            type: 'string'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Orders.getPatientXrayCtOrders',
			create: 'Orders.addPatientXrayCtOrder',
			update: 'Orders.updatePatientXrayCtOrder'
		}
	}
});
Ext.define('App.model.patient.PreventiveCare', {
	extend: 'Ext.data.Model',
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Preventive Care ID'
        },
        {
            name: 'pid',
            type: 'int'
        },
        {
            name: 'eid',
            type: 'int'
        },
        {
            name: 'uid',
            type: 'int'
        },
        {
            name: 'description'
        },
        {
            name: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'observation'
        },
        {
            name: 'type'
        },
        {
            name: 'dismiss'
        },
        {
            name: 'reason'
        },
        {
            name: 'alert',
            type: 'bool'
        }
    ],
	proxy: {
		type: 'direct',
		api: {
			update: 'PreventiveCare.addPreventivePatientDismiss',
			read: 'PreventiveCare.getPreventiveCareCheck'
		}
	}
});
Ext.define('App.model.patient.QRCptCodes', {
	extend: 'Ext.data.Model',
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'QR CPT Code ID'
        },
        {
            name: 'eid',
            type: 'int'
        },
        {
            name: 'code',
            type: 'string'
        },
        {
            name: 'code_text',
            type: 'string'
        },
        {
            name: 'code_text_medium',
            type: 'string'
        },
        {
            name: 'place_of_service',
            type: 'string'
        },
        {
            name: 'emergency',
            type: 'bool'
        },
        {
            name: 'charge',
            type: 'string'
        },
        {
            name: 'days_of_units',
            type: 'string'
        },
        {
            name: 'essdt_plan',
            type: 'string'
        },
        {
            name: 'modifiers',
            type: 'string'
        },
        {
            name: 'status',
            type: 'int',
            defaultValue: 0
        }
    ],
	proxy: {
		type: 'direct',
		api: {
			read: 'Services.getCptCodes'
		},
		reader: {
			root: 'rows',
			totalProperty: 'totals'
		}
	}
});
Ext.define('App.model.patient.Reminder', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_reminders'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'reminder_date',
			type: 'date',
			dataType: 'DATE',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'reminder_type',
			type: 'string',
			len: 45
		},
		{
			name: 'reminder_note',
			type: 'string',
			dataType: 'MEDIUMTEXT'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Reminders.getReminders',
			create: 'Reminders.addReminder',
			update: 'Reminders.updateReminder'
		},
		reader: {
			root: 'data'
		}
	}
});


Ext.define('App.model.patient.VectorGraph', {
    extend: 'Ext.data.Model',
    table: {
        name: 'vectorgraph',
        comment: 'Vector Graphics'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Vector Graphics ID'
        },
        {
            name: 'age_mos',
            type: 'float'
        },
        {
            name: 'height',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P85',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        }
    }

});
Ext.define('App.model.patient.Surgery', {
    extend: 'Ext.data.Model',
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Surgery ID'
        },
        {
            name: 'eid',
            type: 'int'
        },
        {
            name: 'pid',
            type: 'int'
        },
        {
            name: 'created_uid',
            type: 'int'
        },
        {
            name: 'updated_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'surgery',
            type: 'string'
        },
        {
            name: 'surgery_id',
            type: 'string'
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'referred_by',
            type: 'string'
        },
        {
            name: 'outcome',
            type: 'string'
        },
        {
            name: 'notes',
            type: 'string'
        },
        {
            name: 'alert',
            type: 'bool'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Medical.getPatientSurgery',
            create: 'Medical.addPatientSurgery',
            update: 'Medical.updatePatientSurgery'
        }
    }
});
Ext.define('App.model.patient.charts.BMIForAge', {
    extend: 'Ext.data.Model',
    table: {
        name: 'bmiforage',
        comment: 'BMI For Age'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'BMI For Age ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 8
        }
    }

});
Ext.define('App.model.patient.charts.HeadCircumferenceInf', {
    extend: 'Ext.data.Model',
    table: {
        name: 'headcircumferenceinf',
        comment: 'Head Circumference Information'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Head Circumference Information ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 4
        }
    }

});
Ext.define('App.model.patient.Alert', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_alerts'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},

		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			index: true
		},
		{
			name: 'body',
			type: 'string',
			len: 600
		},
		{
			name: 'type',
			type: 'string',
			len: 80,
			index: true
		},
		{
			name: 'user_name',
			type: 'string',
			store: false
		},
		{
			name: 'active',
			type: 'bool',
			defaultValue: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Alerts.getAlerts',
			create: 'Alerts.addAlert',
			update: 'Alerts.updateAlert'
		},
		reader: {
			root: 'data'
		}
	}
});


Ext.define('App.model.patient.VisitPayment', {
    extend: 'Ext.data.Model',
    table: {
        name: 'visitpayment',
        comment: 'Visit Payment'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Visit Payment ID'
        },
        {
            name: 'no',
            type: 'int'
        },
        {
            name: 'date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'facility',
            type: 'string'
        },
        {
            name: 'received_from',
            type: 'string'
        },
        {
            name: 'amount',
            type: 'string'
        },
        {
            name: 'for_payment_of',
            type: 'string'
        },
        {
            name: 'paid_by',
            type: 'string'
        },
        {
            name: 'description',
            type: 'string'
        },
        {
            name: 'next_appointment',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'accounted_amount',
            type: 'string'
        },
        {
            name: 'payment_amount',
            type: 'string'
        },
        {
            name: 'balance_due',
            type: 'string'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Encounter.Checkout'
        },
        reader: {
            type: 'json'
        }
    }
});
Ext.define('App.model.patient.charts.LengthForAgeInf', {
    extend: 'Ext.data.Model',
    table: {
        name: 'lengthforageinf',
        comment: 'Length For Age Information'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Length For Age Information ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 2
        }
    }

});
Ext.define('App.model.patient.charts.StatureForAge', {
    extend: 'Ext.data.Model',
    table: {
        name: 'statureforage',
        comment: 'Stature For Age'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Stature For Age ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 7
        }
    }

});
Ext.define('App.model.patient.charts.WeightForAge', {
    extend: 'Ext.data.Model',
    table: {
        name: 'weightforage',
        comment: 'Weight For Age'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Weight For Age ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 6
        }
    }

});
Ext.define('App.model.patient.charts.WeightForAgeInf', {
    extend: 'Ext.data.Model',
    table: {
        name: 'weightforageinf',
        comment: 'Weight For Age Information'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Weight For Age Information ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 1
        }
    }

});
Ext.define('App.model.patient.charts.WeightForRecumbentInf', {
    extend: 'Ext.data.Model',
    table: {
        name: 'weightforrecumbentinf',
        comment: 'Weight For Recumbent Information'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Weight For Recumbent Information ID'
        },
        {
            name: 'age',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 3
        }
    }

});
Ext.define('App.model.patient.charts.WeightForStature', {
    extend: 'Ext.data.Model',
    table: {
        name: 'weightforstature',
        comment: 'Weight For Stature'
    },
    fields: [
        {
            name: 'id',
            type: 'int',
            comment: 'Weight For Stature ID'
        },
        {
            name: 'height',
            type: 'float'
        },
        {
            name: 'PP',
            type: 'float'
        },
        {
            name: 'P3',
            type: 'float'
        },
        {
            name: 'P5',
            type: 'float'
        },
        {
            name: 'P10',
            type: 'float'
        },
        {
            name: 'P25',
            type: 'float'
        },
        {
            name: 'P50',
            type: 'float'
        },
        {
            name: 'P75',
            type: 'float'
        },
        {
            name: 'P85',
            type: 'float'
        },
        {
            name: 'P90',
            type: 'float'
        },
        {
            name: 'P95',
            type: 'float'
        },
        {
            name: 'P97',
            type: 'float'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'VectorGraph.getGraphData'
        },
        reader: {
            type: 'json'
        },
        extraParams: {
            type: 5
        }
    }

});
Ext.define('App.model.areas.PatientArea', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'pid',
			type: 'int',
			comment: 'Pool Areas ID'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'name',
			type: 'string'
		},
		{
			name: 'patient'
		},
		{
			name: 'shortName',
			type: 'string'
		},
		{
			name: 'poolArea',
			type: 'string'
		},
		{
			name: 'floorPlanId',
			type: 'int'
		},
		{
			name: 'zoneId',
			type: 'int'
		},
		{
			name: 'patientZoneId',
			type: 'int'
		},
		{
			name: 'priority',
			type: 'string'
		},
		{
			name: 'rank',
			type: 'int'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PoolArea.getPatientsByPoolAreaAccess'
		}
	}
});
Ext.define('App.model.areas.PoolArea', {
	extend: 'Ext.data.Model',
	table: {
		name:'pool_areas'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string',
			len: 80
		},
		{
			name: 'concept',
			type: 'string',
			len: 80
		},
		{
			name: 'floor_plan_id',
			type: 'int',
			useNull: true
		},
		{
			name: 'facility_id',
			type: 'int',
			useNull: true
		},
		{
			name: 'sequence',
			type: 'int'
		},
		{
			name: 'active',
			type: 'bool'
		},
		{
			name: 'facility_name',
			type: 'string',
			store: false
		},
		{
			name: 'floor_plan_title',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PoolArea.getPoolAreas',
			create: 'PoolArea.addPoolArea',
			update: 'PoolArea.updatePoolArea',
			destroy: 'PoolArea.destroyPoolArea'
		},
		remoteGroup: false
	},
	remoteGroup: false
});
Ext.define('App.model.areas.PoolDropAreas', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'fname',
			type: 'string'
		},
		{
			name: 'mname',
			type: 'string'
		},
		{
			name: 'lname',
			type: 'string'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'pubpid',
			type: 'string'
		},
		{
			name: 'pic',
			type: 'string'
		},
		{
			name: 'appointment_id',
			type: 'int'
		},
		{
			name: 'zone',
			type: 'string'
		},
		{
			name: 'appointment_time',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'time_in',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'minutes',
			type: 'string',
			convert: function (v,r) {
				if(!r.get('time_in')) return 0;
				return (app.getDate().getTime() - r.get('time_in').getTime()) / 1000 / 60;
			}
		},
		{
			name: 'timer',
			type: 'string',
			convert: function (v,r) {
				var mitutes = r.get('minutes'),
					hours = (mitutes / 60),
					rhours = Math.floor(hours),
					minutes = (hours - rhours) * 60,
					rminutes = Math.round(minutes);
				return Ext.String.format('{0}:{1}', Ext.String.leftPad(rhours,2,'0'),  Ext.String.leftPad(rminutes,2,'0'));
			}
		},
		{
			name: 'alert_color',
			type: 'string',
			convert: function (v,r) {
				var min = r.get('minutes');

				if(min > 30){
					return 'lightcoral';
				}
				if(min > 20){
					return 'lightpink';
				}
				if(min > 10){
					return 'lightblue';
				}
				if(min > 5){
					return 'lightyellow';
				}

				return '';
			}
		}
	]
});
Ext.define('App.view.patient.windows.Charts', {
	extend: 'Ext.window.Window',
	requires: [],
	title: _('vector_charts'),
	modal: true,
	width: 1000,
	height: 700,
	layout: 'fit',
	itemId: 'PatientChartsWindow',
    items: [
        {
            xtype: 'miframe',
	        itemId: 'PatientChartsIframe',
        }
    ],
	tbar: [
		{
			text: 'Weight vs Age (0-5)',
			itemId: 'PatientChartWeightVsAgeToFiveBtn',
		},
		'-',
		{
			text: 'Weight vs Age (2-20)',
			itemId: 'PatientChartWeightVsAgeToTwentyBtn',
		},
		'-',
		{
			text: 'Head Circumference vs Age (0-5)',
			itemId: 'PatientChartHeadCircumferenceVsAgeToFiveBtn',
		},
		'-',
		{
			text: 'Length vs Age (0-5)',
			itemId: 'PatientChartLengthVsAgeToFiveBtn',
		},
		'-',
		{
			text: 'BMI (2-20)',
			itemId: 'PatientChartBMIBtn',
		}
	]
});

Ext.define('App.view.patient.windows.PreventiveCare', {
	extend: 'App.ux.window.Window',
	title: _('preventive_care_window'),
	closeAction: 'hide',
	bodyStyle: 'background-color:#fff',
	modal: true,
	bodyPadding: 5,
	initComponent: function(){
		var me = this;

		me.patientPreventiveCare = Ext.create('App.store.patient.PreventiveCare', {
			groupField: 'type',
			sorters: ['type'],
			autoSync: true
		});

		me.grid = Ext.create('Ext.grid.Panel', {
			store: me.patientPreventiveCare,
			height: 400,
			width: 700,
			features: Ext.create('Ext.grid.feature.Grouping', {
				groupHeaderTpl: _('type') + ': {name} ({rows.length} ' + _('item') + '{[values.rows.length > 1 ? "s" : ""]})',
				hideGroupedHeader: true,
				startCollapsed: true
			}),
			columns: [
				{
					header: _('type'),
					dataIndex: 'type',
					width: 200
				},
				{
					header: _('description'),
					dataIndex: 'description',
					width: 200
				},
				{
					header: _('reason'),
					dataIndex: 'reason',
					flex: 1

				}

			],
			plugins: Ext.create('App.ux.grid.RowFormEditing', {
				autoCancel: false,
				errorSummary: false,
				clicksToEdit: 1,
				items: [
					{
						title: _('general'),
						xtype: 'container',
						padding: 10,
						layout: 'vbox',
						items: [
							{
								/**
								 * Line one
								 */
								xtype: 'fieldcontainer',
								layout: 'hbox',
								defaults: { margin: '0 10 5 0' },
								items: [
									{
										xtype: 'textfield',
										name: 'reason',
										fieldLabel: _('reason'),
										width: 585,
										labelWidth: 70,
										disabled: true,
										allowBlank: false,
										action: 'reason'
									}

								]

							},
							{
								/**
								 * Line two
								 */
								xtype: 'fieldcontainer',
								layout: 'hbox',
								defaults: { margin: '0 10 5 0' },
								items: [

									{
										xtype: 'textfield',
										fieldLabel: _('observation'),
										name: 'observation',
										width: 250,
										labelWidth: 70,
										disabled: true,
										action: 'observation'
									},
									{
										fieldLabel: _('date'),
										xtype: 'datefield',
										disabled: true,
										action: 'date',
										width: 200,
										labelWidth: 40,
										format: g('date_display_format'),
										name: 'date'

									},
									{
										xtype: 'checkboxfield',
										name: 'dismiss',
										fieldLabel: _('dismiss_alert'),
										enableKeyEvents: true,
										listeners: {
											scope: me,
											change: me.onChangeOption

										}
									},
									{
										xtype: 'textfield',
										hidden: true,
										name: 'eid',
										action: 'eid'
									}

								]

							}
						]
					}

				]
			})


		});

		me.items = [ me.grid ];

		//		me.listeners = {
		//			scope: me,
		//			show: me.onPreventiveCareWindowShow
		//		};

		this.callParent(arguments);

	},
	onChangeOption: function(field, newValue){
		var reason = field.up('form').query('[action="reason"]')[0],
			date = field.up('form').query('[action="date"]')[0],
			eid = field.up('form').query('[action="eid"]')[0],
			observation = field.up('form').query('[action="observation"]')[0];

		eid.setValue(app.patient.eid);

		if(newValue){
			reason.setDisabled(false);
			date.setDisabled(false);
			observation.setDisabled(false);
		}else if(!newValue){
			reason.setDisabled(true);
			date.setDisabled(true);
			observation.setDisabled(true);

		}else{
			reason.setDisabled(true);
			date.setDisabled(true);
			observation.setDisabled(true);
		}
	},

	loadPatientPreventiveCare: function(){
		var me = this;
		this.patientPreventiveCare.load({
			scope: me,
			params: {
				pid: app.patient.pid
			},
			callback: function(records, operation, success){
				if(records.length > 0){
					me.show();
					return true;
				}else{
					return false;
				}
			}
		});
	}

	//	onPreventiveCareWindowShow: function() {
	//	    this.patientPreventiveCare.load({params: {pid: app.patient.pid }});
	//
	//    }

});

Ext.define('App.view.patient.windows.DocumentErrorNote', {
	extend: 'Ext.window.Window',
	xtype: 'patientdocumenterrornotewindow',
	draggable: false,
	modal: true,
	autoShow: true,
	title: _('error_note'),
	items: [
		{
			xtype: 'form',
			bodyPadding: 10,
			width: 400,
			items: [
				{

					xtype: 'textareafield',
					anchor: '100%',
					labelWidth: 70,
					labelAlign: 'top',
					name: 'error_note',
					allowBlank: false
				}
			]
		}
	],
	buttons: [
		{
			text: _('cancel'),
			itemId: 'DocumentErrorNoteCancelBtn',
			handler: function(btn){
				btn.up('window').close();
			}
		},
		{
			text: _('save'),
			itemId: 'DocumentErrorNoteSaveBtn'
		}
	]
});
Ext.define('App.view.patient.windows.DocumentViewer', {
	extend: 'Ext.window.Window',
	xtype: 'documentviewerwindow',
	title: _('documents_viewer_window'),
	layout: 'fit',
	height: 700,
	width: 800,
	bodyStyle: 'background-color:#fff',
	maximizable: true,
	defaults: {
		margin: 5
	},
	tbar: [
		'->',
		{
			text: _('archive_and_add_to_print_jobs'),
			itemId: 'documentViewerAddToPrintJobBtn',
			icon: 'resources/images/icons/add.png'
		},
		{
			text: _('archive_document'),
			itemId: 'archiveDocumentBtn',
			icon: 'resources/images/icons/save.png'
		}
	]
});
Ext.define('App.view.patient.windows.ArrivalLog', {
	extend: 'App.ux.window.Window',
	title      : _('patient_arrival_log'),
	closeAction: 'hide',
    layout     : 'fit',
	modal      : true,
	width      : 900,
	height     : 600,
	maximizable: true,
	initComponent: function() {
		var me = this;


        me.store = Ext.create('App.store.patient.PatientArrivalLog',{
            autoSync:true
        });

		me.tbar = [
            {
                xtype       : 'patienlivetsearch',
                fieldLabel  : _('look_for_patient'),
                width       : 400,
                hideLabel:false,
                enableKeyEvents:true,
                listeners:{
                    scope:me,
                    select:me.onPatientSearchSelect,
                    keyup:me.onPatientSearchKeyUp

                }
		    },
            '-',
            {
                text: _('add_new_patient'),
                iconCls:'icoAddRecord',
                action:'newPatientBtn',
                disabled:true,
                scope:me,
                handler:me.onNewPatient
		    },
            '->',
            {
                xtype:'tool',
                type: 'refresh',
                scope:me,
                handler:me.onGridReload
            }
        ];

		me.items = [
            me.ckGrid = Ext.create('Ext.grid.Panel',{
                store:me.store,
                margin:5,
                columns:[
                    {
                        xtype:'actioncolumn',
                        width:25,
                        items: [
                            {
                                icon: 'resources/images/icons/delete.png',  // Use a URL in the icon config
                                tooltip: _('remove'),
                                scope:me,
                                handler: me.onPatientRemove
                            }
                        ]
                    },
                    {
                        header: _('time'),
                        dataIndex:'time',
	                    width:130
                    },
                    {
                        header: _('record') + ' #',
                        dataIndex:'pid'
                    },
                    {
                        header: _('patient_name'),
                        dataIndex:'name',
                        flex:1
                    },
                    {
                        header: _('insurance'),
                        dataIndex:'insurance'
                    },
                    {
                        header: _('area'),
                        dataIndex:'area'
                    },
                    {
                        width:25,
                        dataIndex:'warning',
                        renderer:me.warnRenderer
                    }
                ],
                listeners:{
                    scope:me,
                    itemdblclick:me.onPatientDlbClick
                }

            })
		];

		me.listeners = {
			scope:me,
			show:me.onWinShow
		};

		me.callParent(arguments);
	},

    onPatientSearchSelect:function(field, record){
        var me = this,
            store = me.query('grid')[0].getStore(),
            btn = me.query('button[action="newPatientBtn"]')[0];
        store.add({
            pid:record[0].data.pid,
            name:record[0].data.fullname,
            time: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
            isNew:false
        });
        field.reset();
        btn.setDisabled(true);
    },

    onPatientSearchKeyUp:function(field){
        this.query('button[action="newPatientBtn"]')[0].setDisabled(field.getValue() == null);
    },

    onNewPatient:function(btn){
        var me = this,
            field = me.query('patienlivetsearch')[0],
            name = field.getValue(),
            store = me.query('grid')[0].getStore();
        field.reset();
        btn.disable();
        store.add({
            name:name,
            time: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
            isNew:true
        });
    },

    onPatientRemove:function(grid, rowIndex){
        var store = grid.getStore(),
	        me = this,
            record = store.getAt(rowIndex);
	    Encounter.checkForAnOpenedEncounterByPid({pid:record.data.pid,date:Ext.Date.format(new Date(), 'Y-m-d H:i:s')}, function(provider, response){
		    if(response.result) {
			    me.msg(_('oops'), _('patient_have_a_opened_encounter'));
		    } else {
			    me.msg(_('sweet'), _('patient_have_been_removed'));
			    store.remove(record);
		    }
	    });




    },

    onPatientDlbClick:function(grid, record){
        var me = this,
            data = record.data;
	    // TODO: pass priority!
        app.setPatient(data.pid, data.name, null, function(){
            app.openPatientSummary();
        });
        me.close();
    },

    onGridReload:function(){
        this.store.load();
    },

	onWinShow:function(){
        var me = this;
        me.onGridReload();
        new Ext.util.DelayedTask(function(){
            me.query('patienlivetsearch')[0].focus();
        }).delay(1000);

	}

});

Ext.define('App.view.patient.windows.NewEncounter', {
	extend: 'Ext.window.Window',
	requires: [
		'App.ux.LiveReferringPhysicianSearch'
	],
	itemId: 'EncounterDetailWindow',
	title: _('encounter'),
	closeAction: 'hide',
	closable: false,
	modal: true,
	width: 700,
	layout: 'fit',
	initComponent: function () {
		var me = this;

		me.store = Ext.create('App.store.patient.Encounters');

		Ext.apply(me, {
			items: [
				me.encForm = Ext.create('Ext.form.Panel', {
						itemId: 'EncounterDetailForm',
						border: false,
						bodyPadding: '10 10 0 10',
						items: [
							{
								xtype: 'fieldcontainer',
								layout: 'column',
								items: [
									{
										xtype: 'fieldcontainer',
										layout: 'anchor',
										items: [
											{
												xtype: 'mitos.datetime',
												fieldLabel: 'Date of Service',
												labelWidth: 100,
												width: 300,
												margin: '0 5 5 0',
												name: 'service_date'
											},
											{
												xtype: 'gaiaehr.combo',
												fieldLabel: 'Visit Category',
												labelWidth: 100,
												width: 300,
												margin: '0 5 5 0',
												name: 'visit_category',
												listKey: 'visit_cat',
												editable: false,
												loadStore: true,
												queryMode: 'local'
											},
											{
												xtype: 'textareafield',
												fieldLabel: 'Chief Complaint',
												emptyText: 'Chief Complaint (Please Type a Brief Description)',
												hideLabel: true,
												enableKeyEvents: true,
												width: 300,
												height: 157,
												margin: '0 10 0 0',
												grow: false,
												name: 'brief_description'
											}
										]
									}, {
										xtype: 'fieldcontainer',
										layout: 'anchor',
										items: [
											{
												xtype: 'activeproviderscombo',
												fieldLabel: 'Provider',
												labelWidth: 120,
												width: 350,
												allowBlank: false,
												name: 'provider_uid',
												itemId: 'EncounterProviderCmb',
												editable: false
											},
											{
												xtype: 'activeproviderscombo',
												fieldLabel: 'Technician',
												labelWidth: 120,
												width: 350,
												name: 'technician_uid',
												editable: false
											},
											{
												xtype: 'activefacilitiescombo',
												fieldLabel: 'Facility',
												labelWidth: 120,
												width: 350,
												margin: '0 5 5 0',
												name: 'facility',
												editable: false
											},
											{
												xtype: 'gaiaehr.combo',
												fieldLabel: 'Priority',
												labelWidth: 120,
												width: 350,
												margin: '0 5 5 0',
												name: 'priority',
												listKey: 'enc_prio',
												editable: false,
												loadStore: true,
												queryMode: 'local'
											},
											{
												xtype: 'gaiaehr.combo',
												fieldLabel: 'Patient Class',
												labelWidth: 120,
												width: 350,
												name: 'patient_class',
												listKey: 'pat_class',
												editable: false,
												loadStore: true,
												queryMode: 'local'
											},
											{
												xtype: 'referringphysicianlivetsearch',
												fieldLabel: 'Ref. Physician',
												hideLabel: false,
												labelWidth: 120,
												width: 350,
												name: 'referring_physician'
											},
											{
												xtype: 'fieldcontainer',
												layout: 'hbox',
												items: [
													{
														xtype: 'checkbox',
														itemId: 'EncounterCcdaAvailableField',
														fieldLabel: _('ccda_available'),
														labelWidth: 120,
														name: 'summary_care_provided'
													},
													{
														xtype: 'checkbox',
														fieldLabel: _('requested'),
														labelWidth: 80,
														labelAlign: 'right',
														name: 'summary_care_requested'
													}
												]
											},
											{
												xtype: 'mitos.datetime',
												fieldLabel: 'Onset Hosp. Date',
												labelWidth: 120,
												width: 350,
												margin: '0 5 5 0',
												name: 'onset_date'
											},
											{
												xtype: 'checkbox',
												fieldLabel: 'Is Private',
												labelWidth: 120,
												name: 'is_private',
												disabled: !a('allow_to_create_private_encounter'),
												tooltip: 'Private encounters can only be access by encounter\'s provider'
											}
										]
									}
								]
							}
						]

					}
				)
			],
			buttons: [
				{
					text: _('delete'),
					itemId: 'EncounterDeletetBtn',
					cls: 'toolWarning',
					hidden: true
				},
				{
					text: _('transfer'),
					itemId: 'EncounterTransferBtn',
					cls: 'toolWarning',
					acl: a('transfer_encounters')
				},
				'->',
				{
					text: _('save'),
					action: 'encounter',
					scope: me,
					disableOnCLick: true,
					handler: me.onFormSave
				},
				{
					text: _('cancel'),
					scope: me,
					handler: me.cancelNewEnc
				}
			],
			listeners: {
				show: me.checkValidation,
				hide: me.resetRecord
			}
		}, me);

		me.callParent(arguments);
	},

	checkValidation: function () {
		var me = this,
			form = me.down('form').getForm(),
			record = form.getRecord(),
			brief_description_field = form.findField('brief_description');

		if (app.patient.pid) {
			if (!record && a('add_encounters')) {

				me.loadRecord(
					Ext.create('App.model.patient.Encounter', {
						pid: app.patient.pid,
						service_date: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
						priority: 'Minimal',
						open_uid: app.user.id,
						facility: app.user.facility,
						billing_facility: app.user.facility,
						brief_description: g('default_chief_complaint')
					})
				);

				if (brief_description_field) brief_description_field.enable();


				Encounter.checkOpenEncountersByPid(app.patient.pid, function (provider, response) {
					if (response.result.encounter) {
						Ext.Msg.show({
							title: _('oops') + ' ' + _('open_encounters_found') + '...',
							msg: _('do_you_want_to') + ' <strong>' + _('continue_creating_the_new_encounters') + '</strong><br>"' + _('click_no_to_review_encounter_history') + '"',
							buttons: Ext.Msg.YESNO,
							icon: Ext.Msg.QUESTION,
							fn: function (btn) {
								if (btn != 'yes') {
									me.hide();
									form.reset();
								}
							}
						});
					}
				});
			} else if (record && a('edit_encounters')) {

				if (brief_description_field) brief_description_field.disable();

			} else {
				app.accessDenied();
			}
		} else {
			app.currPatientError();
		}
	},

	onFormSave: function (btn) {
		var me = this,
			form = me.encForm.getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			isNew = record.data.eid === 0;

		if (form.isValid()) {
			if ((isNew && a('add_encounters') || (!isNew && a('edit_encounters')))) {
				record.set(values);

				say(values);

				record.save({
					callback: function (record) {
						if (isNew) {
							var data = record.data;
							app.patientButtonRemoveCls();
							app.patientBtn.addCls(data.priority);
							app.openEncounter(data.eid);
						}
						me.close();
					}
				});
			} else {
				btn.up('window').close();
				app.accessDenied();
			}
		}
	},

	loadRecord: function (record) {
		this.encForm.getForm().loadRecord(record);
	},

	resetRecord: function () {
		this.down('form').getForm().reset(true);
		delete this.down('form').getForm()._record;
	},

	cancelNewEnc: function () {
		this.close();
	}

});

Ext.define('App.store.patient.CheckoutAlertArea', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.CheckoutAlertArea',
	remoteSort: false,
	autoLoad  : false
});


Ext.define('App.model.patient.Patient',{
    extend: 'Ext.data.Model',
    requires: [
        'App.model.patient.Insurance',
        'App.model.patient.Allergies',
        'App.model.patient.Medications',
        'App.model.patient.PatientActiveProblem'
    ],
    table: {
        name: 'patient'
    },
    fields: [
        {
            name: 'pid',
            type: 'int',
            comment: 'patient ID'
        },
	    {
		    name: 'pubpid',
		    type: 'string',
		    index: true,
		    comment: 'record number',
		    len: 40
	    },
	    {
		    name: 'pubpid_issuer',
		    type: 'string',
		    index: true,
		    comment: 'record number issuer ',
		    len: 40
	    },
	    {
		    name: 'interface_number',
		    type: 'string',
		    index: true,
		    comment: 'interface reference number',
		    len: 40
	    },
        {
            name: 'title',
            type: 'string',
            comment: 'Title Mr. Sr.',
            len: 10
        },
        {
            name: 'fname',
            type: 'string',
            comment: 'first name',
            index: true,
            len: 35
        },
        {
            name: 'mname',
            type: 'string',
            comment: 'middle name',
            index: true,
            len: 25
        },
        {
            name: 'lname',
            type: 'string',
            comment: 'last name',
            index: true,
            len: 60
        },
        {
            name: 'suffix',
            type: 'string',
            len: 35
        },
        {
            name: 'sex',
            type: 'string',
            comment: 'sex',
            index: true,
            len: 10
        },
        {
            name: 'orientation',
            type: 'string',
            comment: 'sex orientation',
            index: true,
            len: 15
        },
        {
            name: 'identity',
            type: 'string',
            comment: 'sex identity',
            index: true,
            len: 15
        },
        {
            name: 'DOB',
            type: 'date',
            comment: 'day of birth',
            dateFormat: 'Y-m-d H:i:s',
            index: true,
            defaultValue: '0000-00-00 00:00:00'
        },
        {
            name: 'DOBFormatted',
            type: 'string',
            persist: false,
            convert: function (v, record) {
                return Ext.Date.format(record.get('DOB'), g('date_display_format'));
            }
        },
        {
            name: 'marital_status',
            type: 'string',
            comment: 'marital status',
            len: 40
        },
        {
            name: 'SS',
            type: 'string',
            index: true,
            comment: 'social security',
            len: 40
        },
	    {
		    name: 'drivers_license',
		    type: 'string',
		    index: true,
		    comment: 'driver licence #',
		    len: 40
	    },
	    {
		    name: 'drivers_license_state',
		    type: 'string',
		    len: 40
	    },
	    {
		    name: 'drivers_license_exp',
		    type: 'date',
		    dataType: 'date',
		    dateFormat: 'Y-m-d'
	    },
	    {
		    name: 'provider',
		    type: 'string',
            len: 40
	    },
	    {
		    name: 'pharmacy',
		    type: 'string',
            len: 40
	    },
	    {
		    name: 'hipaa_notice',
		    type: 'string',
		    comment: 'HIPAA notice status',
		    len: 40
	    },
        {
            name: 'record_number',
            type: 'string',
            persist: false
        },
        {
            name: 'fulladdress',
            type: 'string',
            persist: false,
            convert: false
        },
        {
            name: 'phones',
            type: 'string',
            store: false
        },
        {
            name: 'race',
            type: 'string',
            comment: 'race',
            len: 40
        },
        {
            name: 'secondary_race',
            type: 'string',
            comment: 'secondary race',
            len: 40
        },
        {
            name: 'tertiary_race',
            type: 'string',
            comment: 'tertiary race',
            len: 40
        },
        {
            name: 'ethnicity',
            type: 'string',
            comment: 'ethnicity',
            len: 40
        },
        {
            name: 'secondary_ethnicity',
            type: 'string',
            len: 40
        },
        {
            name: 'language',
            type: 'string',
            comment: 'language',
            len: 10
        },
        {
            name: 'birth_fname',
            type: 'string',
            len: 35
        },
        {
            name: 'birth_mname',
            type: 'string',
            len: 35
        },
        {
            name: 'birth_lname',
            type: 'string',
            len: 60
        },
        {
            name: 'allow_leave_msg',
            type: 'bool'
        },
        {
            name: 'allow_voice_msg',
            type: 'bool'
        },
        {
            name: 'allow_mail_msg',
            type: 'bool'
        },
        {
            name: 'allow_sms',
            type: 'bool'
        },
        {
            name: 'allow_email',
            type: 'bool'
        },
        {
            name: 'allow_immunization_registry',
            type: 'bool'
        },
        {
            name: 'allow_immunization_info_sharing',
            type: 'bool'
        },
        {
            name: 'allow_health_info_exchange',
            type: 'bool'
        },
        {
            name: 'allow_patient_web_portal',
            type: 'bool'
        },
        {
            name: 'allow_guardian_web_portal',
            type: 'bool'
        },
        {
            name: 'allow_guardian_web_portal_cda',
            type: 'bool'
        },
        {
            name: 'allow_emergency_contact_web_portal',
            type: 'bool'
        },
        {
            name: 'allow_emergency_contact_web_portal_cda',
            type: 'bool'
        },
        {
            name: 'organ_donor_code',
            type: 'string',
	        len: 10,
	        defaultValue: 'U'
        },
        {
            name: 'occupation',
            type: 'string',
            comment: 'patient occupation',
            len: 40
        },
        {
            name: 'employer_name',
            type: 'string',
            len: 60
        },
        {
            name: 'employer_address',
            type: 'string',
            len: 55
        },
        {
            name: 'employer_city',
            type: 'string',
            len: 30
        },
        {
            name: 'employer_state',
            type: 'string',
            len: 2
        },
        {
            name: 'employer_country',
            type: 'string',
            len: 3
        },
        {
            name: 'employer_postal_code',
            type: 'string',
            len: 15
        },
        {
            name: 'rating',
            type: 'int',
            comment: 'patient stars rating'
        },
        {
            name: 'image',
            type: 'string',
            dataType: 'mediumtext',
            comment: 'patient image base64 string'
        },
        {
            name: 'qrcode',
            type: 'string',
            dataType: 'mediumtext',
            comment: 'patient QRCode base64 string'
        },
	    {
		    name: 'pubaccount',
		    type: 'string',
		    index: true,
		    comment: 'external reference account',
		    len: 40
	    },
        {
            name: 'birth_place',
            type: 'string',
            len: 150
        },
        {
            name: 'birth_multiple',
            type: 'bool',
            useNull: true
        },
        {
            name: 'birth_order',
            type: 'int',
            useNull: true,
            len: 2
        },
        {
            name: 'is_veteran',
            type: 'string',
            len: 1
        },
        {
            name: 'deceased',
            type: 'string',
            len: 1
        },
        {
            name: 'death_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'death_cause',
            type: 'string',
            len: 180
        },
        {
            name: 'alias',
            type: 'string',
            len: 80
        },
        {
            name: 'citizenship',
            type: 'string',
            len: 80
        },
        {
            name: 'primary_facility',
            type: 'int'
        },
        {
            name: 'first_visit_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'administrative_status',
            type: 'string',
            comment: 'active | inactive | merged',
            len: 15
        },
        {
            name: 'create_uid',
            type: 'int',
            comment: 'create user ID'
        },
        {
            name: 'update_uid',
            type: 'int',
            comment: 'update user ID'
        },
        {
            name: 'create_date',
            type: 'date',
            comment: 'create date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            comment: 'last update date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'portal_password',
            type: 'string',
            dataType: 'blob',
            encrypt: true
        },
        {
            name: 'portal_username',
            type: 'string',
	        len: 40
        },
	    {
		    name: 'phone_publicity',
		    type: 'string',
		    len: 10
	    },
	    {
		    name: 'phone_publicity_date',
		    type: 'date',
            dataType: 'date'
	    },
        {
            name: 'phone_home',
            type: 'string',
	        len: 25
        },
        {
            name: 'phone_mobile',
            type: 'string',
	        len: 25
        },
        {
            name: 'phone_work',
            type: 'string',
	        len: 25
        },
        {
            name: 'phone_work_ext',
            type: 'string',
	        len: 25
        },
	    {
		    name: 'phone_fax',
		    type: 'string',
		    len: 25
	    },
        {
            name: 'email',
            type: 'string',
	        len: 80
        },
        {
            name: 'postal_address',
            type: 'string',
	        len: 55
        },
        {
            name: 'postal_address_cont',
            type: 'string',
	        len: 55
        },
        {
            name: 'postal_city',
            type: 'string',
	        len: 30
        },
        {
            name: 'postal_state',
            type: 'string',
	        len: 2
        },
        {
            name: 'postal_zip',
            type: 'string',
	        len: 15
        },
        {
            name: 'postal_country',
            type: 'string',
	        len: 3
        },
        {
            name: 'physical_address',
            type: 'string',
	        len: 55
        },
        {
            name: 'physical_address_cont',
            type: 'string',
	        len: 55
        },
        {
            name: 'physical_city',
            type: 'string',
	        len: 30
        },
        {
            name: 'physical_state',
            type: 'string',
	        len: 2
        },
        {
            name: 'physical_zip',
            type: 'string',
	        len: 15
        },
        {
            name: 'physical_country',
            type: 'string',
	        len: 3
        },
	    {
		    name: 'mother_pid',
		    type: 'int',
            index: true
	    },
	    {
		    name: 'mother_fname',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'mother_mname',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'mother_lname',
		    type: 'string',
		    len: 60
	    },
        {
            name: 'father_pid',
            type: 'int',
            index: true
        },
	    {
		    name: 'father_fname',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'father_mname',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'father_lname',
		    type: 'string',
		    len: 60
	    },
        {
            name: 'spouse_pid',
            type: 'int',
            index: true
        },
        {
            name: 'spouse_fname',
            type: 'string',
            len: 35
        },
        {
            name: 'spouse_mname',
            type: 'string',
            len: 25
        },
        {
            name: 'spouse_lname',
            type: 'string',
            len: 60
        },
        {
            name: 'guardians_pid',
            type: 'int',
            index: true
        },
	    {
		    name: 'guardians_relation',
		    type: 'string',
		    len: 20
	    },
        {
            name: 'guardians_fname',
            type: 'string',
	        len: 35
        },
        {
            name: 'guardians_mname',
            type: 'string',
	        len: 25
        },
        {
            name: 'guardians_lname',
            type: 'string',
	        len: 60
        },
        {
            name: 'guardians_phone',
            type: 'string',
	        len: 25
        },
        {
            name: 'guardians_phone_type',
            type: 'string',
	        len: 10
        },
        {
            name: 'guardians_address',
            type: 'string',
            len: 55
        },
        {
            name: 'guardians_address_cont',
            type: 'string',
            len: 55
        },
        {
            name: 'guardians_city',
            type: 'string',
            len: 30
        },
        {
            name: 'guardians_state',
            type: 'string',
            len: 2
        },
        {
            name: 'guardians_country',
            type: 'string',
            len: 3
        },
        {
            name: 'guardians_zip',
            type: 'string',
            len: 15
        },
        {
            name: 'guardian_portal_password',
            type: 'string',
            dataType: 'blob',
            encrypt: true
        },
        {
            name: 'guardian_portal_username',
            type: 'string',
            len: 40
        },
        {
            name: 'emergency_contact_relation',
            type: 'string',
	        len: 20
        },
        {
            name: 'emergency_contact_fname',
            type: 'string',
	        len: 80
        },
        {
            name: 'emergency_contact_mname',
            type: 'string',
	        len: 25
        },
        {
            name: 'emergency_contact_lname',
            type: 'string',
	        len: 60
        },
        {
            name: 'emergency_contact_phone',
            type: 'string',
	        len: 25
        },
        {
            name: 'emergency_contact_phone_type',
            type: 'string',
            len: 10
        },
	    {
		    name: 'emergency_contact_address',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'emergency_contact_address_cont',
		    type: 'string',
		    len: 55
	    },
	    {
		    name: 'emergency_contact_city',
		    type: 'string',
		    len: 55
	    },
	    {
		    name: 'emergency_contact_state',
		    type: 'string',
		    len: 2
	    },
	    {
		    name: 'emergency_contact_country',
		    type: 'string',
		    len: 3
	    },
	    {
		    name: 'emergency_contact_zip',
		    type: 'string',
		    len: 15
	    },
        {
            name: 'emergency_contact_portal_password',
            type: 'string',
            dataType: 'blob',
            encrypt: true
        },
        {
            name: 'emergency_contact_portal_username',
            type: 'string',
            len: 40
        },
	    {
		    name: 'religion',
		    type: 'string',
		    len: 20
	    },
	    {
		    name: 'authorized_01_relation',
		    type: 'string',
		    len: 20
	    },
	    {
		    name: 'authorized_01_fname',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'authorized_01_mname',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_01_lname',
		    type: 'string',
		    len: 60
	    },
	    {
		    name: 'authorized_01_phone',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_01_phone_type',
		    type: 'string',
		    len: 10
	    },
	    {
		    name: 'authorized_02_relation',
		    type: 'string',
		    len: 20
	    },
	    {
		    name: 'authorized_02_fname',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'authorized_02_mname',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_02_lname',
		    type: 'string',
		    len: 60
	    },
	    {
		    name: 'authorized_02_phone',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_02_phone_type',
		    type: 'string',
		    len: 10
	    },
	    {
		    name: 'authorized_03_relation',
		    type: 'string',
		    len: 20
	    },
	    {
		    name: 'authorized_03_fname',
		    type: 'string',
		    len: 35
	    },
	    {
		    name: 'authorized_03_mname',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_03_lname',
		    type: 'string',
		    len: 60
	    },
	    {
		    name: 'authorized_03_phone',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'authorized_03_phone_type',
		    type: 'string',
		    len: 10
	    },
	    {
		    name: 'phone_mobile_supplier',
		    type: 'string',
		    len: 25
	    },
	    {
		    name: 'pbm_payer_id',
		    type: 'string',
		    len: 60
	    },
	    {
		    name: 'pbm_payer_name',
		    type: 'string',
		    len: 45
	    },
	    {
		    name: 'pbm_card_fname',
		    type: 'string',
		    len: 45
	    },
	    {
		    name: 'pbm_card_lname',
		    type: 'string',
		    len: 45
	    },
        {
            name: 'pbm_member_id',
            type: 'string',
            len: 45
        },
        {
            name: 'pbm_group',
            type: 'string',
            len: 45
        },
	    {
		    name: 'pbm_bin',
		    type: 'string',
		    len: 45
	    },
	    {
		    name: 'pbm_pcn',
		    type: 'string',
		    len: 45
	    },
	    {
		    name: 'pbm_consent',
		    type: 'string',
		    len: 45
	    },
        {
            name: 'immunization_registry_status',
            type: 'string',
            len: 10
        },
        {
            name: 'immunization_registry_status_date',
            type: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'protection_indicator',
            type: 'bool'
        },
        {
            name: 'protection_indicator_date',
            type: 'date',
            dataType: 'date'
        },
	    {
		    name: 'authy_id',
		    type: 'string',
		    len: 45,
            index: true
	    },
	    {
		    name: 'last_visit_id',
		    type: 'string',
		    len: 45,
            index: true
	    },
	    {
		    name: 'name',
		    type: 'string',
		    store: false
	    },
	    {
		    name: 'fullname',
		    type: 'string',
            convert: function (v, rec) {
                return rec.get('lname') + ', ' + rec.get('fname') + ' ' + rec.get('mname');
            },
		    store: false
	    }
    ],
    idProperty: 'pid',
    proxy: {
        type: 'direct',
        api: {
            read: 'Patient.getPatients',
            create: 'Patient.savePatient',
            update: 'Patient.savePatient'
        },
        writer: {
            writeAllFields: true
        }
    },
    hasMany: [
        {
            model: 'App.model.patient.Insurance',
            name: 'insurance',
            primaryKey: 'pid',
            foreignKey: 'pid'
        },
        {
            model: 'App.model.patient.Allergies',
            name: 'allergies',
            primaryKey: 'pid',
            foreignKey: 'pid'
        },
        {
            model: 'App.model.patient.Medications',
            name: 'medications',
            primaryKey: 'pid',
            foreignKey: 'pid'
        },
        {
            model: 'App.model.patient.PatientActiveProblem',
            name: 'activeproblems',
            primaryKey: 'pid',
            foreignKey: 'pid'
        },
        {
            model: 'App.model.patient.PatientContacts',
            name: 'contacts',
            primaryKey: 'pid',
            foreignKey: 'pid'
        }
    ],
    indexes: [
        {
            name: 'live_search_index',
            choice: 'INDEX',
            type: 'BTREE',
            columns: [
                'pid',
                'pubpid',
                'fname',
                'mname',
                'lname',
                'SS'
            ]
        }
    ]
});

Ext.define('App.model.patient.PatientPossibleDuplicate', {
	extend: 'App.model.patient.Patient',
	proxy: {
		type: 'direct',
		api: {
			read: 'Patient.getPossibleDuplicatesByDemographic'
		},
		reader:{
			root: 'data'
		}
	}
});

Ext.define('App.view.dashboard.panel.PortalDropZone', {
	extend: 'Ext.dd.DropTarget',

	constructor: function(portal, cfg) {
		this.portal = portal;
		Ext.dd.ScrollManager.register(portal.body);
        App.view.dashboard.panel.PortalDropZone.superclass.constructor.call(this, portal.body, cfg);
		portal.body.ddScrollConfig = this.ddScrollConfig;
	},

	ddScrollConfig: {
		vthresh  : 50,
		hthresh  : -1,
		animate  : true,
		increment: 200
	},

    createEvent: function(dd, e, data, col, c, pos) {
        return {
            portal: this.portal,
            panel: data.panel,
            columnIndex: col,
            column: c,
            position: pos,
            data: data,
            source: dd,
            rawEvent: e,
            status: this.dropAllowed
        };
    },

    notifyOver: function(dd, e, data) {
        var xy = e.getXY(),
            portal = this.portal,
            proxy = dd.proxy,
            cw,
            colIndex,
            colRight,
            cols,
            len,
            cmatch;

        // case column widths
        if (!this.grid) {
            this.grid = this.getGrid();
        }

        // handle case scroll where scrollbars appear during drag
        cw = portal.body.dom.clientWidth;
        if (!this.lastCW) {
            // set initial client width
            this.lastCW = cw;
        } else if (this.lastCW != cw) {
            // client width has changed, so refresh layout & grid calcs
            this.lastCW = cw;
            //portal.doLayout();
            this.grid = this.getGrid();
        }

        // determine column
        colIndex = 0,
        colRight = 0,
        cols = this.grid.columnX,
        len = cols.length,
        cmatch = false;

        for (len; colIndex < len; colIndex++) {
            colRight = cols[colIndex].x + cols[colIndex].w;
            if (xy[0] < colRight) {
                cmatch = true;
                break;
            }
        }
        // no match, fix last index
        if (!cmatch) {
            colIndex--;
        }

        // find insert position
        var overPortlet, pos = 0,
            h = 0,
            match = false,
            overColumn = portal.items.getAt(colIndex),
            portlets = overColumn.items.items,
            overSelf = false;

        len = portlets.length;

        for (len; pos < len; pos++) {
            overPortlet = portlets[pos];
            h = overPortlet.el.getHeight();
            if (h === 0) {
                overSelf = true;
            } else if ((overPortlet.el.getY() + (h / 2)) > xy[1]) {
                match = true;
                break;
            }
        }

        pos = (match && overPortlet ? pos : overColumn.items.getCount()) + (overSelf ? -1 : 0);
        var overEvent = this.createEvent(dd, e, data, colIndex, overColumn, pos);

        if (portal.fireEvent('validatedrop', overEvent) !== false && portal.fireEvent('beforedragover', overEvent) !== false) {

            // make sure proxy width is fluid in different width columns
            proxy.getProxy().setWidth('auto');
            if (overPortlet) {
                dd.panelProxy.moveProxy(overPortlet.el.dom.parentNode, match ? overPortlet.el.dom : null);
            } else {
                dd.panelProxy.moveProxy(overColumn.el.dom, null);
            }

            this.lastPos = {
                c: overColumn,
                col: colIndex,
                p: overSelf || (match && overPortlet) ? pos : false
            };
            this.scrollPos = portal.body.getScroll();

            portal.fireEvent('dragover', overEvent);
            return overEvent.status;
        } else {
            return overEvent.status;
        }

    },

	notifyOut: function() {
		delete this.grid;
	},

    notifyDrop: function(dd, e, data) {
            delete this.grid;
            if (!this.lastPos) {
                return;
            }
            var c = this.lastPos.c,
                col = this.lastPos.col,
                pos = this.lastPos.p,
                panel = dd.panel,
                dropEvent = this.createEvent(dd, e, data, col, c, pos !== false ? pos : c.items.getCount());

            if (this.portal.fireEvent('validatedrop', dropEvent) !== false &&
                this.portal.fireEvent('beforedrop', dropEvent) !== false) {

                Ext.suspendLayouts();

                // make sure panel is visible prior to inserting so that the layout doesn't ignore it
                panel.el.dom.style.display = '';
                dd.panelProxy.hide();
                dd.proxy.hide();

                if (pos !== false) {
                    c.insert(pos, panel);
                } else {
                    c.add(panel);
                }

                Ext.resumeLayouts(true);

                this.portal.fireEvent('drop', dropEvent);

                // scroll position is lost on drop, fix it
                var st = this.scrollPos.top;
                if (st) {
                    var d = this.portal.body.dom;
                    setTimeout(function() {
                        d.scrollTop = st;
                    },
                    10);
                }
            }

            delete this.lastPos;
            return true;
        },

	// internal cache of body and column coords
	getGrid   : function() {
		var box = this.portal.body.getBox();
		box.columnX = [];
		this.portal.items.each(function(c) {
			box.columnX.push({
				x: c.el.getX(),
				w: c.el.getWidth()
			});
		});
		return box;
	},

	// unregister the dropzone from ScrollManager
	unreg     : function() {
		Ext.dd.ScrollManager.unregister(this.portal.body);
        App.view.dashboard.panel.PortalDropZone.superclass.unreg.call(this);
	}
});

Ext.define('App.view.dashboard.Dashboard', {
	extend: 'App.ux.RenderPanel',
	requires: [

	],
	pageTitle: _('dashboard'),
	itemId: 'DashboardPanel',

	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			pageBody: [
				{
					xtype: 'portalpanel',
					region: 'center',
					items: [
						{
							itemId: 'DashboardColumn1'
						},
						{
							itemId: 'DashboardColumn2'
						}
					]
				}
			]
		});

		me.callParent();
	}
});

Ext.define('App.view.dashboard.panel.NotSignedVitals', {
	extend: 'Ext.grid.Panel',
	itemId: 'DashboardNotSignedVitalsGrid',
	requires: [
		'Ext.ux.SlidingPager'
	],
	height: 220,
	selModel:{
		mode: 'MULTI',
		allowDeselect: true
	},

	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.patient.Vitals', {
			remoteFilter: true,
			filters:[
				{
					property: 'auth_uid',
					value: 0
				}
			]
		});

		me.bbar = {
			xtype: 'pagingtoolbar',
			pageSize: 10,
			store: me.store,
			displayInfo: true,
			plugins: Ext.create('Ext.ux.SlidingPager'),
			items: [
				'-',
				{
					xtype: 'button',
					text: _('sign'),
					disabled: true,
					itemId: 'DashboardNotSignedVitalsSignBtn',
					icon: 'resources/images/icons/pen.png'
				}
			]
		};

		me.columns = [
			{
				xtype: 'datecolumn',
				text: _('date'),
				dataIndex: 'date'
			},
			{
				text: _('patient'),
				dataIndex: 'patient_lname',
				width: 200,
				renderer: function(v, met, rec){
					return Ext.String.format(
						'{0}, {1} {2} - {3}',
						(rec.get('patient_lname') || ''),
						(rec.get('patient_fname') || ''),
						(rec.get('patient_mname') || ''),
						(rec.get('patient_record_number') || rec.get('pid'))
					)
				}
			},
			{
				text: _('values'),
				dataIndex: 'code_text',
				flex: 1,
				renderer: function (v, meta, rec) {
					return Ext.String.format(
						'<b>BP:</b> {0}/{1}&nbsp;&nbsp;&nbsp;<b>PULSE:</b> {2}&nbsp;&nbsp;&nbsp;<b>TEMP:</b> {3}',
						(rec.get('bp_systolic') || 'NONE'),
						(rec.get('bp_diastolic') || 'NONE'),
						(rec.get('pulse') ? rec.get('pulse') + ' bpm' : 'NONE'),
						(rec.get('temp_f') ? rec.get('temp_f') + '&deg;' : 'NONE')
					)
				}
			},
			{
				text: _('administer_by'),
				dataIndex: 'administer_by',
				width: 200
			}
		];

		me.callParent(arguments);
	},

	signedRenderer: function(uid) {
		if(uid > 0) {
			return '<img style="padding-left: 13px" src="resources/images/icons/yes.png" />';
		} else {
			return '<img style="padding-left: 13px" src="resources/images/icons/no.png" />';
		}
	}
});

Ext.define('App.view.dashboard.panel.DailyVisits', {
	extend: 'Ext.panel.Panel',

	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			layout: 'fit',
			height: 300,
			items: {
				xtype: 'chart',
				itemId: 'DashboardDailyVisitsChart',
				animate: false,
				shadow: false,
				store: me.store = Ext.create('Ext.data.JsonStore', {
					fields: [
						{
							type: 'int',
							name: 'total_by_hour'
						},
						{
							type: 'date',
							name: 'service_hour',
							dateFormat: 'Y-m-d H:i:s'
						}
					]
				}),
				axes: [
					{
						type: 'Numeric',
						minimum: 0,
						decimals: 0,
						position: 'left',
						fields: [ 'total_by_hour' ],
						title: 'Patients Per Hour',
						majorTickSteps: 1,
						minorTickSteps: 0,
						label: {
							font: '11px Arial'
						}
					},
					{
						type: 'Time',
						position: 'bottom',
						fields: [ 'service_hour' ],
						title: 'Time',
						dateFormat: 'g:ia',
						step: [Ext.Date.HOUR, 1],
//						majorTickSteps: 5,
//						minorTickSteps: 1,
						constrain: true,
					}
				],
				series: [
					{
						type: 'column',
						highlight: true,
						axis: 'left',
						smooth: true,
						fill: true,
						// xField: 'service_hour',
						// yField: 'total_by_hour',
						yField: 'total_by_hour',
						xField: 'service_hour',
						tips: {
							trackMouse: true,
							width: 140,
							height: 28,
							renderer: function(rec, item) {
								this.setTitle(rec.get('total_by_hour') + ' ' + _('encounters'));
							}
						}
					}
				]
			}
		});

		me.callParent();
	}
});

Ext.define('App.view.dashboard.panel.NewResults', {
	extend: 'Ext.grid.Panel',
	itemId: 'DashboardNewResultsGrid',
	requires: [
		'Ext.ux.SlidingPager'
	],
	height: 220,
	columnLines: true,
	disableSelection: true,
	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.patient.PatientsOrderResults');

		me.bbar = {
			xtype: 'pagingtoolbar',
				pageSize: 10,
				store: me.store,
				displayInfo: true,
				plugins: Ext.create('Ext.ux.SlidingPager')
		};

		me.columns = [
			{
				text: _('signed'),
				dataIndex: 'signed_uid',
				width: 60,
				renderer: function(v){
					return me.signedRenderer(v);
				}
			},
			{
				xtype: 'datecolumn',
				text: _('received'),
				dataIndex: 'create_date'
			},
			{
				text: _('description'),
				dataIndex: 'code_text',
				flex: 1
			},
			{
				text:  _('status'),
				renderer: this.pctChange,
				dataIndex: 'result_status'
			}
		];

		me.callParent(arguments);
	},

	signedRenderer: function(uid) {
		if(uid > 0) {
			return '<img style="padding-left: 13px" src="resources/images/icons/yes.png" />';
		} else {
			return '<img style="padding-left: 13px" src="resources/images/icons/no.png" />';
		}
	},

	/**
	 * Custom function used for column renderer
	 * @param {Object} val
	 */
	change: function(val){
		if(val > 0){
			return '<span style="color:green;">' + val + '</span>';
		}else if(val < 0){
			return '<span style="color:red;">' + val + '</span>';
		}
		return val;
	},

	/**
	 * Custom function used for column renderer
	 * @param {Object} val
	 */
	pctChange: function(val){
		if(val > 0){
			return '<span style="color:green;">' + val + '%</span>';
		}else if(val < 0){
			return '<span style="color:red;">' + val + '%</span>';
		}
		return val;
	},

});

Ext.define('App.view.dashboard.panel.OpenEncounters', {
	extend: 'Ext.grid.Panel',
	itemId: 'DashboardOpenEncountersGrid',
	requires: [
		'Ext.ux.SlidingPager'
	],
	height: 220,
	// selModel:{
	// 	mode: 'MULTI',
	// 	allowDeselect: true
	// },

	initComponent: function(){
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{
					name: 'service_date',
					type: 'date',
					dateFormat: 'Y-m-d H:i:s'
				},
				{
					name: 'provider',
					type: 'string'
				},
				{
					name: 'patient',
					type: 'string'
				},
				{
					name: 'pid',
					type: 'int'
				},
				{
					name: 'eid',
					type: 'int'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Encounter.getOpenEncounters'
				},
				reader: {
					root: 'data'
				},
				remoteGroup: false
			}
		});

		me.bbar = {
			xtype: 'pagingtoolbar',
			pageSize: 10,
			store: me.store,
			displayInfo: true,
			plugins: Ext.create('Ext.ux.SlidingPager'),
		};

		me.columns = [
			{
				xtype: 'datecolumn',
				text: _('service_date'),
				dataIndex: 'service_date',
				format: 'Y-m-d'
			},
			{
				text: _('patient'),
				dataIndex: 'patient',
				flex: 1
			},
			{
				text: _('provider'),
				dataIndex: 'provider',
				flex: 1
			}
		];

		me.callParent(arguments);
	}
});

Ext.define('App.view.areas.FloorPlan', {
	extend: 'App.ux.RenderPanel',
	itemId: 'FloorPlanPanel',
	pageTitle: _('area_floor_plan'),
	pageBody: [
		{
			xtype: 'panel',
			title: _('floor_plans'),
			layout: 'absolute',
			itemId: 'FloorPlanPatientZonePanel',
			tbar: [
				'->',
				{
					xtype: 'floorplanareascombo',
					fieldLabel: _('area'),
					labelWidth: 40,
					itemId: 'FloorPlanAreasCombo'
				}
			],
			tools: [
				{
					type: 'refresh',
					handler: function(){
						App.app.getController('areas.FloorPlan').setZones();
					}
				}
			]
		}
	]
});
Ext.define('App.view.patient.charts.HeightForStature',
{
	extend : 'Ext.panel.Panel',
	layout : 'fit',
	margin : 5,
	title : _('weight_for_age'),

	initComponent : function()
	{
		var me = this;

		me.items = [
		{

			xtype : 'chart',
			store : me.store,
			animate : false,
			shadow : false,
			legend :
			{
				position : 'right'
			},
			axes : [
			{
				title : _('weight_kg'),
				type : 'Numeric',
				position : 'left',
				fields : ['PP', 'P3', 'P5', 'P10', 'P25', 'P50', 'P75', 'P85', 'P90', 'P95', 'P97'],
				grid :
				{
					odd :
					{
						opacity : 1,
						stroke : '#bbb',
						'stroke-width' : 0.5
					}
				},
				minimum : 7,
				maximum : 31
			},
			{
				title : _('length_cm'),
				type : 'Numeric',
				position : 'bottom',
				fields : ['height'],
				minimum : 77,
				maximum : 121.5
			}],
			series : [
			{
				title : _('weight_kg'),
				type : 'scatter',
				axis : 'left',
				xField : 'height',
				yField : 'PP',
				smooth : true,
				highlight :
				{
					size : 10,
					radius : 10
				},
				markerConfig :
				{
					type : 'circle',
					size : 5,
					radius : 5,
					'stroke-width' : 0
				},
				tips :
				{
					trackMouse : true,
					renderer : function(storeItem, item)
					{
						this.update(_('length_cm') + ': ' + storeItem.get('height') + '<br>' + _('weightArray') + ': ' + storeItem.get('PP'));
					}
				}
			},
			{
				title : '97%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P97',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '95%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P95',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '85%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P85',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '75%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P75',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '50%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P50',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 3,
					opacity : 0.5
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 4
				}
			},
			{
				title : '25%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P25',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '10%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P10',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '5%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P5',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '3%',
				type : 'line',
				axis : 'left',
				xField : 'height',
				yField : 'P3',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			}]
		}];

		me.callParent(arguments);

	}
}); 
Ext.define('App.store.patient.AppointmentRequests', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.AppointmentRequest'
});
Ext.define('App.view.patient.encounter.AppointmentRequestGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'appointmentrequestgrid',
	itemId: 'AppointmentRequestGrid',
	frame: true,
	store: Ext.create('App.store.patient.AppointmentRequests'),
	initComponent: function(){
		var me = this;

		me.columns = [
			{
				xtype: 'griddeletecolumn',
				width: 25
			},
			{
				xtype: 'datecolumn',
				text: _('requested_date'),
				dataIndex: 'requested_date',
				width: 120,
				format: g('date_display_format')
			},
			{
				xtype: 'datecolumn',
				text: _('approved_date'),
				dataIndex: 'approved_date',
				width: 150,
				format: g('date_display_format')
			},
			{
				text: _('notes'),
				dataIndex: 'notes',
				flex: 1
			}
		];

		me.callParent();
	},
	tbar: [
		_('appointment_requests'),
		'->',
		{
			text: _('appointment_request'),
			itemId: 'AppointmentRequestAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	]


});
Ext.define('App.view.patient.charts.HeadCircumference',
{
	extend : 'Ext.panel.Panel',
	layout : 'fit',
	margin : 5,
	initComponent : function()
	{
		var me = this;

		me.items = [
		{
			xtype : 'chart',
			store : me.store,
			animate : false,
			shadow : false,
			legend :
			{
				position : 'right'
			},
			axes : [
			{
				title : me.xTitle,
				type : 'Numeric',
				position : 'left',
				fields : ['PP', 'P3', 'P5', 'P10', 'P25', 'P50', 'P75', 'P90', 'P95', 'P97'],
				grid :
				{
					odd :
					{
						opacity : 1,
						stroke : '#bbb',
						'stroke-width' : 0.5
					}
				},
				minimum : me.xMinimum,
				maximum : me.xMaximum
			},
			{
				title : me.yTitle,

				type : 'Numeric',
				position : 'bottom',
				fields : ['age'],
				minimum : me.yMinimum,
				maximum : me.yMaximum
			}],
			series : [
			{
				title : _('circumference_cm'),
				type : 'scatter',
				axis : 'left',
				xField : 'age',
				yField : 'PP',
				smooth : true,
				highlight :
				{
					size : 10,
					radius : 10
				},
				markerConfig :
				{
					type : 'circle',
					size : 5,
					radius : 5,
					'stroke-width' : 0
				},
				tips :
				{
					trackMouse : true,
					renderer : function(storeItem, item)
					{
						this.update(me.yTitle + ' : ' + storeItem.get('age') + '<br>' + me.xTitle + ': ' + storeItem.get('PP'));
					}
				}
			},
			{
				title : '97%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P97',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '95%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P95',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '75%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P75',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '50%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P50',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 3,
					opacity : 0.5
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 4
				}
			},
			{
				title : '25%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P25',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '10%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P10',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '5%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P5',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			},
			{
				title : '3%',
				type : 'line',
				axis : 'left',
				xField : 'age',
				yField : 'P3',
				smooth : true,
				showMarkers : false,
				style :
				{
					stroke : '#000000',
					'stroke-width' : 1,
					opacity : 0.3
				},
				highlight :
				{
					stroke : '#FF9900',
					size : 2
				}
			}]
		}];

		me.callParent(arguments);

	}
}); 
Ext.define('App.view.patient.charts.BPPulseTemp',
{
	extend : 'Ext.container.Container',
	layout :
	{
		type : 'vbox',
		align : 'stretch'
	},
	style : 'background-color:#fff',
	defaults :
	{
		xtype : 'panel',
		layout : 'fit',
		flex : 1
	},
	initComponent : function()
	{
		var me = this;

		me.items = [
		{
			title : _('blood_pressure'),
			margin : 5,
			items : [
			{
				xtype : 'chart',
				style : 'background:#fff',
				store : me.store,
				animate : false,
				shadow : true,
				legend :
				{
					position : 'right'
				},
				axes : [
				{
					title : _('blood_pressure'),
					type : 'Numeric',
					position : 'left',
					fields : ['bp_systolic', 'bp_diastolic', 'bp_systolic_normal', 'bp_diastolic_normal'],
					grid :
					{
						odd :
						{
							opacity : 1,
							stroke : '#bbb',
							'stroke-width' : 0.5
						}
					}
				},
				{
					title : _('date'),
					type : 'Time',
					dateFormat : 'Y-m-d h:i:s a',
					position : 'bottom',
					fields : ['date']
				}],
				series : [
				{
					title : _('systolic'),
					type : 'line',
					axis : 'left',
					xField : 'date',
					yField : 'bp_systolic',
					smooth : true,
					highlight :
					{
						size : 10,
						radius : 10
					},
					markerConfig :
					{
						type : 'circle',
						size : 5,
						radius : 5,
						'stroke-width' : 0
					},
					tips :
					{
						trackMouse : true,
						renderer : function(storeItem, item)
						{
							this.update('Date: ' + Ext.Date.format(storeItem.get('date'), 'Y-m-d h:i:s a') + '<br>Systolic: ' + storeItem.get('bp_systolic'));
						}
					}
				},
				{
					title : _('diastolic'),
					type : 'line',
					axis : 'left',
					xField : 'date',
					yField : 'bp_diastolic',
					smooth : true,
					highlight :
					{
						size : 5,
						radius : 5
					},
					markerConfig :
					{
						type : 'cross',
						size : 5,
						radius : 5,
						'stroke-width' : 0
					},
					tips :
					{
						trackMouse : true,
						renderer : function(storeItem, item)
						{
							this.update(_('date') + ': ' + Ext.Date.format(storeItem.get('date'), 'Y-m-d h:i:s a') + '<br>' + _('diastolic') + ': ' + storeItem.get('bp_diastolic'));
						}
					}

				},
				//                            {
				//                                type     : 'area',
				//                                highlight: true,
				//                                axis     : 'left',
				//                                xField   : 'date',
				//                                yField   : ['bp_diastolic_normal', 'bp_systolic_normal'],
				//                                style    : {
				//                                    opacity: 0.93
				//                                }
				//                            },
				{
					type : 'line',
					showMarkers : false,
					axis : 'left',
					xField : 'date',
					yField : 'bp_diastolic_normal',
					style :
					{
						stroke : '#000000',
						'stroke-width' : 1
					}
				},
				{
					type : 'line',
					showMarkers : false,
					axis : 'left',
					xField : 'date',
					yField : 'bp_systolic_normal',
					style :
					{
						stroke : '#000000',
						'stroke-width' : 1
					}
				}]
			}]
		},
		{
			title : 'Pulse',
			margin : '0 5 5 5',
			items : [
			{
				xtype : 'chart',
				style : 'background:#fff',
				store : me.store,
				animate : false,
				shadow : true,
				legend :
				{
					position : 'right'
				},
				axes : [
				{
					title : _('pulse_per_min'),
					type : 'Numeric',
					position : 'left',
					fields : ['pulse'],
					grid :
					{
						odd :
						{
							opacity : 1,
							stroke : '#bbb',
							'stroke-width' : 0.5
						}
					}
				},
				{
					title : _('date'),
					type : 'Time',
					dateFormat : 'Y-m-d h:i:s a',
					position : 'bottom',
					fields : ['date']

				}],
				series : [
				{
					title : _('pulse'),
					type : 'line',
					axis : 'left',
					xField : 'date',
					yField : 'pulse',
					smooth : true,
					highlight :
					{
						size : 10,
						radius : 10
					},
					markerConfig :
					{
						type : 'circle',
						size : 5,
						radius : 5,
						'stroke-width' : 0
					},
					tips :
					{
						trackMouse : true,
						renderer : function(storeItem, item)
						{
							this.update(_('date') + ': ' + Ext.Date.format(storeItem.get('date'), 'Y-m-d h:i:s a') + '<br>' + _('pulse_per_min') + ': ' + storeItem.get('pulse'));
						}
					}
				}]
			}]
		},
		{
			title : _('temperature'),
			margin : '0 5 5 5',
			items : [
			{

				xtype : 'chart',
				store : me.store,
				animate : false,
				shadow : true,
				legend :
				{
					position : 'right'
				},
				axes : [
				{
					title : _('temp_fahrenheits'),
					type : 'Numeric',
					position : 'left',
					fields : ['temp_f'],
					grid :
					{
						odd :
						{
							opacity : 1,
							stroke : '#bbb',
							'stroke-width' : 0.5
						}
					}
				},
				{
					title : _('date'),
					type : 'Time',
					dateFormat : 'Y-m-d h:i:s a',
					position : 'bottom',
					fields : ['date']

				}],
				series : [
				{
					title : _('temp_fahrenheits'),
					type : 'line',
					axis : 'left',
					xField : 'date',
					yField : 'temp_f',
					smooth : true,
					highlight :
					{
						size : 10,
						radius : 10
					},
					markerConfig :
					{
						type : 'circle',
						size : 5,
						radius : 5,
						'stroke-width' : 0
					},
					tips :
					{
						trackMouse : true,
						renderer : function(storeItem, item)
						{
							this.update(_('date') + ': ' + Ext.Date.format(storeItem.get('date'), 'Y-m-d h:i:s a') + '<br>' + _('temp_fahrenheits') + ': ' + storeItem.get('temp_f'));
						}
					}
				}]
			}]
		}];

		me.callParent(arguments);

	}
}); 
Ext.define('App.view.patient.windows.PossibleDuplicates', {
	extend: 'App.ux.window.Window',
	title: _('possible_duplicates'),
	itemId: 'PossiblePatientDuplicatesWindow',
	closeAction: 'hide',
	bodyStyle: 'background-color:#fff',
	modal: true,
	closable: false,
	requires: [
		'Ext.toolbar.Paging',
		'Ext.ux.SlidingPager'
	],
	initComponent: function(){
		var me = this;

		me.items = [
			{
				xtype: 'grid',
				store: me.store = Ext.create('App.store.patient.PatientPossibleDuplicates'),
				width: 700,
				maxHeight: 700,
				frame: true,
				margin: 5,
				hideHeaders: true,
				columns: [
					{
						dataIndex: 'image',
						width: 65,
						renderer: function(v){
							var src =  v != '' ? v : app.patientImage;
							return '<img src="' + src + '" class="icon32Round" />';
						}
					},
					{
						dataIndex: 'fullname',
						flex: 1,
						renderer: function(v, meta, record){

                            //say(record);
							return '<table cellpadding="1" cellspacing="0" border="0" width="100%" style="font-size: 12px;">' +
								'<tbody>' +

								'<tr>' +
								'<td width="20%"><b>' + _('record_number') + ':</b></td>' +
								'<td>' + record.get('pubpid') +'</td>' +
								'</tr>' +

								'<tr>' +
								'<td><b>' + _('patient') + ':</b></td>' +
								'<td>' + record.get('name') + ' (' + record.get('sex') + ') ' + record.get('DOBFormatted') + '</td>' +
								'</tr>' +
								'</tr>' +
								'<tr>' +
								'<td><b>' + _('address') + ':</b></td>' +
								'<td>' + record.get('fulladdress') + '</td>' +
								'</tr>' +

								'<tr>' +
								'<td><b>' + _('phones') + ':</b></td>' +
								'<td>' + record.get('phones') + '</td>' +
								'</tr>' +

								'<tr>' +
								'<td><b>' + _('driver_lic') + ':</b></td>' +
								'<td>' + record.get('drivers_license') + '</td>' +
								'</tr>' +

								'<tr>' +
								'<td><b>' + _('employer_name') + ':</b></td>' +
								'<td>' + record.get('employer_name') + '</td>' +
								'</tr>' +
								'</tbody>' +
								'</table>';

						}
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					store: me.store,
					displayInfo: true,
					plugins: Ext.create('Ext.ux.SlidingPager')
				}
			}
		];

		me.buttons = [
			{
				text: _('cancel'),
				itemId: 'PossiblePatientDuplicatesCancelBtn'
			},
			'-',
			{
				text: _('continue'),
				itemId: 'PossiblePatientDuplicatesContinueBtn'
			}
		];

		me.callParent();
	}
});
Ext.define('App.view.patient.encounter.CurrentProceduralTerminology', {
    extend:'Ext.panel.Panel',
    alias:'widget.currentproceduralterminology',
    autoScroll:true,
    border:false,
    bodyBorder:false,
    bodyPadding:5,
    bodyStyle: 'background-color:#fff',
    layout:'border',
    pid:null,
    eid:null,
    initComponent:function () {
        var me = this;


        me.referenceCptStore = Ext.create('App.store.patient.QRCptCodes');

        me.encounterCptStore = Ext.create('App.store.patient.EncounterServices', {
            autoSync:true,
            listeners:{
                scope:me,
                beforesync:me.beforesync
            }
        });


        me.cptFormEdit = Ext.create('App.ux.grid.RowFormEditing', {
            autoCancel:false,
            errorSummary:false,
            clicksToEdit:1,
            enableRemove:true,
            items:[
                {
                    fieldLabel: _('full_description'),
                    xtype:'displayfield',
                    name:'code_text',
                    anchor:'100%'
                },
                {
                    xtype:'container',
                    layout:'column',
                    items:[
                        {
                            xtype:'fieldcontainer',
                            layout:'anchor',
                            columnWidth:.5,
                            margin:'0 3 0 0',
                            defaults:{ xtype:'textfield' },
                            items:[
                                {
                                    fieldLabel: _('place_of_service'),
                                    name:'place_of_service',
                                    anchor:'100%'
                                },
                                {
                                    xtype:'checkbox',
                                    labelWidth:105,
                                    fieldLabel: _('emergency') + '?',
                                    name:'emergency'
                                },
                                {
                                    fieldLabel: _('charges'),
                                    name:'charge',
                                    anchor:'100%'
                                }
                            ]
                        },
                        {
                            xtype:'fieldcontainer',
                            layout:'anchor',
                            columnWidth:.5,
                            margin:'0 0 0 3',
                            defaults:{ xtype:'textfield', anchor:'100%', labelWidth:110 },
                            items:[
                                {
                                    fieldLabel: _('days_of_units'),
                                    name:'days_of_units'
                                },
                                {
                                    fieldLabel: _('essdt_fam_plan'),
                                    name:'essdt_plan'
                                },
                                {
                                    fieldLabel: _('modifiers'),
                                    xtype:'livecptsearch',
                                    hideLabel:false,
                                    name:'modifiers'
                                }

                            ]
                        }

                    ]
                },
                {
                    xtype:'liveicdxsearch',
                    fieldLabel: _('diagnosis'),
                    hideLabel:false,
                    name:'diagnosis'
                }
            ],
            listeners:{
                scope:me,
                afterremove:me.onCompleteRemove
            }
        });

        me.items = [
            {
                xtype:'panel',
                title: _('cpt_search'),
                itemId:'leftCol',
                region:'west',
                width:450,
                hidden:true,
                titleCollapse:true,
                margin:'0 5 0 0',
                bodyStyle:'background-color:#fff',
                layout:{
                    type:'vbox',
                    align:'stretch',
                    padding:5
                },
                items:[
                    {
                        xtype:'fieldset',
                        title: _('cpt_quick_reference_options'),
                        padding:'10 15',
                        margin:'0 0 3 0',
                        layout:'anchor',
                        items:{
                            xtype:'combobox',
                            anchor:'100%',
                            editable:false,
                            queryMode:'local',
                            valueField:'value',
                            displayField:'name',
                            store:Ext.create('Ext.data.Store', {
                                fields:['name', 'value'],
                                data:[
                                    { name: _('show_related_cpt_for_current_diagnostics'), value:0 },
                                    { name: _('show_cpt_history_for_this_patient'), value:1 },
                                    { name: _('show_cpt_commonly_used_by_clinic'), value:2 }
                                ]
                            }),
                            listeners:{
                                scope:me,
                                change:me.onQuickReferenceOption
                            }
                        }
                    },
                    Ext.create('Ext.ux.LiveSearchGridPanel', {
                        margins:0,
                        flex:1,
                        store:me.referenceCptStore,
                        viewConfig:{
                            copy:true,
                            stripRows:true,
                            loadMask:true,
                            plugins:[
                                {
                                    ptype:'gridviewdragdrop',
                                    dragGroup:'CPTGridDDGroup'
                                }
                            ]
                        },
                        columns:[
                            {
                                text: _('code'),
                                width:70,
                                sortable:true,
                                dataIndex:'code'
                            },
                            {
                                text: _('description'),
                                flex:1,
                                sortable:true,
                                dataIndex:'code_text_medium'
                            }
                        ]
                    })
                ],
                listeners:{
                    scope:me,
                    collapse:me.onQuickReferenceCollapsed
                }
            },
            {
                xtype:'panel',
                title: _('encounter_cpts'),
                region:'center',
                itemId:'rightCol',
                bodyStyle:'background-color:#fff',
                layout:{
                    type:'vbox',
                    align:'stretch',
                    padding:5
                },
                items:[
                    {
                        xtype:'fieldset',
                        title: _('cpt_live_sarch'),
                        padding:'10 15',
                        margin:'0 0 3 0',
                        layout:'anchor',
                        items:{
                            xtype:'livecptsearch',
                            listeners:{
                                scope:me,
                                select:me.onLiveCptSelect
                            }
                        }

                    },
                    {
                        xtype:'grid',
                        flex:1,
                        margins:0,
                        store:me.encounterCptStore,
                        columns:[
                            {
                                text: _('code'),
                                width:70,
                                sortable:true,
                                dataIndex:'code'
                            },
                            {
                                text: _('description'),
                                flex:1,
                                sortable:true,
                                dataIndex:'code_text'
                            },
                            {
                                text: _('status'),
                                width:50,
                                sortable:true,
                                dataIndex:'status',
                                renderer:me.status
                            }
                        ],
                        tbar:[
                            {
                                text: _('quick_reference'),
                                action:'referenceCptBtn',
                                enableToggle:true,
                                scope:me,
                                toggleHandler:me.onQuickReferenceToggle
                            },
                            '->',
                            {
                                text: _('reload'),
                                handler: function(){
                                    me.encounterCptStoreLoad(null);
                                }
                            }
                        ],
                        viewConfig:{
                            itemId:'view',
                            plugins: {
                                ptype:'gridviewdragdrop',
                                dropGroup:'CPTGridDDGroup'

                            },
                            listeners:{
                                scope:me,
                                drop:me.onCptDropped
                            }
                        },
                        plugins:me.cptFormEdit

                    }
                ]

            }
        ];


        me.callParent(arguments);

    },


    status:function(val){
        if(val == '0') {
            return '<img style="padding-left: 10px" src="resources/images/icons/no.png" />';
        } else if(val == '1') {
            return '<img style="padding-left: 10px" src="resources/images/icons/yes.png" />';
        } else if(val == '2') {
            return '<img style="padding-left: 10px" src="resources/images/icons/icohelp.png" />';
        }
        return val;
    },

    onQuickReferenceCollapsed:function () {
        var btn = this.query('button[action="referenceCptBtn"]');
        if (btn[0].pressed) {
            btn[0].toggle(false);
        }
    },

    onQuickReferenceToggle:function (btn, pressed) {
        if (pressed) {
            this.getComponent('leftCol').show();
        } else {
            this.getComponent('leftCol').hide();
        }

    },

    onQuickReferenceOption:function (combo, value) {
        this.loadCptQuickReferenceGrid(value);
    },


    onCompleteRemove:function () {
        app.msg(_('sweet'), _('cpt_removed_from_this_encounter'));
    },

    onLiveCptSelect:function (btn, record) {
        var me = this;
        btn.reset();
	    delete record[0].data.id;
	    record[0].data.eid = me.eid;
        me.encounterCptStore.add(record[0].data);

    },

    loadCptQuickReferenceGrid:function (filter) {
        this.referenceCptStore.load({params:{pid:this.pid, eid:this.eid, filter:filter}});
    },

    beforesync:function(options){
        if(options.create){
            options.create[0].data.eid = this.eid;
        }
    },

    onCptDropped:function(node, data, dropRecord, dropPosition, dropFunction){
        app.msg(_('sweet'), _('cpt_added_to_this_encounter'));
        this.cptFormEdit.cancelEdit();
        var store = dropRecord.store,
            dropIndex = store.indexOf(dropRecord),
            index = dropPosition == 'before' ? dropIndex - 1  : dropIndex + 1;


        this.cptFormEdit.startEdit(index, 0)
    },

    setDefaultQRCptCodes:function(){
        var combo = this.down('combobox');
        if (combo.getValue() != 1) {
            combo.setValue(1);
        } else {
            this.loadCptQuickReferenceGrid(1);
        }
    },

    encounterCptStoreLoad:function(pid, eid, callback){
        this.pid = pid ? pid : this.pid;
        this.eid = eid ? eid : this.eid;
        this.encounterCptStore.load({
            filters:[
                {
                    property:'eid',
                    value: this.eid
                }
            ],
            callback:function(){
                callback ? callback() : null;
            }
        });
    }


});

Ext.define('App.view.patient.encounter.HealthCareFinancingAdministrationOptions', {
	extend: 'Ext.form.Panel',
	xtype: 'hcafaoptions',

	pid: null,
	eid: null,

	initComponent: function(){
		var me = this;
		me.callParent();
		me.loadHCFAForm();
	},

	loadHCFAForm: function(){
		var me = this;

		me.getFormItems(this, 10, function(panel){

		});
	}

});
Ext.define('App.view.patient.encounter.ICDs', {
	extend: 'Ext.form.FieldSet',
	alias: 'widget.icdsfieldset',
	title: _('dx_codes'),
	padding: '10 15',
	layout: {
		type: 'vbox',
		align: 'stretch'
	},
	requires: [ 'App.ux.LiveICDXSearch' ],
	autoFormSync: true,
	dxGroup: {},
	initComponent: function(){
		var me = this;

		me.items = [
			{
				xtype:'container',
				layout:'hbox',
				items:[
					{
						xtype:'combobox',
						store: Ext.create('Ext.data.Store', {
							fields: [
								{ name:'option', type: 'auto' },
								{ name:'value', type: 'int' }
							],
							data : [
								{ option:'DX:1', value: 1 },
								{ option:'DX:2', value: 2 },
								{ option:'DX:3', value: 3 },
								{ option:'DX:4', value: 4 },
								{ option:'DX:5', value: 5 },
								{ option:'DX:6', value: 6 },
								{ option:'DX:7', value: 7 },
								{ option:'DX:8', value: 8 },
								{ option:'DX:9', value: 9 }
							]
						}),
						width: 55,
						itemId: this.id + '-group-cmb',
						queryMode: 'local',
						displayField: 'option',
						valueField: 'value',
						value: 1,
						margin: '0 3 0 0',
						forceSelection: true,
						editable: false,
						hide: true
					},
					{
						xtype:'combobox',
						store: Ext.create('Ext.data.Store', {
							fields: [
								{ name:'code', type: 'string' },
								{ name:'code_text', type: 'string' }
							],
							data : [
								{ code:'A', code_text: 'Admitting' },
								{ code:'F', code_text: 'Final' },
								{ code:'W', code_text: 'Working' }
							]
						}),
						width: 100,
						itemId: this.id + '-dx-type-cmb',
						queryMode: 'local',
						displayField: 'code_text',
						valueField: 'code',
						margin: '0 3 0 0',
						forceSelection: true,
						allowBlank: false,
						submitValue: false,
						editable: false,
						value: 'F'
					},
					{
						xtype: 'liveicdxsearch',
						itemId: 'liveicdxsearch',
						emptyText: me.emptyText,
						name: 'dxCodes',
						flex: 1,
						listeners: {
							scope: me,
							select: me.onLiveIcdSelect,
							blur: function(field){
								field.reset();
							}
						}
					}
				]
			}
		];

		me.callParent(arguments);
	},

	getGroupContainer: function(group){

		var me = this;

		if(!this.dxGroup[group]){
			this.dxGroup[group] = Ext.widget('container',{
				layout: {
					type: 'table',
					columns: 6
				},
				itemId: this.id + '-group-' + group,
				margin: '5 0 0 0',
				items:[
					{ xtype:'container', itemId: this.id + '-dx-order-1', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-2', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-3', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-4', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-5', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-6', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-7', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-8', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-9', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-10', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-11', action: 'pointer' },
					{ xtype:'container', itemId: this.id + '-dx-order-12', action: 'pointer' }
				],
				listeners:{
					afterrender:function(dxsContainer){

						var dxContainers = dxsContainer.items.items;

						for(var k=0; k < dxContainers.length; k++){

							new Ext.dd.DropTarget(dxContainers[k].el, {
								// must be same as for tree
								ddGroup: 'group-' + group + '-dx',
								dropPos: false,
								dxsContainer: dxsContainer,
								dxContainer: dxContainers[k],

								notifyOver: function(dd, e, data){

//									say('notifyOver');

									var dx = data.panel,
										dxContainer = this.dxContainer,
										proxy = dd.proxy;

									if(dxContainer.items.items.length == 0){
										// is over empty dx container
										return false;
									}else if(dxContainer.items.items[0] == dx){
										return false;
									}else{

										var dragDxContainerIndex = dxsContainer.items.items.indexOf(dx.ownerCt),
											dropDxContainerIndex = dxsContainer.items.items.indexOf(dxContainer);

										this.dropBefore = dragDxContainerIndex > dropDxContainerIndex;
										this.dropPos = dxsContainer.items.items.indexOf(dxContainer);
									}
									return true;
								},

								notifyDrop: function(dd, e, data){

									dd.panelProxy.hide();
									dd.proxy.hide();
									Ext.suspendLayouts();
									if(this.lastPos !== false){

										var parentDragContainer = data.panel.ownerCt,
											parentDropContainer = this.dxsContainer.items.items[this.dropPos],
											parentDropDx = this.dxsContainer.items.items[this.dropPos].items.items[0],
											parentDragDx = data.panel;


										parentDragContainer.remove(parentDragDx, false);
										parentDropContainer.remove(parentDropDx, false);

										parentDropContainer.add(parentDragDx);
										parentDragContainer.add(parentDropDx);

									}

									Ext.resumeLayouts(true);
									delete this.dropPos;

									me.onReOrder(dxsContainer);

									return true;
								}
							});
						}
					}
				}
			});
		}

		this.add(this.dxGroup[group]);

		return this.dxGroup[group];
	},

	onLiveIcdSelect: function(field, record){
		var me = this,
			soap = me.up('form').getForm().getRecord(),
			group_cmb = me.getDxGroupCombo(),
			group = group_cmb.getValue(),
			type_cmb = me.getDxTypeCombo(),
			type = type_cmb.getValue(),
			order = me.getNextOrder(group),
			dxRecords;

		if(!group_cmb.isValid() && !type_cmb.isValid()) return;

		var record_data = {
			pid: soap.data.pid,
			eid: soap.data.eid,
			uid: app.user.id,
			code: record[0].data.code,
			code_text: record[0].data.code_text,
			code_type: record[0].data.code_type,
			dx_group: group,
			dx_type: type,
			dx_order: order
		};

		if(me.fireEvent('beforerecordadd', me, record_data) === false) return;

		dxRecords = this.store.add(record_data);

		me.fireEvent('recordadd', me, dxRecords[0]);

		me.addIcd(dxRecords[0], group, order);
		field.reset();
	},

	doAddIcd: function (data) {
		var me = this,
			soap = me.up('form').getForm().getRecord(),
			group_cmb = me.getDxGroupCombo(),
			group = group_cmb.getValue(),
			type_cmb = me.getDxTypeCombo(),
			type = type_cmb.getValue(),
			order = me.getNextOrder(group),
			dxRecords;

		if(!group_cmb.isValid() && !type_cmb.isValid()) return;

		if(me.store.find('code', data.code) !== -1) return;

		var record_data = {
			pid: soap.data.pid,
			eid: soap.data.eid,
			uid: app.user.id,
			code: data.code,
			code_text: data.code_text,
			code_type: data.code_type,
			dx_group: group,
			dx_type: type,
			dx_order: order
		};

		dxRecords = me.store.add(record_data);

		me.addIcd(dxRecords[0], group, order);
	},

	removeIcds: function(){

		Ext.Object.each(this.dxGroup, function(key, group){
			Ext.destroy(group);
		});

		this.dxGroup = {};
	},

	loadIcds: function(store){

		var me = this,
			dxs = store.data.items;

		me.store = store;
		me.removeIcds();
		me.loading = true;

		for(var i = 0; i < dxs.length; i++){
			me.addIcd(dxs[i], dxs[i].data.dx_group, dxs[i].data.dx_order);
		}
		me.loading = false;
		me.getIcdLiveSearch().reset();
	},

	addIcd: function(record, group, order){
		var me = this;

		me.getDxCell(group, order).add({
			xtype: 'panel',
			closable: true,
			title: (record.get('code') + ' (' + record.get('dx_type')+ ')'),
			dxRecord: record,
			width: 120,
			margin: '0 5 0 0',
			name: this.name,
			editable: false,
			action: 'Dx',
			draggable: {
				moveOnDrag: false,
				ddGroup: 'group-' + group + '-dx'
			},
			listeners: {
				render: function(cmp){
					cmp.el.dom.setAttribute('data-qtip' , ('<b>' + record.get('code') + '</b>: ' +record.get('code_text')));
				},
				close: function(cmp){
					me.store.remove(cmp.dxRecord);
				}
			}
		});
	},

	getDxCell: function(group, order){
		return this.getGroupContainer(group).getComponent(this.id + '-dx-order-' + order);
	},

	getIcdLiveSearch: function(){
		return this.query('liveicdxsearch')[0];
	},

	getDxGroupCombo: function(){
		return this.query('#' + this.id + '-group-cmb')[0];
	},

	getDxTypeCombo: function(){
		return this.query('#' + this.id + '-dx-type-cmb')[0];
	},

	getNextOrder: function(group){
		var pointers = this.getGroupContainer(group).query('container[action=pointer]'),
			i, len = pointers.length;

		for(i=0; i < len; i++){
			if(pointers[i].items.items.length == 0) return (i + 1);
		}
		return false;
	},

	onReOrder: function(group){
		var orders = group.query('container[action=pointer]'),
			len;

		len = orders.length;
		for(var i=0; i < len; i++){
			if(orders[i].items.items.length > 0 && orders[i].items.items[0].action == 'Dx'){
				orders[i].items.items[0].dxRecord.set({dx_order: (i+1)});
			}
		}
	},

	sync: function(){
		this.store.sync();
	}
});
Ext.define('App.view.patient.CheckoutAlertsView',
{
	extend : 'Ext.view.View',
	alias : 'widget.checkoutalertsview',
	trackOver : true,
	cls : 'checkoutalert',
	itemSelector : 'div.alert-div',
	loadMask : true,
	singleSelect : true,
	emptyText : '<span style="color: #616161; font-size: 12px;">' + _('sweet') + ' ' + _('no_alerts_found') + '.</span>',
	initComponent : function()
	{
		var me = this;

		me.tpl = '<table>' +
			'<tpl for=".">' +
			'<tr class="alert-div>' +
			'<div class="alert-div">' +
			'<img class="alert-img" src="{icon}" />' +
			'<div class="alert-msg">{alert}</div>' +
			'</div>' +
			'</tr>' +
			'</tpl>' +
			'</table>';

		me.callParent(arguments);
	}
});

Ext.define('App.store.patient.DoctorsNotes', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.DoctorsNote',
	autoLoad: false
});

Ext.define('App.view.patient.DoctorsNotes', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.store.patient.DoctorsNotes',
		'App.ux.grid.RowFormEditing',
		'App.ux.form.fields.MultiText',
		'App.ux.combo.Templates'
	],
	xtype: 'patientdoctorsnotepanel',
	title: _('doc_nt'),
	itemId: 'DoctorsNotes',
	columnLines: true,
	store: Ext.create('App.store.patient.DoctorsNotes', {
		storeId: 'DoctorsNotesStore',
        groupField: 'group_date',
		remoteFilter: true,
		pageSize: 200,
		sorters: [
			{
				property: 'order_date',
				direction: 'DESC'
			}
		]
	}),
	selModel: Ext.create('Ext.selection.CheckboxModel', {
		showHeaderCheckbox: false
	}),
    features: [
        {
            ftype: 'grouping'
        }
    ],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove')
				}
			]
		},
		{
			xtype: 'datecolumn',
			text: _('date'),
			dataIndex: 'order_date',
			format: g('date_display_format')
		},
		{
			text: _('type'),
			dataIndex: 'template_id',
			renderer: function(v){
				return App.Current.getController('patient.DoctorsNotes').templatesRenderer(v);
			},
			allowBlank: false
		},
		{
			xtype: 'datecolumn',
			text: _('from'),
			dataIndex: 'from_date',
			format: g('date_display_format')
		},
		{
			xtype: 'datecolumn',
			text: _('to'),
			dataIndex: 'to_date',
			format: g('date_display_format')
		},
		{
			text: _('comments'),
			dataIndex: 'comments',
			flex: 1
		},
		{
			text: _('restrictions'),
			dataIndex: 'string_restrictions',
			flex: 1
		}
	],
	tbar: [
		'->',
		'-',
		{
			text: _('new_note'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId: 'newDoctorsNoteBtn'

		},
		'-',
		{
			text: _('print'),
			iconCls: 'icoPrint',
			disabled: true,
			margin: '0 5 0 0',
			itemId: 'printDoctorsNoteBtn'
		}
	]
});

Ext.define('App.view.patient.EncounterDocumentsGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.feature.Grouping'
	],
	xtype: 'encounterdocumentsgrid',
	title: _('documents'),
	split: true,
	features: [
		{
			ftype: 'grouping',
			collapsible: false,
			groupHeaderTpl: '{name}\'s'
		}
	],
	selType: 'checkboxmodel',
	store: Ext.create('Ext.data.Store', {
		fields: ['id', 'record_id', 'description', 'document_type', 'controller', 'method'],
		proxy: {
			type: 'memory'
		},
		groupField: 'document_type',
		storeId: 'EncounterDocumentsGridStore'
	}),
	columns: [
		{
			header: _('description'),
			dataIndex: 'description',
			flex: 1
		}
	],
	tools: [
		{
			xtype: 'button',
			icon: 'resources/images/icons/preview.png',
			tooltip: _('view'),
			margin: '0 5 0 0',
			itemId: 'EncounterDocumentsViewBtn'
		},
		{
			xtype: 'button',
			icon: 'resources/images/icons/printer.png',
			tooltip: _('print'),
			itemId: 'EncounterDocumentsPrintBtn'
		}
	],
	loadDocs: function(eid){
		App.app.getController('patient.encounter.EncounterDocuments').loadDocumentsByEid(this, eid);
	}
});
Ext.define('App.store.patient.Vitals', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.Vitals'],
	model: 'App.model.patient.Vitals',
	groupField: 'group_field'
});
Ext.define('App.view.patient.Vitals', {
	extend: 'Ext.panel.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'App.ux.form.fields.DateTime'
	],
	xtype: 'vitalspanel',
	title: _('vitals'),
	layout: 'border',
	bodyPadding: 5,
	items: [

		// VITALS HEADER BLOCKS
		{
			xtype: 'container',
			height: 100,
			region: 'north',
			itemId: 'vitalsBlocks',
			layout: {
				type: 'hbox',
				align: 'stretch'
			},
			defaults: {
				xtype: 'container',
				cls: 'latest-vitals-items',
				margin: '0 5 5 5',
				width: 130
			},
			items: [
				{
					itemId: 'pulseBlock',
					html: '<p class="title">' + _('pulse') + '</p><p class="value">--</p><p class="extra">--</p>'
				},
				{
					itemId: 'bpBlock',
					margin: '0 5 5 0',
					html: '<p class="title">' + _('bp') + '</p><p class="value">--/--</p><p class="extra">' + _('systolic') + '/' + _('diastolic') + '</p>'
				},
				{
					itemId: 'tempBlock',
					html: '<p class="title">' + _('temp') + '</p><p class="value">--</p><p class="extra">--</p>'
				},
				{
					itemId: 'weighBlock',
					html: '<p class="title">' + _('weight') + '</p><p class="value">--</p>'
				},
				{
					itemId: 'heightBlock',
					html: '<p class="title">' + _('height') + '</p><p class="value">--</p>'
				},
				{
					itemId: 'bmiBlock',
					html: '<p class="title">' + _('bmi') + '</p><p class="value">--</p><p class="extra">--</p>'
				},
				{
					itemId: 'notesBlock',
					margin: '0 5 5 5',
					html: '<p class="title">' + _('notes') + '</p><p class="value" style="text-align: left"> -- </p><p class="extra">--</p>',
					flex: 1
				}
			]
		},
		{
			xtype: 'grid',
			region: 'center',
			flex: 1,
			itemId: 'historyGrid',
			multiSelect: true,
			store: Ext.create('App.store.patient.Vitals',{
				remoteFilter: true,
				sorters: [
					{
						property: 'id',
						direction: 'DESC'
					}
				]
			}),
			stateId: 'VitalsHistoryGrid',
			stateful: true,
			features: [
				{
					ftype:'grouping',
					groupHeaderTpl: '{name}'
				}
			],
			plugins: [
				{
					ptype: 'rowediting'
				}
			],
			viewConfig: {
				getRowClass: function(record, rowIndex, rowParams, store){
					return record.data.auth_uid === 0 ? 'unsignedVital' : '';
				}
			},
			tbar: [
				{
					xtype:'button',
					icon:'resources/images/icons/blueInfo.png',
					focusCls:'',
					handler:function(){
						App.app.getController('InfoButton').doGetInfoByUrl('https://vsearch.nlm.nih.gov/vivisimo/cgi-bin/query-meta?v%3Aproject=medlineplus&query=vitals+signs&x=0&y=0');
					}
				},
				'-',
				{
					xtype:'button',
					text: 'Charts',
					itemId: 'vitalChartsBtn',
				},
				'-',
				'->',
				'-',
				{
					text: _('vitals'),
					iconCls: 'icoAdd',
					itemId: 'vitalAddBtn',
					action: 'encounterRecordAdd'
				},
				'-',
				{
					text: _('sign'),
					icon: 'resources/images/icons/pen.png',
					itemId: 'vitalSignBtn',
					action: 'encounterRecordAdd'
				}
			]

		},
		{
			xtype: 'form',
			title: 'Diagnoses',
			height: 100,
			region: 'south',
			collapsible: true,
			stateful: true,
			stateId: 'VitalsDxFromPanelState',
			bodyPadding: 5,
			items : [
				{
					xtype: 'icdsfieldset',
					margin: '5 0 10 0',
					itemId: 'VitalsDxCodesField'
				}
			]
		}

	],
	initComponent:function(){
		var me = this;

		var columns = [
			{
				text: 'eid',
				dataIndex: 'eid',
				hidden: true,
				width: 50
			},
			{
				xtype: 'actioncolumn',
				width: 20,
				stateId: 'VitalsHistoryGridActionCol',
				items: [
					{
						icon: 'resources/images/icons/cross.png',
						tooltip: _('remove'),
						handler: function (grid, rowIndex, colIndex, item, e, record) {
							App.app.getController('patient.Vitals').onRxOrdersDeleteActionHandler(grid, rowIndex, colIndex, item, e, record);
						}
					}
				]
			},
			{
				xtype:'datecolumn',
				text: _('date'),
				dataIndex: 'date',
				format: 'Y-m-d g:i a',
				width: 180,
				stateId: 'VitalsHistoryGridDateCol',
				editor:{
					xtype: 'mitos.datetime',
					timeFormat: 'g:i a'
				}
			},
			{
				text: _('bp'),
				stateId: 'VitalsHistoryGridBpCol',
				columns:[
					{
						text: _('systolic'),
						dataIndex: 'bp_systolic',
						width: 65,
						stateId: 'VitalsHistoryGridBpSystolicCol',
						editor: {
							xtype: 'textfield',
							vtype: 'numeric'
						}
					},
					{
						text: _('diastolic'),
						dataIndex: 'bp_diastolic',
						width: 65,
						stateId: 'VitalsHistoryGridBpDiastolicCol',
						editor: {
							xtype: 'textfield',
							vtype: 'numeric'
						}
					}
				]
			}
		];

		if(g('units_of_measurement') != 'metric'){
			columns.push({
				text: _('temp'),
				dataIndex: 'temp_f',
				width: 70,
				stateId: 'VitalsHistoryGridTempFCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalTempFField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + '&deg;F'
				}
			});
		}else{
			columns.push({
				text: _('temp'),
				dataIndex: 'temp_c',
				width: 70,
				stateId: 'VitalsHistoryGridTempCCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalTempCField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + '&deg;C'
				}
			});
		}

		columns.push({
			text: _('temp_location'),
			dataIndex: 'temp_location',
			stateId: 'VitalsHistoryGridTempLocationCol',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 62
			}
		});

		if(g('units_of_measurement') != 'metric'){
			columns.push({
				text: _('weight_lbs'),
				dataIndex: 'weight_lbs',
				width: 80,
				stateId: 'VitalsHistoryGridWeightLbsCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalWeightLbsField',
					vtype: 'numericWithSlash',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' lbs/oz'
				}
			});
			columns.push({
				text: _('height_in'),
				dataIndex: 'height_in',
				width: 70,
				stateId: 'VitalsHistoryGridHeightInCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalHeightInField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' in'
				}
			});
			columns.push({
				text: _('hc'),
				dataIndex: 'head_circumference_in',
				width: 70,
				stateId: 'VitalsHistoryGridHeadCircumferenceCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalHeadCircumferenceInField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' in'
				}
			});
		}else{
			columns.push({
				text: _('weight'),
				dataIndex: 'weight_kg',
				width: 80,
				stateId: 'VitalsHistoryGridWeightKgCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalWeightKgField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' kg'
				}
			});
			columns.push({
				text: _('height_cm'),
				dataIndex: 'height_cm',
				stateId: 'VitalsHistoryGridHeightCmCol',
				width: 70,
				editor: {
					xtype: 'textfield',
					itemId: 'vitalHeightCmField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' cm'
				}
			});
			columns.push({
				text: _('hc'),
				dataIndex: 'head_circumference_cm',
				width: 70,
				stateId: 'VitalsHistoryGridHeadCircumferenceCol',
				editor: {
					xtype: 'textfield',
					itemId: 'vitalHeadCircumferenceCmField',
					vtype: 'numericWithDecimal',
					enableKeyEvents: true
				},
				renderer:function(v){
					return v === 0 || v === null ? '' : v + ' in'
				}
			});
		}

		columns.push({
			text: _('pulse'),
			dataIndex: 'pulse',
			width: 60,
			stateId: 'VitalsHistoryGridPulseCol',
			editor: {
				xtype: 'textfield',
				vtype: 'numeric'
			},
			renderer:function(v){
				return v === 0 || v === null ? '' : v;
			}
		});

		columns.push({
			text: _('respiration'),
			dataIndex: 'respiration',
			stateId: 'VitalsHistoryGridRespitarionCol',
			editor: {
				xtype: 'textfield',
				vtype: 'numeric'
			},
			renderer:function(v){
				return v === 0 || v === null ? '' : v;
			}
		});

		columns.push({
			text: _('bmi'),
			dataIndex: 'bmi',
			stateId: 'VitalsHistoryGridBmiCol',
			width: 50
		});

		columns.push({
			text: _('o2%'),
			dataIndex: 'oxygen_saturation',
			stateId: 'VitalsHistoryGridOxygenSaturationCol',
			width: 50,
			editor: {
				xtype: 'textfield',
				vtype: 'numericWithDecimal'
			},
		});

		columns.push({
			text: _('fio2%'),
			dataIndex: 'oxygen_inhaled_concentration',
			stateId: 'VitalsHistoryGridInhaledOxygenConcentrationCol',
			width: 50,
			editor: {
				xtype: 'textfield',
				vtype: 'numericWithDecimal'
			},
		});

		columns.push({
			text: _('other_notes'),
			dataIndex: 'other_notes',
			stateId: 'VitalsHistoryGridOtherNotesCol',
			flex: 1,
			editor: {
				xtype: 'textfield'
			}
		});

		columns.push({
			text: _('administer_by'),
			dataIndex: 'administer_by',
			stateId: 'VitalsHistoryGridAdministerCol'
		});

		columns.push({
			text: _('authorized_by'),
			dataIndex: 'authorized_by',
			stateId: 'VitalsHistoryGridAuthorizedCol'
		});

		me.items[1].columns = columns;

		me.callParent();
	}
});

Ext.define('App.store.patient.PatientImmunization', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientImmunization'
});



Ext.define('App.store.patient.Allergies', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Allergies'
});
Ext.define('App.store.patient.PatientActiveProblems', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.PatientActiveProblem'],
	model: 'App.model.patient.PatientActiveProblem'
});
Ext.define('App.store.patient.Medications', {
	extend: 'Ext.data.Store',
    storeId: 'patientMedicationsStore',
	model     : 'App.model.patient.Medications',
    groupField: 'STR',
    startCollapsed: true
});

Ext.define('App.view.patient.NewPatient', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('patient_entry_form'),
	initComponent: function(){

		var me = this;

		me.pageBody = [
			me.newPatientPanel = Ext.create('App.view.patient.Patient')
		];
		me.callParent(arguments);

	},

	/**
	 *
	 * @param {function} callback
	 */
	confirmationWin: function(callback){
		Ext.Msg.show({
			title: _('please_confirm') + '...',
			msg: _('do_you_want_to_create_a_new_patient'),
			icon: Ext.MessageBox.QUESTION,
			buttons: Ext.Msg.YESNO,
			scope: this,
			fn: function(btn){
				callback(btn);
			}
		});
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 * @param {function} [callback] - callback
	 */
	onActive: function(callback){
		var me = this;
		this.confirmationWin(function(btn){
			if(btn == 'yes'){
				me.newPatientPanel.loadNew();
				app.unsetPatient(null, true);
				callback(true);
			}else{
				app.nav.goBack();
				callback(false);
			}
		});
	}
});
Ext.define('App.view.patient.ProgressNote', {
	extend           : 'Ext.panel.Panel',
    alias            : 'widget.progressnote',
    bodyPadding      : 5,
    autoScroll       : true,
    loadMask         : false,
	initComponent: function() {
		var me = this;

        me.tpl = new Ext.XTemplate(
            '<div class="progressNote" style="margin: 5px">' +
            '   <div class="secession general-data">' +
            '       <div class="title"> ' + _('general') + ' </div>' +
            '       <table width="100%">' +
            '           <tr>' +
            '               <td>' +
            '                   <div class="header row">' + _('name') + ': {patient_name} </div>' +
            '                   <div class="header row">' + _('record') + ': #{pid} </div>' +
            '                   <div class="header row">' + _('provider') + ': {open_by} </div>' +
            '                   <div class="header row">' + _('onset_date') + ': {[values.onset_date || "-"]} </div>' +
			'                   <div class="header row">' + _('referring_provider') + ': {[this.getFullName(values.referring_physician_fname,values.referring_physician_mname,values.referring_physician_lname) || "-"]} </div>' +
			'               </td>' +
            '               <td>' +
            '                   <div class="header row">' + _('service_date') + ': {service_date} </div>' +
            '                   <div class="header row">' + _('visit_category') + ': {visit_category} </div>' +
            '                   <div class="header row">' + _('facility') + ': {facility} </div>' +
            '                   <div class="header row">' + _('priority') + ': {priority} </div>' +
            '                   <div class="header row">' + _('signed_on') + ': {[values.close_date || "-"]} </div>' +
			'               </td>' +
            '           </tr>' +
            '           <tr>' +
            '               <td colspan="2">' +
            '                   <div class="header row" style="white-space: normal;">' + _('chief_complaint') + ': {brief_description} </div>' +
            '               </td>' +
            '           </tr>' +
            '       </table>' +
            '   </div>' +

            /**
             * SOAP Secession
             */
            '   <tpl for="soap">' +
            '       <div class="secession">' +
            '           <div class="title"> ' + _('soap') + ' </div>' +
            '           <p><span>' + _('subjective') + ':</span> {[this.doHtmlDecode(values.subjective) || "-"]} </p>' +
            '           <p><span>' + _('objective') + ':</span> {[this.doHtmlDecode(values.objective) || "-"]}</p>' +
            '           <p><span>' + _('assessment') + ':</span> {[this.doHtmlDecode(values.assessment) || "-"]}</p>' +
            '           <p><span>' + _('plan') + ':</span> {[this.doHtmlDecode(values.plan) || "-"]}</p>' +
            '       </div>' +
            '   </tpl>' +
            /**
             * Speech Dictation Secession
             */
            '   <tpl for="speechdictation">' +
            '       <div class="secession">' +
            '           <div class="title"> ' + _('speech_dictation') + ' </div>' +
            '           <p><span>' + _('dictation') + ':</span> {dictation}</p>' +
            '           <p><span>' + _('additional_notes') + ':</span> {additional_notes}</p>' +
            '       </div>' +
            '   </tpl>' +
			/**
			 * Addenda Secession
			 */
			'   <tpl if="addenda != \'NONE\'">' +
			'       <div class="secession">' +
			'       	<div class="title"> ' + _('addenda') + ' </div>' +
			'           <p>{[this.doHtmlDecode(values.addenda) || "-"]} </p>' +
			'       </div>' +
			'   </tpl>' +
            '</div>',
            {

	            isNotNull: function(value){
	                return value != 'null' && value != null;
	            },

		        isNotEmpty:function(value){

	            },

		        getVitalsValue:function(value){
			        return (value == 0 || value == null) ? '-' : value;
		        },

	            isMetric:function(){
		            return g('units_of_measurement') == 'metric';
	            },

	            doHtmlDecode:function(v){
		            return Ext.String.htmlDecode(v);
	            },

	            getFullName:function(fname,mname,lname){
		            return this.capitalizeEveryWord(Ext.String.format('{0}, {1} {2}', lname || '', fname || '', mname || '' ), true);
	            },

				capitalizeEveryWord:function (str, lower) {
					return (lower ? str.toLowerCase() : str).replace(/(?:^|\s|["'([{])+\S/g, function(match){
						return match.toUpperCase();
					});
				}

            }
        );

		me.callParent(arguments);
	}

});

Ext.define('App.store.patient.Reminders', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Reminder'
});
Ext.define('App.view.patient.Reminders', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing'
	],
	xtype: 'patientreminderspanel',
	title: _('reminders'),
	store: Ext.create('App.store.patient.Reminders'),
	plugins: {
		ptype:'rowediting',
		autoCancel: false,
		errorSummary: false,
		clicksToEdit: 2
	},
	columns: [
		{
			xtype: 'datecolumn',
			text: _('date'),
			dataIndex: 'reminder_date',
			editor: {
				xtype: 'datefield'
			}
		},
		{
			text: _('type'),
			dataIndex: 'reminder_type',
			editor: {
				xtype: 'combobox',
				queryMode: 'local',
				displayField: 'option',
				valueField: 'value',
				store: Ext.create('Ext.data.Store', {
					fields: ['option', 'value'],
					data : [
						{ option: 'Appointment', value: 'appointment' },
						{ option: 'Clinical', value: 'clinical' }
					]
				})
			}
		},
		{
			text: _('note'),
			flex: 1,
			dataIndex: 'reminder_note',
			editor: {
				xtype: 'textfield'
			}
		}
	],
	tbar: [
		'->',
		{
			text: _('add_reminder'),
			iconCls: 'icoAdd',
			itemId: 'PatientRemindersAddBtn'
		}
	]
});
Ext.define('App.store.patient.Alerts', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Alert'
});
Ext.define('App.view.patient.Alerts', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing'
	],
	xtype: 'patientalertspanel',
	title: _('alerts'),
	store: Ext.create('App.store.patient.Alerts'),
	plugins: {
		ptype:'rowediting',
		autoCancel: false,
		errorSummary: false,
		clicksToEdit: 2
	},
	columns: [
		{
			xtype: 'datecolumn',
			text: _('date'),
			format: 'Y-m-d',
			dataIndex: 'date'
		},
		{
			header: _('type'),
			dataIndex: 'type',
			width: 200,
			editor: {
				xtype: 'gaiaehr.combo',
				list: 130
			}
		},
		{
			text: _('note'),
			dataIndex: 'body',
			flex: 1,
			editor: {
				xtype: 'textfield'
			}
		},
		{
			text: _('user'),
			width: 225,
			dataIndex: 'user_name'
		},
		{
			text: _('active'),
			width: 50,
			dataIndex: 'active',
			renderer: function(v, m, r){
				return app.boolRenderer(v, m, r);
			},
			editor: {
				xtype: 'checkbox'
			}
		}
	],
	tbar: [
		'->',
		{
			text: _('add_alert'),
			iconCls: 'icoAdd',
			itemId: 'AlertsAddBtn'
		}
	]
});
Ext.define('App.store.patient.PatientsOrders', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientsOrders',
	remoteSort: false,
	autoLoad: false
});



Ext.define('App.view.patient.Results', {
	extend: 'Ext.panel.Panel',
	requires: [
		'Ext.grid.plugin.CellEditing',
		'Ext.grid.plugin.RowEditing',
		'Ext.tab.Panel',
		'App.store.patient.PatientsOrders',
		'App.ux.LiveLabsSearch',
		'App.ux.LiveRadsSearch',
		'App.ux.LiveReferringPhysicianSearch',
		'App.ux.window.voidComment',
		'App.ux.form.fields.DateTime'
	],
	title: _('res'),
	xtype: 'patientresultspanel',
	layout: 'border',
	tbar: [
		'->',
		{
			text: _('lab_result'),
			itemId: 'ResultsLabOrderNewBtn',
			iconCls: 'icoAdd'
		},
		{
			text: _('rad_result'),
			itemId: 'ResultsRadOrderNewBtn',
			iconCls: 'icoAdd'
		}
	],
	items: [
		{
			xtype: 'grid',
			itemId: 'ResultsOrdersGrid',
			action: 'orders',
			region: 'center',
			columnLines: true,
			allowDeselect: true,
			frame: true,
			store: Ext.create('App.store.patient.PatientsOrders', {
				remoteFilter: true
			}),
			plugins: [
				{
					pluginId: 'ResultsOrdersGridRowEditor',
					ptype: 'rowediting',
					errorSummary: false
				}
			],
			columns: [
				{
					xtype: 'actioncolumn',
					width: 25,
					items: [
						{
							icon: 'resources/images/icons/blueInfo.png',
							tooltip: 'Get Info',
							handler: function(grid, rowIndex, colIndex, item, e, record){
								App.app.getController('InfoButton').doGetInfo(
									record.data.code,
									record.data.code_type,
									record.data.description
								);
							}
						}
					]
				},
				{
					header: _('void'),
					width: 30,
					dataIndex: 'void',
					tooltip: _('void'),
					editor: {
						xtype: 'checkbox',
						itemid: 'ResultsOrdersGridOrderVoidCheckbox'
					},
					renderer: function(v, meta, record){
						return app.voidRenderer(v);
					}
				},
				{
					header: _('type'),
					width: 100,
					dataIndex: 'order_type',
					renderer: function(v, meta, record){
						var style = '';
						if(record.get('void')) style = 'text-decoration: line-through;';

						if(record.data.order_type == 'lab')
							return '<span style="' + style + '">' + _('laboratory') + '</span>';
						if(record.data.order_type == 'rad')
							return '<span style="' + style + '">' + _('radiology') + '</span>';
					},
					editor: {
						xtype: 'combobox',
						itemId: 'ResultsOrdersGridOrderTypeCombo',
						store: Ext.create('Ext.data.Store', {
							fields: ['type', 'order_type'],
							data: [
								{ 'type': 'Laboratory', 'order_type': 'lab' },
								{ 'type': 'Radiology', 'order_type': 'rad' }
							]
						}),
						allowBlank: false,
						editable: false,
						queryMode: 'local',
						displayField: 'type',
						valueField: 'order_type'
					}
				},
				{
					xtype: 'datecolumn',
					format: 'Y-m-d',
					header: _('date_ordered'),
					dataIndex: 'date_ordered',
					menuDisabled: true,
					resizable: false,
					width: 100,
					editor: {
						xtype: 'datefield',
						allowBlank: true
					},
					renderer: function(v, meta, record){
						var dataOrdered;

						if(v){
							dataOrdered = Ext.util.Format.date(v, this.format);
						}else{
							dataOrdered = '';
						}

						if(record.get('void'))
							return '<span style="text-decoration: line-through;">' + dataOrdered + '</span>';
						return '<span>' + dataOrdered + '</span>';
					}
				},
				{
					header: _('order_description'),
					dataIndex: 'description',
					menuDisabled: true,
					resizable: false,
					flex: 1,
					editor: {
						xtype: 'labslivetsearch',
						itemId: 'ResultsLabsLiveSearchField',
						allowBlank: false
					},
					renderer: function(v, meta, record){
						if(record.get('void'))
							return '<span style="text-decoration: line-through;">' + v + '</span>';
						return '<span>' + v + '</span>';
					}
				},
				{
					header: _('status'),
					dataIndex: 'status',
					menuDisabled: true,
					resizable: false,
					width: 60,
					renderer: function(v, meta, record){
						if(record.get('void'))
							return '<span style="text-decoration: line-through;">' + v + '</span>';
						return '<span>' + v + '</span>';
					}
				}
			]
		},
		{
			/**
			 * Orders Card [ Laboratory or Radiology ]
			 * ---------------------------------------
			 */
			xtype: 'panel',
			border: false,
			region: 'south',
			split: true,
			frame: true,
			itemId: 'ResultsCardPanel',
			height: 400,
			hidden: true,
			layout: 'card',
			activeItem: 0,

			items: [
				{
					/**
					 * Laboratory Order Panel
					 * ---------------------
					 */
					xtype: 'panel',
					frame: false,
					itemId: 'ResultsLaboratoryPanel',
					layout: {
						type: 'border'
					},
					tools: [
						{
							xtype: 'button',
							text: _('view_document'),
							icon: 'resources/images/icons/icoView.png',
							itemId: 'ResultsLaboratoryPanelDocumentViewBtn'
						}
					],
					items: [
						{
							xtype: 'form',
							title: _('report_info'),
							itemId: 'ResultsLaboratoryForm',
							region: 'west',
							collapsible: true,
							autoScroll: true,
							width: 400,
							bodyPadding: 5,
							split: true,
							layout: {
								type: 'vbox',
								align: 'stretch'
							},
							items: [
								{
									xtype: 'fieldset',
									title: _('report_info'),
									defaults: {
										xtype: 'textfield',
										anchor: '100%'
									},
									layout: 'anchor',
									items: [
										{
											xtype: 'datefield',
											fieldLabel: _('report_date'),
											name: 'result_date',
											allowBlank: false
										},
										{
											fieldLabel: _('report_number'),
											name: 'performer_order_id',
											allowBlank: false
										},
										{
											xtype: 'combobox',
											fieldLabel: _('status'),
											name: 'result_status',
											queryMode: 'local',
											displayField: 'option',
											valueField: 'value',
											store: Ext.create('Ext.data.Store', {
												fields: ['option', 'value'],
												data: [
													{ option: 'Aborted', value: 'aborted'},
													{ option: 'Active', value: 'active'},
													{ option: 'Cancelled', value: 'cancelled'},
													{ option: 'Completed', value: 'completed'},
													{ option: 'Held', value: 'held'},
													{ option: 'Suspended', value: 'suspended'}
												]
											})
										},
										{
											xtype: 'mitos.datetime',
											fieldLabel: _('observation_date'),
											name: 'observation_date',
											allowBlank: false
										},
										{
											fieldLabel: _('specimen'),
											name: 'specimen_text'
										},
										{
											xtype: 'textareafield',
											fieldLabel: _('specimen_notes'),
											name: 'specimen_notes',
											height: 50
										},
										{
											xtype: 'filefield',
											labelAlign: 'top',
											fieldLabel: _('upload_document'),
											action: 'ResultsLaboratoryFormUploadField',
											submitValue: false
										}
									]
								},
								{
									xtype: 'fieldset',
									title: _('performer'),
									defaults: {
										anchor: '100%'
									},
									layout: 'anchor',
									margin: 0,
									items: [
										{
											xtype: 'referringphysicianlivetsearch',
											fieldLabel: _('name'),
											hideLabel: false,
											name: 'performer_name'
										},
										{
											xtype: 'textareafield',
											fieldLabel: _('address'),
											name: 'performer_address',
											height: 50
										}
									]
								}
							]
						},
                        {
							xtype: 'treepanel',
							itemId: 'ResultsLaboratoryObservationsGrid',
							action: 'observations',
                            animate: false,
                            rootVisible: false,
							flex: 1,
							region: 'center',
							split: true,
							border: false,
							columnLines: true,
							plugins: [
								{
									ptype: 'cellediting',
									clicksToEdit: 1
								}
							],
							columns: [
								{
                                    xtype: 'treecolumn',
									text: _('name'),
									menuDisabled: true,
									dataIndex: 'code_text',
									width: 350,
									renderer: function (v, meta,record) {
                                        var code = record.get('code');
                                        if (code != '') {
                                            v = v + ' (' + code + ')';
                                        }
                                        return v;
                                    }
								},
								{
									xtype: 'actioncolumn',
									width: 25,
									items: [
										{
											icon: 'resources/images/icons/blueInfo.png',  // Use a URL in the icon config
											tooltip: _('get_info'),
											handler: function(grid, rowIndex, colIndex, item, e, record){
												App.app.getController('InfoButton').doGetInfo(
													record.data.code,
													record.data.code_type,
													record.data.code_text
												);
											}
										}
									]
								},
								{
									text: _('value'),
									menuDisabled: true,
									dataIndex: 'value',
									width: 180,
									editor: {
										xtype: 'textfield'
									},
									renderer: function(v, meta, record){
										var red = ['LL', 'HH', '>', '<', 'AA', 'VS'],
											orange = ['L', 'H', 'A', 'W', 'MS'],
											blue = ['B', 'S', 'U', 'D', 'R', 'I'],
											green = ['N'];

										if(Ext.Array.contains(green, record.data.abnormal_flag)){
											return '<span style="color:green;">' + v + '</span>';
										}
										else if(Ext.Array.contains(blue, record.data.abnormal_flag)){
											return '<span style="color:blue;">' + v + '</span>';
										}
										else if(Ext.Array.contains(orange, record.data.abnormal_flag)){
											return '<span style="color:orange;">' + v + '</span>';
										}
										else if(Ext.Array.contains(red, record.data.abnormal_flag)){
											return '<span style="color:red;">' + v + '</span>';
										}
										else{
											return v;
										}
									}
								},
								{
									text: _('units'),
									menuDisabled: true,
									dataIndex: 'units',
									width: 75,
									editor: {
										xtype: 'textfield'
									}
								},
								{
									text: _('abnormal'),
									menuDisabled: true,
									dataIndex: 'abnormal_flag',
									width: 75,
									editor: {
										xtype: 'textfield'
									},
									renderer: function(v, attr){
										var red = ['LL', 'HH', '>', '<', 'AA', 'VS'],
											orange = ['L', 'H', 'A', 'W', 'MS'],
											blue = ['B', 'S', 'U', 'D', 'R', 'I'],
											green = ['N'];

										if(Ext.Array.contains(green, v)){
											return '<span style="color:green;">' + v + '</span>';
										}
										else if(Ext.Array.contains(blue, v)){
											return '<span style="color:blue;">' + v + '</span>';
										}
										else if(Ext.Array.contains(orange, v)){
											return '<span style="color:orange;">' + v + '</span>';
										}
										else if(Ext.Array.contains(red, v)){
											return '<span style="color:red;">' + v + '</span>';
										}
										else{
											return v;
										}
									}
								},
								{
									text: _('range'),
									menuDisabled: true,
									dataIndex: 'reference_rage',
									width: 150,
									editor: {
										xtype: 'textfield'
									}
								},
								{
									text: _('notes'),
									menuDisabled: true,
									dataIndex: 'notes',
									width: 300,
									editor: {
										xtype: 'textfield'
									}
								},
								{
									text: _('status'),
									menuDisabled: true,
									dataIndex: 'observation_result_status',
									width: 60,
									editor: {
										xtype: 'textfield'
									}
								}
							]
						}
					]
				},
				{
					/**
					 * Radiology Order Panel
					 * ---------------------
					 */
					xtype: 'panel',
					itemId: 'ResultsRadiologyPanel',
					frame: true,
					layout: {
						type: 'border'
					},
					items: [
						{
							xtype: 'form',
							title: _('report'),
							itemId: 'ResultsRadiologyForm',
							region: 'west',
							collapsible: true,
							autoScroll: true,
							width: 400,
							bodyPadding: 5,
							split: true,
							layout: {
								type: 'vbox',
								align: 'stretch'
							},
							items: [
								{
									xtype: 'fieldset',
									title: _('report'),
									defaults: {
										xtype: 'textfield',
										anchor: '100%'
									},
									layout: 'anchor',
									items: [
										{
											xtype: 'datefield',
											fieldLabel: _('report_date'),
											name: 'result_date',
											format: 'Y-m-d',
											allowBlank: false
										},
										{
											fieldLabel: _('report_number'),
											name: 'performer_order_id',
											allowBlank: false
										},
										{
											xtype: 'combobox',
											fieldLabel: _('status'),
											name: 'result_status',
											queryMode: 'local',
											displayField: 'option',
											valueField: 'value',
											store: Ext.create('Ext.data.Store', {
												fields: ['option', 'value'],
												data: [
													{ option: 'Aborted', value: 'aborted'},
													{ option: 'Active', value: 'active'},
													{ option: 'Cancelled', value: 'cancelled'},
													{ option: 'Completed', value: 'completed'},
													{ option: 'Held', value: 'held'},
													{ option: 'Suspended', value: 'suspended'}
												]
											})
										},
										{
											xtype: 'fileuploadfield',
											fieldLabel: _('report_document'),
											itemId: 'ResultsRadiologyFormUploadField',
											submitValue: false
										}
									]
								},
								{
									xtype: 'fieldset',
									title: _('study'),
									defaults: {
										xtype: 'textfield',
										anchor: '100%'
									},
									layout: 'anchor',
									items: [
										{
											xtype: 'button',
											text: _('view'),
											margin: '0 0 8 0',
											itemId: 'ResultsRadiologyFormViewStudyBtn'
										}
									]
								},
								{
									xtype: 'fieldset',
									title: _('performer'),
									defaults: {
										xtype: 'textfield',
										anchor: '100%'
									},
									layout: 'anchor',
									margin: 0,
									items: [
										{
											xtype: 'referringphysicianlivetsearch',
											fieldLabel: _('name'),
											hideLabel: false,
											name: 'performer_name'
										},
										{
											xtype: 'textareafield',
											fieldLabel: _('address'),
											name: 'radiologist_address',
											height: 50
										}
									]
								}
							]
						},
						{
							xtype: 'tabpanel',
							region: 'center',
							items: [
								{
									xtype: 'panel',
									title: _('report'),
									layout: 'fit',
									items: [
										{
											xtype: 'textareafield',
											itemId: 'ResultsRadiologyReportBody'
										}
									]
								},
								{
									xtype: 'panel',
									title: _('document'),
									layout: 'fit',
									items: [
										{
											xtype: 'miframe',
											region: 'center',
											itemId: 'ResultsRadiologyDocumentIframe'
										}
									]
								}
							]
						}
					]
				}
			],
			buttons: [
				{
					text: _('sign'),
					iconCls: 'icoSing',
					disabled: true,
					itemId: 'ResultsOrderSignBtn'
				},
				'->',
				{
					text: _('reset'),
					itemId: 'ResultsOrderResetBtn'
				},
				{
					text: _('save'),
					itemId: 'ResultsOrderSaveBtn'
				}
			]
		}
	]
});

Ext.define('App.store.patient.PatientSocialHistory', {
	extend: 'Ext.data.Store',
	requires:['App.model.patient.PatientSocialHistory'],
	model: 'App.model.patient.PatientSocialHistory',
	groupField: 'category_code_text'
});



Ext.define('App.view.patient.SocialHistory', {
	extend: 'Ext.grid.Panel',
	requires:[
		'Ext.grid.plugin.RowEditing',
		'Ext.grid.feature.Grouping',
		'App.store.patient.PatientSocialHistory',
		'App.ux.combo.Combo',
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'patientsocialhistorypanel',
	itemId: 'PatientSocialHistoryGrid',
	columnLines: true,
	store: Ext.create('App.store.patient.PatientSocialHistory',{
		remoteFilter: true
	}),
	plugins: [
		{
			ptype: 'rowediting',
			errorSummary: false
		}
	],
	features: [
		{
			ftype: 'grouping',
			groupHeaderTpl: _('type') + ': {name}'
		}
	],
	columns: [
		{
			xtype: 'griddeletecolumn',
			acl: a('delete_social_history'),
			width: 25
		},
		{
			text: _('type'),
			dataIndex: 'category_code_text',
			width: 250
		},
		{
			text: _('observation'),
			dataIndex: 'observation',
			flex: 1,
			itemId: 'socialhistorypanelobservationcolumn',
			editor: {
				xtype: 'textfield',
				allowBlank: false
			}
		},
		{
			text: _('note'),
			dataIndex: 'note',
			flex: 1,
			editor: {
				xtype: 'textfield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('start'),
			dataIndex: 'start_date',
			format: 'Y-m-d',
			width: 120,
			editor: {
				xtype: 'datefield',
				format: 'Y-m-d',
				allowBlank: false
			}
		},
		{
			xtype: 'datecolumn',
			text: _('end'),
			dataIndex: 'end_date',
			format: 'Y-m-d',
			width: 120,
			editor: {
				xtype: 'datefield',
				format: 'Y-m-d'
			}
		}
	],
	tbar: [
		{
			xtype: 'tbtext',
			text: _('social_history'),
			width: 100
		},
		{
			xtype: 'gaiaehr.combo',
			width: 250,
			list: 101,
			allowBlank: false,
			action: 'socialHistoryTypeCombo'
		},
		{
			iconCls: 'icoAdd',
			disabled: true,
			itemId: 'encounterRecordAdd',
			action: 'socialHistoryAddBtn'
		}
	]
});
Ext.define('App.view.patient.SocialPsychologicalBehavioral', {
	extend: 'Ext.panel.Panel',
	requires: [

	],
	itemId: 'SocialPsychologicalBehavioralPanel',
	xtype: 'socialpsychologicalbehavioralpanel',
	title: _('psychological_behavioral'),
	layout: 'border',
	tbar: [
		{
			text: _('spb'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId: 'SocialPsychologicalBehavioralAddBtn'
		}
	],
	initComponent: function () {

		var me = this;

		var store = Ext.create('App.store.patient.SocialPsychologicalBehavioral', {
			remoteFilter: true
		});

		me.items = [
			{
				xtype: 'grid',
				store: store,
				region: 'west',
				width: 450,
				itemId: 'SocialPsychologicalBehavioralGrid',
				columns: [
					{
						xtype: 'datecolumn',
						text: _('observation_date'),
						dataIndex: 'create_date',
						format: 'F j, Y',
						width: 110
					},
					{
						text: _('pay_basic_needs'),
						dataIndex: 'pay_basics',
						width: 110,
						renderer: function (v) {
							var obj = {
								0: 'Very hard',
								1: 'Hard',
								2: 'Somewhat hard',
								3: '3rd grade',
								4: 'Not very hard'
							};

							if(obj[v]){
								return obj[v];
							}

							return v;
						}
					},
					{
						text: _('education'),
						dataIndex: 'edu_highest_grade',
						width: 100,
						renderer: function (v) {
							var obj = {
								0: 'Never attended/kindergarten only',
								1: '1st grade',
								2: '2nd grade',
								3: '3rd grade',
								4: '4th grade',
								5: '5th grade',
								6: '6th grade',
								7: '7th grade',
								8: '8th grade',
								9: '9th grade',
								10: '10th grade',
								11: '11th grade',
								12: '12th grade, no diploma',
								13: 'High school graduate',
								14: 'GED or equivalent',
								15: 'Some college, no degree',
								16: 'Associate degree: occupational, technical, or vocational program',
								17: 'Associate degree: academic program',
								18: 'Bachelor\'s degree',
								19: 'Master\'s degree',
								20: 'Professional school degree',
								21: 'Doctoral degree',
								77: 'Refused',
								99: 'Don\'t know'
							};

							if(obj[v]){
								return obj[v];
							}

							return v;
						}
					},
					{
						text: _('exercise'),
						dataIndex: 'exercise',
						flex: 1,
						renderer: function (v, meta, rec) {
							return Ext.String.format(
								'for {0} min(s) {1} in a week',
								rec.get('exercise_past_days_minutes'),
								rec.get('exercise_past_days_amount')
							);
						}
					}
				]
			},
			{
				xtype:'panel',
				layout: 'fit',
				region: 'center',
				items: [
					{
						xtype: 'chart',
						itemId: 'SocialPsychologicalBehavioralChart',
						animate: true,
						store: store,
						legend: {
							position: 'top'
						},
						axes: [
							{
								type: 'Numeric',
								position: 'left',
								fields: ['stress_level', 'patient_health_score', 'patient_drink_score', 'patient_isolation_score', 'patient_humiliation_score'],
								title: 'Scores',
								grid: true,
								minimum: 0
							},
							{
								type: 'Time',
								position: 'bottom',
								fields: ['create_date'],
								title: 'Date',
								dateFormat: 'M j, Y'
							}
						],
						series: [
							{
								type: 'line',
								highlight: {
									size: 7,
									radius: 7
								},
								axis: 'left',
								xField: 'create_date',
								yField: ['stress_level'],
								title: 'Stress Lvl',
								showInLegend: true,
								markerConfig: {
									type: 'circle',
									size: 4,
									radius: 4,
									'stroke-width': 0
								}
							},
							{
								type: 'line',
								highlight: {
									size: 7,
									radius: 7
								},
								axis: 'left',
								xField: 'create_date',
								yField: ['patient_health_score'],
								title: 'PHQ-2 Score',
								showInLegend: true,
								markerConfig: {
									type: 'circle',
									size: 4,
									radius: 4,
									'stroke-width': 0
								}
							},
							{
								type: 'line',
								highlight: {
									size: 7,
									radius: 7
								},
								axis: 'left',
								xField: 'create_date',
								yField: 'patient_drink_score',
								title: 'AUDIT-C Score',
								showInLegend: true,
								markerConfig: {
									type: 'circle',
									size: 4,
									radius: 4,
									'stroke-width': 0
								}
							},
							{
								type: 'line',
								highlight: {
									size: 7,
									radius: 7
								},
								axis: 'left',
								xField: 'create_date',
								yField: 'patient_isolation_score',
								title: 'NHANES Score',
								showInLegend: true,
								markerConfig: {
									type: 'circle',
									size: 4,
									radius: 4,
									'stroke-width': 0
								}
							},
							{
								type: 'line',
								highlight: {
									size: 7,
									radius: 7
								},
								axis: 'left',
								xField: 'create_date',
								yField: 'patient_humiliation_score',
								title: 'HARK Score',
								showInLegend: true,
								markerConfig: {
									type: 'circle',
									size: 4,
									radius: 4,
									'stroke-width': 0
								}
							}
						]
					}
				]
			}
		];

		me.callParent();
	}

});

Ext.define('App.view.patient.Visits', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('visits_history'),
	uses: [
		'Ext.grid.Panel',
		'Ext.ux.PreviewPlugin',
		'App.view.patient.EncountersGrid'
	],
	itemId: 'PatientVisitsPanel',
	showRating: true,
	initComponent: function(){
		var me = this;

		//******************************************************************
		// Visit History Grid
		//******************************************************************
		me.historyGrid = Ext.create('App.view.patient.EncountersGrid');

		me.pageBody = [me.historyGrid];

		me.callParent(arguments);
	}
});

Ext.define('App.view.fees.PaymentEntryWindow', {
    extend: 'Ext.window.Window',
    title: _('add_new_payment'),
    closeAction: 'hide',
    modal: true,
    initComponent: function(){
        var me = this;
        me.items = [
            {
                xtype: 'form',
                defaults: {
                    margin: 5
                },
                border: false,
                height: 163,
                width: 747,
                items: [
                    {
                        xtype: 'fieldcontainer',
                        layout: 'hbox',
                        items: [
                            {
                                fieldLabel: _('paying_entity'),
                                xtype: 'mitos.payingentitycombo',
                                name: 'paying_entity',
                                action: 'new_payment',
                                labelWidth: 98,
                                width: 220
                            },
                            {
                                xtype: 'patienlivetsearch',
                                fieldLabel: _('from'),
                                hideLabel: false,
                                name: 'payer_id',
                                action: 'new_payment',
                                anchor: null,
                                labelWidth: 42,
                                width: 300,
                                margin: '0 0 0 25'
                            },
                            {
                                xtype: 'textfield',
                                fieldLabel: _('no'),
                                action: 'new_payment',
                                name: 'check_number',
                                labelWidth: 47,
                                width: 167,
                                margin: '0 0 0 25'
                            }
                        ]
                    },
                    {
                        xtype: 'fieldcontainer',
                        layout: 'hbox',
                        items: [
                            {
                                fieldLabel: _('payment_method'),
                                xtype: 'mitos.paymentmethodcombo',
                                action: 'new_payment',
                                labelWidth: 98,
                                name: 'payment_method',
                                width: 220
                            },
                            {
                                xtype: 'mitos.billingfacilitiescombo',
                                fieldLabel: _('pay_to'),
                                action: 'new_payment',
                                labelWidth: 42,
                                name: 'pay_to',
                                width: 300,
                                margin: '0 0 0 25'
                            },
                            {
                                xtype: 'mitos.currency',
                                fieldLabel: _('amount'),
                                action: 'new_payment',
                                name: 'amount',
                                labelWidth: 47,
                                width: 167,
                                margin: '0 0 0 25',
                                enableKeyEvents: true
                            }
                        ]
                    },
                    {
                        fieldLabel: _('post_to_date'),
                        xtype: 'datefield',
                        name: 'post_to_date',
                        action: 'new_payment',
                        format: g('date_display_format'),
                        labelWidth: 98,
                        width: 220
                    },
                    {
                        fieldLabel: _('note'),
                        xtype: 'textareafield',
                        grow: true,
                        action: 'new_payment',
                        name: 'note',
                        labelWidth: 98,
                        anchor: '100%'
                    }
                ]
            }
        ];
        me.buttons = [
            {
                text: _('save'),
                scope: me,
                handler: me.onPaymentSave
            },
            '-',
            {
                text: _('reset'),
                scope: me,
                handler: me.resetNewPayment
            }
        ];
        me.callParent(arguments);
    },
    onPaymentSave: function(){
        var me = this, panel, form, values;
        panel = me.down('form');
        form = panel.getForm();
        values = form.getFieldValues();
        values.date_created = Ext.Date.format(new Date(), 'Y-m-d H:i:s');
        if(form.isValid()){
            Fees.addPayment(values, function(provider, response){
                if(response.result.success){
                    form.reset();
                    me.hide();
                }else{
                    app.msg('Oops!', _('payment_entry_error'))
                }
            });
        }
    },
    resetNewPayment: function(){
        var fields = this.query('[action="new_payment"]');
        for(var i = 0; i < fields.length; i++){
            fields[i].reset();
        }
    }
});

Ext.define('App.view.patient.VisitCheckout', {
	extend:'App.ux.RenderPanel',
	id:'panelVisitCheckout',
	pageTitle:'Visit Checkout',
    showRating:true,
	initComponent:function(){
		var me = this;

		me.VisitVoucherStore = Ext.create('App.store.account.Voucher',{
			remoteFilter:true
		});

		me.pageBody = Ext.create('Ext.panel.Panel', {
			itemId:'visitpayment',
			defaults:{
				bodyStyle:'padding:15px',
				bodyBorder:true,
				labelWidth:110
			},
			layout:{
				type:'vbox',
				align:'stretch'
			},
			items:[
				{
					xtype:'container',
					flex:1,
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[
						me.invoicePanel = Ext.widget('panel',{
							title:_('services_charges'),
							border:true,
							frame:true,
							bodyBorder:true,
							bodyStyle:'background-color:#fff',
							margin:'5 5 0 5',
							flex:2,
                            layout:{
                                type:'vbox',
                                align:'stretch'
                            },
							items:[
                                {
                                    xtype:'container',
                                    flex:1,
                                    autoScroll:true,
                                    items:[
                                        me.invoiceGrid = Ext.widget('grid', {
                                            frame:false,
                                            border:false,
                                            enableColumnMove:false,
                                            enableColumnHide:false,
                                            sortableColumns:false,
                                            columns:[
                                                {
                                                    xtype:'actioncolumn',
                                                    width:20,
                                                    items:[
                                                        {
                                                            icon:'resources/images/icons/delete.png',
                                                            tooltip:_('remove'),
                                                            scope:me,
                                                            handler:me.onRemoveCharge
                                                        }
                                                    ]
                                                },
                                                {
                                                    header:_('item'),
                                                    dataIndex:'name',
                                                    flex:1,
                                                    editor:{
                                                        xtype:'livecptsearch',
                                                        allowBlank:false
                                                    }
                                                },
                                                {
                                                    header:_('price'),
                                                    width:80,
                                                    dataIndex:'amountOriginal',
                                                    align:'right',
                                                    renderer:me.currencyRenderer
                                                },
                                                {
                                                    header:_('charge'),
                                                    width:80,
                                                    dataIndex:'amount',
                                                    align:'right',
                                                    editor:{
                                                        xtype:'textfield',
                                                        allowBlank:false
                                                    },
                                                    renderer:me.currencyRenderer
                                                }
                                            ],
                                            plugins:[
                                                Ext.create('Ext.grid.plugin.CellEditing', {
                                                    clicksToEdit:2
                                                })
                                            ]
                                        }),
                                        {
                                            xtype:'container',
                                            border:false,
                                            padding:1,
                                            height:200,
                                            items:[
                                                {
                                                    xtype:'container',
                                                    style:'float:right',
                                                    layout:'anchor',
                                                    width:150,
                                                    items:[
                                                        me.total = Ext.widget('mitos.currency',{
                                                            fieldLabel:_('total'),
                                                            labelWidth:70,
                                                            anchor:'100%',
                                                            labelAlign:'right',
                                                            cls:'charges_total',
                                                            margin:'2 0 1 0'
                                                        }),
                                                        me.paid = Ext.widget('mitos.currency',{
                                                            fieldLabel:_('paid'),
                                                            labelWidth:70,
                                                            anchor:'100%',
                                                            labelAlign:'right',
                                                            margin:'1 0'
                                                        }),
                                                        me.balance = Ext.widget('mitos.currency',{
                                                            fieldLabel:_('balance'),
                                                            labelWidth:70,
                                                            anchor:'100%',
                                                            labelAlign:'right',
                                                            cls:'charges_balance',
                                                            margin:'2 0 1 0'
                                                        })
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    xtype:'form',
                                    height:135,
                                    border: false,
                                    items:[
                                        {
                                            xtype:'fieldset',
                                            layout:'column',
                                            margin:'5 10',
                                            title:_('payment'),
                                            items:[
                                                me.billingNotes = Ext.widget('textarea',{
                                                    xtype:'textarea',
                                                    anchor:'100%',
                                                    name:'notes',
                                                    columnWidth:.5,
                                                    height:85,
                                                    emptyText:_('additional_billing_notes')

                                                }),
                                                {
                                                    xtype:'container',
                                                    layout:'anchor',
                                                    columnWidth:.5,
                                                    margin:'0 0 0 15',
                                                    items:[
                                                        me.method = Ext.widget('mitos.paymentmethodcombo',{
                                                            fieldLabel: _('payment_method'),
                                                            labelWidth: 100,
                                                            name: 'method',
                                                            anchor:'100%'
                                                        }),
                                                        me.ref = Ext.widget('textfield',{
                                                            fieldLabel: _('reference_#'),
                                                            labelWidth: 100,
                                                            name: 'reference',
                                                            anchor:'100%'
                                                        }),
                                                        me.amount = Ext.widget('mitos.currency',{
                                                            fieldLabel: _('amount'),
                                                            xtype: 'mitos.currency',
                                                            labelWidth: 100,
                                                            name: 'amount',
                                                            anchor:'100%'
                                                        })
                                                    ]
                                                }
                                            ]
                                        }

                                    ]
                                }
							],
							buttons:[
								'->',
								{
									text:_('save_and_print'),
									scope:me,
                                    action:'saveprint',
									handler:me.onInvoiceSave
								},
								{
									text:_('save'),
									scope:me,
                                    action:'save',
									handler:me.onInvoiceSave
								}
							],
							listeners:{
								scope:me,
								render:me.onInvoicePanelRender
							}
						}),
						me.docsGrid = Ext.widget('encounterdocumentsgrid', {
							title:_('documents'),
							frame:true,
							margin:'5 5 0 0',
							flex:1
						})
					]
				},
				{
					xtype:'container',
					layout:'hbox',
					defaults:{ height:170 },
					items:[
						me.notesReminders = Ext.widget('form', {
							title:_('notes_and_reminders'),
							frame:true,
							flex:2,
							action:'formnotes',
							bodyPadding:10,
							margin:'5 5 0 5',
							bodyBorder:true,
							bodyStyle:'background-color:#fff',
							defaults:{ anchor:'100%'},
							items:[
								{
									xtype:'displayfield',
									fieldLabel:_('message'),
									name:'message'
								},
								{
									xtype:'textfield',
									fieldLabel:_('note'),
									name:'new_note',
									action:'notes'
								},
								{
									xtype:'textfield',
									grow:true,
									fieldLabel:_('reminders'),
									name:'new_reminder',
									action:'notes'
								}
							],
							buttons:[
								{
									text:_('reset'),
									scope:me,
									handler:me.resetNotes
								},
								'-',
								{
									text:_('save'),
									scope:me,
									handler:me.onCheckoutSaveNotes
								}
							]
						}),
						me.followUp = Ext.widget('form', {
							title:_('followup_information'),
							frame:true,
							flex:1,
							margin:'5 5 5 0',
							bodyPadding:10,
							bodyBorder:true,
							bodyStyle:'background-color:#fff',
							defaults:{
								labelWidth:110,
								anchor:'100%'
							},
							items:[
								{
									fieldLabel:_('time'),
									xtype:'textfield',
									name:'followup_time'
								},
								{
									fieldLabel:_('facility'),
									xtype:'activefacilitiescombo',
									name:'followup_facility'
								}
							],
							buttons:[
								{
									text:_('schedule_appointment'),
									scope:me,
									handler:me.scheduleAppointment
								}
							]
						})
					]
				}
			]
		});

		me.callParent(arguments);
	},

	onInvoicePanelRender:function(grid){
		var me = this;

		grid.getHeader().add(
			{
				xtype:'button',
				text:_('service'),
				iconCls:'icoAdd',
				margin:'0 5 0 0',
				scope:me,
				handler:me.onNewService
			},
			{
				xtype:'button',
				text:_('copay'),
				iconCls:'icoAdd',
				margin:'0 5 0 0',
				scope:me,
				handler:me.onAddCoPay
			}
//			{
//				xtype:'button',
//				text:_('payment'),
//				iconCls:'icoAdd',
//				scope:me,
//				handler:me.onAddPaymentClick
//			}
		)
	},

	onNewService:function(btn){
		this.invoiceGrid.getStore().add({code_text:' ', charge:'20.00', ins:false});
	},

	onAddCoPay:function(btn){
		this.invoiceGrid.getStore().add({code_text:'Co-Pay', charge:'00.00', ins:false});
	},

	onAddService:function(){
		var totalField = this.query('[action="totalField"]')[0];
	},

	onRemoveCharge:function(grid, rowIndex){
		var me = this,
			store = grid.getStore(),
            record = store.getAt(rowIndex);
		store.remove(record);
		me.updateTotalBalance();
	},

    //***************************************************************
    //***************************************************************
    //***************************************************************

    onInvoiceSave:function(btn){

        var me = this,
            params = {},
            print = btn.action == 'saveprint',
            servicesRec = me.VisitVoucherStore.data.items,
            lines = [];

        for(var i=0; i < servicesRec.length; i++){
            lines.push(servicesRec[i].data);
        }

        params.pid = me.pid;
        params.eid = me.eid;
        params.lines = lines;
        params.payment = {
            amount: me.amount.getValue(),
            method: me.method.getValue(),
            notes: me.billingNotes.getValue(),
            ref: me.ref.getValue()
        };

        AccBilling.setVisitVoucher(params, function(provider, response){


        });
    },



	cancelPrint:function(btn){
		var win = btn.up('window');
		win.close();
	},

	resetReceiptForm:function(){
		var fields = this.query('[action="receipt"]');
		for(var i = 0; i < fields.length; i++){
			fields[i].reset();
		}
	},

	resetNotes:function(){
		var fields = this.query('[action="notes"]');
		for(var i = 0; i < fields.length; i++){
			fields[i].reset();
		}
	},

	onAddPaymentClick:function(){
		app.onPaymentEntryWindow();
	},

	currencyRenderer:function(v){
		return ('<span style="float:right; padding-right:17px">' + app.currency + ' ' + v + '</span>');
	},

	onCheckoutSaveNotes:function(){
		var me = this, form, values, container = me.query('form[action="formnotes"]');
		form = container[0].getForm();
		values = form.getFieldValues();
		values.date = Ext.Date.format(new Date(), 'Y-m-d H:i:s');
		values.pid = app.patient.pid;
		values.eid = me.eid;
		values.uid = app.user.id;
		values.type = 'administrative';

		// TODO: fix this method...

		if(form.isValid()){
			Patient.addPatientNoteAndReminder(values, function(provider, response){
				if(response.result.success){
					app.msg(_('sweet'), _('note_and_reminder'));
				}else{
					app.msg(_('oops'), _('note_entry_error'));
				}
			});
		}
	},

	scheduleAppointment:function(btn){
		var form = btn.up('form').getForm(),
			time = form.findField('followup_time').getValue(),
			facility = form.findField('followup_facility').getValue(),
			calendar = Ext.getCmp('app-calendar'),
			date;

		switch(time){
			case '1 Day':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 1);
				break;
			case '2 Days':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 2);
				break;
			case '3 Days':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 3);
				break;
			case '1 Week':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 7);
				break;
			case '2 Weeks':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 14);
				break;
			case '3 Weeks':
				date = Ext.Date.add(new Date(), Ext.Date.DAY, 21);
				break;
			case '1 Month':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 1);
				break;
			case '2 Months':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 2);
				break;
			case '3 Months':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 3);
				break;
			case '4 Months':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 4);
				break;
			case '5 Months':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 5);
				break;
			case '6 Months':
				date = Ext.Date.add(new Date(), Ext.Date.MONTH, 6);
				break;
			case '1 Year':
				date = Ext.Date.add(new Date(), Ext.Date.YEAR, 1);
				break;
			case '2 Year':
				date = Ext.Date.add(new Date(), Ext.Date.YEAR, 2);
				break;
			default:
				date = new Date();
				break;
		}
		app.navigateTo('panelCalendar');
		calendar.facility = facility;
		calendar.setStartDate(date);
	},

	getVisitOtherInfo:function(){
		var me = this, forms, fields = [];
		forms = me.query('form');
		Encounter.getEncounterFollowUpInfoByEid(me.eid, function(provider, response){
			forms[1].getForm().setValues(response.result);
		});
		Encounter.getEncounterMessageByEid(me.eid, function(provider, response){
			forms[0].getForm().setValues(response.result);
		});
		for(var i = 0; i < forms.length; i++){
			fields.push(forms[i].getForm().getFields().items);
		}
	},

    calculatePercent:function(percent, value){
        return 100 * ( percent / value );
    },

	setVoucher:function(){
		var me = this;
		me.docsGrid.loadDocs(me.eid);

		me.getVisitOtherInfo();

		me.VisitVoucherStore.load({
			filters:[
				{
					property:'encounterId',
					value : me.eid
				},
				{
					property: 'type',
					value: 'visit'
				}
			],
            callback:function(records, operation, success){

	            var voucher = records[0];

				if(voucher){

					voucher.voucherlines().load({
						callback:function(){
							// say('hello');
						}
					});

				}else{

					AccVoucher.getVisitCheckOutCharges({pid:me.pid,eid:me.eid},function(provicer,response){
						var charges = response.result;
						if(charges.length > 0){
							var rec = me.VisitVoucherStore.add({
									encounterId:me.eid,
									date:new Date(),
									type:'visit'
								}),
								store = rec[0].voucherlines();

							me.invoiceGrid.reconfigure(store);
							for(var i=0; i < charges.length; i++){
								store.add(charges[i]);
							}

			                me.paid.setValue(0.00);
                            me.updateTotalBalance();
						}
					});
				}
            }
		})
	},

    updateTotalBalance:function(){
        var me = this,
            amount   = me.amount.getValue(),
            paid   = me.paid.getValue(),
            records = me.invoiceGrid.getStore().data.items,
            form = me.invoicePanel.down('form'),
            total = 0.00, balance;

        for(var i=0; i < records.length; i++){
            total = eval(total) + eval(records[i].data.amount);
        }
        me.total.setValue(total);
        balance = total - paid;
        me.balance.setValue(balance);
        me.setPaid(balance == 0.00 && records.length > 0);
    },

	setPaid:function(paid){
		var form = this.invoicePanel.down('form');
		if(paid){
			form.addBodyCls('paid');
			form.down('fieldset').setVisible(false);
		}else{
			form.removeBodyCls('paid');
			form.down('fieldset').setVisible(true);
		}
	},

	setVisitPanel:function(){
		this.pid = app.patient.pid;
		this.eid = app.patient.eid;
		this.uid = app.user.id;
		this.updateTitle(app.patient.name + ' - #' + app.patient.pid + ' (' + _('visit_checkout') + ')');
		this.setVoucher();
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive:function(callback){
		var me = this;
		if(app.patient.pid && app.patient.eid){
			me.setVisitPanel();
			callback(true);
		}else{
			callback(false);
			me.currPatientError();
		}
	}


});

Ext.define('App.view.fees.Billing',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelBilling',
	pageTitle : _( 'billing' ),
	uses : ['Ext.grid.Panel'],
	pageLayout : 'card',

	initComponent : function()
	{
		var me = this;
		me.paymentstatus = 1;
		me.patient = null;
		me.pastDue = null;
		me.dateRange =
		{
			start : null,
			limit : null
		};

		me.patientListStore = Ext.create( 'App.store.fees.Billing' );

		/**
		 *  Encounter data grid.
		 * Gives a list of encounter based on the patient search
		 *
		 */
		me.encountersGrid = Ext.create( 'Ext.grid.Panel',
		{
			store : me.patientListStore,
			selModel : Ext.create( 'Ext.selection.CheckboxModel',
			{
				listeners :
				{
					scope : me,
					selectionchange : me.onSelectionChanged
				}
			} ),
			viewConfig :
			{
				stripeRows : true
			},
			columns : [
			{
				header : _( 'service_date' ),
				dataIndex : 'service_date',
				width : 200
			},
			{
				header : _( 'patient' ),
				dataIndex : 'patientName',
				width : 200
			},
			{
				header :  _('first') + ' ' + _('visit'),
				dataIndex : 'first_visit_date',
				width : 200
			},
			{
				header : _( 'encounter_provider' ),
				dataIndex : 'encounterProvider',
				flex : 1
			},
			{
				header : _( 'insurance' ),
				dataIndex : 'insurance',
				width : 200
			},
			{
				header : _( 'billing_stage' ),
				dataIndex : 'billing_stage',
				renderer : me.stage,
				width : 135
			}],
			// ToolBar for Encounter DataGrid.
			tbar : [
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerPatientSearch',
				items : [
				{
					xtype : 'displayfield',
					fieldLabel : _( 'patient_search' )
				},
				{
					xtype : 'patienlivetsearch',
					itemId : 'patienlivetsearch',
					width : 235,
					margin : '0 5 0 0'
				}]
			},
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerDateRange',
				items : [
				{
					xtype : 'datefield',
					itemId : 'datefrom',
					fieldLabel : _( 'from' ),
					labelWidth : 35,
					width : 150,
					format : g('date_display_format')
				},
				{
					xtype : 'datefield',
					itemId : 'dateto',
					fieldLabel : _( 'to' ),
					labelWidth : 35,
					padding : '0 5 0 0',
					width : 150,
					format : g('date_display_format')
				}]
			},
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerInsurance',
				items : [
				{
					xtype : 'mitos.providerscombo',
					itemId : 'provider',
					labelWidth : 60,
					typeAhead : true,
					padding : '0 5 0 5',
					fieldLabel : _( 'provider' ),
					defaultValue : 'All'

				},
				{
					xtype : 'mitos.insurancepayertypecombo',
					itemId : 'insurance',
					labelWidth : 60,
					padding : '0 5 0 5',
					fieldLabel : _( 'insurance' ),
					defaultValue : 'All'

				}]
			}, '-',
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerSearch',
				layout : 'vbox',
				items : [
				{
					xtype : 'button',
					width : 80,
					margin : '0 0 3 0',
					text : _( 'search' ),
					listeners :
					{
						scope : me,
						click : me.ReloadGrid
					}
				}]
			}, '-',
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerGenerate1500',
				layout : 'vbox',
				items : [
				{
					xtype : 'button',
					width : 170,
					margin : '0 0 3 0',
					text : _( 'generate_cms1500_pdf' )
				},
				{
					xtype : 'button',
					width : 170,
					margin : '0 0 3 0',
					text : _( 'generate_cms1500_text' )
				}]
			}, '-',
			{
				xtype : 'fieldcontainer',
				itemId : 'fieldContainerGenerateANSI',
				layout : 'vbox',
				items : [
				{
					xtype : 'button',
					text : _( 'generate_x12' )
				}]
			}, '->',
			{
				xtype : 'tbtext',
				text : _( 'past_due' ) + ':'
			},
			{
				text : _( '30+' ),
				enableToggle : true,
				action : 30,
				toggleGroup : 'pastduedates',
				enableKeyEvents : true,
				scale : 'large',
				listeners :
				{
					scope : me,
					click : me.onBtnClicked
				}
			},
			{
				text : _( '60+' ),
				enableToggle : true,
				action : 60,
				scale : 'large',
				toggleGroup : 'pastduedates',
				listeners :
				{
					scope : me,
					click : me.onBtnClicked
				}
			},
			{
				text : _( '120+' ),
				enableToggle : true,
				action : 120,
				scale : 'large',
				toggleGroup : 'pastduedates',
				listeners :
				{
					scope : me,
					click : me.onBtnClicked
				}
			},
			{
				text : _( '180+' ),
				enableToggle : true,
				action : 180,
				scale : 'large',
				toggleGroup : 'pastduedates',
				listeners :
				{
					scope : me,
					click : me.onBtnClicked
				}
			}],
			listeners :
			{
				scope : me,
				itemdblclick : me.rowDblClicked
			}
		} );

		/**
		 * Panel: encounterBillingDetails
		 */
		me.encounterBillingDetails = Ext.create( 'Ext.panel.Panel',
		{
			defaultTitle : _( 'encounter_billing_details' ),
			title : _( 'encounter_billing_details' ),
			layout : 'border',
			bodyStyle : 'background-color:#fff',
			items : [Ext.create( 'Ext.container.Container',
			{
				region : 'center',
				layout : 'border',
				style : 'background-color:#fff',
				items : [me.icdForm = Ext.create( 'Ext.form.Panel',
				{
					region : 'north',
					border : false,
					items : [
					{
						xtype : 'fieldset',
						title : _( 'encounter_general_info' ),
						margin : '5 5 0 5',
						items : [
						{
							xtype : 'fieldcontainer',
							layout :
							{
								type : 'hbox'
							},
							defaults :
							{
								margin : '0 10'
							},
							hideLabel : true,
							items : [
							{
								xtype : 'datefield',
								name : 'service_date',
								fieldLabel : _( 'service_date' ),
								labelAlign : 'right',
								labelWidth : 80,
								format : g('date_display_format')
							},
							{
								xtype : 'activeinsurancescombo',
								name : 'insurance',
								fieldLabel : _( 'insurance' ),
								labelAlign : 'right'
							},
							{
								xtype : 'textfield',
								name : 'facility',
								fieldLabel : _( 'facility' ),
								labelAlign : 'right',
								labelWidth : 60,
								flex : 1
							}]
						},
						{
							xtype : 'fieldcontainer',
							layout :
							{
								type : 'hbox'
							},
							defaults :
							{
								margin : '0 10'
							},
							hideLabel : true,
							items : [
							{
								xtype : 'datefield',
								name : 'hosp_date',
								fieldLabel : _( 'hosp_date' ),
								labelAlign : 'right',
								labelWidth : 80,
								format : g('date_display_format')
							},
							{
								xtype : 'activeinsurancescombo',
								name : 'sec_insurance',
								fieldLabel : _( 'sec_insurance' ),
								labelAlign : 'right'
							},
							{
								xtype : 'mitos.providerscombo',
								name : 'provider',
								fieldLabel : _( 'provider' ),
								labelAlign : 'right',
								labelWidth : 60,
								flex : 1
							}]
						},
						{
							xtype : 'fieldcontainer',
							layout :
							{
								type : 'hbox'
							},
							defaults :
							{
								margin : '0 10'
							},
							hideLabel : true,
							items : [
							{
								xtype : 'mitos.authorizationscombo',
								name : 'authorization',
								fieldLabel : _( 'authorization' ),
								labelAlign : 'right',
								labelWidth : 80
							},
							{
								xtype : 'textfield',
								name : 'sec_authorization',
								fieldLabel : _( 'sec_authorization' ),
								labelAlign : 'right'
							},
							{
								xtype : 'textfield',
								name : 'referal_by',
								fieldLabel : _( 'referal_by' ),
								labelAlign : 'right',
								labelWidth : 60,
								flex : 1
							}]
						}]
					},
					{
						xtype : 'icdsfieldset',
						title : _( 'encounter_icd9' ),
						margin : '5 5 0 5'
					}]
				} ), me.cptPanel = Ext.create( 'App.view.patient.encounter.CurrentProceduralTerminology',
				{
					region : 'center'
				} )]
			} ), me.progressNote = Ext.create( 'App.view.patient.ProgressNote',
			{
				title : _( 'encounter_progress_note' ),
				region : 'east',
				margin : 5,
				bodyStyle : 'padding:15px',
				width : 500,
				autoScroll : true,
				collapsible : true,
				animCollapse : true,
				collapsed : false
			} )],
			buttons : [
			{
				text : _( 'encounters' ),
				scope : me,
				action : 'encounters',
				tooltip : _( 'back_to_encounter_list' ),
				handler : me.onBtnCancel
			}, '->',
			{
				xtype : 'tbtext',
				action : 'page',
				text : '( 1 of 1 )'
			},
			{
				text : _( 'back' ),
				scope : me,
				action : 'back',
				iconCls : 'icoArrowLeftSmall',
				tooltip : _( 'previous_encounter_details' ),
				handler : me.onBtnBack
			},
			{
				text : _( 'save' ),
				scope : me,
				action : 'save',
				tooltip : _( 'save_billing_details' ),
				handler : me.onBtnSave
			},
			{
				text : _( 'cancel' ),
				scope : me,
				action : 'cancel',
				tooltip : _( 'cancel_and_go_back_to_encounter_list' ),
				handler : me.onBtnCancel
			},
			{
				text : _( 'next' ),
				scope : me,
				action : 'next',
				iconCls : 'icoArrowRightSmall',
				iconAlign : 'right',
				tooltip : _( 'next_encounter_details' ),
				handler : me.onBtnNext
			}]
		} );

		me.pageBody = [me.encountersGrid, me.encounterBillingDetails];
		me.callParent( arguments );
	},

	/**
	 * Function: stage
	 */
	stage : function(val)
	{

		say(val);
		switch(val)
		{
			case 0:
				return '<img src="resources/images/icons/stage0.png" />';
				break;
			case 1:
				return '<img src="resources/images/icons/stage1.png" />';
				break;
			case 2:
				return '<img src="resources/images/icons/stage2.png" />';
				break;
			case 3:
				return '<img src="resources/images/icons/stage3.png" />';
				break;
			case 4:
				return '<img src="resources/images/icons/stage4.png" />';
				break;
			default:
				return val;
		}
	},

	/**
	 * Event: onBtnClicked
	 */
	onBtnClicked : function(btn)
	{
		var datefrom = this.query( 'datefield[itemId="datefrom"]' ), dateto = this.query( 'datefield[itemId="dateto"]' );
		if (btn.pressed)
		{
			datefrom[0].reset( );
			dateto[0].reset( );
			this.pastDue = btn.action;
		}
		else
		{
			this.pastDue = 0;
		}
		this.ReloadGrid( );

	},

	/**
	 * Event: rowDblClicked
	 */
	rowDblClicked : function()
	{
		this.goToEncounterBillingDetail( );
	},

	/**
	 * Function: goToEncounterBillingDetail
	 */
	goToEncounterBillingDetail : function()
	{
		this.getPageBody( ).getLayout( ).setActiveItem( 1 );
	},

	/**
	 * Function: goToEncounterList
	 */
	goToEncounterList : function()
	{
		this.getPageBody( ).getLayout( ).setActiveItem( 0 );
	},

	/**
	 * Event: onSelectionChanged
	 */
	onSelectionChanged : function(sm, model)
	{
		if (model[0])
		{
			var me = this, title = me.encounterBillingDetails.defaultTitle, backbtn = me.encounterBillingDetails.query( 'button[action="back"]' ), nextBtn = me.encounterBillingDetails.query( 'button[action="next"]' ), pageInfo = me.encounterBillingDetails.query( 'tbtext[action="page"]' ), rowIndex = model[0].index;

			me.pid = model[0].data.pid;
			me.eid = model[0].data.eid;

			me.updateProgressNote( me.eid );
			me.encounterBillingDetails.setTitle( title + ' ( ' + model[0].data.patientName + ' )' );

			me.getEncounterIcds( );

			me.cptPanel.encounterCptStoreLoad( me.pid, me.eid, function()
			{
				me.cptPanel.setDefaultQRCptCodes( );
			} );

			pageInfo[0].setText( '( ' + _( 'page' ) + ' ' + (rowIndex + 1) + ' of ' + sm.store.data.length + ' )' );
			nextBtn[0].setDisabled( rowIndex == sm.store.data.length - 1 );
			backbtn[0].setDisabled( rowIndex == 0 );
		}
	},

	/**
	 * Event: onBtnCancel
	 */
	onBtnCancel : function()
	{
		this.getPageBody( ).getLayout( ).setActiveItem( 0 );
	},

	/**
	 * Event: onBtnBack
	 */
	onBtnBack : function()
	{
		var sm = this.encountersGrid.getSelectionModel( ), currRowIndex = sm.getLastSelected( ).index, prevRowindex = currRowIndex - 1;
		sm.select( prevRowindex );
	},

	/**
	 * Event: onBtnNext
	 */
	onBtnNext : function()
	{
		var sm = this.encountersGrid.getSelectionModel( ), currRowIndex = sm.getLastSelected( ).index, nextRowindex = currRowIndex + 1;
		sm.select( nextRowindex );
	},

	/**
	 * Event: onBtnSave
	 */
	onBtnSave : function()
	{
		var me = this, form = me.icdForm.getForm( ), values = form.getValues( );

		me.updateEncounterIcds( values );
		me.msg( _('sweet'), _( 'encounter_billing_data_updated' ) );
	},

	/**
	 * Function: getEncounterIcds
	 */
	getEncounterIcds : function()
	{
		var me = this;
		/**
		 * TODO !!
		 */
//		Encounter.getEncounterIcdxCodes(
//		{
//			eid : me.eid
//		}, function(provider, response)
//		{
//			me.icdForm.down( 'icdsfieldset' ).loadIcds( response.result );
//		} );
	},

	/**
	 * Function: updateEncounterIcds
	 */
	updateEncounterIcds : function(data)
	{
		var me = this;

		data.eid = me.eid;
		/**
		 * TODO !!
		 */
//		Encounter.updateEncounterIcdxCodes( data, function(provider, response)
//		{
//			say( response.result );
//			return true;
//		} );
	},

	/**
	 * Function: updateProgressNote
	 */
	updateProgressNote : function(eid)
	{
		var me = this;
		Encounter.getProgressNoteByEid( eid, function(provider, response)
		{
			var data = response.result;
			me.progressNote.tpl.overwrite( me.progressNote.body, data );
		} );
	},

	/**
	 * Function: Search for billing based on the search fields
	 * This function will pass all the fields to the server side
	 * so PHP dataProvider can calculate and do the search against
	 * the SQL Server
	 */
	ReloadGrid : function(btn)
	{
		// Declare some variables
		var topBarItems = this.encountersGrid.getDockedItems('toolbar[dock="top"]')[0],
		datefrom = topBarItems.getComponent( 'fieldContainerDateRange' ).getComponent( 'datefrom' ).getValue( ),
		dateto = topBarItems.getComponent( 'fieldContainerDateRange' ).getComponent( 'dateto' ).getValue( );

		// Check if the dateFrom and dateTo are in use, if they are clear the pastDue variable
		if(datefrom || dateto) this.pastDue = 0;

		// Load the ExtJs dataStore with the new parameters
		this.patientListStore.load(
		{
			params :
			{
				datefrom : datefrom,
				dateto : dateto,
				provider : topBarItems.getComponent( 'fieldContainerInsurance' ).getComponent( 'provider' ).getValue( ),
				insurance : topBarItems.getComponent( 'fieldContainerInsurance' ).getComponent( 'insurance' ).getValue( ),
				patient : topBarItems.getComponent( 'fieldContainerPatientSearch' ).getComponent( 'patienlivetsearch' ).getValue( ),
				pastDue : this.pastDue
			}
		} );

	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		this.ReloadGrid( );
		callback( true );
	}
} );


Ext.define('App.view.fees.Payments',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelPayments',
	pageTitle : _('payments'),
	initComponent : function()
	{
		var me = this;

		me.encountersPaymentsStore = Ext.create('App.store.fees.EncountersPayments');

		/**
		 * Search Panel Object
		 * --------------------------------------------------------------------------------------------------------------------------
		 */
		me.searchPanel = Ext.create('Ext.panel.Panel',
		{
			title : _('search'),
			layout : 'border',
			items : [
			{
				xtype : 'form',
				itemId : 'searchPanelForm',
				height : 145,
				region : 'north',
				bodyPadding : 10,
				bodyStyle : 'background-color:transparent',
				margin : '0 0 5 0',
				items : [
				{
					xtype : 'fieldcontainer',
					itemId : 'fieldcontainerSearchItems',
					layout : 'hbox',
					items : [
					{
						fieldLabel : _('paying_entity'),
						itemId : 'fieldPayingEntityCombo',
						xtype : 'mitos.payingentitycombo',
						labelWidth : 95,
						width : 230
					},
					{
						xtype : 'patienlivetsearch',
						fieldLabel : _('from'),
						hideLabel : false,
						itemId : 'fieldPatient',
						name : 'from',
						anchor : null,
						labelWidth : 42,
						width : 470,
						margin : '0 0 0 25'
					},
					{
						xtype : 'textfield',
						fieldLabel : _('no'),
						itemId : 'fieldPatientNo',
						name : 'transaction_number',
						labelWidth : 45,
						width : 230,
						labelAlign : 'right',
						margin : '0 0 0 25',
						fieldStyle : 'text-align: right;'
					}]
				},
				{
					xtype : 'fieldcontainer',
					layout : 'hbox',
					itemId : 'fieldcontainerFacility',
					items : [
					{
						xtype : 'mitos.billingfacilitiescombo',
						itemId : 'fieldFacility',
						fieldLabel : _('pay_to'),
						labelWidth : 95,
						width : 470
					}]
				},
				{
					xtype : 'fieldcontainer',
					itemId: 'fieldcontainerFromTo',
					layout : 'hbox',
					items : [
					{
						fieldLabel : _('from'),
						itemId : 'fieldFromDate',
						xtype : 'datefield',
						format: g('date_display_format'),
						labelWidth : 95,
						width : 230
					},
					{
						fieldLabel : _('to'),
						xtype : 'datefield',
						itemId : 'fieldToDate',
						format: g('date_display_format'),
						margin : '0 0 0 25',
						labelWidth : 42,
						width : 230
					}]
				}],
				buttons : [
				{
					text : _('search'),
					handler: me.onSearchButton,
					scope : me
				}, '-',
				{
					text : _('reset'),
					scope : me,
					handler: me.onFormResetButton
					// TODO: Create the function event to reset the form.
				}]
			},
			{
				xtype : 'grid',
				region : 'center',
				store : me.encountersPaymentsStore,
				columns : [
				{
					header : _('service_date')
				},
				{
					header : _('patient_name')
				},
				{
					header : _('insurance')
				},
				{
					header : _('billing_notes'),
					flex : 1
				},
				{
					header : _('balance_due')
				}]
			}]
		});

		/**
		 * Detail Panel Object
		 * --------------------------------------------------------------------------------------------------------------------------
		 */
		me.detailPanel = Ext.create('Ext.panel.Panel',
		{
			title : _('detail'),
			layout : 'border',
			items : [
			{
				xtype : 'form',
				height : 145,
				region : 'north',
				bodyPadding : 10,
				bodyStyle : 'background-color:transparent',
				margin : '0 0 5 0',
				items : [
				{
					xtype : 'fieldcontainer',
					layout : 'hbox',
					items : [
					{
						fieldLabel : _('paying_entity'),
						xtype : 'mitos.payingentitycombo',
						labelWidth : 95,
						width : 230
					},
					{
						xtype : 'patienlivetsearch',
						fieldLabel : _('from'),
						hideLabel : false,
						itemId : 'patientFrom',
						name : 'from',
						anchor : null,
						labelWidth : 42,
						width : 470,
						margin : '0 0 0 25'
					},
					{
						xtype : 'textfield',
						fieldLabel : _('no'),
						name : 'transaction_number',
						labelWidth : 45,
						width : 230,
						labelAlign : 'right',
						margin : '0 0 0 25',
						fieldStyle : 'text-align: right;'
					}]
				},
				{
					xtype : 'fieldcontainer',
					layout : 'hbox',
					items : [
					{
						fieldLabel : _('payment_method'),
						xtype : 'mitos.paymentmethodcombo',
						labelWidth : 95,
						width : 230
					},
					{
						xtype : 'mitos.billingfacilitiescombo',
						fieldLabel : _('pay_to'),
						labelWidth : 42,
						width : 470,
						margin : '0 0 0 25'
					},
					{
						xtype : 'mitos.currency',
						fieldLabel : _('amount'),
						name : 'amount',
						labelWidth : 45,
						width : 230,
						labelAlign : 'right',
						margin : '0 0 0 25',
						enableKeyEvents : true
					}]
				},
				{
					xtype : 'fieldcontainer',
					layout : 'hbox',
					items : [
					{
						fieldLabel : _('from'),
						xtype : 'datefield',
						format: g('date_display_format'),
						labelWidth : 95,
						width : 230
					},
					{
						fieldLabel : _('to'),
						xtype : 'datefield',
						format: g('date_display_format'),
						margin : '0 0 0 25',
						labelWidth : 42,
						width : 230
					}]
				}],
				buttons : [
				{
					text : _('save')
				}, '-',
				{
					text : _('reset')
				}, '->',
				{
					text : _('add_payment'),
					scope : me,
					handler : me.onAddPaymentClick

				}]
			},
			{
				xtype : 'grid',
				region : 'center',
				//store:me.encountersPaymentsStore,
				plugins : Ext.create('App.ux.grid.RowFormEditing',
				{
					autoCancel : false,
					errorSummary : false,
					clicksToEdit : 1,
					enableRemove : true,
					listeners :
					{
						scope : me,
						beforeedit : me.beforeCptEdit
					}
				}),
				columns : [
				{
					header : _('service_date')
				},
				{
					header : _('patient_name')
				},
				{
					header : _('insurance')
				},
				{
					header : _('billing_notes'),
					flex : 1
				},
				{
					header : _('balance_due')
				}]
			}]
		});

		me.tapPanel = Ext.create('Ext.tab.Panel',
		{
			layout : 'fit',
			items : [me.searchPanel, me.detailPanel]
		});

		me.pageBody = [me.tapPanel];
		me.callParent(arguments);
	},

	/**
	 * Shows the payment entry window. 
	 */
	onAddPaymentClick : function()
	{
		app.onPaymentEntryWindow();
	},

	/**
	 * beforeCptEdit Event
	 */
	beforeCptEdit : function(editor, e)
	{
		this.addCptFields(editor.editor, e.record.data)
	},

	/**
	 * addCptFields
	 * Add CPT
	 */
	addCptFields : function(editor, cpts)
	{

		editor.removeAll();

		var testData = this.testData();
		for (var i = 0; i < testData.length; i++)
		{
			editor.add(
			{
				xtype : 'fieldcontainer',
				layout : 'hbox',
				items : [
				{
					xtype : 'textfield',
					width : 100,
					name : 'code',
					readOnly : true,
					margin : '0 5 0 10'
				},
				{
					xtype : 'textfield',
					name : 'copay',
					readOnly : true,
					width : 400,
					margin : '0 5 0 5'
				},
				{
					xtype : 'mitos.currency',
					name : 'remaining',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				},
				{
					xtype : 'mitos.currency',
					name : 'allowed',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				},
				{
					xtype : 'mitos.currency',
					name : 'payment',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				},
				{
					xtype : 'mitos.currency',
					name : 'deductible',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				},
				{
					xtype : 'mitos.currency',
					name : 'takeback',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				},
				{
					xtype : 'checkbox',
					name : 'takeback',
					readOnly : true,
					width : 50,
					margin : '0 5 0 5'
				},
				{
					xtype : 'textfield',
					name : 'takeback',
					readOnly : true,
					width : 100,
					margin : '0 5 0 5'
				}]
			});
		}
	},

	/**
	 * Test Data function
	 */
	testData : function()
	{
		var data = [], i;

		floor = Math.floor((Math.random() * 6) + 1);

		for ( i = 0; i < floor; i++)
		{
			data.push(
			{
				data1 : Math.floor(Math.max((Math.random() * 100), floor)),
				data2 : Math.floor(Math.max((Math.random() * 100), floor)),
				data3 : Math.floor(Math.max((Math.random() * 100), floor)),
				data4 : Math.floor(Math.max((Math.random() * 100), floor)),
				data5 : Math.floor(Math.max((Math.random() * 100), floor)),
				data6 : Math.floor(Math.max((Math.random() * 100), floor)),
				data7 : Math.floor(Math.max((Math.random() * 100), floor)),
				data8 : Math.floor(Math.max((Math.random() * 100), floor)),
				data9 : Math.floor(Math.max((Math.random() * 100), floor))
			});
		}
		return data;
	},

	/**
	 * onBtnClick Event
	 */
	onBtnClick : function(btn)
	{
		var me = this;

		if (btn.action == 'search')
		{
			me.forms.getLayout().setActiveItem(0);
		}
		else
		if (btn.action == 'details')
		{
			me.forms.getLayout().setActiveItem(1);
		}
		else
		if (btn.action == 'new')
		{
			me.window.show();
		}
	},
	
	/**
	 * Search for patients that own money
	 * This function will pass all the fields to the server side 
	 * so PHP dataProvider can calculate and do the search against 
	 * the SQL Server
	 */
	onSearchButton: function(btn)
	{
		// Declare some variables and the values from the form
		var	searchForm =  this.searchPanel.getComponent('searchPanelForm'),
		dateFrom = searchForm.getComponent('fieldcontainerFromTo').getComponent('fieldFromDate').getValue(),
		dateTo = searchForm.getComponent('fieldcontainerFromTo').getComponent('fieldToDate').getValue();
		
		// Load the ExtJs dataStore with the new parameters
		this.encountersPaymentsStore.load(
		{
			params :
			{
				datefrom : dateFrom,
				dateto : dateTo,
				payingEntityCombo : searchForm.getComponent('fieldcontainerSearchItems').getComponent('fieldPayingEntityCombo').getValue(),
				patientSearch : searchForm.getComponent('fieldcontainerSearchItems').getComponent('fieldPatient').getValue(),
				patientNo : searchForm.getComponent('fieldcontainerSearchItems').getComponent('fieldPatientNo').getValue(),
				facility : searchForm.getComponent('fieldcontainerFacility').getComponent('fieldFacility').getValue()
			}
		} );
		//alert(payingEntityCombo);
	},
	
	/**
	 * Reset the form of search.
	 */
	onFormResetButton: function(btn)
	{
		alert('Hello there');
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		this.encountersPaymentsStore.load();
		callback(true);
	}
});
//end Payments class


Ext.define('App.model.administration.Department', {
	extend: 'Ext.data.Model',
	table: {
		name: 'departments'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 5,
			index: true
		},
		{
			name: 'title',
			type: 'string',
			len: 100
		},
        {
            name: 'taxonomy',
            type: 'string',
            len: 15
        },

        {
            name: 'external_id',
            type: 'string',
            len: 25
        },
        {
            name: 'global_id',
            type: 'string',
            len: 50
        },
        {
            name: 'is_specialty_required_for_billing',
            type: 'bool'
        },
        {
            name: 'active',
            type: 'bool'
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Facilities.getDepartments',
			create: 'Facilities.addDepartment',
			update: 'Facilities.updateDepartment'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.store.administration.Departments', {
	extend: 'Ext.data.Store',
	requires: ['App.model.administration.Department'],
	model: 'App.model.administration.Department'
});
Ext.define('App.store.administration.Specialties', {
    model: 'App.model.administration.Specialty',
    extend: 'Ext.data.Store'
});
Ext.define('App.store.administration.FacilityStructures', {
    extend: 'Ext.data.TreeStore',
	requires: ['App.model.administration.FacilityStructure'],
	model: 'App.model.administration.FacilityStructure'
});
Ext.define('App.view.administration.practice.FacilityConfig', {
	extend: 'Ext.panel.Panel',
	requires: [

	],
	xtype: 'facilityconfigpanel',
	title: _('facility_configuration'),
	itemId: 'FacilityStructurePanel',
	layout: {
		type: 'hbox',
		align: 'stretch'
	},
	items: [
		{
			xtype: 'container',
			margin: 5,
			flex: 1,
			layout: {
				type: 'vbox',
				align: 'stretch'
			},
			items: [
				{
					xtype: 'grid',
					title: _('departments'),
					hideHeaders: false,
					frame: true,
					margin: '0 0 5 0',
					store: Ext.create('App.store.administration.Departments', {
						autoLoad: true
					}),
					viewConfig: {
						plugins: {
							ptype: 'gridviewdragdrop',
							dragGroup: 'facilitygroup1',
							dropGroup: 'facilitygroup2',
							onViewRender: function(view){
								var me = this,
									scrollEl;

								if(me.enableDrag){
									if(me.containerScroll){
										scrollEl = view.getEl();
									}

									me.dragZone = new Ext.view.DragZone({
										view: view,
										copy: true,
										ddGroup: me.dragGroup || me.ddGroup,
										dragText: me.dragText,
										containerScroll: me.containerScroll,
										scrollEl: scrollEl
									});
								}

								if(me.enableDrop){
									me.dropZone = new Ext.grid.ViewDropZone({
										view: view,
										ddGroup: me.dropGroup || me.ddGroup
									});
								}
							}
						},
						listeners: {
							drop: function(node, data, dropRec, dropPosition){

								say(node);
								say(data);
								say(dropRec);
								say(dropPosition);

								//var dropOn = dropRec ? ' ' + dropPosition + ' ' + dropRec.get('name') : ' on empty view';
								//Ext.example.msg('Drag from right to left', 'Dropped ' + data.records[0].get('name') + dropOn);
							}
						}
					},
					columns: [
						{
							text: _('id'),
							sortable: true,
							dataIndex: 'id',
							width: 50
						},
						{
							text: _('code'),
							sortable: true,
							dataIndex: 'code',
							editor: {
								xtype: 'textfield'
							}
						},
						{
							text: _('external_id'),
							sortable: true,
							width: 150,
							dataIndex: 'external_id',
							editor: {
								xtype: 'textfield'
							}
						},
                        {
                            text: _('taxonomy'),
                            dataIndex: 'taxonomy',
                            editor: {
                                xtype: 'textfield',
                                allowBlank: false
                            }
                        },
						{
							text: 'title',
							dataIndex: 'title',
							flex: 2
						},
                        {
                            text: _('specialty_required_for_billing'),
                            sortable: true,
                            dataIndex: 'is_specialty_required_for_billing',
                            renderer: function(v){
                                return app.boolRenderer(v);
                            },
                            editor: {
                                xtype: 'checkboxfield'
                            }
                        },
                        {
                            text: _('active'),
                            sortable: true,
                            dataIndex: 'active',
                            renderer: function(v){
                                return app.boolRenderer(v);
                            },
                            editor: {
                                xtype: 'checkboxfield'
                            }
                        }
					]
				},
				{
					xtype: 'grid',
					title: _('specialties'),
					//					hideHeaders: true,
					frame: true,
					flex: 1,
					store: this._sepecialtyStore = Ext.create('App.store.administration.Specialties', {
						autoLoad: true
					}),
					viewConfig: {
						plugins: {
							ptype: 'gridviewdragdrop',
							dragGroup: 'facilitygroup1',
							dropGroup: 'facilitygroup2'
						},
						listeners: {
							drop: function(node, data, dropRec, dropPosition){

								say(node);
								say(data);
								say(dropRec);
								say(dropPosition);

								//var dropOn = dropRec ? ' ' + dropPosition + ' ' + dropRec.get('name') : ' on empty view';
								//Ext.example.msg('Drag from right to left', 'Dropped ' + data.records[0].get('name') + dropOn);
							}
						}
					},
					columns: [
						{
							text: _('id'),
							sortable: true,
							dataIndex: 'id',
							width: 50
						},
						{
							text: _('code'),
							sortable: true,
							dataIndex: 'code',
							editor: {
								xtype: 'textfield'
							}
						},
						{
							text: _('external_id'),
							sortable: true,
							width: 150,
							dataIndex: 'external_id',
							editor: {
								xtype: 'textfield'
							}
						},
                        {
                            text: _('taxonomy'),
                            sortable: true,
                            dataIndex: 'taxonomy',
                            editor: {
                                xtype: 'textfield'
                            }
                        },
                        {
							width: 200,
							text: _('title'),
							dataIndex: 'title',
							sortable: true,
							flex: 1,
							editor: {
								xtype: 'textfield'
							}
						},

						{
							text: _('modality'),
							sortable: true,
							dataIndex: 'modality',
							width: 100,
							editor: {
								xtype: 'textfield'
							}
						},
                        {
                            text: _('isFda'),
                            sortable: true,
                            dataIndex: 'isFda',
							width: 75,
							renderer: function(v){
								return app.boolRenderer(v);
							},
							editor: {
								xtype: 'checkboxfield'
							}
                        },

						{
							text: _('active'),
							sortable: true,
							width: 75,
							dataIndex: 'active',
							renderer: function(v){
								return app.boolRenderer(v);
							},
							editor: {
								xtype: 'checkboxfield'
							}
						}
					],
					plugins: [
						{
							ptype: 'rowediting',
							clicksToEdit: 2
						}
					],
					tools: [
						{
							xtype: 'button',
							text: _('specialty'),
							iconCls: 'icoAdd',
							itemId: 'SpecialitiesAddBtn'
						}
					],
					bbar: Ext.create('Ext.PagingToolbar', {
						pageSize: 10,
						store: this._sepecialtyStore,
						displayInfo: true,
						plugins: Ext.create('Ext.ux.SlidingPager', {})
					})
				}
			]
		},
		{
			xtype: 'treepanel',
			title: _('facility_structure'),
			itemId: 'FacilityStructureTreePanel',
			store: Ext.create('App.store.administration.FacilityStructures', {
				autoLoad: true
			}),
			columnLines: true,
			rootVisible: false,
			hideHeaders: true,
			frame: true,
			margin: '5 5 5 0',
			flex: 1,
//			useArrows:true,
			viewConfig: {
				plugins: {
					ptype: 'treeviewdragdrop',
					dragGroup: 'facilitygroup1',
					dropGroup: 'facilitygroup1',
					expandDelay: 0,
					allowParentInsert: true,
					allowContainerDrops: true,
					onViewRender: function(view){
						var me = this,
							scrollEl;

						if(me.enableDrag){
							if(me.containerScroll){
								scrollEl = view.getEl();
							}
							me.dragZone = new Ext.tree.ViewDragZone({
								view: view,
								ddGroup: me.dragGroup || me.ddGroup,
								dragText: me.dragText,
								displayField: me.displayField,
								repairHighlightColor: me.nodeHighlightColor,
								repairHighlight: me.nodeHighlightOnRepair,
								scrollEl: scrollEl
							});
						}

						if(me.enableDrop){
							me.dropZone = new Ext.tree.ViewDropZone({
								view: view,
								ddGroup: me.dropGroup || me.ddGroup,
								allowContainerDrops: me.allowContainerDrops,
								appendOnly: me.appendOnly,
								allowParentInserts: me.allowParentInserts,
								expandDelay: me.expandDelay,
								dropHighlightColor: me.nodeHighlightColor,
								dropHighlight: me.nodeHighlightOnDrop,
								sortOnDrop: me.sortOnDrop,
								containerScroll: me.containerScroll,
								handleNodeDrop: function(data, targetNode, position){

									var me = this,
										targetView = me.view,
										parentNode = targetNode ? targetNode.parentNode : targetView.panel.getRootNode(),
										Model = targetView.getStore().treeStore.model,
										records, i, len, record,
										insertionMethod, argList,
										needTargetExpand,
										transferData,
										isDepartment = data.records[0] instanceof App.model.administration.Department,
										isSpecialty = data.records[0] instanceof App.model.administration.Specialty,
										workedRecords = [];

									if(isDepartment || isSpecialty){

										for(i = 0, len = data.records.length; i < len; i++){
											Ext.Array.push(workedRecords, new Model({
												id: '',
												fid: 1,
												foreign_id: data.records[i].data.id,
												foreign_type: isDepartment ? 'D' : 'S',
												text: data.records[i].data.title,
												active: false
											}));
										}
										data.records = workedRecords;

									}

									// If the copy flag is set, create a copy of the models
									if(data.copy){
										records = data.records;
										data.records = [];
										for(i = 0, len = records.length; i < len; i++){
											record = records[i];

											if(record.isNode){
												data.records.push(record.copy(undefined, true));
											}else{
												// If it's not a node, make a node copy
												data.records.push(new Model(record.data, record.getId()));
											}
										}
									}

									// Cancel any pending expand operation
									me.cancelExpand();

									// Grab a reference to the correct node insertion method.
									// Create an arg list array intended for the apply method of the
									// chosen node insertion method.
									// Ensure the target object for the method is referenced by 'targetNode'
									if(position == 'before'){
										insertionMethod = parentNode.insertBefore;
										argList = [null, targetNode];
										targetNode = parentNode;
									}
									else if(position == 'after'){
										if(targetNode.nextSibling){
											insertionMethod = parentNode.insertBefore;
											argList = [null, targetNode.nextSibling];
										}
										else{
											insertionMethod = parentNode.appendChild;
											argList = [null];
										}
										targetNode = parentNode;
									}
									else{
										if(!(targetNode.isExpanded() || targetNode.isLoading())){
											needTargetExpand = true;
										}
										insertionMethod = targetNode.appendChild;
										argList = [null];
									}

									// A function to transfer the data into the destination tree
									transferData = function(){
										var color,
											n;

										// Coalesce layouts caused by node removal, appending and sorting
										Ext.suspendLayouts();

										targetView.getSelectionModel().clearSelections();

										// Insert the records into the target node
										for(i = 0, len = data.records.length; i < len; i++){
											record = data.records[i];
											if(!record.isNode){
												if(record.isModel){
													record = new Model(record.data, record.getId());
												}else{
													record = new Model(record);
												}

											}

											record.save({
												callback: function(rec, operation){
													rec.set({'id': operation.response.result.id});
													rec.save();
												}
											});

											data.records[i] = record;

											argList[0] = record;
											insertionMethod.apply(targetNode, argList);
										}

										// If configured to sort on drop, do it according to the TreeStore's comparator
										if(me.sortOnDrop){
											targetNode.sort(targetNode.getOwnerTree().store.generateComparator());
										}

										Ext.resumeLayouts(true);

										// Kick off highlights after everything's been inserted, so they are
										// more in sync without insertion/render overhead.
										// Element.highlight can handle highlighting table nodes.
										if(Ext.enableFx && me.dropHighlight){
											color = me.dropHighlightColor;

											for(i = 0; i < len; i++){
												n = targetView.getNode(data.records[i]);
												if(n){
													Ext.fly(n).highlight(color);
												}
											}
										}
									};

									// If dropping right on an unexpanded node, transfer the data after it is expanded.
									if(needTargetExpand){
										targetNode.expand(false, transferData);
									}
									// If the node is waiting for its children, we must transfer the data after the expansion.
									// The expand event does NOT signal UI expansion, it is the SIGNAL for UI expansion.
									// It's listened for by the NodeStore on the root node. Which means that listeners on the target
									// node get notified BEFORE UI expansion. So we need a delay.
									// TODO: Refactor NodeInterface.expand/collapse to notify its owning tree directly when it needs to expand/collapse.
									else if(targetNode.isLoading()){
										targetNode.on({
											expand: transferData,
											delay: 1,
											single: true
										});
									}
									// Otherwise, call the data transfer function immediately
									else{
										transferData();
									}
								}
							})
						}
					}
				}
			},
			columns: [
				{
					xtype: 'treecolumn',
					text: 'Config',
					flex: 2,
					sortable: true,
					dataIndex: 'text'
				},
				{
					xtype: 'actioncolumn',
					width: 20,
					icon: 'resources/images/icons/delete.png',
					tooltip: _('delete'),
					handler: function(grid, rowIndex, colIndex, item, e, record){

						if(record.childNodes.length > 0){
							app.msg(_('oops'), _('please_remove_child_records_first'), true);
							return;
						}

						Ext.Msg.show({
							title: _('wait'),
							msg: _('delete_this_record'),
							buttons: Ext.Msg.YESNO,
							icon: Ext.Msg.QUESTION,
							fn: function(btn){
								if(btn == 'yes'){
									record.destroy();
								}

							}
						});
					},
					getClass: function(value, metadata, record){
						if(record.data.id[0] != 'f'){
							return 'x-grid-center-icon';
						}else{
							return 'x-hide-display';
						}
					}
				}
			]
		}
	]
});

Ext.define('App.store.administration.InsuranceCompanies', {
	extend: 'Ext.data.Store',
	model: 'App.model.administration.InsuranceCompany'
});
Ext.define('App.ux.form.fields.InputTextMask', {
    constructor: function(mask, clearWhenInvalid) {
        if(clearWhenInvalid === undefined)
            this.clearWhenInvalid = true;
        else
            this.clearWhenInvalid = clearWhenInvalid;
        this.rawMask = mask;
        this.viewMask = '';
        this.maskArray = new Array();
        var mai = 0;
        var regexp = '';
        for(var i=0; i<mask.length; i++){
            if(regexp){
                if(regexp == 'X'){
                    regexp = '';
                }
                if(mask.charAt(i) == 'X'){
                    this.maskArray[mai] = regexp;
                    mai++;
                    regexp = '';
                } else {
                    regexp += mask.charAt(i);
                }
            } else if(mask.charAt(i) == 'X'){
                regexp += 'X';
                this.viewMask += '_';
            } else if(mask.charAt(i) == '9' || mask.charAt(i) == 'L' || mask.charAt(i) == 'l' || mask.charAt(i) == 'A') {
                this.viewMask += '_';
                this.maskArray[mai] = mask.charAt(i);
                mai++;
            } else {
                this.viewMask += mask.charAt(i);
                this.maskArray[mai] = RegExp.escape(mask.charAt(i));
                mai++;
            }
        }

        this.specialChars = this.viewMask.replace(/(L|l|9|A|_|X)/g,'');
        return this;
    },

    init: function(field) {
        this.field = field;

        if (field.rendered){
            this.assignEl();
        } else {
            field.on('render', this.assignEl, this);
        }

        field.on('blur',this.removeValueWhenInvalid, this);
        field.on('focus',this.processMaskFocus, this);
    },

    assignEl: function() {
        this.inputTextElement = this.field.inputEl.dom;
        this.field.inputEl.on('keypress', this.processKeyPress, this);
        this.field.inputEl.on('keydown', this.processKeyDown, this);
        if(Ext.isSafari || Ext.isIE){
            this.field.inputEl.on('paste',this.startTask,this);
            this.field.inputEl.on('cut',this.startTask,this);
        }
        if(Ext.isGecko || Ext.isOpera){
            this.field.inputEl.on('mousedown',this.setPreviousValue,this);
        }
        if(Ext.isGecko){
            this.field.inputEl.on('input',this.onInput,this);
        }
        if(Ext.isOpera){
            this.field.inputEl.on('input',this.onInputOpera,this);
        }
    },
    onInput: function(){
        this.startTask(false);
    },
    onInputOpera: function(){
        if(!this.prevValueOpera){
            this.startTask(false);
        }else{
            this.manageBackspaceAndDeleteOpera();
        }
    },

    manageBackspaceAndDeleteOpera: function(){
        this.inputTextElement.value=this.prevValueOpera.cursorPos.previousValue;
        this.manageTheText(this.prevValueOpera.keycode,this.prevValueOpera.cursorPos);
        this.prevValueOpera=null;
    },

    setPreviousValue: function(event){
        this.oldCursorPos=this.getCursorPosition();
    },

    getValidatedKey: function(keycode, cursorPosition) {
        var maskKey = this.maskArray[cursorPosition.start];
        if(maskKey == '9'){
            return keycode.pressedKey.match(/[0-9]/);
        } else if(maskKey == 'L'){
            return (keycode.pressedKey.match(/[A-Za-z]/))? keycode.pressedKey.toUpperCase(): null;
        } else if(maskKey == 'l'){
            return (keycode.pressedKey.match(/[A-Za-z]/))? keycode.pressedKey.toLowerCase(): null;
        } else if(maskKey == 'A'){
            return keycode.pressedKey.match(/[A-Za-z0-9]/);
        } else if(maskKey){
            return (keycode.pressedKey.match(new RegExp(maskKey)));
        }
        return(null);
    },

    removeValueWhenInvalid: function() {
        if(this.clearWhenInvalid && this.inputTextElement.value.indexOf('_') > -1){
            this.inputTextElement.value = '';
        }
    },

    managePaste: function() {
        if(this.oldCursorPos==null){
            return;
        }
        var valuePasted=this.inputTextElement.value.substring(this.oldCursorPos.start,this.inputTextElement.value.length-(this.oldCursorPos.previousValue.length-this.oldCursorPos.end));
        if(this.oldCursorPos.start<this.oldCursorPos.end){
            this.oldCursorPos.previousValue =
                this.oldCursorPos.previousValue.substring(0,this.oldCursorPos.start)+
                this.viewMask.substring(this.oldCursorPos.start,this.oldCursorPos.end)+
                this.oldCursorPos.previousValue.substring(this.oldCursorPos.end,this.oldCursorPos.previousValue.length);
            valuePasted=valuePasted.substr(0,this.oldCursorPos.end-this.oldCursorPos.start);
        }
        this.inputTextElement.value=this.oldCursorPos.previousValue;
        keycode = {
            unicode: '',
            isShiftPressed: false,
            isTab: false,
            isBackspace: false,
            isLeftOrRightArrow: false,
            isDelete: false,
            pressedKey: ''
        }
        var charOk=false;
        for(var i=0;i<valuePasted.length;i++){
            keycode.pressedKey=valuePasted.substr(i,1);
            keycode.unicode=valuePasted.charCodeAt(i);
            this.oldCursorPos=this.skipMaskCharacters(keycode,this.oldCursorPos);
            if(this.oldCursorPos===false){
                break;
            }
            if(this.injectValue(keycode,this.oldCursorPos)){
                charOk=true;
                this.moveCursorToPosition(keycode, this.oldCursorPos);
                this.oldCursorPos.previousValue=this.inputTextElement.value;
                this.oldCursorPos.start=this.oldCursorPos.start+1;
            }
        }
        if(!charOk && this.oldCursorPos!==false){
            this.moveCursorToPosition(null, this.oldCursorPos);
        }
        this.oldCursorPos=null;
    },

    processKeyDown: function(e){
        this.processMaskFormatting(e,'keydown');
    },

    processKeyPress: function(e){
        this.processMaskFormatting(e,'keypress');
    },

    startTask: function(setOldCursor){
        if(this.task==undefined){
            this.task=new Ext.util.DelayedTask(this.managePaste,this);
        }
        if(setOldCursor!== false){
            this.oldCursorPos=this.getCursorPosition();
        }
        this.task.delay(0);
    },

    skipMaskCharacters: function(keycode, cursorPos){
        if(cursorPos.start!=cursorPos.end && (keycode.isDelete || keycode.isBackspace))
            return(cursorPos);
        while(this.specialChars.match(RegExp.escape(this.viewMask.charAt(((keycode.isBackspace)? cursorPos.start-1: cursorPos.start))))){
            if(keycode.isBackspace) {
                cursorPos.dec();
            } else {
                cursorPos.inc();
            }
            if(cursorPos.start >= cursorPos.previousValue.length || cursorPos.start < 0){
                return false;
            }
        }
        return(cursorPos);
    },

    isManagedByKeyDown: function(keycode){
        if(keycode.isDelete || keycode.isBackspace){
            return(true);
        }
        return(false);
    },

    processMaskFormatting: function(e, type) {
        this.oldCursorPos=null;
        var cursorPos = this.getCursorPosition();
        var keycode = this.getKeyCode(e, type);
        if(keycode.unicode==0){//?? sometimes on Safari
            return;
        }
        if((keycode.unicode==67 || keycode.unicode==99) && e.ctrlKey){//Ctrl+c, let's the browser manage it!
            return;
        }
        if((keycode.unicode==88 || keycode.unicode==120) && e.ctrlKey){//Ctrl+x, manage paste
            this.startTask();
            return;
        }
        if((keycode.unicode==86 || keycode.unicode==118) && e.ctrlKey){//Ctrl+v, manage paste....
            this.startTask();
            return;
        }
        if((keycode.isBackspace || keycode.isDelete) && Ext.isOpera){
            this.prevValueOpera={cursorPos: cursorPos, keycode: keycode};
            return;
        }
        if(type=='keydown' && !this.isManagedByKeyDown(keycode)){
            return true;
        }
        if(type=='keypress' && this.isManagedByKeyDown(keycode)){
            return true;
        }
        if(this.handleEventBubble(e, keycode, type)){
            return true;
        }
        return(this.manageTheText(keycode, cursorPos));
    },

    manageTheText: function(keycode, cursorPos){
        if(this.inputTextElement.value.length === 0){
            this.inputTextElement.value = this.viewMask;
        }
        cursorPos=this.skipMaskCharacters(keycode, cursorPos);
        if(cursorPos===false){
            return false;
        }
        if(this.injectValue(keycode, cursorPos)){
            this.moveCursorToPosition(keycode, cursorPos);
        }
        return(false);
    },

    processMaskFocus: function(){
        if(this.inputTextElement.value.length == 0){
            var cursorPos = this.getCursorPosition();
            this.inputTextElement.value = this.viewMask;
            this.moveCursorToPosition(null, cursorPos, 25);
        }
    },

    isManagedByBrowser: function(keyEvent, keycode, type){
        if(((type=='keypress' && keyEvent.charCode===0) ||
            type=='keydown') && (keycode.unicode==Ext.EventObject.TAB ||
            keycode.unicode==Ext.EventObject.RETURN ||
            keycode.unicode==Ext.EventObject.ENTER ||
            keycode.unicode==Ext.EventObject.SHIFT ||
            keycode.unicode==Ext.EventObject.CONTROL ||
            keycode.unicode==Ext.EventObject.ESC ||
            keycode.unicode==Ext.EventObject.PAGEUP ||
            keycode.unicode==Ext.EventObject.PAGEDOWN ||
            keycode.unicode==Ext.EventObject.END ||
            keycode.unicode==Ext.EventObject.HOME ||
            keycode.unicode==Ext.EventObject.LEFT ||
            keycode.unicode==Ext.EventObject.UP ||
            keycode.unicode==Ext.EventObject.RIGHT ||
            keycode.unicode==Ext.EventObject.DOWN)){
            return(true);
        }
        return(false);
    },

    handleEventBubble: function(keyEvent, keycode, type) {
        try {
            if(keycode && this.isManagedByBrowser(keyEvent, keycode, type)){
                return true;
            }
            keyEvent.stopEvent();
            return false;
        } catch(e) {
            alert(e.message);
        }
    },

    getCursorPosition: function() {
        var s, e, r;
        if(this.inputTextElement.createTextRange){
            r = document.selection.createRange().duplicate();
            r.moveEnd('character', this.inputTextElement.value.length);
            if(r.text === ''){
                s = this.inputTextElement.value.length;
            } else {
                s = this.inputTextElement.value.lastIndexOf(r.text);
            }
            r = document.selection.createRange().duplicate();
            r.moveStart('character', -this.inputTextElement.value.length);
            e = r.text.length;
        } else {
            s = this.inputTextElement.selectionStart;
            e = this.inputTextElement.selectionEnd;
        }
        return this.CursorPosition(s, e, r, this.inputTextElement.value);
    },

    moveCursorToPosition: function(keycode, cursorPosition, defer) {
        var p = (!keycode || (keycode && keycode.isBackspace ))? cursorPosition.start: cursorPosition.start + 1;
        if(this.inputTextElement.createTextRange){
            if(defer){
                Ext.Function.defer(function (){
                    cursorPosition.range.move('character', p);
                    cursorPosition.range.select();
                },defer, this);
            }else{
                cursorPosition.range.move('character', p);
                cursorPosition.range.select();
            }
        } else {
            if(defer){
                Ext.Function.defer(function (){
                    this.inputTextElement.selectionStart = p;
                    this.inputTextElement.selectionEnd = p;
                },defer, this);
            }else{
                this.inputTextElement.selectionStart = p;
                this.inputTextElement.selectionEnd = p;
            }
        }
    },

    injectValue: function(keycode, cursorPosition) {
        if (!keycode.isDelete && keycode.unicode == cursorPosition.previousValue.charCodeAt(cursorPosition.start))
            return true;
        var key;
        if(!keycode.isDelete && !keycode.isBackspace){
            key=this.getValidatedKey(keycode, cursorPosition);
        } else {
            if(cursorPosition.start == cursorPosition.end){
                key='_';
                if(keycode.isBackspace){
                    cursorPosition.dec();
                }
            } else {
                key=this.viewMask.substring(cursorPosition.start,cursorPosition.end);
            }
        }
        if(key){
            this.inputTextElement.value = cursorPosition.previousValue.substring(0,cursorPosition.start)
                + key +
                cursorPosition.previousValue.substring(cursorPosition.start + key.length,cursorPosition.previousValue.length);
            return true;
        }
        return false;
    },

    getKeyCode: function(onKeyDownEvent, type) {
        var keycode = {};
        keycode.unicode = onKeyDownEvent.getKey();
        keycode.isShiftPressed = onKeyDownEvent.shiftKey;

        keycode.isDelete = ((onKeyDownEvent.getKey() == Ext.EventObject.DELETE && type=='keydown') || ( type=='keypress' && onKeyDownEvent.charCode===0 && onKeyDownEvent.keyCode == Ext.EventObject.DELETE))? true: false;
        keycode.isTab = (onKeyDownEvent.getKey() == Ext.EventObject.TAB)? true: false;
        keycode.isBackspace = (onKeyDownEvent.getKey() == Ext.EventObject.BACKSPACE)? true: false;
        keycode.isLeftOrRightArrow = (onKeyDownEvent.getKey() == Ext.EventObject.LEFT || onKeyDownEvent.getKey() == Ext.EventObject.RIGHT)? true: false;
        keycode.pressedKey = String.fromCharCode(keycode.unicode);
        return(keycode);
    },

    CursorPosition: function(start, end, range, previousValue) {
        var cursorPosition = {};
        cursorPosition.start = isNaN(start)? 0: start;
        cursorPosition.end = isNaN(end)? 0: end;
        cursorPosition.range = range;
        cursorPosition.previousValue = previousValue;
        cursorPosition.inc = function(){cursorPosition.start++;cursorPosition.end++;};
        cursorPosition.dec = function(){cursorPosition.start--;cursorPosition.end--;};
        return(cursorPosition);
    }
});

Ext.applyIf(RegExp, {
    escape: function(str) {
        return new String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g, '\\$1');
    }
});
Ext.define('App.view.administration.practice.Insurance', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.combo.Titles',
		'App.ux.grid.RowFormEditing',
		'App.ux.combo.TransmitMethod',
		'App.ux.form.fields.InputTextMask'
	],
	xtype: 'insurancecompaniespanel',
	title: _('insurance_companies'),

	store: this._adminInsuranceCmonpanySotrie = Ext.create('App.store.administration.InsuranceCompanies',{
		remoteSort: false,
		remoteGroup: false,
		pageSize: 250
	}),

	//	border: false,
	//	frame: false,
	columnLines: true,
	plugins: [
		{
			ptype: 'rowformediting',
			autoCancel: false,
			errorSummary: false,
			items: [
				{
					xtype: 'container',
					layout: 'hbox',
					itemId: 'InsuranceCompanyFormContainer',
					items: [
						{
							xtype: 'fieldset',
							title: _('contact_info'),
							layout: 'hbox',
							margin: '0 10 0 0',
							items: [
								{
									xtype: 'container',
									margin: '0 10 0 0',
									layout: 'anchor',
									defaults: {
										margin: '0 10 5 0'
									},
									items: [
										{
											xtype: 'textfield',
											fieldLabel: _('code'),
											name: 'code',
											allowBlank: false
										},
										{
											xtype: 'textfield',
											fieldLabel: _('name'),
											name: 'name',
											allowBlank: false,
											width: 385
										},
										{
											xtype: 'textfield',
											fieldLabel: _('attn'),
											name: 'attn',
											width: 385
										},
										{
											xtype: 'textfield',
											fieldLabel: _('address'),
											name: 'address1',
											width: 385
										},
										{
											xtype: 'textfield',
											fieldLabel: _('address_cont'),
											name: 'address2',
											width: 385
										},
										{
											xtype: 'fieldcontainer',
											margin: '0 0 10 105',
											layout: 'hbox',
											items: [
												{
													xtype: 'textfield',
													width: 150,
													name: 'city'
												},
												{
													xtype: 'textfield',
													width: 50,
													name: 'state'
												},
												{
													xtype: 'textfield',
													width: 75,
													name: 'zip_code'
												}
											]
										}
									]
								},
								{
									xtype: 'container',
									width: 300,
									layout: 'anchor',
									defaults: {
										margin: '0 10 5 0'
									},
									items: [
										{
											xtype: 'textfield',
											fieldLabel: _('phone_number'),
											name: 'phone_number',
											plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')]
										},
										{
											xtype: 'textfield',
											fieldLabel: _('fax_number'),
											name: 'fax_number'
										},
										{
											xtype: 'checkbox',
											fieldLabel: _('active'),
											name: 'active'
										}
									]
								}
							]
						}
					]
				}
			]

		}
	],
	columns: [
		{
			width: 50,
			sortable: true,
			dataIndex: 'id'
		},
		{
			header: _('code'),
			width: 50,
			sortable: true,
			dataIndex: 'code'
		},
        {
			header: _('insurance_name'),
			width: 200,
			sortable: true,
			dataIndex: 'name'
		},
		{
			header: _('attn'),
			width: 200,
			sortable: true,
			dataIndex: 'attn'
		},
		{
			header: _('address'),
			flex: 1,
			sortable: true,
			dataIndex: 'address_full'
		},
		{
			header: _('phone'),
			width: 120,
			sortable: true,
			dataIndex: 'phone1'
		},
		{
			header: _('phone'),
			width: 120,
			sortable: true,
			dataIndex: 'phone2'
		},
		{
			header: _('fax'),
			width: 120,
			sortable: true,
			dataIndex: 'fax'
		},


		{
			header: _('active'),
			width: 55,
			sortable: true,
			dataIndex: 'active',
			renderer: function(v){
				return app.boolRenderer(v);
			}
		}
	],
	tbar: Ext.create('Ext.PagingToolbar', {
		pageSize: 30,
		store: this._adminInsuranceCmonpanySotrie,
		displayInfo: true,
		plugins: Ext.create('Ext.ux.SlidingPager', {
		}),
		items: [
			'-',
			{
				text: _('insurance_company'),
				iconCls: 'icoAdd',
				action: 'insurance',
				itemId: 'addBtn'
			}]

	})
});

Ext.define('App.store.administration.Laboratories', {
    model: 'App.model.administration.Laboratories',
    extend: 'Ext.data.Store',
    proxy:{
        type:'direct',
        api:{
            read:Practice.getLaboratories,
            create:Practice.addLaboratory,
            update:Practice.updateLaboratory
        }
    }
});
Ext.define('App.view.administration.practice.Laboratories', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.combo.Titles',
		'App.ux.grid.RowFormEditing',
		'App.ux.combo.TransmitMethod'
	],
	xtype: 'laboratoriespanel',
	title: _('laboratories'),
	store: Ext.create('App.store.administration.Laboratories'),
	border: false,
	frame: false,
	columnLines: true,
	plugins: [
		{
			ptype: 'rowformediting',
			autoCancel: false,
			errorSummary: false,
			clicksToEdit: 1,
			items: [
				{
					xtype: 'container',
					layout: 'hbox',
					width: 900,
					items: [
						{
							xtype: 'container',
							width: 450,
							layout: 'anchor',
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('name'),
									name: 'name',
									allowBlank: false,
									width: 385
								},
								{
									xtype: 'textfield',
									fieldLabel: _('address'),
									name: 'line1',
									width: 385
								},
								{
									xtype: 'textfield',
									fieldLabel: _('address_cont'),
									name: 'line2',
									width: 385
								},
								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 105,
											value: _('city_state_zip')
										},
										{
											xtype: 'textfield',
											width: 150,
											name: 'city'
										},
										{
											xtype: 'displayfield',
											width: 5,
											value: ','
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'state'
										},
										{
											xtype: 'textfield',
											width: 75,
											name: 'zip'
										}
									]
								}
							]
						},
						{
							xtype: 'container',
							width: 300,
							layout: 'anchor',
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('email'),
									name: 'email',
									width: 275
								},
								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 100,
											value: _('phone')
										},
										{
											xtype: 'textfield',
											width: 40,
											name: 'phone_area_code'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'phone_prefix'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 70,
											name: 'phone_number'
										}
									]
								},
								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 100,
											value: _('fax')
										},
										{
											xtype: 'textfield',
											width: 40,
											name: 'fax_area_code'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'fax_prefix'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 70,
											name: 'fax_number'
										}
									]
								},
								{
									xtype: 'transmitmethodcombo',
									fieldLabel: _('default_method'),
									labelWidth: 100,
									width: 275
								}
							]
						},
						{
							xtype: 'checkbox',
							fieldLabel: _('active'),
							labelWidth: 60,
							name: 'active'
						}
					]
				}
			]
		}
	],
	columns: [
		{
			header: _('pharmacy_name'),
			width: 150,
			sortable: true,
			dataIndex: 'name'
		},
		{
			header: _('address'),
			flex: 1,
			sortable: true,
			dataIndex: 'address_full'
		},
		{
			header: _('phone'),
			width: 120,
			sortable: true,
			dataIndex: 'phone_full'
		},
		{
			header: _('fax'),
			width: 120,
			sortable: true,
			dataIndex: 'fax_full'
		},
		{
			header: _('default_method'),
			flex: 1,
			sortable: true,
			dataIndex: 'transmit_method',
			renderer: function (val){
				if(val == '1'){
					return 'Print';
				}else if(val == '2'){
					return 'Email';
				}else if(val == '3'){
					return 'Email';
				}
				return val;
			}
		},
		{
			header: _('active'),
			width: 55,
			sortable: true,
			dataIndex: 'active',
			renderer: function(v){
				return app.boolRenderer(v);
			}
		}
	],
	tbar: [
		'->',
		{
			text: _('laboratory'),
			iconCls: 'icoAdd',
			action: 'laboratory',
			itemId: 'addBtn'
		}
	]
});

Ext.define('App.store.administration.Pharmacies', {
	model: 'App.model.administration.Pharmacies',
	extend: 'Ext.data.Store'
});

Ext.define('App.view.administration.practice.Pharmacies', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.combo.Titles',
		'App.ux.grid.RowFormEditing',
		'App.ux.combo.TransmitMethod'
	],
	xtype: 'pharmaciespanel',
	title: _('pharmacies'),
	store: Ext.create('App.store.administration.Pharmacies'),
	border: false,
	frame: false,
	columnLines: true,
	plugins: [
		{
			ptype: 'rowformediting',
			autoCancel: false,
			errorSummary: false,
			clicksToEdit: 1,
			items: [
				{
					xtype: 'container',
					layout: 'hbox',
					items: [
						{
							xtype: 'container',
							width: 400,
							layout: 'anchor',
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('name'),
									name: 'name',
									allowBlank: true,
									width: 385
								},
								{
									xtype: 'textfield',
									fieldLabel: _('address'),
									name: 'line1',
									width: 385
								},
								{
									xtype: 'textfield',
									fieldLabel: _('address_cont'),
									name: 'line2',
									width: 385
								},
								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 105,
											value: _('city_state_zip')
										},
										{
											xtype: 'textfield',
											width: 150,
											name: 'city'
										},
										{
											xtype: 'displayfield',
											width: 5,
											value: ','
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'state'
										},
										{
											xtype: 'textfield',
											width: 75,
											name: 'zip'
										}
									]
								}
							]
						},
						{
							xtype: 'container',
							width: 300,
							layout: 'anchor',
							items: [

								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 100,
											value: _('phone')
										},
                                        {
                                            xtype: 'textfield',
                                            width: 20,
                                            name: 'phone_country_code',
                                            maxLength: 2
                                        },
										{
											xtype: 'textfield',
											width: 40,
											name: 'phone_area_code'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 40,
											name: 'phone_prefix'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'phone_number'
										}
									]
								},
								{
									xtype: 'fieldcontainer',
									layout: 'hbox',
									defaults: {
										hideLabel: true
									},
									items: [
										{
											xtype: 'displayfield',
											width: 100,
											value: _('fax')
										},
                                        {
                                            xtype: 'textfield',
                                            width: 20,
                                            name: 'fax_country_code',
                                            maxLength: 2
                                        },
										{
											xtype: 'textfield',
											width: 40,
											name: 'fax_area_code'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 40,
											name: 'fax_prefix'
										},
										{
											xtype: 'displayfield',
											width: 10,
											value: '-'
										},
										{
											xtype: 'textfield',
											width: 50,
											name: 'fax_number'
										}
									]
								},
								{
									xtype: 'textfield',
									fieldLabel: _('email'),
									name: 'email',
									width: 385
								},
								{
									xtype: 'transmitmethodcombo',
									fieldLabel: _('default_method'),
									labelWidth: 100,
									width: 275
								}
							]
						},
						{
							xtype: 'checkbox',
							fieldLabel: _('active'),
							labelWidth: 60,
							margin: '0 0 0 10',
							name: 'active'
						}

					]
				}
			]
		}
	],
	columns: [
		{
			header: _('pharmacy_name'),
			width: 150,
			sortable: true,
			dataIndex: 'name'
		},
		{
			header: _('address'),
			flex: 1,
			sortable: true,
			dataIndex: 'address_full'
		},
		{
			header: _('phone'),
			width: 120,
			sortable: true,
			dataIndex: 'phone_full'
		},
		{
			header: _('fax'),
			width: 120,
			sortable: true,
			dataIndex: 'fax_full'
		},
		{
			header: _('default_method'),
			flex: 1,
			sortable: true,
			dataIndex: 'transmit_method',
			renderer: function (val){
				if(val == '1'){
					return 'Print';
				}else if(val == '2'){
					return 'Email';
				}else if(val == '3'){
					return 'Email';
				}
				return val;
			}
		},
		{
			header: _('active'),
			width: 55,
			sortable: true,
			dataIndex: 'active',
			renderer: function(v){
				return app.boolRenderer(v);
			}
		}
	],
	tbar: [
		'->',
		{
			text: _('pharmacy'),
			iconCls: 'icoAdd',
			action: 'pharmacy',
			itemId: 'addBtn'
		}
	]
});

Ext.define('App.view.administration.practice.ProviderNumbers', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.combo.Titles',
		'App.ux.grid.RowFormEditing',
		'App.ux.combo.TransmitMethod'
	],
	xtype: 'providersnumberspanel',
	title: _('provider_numbers'),
	//store: Ext.create('App.store.administration.InsuranceNumbers'),
	border: false,
	frame: false,
	columnLines: true,
	features: [
		{
			ftype: 'grouping',
			groupHeaderTpl: '{name}'
		}
	],
	plugins: [
		{
			ptype: 'rowformediting',
			autoCancel: false,
			errorSummary: false,
			clicksToEdit: 1,
			items: [
				{
					xtype: 'container',
					layout: 'column',
					items: [
						{
							xtype: 'container',
							defaults:{
								labelWidth: 140
							},
							margin: '0 10 0 0',
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('provider'),
									name: 'provider_id'
								},
								{
									xtype: 'textfield',
									fieldLabel: _('provider_number'),
									name: 'provider_number'
								},
								{
									xtype: 'textfield',
									fieldLabel: _('provider_number_type'),
									name: 'provider_number_type'
								}
							]
						},
						{
							xtype: 'container',
							defaults:{
								labelWidth: 140
							},
							margin: '0 10 0 0',
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('insurance_company'),
									name: 'insurance_company_id'
								},
								{
									xtype: 'textfield',
									fieldLabel: _('rendering_number'),
									name: 'rendering_provider_number'
								},
								{
									xtype: 'textfield',
									fieldLabel: _('rendering_number_type'),
									name: 'rendering_provider_number_type'
								}
							]
						},
						{
							xtype: 'container',
							defaults:{
								labelWidth: 140
							},
							items: [
								{
									xtype: 'textfield',
									fieldLabel: _('group_number'),
									name: 'group_number'
								}
							]
						}
					]
				}
			]
		}
	],
	columns: [
		{
			text: _('provider'),
			flex: 1,
			sortable: true,
			dataIndex: 'provider_id_text'
		},
		{
			text: _('insurance'),
			flex: 1,
			sortable: true,
			dataIndex: 'insurance_company_id_text'
		},
		{
			text: _('provider_number'),
			flex: 1,
			sortable: true,
			dataIndex: 'provider_number'
		},
		{
			text: _('rendering_number'),
			flex: 1,
			sortable: true,
			dataIndex: 'rendering_number'
		},
		{
			text: _('group_number'),
			flex: 1,
			sortable: true,
			dataIndex: 'phone'
		}
	],
	tbar: [
		_('group_by'),
		{
			text: _('provider'),
			enableToggle: true,
			toggleGroup: 'insurance_number_group',
			action: 'provider_id_text'
		},
		{
			text: _('insurance'),
			enableToggle: true,
			toggleGroup: 'insurance_number_group',
			action: 'insurance_company_id_text'
		},
		'-',
		'->',
		{
			text: _('insurance_number'),
			iconCls: 'icoAdd',
			action: 'insurance',
			itemId: 'addBtn'
		}
	]
});

Ext.define('App.view.administration.practice.Specialties', {
	extend: 'Ext.grid.Panel',
	xtype: 'specialtiespanel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'Ext.ux.SlidingPager'
	],
	title: _('specialties'),

	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			store: me.store = Ext.create('App.store.administration.Specialties', {
				autoSync: false
			}),
			columns: [
                {
                    text: _('id'),
                    sortable: true,
                    dataIndex: 'id',
					width: 50
                },
                {
                    text: _('code'),
                    sortable: true,
                    dataIndex: 'code',
                    flex: 1,
                    editor: {
                        xtype: 'textfield'
                    }
                },
                {
                    text: _('external_id'),
                    sortable: true,
                    dataIndex: 'external_id',
                    editor: {
                        xtype: 'textfield'
                    }
                },
				{
					width: 200,
					text: _('title'),
					dataIndex: 'title',
					sortable: true,
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('taxonomy'),
					sortable: true,
					dataIndex: 'taxonomy',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('modality'),
					sortable: true,
					dataIndex: 'modality',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
                {
                    text: _('isFda'),
                    sortable: true,
                    dataIndex: 'isFda',
                    flex: 1,
                    editor: {
                        xtype: 'textfield'
                    }
                },
				{
					text: _('active'),
					sortable: true,
					dataIndex: 'active',
					renderer: me.boolRenderer,
					editor: {
						xtype: 'checkboxfield'
					}
				}
			],
			plugins: [
				{
					ptype: 'rowediting',
					clicksToEdit: 1
				}
			],
			tbar: [
				'->',
				{
					xtype: 'button',
					text: _('specialty'),
					iconCls: 'icoAdd',
					itemId: 'SpecialitiesAddBtn'
				}
			],
			bbar: Ext.create('Ext.PagingToolbar', {
				pageSize: 10,
				store: me.store,
				displayInfo: true,
				plugins: Ext.create('Ext.ux.SlidingPager', {})
			})
		});

		me.callParent(arguments);

	}

});

Ext.define('App.view.administration.Applications', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('applications'),

    initComponent: function(){
        var me = this;

        // *************************************************************************************
        // Application Store
        // *************************************************************************************
        me.store = Ext.create('App.store.administration.Applications');

        // *************************************************************************************
        // Application Grid Panel
        // *************************************************************************************
        me.grid = Ext.create('Ext.grid.Panel', {
            store: me.store,
            plugins: [
                me.edditing = Ext.create('Ext.grid.plugin.RowEditing', {
                    clicksToEdit: 2,
                    errorSummary : false
                })
            ],
            columns: [
                {
                    xtype:'actioncolumn',
                    width:20,
                    items: [
                        {
                            icon: 'resources/images/icons/cross.png',  // Use a URL in the icon config
                            tooltip: 'Remove',
                            scope:me,
                            handler: me.removeApplication
                        }
                    ]

                },
                {
                    text: _('name'),
                    flex: 1,
                    sortable: true,
                    dataIndex: 'app_name',
                    editor:{
                        xtype:'textfield',
                        allowBlank:false
                    }
                },
                {
                    text: _('private_key'),
                    flex: 1,
                    sortable: true,
                    dataIndex: 'pvt_key'
                },
                {
                    text: _('active?'),
                    width: 50,
                    sortable: true,
                    renderer: me.boolRenderer,
                    dataIndex: 'active',
                    editor:{
                        xtype:'checkbox'
                    }
                }
            ],
            tbar:[
                {
                    text:_('add'),
                    iconCls:'icoAdd',
                    scope:me,
                    handler:me.addApplication
                }
            ]
        });
        me.pageBody = [me.grid];
        me.callParent(arguments);
    },

    removeApplication:function(grid, rowIndex, colIndex){
        var me = this,
            record = me.store.getAt(rowIndex);
        Ext.Msg.show({
            title:'Wait!',
            msg: 'This action is final. Are you sure you want to remove <span style="font-weight: bold">"'+record.data.app_name+'"</span>?',
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.WARNING,
            fn:function(btn){
                if(btn == 'yes'){
                    me.edditing.cancelEdit();
                    me.store.remove(record);
                    me.store.sync({
                        callback:function(){
                            me.msg(_('sweet'), _('record_removed'))
                        }
                    });
                }
            }
        });
    },

    addApplication:function(){
        var me = this;
        me.edditing.cancelEdit();
        me.store.insert(0,{active:1});
        me.edditing.startEdit(0,0);
    },

    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function(callback){
        this.store.load();
        callback(true);
    }
});

Ext.define('App.view.administration.IpAccess', {
    extend: 'App.ux.RenderPanel',
    requires: [
        'Ext.grid.plugin.RowEditing'
    ],
    xtype: 'ipaccesspanel',
    itemId: 'IpAccessPanel',
    border: false,
    pageLayout: {
        type: 'vbox',
        align: 'stretch'
    },
    pageTitle: _('network_ip_access'),
    initComponent: function() {
        var me = this;

        me.IpAccessRulesStore = Ext.create('App.store.administration.IpAccessRules', {
            remoteFilter: false,
            autoLoad: false,
            autoSync: false
        });

        me.IpAccessLogStore = Ext.create('App.store.administration.IpAccessLog', {
            remoteFilter: true,
            autoLoad: false,
            autoSync: false
        });

        me.RuleStore = Ext.create('Ext.data.Store',{
            fields: [
                { name: 'id', type: 'string' },
                { name: 'ruleName', type: 'string' }
            ],
            data : [
                { id: 'WHT', ruleName: 'Allow' },
                { id: 'BLK', ruleName: 'Block' }
            ]
        });

        me.pageBody = [
            {
                xtype: 'grid',
                flex: 1,
                frame: true,
                title: _('network_rules'),
                itemId: 'IpAccessRulesGrid',
                columnLines: true,
                store: me.IpAccessRulesStore,
                selType: 'rowmodel',
                plugins: {
                    ptype: 'rowediting',
                    clicksToEdit: 2
                },
                columns: [
                    {
                        text: _('ip') + ' (CIDR)',
                        dataIndex: 'ip',
                        width: 150,
                        editor: {
                            xtype: 'textfield',
                            vtype: 'ipcidr',
                            allowBlank: false,
	                        enableKeyEvents: true,
                            itemId: 'IpAccessRulesIpField'
                        }
                    },
                    {
                        text: _('range'),
                        columns: [
	                        {
		                        text: _('from'),
		                        dataIndex: 'ip_from',
		                        width: 150,
		                        renderer: function (v) {
                                    return app.getController('administration.IpAccess').long2ip(v);
		                        }

                            },
	                        {
		                        text: _('to'),
		                        dataIndex: 'ip_to',
		                        width: 150,
		                        renderer: function (v) {
                                    return app.getController('administration.IpAccess').long2ip(v);
		                        }
	                        }
                        ]
                    },
                    {
                        text: _('country_name'),
                        dataIndex: 'country',
                        align: 'center',
                        width: 300
                    },
                    {
                        text: _('rule'),
                        dataIndex: 'rule',
                        align: 'center',
                        editor: {
                            xtype: 'combo',
                            allowBlank: false,
                            store: me.RuleStore,
                            queryMode: 'local',
                            displayField: 'ruleName',
                            valueField: 'id'
                        }
                    },
                    {
                        text: _('active'),
                        dataIndex: 'active',
                        renderer: me.boolRenderer,
                        align: 'center',
                        editor: {
                            xtype: 'checkboxfield'
                        }
                    }
                ],
                tbar: [
                    '->',
                    '-',
                    {
                        xtype: 'button',
                        text: _('add_new_ip_rule'),
                        itemId: 'addIpRule'
                    },
                    '-',
                    {
                        xtype: 'button',
                        text: _('delete_ip_rule'),
                        disabled: true,
                        itemId: 'deleteIpRule'
                    }
                ],
	            bbar: {
		            xtype: 'pagingtoolbar',
		            store: me.IpAccessRulesStore,
		            dock: 'bottom',
		            displayInfo: true
	            }
            },
            {
                xtype: 'grid',
                flex: 1,
                frame: true,
                title: _('network_log'),
                itemId: 'IpAccessLogGrid',
                columnLines: true,
                store: me.IpAccessLogStore,
                columns: [
                    {
                        text: _('ip'),
                        dataIndex: 'ip',
                        width: 400
                    },
                    {
                        text: _('country_code'),
                        dataIndex: 'country_code'
                    },
                    {
                        text: _('event'),
                        dataIndex: 'event'
                    },
                    {
                        xtype: 'datecolumn',
                        text: _('date'),
                        dataIndex: 'create_date',
                        format: 'Y-m-d H:i:s',
                        width: 150
                    }
                ],
                dockedItems: [{
                    xtype: 'pagingtoolbar',
                    store: me.IpAccessLogStore,
                    dock: 'bottom',
                    displayInfo: true
                }]
            }
        ];

        me.callParent(arguments);

    }

});

Ext.define('App.view.administration.Medications',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelMedications',
	pageTitle : _('medications'),

	initComponent : function()
	{
		var me = this;
		me.query = '';

		me.storeMedications = Ext.create('App.store.administration.Medications');
		me.medicationsGrid = Ext.create('Ext.grid.Panel',
		{
			region : 'center',
			store : me.storeMedications,
			columns : [
			{
				width : 70,
				header : _('number'),
				dataIndex : 'PRODUCTNDC',
				sortable : true
			},
			{
				width : 80,
				header : _('name'),
				dataIndex : 'PROPRIETARYNAME',
				sortable : true
			},
			{
				width : 200,
				header : _('active_component'),
				dataIndex : 'NONPROPRIETARYNAME',
				sortable : true
			},
			{
				width : 175,
				header : _('dosage'),
				dataIndex : 'DOSAGEFORMNAME',
				sortable : true
			},
			{
				width : 45,
				header : _('number'),
				dataIndex : 'ACTIVE_NUMERATOR_STRENGTH',
				sortable : true
			},
			{
				flex : 1,
				header : _('unit'),
				dataIndex : 'ACTIVE_INGRED_UNIT',
				sortable : true
			}],
			plugins : Ext.create('App.ux.grid.RowFormEditing',
			{
				autoCancel : false,
				errorSummary : false,
				clicksToEdit : 1,
				enableRemove : true,
				items : [
				{

					title : 'general',
					xtype : 'container',
					padding : 10,
					layout : 'vbox',
					items : [
					{
						/**
						 * Line one
						 */
						xtype : 'fieldcontainer',
						layout : 'hbox',
						defaults :
						{
							margin : '0 10 5 0'
						},
						items : [
						{
							xtype : 'textfield',
							fieldLabel : _('name'),
							width : 150,
							labelWidth : 50,
							name : 'PROPRIETARYNAME'

						},
						{
							xtype : 'textfield',
							fieldLabel : _('active_component'),
							width : 350,
							labelWidth : 125,
							name : 'NONPROPRIETARYNAME'

						},
						{
							xtype : 'textfield',
							fieldLabel : _('dosage'),
							width : 200,
							labelWidth : 50,
							name : 'DOSAGEFORMNAME'
						}]
					},
					{
						/**
						 * Line two
						 */
						xtype : 'fieldcontainer',
						layout : 'hbox',
						defaults :
						{
							margin : '0 10 5 0'
						},
						items : [
						{
							xtype : 'textfield',
							fieldLabel : _('code'),
							labelWidth : 50,
							width : 150,
							name : 'PRODUCTNDC'

						},
						{
							xtype : 'textfield',
							fieldLabel : _('dose'),
							margin : '0 0 5 0',
							value : 0,
							minValue : 0,
							width : 275,
							labelWidth : 125,
							name : 'ACTIVE_NUMERATOR_STRENGTH'

						},
						{
							xtype : 'textfield',
							name : 'ACTIVE_INGRED_UNIT',
							width : 75

						}]

					}]

				}]

			}),
			tbar : Ext.create('Ext.PagingToolbar',
			{
				store : me.storeMedications,
				displayInfo : true,
				emptyMsg : _('no_office_notes_to_display'),
				plugins : Ext.create('Ext.ux.SlidingPager'),
				items : ['-',
                    {
                        text : 'Add New',
                        scope : me,
                        handler : me.onAddMedication
                    },
                    '-',
                    {
                        xtype : 'textfield',
                        emptyText : _('search'),
                        enableKeyEvents : true,
                        itemId : 'query',
                        listeners :
                        {
                            scope : me,
                            keyup : me.onSearchMedications,
                            buffer : 500
                        }
                    },
                    '-',
                    {
                        text : _('reset'),
                        scope : me,
                        handler : me.onFieldReset
                    },
                    {
                        text: 'Print',
                        iconCls: 'icon-print',
                        handler : function(){
                            //App.ux.grid.Printer.printAutomatically = false;
                            //App.ux.grid.Printer.print(this.up('grid'));
                        }
                    }
                ]
			})

		});
		me.pageBody = [me.medicationsGrid];
		me.callParent(arguments);
	}, // end of initComponent

	onFieldReset : function()
	{

	},

	onAddMedication : function()
	{
		this.medicationsGrid.editingPlugin.cancelEdit();

		this.storeMedications.insert(0,
		{
		});
		this.medicationsGrid.editingPlugin.startEdit(0, 0);

	},

	onSearchMedications : function(field)
	{
		var me = this, store = me.storeMedications;

		me.query = field.getValue();

		store.proxy.extraParams =
		{
			query : me.query
		};
		store.load();
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function()
	{
		this.medicationsGrid.down('toolbar').getComponent('query').reset();
		this.storeMedications.proxy.extraParams =
		{
		};
		this.storeMedications.load();

	}
});
//ens servicesPage class

Ext.define('App.view.administration.Globals', {
	extend: 'App.ux.RenderPanel',
	id: 'panelGlobals',
	pageTitle: 'mdTimeLine EHR ' + _('global_settings'),
	uses: ['App.ux.form.fields.Checkbox'],
	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.administration.Globals',{
			groupField: 'gl_category',
			remoteSort: false,
			autoSync: true,
			pageSize: 500,
			sorters: [
				{
					sorterFn: function(o1, o2){

						var getCat = function(o){
								var name = o.get('gl_category');
								if (name === 'General') {
									return 1;
								} else if (name === 'Locale') {
									return 2;
								} else if (name === 'Clinical') {
									return 3;
								} else if (name === 'Email') {
									return 4;
								} else if (name === 'Audit') {
									return 5;
								} else if (name === 'Fax/Scanner') {
									return 6;
								} else {
									return 7;
								}
							},
							cat1 = getCat(o1),
							cat2 = getCat(o2);

						if (cat1 === cat2) return 0;

						return cat1 < cat2 ? -1 : 1;
					}
				}
			]
		});

		//region Store Region
		me.default_top_pane_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('dashboard'),
					"option_id": "app/dashboard/dashboard.ejs.php"
				},
				{
					"title": _('calendar'),
					"option_id": "app/calendar/calendar.ejs.php"
				},
				{
					"title": _('messages'),
					"option_id": "app/messages/messages.ejs.php"
				}
			]
		});
		me.fullname_store = Ext.create('Ext.data.Store', {
			fields: ['format', 'option_id'],
			data: [
				{
					"format": _('last_first_middle'),
					"option_id": "0"
				},
				{
					"format": _('first_middle_last'),
					"option_id": "1"
				}
			]
		});
		me.main_navigation_menu_left_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('main_navigation_menu_left'),
					"option_id": "west"
				},
				{
					"title": _('main_navigation_menu_right'),
					"option_id": "east"
				}
			]
		});
		me.css_header_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('grey_default'),
					"option_id": "ext-all-gray.css"
				},
				{
					"title": _('blue'),
					"option_id": "ext-all.css"
				},
				{
					"title": _('access'),
					"option_id": "ext-all-access.css"
				}
			]
		});
		me.full_new_patient_form_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('oldstyle_static_form_without_search_or_duplication_check'),
					"option_id": "0"
				},
				{
					"title": _('all_demographics_fields_with_search_and_duplication_check'),
					"option_id": "1"
				},
				{
					"title": _('mandatory_or_specified_fields_only_search_and_dup_check'),
					"option_id": "2"
				},
				{
					"title": _('mandatory_or_specified_fields_only_dup_check_no_search'),
					"option_id": "3"
				}
			]
		});
		me.patient_search_results_style_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('encounter_statistics'),
					"option_id": "0"
				},
				{
					"title": _('mandatory_and_specified_fields'),
					"option_id": "1"
				}
			]
		});
		me.units_of_measurement_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('show_both_us_and_metric_main_unit_is_us'),
					"option_id": "1"
				},
				{
					"title": _('show_both_us_and_metric_main_unit_is_metric'),
					"option_id": "2"
				},
				{
					"title": _('show_us_only'),
					"option_id": "3"
				},
				{
					"title": _('show_metric_only'),
					"option_id": "4"
				}
			]
		});
		me.date_display_format_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('yyyy_mm_dd'),
					"option_id": "Y-m-d"
				},
				{
					"title": _('mm_dd_yyyy'),
					"option_id": "m/d/Y"
				},
				{
					"title": _('dd_mm_yyyy'),
					"option_id": "d/m/Y"
				}
			]
		});
		me.time_display_format_store = Ext.create('Ext.data.Store',	{
				fields: ['title', 'option_id'],
				data: [
					{
						"title": _('24_hr'),
						"option_id": "H:i"
					},
					{
						"title": i18n['12 hr'],
						"option_id": "g:i a"
					}
				]
			});
		me.currency_decimals_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('0'),
					"option_id": "0"
				},
				{
					"title": _('1'),
					"option_id": "1"
				},
				{
					"title": _('2'),
					"option_id": "2"
				}
			]
		});
		me.currency_dec_point_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('comma'),
					"option_id": ","
				},
				{
					"title": _('period'),
					"option_id": "."
				}
			]
		});
		me.currency_thousands_sep_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('comma'),
					"option_id": ","
				},
				{
					"title": _('period'),
					"option_id": "."
				},
				{
					"title": _('space'),
					"option_id": " "
				},
				{
					"title": _('none'),
					"option_id": ""
				}
			]
		});
		me.EMAIL_METHOD_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": "PHPMAIL",
					"option_id": "PHPMAIL"
				},
				{
					"title": "SENDMAIL",
					"option_id": "SENDMAIL"
				},
				{
					"title": "SMTP",
					"option_id": "SMTP"
				}
			]
		});
		me.state_country_data_type_store = Ext.create('Ext.data.Store', {
			fields: ['title', 'option_id'],
			data: [
				{
					"title": _('text_field'),
					"option_id": "2"
				},
				{
					"title": _('single_selection_list'),
					"option_id": "1"
				},
				{
					"title": _('single_selection_list_with_ability_to_add_to_the_list'),
					"option_id": "26"
				}
			]
		});
		me.dummyStore = new Ext.data.ArrayStore({
			fields: ['title', 'option_id'],
			data: [
				[_('option_1'), 'Option 1'],
				[_('option_2'), 'Option 2'],
				[_('option_3'), 'Option 3'],
				[_('option_5'), 'Option 5'],
				[_('option_6'), 'Option 6'],
				[_('option_7'), 'Option 7']
			]
		});

		me.grid = Ext.create('App.ux.grid.LiveSearchGridPanel',{
			store: me.store,
			features: [
				{
					ftype:'grouping',
					groupHeaderTpl: _('category') + ': {name}'
				}
			],
			plugins:[
				{
					ptype:'cellediting'
				}
			],
			columns:[
				{
					text:_('title'),
					dataIndex:'gl_name',
					flex:1
				},
				{
					text:_('value'),
					dataIndex:'gl_value',
					flex:1,
					editor:{
						xtype:'textfield'
					}
				},
				{
					text:_('category'),
					dataIndex:'gl_category'
				}
			]
		});
		me.pageBody = [ me.grid ];
		me.callParent(arguments);
	},

	/**
	 *
	 * @param form
	 * @param store
	 */
	onGloblasSave: function(form, store){
		var record = form.getRecord(), values = form.getValues();
		Globals.updateGlobals(values, function(){
			store.load();
		});

		this.msg(_('new_global_configuration_saved'), _('refresh_the_application'));
	},
	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		this.store.load();
		callback(true);
	}
});


Ext.define('App.view.administration.Lists', {
    extend: 'App.ux.RenderPanel',
    id: 'panelLists',
    pageTitle: _('select_list_options'),
    pageLayout: 'border',
    uses: [
        'App.ux.form.Panel',
        'Ext.grid.plugin.RowEditing'
    ],
    initComponent: function(){
        var me = this;


        /**
         * Store
         */
        me.listsStore = Ext.create('App.store.administration.Lists');
        me.optionsStore = Ext.create('App.store.administration.ListOptions',{
	        remoteFilter:true
        });

        /**
         * RowEditor Classes
         */
        me.optionsRowEditing = Ext.create('Ext.grid.plugin.RowEditing', {});

	    me.listsRowEditing = Ext.create('Ext.grid.plugin.RowEditing', {});

        /**
         * Lists Grid
         */
        me.listsGrid = Ext.create('Ext.grid.Panel', {
            store: me.listsStore,
            itemId: 'listsGrid',
            plugins: [ me.listsRowEditing ],
            width: 450,
            margin: '0 2 0 0',
            region: 'west',
            columns: [
                {
                    text: _('key'),
	                width: 120,
                    dataIndex: 'list_key',
                    editor: {
                        xtype:'textfield',
                        allowOnlyWhitespace: false,
                        allowBlank: false
                    }
                },
                {
                    text: _('select_lists'),
                    flex: 1,
                    sortable: false,
                    dataIndex: 'title',
                    editor: {
	                    xtype:'textfield',
                        allowBlank: false
                    }
                },
                {
                    text: _('active'),
                    width: 55,
                    sortable: false,
                    dataIndex: 'active',
                    renderer: me.boolRenderer,
                    editor: {
                        xtype: 'checkbox',
                        padding: '0 0 0 18'
                    }
                },
                // {
                //     text: _('in_use'),
                //     width: 55,
                //     sortable: false,
                //     dataIndex: 'in_use',
                //     renderer: me.boolRenderer
                // }
            ],
            listeners: {
                scope: me,
                select: me.onListsGridClick
            },
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'top',
                    items: [
                        {
                            text: _('new_list'),
                            iconCls: 'icoAddRecord',
                            scope: me,
                            handler: me.onNewList
                        },
                        '->',
                        {
                            text: _('delete_list'),
                            iconCls: 'icoDeleteBlack',
                            itemId: 'listDeleteBtn',
                            disabled: true,
                            scope: me,
                            handler: me.onListDelete,
                            tooltip: _('can_be_disable')
                        }
                    ]
                }
            ]
        });

        /**
         * Options Grid
         */
        me.optionsGrid = Ext.create('Ext.grid.Panel', {
            store: me.optionsStore,
            itemId: 'optionsGrid',
            plugins: [me.optionsRowEditing],
            region: 'center',
            viewConfig: {
                plugins: {
                    ptype: 'gridviewdragdrop',
                    dragText: _('drag_and_drop_reorganize')
                },
                listeners: {
                    scope: me,
                    drop: me.onDragDrop
                }
            },
            columns: [
	            {
		            xtype: 'rownumberer'
	            },
                {
                    text: _('option_title'),
                    width: 200,
                    sortable: true,
                    dataIndex: 'option_name',
                    editor: {
                        allowBlank: false,
                        enableKeyEvents: true,
                        listeners: {
                            scope: me,
                            keyup: me.onOptionTitleChange
                        }
                    }
                },
                {
                    text: _('option_value'),
                    width: 200,
                    sortable: true,
                    dataIndex: 'option_value',
                    editor: {
                        allowBlank: false,
                        itemId: 'optionValueTextField'
                    }
                },
	            {
		            text: _('code'),
		            sortable: true,
		            dataIndex: 'code',
		            width: 120,
		            editor: {
			            allowBlank: true
		            }
	            },
	            {
		            text: _('code_type'),
		            sortable: true,
		            dataIndex: 'code_type',
		            width: 100,
		            editor: {
			            allowBlank: true
		            }
	            },
                {
                    text: _('notes'),
                    sortable: true,
                    dataIndex: 'notes',
                    flex: 1,
	                width: 100,
                    editor: {
                        allowBlank: true
                    }
                },
                {
                    text: _('active'),
                    width: 55,
                    sortable: false,
                    dataIndex: 'active',
                    renderer: me.boolRenderer,
                    editor: {
                        xtype: 'checkbox',
                        margin: 0
                    }
                }
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'top',
                    items: ['->', {
                        text: _('add_option'),
                        iconCls: 'icoAddRecord',
                        scope: me,
                        handler: me.onNewOption
                    }]
                }
            ]
        });
        me.pageBody = [me.listsGrid, me.optionsGrid];
        me.callParent(arguments);
    },

    /**
     * This wll load a new record to the grid
     * and start the rowEditor
     */
    onNewList: function(){
        var me = this;
        me.listsRowEditing.cancelEdit();
        me.listsStore.insert(0, Ext.create('App.model.administration.Lists'));
        me.listsRowEditing.startEdit(0, 0);
    },

    /**
     *
     * @param grid
     * @param selected
     */
    onListsGridClick: function(grid, selected){
        var me = this,
	        deleteBtn = me.listsGrid.down('toolbar').getComponent('listDeleteBtn'),
	        inUse = !!selected.data.in_use == '1',
	        listId = selected.data.id;

	    me.optionsStore.clearFilter(true);
	    me.optionsStore.filter([
		    {
			    property:'list_id',
			    value: listId
		    }
	    ]);
        inUse ? deleteBtn.disable() : deleteBtn.enable();
    },

    /**
     * This wll load a new record to the grid
     * and start the rowEditor
     */
    onNewOption: function(){
        var me = this,
	        list = me.getCurrList(),
	        m;

	    if(list !== false){
		    me.optionsRowEditing.cancelEdit();
		    m = Ext.create('App.model.administration.ListOptions', {
			    list_id: list.id,
                list_key: list.list_key
		    });
		    me.optionsStore.insert(0, m);
		    me.optionsRowEditing.startEdit(0, 0);
	    }
    },

    /**
     * Set the Option Value same as Option Title
     * @param a
     */
    onOptionTitleChange: function(a){
//        var value = a.getValue(), field = a.up('container').getComponent('optionValueTextField');
//        field.setValue(value);
    },

    /**
     * Logic to sort the options
     * @param node
     * @param data
     * @param overModel
     */
    onDragDrop: function(node, data, overModel){
        var me = this,
	        items = overModel.stores[0].data.items,
	        list = me.getCurrList(),
	        gridItems = [];

        for(var i = 0; i < items.length; i++){
	        Ext.Array.push(gridItems, items[i].data.id);
        }

        var params = {
            list_id: data.records[0].data.list_id,
            fields: gridItems
        };

        Lists.sortOptions(params, function(){
	        me.optionsStore.clearFilter(true);
	        me.optionsStore.filter([
		        {
			        property:'list_key',
			        value: list.list_key
		        }
	        ]);
        });
    },
    /**
     *
     * @param a
     */
    onListDelete: function(a){
        var me = this,
            grid = a.up('grid'),
            store = grid.getStore(),
            sm = grid.getSelectionModel(),
            record = sm.getLastSelected();

        if(!record.data.in_use){
            Ext.Msg.show({
                title: _('please_confirm') + '...',
                icon: Ext.MessageBox.QUESTION,
                msg: _('delete_this_record'),
                buttons: Ext.Msg.YESNO,
                scope: me,
                fn: function(btn){
                    if(btn == 'yes'){
                        store.remove(record);
                        store.sync({
                            success:function(){
                                me.msg(_('sweet'), _('record_deleted'));
                                me.optionsStore.removeAll();
                            },
                            failure:function(){
                                me.msg(_('oops'), _('unable_to_delete') + ' "' + record.data.title, true);
                            }
                        });
                    }
                }
            });
        }else{
            Ext.Msg.alert(_('oops'), _('unable_to_delete') + ' "' + record.data.title + '"<br>' + _('list_currently_used_forms') + '.');
        }
    },

	getCurrList: function(){
		var records = this.listsGrid.getSelectionModel().getSelection();

		if(records.length > 0){
			return records[0].data;
		}

		return false;

	},

    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function(callback){
        var me = this;
        me.listsStore.load();
        callback(true);
    }
});

Ext.define('App.view.administration.Layout', {
    extend: 'App.ux.RenderPanel',
    id: 'panelLayout',
    pageTitle: _('layout_form_editor'),
    pageLayout: 'border',
    initComponent: function(){
        var me = this;

        me.currForm = null;
        me.currField = null;

	    /**
	     *
	     * @type {App.store.administration.LayoutTree}
	     */
        me.fieldsGridStore = Ext.create('App.store.administration.LayoutTree');

        /**
         * Xtype Combobox store
         */
        me.fieldXTypesStore = Ext.create('App.store.administration.XtypesComboModel');

        /**
         * Forms grid store (left grid)
         */
        me.formsGridStore = Ext.create('App.store.administration.FormsList');

        /**
         * Field available on this form as parent items (fieldset / fieldcontainer )
         * use to get the "Child of" combobox data
         */
        me.parentFieldsStore = Ext.create('App.store.administration.ParentFields');

        /**
         * This are the select lists available to use for comboboxes
         * this lists can be created an modified at "Lists" administration panel.
         */
        me.selectListoptionsStore = Ext.create('App.store.administration.FormListOptions');

        /**
         * This grid only available if the field is a Combobox
         */
        me.selectListGrid = Ext.create('Ext.grid.Panel', {
            store: me.selectListoptionsStore,
            collapseMode: 'mini',
            height:200,
            split: true,
            border: false,
            titleCollapse: false,
            hideCollapseTool: true,
            collapsible: true,
            collapsed: true,
            columns: [
                {
                    text: _('name'),
                    flex: 1,
                    sortable: false,
                    dataIndex: 'option_name'
                },
                {
                    text: _('value'),
                    flex: 1,
                    sortable: false,
                    dataIndex: 'option_value'
                }
            ]
        });

        /**
         * form to create and modified the fields
         */
        me.fieldForm = Ext.create('Ext.form.Panel', {
            flex:2,
            border: false,
            autoScroll: true,
            fieldDefaults: {
                msgTarget: 'side',
                labelWidth: 100
            },
            defaults: {
                anchor: '100%'
            },
            items: [
                {
                    fieldLabel: _('type'),
                    xtype: 'combo',
                    name: 'xtype',
                    displayField: 'name',
                    valueField: 'value',
                    allowBlank: false,
                    editable: false,
                    store: me.fieldXTypesStore,
                    queryMode: 'local',
                    margin: '5 5 5 10',
                    itemId: 'xtype',
                    listeners: {
                        scope: me,
                        change: me.onXtypeChange
                    }
                },
                {
                    fieldLabel: _('child_of'),
                    xtype: 'combo',
                    name: 'parentId',
                    displayField: 'name',
                    valueField: 'value',
                    editable: false,
                    hideTrigger: true,
	                allowBlank: false,
                    store: me.parentFieldsStore,
                    queryMode: 'local',
                    margin: '5 5 5 10',
                    emptyText: 'None',
                    itemId: 'parentFields',
                    listeners: {
                        scope: me,
                        expand: me.onParentFieldsExpand
                    }
                },
                {
                    xtype: 'fieldset',
                    itemId: 'aditionalProperties',
                    title: _('aditional_properties'),
                    margin: '0 5 5 5',
                    defaults: {
                        anchor: '100%'
                    },
                    items: [
                        {
                            fieldLabel: _('title'),
                            xtype: 'textfield',
                            name: 'title',
                            itemId: 'title',
                            allowBlank: false,
                            hidden: true
                        },
                        {
                            fieldLabel: _('field_label'),
                            xtype: 'textfield',
                            name: 'fieldLabel',
                            itemId: 'fieldLabel',
                            hidden: true
                        },
                        {
                            fieldLabel: _('box_label'),
                            xtype: 'textfield',
                            name: 'boxLabel',
                            itemId: 'boxLabel',
                            allowBlank: false,
                            hidden: true
                        },
                        {
                            fieldLabel: _('label_width'),
                            xtype: 'textfield',
                            name: 'labelWidth',
                            itemId: 'labelWidth',
                            hidden: true
                        },
                        {
                            fieldLabel: _('hide_label'),
                            xtype: 'checkbox',
                            name: 'hideLabel',
                            itemId: 'hideLabel',
                            hidden: true
                        },
                        {
                            fieldLabel: _('empty_text'),
                            xtype: 'textfield',
                            name: 'emptyText',
                            itemId: 'emptyText',
                            hidden: true
                        },
                        {
                            fieldLabel: _('layout'),
                            xtype: 'textfield',
                            name: 'layout',
                            itemId: 'layout',
                            hidden: true
                        },
                        {
                            fieldLabel: _('name'),
                            xtype: 'textfield',
                            name: 'name',
                            itemId: 'name',
                            allowBlank: false,
                            hidden: true,
	                        listeners:{
		                        scope:me,
		                        change: me.onNameValueChange
	                        }
                        },
                        {
                            fieldLabel: _('input_value'),
                            xtype: 'textfield',
                            name: 'inputValue',
                            itemId: 'inputValue',
                            hidden: true
                        },
                        {
                            fieldLabel: _('width'),
                            xtype: 'textfield',
                            name: 'width',
                            itemId: 'width',
                            emptyText: 'ei. 5 for 5px',
                            hidden: true
                        },
                        {
                            fieldLabel: _('height'),
                            xtype: 'textfield',
                            name: 'height',
                            itemId: 'height',
                            emptyText: 'ei. 5 for 5px',
                            hidden: true
                        },
                        {
                            fieldLabel: _('anchor'),
                            xtype: 'textfield',
                            name: 'anchor',
                            itemId: 'anchor',
                            emptyText: 'ei. 100%',
                            hidden: true
                        },
                        {
                            fieldLabel: _('flex'),
                            xtype: 'checkbox',
                            name: 'flex',
                            itemId: 'flex',
                            hidden: true
                        },
                        {
                            fieldLabel: _('collapsible'),
                            xtype: 'checkbox',
                            name: 'collapsible',
                            itemId: 'collapsible',
                            hidden: true
                        },
                        {
                            fieldLabel: _('checkbox_toggle'),
                            xtype: 'checkbox',
                            name: 'checkboxToggle',
                            itemId: 'checkboxToggle',
                            hidden: true
                        },
                        {
                            fieldLabel: _('collapsed'),
                            xtype: 'checkbox',
                            name: 'collapsed',
                            itemId: 'collapsed',
                            hidden: true
                        },
                        {
                            fieldLabel: _('margin'),
                            xtype: 'textfield',
                            name: 'margin',
                            itemId: 'margin',
                            emptyText: 'ei. 5 5 5 5',
                            hidden: true
                        },
                        {
                            fieldLabel: _('columns'),
                            xtype: 'textfield',
                            name: 'columns',
                            itemId: 'columns',
                            emptyText: 'ei. 2',
                            hidden: true
                        },
                        {
                            fieldLabel: _('column_width'),
                            xtype: 'textfield',
                            name: 'columnWidth',
                            itemId: 'columnWidth',
                            emptyText: 'ei. .5',
                            hidden: true
                        },
                        {
                            fieldLabel: _('is_required'),
                            xtype: 'checkbox',
                            name: 'allowBlank',
                            itemId: 'allowBlank',
                            hidden: true
                        },
                        {
                            fieldLabel: _('min_length'),
                            xtype: 'numberfield',
                            name: 'minLength',
                            itemId: 'minLength',
	                        minValue: 0,
                            hidden: true
                        },
                        {
                            fieldLabel: _('max_length'),
                            xtype: 'numberfield',
                            name: 'maxLength',
                            itemId: 'maxLength',
	                        minValue: 0,
                            hidden: true
                        },
                        {
                            fieldLabel: _('value'),
                            xtype: 'textfield',
                            name: 'value',
                            itemId: 'value',
                            hidden: true
                        },
                        {
                            fieldLabel: _('max_value'),
                            xtype: 'textfield',
                            name: 'maxValue',
                            itemId: 'maxValue',
                            hidden: true
                        },
                        {
                            fieldLabel: _('min_value'),
                            xtype: 'textfield',
                            name: 'minValue',
                            itemId: 'minValue',
                            hidden: true
                        },
                        {
                            fieldLabel: _('max_value'),
                            xtype: 'timefield',
                            name: 'maxValue',
                            itemId: 'timeMaxValue',
                            hidden: true
                        },
                        {
                            fieldLabel: _('min_value'),
                            xtype: 'timefield',
                            name: 'minValue',
                            itemId: 'timeMinValue',
                            hidden: true
                        },
                        {
                            fieldLabel: _('grow'),
                            xtype: 'checkbox',
                            name: 'grow',
                            itemId: 'grow',
                            hidden: true
                        },
                        {
                            fieldLabel: _('grow_min'),
                            xtype: 'textfield',
                            name: 'growMin',
                            itemId: 'growMin',
                            hidden: true
                        },
                        {
                            fieldLabel: _('grow_max'),
                            xtype: 'textfield',
                            name: 'growMax',
                            itemId: 'growMax',
                            hidden: true
                        },
                        {
                            fieldLabel: _('increment'),
                            xtype: 'textfield',
                            name: 'increment',
                            itemId: 'increment',
                            hidden: true
                        },
                        {
                            fieldLabel: _('list_options'),
                            xtype: 'mitos.listscombo',
                            name: 'list_id',
                            itemId: 'list_id',
                            hidden: true,
                            allowBlank: false,
                            listeners: {
                                scope: me,
                                change: me.onSelectListSelect
                            }
                        },
	                    {
		                    fieldLabel: _('code'),
		                    xtype: 'textfield',
		                    name: 'code',
		                    itemId: 'code',
		                    emptyText: 'ei. SNOMED:254687942 or ICD10:H25.091',
		                    hidden: true
	                    },
	                    {
		                    fieldLabel: _('item_id'),
		                    xtype: 'textfield',
		                    name: 'itemId',
		                    itemId: 'itemId',
		                    emptyText: 'sencha itemId',
		                    hidden: true
	                    },
	                    {
		                    fieldLabel: _('action'),
		                    xtype: 'textfield',
		                    name: 'action',
		                    itemId: 'action',
		                    emptyText: 'sencha action',
		                    hidden: true
	                    }
                    ]
                }
            ]
        });

        /**
         * this container holds the form and the select list grid.
         * remember that the select list grid only shows if
         * the field xtype is a combobox
         */
        me.formContainer = Ext.create('Ext.panel.Panel', {
            title: _('field_configuration'),
            border: true,
            split: true,
            width: 390,
            region: 'east',
            layout: {
                type:'vbox',
                align:'stretch'
            },
            bodyStyle: 'background-color:#fff!important',
            items: [
	            me.fieldForm,
	            me.selectListGrid
            ],
            buttons:[
                {
                    text: _('delete'),
                    iconCls: 'icoDeleteBlack',
                    scope: me,
                    handler: me.onFieldDelete
                },
                {
                    text: _('reset'),
                    iconCls: 'icoReload',
                    scope: me,
                    handler: me.onFormReset
                },
                {
                    text: _('save'),
                    iconCls: 'save',
                    scope: me,
                    handler: me.onFieldSave
                }
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    items: [
                        '->',
                        {
                            text: _('add_new'),
                            iconCls: 'icoAddRecord',
                            scope: me,
                            handler: me.onFormReset
                        },
                        '-',
                        {
                            text: _('add_child'),
                            iconCls: 'icoAddRecord',
                            itemId: 'addChild',
                            disabled: true,
                            scope: me,
                            handler: me.onAddChild
                        },
                        '-',
                        {
                            text: _('form_preview'),
                            iconCls: 'icoPreview',
                            enableToggle: true,
                            listeners: {
                                scope: me,
                                toggle: me.onFormPreview
                            }
                        }
                    ]
                }
            ]
        });

        /**
         * This is the fields associated with the current Form selected
         */
        me.fieldsGrid = Ext.create('Ext.tree.Panel', {
            store: me.fieldsGridStore,
            region: 'center',
            border: true,
            sortable: false,
            rootVisible: false,
            title: _('field_editor_demographics'),
            viewConfig: {
                plugins: {
                    ptype: 'treeviewdragdrop',
	                expandDelay:0,
                    allowParentInsert: false
                },
                listeners: {
                    scope: me,
                    drop: me.onDragDrop,
	                itemkeydown: me.onFieldKeyDown
                }
            },
            columns: [
                {
                    xtype: 'treecolumn',
                    text: _('field_type'),
                    sortable: false,
                    dataIndex: 'xtype',
                    width: 200,
                    align: 'left'
                },
                {
                    text: _('title'),
                    sortable: false,
                    dataIndex: 'title',
                    width: 100,
                    align: 'left'
                },
                {
                    text: _('label'),
                    sortable: false,
                    dataIndex: 'fieldLabel',
                    flex: 1,
                    align: 'left'
                }
            ],
            listeners: {
                scope: me,
	            selectionchange: me.onFieldsGridSelectionChange
            }
        });

        /**
         * Form grid will show the available forms to modified.
         * the user will not have the options to create
         * forms, just to modified the fields of existing forms.
         */
        me.formsGrid = Ext.create('Ext.grid.Panel', {
            title: _('forms'),
            region: 'west',
            store: me.formsGridStore,
            width: 200,
            border: true,
            split: true,
            hideHeaders: true,
            plugins:[
                {
                    ptype:'cellediting'
                }
            ],
            tbar:[
                '->',
                {
                    xtype:'button',
                    text: _('form'),
                    iconCls: 'icoAdd',
                    itemId: 'LayoutFormsAddFormBtn',
                    scope: me,
                    handler: me.onLayoutFormsAddFormBtnHandler
                }
            ],
            columns: [
                {
                    flex: 1,
                    sortable: true,
                    dataIndex: 'name',
                    editor: {
                        xtype: 'textfield'
                    }
                }
            ],
            listeners: {
                scope: me,
                itemclick: me.onFormGridItemClick
            }
        });

        /**
         * this panel will render the current form to preview
         * all the changes done.
         */
        me.fromPreview = Ext.create('Ext.form.Panel', {
            region: 'south',
            height: 300,
            collapsible: true,
            titleCollapse: false,
            hideCollapseTool: true,
            collapsed: true,
            border: true,
            split: true,
            collapseMode: 'header',
            bodyStyle: 'padding: 5px',
            layout: 'anchor',
            fieldDefaults: {
                msgTarget: 'side'
            },
            tools: [
                {
                    itemId: 'refresh',
                    type: 'refresh',
                    scope: me,
                    handler: me.previewFormRender
                }
            ]
        });

        me.pageBody = [
	        me.fieldsGrid,
	        me.formsGrid,
	        me.formContainer,
	        me.fromPreview
        ];
        me.callParent(arguments);
    },

	onLayoutFormsAddFormBtnHandler: function () {
		this.formsGrid.editingPlugin.cancelEdit();
		var records = this.formsGrid.getStore().insert(0, {
            name: 'New Form',
            active: 1
		});
		this.formsGrid.editingPlugin.startEdit(records[0], 0);
	},

    /**
     * if the form is valid send the POST request
     */
    onFieldSave: function(){
        var me = this,
            form = me.fieldForm.getForm(),
            record = form.getRecord(),
            store = me.fieldsGridStore,
            parentNode = store.getNodeById(record.data.parentId) || store.getRootNode(),
            values = form.getValues();

        if(form.isValid()){

            values.form_id = record.data.form_id;
            values.leaf = (values.xtype != 'fieldcontainer' && values.xtype != 'fieldset');
            record.set(values);

            if(record.data.id == ''){
	            parentNode.appendChild(record);
            }

            me.fieldsGridStore.sync({
               success:function(batch, options){
                   me.previewFormRender();
                   me.loadCurrFormParentField();

	               //say(batch);
	               //say(options);

                   // this is the quick way to apply the return changes to the model
	               if(record.data.id == ''){
		               //say(batch.proxy.reader.rawData.id);
		               record.set({ id: batch.proxy.reader.rawData.id });
		               record.commit();
	               }

	               me.fieldsGrid.getSelectionModel().select(record);
                   me.msg(_('sweet'), _('record_saved'));
               },
               failure:function(batch){

	               record.remove();

	               me.msg('Oops!', batch.proxy.reader.rawData.message, true);
                   me.loadFieldsGrid();
               }
           });
        }
    },

	/**
	 * Delete Field logic
	 * @param record
	 */
	deleteField:function(record){
		var me = this;

		//say(record.childNodes);

		if(record.childNodes.length > 0){
			me.msg(_('oops'), _('children_fields_must_be_remove_first'), true);
			return;
		}

		Ext.Msg.show({
			title: _('please_confirm') + '...',
			icon: Ext.MessageBox.QUESTION,
			msg: _('delete_this_field'),
			buttons: Ext.Msg.YESNO,
			scope: this,
			fn: function(btn){
				if(btn == 'yes'){
					record.remove();
					me.fieldsGridStore.sync({
						success:function(){
							me.previewFormRender();
							me.msg(_('sweet'), _('record_removed'));
						},
						failure:function(batch){
							me.msg('Oops!', batch.proxy.reader.rawData.message, true);
							me.loadFieldsGrid();
						}
					});
				}
			}
		});
	},

	/**
	 *
	 * @param view
	 * @param record
	 * @param item
	 * @param idex
	 * @param e
	 */
	onFieldKeyDown:function(view, record, item, idex, e){
		if(e.getKey() == e.DELETE){
			this.deleteField(record);
		}
	},

    /**
     *
     */
    onFieldDelete: function(){
        var me = this,
	        form = me.fieldForm.getForm(),
	        record = form.getRecord();

	    me.deleteField(record);
    },

    /**
     *
     * @param node
     * @param data
     * @param overModel
     */
    onDragDrop: function(node, data, overModel){
        var me = this;

        me.fieldsGridStore.sync({
            success:function(){
                me.previewFormRender();
                me.msg(_('sweet'), _('field_updated'));
            },
            failure:function(batch){
                Ext.Msg.alert(_('oops'), batch.proxy.reader.rawData.error);
                me.loadFieldsGrid();
            }
        });
    },

    /**
     * This is to reset the Form and load
     * a new Model with the currForm id
     */
    onFormReset: function(){
        var me = this,
            formPanel = me.fieldForm,
            form = formPanel.getForm(),
            selection = me.fieldsGrid.getSelectionModel(),
	        record = Ext.create('App.model.administration.LayoutTree', {
		        form_id: me.currForm,
		        parentId: 'root'
	        });

	    selection.deselectAll();
        form.reset();
        form.loadRecord(record);
    },

	onNameValueChange:function(field, value){
		field.setDisabled(field.up('form').getForm().getRecord().data.id != 0);
	},

    /**
     *
     * load a new model with the form_id and parentId values.
     * This is the easy way to add a child to a fieldset or fieldcontainer.
     */
    onAddChild: function(){
        var me = this,
            formPanel = me.fieldForm,
            form = formPanel.getForm(),
            row = me.fieldsGrid.getSelectionModel();

        row.deselectAll();
        form.reset();

        form.loadRecord(
            Ext.create('App.model.administration.LayoutTree',{
                form_id: me.currForm,
                parentId: me.currField
            })
        );
    },

    /**
     *
     * This will load the current field data to the form,
     * set the currField, and enable the Add Child btn if
     * the field allows child items (fieldset or fieldcontainer)
     *
     * @param sm
     * @param records
     */
    onFieldsGridSelectionChange: function(sm, records){
        var me = this,
            formPanel = me.fieldForm,
            form = formPanel.getForm();

	    if(records.length > 0){
		    form.loadRecord(records[0]);
		    me.currField = records[0].data.id;
		    if(records[0].data.xtype == 'fieldset' || records[0].data.xtype == 'fieldcontainer'){
			    me.formContainer.down('toolbar').getComponent('addChild').enable();
		    }else{
			    me.formContainer.down('toolbar').getComponent('addChild').disable();
		    }
		    formPanel.el.unmask();
	    }else{
		    me.onFormReset();
	    }
    },

    /**
     *
     * @param DataView
     * @param record
     */
    onFormGridItemClick: function(DataView, record){
        var me = this;

        me.currForm = record.get('id');
        me.fieldsGrid.setTitle(_('field_editor') + ' (' + record.get('name') + ')');
        me.loadFieldsGrid();
        me.onFormReset();
    },

    /**
     *
     * This will load the Select List options. This Combobox shows only when
     * a Type of Combobox is selected
     *
     * @param combo
     * @param value
     */
    onSelectListSelect: function(combo, value){
        var me = this;

        me.selectListoptionsStore.load({
            params: {
                list_id: value
            }
        });
    },

    /**
     *
     * This is to handle a error when loading a combobox store.
     *
     * @param combo
     */
    onParentFieldsExpand: function(combo){
        combo.picker.loadMask.destroy();
    },

    /**
     * onXtypeChange will search the combo value and enable/disable
     * the fields appropriate for the xtype selected
     *
     * @param combo
     * @param value
     */
    onXtypeChange: function(combo, value){
        var me = this;

        if(value == 'combobox'){
            me.selectListGrid.setTitle(_('select_list_options'));
            me.selectListGrid.expand();
            me.selectListGrid.enable();
        }else{
            me.selectListGrid.setTitle('');
            me.selectListGrid.collapse();
            me.selectListGrid.disable();
        }

        /**
         *
         * @param searchStr
         */
        Array.prototype.find = function(searchStr){
            var returnArray = false;

            for(var i = 0; i < this.length; i++){
                if(typeof (searchStr) == 'function'){
                    if(searchStr.test(this[i])){
                        if(!returnArray){
                            returnArray = [];
                        }
                        returnArray.push(i);
                    }
                }else{
                    if(this[i] === searchStr){
                        if(!returnArray){
                            returnArray = [];
                        }
                        returnArray.push(i);
                    }
                }
            }

            return returnArray;
        };

        var addProp = me.fieldForm.getComponent('aditionalProperties');
        var is = addProp.items.keys;

        /**
         *
         * @param items
         */
        function enableItems(items){
            for(var i = 0; i < is.length; i++){
                if(!items.find(is[i])){
                    addProp.getComponent(is[i]).hide();
                    addProp.getComponent(is[i]).disable();
                }else{
                    addProp.getComponent(is[i]).show();
                    addProp.getComponent(is[i]).enable();
                }
            }
        }

        var items;
        if(value == 'fieldset'){
            items = [
                'itemId',
                'action',
                'title',
                'collapsible',
                'collapsed',
                'checkboxToggle',
                'margin',
                'columnWidth',
                'layout'
            ];
        }else if(value == 'fieldcontainer'){
            items = [
                'itemId',
                'action',
                'fieldLabel',
                'labelWidth',
                'hideLabel',
                'width',
                'layout',
                'margin',
                'columnWidth',
                'columns'
            ];
        }else if(value == 'combobox'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'emptyText',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'margin',
                'allowBlank',
                'list_id'
            ];
        }else if(value == 'checkbox'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'boxLabel',
                'inputValue',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'margin'
            ];
        }else if(value == 'textfield'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'anchor',
                'emptyText',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'allowBlank',
                'margin',
                'minLength',
                'maxLength'
            ];
        }else if(value == 'textareafield'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'anchor',
                'height',
                'emptyText',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'allowBlank',
                'grow',
                'growMin',
                'growMax',
                'margin',
                'minLength',
                'maxLength'
            ];
        }else if(value == 'numberfield'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'value',
                'emptyText',
                'maxValue',
                'minValue',
                'increment',
                'fieldLabel',
                'labelWidth',
                'hideLabel',
                'margin'
            ];
        }else if(value == 'timefield'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'value',
                'emptyText',
                'timeMaxValue',
                'timeMinValue',
                'increment',
                'fieldLabel',
                'labelWidth',
                'hideLabel',
                'margin'
            ];
        }else if(value == 'radiofield'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'boxLabel',
                'labelWidth',
                'hideLabel',
                'margin',
                'inputValue'
            ];
        }else if(value == 'datefield' || value == 'mitos.datetime'){
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'value',
                'layout',
                'emptyText',
                'fieldLabel',
                'labelWidth',
                'hideLabel',
                'allowBlank',
                'margin'
            ];
        }else if(value == 'checkboxwithfamilyhistory'){
	        items = [
                'itemId',
                'action',
                'name',
                'width',
                'boxLabel',
                'inputValue',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'margin',
                'code'
            ];
        }else if(value == 'physicalexamfield'){
	        items = [
                'itemId',
                'action',
                'name',
                'width',
                'fieldLabel',
                'boxLabel',
                'inputValue',
                'fieldLabel',
                'hideLabel',
                'labelWidth',
                'margin',
                'code'
            ];
        }else{
            items = [
                'itemId',
                'action',
                'name',
                'width',
                'emptyText',
                'fieldLabel',
                'labelWidth',
                'hideLabel',
                'margin'
            ];
        }
        enableItems(items);
    },

    /**
     *
     * On toggle down/true expand the preview panel and re-render the form
     *
     * @param btn
     * @param toggle
     */
    onFormPreview: function(btn, toggle){
        var me = this;

        if(toggle === true){
            me.fromPreview.expand(false);
            me.previewFormRender();
        }else{
            me.fromPreview.collapse(false);
        }
    },

    /**
     *
     *  this function re-render the preview form
     */
    previewFormRender: function(){
        var me = this,
	        form = this.fromPreview;

        if(form.collapsed !== true){
            form.el.mask();
            me.getFormItems(form, me.currForm, function(){
                form.el.unmask();
            });
        }

    },

    /**
     *
     *  re-load the fields grid (main TreeGrid)
     *  check if a form is selected, if not the select the first choice
     *  save the form id inside this.currForm and load the grid and the
     *  parent fields of this form.
     *
     *  parentFieldsStore is use to create the child of select list
     */
    loadFieldsGrid: function(){
        var me = this;

        me.fieldsGridStore.load({
            params: {
                currForm: me.currForm
            }
        });

        me.loadCurrFormParentField();
        me.previewFormRender();
        me.fieldsGrid.doLayout()
    },

    loadCurrFormParentField:function(){
	    var me = this;
	    me.parentFieldsStore.load({ params:{ currForm: me.currForm } });
    },

    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function(callback){
        var me = this,
	        sm = me.formsGrid.getSelectionModel();

        if(me.currForm === null){
            me.formsGridStore.load({
	            filters:[
		            {
			            property:'active',
			            value:1
		            }
	            ],
                callback:function(records){
	                sm.select(records[0]);
	                me.currForm = records[0].data.id;
	                me.loadFieldsGrid();
	                me.onFormReset();
                }
            });
        }

        callback(true);
    }
});

Ext.define('App.view.administration.Modules', {
    extend: 'App.ux.RenderPanel',
    id: 'panelModules',
    pageTitle: _('modules'),
    initComponent: function(){
        var me = this;

        // *************************************************************************************
        // Module Data Store
        // *************************************************************************************
        me.store = Ext.create('App.store.administration.Modules');

        me.grid = Ext.create('Ext.grid.Panel', {
            store: me.store,
            plugins: [
                me.edditing = Ext.create('Ext.grid.plugin.RowEditing', {
                    clicksToEdit: 2,
                    errorSummary : false
                })
            ],
            columns: [
                {
                    text: _('title'),
                    width: 200,
                    sortable: true,
                    dataIndex: 'title'
                },
                {
                    text: _('description'),
                    flex: 1,
                    sortable: true,
                    dataIndex: 'description'
                },
                {
                    text: _('version'),
                    width: 100,
                    sortable: true,
                    dataIndex: 'installed_version'
                },
                {
                    text: _('sql_version'),
                    width: 100,
                    sortable: true,
                    dataIndex: 'sql_version'
                },
                {
                    text: _('req_core_version'),
                    width: 150,
                    sortable: true,
                    dataIndex: 'required_core_version'
                },
                {
                    text: _('key_if_required'),
                    flex: 1,
                    sortable: true,
                    dataIndex: 'licensekey',
                    editor:{
                        xtype:'textfield'
                    }
                },
                {
                    text: _('enabled?'),
                    width: 60,
                    sortable: true,
                    renderer: me.boolRenderer,
                    dataIndex: 'enable',
                    editor:{
                        xtype:'checkbox'
                    }
                }
            ]
        });
        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    },


    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function(callback){
        this.store.load();
        callback(true);
    }
});

Ext.define('App.view.administration.PdfForms', {
	extend: 'App.ux.RenderPanel',
	requires: [

	],
	pageTitle: 'PDF Forms',
	pageLayout: 'border',
	itemId: 'AdministrationPdfForms',
	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.administration.DocumentForms', {
			remoteFilter: true,
			remoteSort: true,
			autoSync: false,
			pageSize: 50
		});

		me.pageBody = [
			{
				xtype: 'grid',
				store: me.store,
				region: 'center',
				itemId: 'AdministrationPdfFormsGrid',
				frame: true,
				plugins: [
					{
						ptype: 'rowediting'
					}
				],
				columns: [
					{
						text: 'Facility',
						dataIndex: 'facility_id',
						editor: {
							xtype: 'activefacilitiescombo',
							allowBlank: false
						}
					},
					{
						text: 'Type',
						dataIndex: 'document_type',
						editor: {
							xtype: 'textfield',
							allowBlank: false
						}
					},
					{
						text: 'Title',
						dataIndex: 'document_title',
						flex: 1,
						editor: {
							xtype: 'textfield',
							allowBlank: false
						}
					},
					{
						text: 'Path',
						dataIndex: 'document_path',
						flex: 2,
						editor: {
							xtype: 'textfield',
							allowBlank: false
						}
					},
					{
						text: 'SigX',
						dataIndex: 'signature_x',
						width: 40,
						editor: {
							xtype: 'numberfield'
						}
					},
					{
						text: 'SigY',
						dataIndex: 'signature_y',
						width: 40,
						editor: {
							xtype: 'numberfield'
						}
					},
					{
						text: 'SigW',
						dataIndex: 'signature_w',
						width: 40,
						editor: {
							xtype: 'numberfield'
						}
					},
					{
						text: 'SigH',
						dataIndex: 'signature_h',
						width: 40,
						editor: {
							xtype: 'numberfield'
						}
					},
					{
						text: 'Flatten',
						dataIndex: 'flatten',
						width: 70,
						renderer: app.boolRenderer,
						editor: {
							xtype: 'checkboxfield'
						}
					},
					{
						text: 'Active',
						dataIndex: 'is_active',
						width: 70,
						renderer: app.boolRenderer,
						editor: {
							xtype: 'checkboxfield'
						}
					}
				],
				dockedItems: [
					{
						xtype: 'toolbar',
						dock: 'top',
						items: [
							'->',
							{
								xtype: 'button',
								iconCls: 'icoAdd',
								text: 'PDF Form',
								itemId: 'AdministrationPdfFormsAddBtn'
							}
						]
					},
					{
						xtype: 'pagingtoolbar',
						pageSize: 1000,
						store: me.store,
						displayInfo: true,
						dock: 'bottom',
						plugins: new Ext.ux.SlidingPager()
					}
				]
			},
			{
				xtype: 'panel',
				title: 'Tokens',
				region: 'east',
				width: 260,
				frame: true,
				split: true,
				bodyStyle: 'background-color: white',
				itemId: 'AdministrationPdfFormsTokenPanel'
			}
		];

		me.callParent(arguments);

	},

});

Ext.define('App.view.administration.FloorPlans', {
    extend: 'App.ux.RenderPanel',
    id: 'panelFloorPlans',
    pageTitle: _('floor_plan_editor'),
    pageLayout: 'border',
    floorPlanId: null,
    activeZone: null,
    initComponent: function(){
        var me = this;
        me.floorPlansStore = Ext.create('App.store.administration.FloorPlans');
        me.floorZonesStore = Ext.create('App.store.administration.FloorPlanZones');
        me.floorPlans = Ext.create('Ext.grid.Panel', {
            requires: [
                'Ext.grid.plugin.CellEditing'
            ],
            title: _('floor_plans'),
            region: 'west',
            width: 300,
            split: true,
            hideHeaders: true,
            store: me.floorPlansStore,
            columnsLines: true,
            plugins: [
                {
                    ptype: 'rowediting'
                }
            ],
            columns: [
                {
                    dataIndex: 'title',
                    sortable: false,
                    hideable: false,
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        emptyText:_('new_floor'),
                        allowBlank: false
                    }
                },
                {
                    text: _('facility_id'),
                    dataIndex: 'facility_id',
                    editor: {
                        xtype: 'mitos.facilitiescombo',
                        allowBlank: false
                    }
                },
            ],
            tbar: [
                {
                    text: _('add_floor'),
                    action: 'newFloorPlan',
                    iconCls:'icoAdd',
                    scope: me,
                    handler: me.onNewFloorPlan
                },
                '-',
                {
                    text: _('remove_floor'),
                    action: 'newFloorPlan',
                    iconCls:'icoDelete',
                    scope: me,
                    handler: me.onRemoveFloorPlan
                }
            ],
            listeners: {
                scope: me,
                select: me.onFloorPlanSelected
            }
        });
        me.floorPlanZones = Ext.create('Ext.panel.Panel', {
            title: _('floor_plan'),
            region: 'center',
            bodyCls: 'floorPlan',
            layout: 'absolute',
            tbar: [
                {
                    text: _('add_zone'),
                    action: 'newZone',
                    iconCls:'icoAdd',
                    scope: me,
                    handler: me.onNewZone
                }
            ]
        });
        me.floorPlanZoneEditor = Ext.create('Ext.window.Window', {
            title:_('zone_editor'),
            closeAction:'hide',
            closable:false,
            resizable:false,
            items:[
                {
                    xtype:'form',
                    border:false,
                    bodyPadding: '10',
                    defaults:{
                        labelWidth: 130,
                        anchor:'100%'
                    },
                    items:[
                        {
                            xtype: 'textfield',
                            fieldLabel: _('zone_name'),
                            name: 'title'
                        },
                        {
                            xtype:'colorcombo',
                            fieldLabel: _('bg_color'),
                            name:'bg_color'
                        },
                        {
                            xtype:'colorcombo',
                            fieldLabel: _('border_color'),
                            name:'border_color'
                        },
                        {
                            xtype: 'numberfield',
                            fieldLabel: _('width'),
                            minValue: 30,
                            maxValue: 300,
                            name: 'width'
                        },
                        {
                            xtype: 'numberfield',
                            fieldLabel: _('height'),
                            minValue: 30,
                            maxValue: 300,
                            name: 'height'
                        },
                        {
                            xtype: 'checkbox',
                            fieldLabel: _('show_priority_color'),
                            name: 'show_priority_color'
                        },
                        {
                            xtype: 'checkbox',
                            fieldLabel: _('show_patient_preview'),
                            name: 'show_patient_preview'
                        },
                        {
                            xtype: 'checkbox',
                            fieldLabel: _('active'),
                            name: 'active'
                        }
                    ]
                }
            ],
            buttons:[
                {
                    text:_('remove'),
                    xtype:'button',
                    scope:me,
                    handler:me.onZoneRemove
                },
                '->',
                {
                    text:_('cancel'),
                    xtype:'button',
                    scope:me,
                    handler:me.onZoneCancel
                },
                '-',
                {
                    text:_('save'),
                    xtype:'button',
                    scope:me,
                    handler:me.onZoneSave
                }
            ],
            listeners:{
                scope:me,
                afterrender:function(win){
                   win.alignTo(this.floorPlanZones.getEl(), 'tr-tr', [-130, 70]);
                }
            }
        });
        me.listeners = {
            show: function(){
                me.nav = Ext.create('Ext.util.KeyNav', Ext.getDoc(),{
                    scope: me,
                    left: function(){
                        me.moveZone('left');
                    },
                    up: function(){
                        me.moveZone('up');
                    },
                    right: function(){
                        me.moveZone('right');
                    },
                    down: function(){
                        me.moveZone('down');
                    }
                });
            },
            hide: function(){
                if(me.nav) Ext.destroy(me.nav);
                me.setEditMode(false);
            }
        };
        me.pageBody = [me.floorPlans, me.floorPlanZones ];
        me.callParent(arguments);
    },
    setEditMode:function(show, zone){
        var me = this,
	        el = me.activeZone ? me.activeZone.getEl() : null;

        if(el){
                me.setEditor(show, zone);
        }else{
            me.setEditor(show, zone);
        }
    },
    setEditor:function(show, zone){
        var me = this;
        if(show){
            me.activeZone = zone;
            me.getEditor().zone = zone;
            me.floorPlanZones.focus();
            me.getEditor().getForm().loadRecord(zone.record);
	        if(me.floorPlanZoneEditor.hidden){
		        me.floorPlanZoneEditor.show(zone.getEl());
	        }

        }else{
            me.floorPlanZoneEditor.hide();
            me.getEditor().getForm().reset();
            me.activeZone = null;
        }
    },
    getEditor:function(){
        return this.floorPlanZoneEditor.down('form');
    },
    onZoneCancel:function(btn){
        var me = this,
            zone = me.activeZone,
            record = zone.record,
            config;
        record.reject();
        config = {
            text: record.data.title,
            scale: record.data.scale,
            style:{
                'border-color':record.data.border_color,
                'background-color':record.data.bg_color
            },
            width:record.data.width,
            height:record.data.height
        };
        me.activeZone.setPosition(record.data.x, record.data.y);
        me.applyZoneConfig(zone, config);
        me.setEditMode(false);
    },
    onZoneSave:function(){
        var me = this,
            editor = me.getEditor(),
            form = editor.getForm(),
            values = form.getValues(),
            record = form.getRecord(),
            config;
        record.set(values);
        config = {
            text: record.data.title,
            scale: record.data.scale,
            style:{
                'border-color':record.data.border_color,
                'background-color':record.data.bg_color
            },
            width:record.data.width,
            height:record.data.height
        };
        record.save({
            callback: function (){
                app.fireEvent('floorplanzonesave', me, record);
            }
        });
        me.applyZoneConfig(editor.zone, config);
        me.setEditMode(false);
    },
    onZoneHandler:function(zone){
        var me = this;
        me.setEditMode(true, zone);
    },
    onZoneRemove:function(){
        var me = this,
            editor = this.getEditor(),
            form = editor.getForm(),
            record = form.getRecord(),
            zone = editor.zone;
        Ext.Msg.show({
            title:'Wait!',
            msg: _('remove_final_notice') + ' <span style="font-weight: bold">"'+record.data.title+'"</span>?',
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.WARNING,
            fn:function(btn){
                if(btn == 'yes'){
                    me.floorZonesStore.remove(record);
                    me.floorZonesStore.sync({
                        success:function(){
                            me.floorPlanZones.remove(zone, true);
                            editor.up('window').hide();
                        }
                    });
                }
            }
        });
    },
    onRemoveFloorPlan:function(btn){
        var me = this,
            grid = btn.up('grid'),
            store = grid.store,
            sm = grid.getSelectionModel(),
            record = sm.getLastSelected();
        Ext.Msg.show({
            title:'Wait!',
            msg: _('remove_final_notice') + ' <span style="font-weight: bold">"'+record.data.title+'"</span>?',
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.WARNING,
            fn:function(btn){
                if(btn == 'yes'){
                    store.remove(record);
                    store.sync({
                        callback:function(){
                            sm.deselectAll();
                            me.floorPlanZones.removeAll();
                            me.msg(_('sweet'),_('record_removed'))
                        }
                    });

                }
            }
        });

    },
    onNewZone: function(){
        var me = this;
        me.floorZonesStore.add({
            floor_plan_id: me.floorPlanId,
            title: _('new_zone'),
            x: 5,
            y: 5,
            show_priority_color: 1,
            show_patient_preview: 1,
            active: 0
        });
        me.floorZonesStore.sync({
            callback: function(batch){
                me.createZone(batch.operations[0].records[0]);
            }
        });
    },
    createZone: function(record){
        var me = this, zone;
        zone = me.floorPlanZones.add(
            Ext.create('Ext.button.Split', {
                text: record.data.title,
                draggable: {
                    listeners: {
                        scope: me,
                        dragend: me.zoneDragged
                    }
                },
                scale: record.data.scale,
                style:{
                    'border-color':record.data.border_color,
                    'background-color':record.data.bg_color
                },
                x: record ? record.data.x : 5,
                y: record ? record.data.y : 5,
                width:record.data.width,
                height:record.data.height,
                scope:me,
                handler: me.onZoneHandler
            })
        );
        zone.record = record;
    },
    applyZoneConfig:function(zone, config){
        zone.setText(config.text);
        zone.getEl().applyStyles(config.style);
        zone.setScale(config.scale);
        zone.setSize(config.width, config.height);
    },
    moveZone: function(direction){
        if(app.currCardCmp == this && this.activeZone != null){
            var x = this.activeZone.x, y = this.activeZone.y;
            if(direction == 'left'){
                x = x - 1;
            }else if(direction == 'right'){
                x = x + 1;
            }else if(direction == 'up'){
                y = y - 1;
            }else if(direction == 'down'){
                y = y + 1;
            }
            this.activeZone.setPosition(x, y);
            this.activeZone.record.set({x:x,y:y});
        }
    },
    zoneDragged: function(drag){
        var zone = drag.comp;
        zone.record.set({
            x: zone.x,
            y: zone.y
        });
    },
    onNewFloorPlan: function(btn){
        var me = this,
            grid = btn.up('grid'),
            editingPlugin = grid.editingPlugin,
            records;

        editingPlugin.cancelEdit();

        records = this.floorPlansStore.add({});

        editingPlugin.startEdit(records[0],0);
    },
    onFloorPlanSelected: function(model, record){
        this.setEditMode(false);
        this.floorPlanId = record.data.id;
        this.reloadFloorPlanZones();
    },
    reloadFloorPlanZones: function(){
        var me = this;
        me.floorPlanZones.removeAll();
        me.floorZonesStore.load({
            params:{ floor_plan_id: this.floorPlanId },
            scope: me,
            callback: function(records, operation, success){
                me.setEditMode(false);
                for(var i = 0; i < records.length; i++) me.createZone(records[i]);
            }
        });
    },
    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function(callback){
        var me = this;
        me.floorPlansStore.load({
            callback:function(){
                me.floorPlans.getSelectionModel().select(0);
            }
        });
        callback(true);
    }
});

Ext.define('App.view.administration.ExternalDataLoads', {
	extend: 'App.ux.RenderPanel',
	id: 'panelExternalDataLoads',
	pageTitle: _('external_data_loads'),
	/**
	 * define the layout 'accordion'
	 * and few more configs
	 */
	pageLayout: {
		type: 'accordion',
		animate: true,
		activeOnTop: true
	},
	initComponent: function(){
		var me = this;
		/**
		 * var stores is used to hold all the stores inside this class
		 * this way, if I want to reload all the stores at once, I can do it
		 * using a for loop
		 *
		 * see function loadStores()
		 *
		 * @type {Array}
		 */
		me.stores = [];

		me.stores.push(
			me.icd9Store = Ext.create('App.store.administration.ExternalDataLoads', {
				codeType: 'ICD9'
			})
		);
		me.stores.push(
			me.icd10Store = Ext.create('App.store.administration.ExternalDataLoads', {
				codeType: 'ICD10',
				groupField: 'version'
			})
		);
		me.stores.push(
			me.rxnormStore = Ext.create('App.store.administration.ExternalDataLoads', {
				codeType: 'RXNORM'
			})
		);
		me.stores.push(
			me.snomedStore = Ext.create('App.store.administration.ExternalDataLoads', {
				codeType: 'SNOMED'
			})
		);
		me.stores.push(
			me.hcpcsStore = Ext.create('App.store.administration.ExternalDataLoads', {
				codeType: 'HCPCS'
			})
		);


		/**
		 * Since all the grid are very similar I created a function that return a grid
		 */
		me.icd9Grid = me.getCodeGrid('Available ICD9 Data', me.icd9Store, false);
		me.icd10Grid = me.getCodeGrid('Available ICD10 Data', me.icd10Store, true);
		me.rxnormGrid = me.getCodeGrid('Available RxNorm Data', me.rxnormStore, false);
		me.snomedGrid = me.getCodeGrid('Available SNOMED Data', me.snomedStore, false);
		me.hcpcsGrid = me.getCodeGrid('Available HCPCS Data', me.hcpcsStore, false);

		/**
		 * Same thing with the forms
		 */
		me.icd9Form = me.getCodeForm('ICD9');
		me.icd10Form = me.getCodeForm('ICD10');
		me.rxnormForm = me.getCodeForm('RXNORM');
		me.snomedForm = me.getCodeForm('SNOMED');
		me.hcpcsForm = me.getCodeForm('HCPCS');

		/**
		 * Here are the panels used inside the accordion layout
		 */
		me.icd9 = Ext.create('Ext.form.Panel', {
			title: _('update_icd9'),
			layout: 'border',
			items: [me.icd9Grid, me.icd9Form]
		});

		me.icd10 = Ext.create('Ext.panel.Panel', {
			title: _('update_icd10'),
			layout: 'border',
			items: [me.icd10Grid, me.icd10Form]
		});

		me.rxnorm = Ext.create('Ext.panel.Panel', {
			title: _('update_rxnorm'),
			layout: 'border',
			items: [me.rxnormGrid, me.rxnormForm]
		});

		me.snomed = Ext.create('Ext.panel.Panel', {
			title: _('update_snomed'),
			layout: 'border',
			items: [me.snomedGrid, me.snomedForm]
		});
		me.hcpcs = Ext.create('Ext.panel.Panel', {
			title: _('update_hcpcs'),
			layout: 'border',
			items: [me.hcpcsGrid, me.hcpcsForm]
		});

		me.pageBody = [me.icd9, me.icd10, me.rxnorm, me.snomed, me.hcpcs];
		me.callParent(arguments);
	},

	getCodeForm: function(action){
		var me = this;
		return Ext.create('Ext.form.Panel', {
			bodyPadding: 10,
			region: 'center',
			action: action,
			frame: true,
			bodyStyle: 'background-color:white',
			bodyBorder: true,
			margin: '5 0 5 0',
			items: [
				{
					xtype: 'fieldset',
					styleHtmlContent: true,
					action: action,
					title: _('current_version_installed'),
					html: _('no_data_installed'),
					tpl: _('revision_name') + ':  {revision_name}<br>' + _('revision_number') + ':  {revision_number}<br>' + _('revision_version') + ': {revision_version}<br>' + _('revision_date') + ':    {revision_date}<br>' + _('imported_on') + ':      {imported_date}'
				},
				{
					xtype: 'fieldset',
					title: _('installation'),
					action: 'installation',
					styleHtmlContent: true,
					html: me.getInstallationDetails(action)
				},
				{
					xtype: 'fieldset',
					title: _('upload'),
					action: 'upload',
					items: [
						{

							xtype: 'filefield',
							name: 'filePath',
							buttonText: _('upload'),
							emptyText: _('data_file'),
							width: 350,
							labelWidth: 50,
							allowBlank: false
						}
					]
				}
			],
			api: {
				submit: 'ExternalDataUpdate.updateCodesWithUploadFile'
			},
			buttons: [
				{
					text: _('update'),
					action: action,
					scope: me,
					handler: me.uploadFile
				}
			]
		});
	},

	getCodeGrid: function(title, store, grouping){
		var me = this;
		return Ext.create('Ext.grid.Panel', {
			title: title,
			store: store,
			region: 'west',
			width: 500,
			margin: '5 0 5 0',
			padding: 0,
			split: true,
			columns: me.getDefaultColumns(),
			listeners: {
				scope: me,
				itemdblclick: me.onCodeDblClick
			},
			features: grouping ? [
				{
					ftype: 'grouping'
				}
			] : []
		});
	},

	getDefaultColumns: function(){
		return [
			{
				xtype: 'datecolumn',
				header: _('date'),
				dataIndex: 'date',
				format: g('date_display_format')
			},
			{
				header: _('version'),
				dataIndex: 'version'
			},
			{
				header: _('file'),
				dataIndex: 'basename',
				width: 300
			}
		];
	},

	getInstallationDetails: function(action){
		if(action == 'ICD9'){
			return '<p>Steps to install the ICD 9 data:</p>' +
				'<ol>' +
				'<li>The raw data feed release can be obtained from <a href="https://www.cms.gov/Medicare/Coding/ICD9ProviderDiagnosticCodes/codes.html">this location</a></li>' +
				'<li>Upload the downloaded .zip file, or place the downloaded ICD 9 database zip file into the following directory: contrib/icd9</li>' +
				'<li>Double Click the zip file from the "Available ICD9 Data" grid to install</li>' +
				'</ol>' +
				'<p style="color:red">NOTE: Importing external data can take more than an hour depending on your hardware configuration. For example, one of the RxNorm data tables contain in excess of 6 million rows.</p>'
		}
		else if(action == 'ICD10'){
			return '<p>Steps to install the ICD 10 data:</p>' +
				'<ol>' +
				'<li>The raw data feed release can be obtained from <a href="https://www.cms.gov/Medicare/Coding/ICD10">this location</a></li>' +
				'<li>Upload the downloaded .zip file, or place the downloaded ICD 10 database zip files into the following directory: contrib/icd10</li>' +
				'<li>Double Click the zip file from the "Available ICD10 Data" grid to install</li>' +
				'</ol>' +
				'<p>These are the ICD10 2012 links:</p>' +
				'<ol>' +
				'<li><a href="https://www.cms.gov/Medicare/Coding/ICD10/Downloads/DiagnosisGEMs_2012.zip">DiagnosisGEMs_2012</a></li>' +
				'<li><a href="https://www.cms.gov/Medicare/Coding/ICD10/Downloads/ProcedureGEMs_2012.zip">ProcedureGEMs_2012</a></li>' +
				'<li><a href="https://www.cms.gov/Medicare/Coding/ICD10/Downloads/ReimbursementMapping_2012.zip">ReimbursementMapping_2012</a></li>' +
				'<li><a href="https://www.cms.gov/Medicare/Coding/ICD10/Downloads/2012_PCS_long_and_abbreviated_titles.zip">2012_PCS_long_and_abbreviated_titles</a></li>' +
				'<li><a href="https://www.cms.gov/Medicare/Coding/ICD10/Downloads/ICD10OrderFiles_2012.zip">ICD10OrderFiles_2012</a></li>' +
				'</ol>' +
				'<p style="color:red">NOTE: Importing external data can take more than an hour depending on your hardware configuration. For example, one of the RxNorm data tables contain in excess of 6 million rows.</p>'
		}
		else if(action == 'RXNORM'){
			return '<p>Steps to install the RxNorm data:</p>' +
				'<ol>' +
				'<li>The first step is to open an account with the Unified Medical Language System web site <a href="https://utslogin.nlm.nih.gov/cas/login">here</a></li>' +
				'<li>Then the raw data feed release can be obtained from <a href="http://www.nlm.nih.gov/research/umls/rxnorm/docs/rxnormfiles.html">this location</a></li>' +
				'<li>Upload the downloaded .zip file, or place the downloaded RxNorm database zip file into the following directory: contrib/rxnorm.</li>' +
				'<li>Double Click the zip file from the "Available RxNorm Data" grid to install</li>' +
				'</ol>' +
				'<p style="color:red">NOTE: Only the full monthly RxNorm release is currently supported</p>'
		}
		else if(action == 'SNOMED'){
			return 'Lorem ipsum dolor sit amet, porta nam suscipit sed id, ' +
				'vestibulum velit tortor velit viverra, non enim justo, ' +
				'purus nec, libero sociis lobortis, eu et leo mauris velit. ' +
				'Magnis tellus blandit fringilla, morbi mauris commodo, nec morbi ac non'
		}
		else if(action == 'HCPCS'){
			return '<p>Steps to install the HCPCS data:</p>' +
				'<ol>' +
				'<li>The raw data feed release can be obtained from <a href="http://www.cms.gov/Medicare/Coding/HCPCSReleaseCodeSets/Alpha-Numeric-HCPCS.html">this location</a></li>' +
				'<li>Upload the downloaded .zip file, or place the downloaded zip files into the following directory: contrib/hcpcs</li>' +
				'<li>Double Click the zip file from the "Available HCPCS Data" grid to install</li>' +
				'</ol>' +
				'<p>These is the HCPCS 2013 direct link:</p>' +
				'<ol>' +
				'<li><a href="http://www.cms.gov/Medicare/Coding/HCPCSReleaseCodeSets/Downloads/13anweb.zip">13anweb</a></li>' +
				'</ol>' +
				'<p style="color:red">NOTE: Importing external data can take more than an hour depending on your hardware configuration.</p>'
		}

	},

	uploadFile: function(btn){
		var me = this, form = btn.up('form').getForm();
		if(form.isValid()){
			form.submit({
				waitMsg: _('uploading_and_updating_code_database') + '...',
				scope: me,
				params: {
					codeType: btn.action
				},
				success: function(fp, o){
					//say(o.result);
				},
				failure: function(fp, o){
					//say(o.result);
				}
			});
		}
	},

	onCodeDblClick: function(grid, record){
		var me = this,
			log = app.log;

		log.ActivityMonitor(false);
		grid.el.mask(_('installing_database_please_wait') + '...');
		ExternalDataUpdate.updateCodes(record.data, function(provider, response){
			grid.el.unmask();
			if(response.result.success){
				me.setCurrentCodesInfo();
				me.alert(_('new_database_installed'), 'info');
			}
			else{
				me.alert(response.result.error, 'error');
			}
			log.ActivityMonitor(true);
		});
	},

	setCurrentCodesInfo: function(){
		var me = this, codes, fieldset;
		ExternalDataUpdate.getCurrentCodesInfo(function(provider, response){
			codes = response.result;
			for(var i = 0; i < codes.length; i++){
				if(codes[i].data !== false){
					fieldset = me.query('fieldset[action="' + codes[i].data.codeType + '"]')[0];
					fieldset.update(codes[i].data);
				}
			}
		});
	},

	loadStores: function(){
		var me = this;
		for(var i = 0; i < me.stores.length; i++){
			me.stores[i].load({
				params: {
					pid: me.pid
				}
			});
		}
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		this.loadStores();
		this.setCurrentCodesInfo();
		callback(true);
	}
});

Ext.define('App.view.administration.PreventiveCare',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelPreventiveCare',
	pageTitle : _('preventive_care'),
	uses : ['Ext.grid.Panel', 'App.ux.combo.CodesTypes', 'App.ux.combo.Titles'],
	initComponent : function()
	{
		var me = this;

		me.active = 1;
		me.dataQuery = '';
		me.category_id = '3';

		me.store = Ext.create('App.store.administration.PreventiveCare');
		me.activeProblemsStore = Ext.create('App.store.administration.PreventiveCareActiveProblems');
		me.medicationsStore = Ext.create('App.store.administration.PreventiveCareMedications');
		me.labsStore = Ext.create('App.store.administration.PreventiveCareLabs');

		function code_type(val)
		{
			if (val == '1')
			{
				return 'CPT4';
			}
			else
			if (val == '2')
			{
				return 'ICD9';
			}
			else
			if (val == '3')
			{
				return 'HCPCS';
			}
			else
			if (val == '100')
			{
				return 'CVX';
			}
			return val;
		}


		me.guidelineGrid = Ext.create('Ext.grid.Panel',
		{
			region : 'center',
			store : me.store,
			columns : [
			{
				xtype : 'actioncolumn',
				width : 30,
				items : [
				{
					icon : 'resources/images/icons/delete.png',
					tooltip : _('remove'),
					handler : function(grid, rowIndex, colIndex)
					{
						var rec = grid.getStore().getAt(rowIndex);
					},
					getClass : function()
					{
						return 'x-grid-icon-padding';
					}
				}]
			},

			{
				flex : 1,
				header : _('description'),
				sortable : true,
				dataIndex : 'description'
			},
			{
				width : 100,
				header : _('age_start'),
				sortable : true,
				dataIndex : 'age_start'
			},
			{
				width : 100,
				header : _('age_end'),
				sortable : true,
				dataIndex : 'age_end'
			},
			{
				width : 100,
				header : _('sex'),
				sortable : true,
				dataIndex : 'sex'
			},
			{
				width : 100,
				header : _('frequency'),
				sortable : true,
				dataIndex : 'frequency'
			}],
			plugins : Ext.create('App.ux.grid.RowFormEditing',
			{
				autoCancel : false,
				errorSummary : false,
				clicksToEdit : 1,
				listeners :
				{
					scope : me,
					beforeedit : me.beforeServiceEdit,
					edit : me.onServiceEdit,
					canceledit : me.onServiceCancelEdit

				},
				items : [
				{
					/**
					 * CVX Container
					 */
					xtype : 'tabpanel',
					action : _('immunizations'),
					layout : 'fit',
					plain : true,
					listeners :
					{
						scope : me,
						tabchange : me.onFormTapChange
					},
					items : [
					{
						title : _('general'),
						xtype : 'container',
						padding : 10,
						layout : 'vbox',
						items : [
						{
							/**
							 * line One
							 */
							xtype : 'fieldcontainer',
							layout : 'hbox',
							defaults :
							{
								margin : '0 10 5 0',
								action : 'field'
							},
							items : [
							{

								xtype : 'textfield',
								fieldLabel : _('description'),
								name : 'description',
								labelWidth : 130,
								width : 703
							},
							{
								xtype : 'gaiaehr.sexcombo',
								fieldLabel : _('sex'),
								name : 'sex',
								width : 100,
								labelWidth : 30

							},
							{
								fieldLabel : _('active'),
								xtype : 'checkboxfield',
								labelWidth : 75,
								name : 'active'
							}]
						},
						{
							/**
							 * Line two
							 */
							xtype : 'fieldcontainer',
							layout : 'hbox',
							defaults :
							{
								margin : '0 10 5 0',
								action : 'field'
							},
							items : [
							{
								xtype : 'mitos.codestypescombo',
								fieldLabel : _('coding_system'),
								labelWidth : 130,
								value : 'CVX',
								name : 'coding_system',
								readOnly : true

							},
							{
								xtype : 'numberfield',
								fieldLabel : _('frequency'),
								margin : '0 0 5 0',
								value : 0,
								minValue : 0,
								width : 150,
								name : 'frequency'

							},
							{
								xtype : 'mitos.timecombo',
								name : 'frequency_time',
								width : 100

							},
							{
								xtype : 'numberfield',
								fieldLabel : _('age_start'),
								name : 'age_start',
								labelWidth : 75,
								width : 140,
								value : 0,
								minValue : 0

							},
							{
								fieldLabel : _('must_be_pregnant'),
								xtype : 'checkboxfield',
								labelWidth : 105,
								name : 'pregnant'

							}]

						},
						{
							/**
							 * Line three
							 */
							xtype : 'fieldcontainer',
							layout : 'hbox',
							defaults :
							{
								margin : '0 10 5 0',
								action : 'field'
							},
							items : [
							{
								xtype : 'textfield',
								fieldLabel : _('code'),
								name : 'code',
								labelWidth : 130
							},
							{
								xtype : 'numberfield',
								fieldLabel : _('times_to_perform'),
								name : 'times_to_perform',
								width : 250,
								value : 0,
								minValue : 0,
								tooltip : _('greater_than_1_or_just_check_perform_once')

							},
							{

								xtype : 'numberfield',
								fieldLabel : _('age_end'),
								name : 'age_end',
								labelWidth : 75,
								width : 140,
								value : 0,
								minValue : 0

							},
							{
								fieldLabel : _('perform_only_once'),
								xtype : 'checkboxfield',
								labelWidth : 105,
								name : 'only_once'
							}]

						}]
					},
					{
						title : _('active_problems'),
						action : 'problems',
						xtype : 'grid',
						margin : 5,
						store : me.activeProblemsStore,
						columns : [

						{
							xtype : 'actioncolumn',
							width : 20,
							items : [
							{
								icon : 'resources/images/icons/delete.png',
								tooltip : _('remove'),
								scope : me,
								handler : me.onRemoveRelation
							}]
						},
						{
							header : _('code'),
							width : 100,
							dataIndex : 'code'
						},
						{
							header : _('description'),
							flex : 1,
							dataIndex : 'code_text'
						}],
						bbar :
						{
							xtype : 'liveicdxsearch',
							margin : 5,
							fieldLabel : _('add_problem'),
							hideLabel : false,
							listeners :
							{
								scope : me,
								select : me.addActiveProblem
							}
						}
					},
					{
						title : _('medications'),
						action : 'medications',
						xtype : 'grid',
						width : 300,
						store : me.medicationsStore,
						columns : [
						{
							xtype : 'actioncolumn',
							width : 20,
							items : [
							{
								icon : 'resources/images/icons/delete.png',
								tooltip : _('remove'),
								scope : me,
								handler : me.onRemoveRelation
							}]
						},
						{
							header : _('code'),
							width : 100,
							dataIndex : 'code'
						},
						{
							header : _('description'),
							flex : 1,
							dataIndex : 'code_text'
						}],
						bbar :
						{
							xtype : 'rxnormlivetsearch',
							margin : 5,
							fieldLabel : _('add_problem'),
							hideLabel : false,
							listeners :
							{
								scope : me,
								select : me.addMedications
							}
						}
					},
					{
						title : _('labs'),
						action : 'labs',
						xtype : 'grid',
						store : me.labsStore,
						width : 300,
						columns : [
						{
							xtype : 'actioncolumn',
							width : 20,
							items : [
							{
								icon : 'resources/images/icons/delete.png',
								tooltip : _('remove'),
								scope : me,
								handler : me.onRemoveRelation
							}]
						},
						{
							header : _('value_name'),
							flex : 1,
							dataIndex : 'value_name'
						},
						{
							header : _('less_than'),
							flex : 1,
							dataIndex : 'less_than',
							editor :
							{
								xtype : 'numberfield'
							}
						},
						{
							header : _('greater_than'),
							flex : 1,
							dataIndex : 'greater_than',
							editor :
							{
								xtype : 'numberfield'
							}
						},
						{
							header : _('equal_to'),
							flex : 1,
							dataIndex : 'equal_to',
							editor :
							{
								xtype : 'numberfield'
							}
						}],

						plugins : Ext.create('Ext.grid.plugin.CellEditing',
						{
							autoCancel : true,
							errorSummary : false,
							clicksToEdit : 2,
							listeners :
							{
								scope : me,
								edit : me.afterLabTimeEdit

							}
						}),
						bbar :
						{
							xtype : 'labslivetsearch',
							margin : 5,
							fieldLabel : _('add_labs'),
							hideLabel : false,
							listeners :
							{
								scope : me,
								select : me.addLabs
							}
						}
					}]

				}]
			}),

			tbar : me.PagingToolbar = Ext.create('Ext.PagingToolbar',
			{
				store : me.store,
				displayInfo : true,
				emptyMsg : _('no_office_notes_to_display'),
				plugins : Ext.create('Ext.ux.SlidingPager',
				{
				}),
				items : ['-',
				{
					xtype : 'mitos.preventivecaretypescombo',
					width : 150,
					listeners :
					{
						scope : me,
						select : me.onCodeTypeSelect
					}
				}]
			})
		});
		// END GRID

		me.pageBody = [me.guidelineGrid];
		me.callParent(arguments);
	},

	onServiceEdit : function(context, e)
	{

	},

	onServiceCancelEdit : function(context, e)
	{

	},

	afterLabTimeEdit : function(editor, e)
	{

	},

	beforeServiceEdit : function(context, e)
	{
		var editor = context.editor, grids = editor.query('grid');
		for (var i = 0; i < grids.length; i++)
		{
			grids[i].store.load(
			{
				params :
				{
					id : e.record.data.id
				}
			});
		}
	},

	onFormTapChange : function(panel, newCard, oldCard)
	{
		//say(newCard);
		//this.ImmuRelationStore.proxy.extraParams = { code_type: newCard.action, selected_id:this.getSelectId() };
		//this.ImmuRelationStore.load();
	},

	//	onSearch: function(field) {
	//		var me = this,
	//			store = me.store;
	//		me.dataQuery = field.getValue();
	//
	//		store.proxy.extraParams = {active: me.active, code_type: me.code_type, query: me.dataQuery};
	//		me.store.load();
	//	},

	onCodeTypeSelect : function(combo, record)
	{
		var me = this;
		me.category_id = record[0].data.option_value;
		if (me.category_id == 'dismiss')
		{

		}
		else
		{
			me.PagingToolbar.moveFirst();
			//            me.store.proxy.pageParam = 1;
			//            me.store.proxy.startParam = 0;
			me.store.proxy.extraParams =
			{
				category_id : me.category_id
			};
			me.store.load();
		}
	},

	//	onNew: function(form, model) {
	//		form.getForm().reset();
	//		var newModel = Ext.ModelManager.create({}, model);
	//		form.getForm().loadRecord(newModel);
	//	},

	addActiveProblem : function(field, model)
	{

		this.activeProblemsStore.add(
		{
			code : model[0].data.code,
			code_text : model[0].data.code_text,
			guideline_id : this.getSelectId()
		});
		field.reset();
	},
	addMedications : function(field, model)
	{
		this.medicationsStore.add(
		{

			code : model[0].data.id,
			code_text : model[0].data.PROPRIETARYNAME,
			guideline_id : this.getSelectId()
		});
		field.reset();

	},
	addLabs : function(field, model)
	{

		this.labsStore.add(
		{
			code : model[0].data.loinc_number,
			value_name : model[0].data.loinc_name,
			less_than : '0',
			greater_than : '0',
			equal_to : '0',
			preventive_care_id : this.getSelectId()
		});
		field.reset();

	},

	onRemoveRelation : function(grid, rowIndex, colIndex)
	{
		var me = this, store = grid.getStore(), record = store.getAt(rowIndex);
		store.remove(record);
	},

	getSelectId : function()
	{
		var row = this.guidelineGrid.getSelectionModel().getLastSelected();
		return row.data.id;
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		this.guidelineGrid.query('combobox')[0].setValue(this.category_id);
		this.store.proxy.extraParams =
		{
			category_id : this.category_id
		};
		this.store.load();
		callback(true);
	}
});
//ens servicesPage class

Ext.define('App.model.administration.AclGroup', {
	extend: 'Ext.data.Model',
	table: {
		name: 'acl_groups'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ACL.getAclGroups',
			create: 'ACL.addAclGroup',
			update: 'ACL.updateAclGroup'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.store.administration.AclGroups', {
    model: 'App.model.administration.AclGroup',
    extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.TransactionLog', {
    extend: 'App.ux.RenderPanel',
    xtype: 'TransactionLogPanel',
    pageLayout: 'border',
    pageTitle: _('transaction_log'),
	itemId: 'TransactionLogPanel',
	requires: [
		'App.ux.LivePatientSearch',
		'App.ux.LiveUserSearch'
	],
    initComponent: function() {
        var me = this;

        me.transactionLogStore = Ext.create('App.store.administration.TransactionLog', {
            remoteFilter: true,
            remoteSort: true
        });

        me.auditLogStore = Ext.create('App.store.administration.AuditLogs', {
            remoteFilter: true,
            remoteSort: true
        });

        me.pageBody = [
            {
                xtype: 'form',
                itemId: 'TransactionLogFilterFormPanel',
                region: 'west',
                width: 250,
                autoScroll: true,
	            collapsible: true,
	            split: true,
                border: true,
                bodyPadding: 10,
                title: _('filters'),
                items:[
                    {
                        xtype: 'fieldcontainer',
                        layout: 'column',
                        fieldLabel: _('from_date'),
                        labelAlign: 'top',
                        items: [
                            {
                                xtype: 'datefield',
                                name: 'begin_date',
                                columnWidth:.5,
                                hideLabel: true,
                                emptyText:  _('begin_date'),
                                allowBlank: true,
                                format: g('date_display_format'),
                                submitFormat: 'Y-m-d',
                                value: new Date()
                            },
                            {
                                xtype: 'timefield',
                                name: 'begin_time',
                                hideLabel: true,
                                emptyText:  _('begin_time'),
                                increment: 30,
                                columnWidth:.5,
                                format: 'H:i:s',
                                submitFormat: 'H:i:s',
                                value: '00:00:00'
                            }
                        ]
                    },
                    {
                        xtype: 'fieldcontainer',
                        layout: 'column',
                        fieldLabel: _('to_date'),
                        labelAlign: 'top',
                        items: [
                            {
                                xtype: 'datefield',
                                name: 'end_date',
                                columnWidth:.5,
                                hideLabel: true,
                                emptyText:  _('end_date'),
                                allowBlank: true,
                                format: g('date_display_format'),
                                submitFormat: 'Y-m-d',
                                value: new Date()
                            },
                            {
                                xtype: 'timefield',
                                name: 'end_time',
                                hideLabel: true,
                                emptyText:  _('end_time'),
                                increment: 30,
                                columnWidth:.5,
                                format: 'H:i:s',
                                submitFormat: 'H:i:s',
                                value: '23:00:00'
                            }
                        ]
                    },
	                {
		                xtype: 'tablelist',
		                fieldLabel: _('table'),
		                name: 'table_name',
		                labelAlign: 'top',
		                columnWidth: 1,
		                anchor: '100%',
		                enableReset: true
	                },
	                {
		                xtype: 'eventlist',
		                fieldLabel: _('event_type'),
		                labelAlign: 'top',
		                name: 'event_type',
		                columnWidth: 1,
		                anchor: '100%',
		                enableReset: true
	                },
	                {
		                xtype: 'userlivetsearch',
		                fieldLabel: _('user'),
		                labelAlign: 'top',
		                hideLabel: false,
		                name: 'uid',
		                anchor: '100%'
	                },
	                {
		                xtype: 'patienlivetsearch',
		                fieldLabel: _('patient'),
		                labelAlign: 'top',
		                hideLabel: false,
		                name: 'pid',
		                anchor: '100%',
		                resetEnabled: true
	                }
                ],
                bbar: [
                	{
	                    xtype: 'button',
	                    text: _('search'),
		                flex: 1,
	                    itemId: 'TransactionLogFilterSearchBtn'
	                }
                ]
            },
            {
                xtype: 'tabpanel',
                //layout: 'fit',
                itemId: 'TransactionLogTabPanel',
                region: 'center',
                items: [
                    {
                        // Transaction Log Grid
                        xtype: 'grid',
                        itemId: 'TransactionLogDataGrid',
                        store: me.transactionLogStore,
                        region: 'center',
                        border: true,
                        title: _('transaction_log'),
                        dockedItems: [
                            {
                                xtype: 'pagingtoolbar',
                                store: me.transactionLogStore,
                                dock: 'bottom',
                                displayInfo: true
                            }
                        ],
                        columns: [
                            {
                                xtype:'datecolumn',
                                text: 'Date',
                                format:'Y-m-d H:i:s',
                                dataIndex: 'date',
                                width: 250
                            },
                            {
                                text: 'Patient',
                                dataIndex: 'patient_lname',
                                flex: 1,
                                renderer: function (v, meta,rec) {
                                    return rec.get('patient_name');
                                }
                            },
                            {
                                text: 'User',
                                dataIndex: 'user_lname',
                                flex: 1,
                                renderer: function (v, meta,rec) {
                                    return rec.get('user_name');
                                }
                            },
                            {
                                text: 'Category',
                                dataIndex: 'category',
                                flex: 1
                            },
                            {
                                text: 'Event',
                                dataIndex: 'event',
                                flex: 1
                            },
                            {
                                text: 'Pk',
                                dataIndex: 'pk'
                            },
                            {
                                text: 'Table',
                                dataIndex: 'table_name',
                                flex: 1
                            },
                            {
                                text: 'IP',
                                dataIndex: 'ip',
                                flex: 1
                            }
                        ]
                    },
                    // Audit Log Grid
                    {
                        xtype: 'grid',
                        itemId: 'AuditLogDataGrid',
                        store: me.auditLogStore,
                        region: 'center',
                        border: true,
                        title: _('audit_log'),
                        dockedItems: [
                            {
                                xtype: 'pagingtoolbar',
                                store: me.auditLogStore,
                                dock: 'bottom',
                                displayInfo: true
                            }
                        ],
                        columns: [
                            {
                                xtype:'datecolumn',
                                text: 'Date',
                                format:'Y-m-d H:i:s',
                                dataIndex: 'event_date',
                                width: 250
                            },
                            {
                                text: 'Patient',
                                dataIndex: 'patient_lname',
                                flex: 1,
                                renderer: function (v, meta,rec) {
                                    return rec.get('patient_name');
                                }
                            },
                            {
                                text: 'User',
                                dataIndex: 'user_lname',
                                flex: 1,
                                renderer: function (v, meta,rec) {
                                    return rec.get('user_name');
                                }
                            },
                            {
                                text: 'Event',
                                dataIndex: 'event',
                                flex: 1
                            },
                            {
                                text: 'Event Description',
                                dataIndex: 'event_description',
                                flex: 1
                            },
                            {
                                text: 'Foreign Pk',
                                dataIndex: 'foreign_id'
                            },
                            {
                                text: 'Foreign Table',
                                dataIndex: 'foreign_table',
                                flex: 1
                            },
                            {
                                text: 'IP',
                                dataIndex: 'ip',
                                flex: 1
                            }
                        ]
                    }
                ]
            }

            // {
            //     xtype: 'grid',
            //     itemId: 'TransactionLogDataGrid',
            //     store: me.transactionLogStore,
            //     region: 'center',
	        //     border: true,
	        //     title: _('results'),
            //     dockedItems: [
            //         {
            //             xtype: 'pagingtoolbar',
            //             store: me.transactionLogStore,
            //             dock: 'bottom',
            //             displayInfo: true
            //         }
            //     ],
            //     columns: [
	        //         {
		    //             text: 'Date',
		    //             dataIndex: 'date',
		    //             width: 250
	        //         },
            //         {
            //             text: 'Patient',
            //             dataIndex: 'patient_lname',
	        //             flex: 1,
	        //             renderer: function (v, meta,rec) {
		    //                 return rec.get('patient_name');
	        //             }
            //         },
            //         {
            //             text: 'User',
            //             dataIndex: 'user_lname',
	        //             flex: 1,
	        //             renderer: function (v, meta,rec) {
		    //                 return rec.get('user_name');
	        //             }
            //         },
            //         {
            //             text: 'Category',
            //             dataIndex: 'category',
	        //             flex: 1
            //         },
            //         {
            //             text: 'Event',
	        //             dataIndex: 'event',
	        //             flex: 1
            //         },
            //         {
            //             text: 'Pk',
            //             dataIndex: 'pk'
            //         },
            //         {
            //             text: 'Table',
            //             dataIndex: 'table_name',
	        //             flex: 1
            //         },
            //         {
            //             text: 'IP',
            //             dataIndex: 'ip',
	        //             flex: 1
            //         }
            //     ]
            // }
        ];

        me.callParent(arguments);

    }

});

Ext.define('App.view.administration.CronJob', {
    extend: 'App.ux.RenderPanel',
    requires: [
        'Ext.grid.plugin.RowEditing'
    ],
    xtype: 'cronjobpanel',
    itemId: 'CronJobPanel',
    border: false,
    pageLayout: {
        type: 'vbox',
        align: 'stretch'
    },
    pageTitle: _('cronjobs'),
    initComponent: function() {
        var me = this;

        me.CronJobStore = Ext.create('App.store.administration.CronJob', {
            remoteFilter: false,
            autoLoad: false,
            autoSync: false,
            pageSize: 100
        });

        me.pageBody = [
            {
                xtype: 'grid',
                flex: 1,
                frame: true,
                title: _('cronjobs_available'),
                itemId: 'CronJobGrid',
                columnLines: true,
                store: me.CronJobStore,
                selType: 'rowmodel',
                plugins: {
                    ptype: 'rowediting',
                    clicksToEdit: 2
                },
                columns: [
                    {
                        text: _('name'),
                        dataIndex: 'name',
                        flex: 1
                    },
                    {
                        text: _('minute'),
                        dataIndex: 'minute',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"',
	                        validator: function (v) {
		                        if(v < 0 || v > 59){
			                        return 'Minute (0 - 59)';
		                        }
		                        return true;
	                        }
                        }
                    },
                    {
                        text: _('hour'),
                        dataIndex: 'hour',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"',
	                        validator: function (v) {
		                        if(v < 0 || v > 23){
			                        return 'Hour (0 - 23)';
		                        }
		                        return true;
	                        }

                        }
                    },
                    {
                        text: _('month_day'),
                        dataIndex: 'month_day',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"',
	                        validator: function (v) {
		                        if(v < 1 || v > 31){
			                        return 'Day of month (1 - 31)';
		                        }
		                        return true;
	                        }
                        }
                    },
                    {
                        text: _('month'),
                        dataIndex: 'month',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"',
	                        validator: function (v) {
		                        if(v < 1 || v > 12){
			                        return 'Month (1 - 12)';
		                        }
		                        return true;
	                        }
                        }
                    },
                    {
                        text: _('week_day'),
                        dataIndex: 'week_day',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"',
	                        validator: function (v) {
                                if(v < 0 || v > 7){
                                    return 'Day of week (0 - 7) (Sunday=0 or 7)';
                                }
                                return true;
	                        }
                            
                        }
                    },
                    {
                        text: _('timeout'),
                        dataIndex: 'timeout',
                        align: 'center',
                        editor: {
                            xtype: 'numberfield',
                            allowBlank: false,
	                        inputAttrTpl: 'style="text-align:center"'
                        }
                    },
                    {
                        text: _('parameters'),
                        dataIndex: 'params',
                        align: 'center',
                        editor: {
                            xtype: 'textfield',
                            inputAttrTpl: 'style="text-align:center"'
                        }
                    },
                    {
                        text: _('elapsed'),
                        dataIndex: 'elapsed',
                        align: 'center'
                    },
                    {
                        text: _('pid'),
                        dataIndex: 'pid',
                        align: 'center'
                    },
                    {
                        text: _('running'),
                        dataIndex: 'running',
                        renderer: me.boolRenderer,
                        align: 'center'
                    },
                    {
                        text: _('active'),
                        dataIndex: 'active',
                        renderer: me.boolRenderer,
                        align: 'center',
                        editor: {
                            xtype: 'checkboxfield'
                        }
                    }
                ],
                tbar: [
                    '->',
                    {
                        xtype: 'button',
                        text: _('kill_process'),
                        itemId: 'CronJobPanelKillProcessBtn',
                        cls: 'btnRedBackground'
                    }
                ],
                bbar: {
                    xtype: 'pagingtoolbar',
                    pageSize: 100,
                    store: me.CronJobStore ,
                    displayInfo: true,
                    plugins: new Ext.ux.SlidingPager()
                }
            }
        ];

        me.callParent(arguments);

    }

});

Ext.define('App.view.miscellaneous.Amendments', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'Ext.ux.SlidingPager'
	],
	itemId: 'AmendmentsPanel',
	pageTitle: _('amendments'),

	initComponent: function(){

		var me = this;

		me.controller = App.app.getController('miscellaneous.Amendments');

		me.pageBody = [
			{
				xtype:'grid',
				itemId: 'AmendmentsGrid',
				store: me.store = Ext.create('App.store.miscellaneous.Amendments',{
					remoteFilter: true,
					remoteSort: true,
					sorters:[
						{
							property: 'cancel_date',
							direction: 'DESC'
						}
					]
				}),
				columns:[
					{
						text: _('type'),
						width: 70,
						dataIndex: 'amendment_type',
						renderer: function(v, meta, record){
							var str;

							if(v === 'P'){
								str = _('patient');
							}else if(v === 'G'){
								str = _('guardian');
							}else if(v === 'E'){
								str = _('emergency_contact');
							}else if(v === 'D'){
								str = _('doctor');
							}else if(v === 'O'){
								str = _('organization');
							}else{
								str = v;
							}

							return me.newRenderer(str, meta, record);
						}
					},
					{
						text: _('dates'),
						columns: [
							{
								text: _('received'),
								width: 140,
								dataIndex: 'create_date',
								renderer: me.dateNewRenderer
							},
							{
								text: _('appended'),
								width: 140,
								dataIndex: 'create_date',
								renderer: me.dateNewRenderer
								// renderer: function(v, meta, record){
								// 	if(record.get('amendment_status') === 'A'){
								// 		return me.dateNewRenderer(v, meta, record);
								// 	}else{
								// 		return me.dateNewRenderer(null, meta, record);
								// 	}
								// }
							},
							{
								text: _('responded'),
								width: 140,
								dataIndex: 'response_date',
								renderer: me.dateNewRenderer
							}
						]
					},
					{
						text: _('message'),
						flex: 1,
						dataIndex: 'amendment_message',
						renderer: me.newRenderer
					},
					{
						text: _('response_message'),
						flex: 1,
						dataIndex: 'response_message',
						renderer: me.newRenderer
					},
					{
						text: _('status'),
						width: 100,
						dataIndex: 'amendment_status',
						renderer: function(v, meta, record){
							var str;

							if(v === 'W'){
								str = _('waiting_response');
							}else if(v === 'A'){
								str = _('approved');
							}else if(v === 'D'){
								str = _('denied');
							}else if(v === 'C'){
								str = _('canceled');
							}else if(v === 'E'){
								str = _('error');
							}else{
								str = v;
							}

							me.controller.updateIsViewed(record);

							return me.newRenderer(str, meta, record);
						}
					},
					{
						text: _('approved_denied_by'),
						width: 200,
						dataIndex: 'responded_by',
						renderer: me.newRenderer
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 25,
					store: me.store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager()
				}
			}
		];

		me.callParent();
	},

	newRenderer: function(v, meta, record){
		if(!record.data.is_read){
			meta.style = 'font-weight:bold';
		}
		return v;
	},

	dateNewRenderer: function(v, meta, record){
		if(!record.data.is_read){
			meta.style = 'font-weight:bold';
		}
		return Ext.Date.format(v, g('date_time_display_format'));
	}

});

Ext.define('App.view.miscellaneous.OfficeNotes',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelOfficeNotes',
	pageTitle : _('office_notes'),
	pageLayout : 'border',
	initComponent : function()
	{
		var me = this;

		me.store = Ext.create('App.store.miscellaneous.OfficeNotes');

		me.form = Ext.create('Ext.form.FormPanel',
		{
			region : 'north',
			frame : true,
			height : 97,
			margin : '0 0 3 0',
			items : [
			{
				xtype : 'textareafield',
				allowBlank : false,
				grow : true,
				margin : 0,
				itemId : 'body',
				name : 'body',
				anchor : '100%',
				emptyText : _('type_new_note_here') + '...',
				listeners :
				{
					scope : me,
					validitychange : me.onValidityChange
				}
			}],
			dockedItems : [
			{
				xtype : 'toolbar',
				dock : 'top',
				items : [
				{
					text : _('save'),
					iconCls : 'save',
					itemId : 'cmdSave',
					disabled : true,
					scope : me,
					handler : me.onNoteSave
				}, '-',
				{
					text : _('hide_this_note'),
					iconCls : 'save',
					itemId : 'cmdHide',
					tooltip : _('hide_selected_office_note'),
					disabled : true,
					scope : me,
					handler : me.onNoteHide

				}, '-',
				{
					text : _('reset'),
					iconCls : 'save',
					itemId : 'cmdReset',
					disabled : true,
					scope : me,
					handler : me.onFormReset
				}]
			}]
		});

		me.grid = Ext.create('Ext.grid.Panel',
		{
			region : 'center',
			store : me.store,
			listeners :
			{
				scope : me,
				itemclick : me.onItemClick
			},
			columns : [
			{
				width : 150,
				header : _('date'),
				sortable : true,
				dataIndex : 'date',
				renderer : Ext.util.Format.dateRenderer('Y-m-d H:i:s')
			},
			{
				width : 150,
				header : _('user'),
				sortable : true,
				dataIndex : 'user'
			},
			{
				flex : 1,
				header : _('note'),
				sortable : true,
				dataIndex : 'body'
			}],
			tbar : Ext.create('Ext.PagingToolbar',
			{
				store : me.store,
				displayInfo : true,
				emptyMsg : _('no_office_notes_to_display'),
				plugins : Ext.create('Ext.ux.SlidingPager',
				{
				}),
				items : [
				{
					text : _('show_only_active_notes'),
					iconCls : 'save',
					enableToggle : true,
					pressed : true,
					handler : function()
					{
						//me.cmdShowAll.toggle(false);
						me.store.load(
						{
							params :
							{
								show : 'active'
							}
						});
					}
				}, '-',
				{
					text : _('show_all_notes'),
					iconCls : 'save',
					enableToggle : true,
					handler : function()
					{
						//me.cmdShow.toggle(false);
						me.store.load(
						{
							params :
							{
								show : 'all'
							}
						});
					}
				}]
			})
		});
		// END GRID
		me.pageBody = [me.form, me.grid];
		me.callParent(arguments);
	},

	onNoteSave : function(btn)
	{
		var form = btn.up('form').getForm(), store = this.store, record = form.getRecord(), values = form.getValues(), storeIndex = store.indexOf(record);
		if (storeIndex == -1)
		{
			store.add(values);
		}
		else
		{
			record.set(values);
		}
		store.sync();
		//store.load();
	},

	onNoteHide : function()
	{

	},

	onFormReset : function(btn)
	{
		var panel = this.form, form = panel.getForm(), toolbar = panel.down('toolbar'), savebtn = toolbar.getComponent('cmdSave'), hidebtn = toolbar.getComponent('cmdHide'), resetbtn = toolbar.getComponent('cmdReset');
		form.reset();
		savebtn.disable();
		hidebtn.disable();
		resetbtn.disable();
		savebtn.setText('Save');
	},

	onItemClick : function(grid, record)
	{
		var panel = this.form, form = panel.getForm(), toolbar = panel.down('toolbar'), savebtn = toolbar.getComponent('cmdSave'), hidebtn = toolbar.getComponent('cmdHide'), resetbtn = toolbar.getComponent('cmdReset');
		form.reset();
		form.loadRecord(record);
		savebtn.enable();
		hidebtn.enable();
		resetbtn.enable();
		savebtn.setText('Update');
	},

	onValidityChange : function()
	{
		var panel = this.form, textfield = panel.getComponent('body'), toolbar = panel.down('toolbar'), savebtn = toolbar.getComponent('cmdSave'), resetbtn = toolbar.getComponent('cmdReset');

		if (textfield.isValid())
		{
			savebtn.enable();
			resetbtn.enable();
		}
		else
		{
			savebtn.disable();
		}
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		this.store.load(
		{
			params :
			{
				show : 'active'
			}
		});
		callback(true);
	}
});
//ens oNotesPage class

Ext.define('App.view.miscellaneous.Websearch',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelWebsearch',
	pageTitle : _('national_library'),
	pageLayout : 'border',
	uses : ['Ext.grid.Panel'],
	initComponent : function()
	{

		var page = this;
		var search_type;
        var term;
		var rec;
		if (!Ext.ModelManager.isRegistered('webSearch'))
		{
            page.store = Ext.create('App.store.miscellaneous.webSearch');
            page.codingStore = Ext.create('Ext.data.Store',
            {
                fields: ['search', 'name'],
                data :
                    [
                        {"search":"code", "name":"Code"},
                        {"search":"term", "name":"Term"}
                    ]
            });
		}

		page.searchPanel = Ext.create('Ext.panel.Panel',
		{
			region : 'north',
			bodyPadding : '8 11 5 11',
			margin : '0 0 2 0',
			layout : 'anchor',
			items : [
			{
				xtype : 'radiogroup',
				fieldLabel : _('search_by'),
				items : [
                    {
                        boxLabel : _('heath_topics'),
                        name : 'type',
                        inputValue : 'health_topics'
                    },
                    {
                        boxLabel : 'SNOMED CT',
                        name : 'type',
                        inputValue : 'snomed'
                    },
                    {
                        boxLabel : 'RxCUI',
                        name : 'type',
                        inputValue : 'rxcui'
                    },
                    {
                        boxLabel : 'LOINC',
                        name : 'type',
                        inputValue : 'loinc'
                    },
                    {
                        boxLabel : 'NDC',
                        name : 'type',
                        inputValue : 'ndc'
                    },
                    {
                        boxLabel : 'ICD-9-CM',
                        name : 'type',
                        inputValue : 'icd9cm'
                    }
				],
				listeners :
				{
					change : function()
					{
						var value = this.getValue();
						search_type = value.type;
						page.searchField.enable();
						page.searchField.reset();
					}
				}
			},
            page.termField = Ext.create('Ext.form.ComboBox',
            {
                name: 'term',
                fieldLabel: _('code_term') + ':',
                store: page.codingStore,
                anchor : '100%',
                queryMode: 'local',
                displayField: 'name',
                valueField: 'search',
                editable: false,
                listeners:
                {
                    change: function()
                    {
                        term = this.getValue();
                    }
                }
            }),
            page.searchField = Ext.create('Ext.form.field.Text',
			{
				emptyText : _('web_search') + '...',
				enableKeyEvents : true,
				hideLabel : true,
				anchor : '100%',
				disabled : true,
				listeners :
				{
					keyup : function()
					{
						var query = this.getValue();
						if (query.length > 2)
						{
							page.store.load(
							{
								params :
								{
									type: search_type,
									q: query,
                                    term: term
								}
							});
						}
					},
					buffer : 500,
					focus : function()
					{
						page.viewPanel.collapse();
					}
				}
			}
            )]
		});
		page.searchRow = function(value, p, record)
		{
			return Ext.String.format('<div class="topic"><span class="search_title">{0}</span><br><span class="search_source">{1}</span><br><span class="search_snippet" style="white-space: normal;">{2}</span></div>', value, record.get('source') || "Unknown", record.get('snippet') || "Unknown");
		};
		page.onotesGrid = Ext.create('Ext.grid.Panel',
		{
			margin : '0 0 2 0',
			region : 'center',
			store : page.store,
			viewConfig :
			{
				deferEmptyText : false,
				emptyText : '<p class="search_nothing_found" style="padding: 10px 0 0 20px; font-size: 24px">' + _('nothing_found') + '!</p>',
				stripeRows : true,
				loadingText : _('searching') + '... ' + _('please_wait')
			},
			columns : [
			{
				flex : 1,
				header : _('search_results'),
				sortable : true,
				dataIndex : 'title',
				renderer : page.searchRow
			},
			{
				hidden : true,
				sortable : true,
				dataIndex : 'source'
			},
			{
				hidden : true,
				sortable : true,
				dataIndex : 'snippet'
			}],
			tbar : Ext.create('Ext.PagingToolbar',
			{
				store : page.store,
				displayInfo : true,
				emptyMsg : _('nothing_to_display'),
				plugins : Ext.create('Ext.ux.SlidingPager',
				{
				})
			}),
			listeners :
			{
				itemclick : function(DataView, record, item, rowIndex)
				{
					rec = page.store.getAt(rowIndex);
					page.viewPanel.update(rec.data);
                    page.viewPanel.expand();
				}
			}
		});
		// END GRID
		page.viewPanel = Ext.create('Ext.panel.Panel',
		{
			region : 'south',
			height : 300,
			collapsible : true,
			collapsed : true,
			layout : 'fit',
			frame : true,
			bodyBorder : true,
			tpl : Ext.create('Ext.XTemplate', '<div class="search_container">', '<div class="search_data">', '<h3 class="search_title">' + _('title') + ': {title}</h3>', '<h4 class="search_source">' + _('source') + ': {source}</h4>', '</div>', '<div class="search_body">{FullSummary}</div>', '</div>')
		});

		page.pageBody = [page.searchPanel, page.onotesGrid, page.viewPanel];
		page.callParent(arguments);
        page.termField.select('code');
	}, // end of initComponent
	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		callback(true);
	}
});
//ens UserPage class

Ext.define('App.view.miscellaneous.MySettings',
{
	extend : 'App.ux.RenderPanel',
	id : 'panelMySettings',
	pageTitle : _('my_settings'),
	uses : ['Ext.grid.Panel'],
	initComponent : function()
	{
		var panel = this;
		// *************************************************************************************
		// User Settings Form
		// Add or Edit purpose
		// *************************************************************************************
		panel.uSettingsForm = Ext.create('App.ux.form.Panel',
		{
			id : 'uSettingsForm',
			bodyStyle : 'padding: 10px;',
			cls : 'form-white-bg',
			frame : true,
			hideLabels : true,
			items : [
			{
				xtype : 'textfield',
				hidden : true,
				id : 'id',
				name : 'id'
			},
			{
				xtype : 'fieldset',
				title : _('appearance_settings'),
				collapsible : true,
				defaultType : 'textfield',
				layout : 'anchor',
				defaults :
				{
					labelWidth : 89,
					anchor : '100%',
					layout :
					{
						type : 'hbox',
						defaultMargins :
						{
							top : 0,
							right : 5,
							bottom : 0,
							left : 0
						}
					}
				},
				items : [
				{
					// fields
				},
				{

				},
				{

				}]
			},
			{
				xtype : 'fieldset',
				title : _('locale_settings'),
				collapsible : true,
				defaultType : 'textfield',
				layout : 'anchor',
				defaults :
				{
					labelWidth : 89,
					anchor : '100%',
					layout :
					{
						type : 'hbox',
						defaultMargins :
						{
							top : 0,
							right : 5,
							bottom : 0,
							left : 0
						}
					}
				},
				items : [
				{
					// fields
				},
				{

				},
				{

				}]
			},
			{
				xtype : 'fieldset',
				title : _('calendar_settings'),
				collapsible : true,
				defaultType : 'textfield',
				layout : 'anchor',
				defaults :
				{
					labelWidth : 89,
					anchor : '100%',
					layout :
					{
						type : 'hbox',
						defaultMargins :
						{
							top : 0,
							right : 5,
							bottom : 0,
							left : 0
						}
					}
				},
				items : [
				{
					// fields
				},
				{

				},
				{

				}]
			}],
			dockedItems : [
			{
				xtype : 'toolbar',
				dock : 'top',
				items : [
				{
					text : _('save'),
					iconCls : 'save',
					id : 'cmdSave',
					disabled : true,
					handler : function()
					{

					}
				}]
			}]
		});
		panel.pageBody = [panel.uSettingsForm];
		panel.callParent(arguments);
	},
	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive : function(callback)
	{
		callback(true);
	}
});
// End ExtJS

Ext.define('App.view.signature.SignatureWindow', {
	extend      : 'Ext.window.Window',
	title       : _('please_sign'),
	closeAction : 'hide',
	height      : 250,
	width       : 500,
	bodyStyle   : 'background-color:#fff',
	modal       : true,
    layout		: 'fit',
	initComponent: function() {
		var me = this;

        me.html = me.signature = '<iframe id="svgSignature" src="app/view/signature/signature.svg" height="100%" width="100%" scrolling="no" frameborder="0"></iframe>';

        me.buttons = [
            {
                text: _('save'),
                scope:me,
                handler:me.signatureSave
            },
            {
                text: _('reset'),
                scope:me,
                handler:me.signatureCancel
            }
        ];

		this.callParent(arguments);

	},

    signatureSave:function(){
        var svg = document.getElementById('svgSignature').contentWindow;
    },

    signatureCancel:function(){
        var svg = document.getElementById('svgSignature').contentWindow;
        svg.clearSignature();
        //this.close();
    }



});

Ext.define('App.store.miscellaneous.AddressBook', {
	model: 'App.model.miscellaneous.AddressBook',
	extend: 'Ext.data.Store'
});
Ext.define('App.store.patient.CarePlanGoals', {
	extend: 'Ext.data.Store',
	requires: [
		'App.model.patient.CarePlanGoal'
	],
	model: 'App.model.patient.CarePlanGoal'
});
Ext.define('App.store.patient.PatientPossibleDuplicates', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientPossibleDuplicate'
});
Ext.define('App.store.patient.SmokeStatus', {
	extend: 'Ext.data.Store',
	requires:['App.model.patient.SmokeStatus'],
	model: 'App.model.patient.SmokeStatus',
	remoteFilter: true
});



Ext.define('App.store.patient.CognitiveAndFunctionalStatus', {
	extend: 'Ext.data.Store',
	requires: [
		'App.model.patient.CognitiveAndFunctionalStatus'
	],
	model: 'App.model.patient.CognitiveAndFunctionalStatus'
});
Ext.define('App.store.administration.Applications', {
    model: 'App.model.administration.Applications',
    extend: 'Ext.data.Store',
    autoSync: true,
    autoLoad: false
});
Ext.define('App.store.administration.DefaultDocuments',
{
	model : 'App.model.administration.DefaultDocuments',
	extend : 'Ext.data.Store',
	proxy :
	{
		type : 'direct',
		api :
		{
			read : DocumentHandler.getDefaultDocumentsTemplates,
			create : DocumentHandler.addDocumentsTemplates,
			update : DocumentHandler.updateDocumentsTemplates
		}
	},
	autoSync : true,
	autoLoad : false

}); 
Ext.define('App.store.administration.ActiveProblems',
{
	model : 'App.model.administration.ActiveProblems',
	extend : 'Ext.data.Store',
	proxy :
	{
		type : 'direct',
		api :
		{
			read : Services.getActiveProblems,
			create : Services.addActiveProblems,
			destroy : Services.removeActiveProblems
		},
		reader :
		{
			totalProperty : 'totals',
			root : 'rows'
		}
	},
	autoLoad : false
}); 
Ext.define('App.store.administration.Facility', {
    model: 'App.model.administration.Facility',
    extend: 'Ext.data.Store',
    proxy: {
        type: 'direct',
        api: {
            read: 'Facilities.getFacilities',
            create: 'Facilities.addFacility',
            update: 'Facilities.updateFacility',
            destroy: 'Facilities.deleteFacility'
        }
    }
});
Ext.define('App.store.administration.ExternalDataLoads',
	{
		model: 'App.model.administration.ExternalDataLoads',
		extend: 'Ext.data.Store',
		constructor: function(config){
			var me = this;
			me.proxy =
			{
				type: 'direct',
				api: {
					read: 'ExternalDataUpdate.getCodeFiles'
				},
				extraParams: {
					codeType: config.codeType
				}
			};
			me.callParent(arguments);
		},
		remoteSort: false,
		autoLoad: false
	});
Ext.define('App.store.administration.FloorPlans', {
	model: 'App.model.administration.FloorPlans',
	extend: 'Ext.data.Store',
	autoSync: false,
	autoLoad: false
}); 
Ext.define('App.store.administration.DocumentsTemplates', {
	model: 'App.model.administration.DocumentsTemplates',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'DocumentHandler.getDocumentsTemplates',
			create: 'DocumentHandler.addDocumentsTemplates',
			update: 'DocumentHandler.updateDocumentsTemplates'
		}
	},
	autoSync: true,
	autoLoad: false
}); 
Ext.define('App.store.administration.DocumentToken', {
    model: 'App.model.administration.DocumentToken',
    extend: 'Ext.data.Store',
    data: [
        {
            title: _('patient_id'),
            token: '[PATIENT_ID]'
        },
        {
            title: _('patient_record_number'),
            token: '[PATIENT_RECORD_NUMBER]'
        },
        {
            title: _('patient_name'),
            token: '[PATIENT_NAME]'
        },
        {
            title: _('patient_full_name'),
            token: '[PATIENT_FULL_NAME]'
        },
        {
            title: _('patient_mothers_maiden_name'),
            token: '[PATIENT_MAIDEN_NAME]'
        },
        {
            title: _('patient_last_name'),
            token: '[PATIENT_LAST_NAME]'
        },
        {
            title: _('patient_birthdate'),
            token: '[PATIENT_BIRTHDATE]'
        },
        {
            title: _('patient_marital_status'),
            token: '[PATIENT_MARITAL_STATUS]'
        },
        {
            title: _('patient_home_phone'),
            token: '[PATIENT_HOME_PHONE]'
        },
        {
            title: _('patient_mobile_phone'),
            token: '[PATIENT_MOBILE_PHONE]'
        },
        {
            title: _('patient_work_phone'),
            token: '[PATIENT_WORK_PHONE]'
        },
        {
            title: _('patient_email'),
            token: '[PATIENT_EMAIL]'
        },
        {
            title: _('patient_social_security'),
            token: '[PATIENT_SOCIAL_SECURITY]'
        },
        {
            title: _('patient_sex'),
            token: '[PATIENT_SEX]'
        },
        {
            title: _('patient_age'),
            token: '[PATIENT_AGE]'
        },
        {
            title: _('PATIENT_PHYSICAL_ADDRESS_LINE_ONE'),
            token: '[PATIENT_PHYSICAL_ADDRESS_LINE_ONE]'
        },
        {
            title: _('PATIENT_PHYSICAL_ADDRESS_LINE_TWO'),
            token: '[PATIENT_PHYSICAL_ADDRESS_LINE_TWO]'
        },
        {
            title: _('PATIENT_PHYSICAL_CITY'),
            token: '[PATIENT_PHYSICAL_CITY]'
        },
        {
            title: _('PATIENT_PHYSICAL_STATE'),
            token: '[PATIENT_PHYSICAL_STATE]'
        },
        {
            title: _('PATIENT_PHYSICAL_ZIP'),
            token: '[PATIENT_PHYSICAL_ZIP]'
        },
        {
            title: _('PATIENT_PHYSICAL_COUNTRY'),
            token: '[PATIENT_PHYSICAL_COUNTRY]'
        },
        {
            title: _('PATIENT_POSTAL_ADDRESS_LINE_ONE'),
            token: '[PATIENT_POSTAL_ADDRESS_LINE_ONE]'
        },
        {
            title: _('PATIENT_POSTAL_ADDRESS_LINE_TWO'),
            token: '[PATIENT_POSTAL_ADDRESS_LINE_TWO]'
        },
        {
            title: _('PATIENT_POSTAL_CITY'),
            token: '[PATIENT_POSTAL_CITY]'
        },
        {
            title: _('PATIENT_POSTAL_STATE'),
            token: '[PATIENT_POSTAL_STATE]'
        },
        {
            title: _('PATIENT_POSTAL_ZIP'),
            token: '[PATIENT_POSTAL_ZIP]'
        },
        {
            title: _('PATIENT_POSTAL_COUNTRY'),
            token: '[PATIENT_POSTAL_COUNTRY]'
        },
        {
            title: _('patient_tabacco'),
            token: '[PATIENT_TABACCO]'
        },
        {
            title: _('patient_alcohol'),
            token: '[PATIENT_ALCOHOL]'
        },
        {
            title: _('patient_drivers_license'),
            token: '[PATIENT_DRIVERS_LICENSE]'
        },
        {
            title: _('patient_employeer'),
            token: '[PATIENT_EMPLOYEER]'
        },
        {
            title: _('patient_first_emergency_contact'),
            token: '[PATIENT_FIRST_EMERGENCY_CONTACT]'
        },
        {
            title: _('patient_referral'),
            token: '[PATIENT_REFERRAL]'
        },
        {
            title: _('patient_date_referred'),
            token: '[PATIENT_REFERRAL_DATE]'
        },
        {
            title: _('patient_balance'),
            token: '[PATIENT_BALANCE]'
        },
        {
            title: _('patient_picture'),
            token: '[PATIENT_PICTURE]'
        },
        {
            title: _('patient_primary_plan'),
            token: '[PATIENT_PRIMARY_PLAN]'
        },
        {
            title: _('patient_primary_plan_insured_person'),
            token: '[PATIENT_PRIMARY_INSURED_PERSON]'
        },
        {
            title: _('patient_primary_plan_contract_number'),
            token: '[PATIENT_PRIMARY_CONTRACT_NUMBER]'
        },
        {
            title: _('patient_primary_plan_expiration_date'),
            token: '[PATIENT_PRIMARY_EXPIRATION_DATE]'
        },
        {
            title: _('patient_secondary_plan'),
            token: '[PATIENT_SECONDARY_PLAN]'
        },
        {
            title: _('patient_secondary_insured_person'),
            token: '[PATIENT_SECONDARY_INSURED_PERSON]'
        },
        {
            title: _('patient_secondary_plan_contract_number'),
            token: '[PATIENT_SECONDARY_CONTRACT_NUMBER]'
        },
        {
            title: _('patient_secondary_plan_expiration_date'),
            token: '[PATIENT_SECONDARY_EXPIRATION_DATE]'
        },
        {
            title: _('patient_referral_details'),
            token: '[PATIENT_REFERRAL_DETAILS]'
        },
        {
            title: _('patient_referral_reason'),
            token: '[PATIENT_REFERRAL_REASON]'
        },
        {
            title: _('patient_head_circumference'),
            token: '[PATIENT_HEAD_CIRCUMFERENCE]'
        },
        {
            title: _('patient_height'),
            token: '[PATIENT_HEIGHT]'
        },
        {
            title: _('patient_pulse'),
            token: '[PATIENT_PULSE]'
        },
        {
            title: _('patient_respiratory_rate'),
            token: '[PATIENT_RESPIRATORY_RATE]'
        },
        {
            title: _('patient_temperature'),
            token: '[PATIENT_TEMPERATURE]'
        },
        {
            title: _('patient_weight'),
            token: '[PATIENT_WEIGHT]'
        },
        {
            title: _('patient_pulse_oximeter'),
            token: '[PATIENT_PULSE_OXIMETER]'
        },
        {
            title: _('patient_blood_preasure'),
            token: '[PATIENT_BLOOD_PREASURE]'
        },
        {
            title: _('patient_body_mass_index'),
            token: '[PATIENT_BMI]'
        },
        {
            title: _('patient_active_allergies_list'),
            token: '[PATIENT_ACTIVE_ALLERGIES_LIST]'
        },
        {
            title: _('patient_inactive_allergies_list'),
            token: '[PATIENT_INACTIVE_ALLERGIES_LIST]'
        },
        {
            title: _('patient_active_medications_list'),
            token: '[PATIENT_ACTIVE_MEDICATIONS_LIST]'
        },
        {
            title: _('patient_inactive_medications_list'),
            token: '[PATIENT_INACTIVE_MEDICATIONS_LIST]'
        },
        {
            title: _('patient_active_problems_list'),
            token: '[PATIENT_ACTIVE_PROBLEMS_LIST]'
        },
        {
            title: _('patient_inactive_problems_list'),
            token: '[PATIENT_INACTIVE_PROBLEMS_LIST]'
        },
        {
            title: _('patient_active_immunizations_list'),
            token: '[PATIENT_ACTIVE_IMMUNIZATIONS_LIST]'
        },
        {
            title: _('patient_inactive_immunizations_list'),
            token: '[PATIENT_INACTIVE_IMMUNIZATIONS_LIST]'
        },
        {
            title: _('patient_active_dental_list'),
            token: '[PATIENT_ACTIVE_DENTAL_LIST]'
        },
        {
            title: _('patient_inactive_dental_list'),
            token: '[PATIENT_INACTIVE_DENTAL_LIST]'
        },
        {
            title: _('patient_active_surgery_list'),
            token: '[PATIENT_ACTIVE_SURGERY_LIST]'
        },
        {
            title: _('patient_inactive_surgery_list'),
            token: '[PATIENT_INACTIVE_SURGERY_LIST]'
        },
        {
            title: _('provider_id'),
            token: '[PROVIDER_ID]'
        },
        {
            title: _('provider_title'),
            token: '[PROVIDER_TITLE]'
        },
        {
            title: _('provider_full_name'),
            token: '[PROVIDER_FULL_NAME]'
        },
        {
            title: _('provider_first_name'),
            token: '[PROVIDER_FIRST_NAME]'
        },
        {
            title: _('provider_middle_name'),
            token: '[PROVIDER_MIDDLE_NAME]'
        },
        {
            title: _('provider_last_name'),
            token: '[PROVIDER_LAST_NAME]'
        },
        {
            title: _('provider_npi'),
            token: '[PROVIDER_NPI]'
        },
        {
            title: _('provider_lic'),
            token: '[PROVIDER_LIC]'
        },
        {
            title: _('provider_dea'),
            token: '[PROVIDER_DEA]'
        },
        {
            title: _('provider_state_drug_id'),
            token: '[PROVIDER_SDI]'
        },
        {
            title: _('provider_fed_tax'),
            token: '[PROVIDER_FED_TAX]'
        },
        {
            title: _('provider_ess'),
            token: '[PROVIDER_ESS]'
        },
        {
            title: _('provider_taxonomy'),
            token: '[PROVIDER_TAXONOMY]'
        },
        {
            title: _('provider_email'),
            token: '[PROVIDER_EMAIL]'
        },
        {
            title: _('provider_direct_address'),
            token: '[PROVIDER_DIRECT_ADDRESS]'
        },
        {
            title: _('provider_address_one'),
            token: '[PROVIDER_ADDRESS_LINE_ONE]'
        },
        {
            title: _('provider_address_two'),
            token: '[PROVIDER_ADDRESS_LINE_TWO]'
        },
        {
            title: _('provider_city'),
            token: '[PROVIDER_ADDRESS_CITY]'
        },
        {
            title: _('provider_state'),
            token: '[PROVIDER_ADDRESS_STATE]'
        },
        {
            title: _('provider_zip'),
            token: '[PROVIDER_ADDRESS_ZIP]'
        },
        {
            title: _('provider_country'),
            token: '[PROVIDER_ADDRESS_COUNTRY]'
        },
        {
            title: _('provider_phone'),
            token: '[PROVIDER_PHONE]'
        },
        {
            title: _('provider_mobile'),
            token: '[PROVIDER_MOBILE]'
        },
        {
            title: _('encounter_date'),
            token: '[ENCOUNTER_DATE]'
        },
        {
            title: _('encounter_subjective_part'),
            token: '[ENCOUNTER_SUBJECTIVE]'
        },
        {
            title: _('encounter_subjective_part'),
            token: '[ENCOUNTER_OBJECTIVE]'
        },
        {
            title: _('encounter_assessment'),
            token: '[ENCOUNTER_ASSESSMENT]'
        },
        {
            title: _('encounter_assessment_list'),
            token: '[ENCOUNTER_ASSESSMENT_LIST]'
        },
        {
            title: _('encounter_assessment_code_list'),
            token: '[ENCOUNTER_ASSESSMENT_CODE_LIST]'
        },
        {
            title: _('encounter_assessment_full_list'),
            token: '[ENCOUNTER_ASSESSMENT_FULL_LIST]'
        },
        {
            title: _('encounter_plan'),
            token: '[ENCOUNTER_PLAN]'
        },
        {
            title: _('encounter_medications'),
            token: '[ENCOUNTER_MEDICATIONS]'
        },
        {
            title: _('encounter_immunizations'),
            token: '[ENCOUNTER_IMMUNIZATIONS]'
        },
        {
            title: _('encounter_allergies'),
            token: '[ENCOUNTER_ALLERGIES]'
        },
        {
            title: _('encounter_active_problems'),
            token: '[ENCOUNTER_ACTIVE_PROBLEMS]'
        },
        {
            title: _('encounter_surgeries'),
            token: '[ENCOUNTER_SURGERIES]'
        },
        {
            title: _('encounter_dental'),
            token: '[ENCOUNTER_DENTAL]'
        },
        {
            title: _('encounter_laboratories'),
            token: '[ENCOUNTER_LABORATORIES]'
        },
        {
            title: _('encounter_procedures_terms'),
            token: '[ENCOUNTER_PROCEDURES_TERMS]'
        },
        {
            title: _('encounter_cpt_codes_list'),
            token: '[ENCOUNTER_CPT_CODES]'
        },
        {
            title: _('encounter_signature'),
            token: '[ENCOUNTER_SIGNATURE]'
        },
        {
            title: _('orders_laboratories'),
            token: '[ORDERS_LABORATORIES]'
        },
        {
            title: _('orders_x_rays'),
            token: '[ORDERS_XRAYS]'
        },
        {
            title: _('orders_referral'),
            token: '[ORDERS_REFERRAL]'
        },
        {
            title: _('orders_other'),
            token: '[ORDERS_OTHER]'
        },
        {
            title: _('order_date'),
            token: '[ORDER_DATE]'
        },
        {
            title: _('current_date'),
            token: '[CURRENT_DATE]'
        },
        {
            title: _('current_time'),
            token: '[CURRENT_TIME]'
        },
        {
            title: _('current_user_name'),
            token: '[CURRENT_USER_NAME]'
        },
        {
            title: _('current_user_full_name'),
            token: '[CURRENT_USER_FULL_NAME]'
        },
        {
            title: _('current_user_license_number'),
            token: '[CURRENT_USER_LICENSE_NUMBER]'
        },
        {
            title: _('current_user_dea_license_number'),
            token: '[CURRENT_USER_DEA_LICENSE_NUMBER]'
        },
        {
            title: _('current_user_dm_license_number'),
            token: '[CURRENT_USER_DM_LICENSE_NUMBER]'
        },
        {
            title: _('current_user_npi_license_number'),
            token: '[CURRENT_USER_NPI_LICENSE_NUMBER]'
        },
        {
            title: '',
            token: '[REFERRING_ID]'
        },
        {
            title: '',
            token: '[REFERRING_TITLE]'
        },
        {
            title: '',
            token: '[REFERRING_FULL_NAME]'
        },
        {
            title: '',
            token: '[REFERRING_FIRST_NAME]'
        },
        {
            title: '',
            token: '[REFERRING_MIDDLE_NAME]'
        },
        {
            title: '',
            token: '[REFERRING_LAST_NAME]'
        },
        {
            title: '',
            token: '[REFERRING_NPI]'
        },
        {
            title: '',
            token: '[REFERRING_LIC]'
        },
        {
            title: '',
            token: '[REFERRING_FED_TAX]'
        },
        {
            title: '',
            token: '[REFERRING_TAXONOMY]'
        },
        {
            title: '',
            token: '[REFERRING_EMAIL]'
        },
        {
            title: '',
            token: '[REFERRING_DIRECT_ADDRESS]'
        },
        {
            title: '',
            token: '[REFERRING_PHONE]'
        },
        {
            title: '',
            token: '[REFERRING_MOBILE]'
        },
        {
            title: '',
            token: '[REFERRING_FAX]'
        },
        {
            title: _('referral_id'),
            token: '[REFERRAL_ID]'
        },
	    {
            title: _('referral_date'),
            token: '[REFERRAL_DATE]'
        },
	    {
            title: _('referral_reason'),
            token: '[REFERRAL_REASON]'
        },
	    {
            title: _('referral_diagnosis'),
            token: '[REFERRAL_DIAGNOSIS]'
        },
	    {
            title: _('referral_service_request'),
            token: '[REFERRAL_SERVICE]'
        },
	    {
            title: _('referral_risk_level'),
            token: '[REFERRAL_RISK_LEVEL]'
        },
	    {
            title: _('referral_by'),
            token: '[REFERRAL_BY_TEXT]'
        },
	    {
            title: _('referral_to'),
            token: '[REFERRAL_TO_TEXT]'
        },
	    {
            title: _('rad_report_body'),
            token: '[REPORT_ACCESSIONS]'
        },
	    {
            title: _('report_body'),
            token: '[REPORT_BODY]'
        },
	    {
            title: _('report_interpreter'),
            token: '[REPORT_INTERPRETER]'
        },
	    {
            title: _('report_transcriptionist'),
            token: '[REPORT_TRANSCRIPTIONIST]'
        },
	    {
            title: _('report_signature'),
            token: '[REPORT_SIGNATURE]'
        },
	    {
            title: _('line'),
            token: '[LINE]'
        },
	    {
            title: _('time_now'),
            token: '[TIME_NOW]'
        }
    ]
});
Ext.define('App.store.administration.FloorPlanZones', {
	extend: 'Ext.data.Store',
	model: 'App.model.administration.FloorPlanZones'
});
Ext.define('App.store.administration.FormsList', {
    model: 'App.model.administration.FormsList',
    extend: 'Ext.data.Store',
    proxy: {
        type: 'direct',
        api: {
            read: 'FormLayoutBuilder.getForms',
            create: 'FormLayoutBuilder.addForms',
            update: 'FormLayoutBuilder.updateForms'
        }
    },
    autoSync: true,
    remoteSort: true,
    autoLoad: false
});
Ext.define('App.store.administration.Globals', {
	requires: [ 'App.model.administration.Globals' ],
    model: 'App.model.administration.Globals',
    extend: 'Ext.data.Store'
});
Ext.define('App.store.administration.ImmunizationRelations', {
	model: 'App.model.administration.ImmunizationRelations',
	extend: 'Ext.data.Store',
	autoLoad: false,
	autoSync: true,
	remoteSort: false

}); 
Ext.define('App.store.administration.HeadersAndFooters',
{
	model : 'App.model.administration.HeadersAndFooters',
	extend : 'Ext.data.Store',
	proxy :
	{
		type : 'direct',
		api :
		{
			read : DocumentHandler.getHeadersAndFootersTemplates,
			create : DocumentHandler.addDocumentsTemplates,
			update : DocumentHandler.updateDocumentsTemplates
		}
	},
	autoSync : true,
	autoLoad : false

}); 
Ext.define('App.store.administration.FormListOptions', {
    model: 'App.model.administration.FormListOptions',
    extend: 'Ext.data.Store',
    autoLoad: false
});
Ext.define('App.store.administration.LayoutTree', {
    model: 'App.model.administration.LayoutTree',
    extend: 'Ext.data.TreeStore',
    folderSort: false,
    autoLoad: false
});
Ext.define('App.store.administration.Lists', {
    model: 'App.model.administration.Lists',
    extend: 'Ext.data.Store',
	pageSize: 500,
	sorters: [
		{
			property: 'title',
			direction: 'ASC'
		}
	]
});
Ext.define('App.store.administration.ListOptions', {
    model: 'App.model.administration.ListOptions',
    extend: 'Ext.data.Store',
	pageSize:300,
	remoteSort: true,
	sorters: [
		{
			property: 'seq',
			direction: 'ASC'
		}
	]
});
Ext.define('App.store.administration.LabObservations', {
	model: 'App.model.administration.LabObservations',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'Laboratories.getLabObservations',
			create: 'Laboratories.addLabObservation',
			update: 'Laboratories.updateLabObservation',
			destroy: 'Laboratories.removeLabObservation'
		},
		writer: {
			writeAllFields: true
		}
	},
	autoSync: true,
	autoLoad: false
});
Ext.define('App.store.administration.Modules', {
    model: 'App.model.administration.Modules',
    extend: 'Ext.data.Store'
});
Ext.define('App.store.administration.Medications',{
	model : 'App.model.administration.Medications',
	extend : 'Ext.data.Store',
	buffered: true,
	leadingBufferZone: 100,
	pageSize: 50,
	remoteFilter: true
}); 
Ext.define('App.store.administration.PreventiveCareActiveProblems', {
	model: 'App.model.administration.PreventiveCareActiveProblems',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'PreventiveCare.getGuideLineActiveProblems',
			create: 'PreventiveCare.addGuideLineActiveProblems',
			destroy: 'PreventiveCare.removeGuideLineActiveProblems'
		}
	},
	remoteSort: false,
	autoLoad: false
});
Ext.define('App.store.administration.PreventiveCare', {
	model: 'App.model.administration.PreventiveCare',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'PreventiveCare.getGuideLinesByCategory',
			create: 'PreventiveCare.addGuideLine',
			update: 'PreventiveCare.updateGuideLine'
		},
		reader: {
			totalProperty: 'totals',
			root: 'rows'
		},
		extraParams: {
			code_type: this.code_type,
			query: this.query,
			active: this.active
		}
	},
	autoSync: true,
	remoteSort: false,
	autoLoad: false
});
Ext.define('App.store.administration.ParentFields', {
	model: 'App.model.administration.ParentFields',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'FormLayoutBuilder.getParentFields'
		}
	},
	autoLoad: false
});
Ext.define('App.store.administration.TransactionLog', {
	model: 'App.model.administration.TransactionLog',
	extend: 'Ext.data.Store'
});

Ext.define('App.store.administration.PreventiveCareMedications', {
	model: 'App.model.administration.PreventiveCareMedications',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'PreventiveCare.getGuideLineMedications',
			create: 'PreventiveCare.addGuideLineMedications',
			destroy: 'PreventiveCare.removeGuideLineMedications'
		}
	},
	remoteSort: false,
	autoLoad: false
}); 
Ext.define('App.store.administration.ProviderCredentializations', {
    model: 'App.model.administration.ProviderCredentialization',
    extend: 'Ext.data.Store'
});
Ext.define('App.store.administration.PreventiveCareLabs', {
	model: 'App.model.administration.PreventiveCareLabs',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'PreventiveCare.getGuideLineLabs',
			create: 'PreventiveCare.addGuideLineLabs',
			destroy: 'PreventiveCare.removeGuideLineLabs',
			update: 'PreventiveCare.updateGuideLineLabs'
		}
	},
	remoteSort: false,
	autoLoad: false
}); 
Ext.define('App.store.administration.EncounterEventHistory', {
    model: 'App.model.administration.EncounterEventHistory',
    extend: 'Ext.data.Store',
    autoLoad : false
});

Ext.define('App.store.administration.Services', {
	model: 'App.model.administration.Services',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'DataManager.getServices',
			create: 'DataManager.addService',
			update: 'DataManager.updateService'
		},
		reader: {
			totalProperty: 'totals',
			root: 'rows'
		},
		writer: {
			writeAllFields: true
		},
		extraParams: {
			code_type: this.code_type,
			query: this.query,
			active: this.active
		}
	},
	autoSync: true,
	remoteSort: true,
	autoLoad: false
}); 
Ext.define('App.store.administration.IpAccessRules', {
    storeId: 'IpAccessRulesStore',
    model: 'App.model.administration.IpAccessRule',
    extend: 'Ext.data.Store'
});

Ext.define('App.store.administration.IpAccessLog', {
    storeId: 'IpAccessLogStore',
    model: 'App.model.administration.IpAccessLog',
    extend: 'Ext.data.Store'
});

Ext.define('App.store.miscellaneous.OfficeNotes', {
	extend    : 'Ext.data.Store',
	model     : 'App.model.miscellaneous.OfficeNotes',
	autoLoad  : false
});
Ext.define('App.store.administration.CronJob', {
    storeId: 'CronJobStore',
    model: 'App.model.administration.CronJob',
    extend: 'Ext.data.Store'
});

Ext.define('App.store.administration.XtypesComboModel', {
	model: 'App.model.administration.XtypesComboModel',
	extend: 'Ext.data.Store',
	proxy: {
		type: 'direct',
		api: {
			read: 'CombosData.getFiledXtypes'
		}
	},
	autoLoad: true
});
Ext.define('App.store.administration.User', {
    model: 'App.model.administration.User',
    extend: 'Ext.data.Store',
    autoLoad: false
}); 
Ext.define('App.store.account.VoucherLine', {
	extend: 'Ext.data.Store',
	model     : 'App.model.account.VoucherLine',
    remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.fees.Billing',
{
	extend : 'Ext.data.Store',
	model : 'App.model.fees.Billing',
	autoLoad : false
}); 
Ext.define('App.store.miscellaneous.Amendments', {
	model: 'App.model.miscellaneous.Amendment',
	extend: 'Ext.data.Store'
});
Ext.define('App.store.account.Voucher', {
	extend: 'Ext.data.Store',
	model     : 'App.model.account.Voucher',
    remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.fees.Checkout', {
	extend    : 'Ext.data.Store',
	model     : 'App.model.fees.Checkout',
	autoLoad  : false
});
Ext.define( 'App.store.fees.EncountersPayments',
{
	extend : 'Ext.data.Store',
	model : 'App.model.fees.EncountersPayments',
	autoLoad : false
} );

Ext.define('App.store.documents.AdministrativeDocuments', {
	extend: 'Ext.data.Store',
	model     : 'App.model.documents.AdministrativeDocuments',
	remoteSort: false,
	autoLoad  : false,
	autoSync:true
});
Ext.define( 'App.store.fees.PaymentTransactions',
{
	extend : 'Ext.data.Store',
	model : 'App.model.fees.PaymentTransactions',
	autoLoad : false
} ); 
Ext.define('App.store.patient.AdvanceDirectives', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.AdvanceDirective'
});
Ext.define('App.store.navigation.Navigation', {
	extend  : 'Ext.data.TreeStore',
	requires: ['App.model.navigation.Navigation'],
	model   : 'App.model.navigation.Navigation'
});
Ext.define('App.store.patient.encounter.Procedures', {
    model: 'App.model.patient.encounter.Procedures',
    extend: 'Ext.data.Store',
	autoLoad:false
});
Ext.define('App.store.patient.CptCodes', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.CptCodes',
    remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.Disclosures', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.Disclosures',
	remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.EncounterServices', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.EncounterService'
});
Ext.define('App.store.patient.Dental', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.Dental',
    remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.Encounters', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.Encounter'],
	model: 'App.model.patient.Encounter',
	remoteSort: true
});
Ext.define('App.store.patient.CVXCodes', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.CVXCodes'],
	model: 'App.model.patient.CVXCodes',
	remoteSort: false,
	autoLoad: false
});



Ext.define('App.store.patient.MeaningfulUseAlert', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.MeaningfulUseAlert',
	remoteSort: true,
	autoLoad  : false
});
Ext.define('App.store.patient.ImmunizationCheck', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.ImmunizationCheck',
	remoteSort: true,
	autoLoad  : false
});


Ext.define('App.store.patient.LaboratoryTypes', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.LaboratoryTypes',
	remoteSort: false
});
Ext.define('App.store.patient.RxOrders', {
    extend: 'Ext.data.Store',
    model     : 'App.model.patient.Medications',
    groupField: 'date_ordered',
    startCollapsed: true,
    proxy: {
        type: 'direct',
        api: {
            read: 'Medications.getPatientMedicationsOrders',
            create: 'Medications.addPatientMedication',
            update: 'Medications.updatePatientMedication',
            destroy: 'Medications.destroyPatientMedication'
        },
        remoteGroup: false
    }
});
Ext.define('App.store.patient.Patient', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.Patient',
	remoteSort: true,
	autoLoad  : false
});
Ext.define('App.store.patient.PatientContacts', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientContacts',
	remoteSort: true
});
Ext.define('App.store.patient.Notes', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Notes'
});
Ext.define('App.store.patient.PatientArrivalLog', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientArrivalLog',
	remoteSort: true,
	autoLoad  : false
});
Ext.define('App.store.patient.PatientCalendarEvents', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientCalendarEvents',
	remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.PatientDocuments', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientDocuments',
	remoteSort: false,
	autoLoad  : false,
	autoSync:true
});
Ext.define('App.store.patient.PatientLabsResults', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientLabsResults',
	remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.PatientsOrderObservations', {
	extend: 'Ext.data.TreeStore',
	model: 'App.model.patient.PatientsOrderObservation',
	remoteSort: false,
	autoLoad: false
});



Ext.define('App.store.patient.PatientsLabOrderItems', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientsLabOrderItems',
	remoteSort: false,
	autoLoad  : false
});



Ext.define('App.store.patient.DismissedAlerts', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.DismissedAlerts',
    remoteSort: false,
	autoLoad  : false,
    autoSync  : true
});
Ext.define('App.store.patient.PatientsPrescriptions', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientsPrescriptions',
	remoteSort: false,
	autoLoad  : false
});



Ext.define('App.store.patient.PatientsPrescriptionMedications', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientsPrescriptionMedications',
	remoteSort: false,
	autoLoad  : false
});



Ext.define('App.store.patient.PatientsOrderResults', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientsOrderResult',
	remoteSort: false,
	autoLoad: false
});



Ext.define('App.store.patient.QRCptCodes', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.QRCptCodes',
	remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.PreventiveCare', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PreventiveCare',
	remoteSort: false,
	autoLoad  : false
});



Ext.define('App.store.patient.PatientsXrayCtOrders', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.PatientsXrayCtOrders',
	remoteSort: false,
	autoLoad  : false
});



Ext.define('App.store.patient.Surgery', {
	extend: 'Ext.data.Store',
	model     : 'App.model.patient.Surgery',
	remoteSort: false,
	autoLoad  : false
});
Ext.define('App.store.patient.Referrals', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Referral',
	autoLoad: false
});



Ext.define('App.store.patient.VectorGraph', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.VectorGraph'],
	model   : 'App.model.patient.VectorGraph'
});
Ext.define('App.store.patient.VisitPayment', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.VisitPayment'],
	model   : 'App.model.patient.VisitPayment'
});
Ext.define('App.store.patient.charts.StatureForAge', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.StatureForAge'],
	model   : 'App.model.patient.charts.StatureForAge'
});
Ext.define('App.store.patient.charts.HeadCircumferenceInf', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.HeadCircumferenceInf'],
	model   : 'App.model.patient.charts.HeadCircumferenceInf'
});
Ext.define('App.store.patient.charts.LengthForAgeInf', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.LengthForAgeInf'],
	model   : 'App.model.patient.charts.LengthForAgeInf'
});
Ext.define('App.store.patient.charts.WeightForAge', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.WeightForAge'],
	model   : 'App.model.patient.charts.WeightForAge'
});
Ext.define('App.store.patient.charts.WeightForAgeInf', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.WeightForAgeInf'],
	model   : 'App.model.patient.charts.WeightForAgeInf'
});
Ext.define('App.store.patient.charts.BMIForAge', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.BMIForAge'],
	model   : 'App.model.patient.charts.BMIForAge'
});
Ext.define('App.store.patient.charts.WeightForStature', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.WeightForStature'],
	model   : 'App.model.patient.charts.WeightForStature'
});
Ext.define('App.store.patient.charts.WeightForRecumbentInf', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.charts.WeightForRecumbentInf'],
	model   : 'App.model.patient.charts.WeightForRecumbentInf'
});
Ext.define('App.store.areas.PatientAreas', {
	extend: 'Ext.data.Store',
	requires: ['App.model.areas.PatientArea'],
	model: 'App.model.areas.PatientArea',
	pageSize: 10
});
Ext.define('App.controller.HelpDocuments', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'AppHelpDocumentMenu',
			selector: '#AppHelpDocumentMenu'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#AppHelpDocumentMenu > menuitem': {
				click: me.onAppHelpDocumentMenuClick
			}
		});

	},

	onAppHelpDocumentMenuClick: function (item){
		this.showHelpDocumentWindow(item.documentTitle, item.documentUrl);
	},

	addDocumentMenuItem: function (title, url){

		if(!this.getAppHelpDocumentMenu()) return;

		this.getAppHelpDocumentMenu().menu.add({
			text: title,
			icon: 'resources/images/icons/icohelp.png',
			documentTitle: title,
			documentUrl: url
		});
	},

	showHelpDocumentWindow: function (title, url){
		Ext.create('Ext.window.Window',{
			title: title,
			width: 900,
			height: 620,
			layout: 'fit',
			html: '<iframe allowtransparency="true" style="background: #FFFFFF;" width="100%" height="100%" src="'+ url +'"></iframe>'
		}).show();
	}
});

Ext.define('App.store.areas.PoolAreas', {
	extend: 'Ext.data.Store',
	requires: ['App.model.areas.PoolArea'],
	model: 'App.model.areas.PoolArea'
});
Ext.define('App.store.areas.PoolDropAreas', {
	extend: 'Ext.data.Store',
	requires: ['App.model.areas.PoolDropAreas'],
	pageSize: 10,
	model   : 'App.model.areas.PoolDropAreas'
});
Ext.define('App.controller.administration.CPT', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'CptAdminGrid',
			selector: 'cptadmingrid'
		},
		{
			ref: 'AdminCpt4CodeOnlyActiveBtn',
			selector: '#adminCpt4CodeOnlyActiveBtn'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'cptadmingrid': {
				activate: me.onCptAdminGridActive
			},
			'#adminCpt4CodeSearchField': {
				keyup: me.onAdminCpt4CodeSearchFieldKeyUp
			}
		});
	},

	onCptAdminGridActive: function(grid){
		grid.getStore().load();
	},

	onAdminCpt4CodeSearchFieldKeyUp: function(field){
		var me = this,
			store = me.getCptAdminGrid().getStore();
		me.dataQuery = field.getValue();
		store.proxy.extraParams = {
			onlyActive: me.getAdminCpt4CodeOnlyActiveBtn().pressed,
			query: me.dataQuery
		};

		store.loadPage(1);
	}

});
Ext.define('App.controller.Network', {
	extend: 'Ext.app.Controller',
	requires: [
	],
	refs: [
		{
			ref: 'AppNetworkStatusBox',
			selector: '#AppNetworkStatusBox'
		}
	],

	init: function(){
		var me = this;


		return;
		// say('new Network');

        me.Network = new Network();

        me.Network.latency.settings({
            endpoint: './classes/Latency.php',
            measures: 1,
            attempts: 1
        });


        me.Network.latency.on('end', function(average_latency, all_latencies) {
            me.onLatencyCheckEnd(average_latency, all_latencies);
        });

		me.control({
			'viewport': {
				render: me.onAppBeforeRender
			},
			'#AppNetworkStatusBox': {
				afterrender: me.onAppNetworkStatusBoxAfterRender
			}
		});


        window.addEventListener('online', function () {
            me.updateOnlineStatus();
        });
        window.addEventListener('offline', function () {
            me.updateOnlineStatus();
        });

    },

	onLatencyCheckEnd: function(average_latency){

		var bgcolor;

		if(average_latency < 100){
            bgcolor = 'green';
		}else if(average_latency < 150){
            bgcolor = 'yellow';
		}else if(average_latency < 175){
            bgcolor = 'orange';
		}else if(average_latency < 200){
            bgcolor = 'violet';
		}else {
            bgcolor = 'red';
		}

		// say('average_latency:' + average_latency);

        this.AppNetworkStatusBox.el.setStyle({
            backgroundColor: bgcolor,
            backgroundImage: 'none'
        });

	},

	startLatencyCheck: function(){
        performance.clearResourceTimings();
        this.Network.latency.start();
	},

    onAppBeforeRender: function(){
        var me = this;

        me.updateOnlineStatus();

        app.startLatencyCheck = function () {
            me.startLatencyCheck();
        };

        app.cron.addCronFn('app.startLatencyCheck()');
	},

    onAppNetworkStatusBoxAfterRender:function(comp){
		this.AppNetworkStatusBox = comp;
	},

    updateOnlineStatus: function () {
        app.fireEvent(navigator.onLine ? 'apponline' : 'appoffline', this);
        // say(navigator.onLine);

    },


});

Ext.define('App.controller.administration.AuditLog', {
    extend: 'Ext.app.Controller',
    requires: [],

    refs: [
        {
            selector: '#AuditLogWindow',
            ref: 'AuditLogWindow'
        },
        {
            selector: '#AuditLogWindowGrid',
            ref: 'AuditLogWindowGrid'
        }
    ],

    /**
     *
     */
    init: function(){
        var me = this;

        me.control({
            '#AuditLogWindowGrid': {
                close: me.onAuditLogWindowGridClose
            }
        });
    },

    onAuditLogWindowGridClose: function(){
        this.getAuditLogWindowGrid().getStore().removeAll();
    },

    /**
     *
     * @param pid               {int}       Example: 1111
     * @param uid               {int}       Example: 2222
     * @param eid               {int}       Example: 2222
     * @param foreign_id        {int}       Example: 3333
     * @param foreign_table     {string}    Example: worklist_reports
     * @param event             {string}    Example: create
     * @param event_description {string}    Example: Report Created
     */
    addLog: function(pid, uid, eid, foreign_id, foreign_table, event, event_description){
        AuditLog.addLog({
            pid: pid,
            uid: uid,
            eid: eid,
            foreign_id: foreign_id,
            foreign_table: foreign_table,
            event: event,
            event_description: event_description
        });
    },

    showLogByRecord: function(record){
        var me = this,
            win = me.showLogWindow(),
            store = me.getAuditLogWindowGrid().getStore(),
            idProperty = record.idProperty || 'id';

        store.clearFilter(true);

        store.getProxy().extraParams = { };

        store.filter([
            {
                property: 'foreign_id',
                value: record.get(idProperty)
            },
            {
                property: 'foreign_table',
                value: record.table.name
            }
        ]);
    },

    showLogByPidEvent: function(pid, event){
        var me = this,
            win = me.showLogWindow(),
            store = me.getAuditLogWindowGrid().getStore();

        store.clearFilter(true);

        store.getProxy().extraParams = { };

        store.filter([
            {
                property: 'pid',
                value: pid
            },
            {
                property: 'event',
                value: event
            }
        ]);
    },

    showLogWindow: function(){
        if(!this.getAuditLogWindow()){
            Ext.create('App.view.administration.AuditLogWindow');
        }
        return this.getAuditLogWindow().show();
    }

});

Ext.define('App.controller.administration.BackUp', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref:'AdministrationBackupGrid',
            selector:'#AdministrationBackupGrid'
        },
        {
            ref:'AdministrationBackupRefreshBtn',
            selector:'#AdministrationBackupRefreshBtn'
        }
    ],

    init: function() {
        var me = this;

        me.control({
            viewport: {
                render: me.onViewportRender
            },
            '#AdministrationBackupPanel': {
                activate: me.onAdministrationBackupPanelActivate
            },
            '#AdministrationBackupRefreshBtn': {
                click: me.onAdministrationBackupRefreshBtnClick
            },
            '#AdministrationBackupAsyncBackupBtn': {
                click: me.onAdministrationBackupAsyncBackupBtnClick
            }
        });
    },

	onAdministrationBackupPanelActivate: function(){
		this.getAdministrationBackupGrid().store.load();
	},

	onViewportRender: function(){
		if(!a('access_backup_settings')) return;

		BackUp.doBackupCheck(function (backup) {
			if(backup) return;
			app.alert(_('no_backup_found_within_24_hours'), 'warning');

			Ext.Msg.show({
				title: _('no_backup_found_within_24_hours'),
				msg: _('would_you_like_to_create_one'),
				buttons: Ext.Msg.YESNO,
				icon: Ext.Msg.WARNING,
				fn: function (btn) {
					if(btn === 'yes'){
						app.nav.navigateTo('App.view.administration.Backup');
					}
				}
			});
		});

	},

	onAdministrationBackupRefreshBtnClick: function () {
    	this.getAdministrationBackupGrid().getStore().load();
	},

	onAdministrationBackupAsyncBackupBtnClick: function () {

    	var me = this;

		Ext.Msg.show({
			title:  _('this_action_may_take_a_long_time'),
			msg: _('would_you_like_to_continue'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.WARNING,
			fn: function (btn) {
				if(btn === 'yes'){
					Ext.getBody().el.mask(_('creating_backup_be_right_back'));

					BackUp.doBackUp(function () {
						me.getAdministrationBackupGrid().store.load();
						Ext.getBody().el.unmask();
						Ext.Msg.alert(_('sweet'), _('backup_completed'));
					});
				}
			}
		});



	}

});

Ext.define('App.controller.administration.ContentManagement', {
    extend: 'Ext.app.Controller',
    refs: [
        {
            ref: 'ContentManagementGrid',
            selector: '#ContentManagementGrid'
        },
        {
            ref: 'ContentManagementWindow',
            selector: '#ContentManagementWindow'
        },
        {
            ref: 'ContentManagementWindowForm',
            selector: '#ContentManagementWindowForm'
        },
        {
            ref: 'ContentManagementWindowSaveBtn',
            selector: '#ContentManagementWindowSaveBtn'
        },
        {
            ref: 'ContentManagementWindowCancelBtn',
            selector: '#ContentManagementWindowCancelBtn'
        },
        {
            ref: 'ContentManagementWindowTextContentBody',
            selector: '#ContentManagementWindowTextContentBody'
        },
        {
            ref: 'ContentManagementWindowHtmlContentBody',
            selector: '#ContentManagementWindowHtmlContentBody'
        },
        {
            ref: 'ContentManagementWindowTokensTextArea',
            selector: '#ContentManagementWindowTokensTextArea'
        },
        {
            ref: 'ContentManagementWindowIsHtmlCheckbox',
            selector: '#ContentManagementWindowIsHtmlCheckbox'
        },
        {
            ref: 'ContentManagementAddBtn',
            selector: '#ContentManagementAddBtn'
        },
        {
            ref: 'ContentManagementGridContextMenuDelete',
            selector: '#ContentManagementGridContextMenuDelete'
        }
    ],

    init: function () {
        var me = this;

        me.control({
            '#ContentManagementGrid': {
                beforerender: me.onContentManagementGridBeforeRender,
                itemdblclick: me.onContentManagementGridItemDblClick,
                //beforeitemcontextmenu: me.onContentManagementWindowGridContextMenu
            },
            '#ContentManagementWindow': {
                close: me.onContentManagementWindowClose
            },
            '#ContentManagementWindowSaveBtn': {
                click: me.onContentManagementWindowSaveBtnClick
            },
            '#ContentManagementWindowCancelBtn': {
                click: me.onContentManagementWindowCancelBtnClick
            },
            '#ContentManagementWindowIsHtmlCheckbox': {
                change: me.onContentManagementWindowIsHtmlCheckboxChange
            },
            '#ContentManagementAddBtn': {
                click: me.onContentManagementAddBtnClick
            },
            '#ContentManagementGridContextMenuDelete': {
                click: me.onContentManagementGridContextMenuDeleteClick
            }
        });
    },

    onContentManagementWindowSaveBtnClick: function () {
        var me = this,
            form = me.getContentManagementWindowForm().getForm(),
            record = form.getRecord(),
            values = form.getValues();

        if (form.isValid()) {

            record.set(values);
            record.store.sync({
                success: function () {
                    app.msg(_('sweet'), _('record_saved'));
                    record.store.load();
                },
                failure: function () {
                    app.msg(_('oops'), _('record_error'), true);
                }
            });

            me.getContentManagementWindow().close();
        }
    },

    onContentManagementWindowCancelBtnClick: function () {
        var me = this,
            content_management_grid = me.getContentManagementGrid(),
            content_management_grid_store = content_management_grid.getStore(),
            form = me.getContentManagementWindowForm().getForm(),
            record = form.getRecord();


        if (record.get('content_type') == '' && record.get('content_body') == '') {
            content_management_grid_store.remove(record);
        }

        this.getContentManagementWindow().close();
    },

    onContentManagementWindowClose: function () {
        this.getContentManagementWindowForm().getForm().reset();
    },

    onContentManagementGridBeforeRender: function (grid) {
        grid.getStore().load();
    },

    onContentManagementGridItemDblClick: function (grid, record) {

        this.showContentWindow();

        var me = this,
            content_type = record.get('content_type'),
            form_panel = me.getContentManagementWindowForm(),
            form = form_panel.getForm(),
            is_html = record.get('is_html'),
            textareafield = form_panel.down('textareafield[action=content_body]'),
            htmleditor = form_panel.down('htmleditor[action=content_body]');

        form.reset();
        form.loadRecord(record);

        textareafield.setValue(record.get('content_body'));
        textareafield.submitValue = !is_html;
        textareafield.setDisabled(is_html);
        textareafield.setVisible(!is_html);

        htmleditor.setValue(record.get('content_body'));
        htmleditor.submitValue = is_html;
        htmleditor.setDisabled(!is_html);
        htmleditor.setVisible(is_html);

        me.setTokensTextAreaFieldByContentType(content_type);
    },

    onContentManagementWindowIsHtmlCheckboxChange: function (checkbox, isHtml, oldValue, eOpts) {
        var me = this,
            content_body = me.getContentManagementWindowTextContentBody(),
            content_html_body = me.getContentManagementWindowHtmlContentBody(),
            form_panel = me.getContentManagementWindowForm(),
            form = form_panel.getForm(),
            record = form.getRecord();

        if (isHtml == true) {
            content_body.hide();
            content_body.setDisabled(true);
            content_body.submitValue = false;

            content_html_body.show();
            content_html_body.setDisabled(false);
            content_html_body.setValue(record.get('content_body'));
            content_html_body.submitValue = true;
        } else {
            content_body.show();
            content_body.setDisabled(false);
            content_body.setValue(record.get('content_body'));
            content_body.submitValue = true;

            content_html_body.hide();
            content_html_body.setDisabled(true);
            content_html_body.submitValue = false;
        }
    },

    onContentManagementAddBtnClick: function (btn) {
        this.getContentManagementGrid().getSelectionModel().deselectAll();

        var me = this,
            content_management_grid = me.getContentManagementGrid(),
            content_management_grid_store = content_management_grid.getStore(),
            win = me.showContentWindow(),
            form = win.down('form').getForm(),
            records = content_management_grid_store.add({
                content_type: '',
                content_lang: 'en',
                content_body: '',
                is_html: false,
                content_version: '1.0'
            });

        form.loadRecord(records[0]);

        me.setTokensTextAreaFieldByContentType(records[0].get('content_type'));
    },

    showContentManagementGridContextMenu: function(content_management_grid, content_management_record, e) {
        // if (!a('access_patient_notes_transaction_log')) return;

        var me = this;

        me.ContentManagementGridContextMenu = Ext.widget('menu', {
            margin: '0 0 10 0',
            items: [
                {
                    text: _('delete_selected'),
                    icon: 'modules/billing/resources/images/cross.png',
                    itemId: 'ContentManagementGridContextMenuDelete',
                    acl: true
                }
            ]
        });

        me.ContentManagementGridContextMenu.content_management_grid = content_management_grid;
        me.ContentManagementGridContextMenu.content_management_record = content_management_record;

        me.ContentManagementGridContextMenu.showAt(e.getXY());

        return me.ContentManagementGridContextMenu;
    },

    onContentManagementGridContextMenuDeleteClick: function(btn) {
        var me = this,
            content_management_grid = this.getContentManagementGrid(),
            content_management_grid_store = content_management_grid.getStore(),
            content_management_selected_rows = content_management_grid.getSelectionModel().getSelection();

        if (content_management_selected_rows.length) {
            content_management_grid_store.remove(content_management_selected_rows);

            content_management_grid_store.sync({
                callback: function (){
                    app.msg(_('sweet'), _('records_removed'));
                }
            });
        }
    },

    onContentManagementWindowGridContextMenu: function (print_jobs_grid, print_jobs_record, item, index, e){
        e.preventDefault();

        this.showContentManagementGridContextMenu(print_jobs_grid, print_jobs_record, e)
    },

    showContentWindow: function () {
        if (!this.getContentManagementWindow()) {
            Ext.create('App.view.administration.ContentManagementWindow');
        }
        return this.getContentManagementWindow().show();
    },

    setTokensTextAreaFieldByContentType: function (content_type) {
        var me = this,
            tokens = [],
            tokenTextAreaField = me.getContentManagementWindowTokensTextArea();

        tokens = tokens.concat(this.patientTokens());

        if (content_type === 'disclosure') {
            tokens = tokens.concat(this.disclosureTokens(), this.formatTokens());
        }

        if (content_type === 'reminder_mammography_one_year' || content_type === 'reminder_mammography_six_months' || content_type === 'reminder_mammography_pathology') {
            tokens = tokens.concat(this.breastImagingReminderTokens());
        }

        if (content_type === 'sms_worklist_report_ready') {
            tokens = tokens.concat(this.smsWorklistReporReadyTokens());
        }

        if (content_type == null || content_type === '' || tokens.length <= 0) {
            tokens = tokens.concat(this.defaultTokens());
        }

        tokenTextAreaField.setValue(tokens.join("\r\n"));
    },

    patientTokens: function () {
        return [
            '[PATIENT_NAME]',
            '[PATIENT_ID]',
            '[PATIENT_RECORD_NUMBER]',
            '[PATIENT_FULL_NAME]',
            '[PATIENT_LAST_NAME]',
            '[PATIENT_SEX]',
            '[PATIENT_BIRTHDATE]',
            '[PATIENT_MARITAL_STATUS]',
            '[PATIENT_SOCIAL_SECURITY]',
            '[PATIENT_EXTERNAL_ID]',
            '[PATIENT_DRIVERS_LICENSE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_ONE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_TWO]',
            '[PATIENT_POSTAL_CITY]',
            '[PATIENT_POSTAL_STATE]',
            '[PATIENT_POSTAL_ZIP]',
            '[PATIENT_POSTAL_COUNTRY]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_ONE]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_TWO]',
            '[PATIENT_PHYSICAL_CITY]',
            '[PATIENT_PHYSICAL_STATE]',
            '[PATIENT_PHYSICAL_ZIP]',
            '[PATIENT_PHYSICAL_COUNTRY]',
            '[PATIENT_HOME_PHONE]',
            '[PATIENT_MOBILE_PHONE]',
            '[PATIENT_WORK_PHONE]',
            '[PATIENT_EMAIL]',
            '[PATIENT_MOTHERS_NAME]',
            '[PATIENT_GUARDIANS_NAME]',
            '[PATIENT_EMERGENCY_CONTACT]',
            '[PATIENT_EMERGENCY_PHONE]',
            '[PATIENT_PROVIDER]',
            '[PATIENT_PHARMACY]',
            '[PATIENT_AGE]',
            '[PATIENT_OCCUPATION]',
            '[PATIENT_EMPLOYEER]',
            '[PATIENT_RACE]',
            '[PATIENT_ETHNICITY]',
            '[PATIENT_LENGUAGE]',
            '[PATIENT_PICTURE]',
            '[PATIENT_QRCODE]',
        ];
    },

    billingTokens: function () {
        return [
            '[SERVICES_TABLE]',
            '[CLAIM_TABLE]',
        ];
    },

    disclosureTokens: function () {
        return [
            '[DISCLOSURE_DOCUMENTS]',
            '[DISCLOSURE_RECIPIENT]',
            '[DISCLOSURE_DESCRIPTION]',
            '[DISCLOSURE_REQUEST_DATE]',
            '[DISCLOSURE_FULFIL_DATE]',
            '[DISCLOSURE_PICKUP_DATE]',
            '[DISCLOSURE_DOCUMENT_COUNT]'
        ];
    },

    breastImagingReminderTokens: function () {
        return [
            '[PATIENT_NAME]',
            '[PATIENT_ADDRESS]',
            '[PATIENT_ADDRESS_CONT]',
            '[PATIENT_CITY]',
            '[PATIENT_STATE]',
            '[PATIENT_ZIP]',
            '[PATIENT_CITY_STATE_ZIP]',
            '[PATIENT_RECORD_NUMBER]',
            '[FACILITY_NAME]',
            '[FACILITY_ADDRESS]',
            '[FACILITY_ADDRESS_CONT]',
            '[FACILITY_CITY_STATE_ZIP]',
            '[SERVICE_DATE]',
            '[TODAY]',
            '[B]',
            '[/B]',
            '[U]',
            '[/U]',
            '[I]',
            '[/I]',
            '[TAB]'
        ];
    },

    smsWorklistReporReadyTokens: function () {
        return [
            '[FACILITY_NAME]',
            '[SERVICE_DATE]',
            '[ACCESSION_NUMBER]'
        ];
    },

    formatTokens: function () {
        return [
            '[TODAY]',
            '[B]',
            '[/B]',
            '[U]',
            '[/U]',
            '[I]',
            '[/I]',
            '[TAB]'
        ];
    },

    defaultTokens: function () {
        return [
            '[PATIENT_NAME]',
            '[PATIENT_RECORD_NUMBER]',
            '[SERVICE_DATE]',
            '[SIGNED_DATE]',
            '[TITLE]',
            '[RADIOLOGIST_SIGNATURE]',
            '[ORDERING_PHYSICIAN]',
            '[FACILITY_NAME]',
            '[FACILITY_PHONE]',
            '[DENSE_BREST]',
            '[NORMAL_BENIGN]',
            '[PROBABLY_BENIGN]',
            '[ADDITIONAL]',
            '[PREVIOUS]',
            '[ABNORMAL]',
            '[RECOMENDATIONS_LIST]',
            '[B]',
            '[/B]',
            '[U]',
            '[/U]',
            '[I]',
            '[/I]'
        ];
    }


});
Ext.define('App.controller.Main', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'viewport',
			selector: 'viewport'
		},
		{
			ref: 'ApplicationFacilityCombo',
			selector: '#ApplicationFacilityCombo'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				usersessionswitch: me.onApplicationUserSessionSwitch
			},
			'#ApplicationFacilityCombo': {
				select: me.onApplicationFacilityComboSelect,
				beforerender: me.onApplicationFacilityComboBeforeRender
			},
			'#AppCleatState': {
				click: me.onAppCleatStateClick
			}
		});

	},

	onAppCleatStateClick: function (btn){

		Ext.Msg.show({
			title: 'Wait!',
			msg: 'This action will reset the application state and refresh the application',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn){
				if(btn === 'yes'){
					AppState.AppStateUnClearByUid(app.user.id, function (){
						window.document.location.reload();
					});
				}
			}
		});



	},

	onApplicationUserSessionSwitch: function (ctrl, session) {

		if(session.user.acl_roles[0] == app.user.acl_roles[0]){
			Ext.Object.each(session.user, function (key, value) {
				app.user[key] = value;
			});
			app.user.token = session.token;
			app.userSplitBtn.setText(app.user.title + ' ' + app.user.fname[0] + '.' + app.user.lname);
			ctrl.doApplicationUnLock();
			app.msg(
				_('sweet'),
				Ext.String.format(_('application_successfully_switched_to_x'), '<b>' + (app.user.title + ' ' + app.user.fname + ' ' + app.user.lname) + '</b>')
			);

		}else {
			window.onbeforeunload = null;
			window.location.reload();
		}
	},

	onApplicationFacilityComboSelect: function (cmb, records) {
		var me = this;
		Facilities.setFacility(records[0].data.option_value, function(provider, response){
			if(records[0].data.option_value == response.result){
				// set user global facility value
				app.user.facility = records[0].data.option_value;

				app.fireEvent('appfacilitychanged', me, app.user.facility, cmb);

				app.msg(_('sweet'), _('facility') + ' ' + records[0].data.option_name);
				app.setWindowTitle(records[0].data.option_name);

				me.getController('areas.PatientPoolAreas').reRenderPoolAreas();
				me.getController('areas.FloorPlan').renderZones();

				// app.nav['App_view_areas_PatientPoolAreas'].reRenderPoolAreas();
				// app.nav['App_view_areas_FloorPlan'].renderZones();
				app.getPatientsInPoolArea();
			}
		});
	},

	onApplicationFacilityComboBeforeRender: function (cmb) {
		cmb.getStore().on('load', this.onFacilityComboLoad, this);
	},

	onFacilityComboLoad:function(store, records){
		var rec = store.findRecord('option_value', app.user.facility);
		this.getApplicationFacilityCombo().setValue(rec);
		app.setWindowTitle(rec.data.option_name)
	},

	getCurrentFacility: function () {
		return this.getApplicationFacilityCombo().findRecordByValue(app.user.facility);
	},

	getCurrentFacilityName: function () {
		return this.getApplicationFacilityCombo().findRecordByValue(app.user.facility).get('option_name');
	}

});

Ext.define('App.controller.administration.DocumentPdfForms', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'DocumentPdfFormsWindow',
			selector: '#DocumentPdfFormsWindow'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#AdministrationDocuments': {
				activate: me.onAdministrationDocumentsActive
			}
		});
	},

	showDocumentPdfFormsWindow: function(){

		if(!this.getDocumentPdfFormsWindow()){
			Ext.create('')
		}
		return this.getDocumentPdfFormsWindow().show();
	},



});

Ext.define('App.controller.administration.DataPortability', {
    extend: 'Ext.app.Controller',

	refs: [
		{
			ref:'DataPortabilityPanel',
			selector:'#DataPortabilityPanel'
		},
		{
			ref:'DataPortabilityPanelIFrame',
			selector:'#DataPortabilityPanelIFrame'
		},
        {
            ref: 'ExportFilterForm',
            selector: '#ExportFilterForm'
        }
	],

	init: function() {
		var me = this;

		me.control({
			'#DataPortabilityExportBtn':{
				click: me.onDataPortabilityExportBtnClick
			}
		});
	},

	onDataPortabilityExportBtnClick: function(btn){
		var iframe = this.getDataPortabilityPanelIFrame(),
			src = location.origin + location.pathname + 'dataProvider/DataPortability.php?token=' + app.user.token +'&site=' + g('site'),
            form = this.getExportFilterForm().getForm(),
            record = form.getValues().getRecord();

		iframe.setSrc(src);
	}

});

Ext.define('App.controller.administration.Documents', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'AdministrationDocuments',
			selector: '#AdministrationDocuments'
		},
		{
			ref: 'AdministrationDocumentsDefaultsGrid',
			selector: '#AdministrationDocumentsDefaultsGrid'
		},
		{
			ref: 'AdministrationDocumentsTemplatesGrid',
			selector: '#AdministrationDocumentsTemplatesGrid'
		},
		{
			ref: 'AdministrationDocumentsTemplatesEditorForm',
			selector: '#AdministrationDocumentsTemplatesEditorForm'
		},
		{
			ref: 'AdministrationDocumentsTokensGrid',
			selector: '#AdministrationDocumentsTokensGrid'
		},
		{
			ref: 'AdministrationDocumentsTokenTextField',
			selector: '#AdministrationDocumentsTokenTextField'
		},
		{
			ref: 'AdministrationDocumentsNewTemplateBtn',
			selector: '#AdministrationDocumentsNewTemplateBtn'
		},
		{
			ref: 'AdministrationDocumentsPdfTemplatesGrid',
			selector: '#AdministrationDocumentsPdfTemplatesGrid'
		},
		{
			ref: 'AdministrationDocumentsPdfTemplatesAddBtn',
			selector: '#AdministrationDocumentsPdfTemplatesAddBtn'
		},
		{
			ref: 'AdministrationDocumentsPdfTemplateWindow',
			selector: '#AdministrationDocumentsPdfTemplateWindow'
		},
		{
			ref: 'AdministrationDocumentsPdfTemplateWindowForm',
			selector: '#AdministrationDocumentsPdfTemplateWindowForm'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#AdministrationDocuments': {
				activate: me.onAdministrationDocumentsActive
			},
			'#AdministrationDocumentsTokensGrid': {
				afterrender: me.onAdministrationDocumentsTokensGridAfterRender
			},
			'#AdministrationDocumentsNewTemplateBtn': {
				click: me.onAdministrationDocumentsNewTemplateBtnClick
			},
			'#AdministrationDocumentsNewDefaulTemplateBtn': {
				click: me.onAdministrationDocumentsNewDefaulTemplateBtnClick
			},
			'#AdministrationDocumentsPdfTemplatesGrid': {
				render: me.onAdministrationDocumentsPdfTemplatesGridRender,
				itemdblclick: me.onAdministrationDocumentsPdfTemplatesGridItemDblClick
			},
			'#AdministrationDocumentsPdfTemplatesAddBtn': {
				click: me.onAdministrationDocumentsPdfTemplatesAddBtnClick
			},
			'#AdministrationDocumentsPdfTemplateWindowSaveBtn': {
				click: me.onAdministrationDocumentsPdfTemplateWindowSaveBtnClick
			},
			'#AdministrationDocumentsPdfTemplateWindowSaveCloseBtn': {
				click: me.onAdministrationDocumentsPdfTemplateWindowSaveCloseBtnClick
			},
			'#AdministrationDocumentsPdfTemplateWindowCancelBtn': {
				click: me.onAdministrationDocumentsPdfTemplateWindowCancelBtnClick
			},
			'#AdministrationDocumentsPdfTemplateWindowDeleteBtn': {
				click: me.onAdministrationDocumentsPdfTemplateWindowDeleteBtnClick
			}
		});
	},

	onAdministrationDocumentsPdfTemplatesGridRender: function(grid){
		grid.getStore().load();
	},

	onAdministrationDocumentsPdfTemplatesGridItemDblClick: function(grid, record){
		this.doEditAdministrationDocumentsPdfTemplateRecord(record);
	},

	onAdministrationDocumentsPdfTemplatesAddBtnClick: function(btn){

		var grid = this.getAdministrationDocumentsPdfTemplatesGrid(),
			store = grid.getStore(),
			records = store.add({
				facility_id: 0,
				concept: 'default',
				template: '',
				body_margin_left: 10,
				body_margin_top: 10,
				body_margin_right: 10,
				body_margin_bottom: 10,
				body_font_family: 'Arial',
				body_font_style: '',
				body_font_size: 10,
				footer_margin: 0,
				format: 'LETTER',
				is_interface_tpl: 0,
				active: 1
			});

		this.doEditAdministrationDocumentsPdfTemplateRecord(records[0]);
	},

	doEditAdministrationDocumentsPdfTemplateRecord: function (record){
		// show window
		this.showAdministrationDocumentsPdfTemplateWindow();
		// load record
		this.getAdministrationDocumentsPdfTemplateWindowForm().getForm().loadRecord(record);
	},

	showAdministrationDocumentsPdfTemplateWindow: function (){
		if(!this.getAdministrationDocumentsPdfTemplateWindow()){
			Ext.create('App.view.administration.DocumentsPdfTemplateWindow');
		}
		return this.getAdministrationDocumentsPdfTemplateWindow().show();
	},

	onAdministrationDocumentsPdfTemplateWindowSaveBtnClick: function (btn){
		this.doAdministrationDocumentsPdfTemplateWindowSave(btn, false);
	},

	onAdministrationDocumentsPdfTemplateWindowSaveCloseBtnClick: function (btn){
		this.doAdministrationDocumentsPdfTemplateWindowSave(btn, true);
	},

	doAdministrationDocumentsPdfTemplateWindowSave: function (btn, close_window){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(!form.isValid()) return;

		record.set(values);

		if(record.store.getModifiedRecords().length > 0){
			record.store.sync({
				callback: function (){
					if (close_window) win.close();
				}
			});
		}else{
			if (close_window) win.close();
		}
	},

	onAdministrationDocumentsPdfTemplateWindowCancelBtnClick: function (btn){
		btn.up('window').close();
	},

	onAdministrationDocumentsPdfTemplateWindowDeleteBtnClick: function (btn){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			store = record.store;

		Ext.Msg.show({
			title: 'Wait!',
			msg: 'Would you like to remove this record?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (ans){
				if(ans === 'yes'){

					store.remove(record);
					store.sync({
						callback: function (){
							win.close();
							app.msg(_('sweet'), _('record_removed'));
						}
					});
				}
			}
		});
	},

	// -------------------------
	// -------------------------
	// -------------------------

	onAdministrationDocumentsActive: function(){

	},

	onAdministrationDocumentsNewTemplateBtnClick: function(){
		var me = this,
			grid = me.getAdministrationDocumentsTemplatesGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0,
			{
				title: _('new_document'),
				template_type: 'documenttemplate',
				date: new Date(),
				type: 1
			});
		grid.editingPlugin.startEdit(0, 0);
	},

	onAdministrationDocumentsNewDefaulTemplateBtnClick: function(){
		var me = this,
			grid = me.getAdministrationDocumentsDefaultsGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0,
			{
				title: _('new_defaults'),
				template_type: 'defaulttemplate',
				date: new Date(),
				type: 1
			});
		grid.editingPlugin.startEdit(0, 0);
	},
	
	onAdministrationDocumentsTokensGridAfterRender: function(grid){

	},

	doCopy: function(grid, record){

		if(!document.queryCommandSupported('copy')){
			app.msg(_('oops'), _('text_copy_not_supported_by_browser'), true);
			return;
		}

		var me = this;
		grid.editingPlugin.startEdit(record, 0);
		me.getAdministrationDocumentsTokenTextField().inputEl.dom.select();
		document.execCommand("copy");
		app.msg(_('sweet'), _('text_copyed'));

	}


});

Ext.define('App.controller.administration.FacilityStructure', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'FacilityStructurePanel',
			selector: '#FacilityStructurePanel'
		},
		{
			ref: 'FacilityStructureTreePanel',
			selector: '#FacilityStructureTreePanel'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#FacilityStructurePanel': {
				activate: me.onFacilityStructurePanelActivate
			}
		});

	},

	onFacilityStructurePanelActivate: function(){
		this.getFacilityStructureTreePanel().getStore().load();
	}

});
Ext.define('App.controller.administration.EncounterSnippets', {
	extend: 'Ext.app.Controller',
	requires: [
	],
	refs: [
		{
			ref: 'soapPanel',
			selector: '#soapPanel'
		},
		{
			ref: 'SoapForm',
			selector: '#soapForm'
		},
		{
			ref: 'SoapDxCodesField',
			selector: '#SoapDxCodesField'
		},
		{
			ref: 'SnippetsTreePanel',
			selector: '#SnippetsTreePanel'
		},
		{
			ref: 'SnippetWindow',
			selector: '#SnippetWindow'
		},
		{
			ref: 'SnippetForm',
			selector: '#SnippetForm'
		},
		{
			ref: 'SnippetFormCategoryCmb',
			selector: '#SnippetFormCategoryCmb'
		},
		{
			ref: 'SnippetFormTextField',
			selector: '#SnippetFormTextField'
		},
		{
			ref: 'SnippetDeleteBtn',
			selector: '#SnippetDeleteBtn'
		},
		{
			ref: 'SnippetCancelBtn',
			selector: '#SnippetCancelBtn'
		},
		{
			ref: 'SnippetSaveBtn',
			selector: '#SnippetSaveBtn'
		},

		// templates specialties combo
		{
			ref: 'SoapTemplateSpecialtiesCombo',
			selector: '#SoapTemplateSpecialtiesCombo'
		}
	],

	init: function(){
		var me = this;

		this.control({
			'viewport': {
				'beforeencounterload': me.onOpenEncounter
			},
			'#SnippetsTreePanel': {
				itemdblclick: me.onSnippetsTreePanelItemDblClick
			},
			'#SnippetDeleteBtn': {
				click: me.onSnippetDeleteBtnClick
			},
			'#SnippetSaveBtn': {
				click: me.onSnippetSaveBtnClick
			},
			'#SnippetCancelBtn': {
				click: me.onSnippetCancelBtnClick
			},
			'#SnippetAddBtn': {
				click: me.onSnippetAddBtnClick
			},
			'#soapProcedureWindow > form > textarea': {
				focus: me.onProcedureTextFieldFocus
			},
			'#SoapTemplateSpecialtiesCombo': {
				select: me.onSoapTemplateSpecialtiesComboChange,
				change: me.onSoapTemplateSpecialtiesComboChange
			}
		});
	},

	onOpenEncounter: function(encounter){
		this.getSoapTemplateSpecialtiesCombo().setValue(encounter.data.specialty_id);
	},

	onSoapTemplateSpecialtiesComboChange: function(cmb){
		this.loadSnippets();
	},

	loadSnippets: function() {
		var me = this;

		if (me.getSnippetsTreePanel().collapsed === false) {
			var templates = me.getSnippetsTreePanel(),
				specialty_id = me.getSoapTemplateSpecialtiesCombo().getValue();


			templates.getStore().load({
				filters: [
					{
						property: 'specialty_id',
						value: specialty_id
					},
					{
						property: 'uid',
						value: app.user.id
					},
					{
						property: 'uid',
						value: 0
					},
					{
						property: 'uid',
						value: null
					}
				]
			});
		}
	},

	/**
	 *
	 * @param view
	 * @param record
	 */
	onSnippetsTreePanelItemDblClick: function(view, record){

		var me = this,
			formPanel = me.getSoapForm(),
			form = formPanel.getForm(),
			fields = ['subjective', 'objective', 'assessment', 'instructions'];

		fields.forEach(function (field_name) {
			var field = form.findField(field_name),
				snippet = record.get(field_name),
				inputEl = field.inputEl.dom,
				value = field.getValue(),
				glue = !value[0] || value[0] === ' ' ? '' : ' ';

			if(snippet === '') return;

			me.setCursorPos(inputEl, value.length);
			document.execCommand("insertText", false, glue + snippet);
		});

		var diagnoses = record.get('diagnoses');

		if(diagnoses === '') return;

		diagnoses = diagnoses.split(',');

		var dxField = me.getSoapPanel().dxField;

		DiagnosisCodes.getICDDataByCodes(diagnoses, function (response) {

			response.forEach(function (data) {
				dxField.doAddIcd({
					code: data.code,
					code_text: data.code_text,
					code_type: data.code_type
				});
			});
		});
	},

	setCursorPos: function(input, start, end){
		input.focus();
		if(arguments.length < 3) end = start;
		if("selectionStart" in input){
			input.selectionStart = start;
			input.selectionEnd = end;
		}else if(input.createTextRange){
			var rng = input.createTextRange();
			rng.moveStart("character", start);
			rng.collapse();
			rng.moveEnd("character", end - start);
			rng.select();
		}
	},

	/**
	 *
	 * @param node
	 * @param data
	 * @param overModel
	 */
	onSnippetDrop: function(node, data, overModel){
		var me = this, pos = 10;

		say(node);
		say(data);
		say(overModel);

		// for(var i = 0; i < overModel.parentNode.childNodes.length; i++){
		// 	overModel.parentNode.childNodes[i].set({pos: pos});
		// 	pos = pos + 10;
		// }
		// me.snippetStore.sync();
	},


	onSnippetDeleteBtnClick: function(){
		var me = this,
			form = me.getSnippetForm().getForm(),
			record = form.getRecord();

		// TODO ask to make sure

		me.getSnippetsTreePanel().getStore().remove(record);
		form.reset(true);
		me.getSnippetWindow().close()
	},

	onSnippetSaveBtnClick: function(){
		var me = this,
			win = me.getSnippetWindow(),
			form = me.getSnippetForm().getForm(),
			values = form.getValues(),
			record = form.getRecord();

		if(!form.isValid())  return;

		record.set(values);

		if(Ext.Object.isEmpty(record.getChanges())){
			form.reset();
			win.close();
			return;
		}

		record.store.sync({
			callback: function(){
				form.reset();
				win.close();
				app.msg(_('sweet'), _('record_saved'));
			}
		});
	},

	onSnippetCancelBtnClick: function(){
		this.getSnippetsTreePanel().getStore().rejectChanges();
		this.getSnippetWindow().close();

	},

	showSnippetEditWindow: function(){
		if(!this.getSnippetWindow()){
			Ext.create('App.view.patient.encounter.Snippets');
		}
		return this.getSnippetWindow().show();
	},

	onSnippetAddBtnClick: function(){
		var me = this,
			store =  me.getSnippetsTreePanel().getStore(),
			categories = [];

		store.groups.items.forEach(function (group) {
			if(group.key === '') return;
			categories = Ext.Array.push(categories, { text: group.key });
		});

		var records = store.add({
			uid: app.user.id,
			specialty_id: me.getSoapTemplateSpecialtiesCombo().getValue()
		});

		me.showSnippetEditWindow();
		me.getSnippetForm().getForm().loadRecord(records[0]);
		me.getSnippetFormCategoryCmb().store.loadData(categories);

	},

	onSnippetBtnEdit: function(grid, rowIndex, colIndex, actionItem, event, record){
		this.showSnippetEditWindow();
		this.getSnippetForm().getForm().loadRecord(record);
	}

});
Ext.define('App.controller.administration.DecisionSupport', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'DecisionSupportAdminPanel',
			selector: 'decisionSupportAdminPanel'
		},
		{
			ref: 'DecisionSupportAdminGrid',
			selector: '#decisionSupportAdminGrid'
		},
		{
			ref: 'DecisionSupportRuleAddBtn',
			selector: '#decisionSupportRuleAddBtn'
		},
		{
			ref: 'DecisionSupportEditorTabPanel',
			selector: '#decisionSupportEditorTabPanel'
		},

		// editor grids
		{
			ref: 'DecisionSupportProcGrid',
			selector: 'grid[action=PROC]'
		},
		{
			ref: 'DecisionSupportProBGrid',
			selector: 'grid[action=PROB]'
		},
		{
			ref: 'DecisionSupportSociGrid',
			selector: 'grid[action=SOCI]'
		},
		{
			ref: 'DecisionSupportMediGrid',
			selector: 'grid[action=MEDI]'
		},
		{
			ref: 'DecisionSupportAlleGrid',
			selector: 'grid[action=ALLE]'
		},
		{
			ref: 'DecisionSupportLabGrid',
			selector: 'grid[action=LAB]'
		},
		{
			ref: 'DecisionSupportVitaGrid',
			selector: 'grid[action=VITA]'
		},
		{
			ref: 'DecisionSupportVitalCombo',
			selector: '#DecisionSupportVitalCombo'
		},
		{
			ref: 'DecisionSupportSocialHistoryCombo',
			selector: '#DecisionSupportSocialHistoryCombo'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#decisionSupportAdminPanel': {
				activate: me.onDecisionSupportAdminPanelActive
			},
			'#decisionSupportRuleAddBtn': {
				click: me.onDecisionSupportRuleAddBtnClick
			},

			'#decisionSupportAdminGrid': {
				beforeedit: me.onDecisionSupportAdminGridBeforeEdit,
				edit: me.onDecisionSupportAdminGridEdit,
				beforeitemcontextmenu: me.onDecisionSupportAdminGridBeforeContextMenu,
			},

			'#DecisionSupportAdminGridShowLogMenu': {
				click: me.onDecisionSupportAdminGridShowLogMenuClick
			},

			'#DecisionSupportProcedureCombo': {
				select: me.onDecisionSupportProcedureComboSelect
			},
			'#DecisionSupportProblemCombo': {
				select: me.onDecisionSupportProblemComboSelect
			},
			'#DecisionSupportMedicationCombo': {
				select: me.onDecisionSupportMedicationComboSelect
			},
			'#DecisionSupportMedicationAllergyCombo': {
				select: me.onDecisionSupportMedicationAllergyComboSelect
			},
			'#DecisionSupportLabCombo': {
				select: me.onDecisionSupportLabComboSelect
			},
			'#DecisionSupportVitalAddBtn': {
				click: me.onDecisionSupportVitalAddBtnClick
			},
			'#DecisionSupportSocialHistoryAddBtn': {
				click: me.onDecisionSupportSocialHistoryAddBtnClick
			},
			'#DecisionSupportSocialHistoryCombo': {
				beforerender: me.onDecisionSupportSocialHistoryComboBeforeRender
			}
		});

		me.logCtrl = me.getController('App.controller.administration.AuditLog');

	},

	onDecisionSupportAdminPanelActive: function(){
		this.getDecisionSupportAdminGrid().getStore().load();
	},

	onDecisionSupportRuleAddBtnClick: function(btn){
		var grid = btn.up('grid');

		grid.editingPlugin.cancelEdit();
		grid.getStore().insert(0, {
			create_date: new Date(),
			update_date: new Date(),
			create_uid: app.user.id,
			update_uid: app.user.id,
			active: 1
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onDecisionSupportAdminGridBeforeEdit: function(plugin, context){
		var editor = plugin.editor,
			record = context.record,
			grids = editor.query('grid'),
            grid,
            store,
            i;

		this.getDecisionSupportEditorTabPanel().setActiveTab(0);

		for(i = 0; i < grids.length; i++){
			grid = grids[i],
				store = grid.getStore();
			store.grid = grid;
			store.load({
				filters: [
					{
						property: 'rule_id',
						value: record.data.id
					},
					{
						property: 'concept_type',
						value: grid.action
					}
				],
				callback: function(records, operation, success){
					this.grid.setTitle(this.grid.initialConfig.title + ' (' + records.length + ')')
				}
			});
		}
	},


	onDecisionSupportAdminGridEdit: function (plugin, context) {

		var description = context.record.get('description') + ' - Updated',
			active = context.record.get('active'),
			changes = context.record.getChanges();

		if(!Ext.Object.isEmpty(changes) && changes.active !== undefined){

			if(changes.active){
				description += ' - Activated';
			}else{
				description += ' - Deactivated';
			}
		}

		this.logCtrl.addLog(
			0,
			app.user.id,
			0,
			context.record.get('id'),
			context.record.table.name,
			'UPDATE',
			description
		);
	},

	onDecisionSupportAdminGridBeforeContextMenu: function (grid, record, item, index, e) {
		e.preventDefault();
		this.showDecisionSupportAdminGridContextMenu(e);
	},

	showDecisionSupportAdminGridContextMenu: function (e) {

		var me = this;
		if(!me.gridContextMenu){
			me.gridContextMenu = Ext.widget('menu', {
				margin: '0 0 10 0',
				items: [
					{
						text: _('show_log'),
						itemId: 'DecisionSupportAdminGridShowLogMenu',
						icon: 'resources/images/icons/icoView.png'
					}
				]
			});
		}

		me.gridContextMenu.showAt(e.getXY());

		return me.gridContextMenu;
	},

	onDecisionSupportAdminGridShowLogMenuClick: function () {
		var record = this.getDecisionSupportAdminGrid().getSelectionModel().getLastSelected();

		this.logCtrl.showLogByRecord(record);
	},

	onDecisionSupportProcedureComboSelect: function(cmb, records){
		var grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: records[0].data.code,
			concept_text: records[0].data.code_text,
			concept_code_type: records[0].data.code_type
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportProblemComboSelect: function(cmb, records){
		var grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: records[0].data.ConceptId,
			concept_text: records[0].data.Term,
			concept_code_type: records[0].data.CodeType
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportMedicationComboSelect: function(cmb, records){
		var grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: records[0].data.RXCUI,
			concept_text: records[0].data.STR,
			concept_code_type: records[0].data.CodeType
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportMedicationAllergyComboSelect: function(cmb, records){
		var grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: records[0].data.RXCUI,
			concept_text: records[0].data.STR,
			concept_code_type: records[0].data.CodeType
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportLabComboSelect: function(cmb, records){
		var grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: records[0].data.loinc_number,
			concept_text: records[0].data.loinc_name,
			concept_code_type: 'LOINC'
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportVitalAddBtnClick: function(){
		var cmb = this.getDecisionSupportVitalCombo(),
			cmcStore = cmb.getStore(),
			record = cmcStore.findRecord('option_value', cmb.getValue()),
			grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: record.data.code,
			concept_text: record.data.option_name,
			concept_code_type: record.data.code_type
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportSocialHistoryAddBtnClick: function(){
		var cmb = this.getDecisionSupportSocialHistoryCombo(),
			cmcStore = cmb.getStore(),
			record = cmcStore.findRecord('option_value', cmb.getValue()),
			grid = cmb.up('grid'),
			store = grid.getStore(),
            foo;

		grid.editingPlugin.cancelEdit();
		foo = store.add({
			rule_id: this.getRuleId(),
			concept_type: grid.action,
			concept_code: record.data.code,
			concept_text: record.data.option_name,
			concept_code_type: record.data.code_type
		});
		grid.editingPlugin.startEdit(foo[0], 2);
	},

	onDecisionSupportSocialHistoryComboBeforeRender: function(cmb){
		cmb.getStore().on('load', function(store){
			store.insert(0,{
				code: 'smoking_status',
				option_name: _('smoking_status'),
				option_value: 'smoking_status',
				code_type: ''
			});
		});
	},

	getRuleId: function(){
		return this.getDecisionSupportEditorTabPanel().up('form').getForm().getRecord().data.id;
	},

	doRemoveRule: function(record){
		record.store.remove(record);
	},

	doRemoveRuleConcept: function(record){
		record.store.remove(record);
	}

});

Ext.define('App.controller.administration.FileSystems', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref:'AdminFileSystemsPanel',
            selector:'#AdminFileSystemsPanel'
        },
        {
            ref:'FileSystemsGrid',
            selector:'#FileSystemsGrid'
        }
    ],

    init: function() {
        var me = this;

        me.control({
            '#AdminFileSystemsPanel': {
                activate: me.onAdminFileSystemsPanelActivate
            },
            '#FileSystemsAnalyzeBtn': {
                click: me.onFileSystemsAnalyzeBtnClick
            },
            '#FileSystemsAddBtn': {
                click: me.onFileSystemsAddBtnClick
            }
        });
    },

	onAdminFileSystemsPanelActivate: function () {
		this.getFileSystemsGrid().getStore().load();
	},

	onFileSystemsAnalyzeBtnClick: function () {
		var me = this;

		FileSystem.fileSystemsSpaceAnalyzer(function () {
			me.getFileSystemsGrid().getStore().load();
		});
	},
	
	onFileSystemsAddBtnClick: function () {

    	var me = this,
		    grid = me.getFileSystemsGrid(),
		    store = grid.getStore();

		grid.editingPlugin.cancelEdit();

		var records = store.add({
			status: 'ONLINE'
		});

		grid.editingPlugin.startEdit(records[0], 0);

	}

});

Ext.define('App.controller.administration.HL7', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'HL7ServersPanel',
			selector: 'hl7serverspanel'
		},
		{
			ref: 'HL7ServersGrid',
			selector: '#hl7serversgrid'
		},
		{
			ref: 'HL7ClientsGrid',
			selector: '#hl7clientsgrid'
		},
		{
			ref: 'HL7MessagesWindow',
			selector: '#HL7MessagesWindow'
		},
		{
			ref: 'HL7MessagesGrid',
			selector: '#HL7MessagesGrid'
		},
		{
			ref: 'HL7MessageViewerWindow',
			selector: '#HL7MessageViewerWindow'
		},
		{
			ref: 'HL7MessageViewerForm',
			selector: '#HL7MessageViewerForm'
		},
		{
			ref: 'HL7MessageViewerRawMessageField',
			selector: '#HL7MessageViewerRawMessageField'
		},
		{
			ref: 'HL7MessageViewerMessageField',
			selector: '#HL7MessageViewerMessageField'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'hl7serverspanel': {
				activate: me.onHL7ServersPanelActive
			},
			'#hl7serversgrid': {
				beforeedit: me.onHL7ServersGridBeforeEdit,
				validateedit: me.onHL7ServersGridValidateEdit
			},
			'#hl7serversgrid #addHL7ServerBtn': {
				click: me.onAddHL7ServerBtnClick
			},
			'#hl7serversgrid #removeHL7ServerBtn': {
				click: me.onRemoveHL7ServerBtnClick
			},
			'#hl7clientsgrid #addHL7ClientBtn': {
				click: me.onAddHL7ClientBtnClick
			},
			'#hl7clientsgrid #removeHL7ClientBtn': {
				click: me.onRemoveHL7ClientBtnClick
			},
			'#HL7MessagesViewBtn': {
				click: me.onHL7MessagesViewBtnClick
			},
			'#HL7MessagesGrid': {
				itemdblclick: me.onHL7MessagesGridItemDblClick
			},
			'#HL7ServerConfigBtn': {
				click: me.onHL7ServerConfigBtnClick
			},
			'#HL7ClientConfigBtn': {
				click: me.onHL7ClientConfigBtnClick
			},
			'#HL7ConfigEditorCancelBtn': {
				click: me.onHL7ConfigEditorCancelBtnClick
			},
			'#HL7ConfigEditorSaveBtn': {
				click: me.onHL7ConfigEditorSaveBtnClick
			},


			'#HL7MessageViewerWindowResendBtn': {
				click: me.onHL7MessageViewerWindowResendBtnClick
			},
			'#HL7MessageViewerWindowPreviousBtn': {
				click: me.onHL7MessageViewerWindowPreviousBtnClick
			},
			'#HL7MessageViewerWindowNextBtn': {
				click: me.onHL7MessageViewerWindowNextBtnClick
			},
			'#HL7MessageViewerWindowCloseBtn': {
				click: me.onHL7MessageViewerWindowCloseBtnClick
			},
			'#HL7MessageViewerMessageEditBtn': {
				toggle: me.onHL7MessageViewerMessageEditBtnToggle
			}
		});

	},

	onHL7ConfigEditorCancelBtnClick: function(btn){
		btn.up('window').close();
	},

	onHL7ConfigEditorSaveBtnClick: function(btn){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			record = form.getRecord();

		record.set(values);

		if(!Ext.Object.isEmpty(record.getChanges())){
			record.save({
				callback: function () {
					win.close();
					app.msg(_('sweet'), _('record_saved'));
				}
			});
		}else{
			win.close();
		}

	},

	onHL7ServerConfigBtnClick: function(btn){
		var grid = btn.up('grid'),
			selection = grid.getSelectionModel().getSelection();

		if(selection.length === 0){
			return;
		}

		var win = this.showConfigEditorWindow();
		win.down('form').getForm().loadRecord(selection[0]);
	},

	onHL7ClientConfigBtnClick: function(btn){
		var grid = btn.up('grid'),
			selection = grid.getSelectionModel().getSelection();

		if(selection.length === 0){
			return;
		}

		var win = this.showConfigEditorWindow();
		win.down('form').getForm().loadRecord(selection[0]);
	},

	showConfigEditorWindow: function(){
		return Ext.create('Ext.window.Window', {
			title: 'Configuration',
			height: 400,
			width: 600,
			layout: 'fit',
			modal: true,
			items: {
				xtype: 'form',
				layout: 'fit',
				items: [
					{
						xtype: 'textareafield',
						name: 'config'
					}
				]
			},
			buttons: [
				{
					xtype: 'button',
					text: _('cancel'),
					itemId: 'HL7ConfigEditorCancelBtn'
				},
				{
					xtype: 'button',
					text: _('save'),
					itemId: 'HL7ConfigEditorSaveBtn'
				}
			]
		}).show();
	},

	onAddHL7ServerBtnClick: function(){
		var me = this,
			grid = me.getHL7ServersGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {});
		grid.editingPlugin.startEdit(0, 0);
	},

	onAddHL7ClientBtnClick: function(){
		var me = this,
			grid = me.getHL7ClientsGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {});
		grid.editingPlugin.startEdit(0, 0);
	},

	onRemoveHL7ServerBtnClick: function(){

	},

	onRemoveHL7ClientBtnClick: function(){

	},

	serverStartHandler: function(record){
		HL7ServerHandler.start({
            id: record.data.id,
            ip: record.data.ip,
            port: record.data.port
        }, function(provider, response){
			record.set({'online': response.result.online, token: response.result.token});
			record.commit();
		});
	},

	serverStopHandler: function(record){
		HL7ServerHandler.stop({
			id: record.data.id,
            token: record.data.token,
            ip: record.data.ip,
            port: record.data.port
        }, function(provider, response){
			record.set({'online': response.result.online});
			record.commit();
		});
	},

	onHL7ServersPanelActive: function(){
		this.reloadStore();
	},

	reloadStore: function(){
		this.getHL7ServersGrid().getStore().load();
		this.getHL7ClientsGrid().getStore().load();
	},

	onHL7ServersGridBeforeEdit: function(plugin, e){
		var multiField = plugin.editor.query('multitextfield')[0],
			data = e.record.data.allow_ips;

		Ext.Function.defer(function(){
			multiField.setValue(data);
		}, 10);
	},

	onHL7ServersGridValidateEdit: function(plugin, e){
		var multiField = plugin.editor.query('multitextfield')[0],
			values = multiField.getValue();
		e.record.set({ allow_ips: values });
	},

	onHL7MessagesViewBtnClick: function(){
		this.showHL7MessagesByReference(undefined);
	},

	showHL7MessagesByReference: function(reference){
		this.showHL7MessagesWindow();
		if(reference){
			this.getHL7MessagesGrid().getStore().clearFilter(true);
			this.getHL7MessagesGrid().getStore().filter([
				{
					property: 'reference',
					value: reference
				}
			]);
		}else{
			this.getHL7MessagesGrid().getStore().clearFilter(true);
			this.getHL7MessagesGrid().getStore().load();
		}
	},

	onHL7MessagesGridItemDblClick: function(grid, record){
		this.viewHL7MessageDetailById(record.get('id'));
	},

	viewHL7MessageDetailById: function(message_id){
		var me = this,
			win = me.showHL7MessageDetailWindow(),
			form = win.down('form').getForm();

		HL7Messages.getMessageById(message_id, function(response){
			response.raw_message = Ext.clone(response.message).split("\r").join("\r\n");
			response.message = me.colourizer(response.message);
			response.response = me.colourizer(response.response);
			form.setValues(response);
		});
	},

	showHL7MessageDetailWindow: function(){
		if(!this.getHL7MessageViewerWindow()){
			Ext.create('App.view.administration.HL7MessageViewer');
		}
		return this.getHL7MessageViewerWindow().show();
	},

	showHL7MessagesWindow: function(){
		if(!this.getHL7MessagesWindow()){
			Ext.create('App.view.administration.HL7Messages');
		}
		return this.getHL7MessagesWindow().show();
	},

	onHL7MessageViewerWindowResendBtnClick: function(btn){
		var values = btn.up('window').down('form').getForm().getValues(),
			message = values.raw_message,
			is_outbound = values.isOutbound;

		if(!is_outbound){
			app.msg(_('oops'), 'Only outbound messages can be resend', true);
			return;
		}

		HL7Messages.getResendMessage(message, function (response) {

			say(response);


		});
	},

	onHL7MessageViewerMessageEditBtnToggle: function (btn, pressed){

		this.getHL7MessageViewerRawMessageField().setVisible(pressed);
		this.getHL7MessageViewerMessageField().setVisible(!pressed);

	},

	onHL7MessageViewerWindowPreviousBtnClick: function(btn){
		var messages_grid = this.getHL7MessagesWindow().down('grid'),
			messages_store = messages_grid.getStore(),
			message_sm = messages_grid.getSelectionModel(),
			message_last_selected = message_sm.getLastSelected(),
			message_last_selected_index = messages_store.findBy(function (record, id) {
				return message_last_selected.get('id') === id;
			}),
			message_next_record_index = message_last_selected_index - 1,
			message_next_record = messages_store.getAt(message_next_record_index),
			message_form = btn.up('window').down('form').getForm();

		say(message_last_selected_index);
		say(message_next_record_index);
		say(message_form);

		if(!message_next_record){
			btn.up('window').close();
			return;
		}


		message_sm.select(message_next_record);

		this.viewHL7MessageDetailById(message_next_record.get('id'));

	},

	onHL7MessageViewerWindowNextBtnClick: function(btn){
		var messages_grid = this.getHL7MessagesWindow().down('grid'),
			messages_store = messages_grid.getStore(),
			message_sm = messages_grid.getSelectionModel(),
			message_last_selected = message_sm.getLastSelected(),
			message_last_selected_index = messages_store.findBy(function (record, id) {
				return message_last_selected.get('id') === id;
			}),
			message_next_record_index = message_last_selected_index + 1,
			message_next_record = messages_store.getAt(message_next_record_index),
			message_form = btn.up('window').down('form').getForm();

		say(message_last_selected_index);
		say(message_next_record_index);
		say(message_form);

		if(!message_next_record){
			btn.up('window').close();
			return;
		}

		message_sm.select(message_next_record);

		this.viewHL7MessageDetailById(message_next_record.get('id'));
	},

	onHL7MessageViewerWindowCloseBtnClick: function(btn){
		btn.up('window').close();
	},

	colourizer: function(message) {

		var lines = message.split("\r");
		var output = "";
		for (var index in lines) {
			var nextLine = lines[index];
			if (nextLine.length < 3) {
				output = output + nextLine + "<br>";
				continue;
			}

			var fields = nextLine.split("|");
			for (var fIndex in fields) {
				var nextField = fields[fIndex];
				if (fIndex == 0) {
					output = output + "<span style=\"color: #000080;\"><b>" + nextField + "</b></span>";
				} else {

					var reps = nextField.split("~");
					for (var rIndex in reps) {
						var nextRep = reps[rIndex];

						if (rIndex > 0) {
							output = output + "<span style=\"color: #808080;\">~</span>";
						}

						var comps = nextRep.split("^");
						for (var cIndex in comps) {
							var nextComp = comps[cIndex];

							if (cIndex > 0) {
								output = output + "<span style=\"color: #808080;\">^</span>";
							}

							var subcomps = nextComp.split("&");
							for (var sIndex in subcomps) {
								var nextSubComp = subcomps[sIndex];

								if (sIndex > 0) {
									output = output + "<span style=\"color: #808080;\">&</span>";
								}

								if (nextSubComp.match(/^[0-9./]+/)) {
									nextSubComp = "<span style=\"color: #990033;\">" + nextSubComp + "</span>";
								}

								output = output + nextSubComp;

							}
						}
					}
				}

				output = output + "<span style=\"color: #808080;\"><b>|</b></span>";

			}

			output = output + "<br>";
		}

		return output;

		// output = output.replace(/<br>/g, "<br>\n");
		// output = output.replace(/&/g, "&amp;");
		// output = output.replace(/>/g, "&gt;");
		// output = output.replace(/</g, "&lt;");
		// document.getElementById('outHtml').innerHTML = "<pre>" + output + "</pre>";

		//window.alert(value);

	}

});

Ext.define('App.controller.administration.PoolAreas', {
    extend: 'Ext.app.Controller',

	refs: [
		{
			ref:'PoolAreasPanel',
			selector:'#PoolAreasPanel'
		},
		{
			ref:'PoolAreasGrid',
			selector:'#PoolAreasGrid'
		}
	],

	init: function() {
		var me = this;

		me.control({
			'#PoolAreasPanel':{
				activate: me.onPoolAreasPanelActive,
			},
			'#PoolAreasPanelAddBtn':{
				click: me.onPoolAreasPanelAddBtnClick,
			}
		});
	},

	onPoolAreasPanelActive: function(panel){
		this.getPoolAreasGrid().getStore().load();
	},

	onPoolAreasPanelAddBtnClick: function(btn){
		var	grid = this.getPoolAreasGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			active: 0
		});
		grid.editingPlugin.startEdit(0, 0);
	},

});

Ext.define('App.controller.administration.Printers', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'AdministrationPrintersGrid',
			selector: '#AdministrationPrintersGrid'
		},
	],

	init: function(){

		var me = this;

		me.control({
			'#AdministrationPrintersAddBtn': {
				click: me.onAdministrationPrintersAddBtnClick
			},
			'#AdministrationPrintersRemoveBtn': {
				click: me.onAdministrationPrintersRemoveBtnClick
			}
		});

	},

	onAdministrationPrintersAddBtnClick: function () {
		var editingPlugin = this.getAdministrationPrintersGrid().editingPlugin,
			records;

		editingPlugin.cancelEdit();

		records = this.getAdministrationPrintersGrid().getStore().add({});

		editingPlugin.startEdit(records[0], 0);
	},

	onAdministrationPrintersRemoveBtnClick: function () {
		var me = this,
			grid = me.getAdministrationPrintersGrid(),
			editingPlugin = grid.editingPlugin,
			store = grid.getStore(),
			selection = grid.getSelectionModel().getSelection()[0];

		editingPlugin.cancelEdit();

		store.remove(selection);
		store.sync();
	}

});
Ext.define('App.controller.administration.Practice', {
    extend: 'Ext.app.Controller',

	refs: [
		{
			ref:'PracticePanel',
			selector:'practicepanel'
		}
	],

	init: function() {
		var me = this;

		me.control({
			'practicepanel grid':{
				activate: me.onPracticeGridPanelsActive,
			},
			'practicepanel button[toggleGroup=insurance_number_group]':{
				toggle: me.onInsuranceNumberGroupToggle
			},
			'practicepanel toolbar > #addBtn':{
				click: me.onAddBtnClick
			}
		});
	},

	onPracticeGridPanelsActive: function(grid){
		grid.getStore().load();
	},

	onAddBtnClick: function(btn){
		var	grid = btn.up('grid'),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			active: 1
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onInsuranceNumberGroupToggle:function(btn, pressed){
		var grid = btn.up('grid');

		if(pressed) {
			grid.view.features[0].enable();
			grid.getStore().group(btn.action);
		}else{
			grid.view.features[0].disable();
		}
	}

});

Ext.define('App.controller.administration.ReferringProviders', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'ReferringProvidersPanel',
			selector: 'referringproviderspanel'
		},
		{
			ref: 'ReferringProviderAddBtn',
			selector: '#referringProviderAddBtn'
		},
		{
			ref: 'ReferringProviderWindow',
			selector: '#ReferringProviderWindow'
		},
		{
			ref: 'ReferringProviderWindowForm',
			selector: '#ReferringProviderWindowForm'
		},
		{
			ref: 'ReferringProviderWindowGrid',
			selector: '#ReferringProviderWindowGrid'
		},
		{
			ref: 'ReferringProviderInsuranceBlacklistGrid',
			selector: '#ReferringProviderInsuranceBlacklistGrid'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				referringproviderddbtnclick: me.onReferringProviderSearchAddBtnClick
			},
			'referringproviderspanel': {
				itemdblclick: me.onReferringProvidersPanelItemDblClick
			},
			'#referringProviderAddBtn': {
				click: me.onReferringProviderAddBtnClick
			},
			'#ReferringProviderWindow': {
				close: me.onReferringProviderWindowClose
			},
			'#ReferringProviderWindowCancelBtn': {
				click: me.onReferringProviderWindowCancelBtnClick
			},
			'#ReferringProviderWindowSaveBtn': {
				click: me.onReferringProviderWindowSaveBtnClick
			},
			'#ReferringProviderFacilityAddBtn': {
				click: me.onReferringProviderFacilityAddBtnClick
			},
			'#ReferringProviderAuthyRegisterBtn': {
				click: me.onReferringProviderAuthyRegisterBtnClick
			},
			'#ReferringProviderWindowFormNpiSearchField': {
				searchresponse: me.onReferringProviderWindowFormNpiSearchFieldSearchResponse
			},
			'#ProceduresHistoryGridPerformerField': {
				select: me.onProceduresHistoryGridPerformerFieldSelect
			},
			'#ProceduresHistoryGridServiceLocationField': {
				select: me.onProceduresHistoryGridServiceLocationFieldSelect
			},

			'#ReferringProviderInsuranceBlacklistGrid': {
				beforeedit: me.onReferringProviderInsuranceBlacklistGridBeforeEdit,
				validateedit: me.onReferringProviderInsuranceBlacklistGridValidateEdit
			},
			'#ReferringProviderInsuranceBlacklistAddBtn': {
				click: me.onReferringProviderInsuranceBlacklistAddBtnClick
			},
			'#ReferringProviderInsuranceBlacklistInsuranceCmb': {
				select: me.onReferringProviderInsuranceBlacklistInsuranceCmbSelect
			},
			'#ReferringProviderInsuranceBlacklistSpecialtyCmb': {
				select: me.onReferringProviderInsuranceBlacklistSpecialtyCmbSelect
			}
		});
	},

	onReferringProviderInsuranceBlacklistGridBeforeEdit: function (plugin, context){
		return a('allow_edit_referring_physician_blacklist');
	},

	onReferringProviderInsuranceBlacklistGridValidateEdit: function (plugin, context){

		//say('onReferringProviderInsuranceBlacklistGridValidateEdit');
		//say(plugin);
		//say(context);
		var form = plugin.editor.getForm(),
			specialty_combo = form.findField('specialty_id'),
			specialty_combo_record = specialty_combo.findRecordByValue(specialty_combo.getValue()),
			insurance_combo = form.findField('insurance_id'),
			insurance_combo_record = insurance_combo.findRecordByValue(insurance_combo.getValue());

		// say(form);
		// say(insurance_combo);
		// say(insurance_combo_record);

		if(specialty_combo_record){
			context.record.set({specialty_name: specialty_combo_record.get('title')});
		}else{
			context.record.set({specialty_name: ''});
		}

		if(insurance_combo_record){
			context.record.set({insurance_name: insurance_combo_record.get('name')});
		}else{
			context.record.set({insurance_name: ''});
		}

	},

	onReferringProviderInsuranceBlacklistAddBtnClick: function (btn){
		var form = btn.up('window').down('form').getForm(),
			grid = btn.up('grid'),
			store = grid.getStore();

		if(!form.isValid()){
			app.msg(_('oops'), _('invalid_values_found'), true);
			return;
		}

		grid.editingPlugin.cancelEdit();
		grid.editingPlugin.startEdit(store.add({
			npi: form.findField('npi').getValue()
		})[0], 1);
	},

	onReferringProviderInsuranceBlacklistInsuranceCmbSelect: function (cmb){

	},

	onReferringProviderInsuranceBlacklistSpecialtyCmbSelect: function (cmb){

	},

	onProceduresHistoryGridPerformerFieldSelect: function(field, selection){

		if(selection.length === 0) return;

		var record = field.up('form').getForm().getRecord();

		record.set({
			performer_id: selection[0].get('id')
		});
	},

	onProceduresHistoryGridServiceLocationFieldSelect: function(field, selection){

		if(selection.length === 0) return;

		var record = field.up('form').getForm().getRecord();

		record.set({
			service_location_id: selection[0].get('id')
		});
	},

	onReferringProviderAuthyRegisterBtnClick: function(){
		var referring_grid = this.getReferringProvidersPanel(),
			referring_store = referring_grid.getStore(),
			referring_record = referring_grid.getSelectionModel().getLastSelected();

		//say(referring_record);

		TwoFactorAuthentication.registerUserByIdAndType(
			referring_record.get('id'),
			'referring',
			referring_record.get('email'),
			referring_record.get('cel_number').replace(/[-() ]/g,''),
			function (response) {
				say(response);
				if(!response.success){
					app.msg(_('oops'), response.errors.replace(/,/g, '<br>'), true);
				}else {
					referring_record.set({authy_id: response.authy_id});
					referring_record.commit();
					referring_grid.view.refresh();
				}
			}
		);
	},

	onReferringProviderWindowFormNpiSearchFieldSearchResponse: function (field, result) {

		if (!result.success) {
			app.msg(_('oops'), result.error, true);
			return;
		}

		if (result.data === false) {
			app.msg(_('oops'), _('no_provider_found'), true);
			return;
		}

		var values = {
			global_id: null,
			title: result.data.basic.name_prefix,
			fname: result.data.basic.first_name || '',
			mname: '',
			lname: result.data.basic.last_name || '',
			organization_name: result.data.basic.organization_name || '',
			active: 1,
			npi: result.data.number,
			lic: '',
			taxonomy: '',
			upin: '',
			ssn: '',
			notes: 'NPI registry import',
			username: '',
			password: '',
			authorized: 0,
			email: '',
			phone_number: '',
			fax_number: '',
			cel_number: ''
		};

		var facilities = [];

		if(result.data.taxonomies) {
			result.data.taxonomies.forEach(function (taxonomy) {
				if (!taxonomy.primary) return;
				values.taxonomy = taxonomy.code || '';
				values.lic = taxonomy.license || '';
			});
		}

		if(result.data.addresses){
			result.data.addresses.forEach(function (address) {
				if(address.address_purpose !== 'LOCATION') return;
				values.phone_number = address.telephone_number || '';
				values.fax_number = address.fax_number || '';

				facilities = Ext.Array.push(facilities, {
					name: values.organization_name,
					address: address.address_1 || '',
					address_cont: address.address_2 || '',
					city: address.city || '',
					postal_code: address.postal_code || '',
					state: address.state || ''
				});
			});
		}

		var form = field.up('form').getForm(),
			store = this.getReferringProviderWindowGrid().getStore();
		form.setValues(values);
		store.add(facilities);

	},

	onReferringProviderSearchAddBtnClick: function (field, field_record) {
		var me = this;

		if(field_record){
			App.model.administration.ReferringProvider.load(field_record.get('id'), {
				success: function(referring_record) {
					me.doReferringProviderWindow(referring_record);
				}
			});
		}else{
			me.doReferringProviderWindow();
		}

		me.triggerField = field;
	},

	onReferringProviderAddBtnClick: function () {
		this.doReferringProviderWindow();
		this.triggerField = undefined;
	},

	onReferringProvidersPanelItemDblClick: function (grid, referring_record) {
		this.doReferringProviderWindow(referring_record);
		this.triggerField = undefined;
	},

	doReferringProviderWindowByReferringId: function (referring_id, callback) {
		var me = this;

		App.model.administration.ReferringProvider.load(referring_id, {
			success: function (referring_record) {
				referring_record.saveCallback = callback;
				me.doReferringProviderWindow(referring_record);
			}
		});
	},


	doReferringProviderWindow: function (referring_record) {

		referring_record = referring_record || Ext.create('App.model.administration.ReferringProvider', {
				global_id: null,
				create_date: new Date(),
				update_date: new Date(),
				create_uid: app.user.id,
				update_uid: app.user.id,
				username: null,
				active: 1
			});

		this.showReferringProviderWindow();

		var form = this.getReferringProviderWindowForm().getForm(),
			facilities_grid = this.getReferringProviderWindowGrid(),
			facilities_store = referring_record.facilities(),
			insurance_blacklist_grid = this.getReferringProviderInsuranceBlacklistGrid(),
			insurance_blacklist_store = referring_record.blacklist();

		form.loadRecord(referring_record);

		facilities_grid.reconfigure(facilities_store);
		facilities_store.load();

		insurance_blacklist_grid.reconfigure(insurance_blacklist_store);
		insurance_blacklist_store.load();
	},

	onReferringProviderWindowClose: function () {
		this.getReferringProviderWindowForm().getForm().reset();
		this.getReferringProviderWindowGrid().getStore().removeAll();
	},

	onReferringProviderWindowCancelBtnClick: function () {
		this.getReferringProviderWindow().close();
	},

	onReferringProviderWindowSaveBtnClick: function () {
		var me = this,
			form = me.getReferringProviderWindowForm().getForm(),
			store = me.getReferringProviderWindowGrid().getStore(),
			record = form.getRecord(),
			values = form.getValues();

		if(!form.isValid()) return;

		if((values.lname.trim() != '' || values.fname.trim() != '') && values.organization_name.trim() == ''){
			app.msg(_('oops'), _('referring_name_validation_msg'), true);
			return;
		}

		values.update_date = new Date();
		values.update_uid = app.user.id;
		if(values.username === '') values.username = null;

		record.set(values);

		record.save({
			callback: function (provider_record) {
				var sync_records = Ext.Array.merge(store.getUpdatedRecords(), store.getNewRecords());

				if(sync_records.length > 0){
					sync_records.forEach(function (sync_record) {
						sync_record.set({referring_provider_id: provider_record.get('id')})
					});

					store.sync({
						callback: function () {
							me.getReferringProviderWindow().close();
							me.recordSaveHandler(provider_record);
						}
					});
				}else {
					me.getReferringProviderWindow().close();
					me.recordSaveHandler(provider_record);
				}
			}
		});
	},

	recordSaveHandler: function (provider_record) {
		if(this.triggerField){
			var records = this.triggerField.store.add(provider_record.data);
			this.triggerField.select(records[0]);
			this.triggerField.fireEvent('select', this.triggerField, records);
		}else if(provider_record.saveCallback && typeof provider_record.saveCallback == 'function'){
			provider_record.saveCallback();
		}else if(!provider_record.store){
			this.getReferringProvidersPanel().getStore().insert(0, provider_record);
		}else{
			this.getReferringProvidersPanel().view.refresh();
		}
	},

	onReferringProviderFacilityAddBtnClick: function () {
		var grid = this.getReferringProviderWindowGrid();
		grid.editingPlugin.cancelEdit();

		var records = grid.getStore().add({
			create_date: new Date(),
			update_date: new Date(),
			create_uid: app.user.id,
			update_uid: app.user.id
		});

		grid.editingPlugin.startEdit(records[0], 0);
	},

	showReferringProviderWindow: function () {
		if(!this.getReferringProviderWindow()){
			Ext.create('App.view.administration.ReferringProviderWindow');
		}
		return this.getReferringProviderWindow().show();
	}

});

Ext.define('App.controller.administration.Specialties', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'SpecialtiesPanel',
			selector: 'specialtiespanel'
		},
		{
			ref: 'SpecialtiesAddBtn',
			selector: '#SpecialitiesAddBtn'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#SpecialitiesAddBtn': {
				click: me.onSpecialtiesAddBtnClick
			}
		});

	},

	onSpecialtiesAddBtnClick: function(btn){

		var grid = btn.up('grid');

		grid.editingPlugin.cancelEdit();
		var recs = grid.getStore().insert(0, {
			create_date: new Date(),
			update_date: new Date(),
			create_uid: app.user.id,
			update_uid: app.user.id,
			active: 1
		});
		grid.editingPlugin.startEdit(recs[0], 0);
	}

});
Ext.define('App.controller.administration.EmailTemplates', {
	extend: 'Ext.app.Controller',

	uses: [

	],

	refs: [
		{
			ref: 'AdministrationEmailTemplates',
			selector: '#AdministrationEmailTemplates'
		},
		{
			ref: 'AdministrationEmailTemplatesGrid',
			selector: '#AdministrationEmailTemplatesGrid'
		},
		{
			ref: 'AdministrationEmailTemplateWindow',
			selector: '#AdministrationEmailTemplateWindow'
		},
		{
			ref: 'AdministrationEmailTemplateForm',
			selector: '#AdministrationEmailTemplateForm'
		}
	],

	init: function () {
		var me = this;

		me.control({
			'#AdministrationEmailTemplates': {
				activate: me.onAdministrationEmailTemplatesActivate
			},
			'#AdministrationEmailTemplatesGrid': {
				itemdblclick: me.onAdministrationEmailTemplatesGridItemDblClick
			},
			'#AdministrationEmailTemplateCancelBtn': {
				click: me.onAdministrationEmailTemplateCancelBtnClick
			},
			'#AdministrationEmailTemplateSaveBtn': {
				click: me.onAdministrationEmailTemplateSaveBtnClick
			},
			'#AdministrationEmailTemplateBodyField': {
				push: me.onAdministrationEmailTemplateBodyFieldRender
			}
		});

	},

	onAdministrationEmailTemplatesActivate: function () {
		this.getAdministrationEmailTemplatesGrid().getStore().load();
	},

	onAdministrationEmailTemplatesGridItemDblClick: function (grid, email_template_record) {
		this.showAdministrationEmailTemplateWindow();

		this.getAdministrationEmailTemplateForm().getForm().loadRecord(email_template_record);
	},

	onAdministrationEmailTemplateCancelBtnClick: function(btn){
		this.getAdministrationEmailTemplateForm().getForm().reset(true);
		this.getAdministrationEmailTemplateWindow().close();
	},

	onAdministrationEmailTemplateSaveBtnClick: function(btn){

		var win = this.getAdministrationEmailTemplateWindow(),
			form = this.getAdministrationEmailTemplateForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();


		if(!form.isValid()) return;

		record.set(values);

		if(!Ext.Object.isEmpty(record.getChanges())){
			record.store.sync({
				callback: function () {
					form.reset(true);
					win.close();
				}
			});
		}else{
			form.reset(true);
			win.close();
		}
	},

	onAdministrationEmailTemplateBodyFieldRender: function(editor){

		say('onAdministrationEmailTemplateBodyFieldRender');

		if (editor.iframeEl) {
			/* This is very hacky... we're getting the textareaEl, which
			 * was provided to us, and getting its next sibling, which is
			 * the iframe... and then we're probing the iframe for the
			 * body and changing its background-color to the selected hex */
			var iframe = editor.iframeEl.dom;
			if (iframe) {
				var doc = (iframe.contentDocument) ? iframe.contentDocument : iframe.contentWindow.document;
				if (doc && doc.body && doc.body.style) {
					doc.body.style['color'] = null;
					doc.body.style['background-color'] = null;
				}
			}
		}
	},

	showAdministrationEmailTemplateWindow: function () {
		if(!this.getAdministrationEmailTemplateWindow()){
			Ext.create('App.view.administration.EmailTemplateWindow');
		}
		return this.getAdministrationEmailTemplateWindow().show();
	}

});
Ext.define('App.controller.administration.EncounterTemplatePanels', {
	extend: 'Ext.app.Controller',

	uses: [
		'App.ux.LiveRadsSearch',
		'App.ux.LiveLabsSearch',
	],

	refs: [
		{
			ref: 'TemplatePanelsWindow',
			selector: '#TemplatePanelsWindow'
		},
		{
			ref: 'TemplatePanelsGrid',
			selector: '#TemplatePanelsGrid'
		},
		{
			ref: 'TemplatePanelsCombo',
			selector: '#TemplatePanelsCombo'
		},
		{
			ref: 'SoapTemplatesBtn',
			selector: '#SoapTemplatesBtn'
		},
		{
			ref: 'encounterPanel',
			selector: '#encounterPanel'
		},
		{
			ref: 'encounterPanel',
			selector: '#encounterPanel'
		},
		{
			ref: 'soapPanel',
			selector: '#soapPanel'
		},
		{
			ref: 'soapForm',
			selector: '#soapForm'
		},

		// Admin
		{
			ref: 'AdministrationEncounterTemplatesPanel',
			selector: '#AdministrationEncounterTemplatesPanel'
		},
		{
			ref: 'AdministrationEncounterTemplatesGrid',
			selector: '#AdministrationEncounterTemplatesGrid'
		},
		{
			ref: 'AdministrationEncounterTemplateWindow',
			selector: '#AdministrationEncounterTemplateWindow'
		},
		{
			ref: 'AdministrationEncounterTemplateForm',
			selector: '#AdministrationEncounterTemplateForm'
		},
		{
			ref: 'AdministrationEncounterTemplateGrid',
			selector: '#AdministrationEncounterTemplateGrid'
		},
	],

	init: function () {
		var me = this;

		me.control({
			'viewport': {
				encounterload: me.onEncounterLoad
			},
			'#encounterPanel': {
				// activate: me.onSoapPanelActivate,
				beforerender: me.onEncounterPanelBeforeRender
			},
			'#TemplatePanelsCombo': {
				select: me.onTemplatePanelsComboSelect
			},
			'#SoapTemplatesBtn': {
				click: me.onSoapTemplatesBtnClick
			},
			'#TemplatePanelsAddBtn': {
				click: me.onTemplatePanelsAddBtnClick
			},
			'#TemplatePanelsCancelBtn': {
				click: me.onTemplatePanelsCancelBtnClick
			},

			// Admin
			'#AdministrationEncounterTemplatesPanel': {
				activate: me.onAdministrationEncounterTemplatesPanelActivate
			},
			'#AdministrationEncounterTemplatesGrid': {
				itemdblclick: me.onAdministrationEncounterTemplatesGridItemDblClick
			},
			'#AdministrationEncounterTemplateForm': {
				loadrecord: me.onAdministrationEncounterTemplateFormLoadRecord
			},
			'#EncounterTemplatesAddBtn': {
				click: me.onEncounterTemplatesAddBtnClick
			},
			'#AdministrationEncounterTemplateRadOrderAddBtn': {
				click: me.onAdministrationEncounterTemplateRadOrderAddBtnClick
			},
			'#AdministrationEncounterTemplateLabOrderAddBtn': {
				click: me.onAdministrationEncounterTemplateLabOrderAddBtnClick
			},
			'#AdministrationEncounterTemplateCancelBtn': {
				click: me.onAdministrationEncounterTemplateCancelBtnClick
			},
			'#AdministrationEncounterTemplateSaveBtn': {
				click: me.onAdministrationEncounterTemplateSaveBtnClick
			}
		});

	},

	onEncounterLoad: function (encounter) {

		if (!this.getTemplatePanelsWindow()) {
			Ext.create('App.view.patient.windows.EncounterTemplatePanels');
		}

		var me = this,
			store = me.getTemplatePanelsCombo().getStore(),
			btn = me.getSoapTemplatesBtn();

		store.load({
			filters: [
				{
					property: 'specialty_id',
					value: encounter.get('specialty_id')
				},
				{
					property: 'active',
					value: 1
				}
			],
			callback: function (records) {
				if (records.length > 0) {
					btn.disabled = false;
					btn.setDisabled(false);
					btn.setTooltip(_('clinical_templates'));
				} else {
					btn.disabled = true;
					btn.setDisabled(true);
					btn.setTooltip(_('no_templates_found'));
				}
			}
		});
	},

	onEncounterPanelBeforeRender: function () {
		this.getSoapForm().getDockedItems('toolbar[dock="bottom"]')[0].insert(0, [{
			xtype: 'button',
			text: _('templates'),
			itemId: 'SoapTemplatesBtn'
		}]);
	},

	// onSoapPanelActivate: function () {
	// 	var hasTemplates = this.getTemplatePanelsCombo().getStore().data.items.length > 0,
	// 		btn = this.getSoapTemplatesBtn();
	//
	// 	if (hasTemplates) {
	// 		btn.disabled = false;
	// 		btn.setDisabled(false);
	// 		btn.setTooltip(_('clinical_templates'));
	// 	} else {
	// 		btn.disabled = true;
	// 		btn.setDisabled(true);
	// 		btn.setTooltip(_('no_templates_found'));
	// 	}
	//
	// },

	onSoapTemplatesBtnClick: function () {
		this.doTemplatePanelsWindowShow();
	},

	onTemplatePanelsComboSelect: function (cmb, records) {
		var me = this,
			grid = me.getTemplatePanelsGrid(),
			sm = grid.getSelectionModel(),
			store = records[0].templates();

		grid.reconfigure(store);
		store.load({
			callback: function () {
				sm.selectAll();
			}
		});
	},

	doTemplatePanelsWindowShow: function () {
		this.getTemplatePanelsGrid().getStore().removeAll();
		this.getTemplatePanelsCombo().reset();
		return this.getTemplatePanelsWindow().show();
	},

	onTemplatePanelsAddBtnClick: function () {
		var me = this,
			cmb = me.getTemplatePanelsCombo(),
			records = me.getTemplatePanelsGrid().getSelectionModel().getSelection();

		if (!cmb.isValid()) return;

		if (records.length === 0) {
			app.msg(_('oops'), _('no_templates_to_add'), true);
			return;
		}

		Ext.Msg.show({
			title: _('wait'),
			msg: _('add_templates_message'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if (btn == 'yes') {
					me.doAddTemplates(records);
					me.getTemplatePanelsWindow().close();
				}
			}
		});
	},

	doAddTemplates: function (templates) {

		app.onMedicalWin();

		templates.forEach(function (template) {

			var type = template.get('template_type'),
				data = eval('(' + template.get('template_data') + ')');

			if (!data) {
				say('Error: data eval issue -- ' + data);
				return;
			}

			data.pid = app.patient.pid;
			data.eid = app.patient.eid;
			data.uid = app.user.id;
			data.date_ordered = new Date();

			switch (type) {

				case 'LAB':
					App.app.getController('patient.LabOrders').doAddOrderByTemplate(data);
					break;
				case 'RAD':
					App.app.getController('patient.RadOrders').doAddOrderByTemplate(data);
					break;
				case 'RX':
					App.app.getController('patient.RxOrders').doAddOrderByTemplate(data);
					break;
				case 'REF':
					App.app.getController('patient.Referrals').doAddReferralByTemplate(data);
					break;
				default:
					say('Error: no template_type found -- ' + type);
					break;
			}

		});


		Ext.Function.defer(function () {
			app.getActivePanel().getProgressNote();
		}, 500);


	},

	onTemplatePanelsCancelBtnClick: function () {
		this.getTemplatePanelsWindow().close();
	},

	getLabTemplate: function (code, description) {
		return {
			pid: 0,
			eid: 0,
			uid: 0,
			code: code, //                  58410-2,    24356-8,    24321-2,    34529-8
			code_type: "LOINC",
			date_collected: null,
			date_ordered: '',
			description: description, //    CBC,        U/A,        BMP         PT & PPT
			hl7_recipient_id: 0,
			note: "",
			order_type: "lab",
			priority: "Normal",
			status: "Pending",
			type: "Laboratory",
			void: false,
			void_comment: ""
		};
	},

	getRadTemplate: function (code, description) {
		return {
			pid: 0,
			eid: 0,
			uid: 0,
			code: code,//               24650-4,                        36572-6
			code_type: "LOINC",
			date_collected: null,
			date_ordered: '',
			description: description,// Chest X-Ray AP & Lateral,       Chest X-Ray AP 1 View
			hl7_recipient_id: 0,
			note: "",
			order_type: "rad",
			priority: "Normal",
			status: "Pending",
			type: "Radiology",
			void: false,
			void_comment: ""
		};
	},

	getRefTemplate: function (service_code, service_description, referal_reason) {

		return {
			pid: 0,
			eid: 0,
			refer_by: 0,
			refer_by_text: '',
			referral_date: '',
			create_uid: 0,
			update_uid: 0,
			create_date: null,
			update_date: null,

			is_external_referral: true,
			refer_to: '',
			refer_to_text: '',

			send_record: false,
			service_code: service_code || '',   // 29303009
			service_code_type: "SNOMED-CT",
			service_text: service_description || '', // Electrocardiographic procedure (procedure)
			risk_level: "low",
			referal_reason: referal_reason || '', // PRE-OP
			diagnosis_code: "",
			diagnosis_code_type: "",
			diagnosis_text: ""

		};
	},


	onAdministrationEncounterTemplatesPanelActivate: function(panel){
		this.getAdministrationEncounterTemplatesGrid().getStore().load();
	},

	onEncounterTemplatesAddBtnClick: function(){
		this.showEncounterTemplateWindow();
		this.getAdministrationEncounterTemplateForm().getForm().loadRecord(
			Ext.create('App.model.administration.EncounterTemplatePanel')
		);
	},

	onAdministrationEncounterTemplatesGridItemDblClick: function(gird, record){
		this.showEncounterTemplateWindow();
		this.getAdministrationEncounterTemplateForm().getForm().loadRecord(record);
	},

	onAdministrationEncounterTemplateFormLoadRecord: function(form, record){
		say('onAdministrationEncounterTemplateFormLoadRecord');
		say(form);
		say(record);

		var store = this.getAdministrationEncounterTemplateGrid().getStore();

		if(record.get('id') > 0){
			store.load({
				filters: [
					{
						property: 'panel_id',
						value: record.get('id')
					}
				]
			});
		} else {
			store.removeAll();
			store.commitChanges();
		}
	},

	onAdministrationEncounterTemplateRadOrderAddBtnClick: function(btn){
		this.getRadOrderWindow();
	},

	onAdministrationEncounterTemplateLabOrderAddBtnClick: function(btn){
		this.getLadOrderWindow();
	},

	onAdministrationEncounterTemplateCancelBtnClick: function(btn){
		this.getAdministrationEncounterTemplateForm().getForm().reset(true);
		this.getAdministrationEncounterTemplateWindow().close();
	},

	onAdministrationEncounterTemplateSaveBtnClick: function(btn){

		var me = this,
			form = this.getAdministrationEncounterTemplateForm().getForm(),
			template_record = form.getRecord(),
			template_values = form.getValues();

		if(!form.isValid()) return;

		template_record.set(template_values);

		var template_record_changes = template_record.getChanges();

		if(!Ext.Object.isEmpty(template_record_changes)){
			template_record.save({
				callback: function (record) {
					me.onAdministrationEncounterTemplateItemsSave(template_record);
				}
			});
		}else{
			me.onAdministrationEncounterTemplateItemsSave(template_record);
		}

	},

	onAdministrationEncounterTemplateItemsSave: function(template_record){
		var me = this,
			items_store = this.getAdministrationEncounterTemplateGrid().getStore(),
			items_modified_records = items_store.getModifiedRecords();


		items_modified_records.forEach(function (items_modified_record) {
			items_modified_record.set({panel_id: template_record.get('id')});
		});

		if(items_modified_records.length > 0){

			items_store.sync({
				callback: function () {
					me.getAdministrationEncounterTemplateForm().getForm().reset(true);
					me.getAdministrationEncounterTemplateWindow().close();
				}
			});

		}else{
			me.getAdministrationEncounterTemplateForm().getForm().reset(true);
			me.getAdministrationEncounterTemplateWindow().close();
		}








	},


	showEncounterTemplateWindow: function () {

		if(!this.getAdministrationEncounterTemplateWindow()){
			Ext.create('App.view.administration.EncounterTemplateWindow');
		}
		return this.getAdministrationEncounterTemplateWindow().show();
	},

	addAdministrationEncounterTemplateGridRecord: function(description, template_type, template_data){
		var store = this.getAdministrationEncounterTemplateGrid().getStore();


		store.add({
			description: description,
			template_type: template_type,
			template_data: JSON.stringify(template_data),
			active: 1,
		});

	},

	getRadOrderWindow: function () {

		var me = this;

		Ext.create('Ext.window.Window',{
			resizable: false,
			items:[
				{
					xtype: 'form',
					bodyPadding: 10,
					items: [
						{
							xtype: 'radslivetsearch',
							fieldLabel: _('study'),
							labelAlign: 'top',
							hideLabel: false,
							width: 300
						}
					]
				}
			],
			buttons:[
				{
					xtype: 'button',
					text: _('cancel'),
					handler: function () {
						this.up('window').close();
					}
				},
				{
					xtype: 'button',
					text: _('add'),
					handler: function () {
						var field = this.up('window').down('radslivetsearch'),
							record = field.findRecordByValue(field.getValue());

						if(record){
							var tpl = me.getRadTemplate(record.get('loinc_number'), record.get('loinc_name'));
							me.addAdministrationEncounterTemplateGridRecord(tpl.description, 'RAD', tpl);
						}

						this.up('window').close();
					}
				}
			]
		}).show();
	},

	getLadOrderWindow: function () {

		var me = this;

		Ext.create('Ext.window.Window',{
			resizable: false,
			items:[
				{
					xtype: 'form',
					bodyPadding: 10,
					items: [
						{
							xtype: 'labslivetsearch',
							fieldLabel: _('study'),
							labelAlign: 'top',
							hideLabel: false,
							width: 300
						}
					]
				}
			],
			buttons:[
				{
					xtype: 'button',
					text: _('cancel'),
					handler: function () {
						this.up('window').close();
					}
				},
				{
					xtype: 'button',
					text: _('add'),
					handler: function () {
						var field = this.up('window').down('labslivetsearch'),
							record = field.findRecordByValue(field.getValue());

						if(record){
							var tpl = me.getRadTemplate(record.get('loinc_number'), record.get('loinc_name'));
							me.addAdministrationEncounterTemplateGridRecord(tpl.description, 'LAB', tpl);
						}

						this.up('window').close();
					}
				}
			]
		}).show();
	}

});
Ext.define('App.controller.administration.Version', {
    extend: 'Ext.app.Controller',
    requires: [
        'App.ux.ManagedIframe'
    ],
    refs: [
        {
            ref: 'UpdateNotesWindow',
            selector: '#UpdateNotesWindow'
        },
        {
            ref: 'UpdateNotesWindowDontShowAgainBtn',
            selector: '#UpdateNotesWindowDontShowAgainBtn'
        },
        {
            ref: 'UpdateNotesWindowIframe',
            selector: '#UpdateNotesWindow miframe'
        }

    ],

    init: function () {
        var me = this;

        me.v_major = null;
        me.v_minor = null;
        me.v_patch = null;
        me.v_notes_url = null;
        me.version = null;

        me.control({
            'viewport': {
                render: me.onViewportRender
            },
            '#UpdateNotesWindowDontShowAgainBtn': {
                click: me.onUpdateNotesWindowDontShowAgainBtn
            }
        });
    },

    onViewportRender: function(){

    	var  me = this;

        Version.getLatestUpdate(function (lastUpdate) {

            me.v_major = lastUpdate.v_major || 0;
            me.v_minor = lastUpdate.v_minor || 0;
            me.v_patch = lastUpdate.v_patch || 0;
            me.v_notes_url = lastUpdate.v_notes_url || null;

            me.version = me.v_major.toString() + '.' + me.v_minor.toString() + '.' + me.v_patch.toString();

            if (me.v_major !== null && me.v_minor !== null && me.v_patch !== null && me.v_notes_url !== null){
                Version.getUpdateAcknowledge(me.version, app.user.id, function (acknowledge) {
                    say(acknowledge);
                    if (!acknowledge) {
                        me.showUpdateNotesWindow();
                        me.getUpdateNotesWindowIframe().setSrc(me.v_notes_url);
                    }
                })
            }
        });
    },

    showUpdateNotesWindow: function () {
        var me = this;

        if (!me.getUpdateNotesWindow()) {
            Ext.create('App.view.update_notes.UpdateNotesWindow',{
                title: 'Version ' + me.version
            });
        }
        return me.getUpdateNotesWindow().show();
    },

    onUpdateNotesWindowDontShowAgainBtn: function (btn) {
        var me = this;

        Version.setUpdateAcknowledge(me.version,app.user.id,function (response) {
            me.getUpdateNotesWindow().close();
        })

    }

    // getLastUpdate: function () {
    //     var me = this;
    //
    //     Version.getLatestUpdate(function (lastUpdate) {
    //         me.version = lastUpdate.version;
    //         me.url = lastUpdate.url;
    //         if(me.version !== false || me.version != null || me.url.length !== 0 || me.url !== null){}
    //         Version.getUpdateAcknowledge(lastUpdate.id, app.user.id, function (acknowledge) {
    //             me.lastUpdateId = lastUpdate.id;
    //             if (!acknowledge) {
    //                 me.showUpdateNotesWindow();
    //                 me.getUpdateNotesWindowIframe().setSrc(me.url);
    //             }
    //         })
    //     });
    // }
});

Ext.define('App.controller.administration.Users', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'AdminUsersPanel',
			selector: '#AdminUsersPanel'
		},
		{
			ref: 'AdminUserGridPanel',
			selector: '#AdminUserGridPanel'
		},
		{
			ref: 'PasswordExpiredWindow',
			selector: '#PasswordExpiredWindow'
		},
		{
			ref: 'PasswordExpiredWindowForm',
			selector: '#PasswordExpiredWindowForm'
		},
		{
			ref: 'PasswordExpiredWindowPasswordField',
			selector: '#PasswordExpiredWindowPasswordField'
		},
		{
			ref: 'PasswordExpiredWindowConfirmPasswordField',
			selector: '#PasswordExpiredWindowConfirmPasswordField'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				afterrender: me.onApplicationAfterRender
			},
			'#AdminUserGridPanel': {
				beforeedit: me.onAdminUserGridPanelBeforeEdit
			},
			'#UserGridEditFormProviderCredentializationActiveBtn': {
				click: me.onUserGridEditFormProviderCredentializationActiveBtnClick
			},
			'#UserGridEditFormProviderCredentializationInactiveBtn': {
				click: me.onUserGridEditFormProviderCredentializationInactiveBtnClick
			},

			'#AdminUserGridPanelPrintBtn': {
				click: me.onAdminUserGridPanelPrintBtnClick
			},
			'#PasswordExpiredWindowUpdateBtn': {
				click: me.onPasswordExpiredWindowUpdateBtnClick
			},
			'#SwitchUserBtn': {
				click: me.onSwitchUserBtnClick
			},
			'#AdminUserGridPanelAuthyRegisterBtn': {
				click: me.onAdminUserGridPanelAuthyRegisterBtnClick
			},
			'#AdminUserGridPanelLDAPSyncBtn': {
				click: me.onAdminUserGridPanelLDAPSyncBtnClick
			}
		});
	},

	onAdminUserGridPanelLDAPSyncBtnClick: function(btn){

		LDAP.Sync(function (response) {

			if(response.success){
				app.msg(_('oops'), response.message);
				btn.up('grid').getStore().reload();
			}else {
				app.msg(_('oops'), response.error, true);
			}

		});
	},

	onAdminUserGridPanelAuthyRegisterBtnClick: function(btn){
		var user_grid = this.getAdminUserGridPanel(),
			user_store = user_grid.getStore(),
			user_record = user_grid.getSelectionModel().getLastSelected();

		say(user_record);

		TwoFactorAuthentication.registerUserByIdAndType(
			user_record.get('id'),
			'application',
			user_record.get('email'),
			user_record.get('mobile').replace(/[-() ]/g,''),
			function (response) {
				say(response);
				if(!response.success){
					app.msg(_('oops'), response.errors.replace(/,/g, '<br>'), true);
				}else {
					user_record.set({authy_id: response.authy_id});
					user_record.commit();
					user_grid.view.refresh();
				}
			}
		);

	},

	onAdminUserGridPanelPrintBtnClick: function(){

		var grid = this.getAdminUserGridPanel(),
			store = grid.getStore();

		store.load({
			start: 0,
			limit: 5000,
			callback: function () {
				App.ux.grid.Printer.mainTitle = 'User Report';
				App.ux.grid.Printer.filtersHtml = '------------'; //optional
				App.ux.grid.Printer.print(grid, null);
			}
		});

	},

	/***********************************************
	 ** passwrod expiration
	 ***********************************************/

	onApplicationAfterRender: function (comp) {
		if(comp.user.password_expired){
			this.doPasswordExpiredUpdate();
		}
	},

	doPasswordExpiredUpdate: function () {
		this.showPasswordExpiredWindow();
	},

	showPasswordExpiredWindow: function () {
		if(!this.getPasswordExpiredWindow()){
			Ext.create('App.view.administration.PasswordExpiredWindow');
		}
		return this.getPasswordExpiredWindow().show();
	},

	passwordConfirmationValidation: function (value) {
		if(this.getPasswordExpiredWindowPasswordField().getValue() === value){
			return true
		}

		return _('password_confirmation_error');
	},

	onPasswordExpiredWindowUpdateBtnClick: function () {
		say('onPasswordExpiredWindowUpdateBtnClick');

		var win = this.getPasswordExpiredWindow(),
			form = this.getPasswordExpiredWindowForm().getForm(),
			values = form.getValues();

		if (!form.isValid()) return;

		if(values['old_password'] == ''){
			return;
		}

		if(values['new_password'] != values['confirmation_password']){
			return;
		}

		values.id = app.user.id;

		User.updatePassword(values, function (response) {

			if(response.success){
				app.msg(_('sweet'), _('password_changed'));
				form.reset();
				win.close();
				return;
			}

			app.msg(_('oops'), _(response.message), true);
		});
	},

	onAdminUserGridPanelBeforeEdit: function(plugin, context){
		var grid = plugin.editor.down('grid'),
			store = grid.getStore(),
			filters = [
				{
					property: 'provider_id',
					value: context.record.data.id
				}
			],
			params = {};

		store.clearFilter(true);
		if(context.record.data.id > 0 && context.record.data.npi != ''){
			params = {
				providerId: context.record.data.id,
				fullList: true
			};
			Ext.Array.push(filters, {
				property: 'provider_id',
				value: null
			});
		}

		store.load({
			filters: filters,
			params: params
		});
	},

	onUserGridEditFormProviderCredentializationActiveBtnClick: function(btn){
		var store = btn.up('grid').getStore(),
			records = store.data.items,
			now = Ext.Date.format(new Date(), 'Y-m-d');

		for(var i = 0; i < records.length; i++){
			records[i].set({
				start_date: now,
				end_date: '9999-12-31',
				active: true
			});
		}
	},

	onUserGridEditFormProviderCredentializationInactiveBtnClick: function(btn){
		var store = btn.up('grid').getStore(),
			records = store.data.items,
			date = new Date(),
			yesterday = Ext.Date.format(Ext.Date.subtract(date, Ext.Date.DAY, 1), 'Y-m-d');

		for(var i = 0; i < records.length; i++){
			records[i].set({
				start_date: yesterday,
				end_date: yesterday,
				active: false
			});
		}
	},

	onSwitchUserBtnClick: function () {
		this.getController('LogOut').doApplicationLock();
	}
});
Ext.define('App.controller.administration.IpAccess', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref:'IpAccessPanel',
            selector:'ipaccesspanel'
        },
        {
            ref: 'IpAccessRulesGrid',
            selector: 'ipaccesspanel #IpAccessRulesGrid'
        },
        {
            ref: 'IpAccessLogGrid',
            selector: 'ipaccesspanel #IpAccessLogGrid'
        },
        {
            ref: 'IpAccessPanelContextMenu',
            selector: '#IpAccessPanelContextMenu'
        },
        {
            ref: 'IpAccessRulesIpField',
            selector: '#IpAccessRulesIpField'
        },
        {
            ref: 'IpAccessRulesIpFormField',
            selector: '#IpAccessRulesIpFormField'
        },
        {
            ref: 'IpAccessRulesIpToField',
            selector: '#IpAccessRulesIpToField'
        }
    ],

    init: function() {
        var me = this;

        me.control({
            'ipaccesspanel':{
                activate: me.onIpAccessPanelActive
            },
            'ipaccesspanel #addIpRule':{
                click: me.onAddIpRuleClick
            },
            'ipaccesspanel #IpAccessLogGrid':{
	            beforeitemcontextmenu: me.onIpAccessLogGridBeforeContextMenu
            },
            '#IpAccessPanelAddToWhiteListMenu':{
	            click: me.onIpAccessPanelAddToWhiteListMenuClick
            },
            '#IpAccessRulesIpField':{
	            keyup: me.onIpAccessRulesIpFieldKeyUp
            }
        });

        me.clockCtrl = me.getController('Clock');

    },

    onAddIpRuleClick: function(btn){
        var me = this,
            rulesGrid = me.getIpAccessRulesGrid();

        rulesGrid.editingPlugin.cancelEdit();
        var rercords = rulesGrid.getStore().add({
            create_date: this.clockCtrl.getTime(),
            update_date: this.clockCtrl.getTime(),
            active: 1
        });
        rulesGrid.editingPlugin.startEdit(rercords[0], 0);
    },

    onIpAccessPanelActive: function(){
        var me = this,
            rulesGrid = me.getIpAccessRulesGrid(),
            logGrid = me.getIpAccessLogGrid();

        rulesGrid.getStore().load();
        logGrid.getStore().load();
    },

	onIpAccessPanelAddToWhiteListMenuClick: function() {

    	var net_log_record = this.getIpAccessLogGrid().getSelectionModel().getLastSelected(),
    	    ip_rules_store = this.getIpAccessRulesGrid().getStore(),
    	    ip_rules_editingPlugin = this.getIpAccessRulesGrid().editingPlugin,
		    ip = net_log_record.get('ip') + '/32',
		    range = this.cidrToRange(ip, true);

		ip_rules_editingPlugin.cancelEdit();

		var records = ip_rules_store.add({
			ip: ip,
			ip_from: range[0],
			ip_to: range[1],
			rule: 'WHT',
			create_date: this.clockCtrl.getTime(),
			create_uid: app.user.id,
			active: 1
		});

		ip_rules_editingPlugin.startEdit(records[0], 0);
	},

	onIpAccessLogGridBeforeContextMenu: function (grid, record, item, index, e) {
    	e.preventDefault();
    	this.showNetWorkLogContextMenu(e);
	},

	showNetWorkLogContextMenu: function(e) {

		if(!this.getIpAccessPanelContextMenu()){
			Ext.widget('menu', {
				margin: '0 0 10 0',
				itemId: 'IpAccessPanelContextMenu',
				items: [
					{
						text: _('add_to_network_rules'),
						itemId: 'IpAccessPanelAddToWhiteListMenu',
						icon: 'resources/images/icons/add.png'
					}
				]
			});
		}

		return this.getIpAccessPanelContextMenu().showAt(e.getXY());
	},

	onIpAccessRulesIpFieldKeyUp: function (field) {

    	if(!field.isValid()) return;

    	var value = field.getValue(),
	        range = this.cidrToRange(value, true),
	        record = field.up('form').getForm().getRecord();

		record.set({
			ip_from: range[0],
			ip_to: range[1]
		});
	},

	long2ip: function (ip) {
		//  discuss at: http://locutus.io/php/long2ip/
		// original by: Waldo Malqui Silva (http://waldo.malqui.info)
		//   example 1: long2ip( 3221234342 )
		//   returns 1: '192.0.34.166'

		if (!isFinite(ip)) {
			return false
		}

		return [ip >>> 24, ip >>> 16 & 0xFF, ip >>> 8 & 0xFF, ip & 0xFF].join('.')
	},

	ip2long: function(ip) {
		//  discuss at: http://locutus.io/php/ip2long/
		// original by: Waldo Malqui Silva (http://waldo.malqui.info)
		// improved by: Victor
		//  revised by: fearphage (http://http/my.opera.com/fearphage/)
		//  revised by: Theriault (https://github.com/Theriault)
		//    estarget: es2015
		//   example 1: ip2long('192.0.34.166')
		//   returns 1: 3221234342
		//   example 2: ip2long('0.0xABCDEF')
		//   returns 2: 11259375
		//   example 3: ip2long('255.255.255.256')
		//   returns 3: false

		var i = 0;
		// PHP allows decimal, octal, and hexadecimal IP components.
		// PHP allows between 1 (e.g. 127) to 4 (e.g 127.0.0.1) components.

		const pattern = new RegExp([
			'^([1-9]\\d*|0[0-7]*|0x[\\da-f]+)',
			'(?:\\.([1-9]\\d*|0[0-7]*|0x[\\da-f]+))?',
			'(?:\\.([1-9]\\d*|0[0-7]*|0x[\\da-f]+))?',
			'(?:\\.([1-9]\\d*|0[0-7]*|0x[\\da-f]+))?$'
		].join(''), 'i');

		ip = ip.match(pattern); // Verify ip format.
		if (!ip) {
			// Invalid format.
			return false
		}
		// Reuse ip variable for component counter.
		ip[0] = 0;
		for (i = 1; i < 5; i += 1) {
			ip[0] += !!((ip[i] || '').length);
			ip[i] = parseInt(ip[i]) || 0
		}
		// Continue to use ip for overflow values.
		// PHP does not allow any component to overflow.
		ip.push(256, 256, 256, 256);
		// Recalculate overflow of last component supplied to make up for missing components.
		ip[4 + ip[0]] *= Math.pow(256, 4 - ip[0]);
		if (ip[1] >= ip[5] ||
			ip[2] >= ip[6] ||
			ip[3] >= ip[7] ||
			ip[4] >= ip[8]) {
			return false
		}

		return ip[1] * (ip[0] === 1 || 16777216) +
			ip[2] * (ip[0] <= 2 || 65536) +
			ip[3] * (ip[0] <= 3 || 256) +
			ip[4] * 1
	},

	cidrToRange: function(cidr, long) {
		var range = [2];
		cidr = cidr.split('/');
		var start = this.ip2long(cidr[0]);
		var stop = Math.pow(2, 32 - cidr[1]) + start - 1;
		range[0] = long ? start : this.long2ip(start);
		range[1] = long ? stop : this.long2ip(stop);
		return range;
	}

});

Ext.define('App.controller.administration.PdfForms', {
    extend: 'Ext.app.Controller',
    refs: [
        {
            ref: 'AdministrationPdfForms',
            selector: '#AdministrationPdfForms'
        },
        {
            ref: 'AdministrationPdfFormsGrid',
            selector: '#AdministrationPdfFormsGrid'
        },
        {
            ref: 'AdministrationPdfFormsTokenPanel',
            selector: '#AdministrationPdfFormsTokenPanel'
        },
        {
            ref: 'AdministrationPdfFormsAddBtn',
            selector: '#AdministrationPdfFormsAddBtn'
        }
    ],

    init: function () {
        var me = this;

        me.control({
            '#AdministrationPdfForms': {
                activate: me.onAdministrationPdfFormsActivate
            },
            '#AdministrationPdfFormsTokenPanel': {
                beforerender: me.onAdministrationPdfFormsTokenPanelBeforeRender
            },
            '#AdministrationPdfFormsAddBtn': {
                click: me.onAdministrationPdfFormsAddBtnClick
            }
        });
    },

    onAdministrationPdfFormsActivate: function () {
        this.getAdministrationPdfFormsGrid().getStore().load();
    },

    onAdministrationPdfFormsAddBtnClick: function () {
        var grid = this.getAdministrationPdfFormsGrid(),
            store = grid.getStore(),
            plugin = grid.editingPlugin;

        plugin.cancelEdit();

        plugin.startEdit(store.add({
            signature_x: 0,
            signature_y: 0,
            signature_w: 0,
            signature_h: 0,
            flatten: true
        })[0], 0);

    },

    onAdministrationPdfFormsTokenPanelBeforeRender: function (panel){
        panel.update(this.patientTokens().join('<br>'));
    },

    patientTokens: function () {
        return [
            '[PATIENT_NAME]',
            '[PATIENT_ID]',
            '[PATIENT_RECORD_NUMBER]',
            '[PATIENT_FULL_NAME]',
            '[PATIENT_LAST_NAME]',
            '[PATIENT_SEX]',
            '[PATIENT_BIRTHDATE]',
            '[PATIENT_MARITAL_STATUS]',
            '[PATIENT_SOCIAL_SECURITY]',
            '[PATIENT_EXTERNAL_ID]',
            '[PATIENT_DRIVERS_LICENSE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_ONE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_TWO]',
            '[PATIENT_POSTAL_CITY]',
            '[PATIENT_POSTAL_STATE]',
            '[PATIENT_POSTAL_ZIP]',
            '[PATIENT_POSTAL_COUNTRY]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_ONE]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_TWO]',
            '[PATIENT_PHYSICAL_CITY]',
            '[PATIENT_PHYSICAL_STATE]',
            '[PATIENT_PHYSICAL_ZIP]',
            '[PATIENT_PHYSICAL_COUNTRY]',
            '[PATIENT_HOME_PHONE]',
            '[PATIENT_MOBILE_PHONE]',
            '[PATIENT_WORK_PHONE]',
            '[PATIENT_EMAIL]',
            '[PATIENT_MOTHERS_NAME]',
            '[PATIENT_GUARDIANS_NAME]',
            '[PATIENT_EMERGENCY_CONTACT]',
            '[PATIENT_EMERGENCY_PHONE]',
            '[PATIENT_PROVIDER]',
            '[PATIENT_PHARMACY]',
            '[PATIENT_AGE]',
            '[PATIENT_OCCUPATION]',
            '[PATIENT_EMPLOYER]',
            '[PATIENT_RACE]',
            '[PATIENT_ETHNICITY]',
            '[PATIENT_LANGUAGE]',
            '[PATIENT_PICTURE]',
            '[PATIENT_QRCODE]',
            '[FACILITY_NAME]',
            '[FACILITY_PHONE]',

            '[REFERRING_ID]',
            '[REFERRING_NAME]',
            '[REFERRING_TITLE]',
            '[REFERRING_FIRST_NAME]',
            '[REFERRING_LAST_NAME]',
            '[REFERRING_MIDDLE_NAME]',
            '[REFERRING_NPI]',
            '[REFERRING_LIC]',
            '[REFERRING_EMAIL]',
            '[REFERRING_PHONE_NUMBER]',
            '[REFERRING_FAX_NUMBER]',
            '[REFERRING_CEL_NUMBER]'
        ];
    }


});
Ext.define('App.controller.administration.MeasureCalculation', {
    extend: 'Ext.app.Controller',
    uses: [
        'App.ux.grid.Printer'
    ],
    refs: [
        {
            selector: '#MeasureCalculation',
            ref: 'MeasureCalculation'
        },

        // Meaningful Use
        {
            selector: '#MeaningfulUseGrid',
            ref: 'MeaningfulUseGrid'
        },
        {
            selector: '#MeaningfulUseFromField',
            ref: 'MeaningfulUseFromField'
        },
        {
            selector: '#MeaningfulUseToField',
            ref: 'MeaningfulUseToField'
        },
        {
            selector: '#MeaningfulUseProviderField',
            ref: 'MeaningfulUseProviderField'
        },

        // MIPS
        {
            selector: '#MIPSGrid',
            ref: 'MIPSGrid'
        },
        {
            selector: '#MIPSGridFromField',
            ref: 'MIPSGridFromField'
        },
        {
            selector: '#MIPSGridToField',
            ref: 'MIPSGridToField'
        },
        {
            selector: '#MIPSGridProviderField',
            ref: 'MIPSGridProviderField'
        },
        {
            selector: '#MIPSGridInsuranceField',
            ref: 'MIPSGridInsuranceField'
        },
        {
            selector: '#MIPSGridSexField',
            ref: 'MIPSGridSexField'
        },
        {
            selector: '#MIPSGridEthnicityField',
            ref: 'MIPSGridEthnicityField'
        },
        {
            selector: '#MIPSGridRaceField',
            ref: 'MIPSGridRaceField'
        }
    ],

    /**
     *
     */
    init: function(){
        var me = this;

        me.control({
            '#MeaningfulUseRefreshBtn': {
                click: me.onMeaningfulUseRefreshBtnClick
            },
            '#MeaningfulUseGrid': {
                celldblclick: me.onMeaningfulUseGridCellDblClick
            },
            '#MeaningfulUseGridPrintBtn': {
                click: me.onMeaningfulUseGridPrintBtnClick
            },


            '#MIPSGridRefreshBtn': {
                click: me.onMIPSGridRefreshBtnClick
            },
            '#MIPSGrid': {
                celldblclick: me.onMIPSGridCellDblClick
            },
            '#MIPSGridPrintBtn': {
                click: me.onMIPSGridPrintBtnClick
            }
        });

        me.doSortGridStoreBuffer = Ext.Function.createBuffered(me.doSortGridStore, 250, me);
    },

    onMIPSGridRefreshBtnClick: function (btn){
        var fromField = this.getMIPSGridFromField(),
            toField = this.getMIPSGridToField(),
            providerField = this.getMIPSGridProviderField(),
            insuranceField = this.getMIPSGridInsuranceField(),
            sexField = this.getMIPSGridSexField(),
            ethnicityField = this.getMIPSGridEthnicityField(),
            raceField = this.getMIPSGridRaceField(),
            grid_store = this.getMIPSGrid().getStore();

        grid_store.removeAll();
        grid_store.commitChanges();

        if(!fromField.isValid() || !toField.isValid() || !providerField.isValid()){
            return;
        }

        var provider_id = providerField.getValue(),
            insurance_id = insuranceField.getValue(),
            from = Ext.Date.format(fromField.getValue(), 'Y-m-d'),
            to = Ext.Date.format(toField.getValue(), 'Y-m-d'),
            sex = sexField.getValue(),
            ethnicity = ethnicityField.getValue(),
            race = raceField.getValue();

        this.doReportMeasureByDates(grid_store, 'AdvanceCarePlan', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'ControllingHighBloodPressure', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'HeartFailureARBorARNI', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'CoronaryArteryDiseaseAntiplatelet', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'CoronaryArteryDiseaseBetaBlocker', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'HeartFailureBetaBlocker', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'InfluenzaImmunization', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'PneumococcalImmunization', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'FallsRiskAssessment', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'FallsPlanOfCare', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'SupportElectronicReferralLoops', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'ClosingTheReferralLoopReceipt', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'BreastCancerScreening', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'DocumentationOfCurrentMedications', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'PreventiveCareAndScreeningBMIAndFUP', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'UseOfHighRiskMedicationsInOlderAdults', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'DiabetesMedicalAttentionForNephropathy', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'ChlamydiaScreeningForWomen', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'TobaccoUseScreeningCessationIntervention', provider_id, from, to, insurance_id, sex, ethnicity, race);
        this.doReportMeasureByDates(grid_store, 'HIVScreening', provider_id, from, to, insurance_id, sex, ethnicity, race);


    },

    onMIPSGridCellDblClick: function (view, td, cellIndex, report_record){
        this.doShowPatientList(view, td, cellIndex, report_record);
    },

    onMIPSGridPrintBtnClick: function (btn){
        var fromField = this.getMIPSGridFromField(),
            toField = this.getMIPSGridToField(),
            providerField = this.getMIPSGridProviderField(),
            provider = providerField.findRecordByValue(providerField.getValue()),
            grid = this.getMIPSGrid();

        if(!fromField.isValid() || !toField.isValid() || !providerField.isValid() || grid.store.count() === 0) return;

        App.ux.grid.Printer.mainTitle = 'MIPS Calculation'; //optional
        App.ux.grid.Printer.filtersHtml = Ext.String.format(
            '<b>From:</b> {0}<br><b>To:</b> {1}<br><b>Provider:</b> {2}',
            Ext.Date.format(fromField.getValue(), 'F j, Y'),
            Ext.Date.format(toField.getValue(), 'F j, Y'),
            provider.get('fullname')
        ); //optional
        App.ux.grid.Printer.print(grid);
    },

    onMeaningfulUseGridPrintBtnClick: function(btn){

        var fromField = this.getMeaningfulUseFromField(),
            toField = this.getMeaningfulUseToField(),
            providerField = this.getMeaningfulUseProviderField(),
            provider = providerField.findRecordByValue(providerField.getValue()),
            grid = this.getMeaningfulUseGrid();

        if(!fromField.isValid() || !toField.isValid() || !providerField.isValid() || grid.store.count() === 0) return;

        App.ux.grid.Printer.mainTitle = 'Meaningful Use Calculation'; //optional
        App.ux.grid.Printer.filtersHtml = Ext.String.format(
            '<b>From:</b> {0}<br><b>To:</b> {1}<br><b>Provider:</b> {2}',
            Ext.Date.format(fromField.getValue(), 'F j, Y'),
            Ext.Date.format(toField.getValue(), 'F j, Y'),
            provider.get('fullname')
        ); //optional
        App.ux.grid.Printer.print(grid);
    },

    onMeaningfulUseGridCellDblClick: function(view, td, cellIndex, report_record){
        this.doShowPatientList(view, td, cellIndex, report_record);
    },

    onMeaningfulUseRefreshBtnClick: function (btn) {
        var fromField = this.getMeaningfulUseFromField(),
            toField = this.getMeaningfulUseToField(),
            providerField = this.getMeaningfulUseProviderField(),
            grid_store = this.getMeaningfulUseGrid().getStore();

        grid_store.removeAll();
        grid_store.commitChanges();

        if(!fromField.isValid() || !toField.isValid() || !providerField.isValid()){
            return;
        }

        var provider_id = providerField.getValue(),
	        from = Ext.Date.format(fromField.getValue(), 'Y-m-d'),
	        to = Ext.Date.format(toField.getValue(), 'Y-m-d');

        this.doReportMeasureByDates(grid_store,'ePrescribing', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'PatientEducation', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'ProvidePatientsElectronicAccess', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'ViewDownloadTransmit', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'SecureMessaging', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'PatientGeneratedHealthData', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'SupportElectronicReferralLoopsSending', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'ReceiveAndIncorporate', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'MedicationClinicalInformationReconciliation', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'CPOEMedications', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'CPOELaboratory', provider_id, from, to, null, null, null, null);
        this.doReportMeasureByDates(grid_store,'CPOERadiology', provider_id, from, to, null, null, null, null);

    },

    doReportMeasureByDates: function (grid_store, measure, provider_id, start_date, end_date, insurance_id, sex, ethnicity, race) {
        var me = this;

        MeasureCalculation.getReportMeasureByDates(measure, provider_id, start_date, end_date, insurance_id, sex, ethnicity, race, function (response) {
            grid_store.loadData(response, true);
            me.doSortGridStoreBuffer(grid_store);
        });

    },

    doSortGridStore: function(store){
        store.sort();
    },

    showMeasureCalculationPatientListWindow: function (title, data, numerator_types_obj) {


        var store = Ext.create('Ext.data.ArrayStore', {
            fields: [
                {  name: 'pid', type: 'string' },
                {  name: 'pubpid', type: 'string'  },
                {  name: 'fname', type: 'string'  },
                {  name: 'mname', type: 'string'  },
                {  name: 'lname', type: 'string'  },
                {  name: 'sex', type: 'string'  },
                {  name: 'DOB', type: 'date', dateFormat: 'Y-m-d H:i:s' }
            ]
        });

        Ext.create('Ext.window.Window', {
            title: title + ' [' + data.length + ']',
            width: 800,
            height: 500,
            layout: 'fit',
            items: {  // Let's put an empty grid in just to illustrate fit layout
                xtype: 'grid',
                store: store,
                columns: [
                    {
                        text: 'ID',
                        dataIndex: 'pid',
                        width: 50
                    },
                    {
                        text: 'MRN',
                        dataIndex: 'pubpid',
                        width: 120
                    },
                    {
                        text: 'Name',
                        dataIndex: 'pubpid',
                        flex: 1,
                        renderer: function (v,m,r) {
                            return Ext.String.format('{0}, {1} {2}', r.get('lname'), r.get('fname'), r.get('mname'))
                        }
                    },
                    {
                        text: 'Sex',
                        dataIndex: 'sex',
                        width: 50
                    },
                    {
                        xtype: 'datecolumn',
                        text: 'DOB',
                        format:'Y-m-d',
                        dataIndex: 'DOB'
                    },
                    {
                        text: 'Action',
                        dataIndex: 'pid',
                        renderer: function (v) {
                            switch (numerator_types_obj[v]) {
                                case 'CCDA_VDT':
                                    return 'VDT';
                                case 'CCDA_VDT_API':
                                    return 'API';
                                default:
                                    return 'N/A';
                            }
                        }
                    }
                ]
            }
        }).show();

        store.loadData(data);
    },

    doShowPatientList: function (view, td, cellIndex, report_record){
        var me = this,
            column = view.panel.columnManager.getHeaderAtIndex(cellIndex),
            pids;

        if(column.dataIndex !== 'denominator' && column.dataIndex !== 'numerator') return;

        pids = report_record.get(column.dataIndex + '_pids');

        if(pids == '') return;

        var numerator_types = report_record.get('numerator_types'), i, len,
            numerator_types_obj = {}, v;

        if(numerator_types){

            numerator_types = numerator_types.split(',');

            len = numerator_types.length;
            for (i = 0; i < len; i++) {
                v = numerator_types[i].split('~');
                numerator_types_obj[v[0]] = v[1]
            }
        }

        MeasureCalculation.getPatientList(pids, function (response) {
            me.showMeasureCalculationPatientListWindow(Ext.String.capitalize(column.dataIndex) + ' Patient List', response, numerator_types_obj);
        });
    },

});

Ext.define('App.controller.administration.LegalLetters', {
    extend: 'Ext.app.Controller',
    refs: [
        {
            ref: 'AdministrationLegalLetters',
            selector: '#AdministrationLegalLetters'
        },
        {
            ref: 'AdministrationLegalLettersGrid',
            selector: '#AdministrationLegalLettersGrid'
        },
        {
            ref: 'AdministrationLegalLetterWindow',
            selector: '#AdministrationLegalLetterWindow'
        }
    ],

    init: function () {
        var me = this;

        me.control({
            '#AdministrationLegalLetters': {
                activate: me.onAdministrationLegalLettersActivate
            },
            '#AdministrationLegalLettersGrid': {
                itemdblclick: me.onAdministrationLegalLettersGridItemDblClick
            },
            '#AdministrationLegalLettersAddBtn': {
                click: me.onAdministrationLegalLettersAddBtnClick
            },
            '#AdministrationLegalLetterCancelBtn': {
                click: me.onAdministrationLegalLetterCancelBtnClick
            },
            '#AdministrationLegalLetterSaveBtn': {
                click: me.onAdministrationLegalLetterSaveBtnClick
            }
        });
    },

    onAdministrationLegalLettersGridItemDblClick: function (grid, letter_record){
        var win = this.showAdministrationLegalLetterWindow();
        win.down('form').getForm().loadRecord(letter_record);
    },

    onAdministrationLegalLetterCancelBtnClick: function (btn){
        var win = btn.up('window');
        win.down('form').getForm().reset(true);
        this.getAdministrationLegalLettersGrid().getStore().rejectChanges();
        win.close();
    },

    onAdministrationLegalLetterSaveBtnClick: function (btn){
        var win = btn.up('window'),
            form = win.down('form').getForm(),
            record = form.getRecord(),
            values = form.getValues()

        if(!form.isValid()){
            return;
        }

        record.set(values);

        if(record.store.getModifiedRecords().length > 0){
            record.store.sync({
                callback: function (){
                    win.close();
                }
            });
        }else{
            win.close();
        }
    },

    onAdministrationLegalLettersActivate: function () {
        this.getAdministrationLegalLettersGrid().getStore().load();
    },

    onAdministrationLegalLettersAddBtnClick: function () {
        var win = this.showAdministrationLegalLetterWindow(),
            added_records = this.getAdministrationLegalLettersGrid().getStore().add({
            workflow: 'PRE-REGISTRATION',
            days_valid_for: 365,
            version: '1.0',
            active: false
        })

        win.down('form').getForm().loadRecord(added_records[0]);

    },

    showAdministrationLegalLetterWindow: function (){

        if(!this.getAdministrationLegalLetterWindow()){

            Ext.create('Ext.window.Window',{
                title: _('legal_letter'),
                layout: 'fit',
                bodyPadding: 5,
                width: 800,
                itemId: 'AdministrationLegalLetterWindow',
                items: [
                    {
                        xtype: 'form',
                        bodyPadding: 10,
                        items: [
                            {
                                xtype: 'textfield',
                                fieldLabel: _('title'),
                                name: 'title',
                                anchor: '100%',
                                allowBlank: false
                            },
                            {
                                xtype: 'activefacilitiescombo',
                                fieldLabel: _('facility'),
                                name: 'facility_id'
                            },
                            {
                                xtype: 'combobox',
                                fieldLabel: _('workflow'),
                                name: 'workflow',
                                editable: false,
                                store: ['PRE-REGISTRATION'],
                                allowBlank: false
                            },
                            {
                                xtype: 'htmleditor',
                                fieldLabel: _('content'),
                                name: 'content',
                                height: 400,
                                anchor: '100%',
                                allowBlank: false
                            },
                            {
                                xtype: 'numberfield',
                                fieldLabel: _('days_valid_for'),
                                name: 'days_valid_for',
                                allowBlank: false,
                                minValue: -1,
                                maxValue: 9999
                            },
                            {
                                xtype: 'textfield',
                                fieldLabel: _('version'),
                                name: 'version',
                                allowBlank: false
                            },
                            {
                                xtype: 'checkbox',
                                fieldLabel: _('active'),
                                name: 'active'
                            }
                        ]
                    }
                ],
                buttons: [
                    {
                        xtype: 'button',
                        text: _('cancel'),
                        itemId: 'AdministrationLegalLetterCancelBtn'
                    },
                    {
                        xtype: 'button',
                        text: _('save'),
                        itemId: 'AdministrationLegalLetterSaveBtn'
                    }
                ]
            });

        }
        return this.getAdministrationLegalLetterWindow().show();
    },

    patientTokens: function () {
        return [
            '[PATIENT_NAME]',
            '[PATIENT_ID]',
            '[PATIENT_RECORD_NUMBER]',
            '[PATIENT_FULL_NAME]',
            '[PATIENT_LAST_NAME]',
            '[PATIENT_SEX]',
            '[PATIENT_BIRTHDATE]',
            '[PATIENT_MARITAL_STATUS]',
            '[PATIENT_SOCIAL_SECURITY]',
            '[PATIENT_EXTERNAL_ID]',
            '[PATIENT_DRIVERS_LICENSE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_ONE]',
            '[PATIENT_POSTAL_ADDRESS_LINE_TWO]',
            '[PATIENT_POSTAL_CITY]',
            '[PATIENT_POSTAL_STATE]',
            '[PATIENT_POSTAL_ZIP]',
            '[PATIENT_POSTAL_COUNTRY]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_ONE]',
            '[PATIENT_PHYSICAL_ADDRESS_LINE_TWO]',
            '[PATIENT_PHYSICAL_CITY]',
            '[PATIENT_PHYSICAL_STATE]',
            '[PATIENT_PHYSICAL_ZIP]',
            '[PATIENT_PHYSICAL_COUNTRY]',
            '[PATIENT_HOME_PHONE]',
            '[PATIENT_MOBILE_PHONE]',
            '[PATIENT_WORK_PHONE]',
            '[PATIENT_EMAIL]',
            '[PATIENT_MOTHERS_NAME]',
            '[PATIENT_GUARDIANS_NAME]',
            '[PATIENT_EMERGENCY_CONTACT]',
            '[PATIENT_EMERGENCY_PHONE]',
            '[PATIENT_PROVIDER]',
            '[PATIENT_PHARMACY]',
            '[PATIENT_AGE]',
            '[PATIENT_OCCUPATION]',
            '[PATIENT_EMPLOYER]',
            '[PATIENT_RACE]',
            '[PATIENT_ETHNICITY]',
            '[PATIENT_LANGUAGE]',
            '[PATIENT_PICTURE]',
            '[PATIENT_QRCODE]',
            '[FACILITY_NAME]',
            '[FACILITY_PHONE]',
        ];
    }


});
Ext.define('App.controller.administration.TransactionLog', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref:'TransactionLogPanel',
            selector:'#TransactionLogPanel'
        },
        {
            ref:'TransactionLogFilterFormPanel',
            selector:'#TransactionLogFilterFormPanel'
        },
        {
            ref:'TransactionLogDataGrid',
            selector:'#TransactionLogDataGrid'
        },
        {
            ref:'TransactionLogFilterPanel',
            selector:'#TransactionLogFilterPanel'
        },

	    {
		    ref:'TransactionLogWindow',
		    selector:'#TransactionLogWindow'
	    },
	    {
		    ref:'TransactionLogDetailLogGrid',
		    selector:'#TransactionLogDetailLogGrid'
	    },
	    {
		    ref:'TransactionLogTabPanel',
		    selector:'#TransactionLogTabPanel'
	    },
	    {
		    ref:'AuditLogDataGrid',
		    selector:'#AuditLogDataGrid'
	    }
    ],

    init: function() {
        var me = this;

        me.control({
            '#TransactionLogFilterSearchBtn':{
                click: me.onTransactionLogFilterSearchBtnClick
            },
            '#TransactionLogDataGrid':{
                itemdblclick: me.onTransactionLogDataGridItemDblClick
            },
            '#AuditLogWindowGrid':{
                itemdblclick: me.onAuditLogWindowGridDblClick
            }
        });

        me.clockCtrl = me.getController('Clock');

    },

	onTransactionLogFilterSearchBtnClick: function() {

		// Aqui hay que buscar el tabpanel activo para hacer el search
		// Metodo del tab: sgetActiveTab
		var form = this.getTransactionLogFilterFormPanel().getForm(),
			tabpanel = this.getTransactionLogTabPanel(),
			active_grid = tabpanel.getActiveTab(),
			store = active_grid.getStore(),
			//store = this.getTransactionLogDataGrid().getStore(),
			values = form.getValues();

		if (!form.isValid()) return;


		store.getProxy().extraParams = { filters: values };
		store.load();
	},

	onTransactionLogDataGridItemDblClick: function (grid, record) {
    	this.doTransactionLogDetailByTableAndPk(record.get('table_name'), record.get('pk'), false);
	},

	onAuditLogWindowGridDblClick: function (grid, record) {
    	this.doTransactionLogDetailByTableAndPk(record.get('foreign_table'), record.get('foreign_id'), record.get('site'));
	},

	doTransactionLogDetailByTableAndPk: function (table, pk, site) {
		var me = this;

		TransactionLog.getTransactionLogDetailByTableAndPk(table, pk, site, function (response) {

			if(response.total == 0) {
				app.msg(_('info'), _('no_record_fund'));
				return;
			}

			me.showTransactionLogWindow();
			me.setTransactionLogDetailGrid(response);

		});
	},

	setTransactionLogDetailGrid: function (response) {

		response.table = response.table || 'none';
		response.columns = response.columns || [];
		response.data = response.data || [];

    	var me = this,
			model_name = 'App.model.' + Ext.String.capitalize(response.table) + '_TransactionLogDetailModel',
			fields = [
				'_id',
				'_event_time',
				'_event_type',
				'_event_uid',
				'_event_ip',
				'_event_user_title',
				'_event_user_fname',
				'_event_user_mname',
				'_event_user_lname',
				{
					name: '_event_user',
					convert: function (v,rec) {
						return rec.get('_event_user_lname') + ', ' +
							rec.get('_event_user_fname') + ' ' +
							rec.get('_event_user_mname');
					}
				}
			],
			columns = [
				{
					text: _('event_info'),
					locked: true,
					columns: [
						{
							text: 'event_time',
							dataIndex: '_event_time',
							width: 120
						},
						{
							text: 'event_type',
							dataIndex: '_event_type',
							width: 100
						},
						{
							text: 'event_user',
							dataIndex: '_event_user',
							width: 150
						},
						{
							text: 'ip',
							dataIndex: '_event_ip',
							width: 100
						}
					]
				},
				{
					text: _('record'),
					columns: [	]
				}
			];

		fields = Ext.Array.merge(fields, response.columns);

		response.columns.forEach(function (col) {
			columns[1].columns = Ext.Array.push(columns[1].columns, {
				text: col,
				dataIndex: col,
				width: 200
			});
		});

		if(!eval(model_name)){
			Ext.define(model_name, {
				extend: 'Ext.data.Model',
				fields: fields,
				idProperty: '_id'
			});
		}

		var store = Ext.create('Ext.data.Store', {
			model: model_name,
			data: { data: response.data },
			autoLoad: true,
			proxy: {
				type: 'memory',
				reader: {
					type: 'json',
					root: 'data'
				}
			}
		});

		me.getTransactionLogDetailLogGrid().reconfigure(store, columns);
	},

	showTransactionLogWindow: function () {
		if(!this.getTransactionLogWindow()){
			Ext.create('Ext.window.Window', {
				layout: 'fit',
				title: _('transactions'),
				itemId: 'TransactionLogWindow',
				maximizable: true,
				closeAction: 'hide',
				items: [
					{
						xtype:'grid',
						height: 400,
						width: 1200,
						enableLocking: true,
						itemId: 'TransactionLogDetailLogGrid',
						viewConfig: {
							enableTextSelection: true
						},
						columns: [
							{
								text: '',
								flex: 1
							}
						]
					}
				]
			});
		}
		return this.getTransactionLogWindow().show();
	}
});

Ext.define('App.controller.administration.CronJob', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref:'CronJobPanel',
            selector:'cronjobpanel'
        },
        {
            ref: 'CronJobGrid',
            selector: 'cronjobpanel #CronJobGrid'
        }
    ],

    init: function() {
        var me = this;

        me.control({
            'cronjobpanel':{
                activate: me.onCronJobPanelActive
            },
            '#CronJobPanelKillProcessBtn':{
                click: me.onCronJobPanelKillProcessBtnClick
            }
        });

    },


    doGridRefresh: function (){
        this.getCronJobGrid().getStore().load();
    },

    onCronJobPanelActive: function(){
        this.doGridRefresh();
    },

    onCronJobPanelKillProcessBtnClick: function (btn){

        var me = this,
            grid = btn.up('grid'),
            selection = grid.getSelectionModel().getSelection();

        if(selection.length === 0){
            return;
        }

        if(!selection[0].get('running')){
            app.msg(_('oops'), 'Process is not running', true);
            return;
        }

        if(selection[0].get('pid') === ''){
            app.msg(_('oops'), 'Process PID missing', true);
            return;
        }

        var pid = selection[0].get('pid');

        Ext.Msg.show({
            title: 'Wait!',
            msg: Ext.String.format('This action will kill process <b>{0}</b>, would you like to continue?', pid),
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.QUESTION,
            fn: function (answer){
                if(answer === 'yes'){
                    CronJob.killCronjob(selection[0].data, function (success){
                        if(success){
                            app.msg(_('sweet'), Ext.String.format('Process {0} Killed', pid), true);
                            me.doGridRefresh();
                        }else{
                            app.msg(_('oops'), 'Something went wrong killing the process', true);
                        }
                    });
                }
            }
        });

    }

});

Ext.define('App.controller.dashboard.Dashboard', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'DashboardRenderPanel',
			selector: '#DashboardPanel'
		},
		{
			ref: 'DashboardPanel',
			selector: 'portalpanel'
		},
		{
			ref: 'DashboardLeftColumn',
			selector: '#DashboardColumn1'
		},
		{
			ref: 'DashboardRightColumn',
			selector: '#DashboardColumn2'
		}
	],

	addLeftPanel: function(title, item, index){
		var panel;
		if(index){
			panel = this.getDashboardLeftColumn().insert(index, {
				xtype: 'portlet',
				title: title,
				items: [item]
			});
		}else{
			panel = this.getDashboardLeftColumn().add({
				xtype: 'portlet',
				title: title,
				items: [item]
			});
		}
		return panel;
	},

	addRightPanel: function(title, item, index){
		var panel;
		if(index){
			panel = this.getDashboardRightColumn().insert(index, {
				xtype: 'portlet',
				title: title,
				items: [item]
			});
		}else{
			panel = this.getDashboardRightColumn().add({
				xtype: 'portlet',
				title: title,
				items: [item]
			});
		}
		return panel;
	},

	getColumns: function(){
		return this.getDashboardPanel().items;
	}

});

Ext.define('App.controller.dashboard.panel.NewResults', {
	extend: 'App.controller.dashboard.Dashboard',

	init: function(){
		if(!a('view_dashboard_new_results')) return;

		var me = this;

		me.control({
			'portalpanel':{
				render: me.onDashboardPanelBeforeRender
			},
			'#DashboardPanel':{
				activate: me.onDashboardPanelActivate
			},
			'#DashboardNewResultsGrid':{
				itemdblclick: me.onDashboardNewResultsGridItemDoubleClick
			}
		});

		me.addRef([
			{
				ref: 'DashboardRenderPanel',
				selector:'#DashboardPanel'
			},
			{
				ref: 'DashboardNewResultsGrid',
				selector:'#DashboardNewResultsGrid'
			}
		]);
	},

	onDashboardNewResultsGridItemDoubleClick: function(grid, record){
		grid.el.mask(_('please_wait'));

		app.setPatient(record.data.pid, null, null, function(){
			app.openPatientSummary();
			app.onMedicalWin('laboratories');
			grid.el.unmask();
		});
	},


	onDashboardPanelActivate: function(){
		this.getDashboardNewResultsGrid().getStore().load();
	},

	onDashboardPanelBeforeRender: function(){
		this.addRightPanel(_('new_results'), Ext.create('App.view.dashboard.panel.NewResults'));
	}

});
Ext.define('App.controller.areas.FloorPlan', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'FloorPlanPanel',
			selector: '#FloorPlanPanel'
		},
		{
			ref: 'FloorPlanPatientZonePanel',
			selector: '#FloorPlanPatientZonePanel'
		},
		{
			ref: 'FloorPlanAreasCombo',
			selector: '#FloorPlanAreasCombo'
		},
		{
			ref: 'FloorPlanPatientZoneDetailWindow',
			selector: '#FloorPlanPatientZoneDetailWindow'
		},
		{
			ref: 'FloorPlanPatientZoneDetailRemovePatientBtn',
			selector: '#FloorPlanPatientZoneDetailRemovePatientBtn'
		},
		{
			ref: 'FloorPlanPatientZoneAssignmentWindow',
			selector: '#FloorPlanPatientZoneAssignmentWindow'
		},
		{
			ref: 'FloorPlanPatientZoneAssignmentCombo',
			selector: '#FloorPlanPatientZoneAssignmentCombo'
		},
		{
			ref: 'FloorPlanPatientProviderAssignmentCombo',
			selector: '#FloorPlanPatientProviderAssignmentCombo'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#FloorPlanPanel': {
				activate: me.onFloorPlanPanelActivate,
				deactivate: me.onFloorPlanPanelDeactivate
			},
			'#FloorPlanPatientZoneDetailRemovePatientBtn': {
				click: me.onFloorPlanPatientZoneDetailRemovePatientBtnClick
			},
			'#FloorPlanAreasCombo': {
				select: me.onFloorPlanAreasComboSelect
			},
			'#FloorPlanPatientZoneAssignmentCancelBtn': {
				click: me.onFloorPlanPatientZoneAssignmentCancelBtnClick
			},
			'#FloorPlanPatientZoneAssignmentSaveBtn': {
				click: me.onFloorPlanPatientZoneAssignmentSaveBtnClick
			},
			'#FloorPlanPatientZoneAssignmentCombo': {
				beforeselect: me.onFloorPlanPatientZoneAssignmentComboBeforeSelect
			}
		});

		me.floorPlanZonesStore = Ext.create('App.store.administration.FloorPlanZones');

	},

	onFloorPlanPanelActivate: function(){
		if(this.getFloorPlanAreasCombo().getValue() == null){
			this.renderZones();
		}else{
			this.setZones();
		}
	},

	onFloorPlanPanelDeactivate: function(){
		if(this.getFloorPlanPatientZoneDetailWindow()){
			this.getFloorPlanPatientZoneDetailWindow().close();
		}
	},

	onFloorPlanPatientZoneDetailRemovePatientBtnClick: function(btn){
		var me = this,
			win = btn.up('window');
		me.unAssignPatient(win.zone, win.zone.data);
		win.close();
	},

	onFloorPlanAreasComboSelect: function(cmb, records){
		var me = this;
		me.loadZones(records[0], function(){
			me.setZones();
		});
	},

	renderZones: function(){
		var me = this,
			cmb = me.getFloorPlanAreasCombo();

		cmb.getStore().load({
			callback: function(records){
				if(records.length > 0){
					cmb.setValue(records[0].data.id);
					me.onFloorPlanAreasComboSelect(cmb, records);
				}else{
					cmb.setValue('');
					me.getFloorPlanPatientZonePanel().removeAll();
				}
			}
		});
	},

	createZone: function(record){
		var me = this, zone;

		zone = me.getFloorPlanPatientZonePanel().add({
			xtype: 'splitbutton',
			text: record.data.title,
			scale: record.data.scale,
			itemId: record.data.id,
			style: {
				'border-color': record.data.border_color,
				'background-color': record.data.bg_color
			},
			x: record.data.x,
			y: record.data.y,
			width: record.data.width,
			height: record.data.height,
			scope: me,
			handler: me.onZoneClicked,
			tooltip: _('patient_name') + ': [empty]',
			listeners: {
				scope: me,
				render: me.initializeZone,
				arrowclick: me.onZoneArrowClicked
			},
			// patient zone specific reference data --->
			pid: null,
			zoneId: record.data.id,
			priority: null,
			patientZoneId: null
			// <---
		});

		zone.record = record;
	},

	loadZones: function(cmbRecord, callback){
		var me = this;
		me.getFloorPlanPatientZonePanel().removeAll();
		me.floorPlanZonesStore.load({
			params: {
				floor_plan_id: cmbRecord.data.id
			},
			scope: me,
			callback: function(records, operation, success){
				for(var i = 0; i < records.length; i++){
					me.createZone(records[i]);
				}
				callback();
			}
		});
	},

	initializeZone: function(panel){
		var me = this;
		panel.dragZone = Ext.create('Ext.dd.DragZone', panel.getEl(), {
			ddGroup: 'patientPoolAreas',

			getDragData: function(e){
				var sourceEl = panel.btnEl.dom, d;
				if(sourceEl){
					d = sourceEl.cloneNode(true);
					d.id = Ext.id();
					return panel.dragData = {
						sourceEl: sourceEl,
						repairXY: Ext.fly(sourceEl).getXY(),
						ddel: d,
						patientData: panel.data,
						zone: panel
					};
				}else{
					return false;
				}
			},

			getRepairXY: function(e){
				return this.dragData.repairXY;
			},

			b4MouseDown: function(e){
				this.autoOffset(e.getPageX(), e.getPageY());
			}
		});

		panel.dragZone.lock();

		panel.dropZone = Ext.create('Ext.dd.DropZone', panel.getEl(), {
			ddGroup: 'patientPoolAreas',

			notifyOver: function(dd, e, data){
				if(panel.pid == null){
					return Ext.dd.DropZone.prototype.dropAllowed;
				}else{
					return Ext.dd.DropZone.prototype.dropNotAllowed;
				}
			},

			notifyDrop: function(dd, e, data){
				panel.data = data.patientData;
				if(data.zone){
					me.unAssignPatient(data.zone, panel.data);
				}
				me.assignPatient(panel, panel.data);
			}
		});
	},

	onZoneClicked: function(btn){
		app.setPatient(btn.data.pid, btn.data.name, null, function(){
			btn.data.eid ? app.openEncounter(btn.data.eid) : app.openPatientSummary();
		});
	},

	onZoneArrowClicked: function(zone){
		var me = this;

		if(!me.getFloorPlanPatientZoneDetailWindow()){
			Ext.create('Ext.Window', {
				width: 300,
				closeAction: 'hide',
				itemId: 'FloorPlanPatientZoneDetailWindow',
				tpl: new Ext.XTemplate(
					'<div class="zoneSummaryContainer">' +
					'   <div class="zoneSummaryArea">' +
					'       <tpl if="this.patientImg(image)">',
					'           <img src="{image}" height="96" width="96">' +
					'       <tpl else>',
					'           <img src="' + app.patientImage + '" height="96" width="96">',
					'       </tpl>',
					'       <p>Name: {name}</p>' +
					'       <p>DOB: {DOB}</p>' +
					'       <p>Age: {age.str}</p>' +
					'       <p>Sex: {sex}</p>' +
					'   </div>' +
					'</div>',
					{
						patientImg: function(image){
							return image != null && image != '';
						}
					}
				),
				buttons: [
					{
						text: _('remove_patient'),
						itemId: 'FloorPlanPatientZoneDetailRemovePatientBtn'
					}
				]
			});
		}

		if(zone.data){
			var win = me.getFloorPlanPatientZoneDetailWindow();

			win.zone = zone;
			win.update(zone.data.patient);
			win.show();
			win.alignTo(zone.getEl(), 'tl-tr?');
			win.focus();
		}
	},

	assignPatient: function(zone, data){
		var me = this,
			params = {
				zone_id: zone.zoneId,
				pid: data.pid
			};

		PatientZone.addPatientToZone(params, function(response){
			data.patientZoneId = response.data.id;
			app.msg('Sweet!', data.name + ' ' + _('successfully_moved') + '.');
			me.setZone(zone, data);
		});
	},

	unAssignPatient: function(zone, data){
		var me = this;
		PatientZone.removePatientFromZone({id: data.patientZoneId}, function(){
			me.unSetZone(zone)
		});
	},

	setZone: function(zone, data){
		zone.pid = data.pid;
		zone.priority = data.priority;
		zone.patientZoneId = data.patientZoneId;

		if(zone.dropZone) zone.dropZone.lock();
		if(zone.dragZone) zone.dragZone.unlock();

		zone.setTooltip(_('patient_name') + ':' + data.name);
		zone.addCls(data.priority);
		zone.addCls('zone-in-use');
		zone.data = data;
	},

	unSetZone: function(zone){
		zone.pid = null;
		zone.data = null;
		if(zone.dropZone) zone.dropZone.unlock();
		if(zone.dragZone) zone.dragZone.lock();
		zone.setTooltip(_('patient_name') + ': [empty]');
		zone.removeCls(zone.priority);
		zone.removeCls('zone-in-use');
		zone.data = null;
	},

	setZones: function(){
		var me = this,
			panel = me.getFloorPlanPatientZonePanel(),
			floorPlanId = me.getFloorPlanAreasCombo().getValue(),
			zones = panel.items.items,
			zone,
			data;

		PatientZone.getPatientsZonesByFloorPlanId(floorPlanId, function(response){

			zones = panel.items.items;
			data = response;

			for(var j = 0; j < zones.length; j++){
				me.unSetZone(zones[j]);
			}

			for(var i = 0; i < data.length; i++){
				zone = panel.getComponent(data[i].zoneId);
				zone.data = data[i];
				me.setZone(zone, data[i]);
			}
		})
	},

	setFloorPlan: function(floorPlanId){

	},

	promptPatientZoneAssignment: function(pid, floorPlanId, area_id, zone){
		var me = this;

		if(zone) return;

		if(!me.getFloorPlanPatientZoneAssignmentWindow()){

			Ext.create('Ext.window.Window', {
				title: _('patient_zone_assignment'),
				itemId: 'FloorPlanPatientZoneAssignmentWindow',
				items: [
					{
						xtype: 'combobox',
						width: 300,
						margin: 10,
						itemId: 'FloorPlanPatientZoneAssignmentCombo',
						queryMode: 'local',
						valueField: 'id',
						displayField: 'display',
						fieldLabel: _('zone'),
						labelAlign: 'top',
						editable: false,
						store: Ext.create('Ext.data.Store', {
							sorters: [
								{
									property: 'title'
								}
							],
							fields: [
								{
									name: 'id',
									type: 'int'
								},
								{
									name: 'title',
									type: 'string'
								},
								{
									name: 'display',
									type: 'string',
									convert: function(v, record){
										if(!record.get('is_multi_patient') && record.get('in_use') > 0){
											return '<span style="text-decoration: line-through; color: #c1c1c1">' +
												record.data.title + '</span> (' + _('inuse') + ')';
										}
										return record.data.title;
									}
								},
								{
									name: 'is_multi_patient',
									type: 'bool'
								},
								{
									name: 'in_use',
									type: 'int'
								}
							]
						})
					},
					{
						xtype: 'activeproviderscombo',
						margin: '0 10 10 10',
						width: 300,
						fieldLabel: _('provider'),
						labelAlign: 'top',
						itemId: 'FloorPlanPatientProviderAssignmentCombo'
					}
				],
				buttons: [
					{
						text: _('cancel'),
						itemId: 'FloorPlanPatientZoneAssignmentCancelBtn'
					},
					{
						text: _('save'),
						itemId: 'FloorPlanPatientZoneAssignmentSaveBtn'
					}
				]
			});
		}

		FloorPlans.getFloorPlanZonesByFloorPlanId(floorPlanId, function(result){
			var field = me.getFloorPlanPatientZoneAssignmentCombo();
			field.reset();
			field.getStore().loadData(result);
		});
		me.getFloorPlanPatientZoneAssignmentWindow().pid = pid;
		me.getFloorPlanPatientZoneAssignmentWindow().area_id = area_id;
		me.getFloorPlanPatientZoneAssignmentWindow().show();

	},

	onFloorPlanPatientZoneAssignmentCancelBtnClick: function(btn){
		this.getFloorPlanPatientZoneAssignmentWindow().close();
	},

	onFloorPlanPatientZoneAssignmentSaveBtnClick: function(btn){
		var zone_id = this.getFloorPlanPatientZoneAssignmentCombo().getValue(),
			provider_id = this.getFloorPlanPatientProviderAssignmentCombo().getValue(),
			win = this.getFloorPlanPatientZoneAssignmentWindow();

		if(zone_id && zone_id != null){
			PatientZone.addPatientToZone({
				zone_id: zone_id,
				provider_id: provider_id,
				pid: win.pid
			}, function(response){
				app.msg('Sweet!', _('patient_successfully_assigned_to_zone'));

				// TODO set zone with the data on hand
				// me.setZone(zone, data);
			});
		}

		win.close();

	},

	onFloorPlanPatientZoneAssignmentComboBeforeSelect: function(cmb, record){
		return record.get('is_multi_patient') || record.get('in_use') === 0;
	}

});
Ext.define('App.controller.areas.FloorPlansRules', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'FloorPlansRulesWindow',
			selector: '#FloorPlansRulesWindow'
		},
		{
			ref: 'FloorPlansRulesGrid',
			selector: '#FloorPlansRulesGrid'
		},
		{
			ref: 'FloorPlansRulesZoneCombo',
			selector: '#FloorPlansRulesZoneCombo'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				appfacilitychanged: me.onAppFacilityChanged
			},
			'#PatientPoolAreasPanel': {
				activate: me.onFPatientPoolAreasPanelActivate
			},
			'#FloorPlansRulesWindow': {
				show: me.onFloorPlansRulesWindowShow
			},
			'#FloorPlansRulesCancelBtn': {
				click: me.onFloorPlansRulesCancelBtnClick
			},
			'#FloorPlansRulesSaveBtn': {
				click: me.onFloorPlansRulesSaveBtnClick
			},
			'#FloorPlansRulesGrid': {
				beforeedit: me.onFloorPlansRulesGridBeforeEdit,
				validateedit: me.onFloorPlansRulesGridEdit
			},
			'#PatientPoolAreasRulesBtn': {
				click: me.onPatientPoolAreasRulesBtnClick
			},
		});

		// Ext.Function.defer(function () {
		// 	me.showFloorPlansRulesWindow();
		// },1000, me);

	},

	onFPatientPoolAreasPanelActivate: function(panel){
		panel.reloadStores();
	},

	onPatientPoolAreasRulesBtnClick: function(){
		this.showFloorPlansRulesWindow();
	},

	onAppFacilityChanged: function(ctl, facility_id){
		this.doLoadRules();
	},

	onFloorPlansRulesGridBeforeEdit: function(editor, e){
		var field = this.getFloorPlansRulesZoneCombo();

		field.store.load({
			params: {
				floor_plan_id: e.record.get('floor_plan_id')
			}
		});
	},

	onFloorPlansRulesGridEdit: function(editor, e){
		var field = this.getFloorPlansRulesZoneCombo(),
			zone_record = field.findRecordByValue(field.getValue());

		e.record.set({zone: zone_record.get('title')});
	},

	onFloorPlansRulesWindowShow: function(btn){
		this.doLoadRules();
	},

	doLoadRules: function(){

		if(!this.getFloorPlansRulesGrid()) return;

		var store = this.getFloorPlansRulesGrid().getStore();

		store.load({
			params: {
				facility_id: app.user.facility
			}
		});
	},

	onFloorPlansRulesCancelBtnClick: function(btn){
		this.getFloorPlansRulesGrid().getStore().rejectChanges();
		btn.up('window').close();
	},

	onFloorPlansRulesSaveBtnClick: function(btn){
		this.getFloorPlansRulesGrid().getStore().sync({
			callback: function () {
				btn.up('window').close();
			}
		});
	},

	showFloorPlansRulesWindow: function () {
		if(!this.getFloorPlansRulesWindow()){
			Ext.create('App.view.areas.FloorPlansRulesWindow');
		}
		return this.getFloorPlansRulesWindow().show();
	}

});
Ext.define('App.controller.areas.PatientPoolAreas', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'PatientPoolAreasPanel',
			selector: '#PatientPoolAreasPanel'
		},
		{
			ref: 'PatientPoolAreasRemovePatientMenu',
			selector: '#PatientPoolAreasRemovePatientMenu'
		},
		{
			ref: 'PatientToNextAreaWindow',
			selector: '#PatientToNextAreaWindow'
		},
		{
			ref: 'PatientPoolAreasPanel',
			selector: '#PatientPoolAreasPanel'
		},


		//navigation pool area
		{
			ref: 'NavigationPatientPoolAreaDatView',
			selector: '#NavigationPatientPoolAreaDatView'
		},
		{
			ref: 'NavigationPatientPoolAreaFloorPlanZonesCombo',
			selector: '#NavigationPatientPoolAreaFloorPlanZonesCombo'
		},
		{
			ref: 'PatientPoolAreasDisableAlertColorsBtn',
			selector: '#PatientPoolAreasDisableAlertColorsBtn'
		}


	],

	init: function(){
		var me = this;

		me.control({
			'#PatientPoolAreasPanel grid': {
				beforeitemcontextmenu: me.onPatientPoolAreasGridBeforeItemContextMenu,
				beforerender: me.onPatientPoolAreasGridBeforeRender
			},
			'#PatientPoolAreasRemovePatientMenu': {
				click: me.onPatientPoolAreasRemovePatientMenuClick
			},
			'#PatientToNextAreaWindow': {
				render: me.onPatientToNextAreaWindowBeforeRender
			},
			'#PatientToNextAreaWindow button[action=poolarea]': {
				click: me.onPatientToNextAreaWindowPoolAreaBtnClick
			},
			'#PatientToNextAreaWindowCancelBtn': {
				click: me.onPatientToNextAreaWindowCancelBtnClick
			},
			'#HeaderSendToPoolAreaBtn': {
				click: me.onHeaderSendToPoolAreaBtnClick
			},
			'#NavigationPatientPoolAreaFloorPlanZonesCombo': {
				beforerender: me.onNavigationPatientPoolAreaFloorPlanZonesComboBeforeRender
			},
			'#PatientPoolAreasDisableAlertColorsBtn': {
				toggle: me.onPatientPoolAreasDisableAlertColorsBtnToggle
			}
		});

		me.reloadAreaBuffer = Ext.Function.createBuffered(me.reloadArea, 50, me);
	},

	onPatientPoolAreasDisableAlertColorsBtnToggle: function (btn, pressed){
		var area_grids = this.getPatientPoolAreasPanel().query('grid');

		area_grids.forEach(function (grid){
			grid.showAlertColor = !pressed;
			grid.view.refresh();
		});
	},

	onPatientPoolAreasGridBeforeRender: function (grid){
		grid.showAlertColor = !this.getPatientPoolAreasDisableAlertColorsBtn().pressed;
	},

	getSelectedPoolAreaZones: function(){
		return this.getNavigationPatientPoolAreaFloorPlanZonesCombo().getValue();
	},

	onNavigationPatientPoolAreaFloorPlanZonesComboBeforeRender: function(cmb){
		// say('onNavigationPatientPoolAreaFloorPlanZonesComboBeforeRender');
		// say(cmb);
		// TODO: load only the zones allowed by user
		cmb.store.load();

	},

	getPoolAreaIdByConcept: function(concept){

		var container = this.getPatientPoolAreasPanel().getPageBody().down('container'),
			grid = container.child('grid[floorPlanConcept='+concept+']');

		return grid.floorPlanId || false;
	},

	onHeaderSendToPoolAreaBtnClick: function () {

		if(!app.patient.pid){
			app.msg(_('oops'),_('no_patient_selected'), true);
			return;
		}

		this.doSendPatientToNextArea(app.patient.pid, function () {
			app.openDashboard();
		});
	},

	reRenderPoolAreas: function () {
		this.getPatientPoolAreasPanel().reRenderPoolAreas();
	},

	doSendPatientToNextArea: function (pid, callback) {
		var win = this.showPatientToNextAreaWindow();
		win.pid = pid;
		win.callback = callback;
	},

	onPatientToNextAreaWindowPoolAreaBtnClick: function (btn) {
		var win = btn.up('window'),
			pid = win.pid,
			callback = win.callback,
			poolAreaId = btn.poolAreaId;

		//app.goToPoolAreas();
		win.close();
		this.getPatientPoolAreasPanel().doSendPatientToPoolArea(pid, poolAreaId, callback);
		app.patientPoolStore.reload();
	},

	onPatientToNextAreaWindowCancelBtnClick: function (btn) {
		btn.up('window').close();
	},

	showPatientToNextAreaWindow: function () {
		if(!this.getPatientToNextAreaWindow()){
			Ext.create('Ext.window.Window',{
				itemId: 'PatientToNextAreaWindow',
				title: _('send_patient_to_next_area'),
				layout: 'hbox',
				closeAction: 'hide',
				bodyPadding: '10 0 10 10',
				buttons: [
					{
						text: _('cancel'),
						itemId: 'PatientToNextAreaWindowCancelBtn'
					}
				]
			});
		}
		return this.getPatientToNextAreaWindow().show();
	},

	onPatientToNextAreaWindowBeforeRender: function (win) {
		var me = this,
			pools = me.getPatientPoolAreasPanel().getPoolAreas(),
			buttons = [];

		pools.forEach(function (pool) {
			buttons = Ext.Array.push(buttons, {
				xtype: 'button',
				text: '-> ' + pool.title,
				scale: 'medium',
				width: 100,
				action: 'poolarea',
				poolAreaId: pool.action,
				margin: '0 10 0 0'
			});
		});

		win.add(buttons);
	},

	onPatientPoolAreasRemovePatientMenuClick: function (item) {
		var me = this,
			pool_view = item.up('menu').pool_view,
			pool_view_store = pool_view.store;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('remove_patient_pool_area_msg'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn !== 'yes') return;

				var selection = pool_view.getSelectionModel().getSelection();

				selection.forEach(function (pool_record) {
					me.removePatientFromArea(pool_record, pool_view_store);
				});
			}
		});
	},

	reloadArea: function (store) {
		store.reload();
	},

	sendPatientToPoolArea: function(pid, area_id, appointment_id, callback){

		var me = this;

		PoolArea.sendPatientToPoolArea({
			pid: pid,
			sendTo: area_id,
			appointment_id: appointment_id
		}, function(response){

			app.fireEvent('sendpatienttoarea', me, pid, area_id, response);

			if(response.floor_plan_id == null){
				app.unsetPatient(null, true);
				app.nav['App_view_areas_PatientPoolAreas'].reloadStores();
				app.getPatientsInPoolArea();
				if(callback) callback(response);
				return;
			}

			app.getController('areas.FloorPlan').promptPatientZoneAssignment(response.record.pid, response.floor_plan_id, area_id, response.zone);

			if(callback) callback(response);


		});
	},


	removePatientFromArea: function (pool_record, pool_view_store) {
		var me = this,
			params = {
			area_id: pool_record.get('id')
		};

		PoolArea.removePatientArrivalLog(params, function (response) {
			if(response.success){
				me.reloadAreaBuffer(pool_view_store);
			}
		});
	},

	onPatientPoolAreasGridBeforeItemContextMenu: function (view, pool_record, item, index, e) {
		e.preventDefault();
		this.showPatientPoolAreasPanelGridMenu(view, e);
	},

	showPatientPoolAreasPanelGridMenu: function (pool_view, e) {
		var me = this;
		if(!me.grid_menu){
			me.grid_menu = Ext.widget('menu', {
				margin: '0 0 10 0',
				items: [
					{
						text: _('remove_patient'),
						itemId: 'PatientPoolAreasRemovePatientMenu',
						icon: 'resources/images/icons/delete.png'
					}
				]
			});
		}
		me.grid_menu.pool_view = pool_view;
		me.grid_menu.showAt(e.getXY());

		return me.grid_menu;
	}

});
Ext.define('App.controller.dashboard.panel.NotSignedVitals', {
	extend: 'App.controller.dashboard.Dashboard',

	init: function(){
		if(!a('view_dashboard_vitals_not_signed')) return;

		var me = this;

		me.control({
			'portalpanel':{
				render: me.onDashboardPanelBeforeRender
			},
			'#DashboardPanel':{
				activate: me.onDashboardPanelActivate
			},
			'#DashboardNotSignedVitalsGrid':{
				selectionchange: me.onDashboardNotSignedVitalsGridSelectionChange,
				itemdblclick: me.onDashboardNotSignedVitalsGridClick
			},
			'#DashboardNotSignedVitalsSignBtn':{
				click: me.onDashboardNotSignedVitalsSignBtnClick
			}
		});

		me.addRef([
			{
				ref: 'PatientSummaryPanel',
				selector:'#PatientSummaryPanel'
			},
			{
				ref: 'PatientSummaryPanelVitalsPanel',
				selector:'#PatientSummaryPanel vitalspanel'
			},
			{
				ref: 'DashboardRenderPanel',
				selector:'#DashboardPanel'
			},
			{
				ref: 'DashboardNotSignedVitalsGrid',
				selector:'#DashboardNotSignedVitalsGrid'
			},
			{
				ref: 'DashboardNotSignedVitalsSignBtn',
				selector:'#DashboardNotSignedVitalsSignBtn'
			}
		]);
	},

	onDashboardNotSignedVitalsGridSelectionChange: function (grid, selection) {
		this.getDashboardNotSignedVitalsSignBtn().setDisabled(selection.length === 0);
	},

	onDashboardNotSignedVitalsGridClick: function(grid, record){

		var me = this;

		grid.el.mask(_('please_wait'));
		app.setPatient(record.data.pid, null, null, function(){
			app.openPatientSummary();

			grid.el.unmask();

			Ext.Function.defer(function () {
				me.getPatientSummaryPanel().tabPanel.setActiveTab(me.getPatientSummaryPanelVitalsPanel());
			},500);

		});
	},


	onDashboardPanelActivate: function(){
		this.getDashboardNotSignedVitalsGrid().getStore().load();
	},

	onDashboardPanelBeforeRender: function(){
		this.addLeftPanel(_('vitals_not_signed'), Ext.create('App.view.dashboard.panel.NotSignedVitals'));
	},

	onDashboardNotSignedVitalsSignBtnClick: function () {

		var me = this,
			vitals_store = this.getDashboardNotSignedVitalsGrid().getStore(),
			vitals_records = this.getDashboardNotSignedVitalsGrid().getSelectionModel().getSelection();

		if(vitals_records.length === 0) return;

		app.passwordVerificationWin(function(btn, password){

			if(btn === 'ok'){

				User.verifyUserPass(password, function(provider, response){
					if(response.result){
						vitals_records.forEach(function (vitals_record) {
							vitals_record.set({
								auth_uid: app.user.id
							});
						});

						vitals_store.sync({
							callback: function () {
								vitals_store.reload();
							}
						});
					}else{
						Ext.Msg.show({
							title: 'Oops!',
							msg: _('incorrect_password'),
							buttons: Ext.Msg.OKCANCEL,
							icon: Ext.Msg.ERROR,
							fn: function(btn){
								if(btn === 'ok'){
									me.onDashboardNotSignedVitalsSignBtnClick();
								}
							}
						});
					}
				});
			}
		});

	}

});
Ext.define('App.controller.miscellaneous.Amendments', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'AmendmentsPanel',
			selector: '#AmendmentsPanel'
		},
		{
			ref: 'AmendmentsGrid',
			selector: '#AmendmentsGrid'
		},
		{
			ref: 'AmendmentDetailsWindow',
			selector: '#AmendmentDetailsWindow'
		},
		{
			ref: 'AmendmentDetailsForm',
			selector: '#AmendmentDetailsForm'
		},
		{
			ref: 'AmendmentDetailsDataGrid',
			selector: '#AmendmentDetailsDataGrid'
		},
		{
			ref: 'AmendmentDetailsResponseMessageField',
			selector: '#AmendmentDetailsResponseMessageField'
		},
		{
			ref: 'AmendmentDetailsApproveBtn',
			selector: '#AmendmentDetailsApproveBtn'
		},
		{
			ref: 'AmendmentDetailsDenyBtn',
			selector: '#AmendmentDetailsDenyBtn'
		},
		{
			ref: 'AmendmentDetailsResponseText',
			selector: '#AmendmentDetailsResponseText'
		},
		{
			ref: 'AmendmentDetailsUserLiveSearch',
			selector: '#AmendmentDetailsUserLiveSearch'
		},
		{
			ref: 'AmendmentDetailsAssignBtn',
			selector: '#AmendmentDetailsAssignBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#AmendmentsPanel' :{
				activate: me.onAmendmentsPanelActivate
			},
			'#AmendmentsGrid' :{
				itemdblclick: me.onAmendmentsPanelItemDblClick
			},
			'#PatientAmendmentsPanel' :{
				itemdblclick: me.onAmendmentsPanelItemDblClick
			},
			'#AmendmentDetailsDenyBtn' :{
				click: me.onAmendmentDetailsDenyBtnClick
			},
			'#AmendmentDetailsApproveBtn' :{
				click: me.onAmendmentDetailsApproveBtnClick
			},
			'#AmendmentDetailsAssignBtn' :{
				click: me.onAmendmentDetailsAssignBtnClick
			}
		});

		if(a('amendments_access')){

			me.cronSkip = 2;
			var cron = App.app.getController('Cron'),
				count = 2;
			cron.checkForUnreadAmendments = function(){
				count++;
				if(count && (count % me.cronSkip !== 0)) return;
				Amendments.getUnViewedAmendments(a('amendments_view_unassigned'), function(response){
					if(response.total > 0){
						var messages = [];
						for(var i=0; i < response.data.length; i++){
							Ext.Array.push(messages, response.data[i].id);
						}
						app.notification.add(
							'new_amendment_notification',
							_('pending_amendment') + ' (' + response.total + ')',
							messages,
							'miscellaneous.Amendments',
							'onNewAmendmentClick'
						);
					}else{
						app.notification.remove('new_amendment_notification');
					}
				});
			};
			cron.addCronFn('me.checkForUnreadAmendments()');
		}
	},

	onAmendmentsPanelActivate: function(){
		var store = this.getAmendmentsGrid().getStore(),
			filters = [{
				property: 'assigned_to_uid',
				value: app.user.id
			}];

		store.clearFilter(true);

		if(a('amendments_view_unassigned')){
			Ext.Array.push(filters, {
				property: 'assigned_to_uid',
				value: '0'
			});
		}

		store.filter(filters);
	},

	updateIsViewed: function(record){
		if(record.data.is_viewed === false){
			Amendments.updateAmendment({
				id: record.data.id,
				is_viewed: true
			});
		}
	},

	updateIsRead: function(record){
		if(record.data.is_read === false){
			Amendments.updateAmendment({
				id: record.data.id,
				is_read: true
			});
		}
	},

	onNewAmendmentClick: function(){
		this.getController('Navigation').goTo('App.view.miscellaneous.Amendments');
	},

	onAmendmentsPanelItemDblClick: function(grid, record){

		if(!this.getAmendmentDetailsWindow()){
			Ext.create('App.view.miscellaneous.AmendmentDetails');
		}
		this.getAmendmentDetailsWindow().show();

		var me = this,
			form = me.getAmendmentDetailsForm().getForm(),
			dataGrid = me.getAmendmentDetailsDataGrid(),
			dataStore = dataGrid.getStore(),
			data = [];

		Ext.Object.each(record.data.amendment_data, function(key, value){
			for(var i = 0; i < value.length; i++){
				value[i].data_key = key;
				value[i].approved = true;
				Ext.Array.push(data, value[i]);
			}
		});

		dataStore.removeAll();

		if(data.length > 0){
			dataGrid.show();
			dataStore.loadData(data);
		}else{
			dataGrid.hide();

		}

		me.getAmendmentDetailsUserLiveSearch().reset();
		form.reset(true);
		form.loadRecord(record);


		if(record.data.amendment_status === 'W'){

			me.getAmendmentDetailsUserLiveSearch().setVisible(a('amendments_assign'));
			me.getAmendmentDetailsAssignBtn().setVisible(a('amendments_assign'));

			me.getAmendmentDetailsApproveBtn().setDisabled(true);
			me.getAmendmentDetailsDenyBtn().setDisabled(!a('amendments_response'));
			me.getAmendmentDetailsResponseText().hide();
			me.getAmendmentDetailsResponseText().setText('');

			app.setPatient(record.data.pid, null, null, function(patient){
				if(patient.pid === null){
					app.msg(_('oops'), _('patient_not_found'), true);
					me.getAmendmentDetailsApproveBtn().setDisabled(!a('amendments_response'));
					return;
				}
				me.getAmendmentDetailsApproveBtn().setDisabled(false);
				app.openPatientSummary();
			});

		}else{

			me.getAmendmentDetailsUserLiveSearch().setVisible(false);
			me.getAmendmentDetailsAssignBtn().setVisible(false);

			me.getAmendmentDetailsApproveBtn().setDisabled(true);
			me.getAmendmentDetailsDenyBtn().setDisabled(true);
			me.getAmendmentDetailsResponseText().show();

			var msg = '';
			if(record.data.amendment_status == 'A'){
				msg += _('approved') + ' - ' + Ext.Date.format(record.data.response_date, g('date_time_display_format'));
			}else if(record.data.amendment_status == 'D'){
				msg += _('denied') + ' - ' + Ext.Date.format(record.data.response_date, g('date_time_display_format'));
			}else if(record.data.amendment_status == 'C'){
				msg += _('canceled') + ' - ' + Ext.Date.format(record.data.cancel_date, g('date_time_display_format'));
			}

			me.getAmendmentDetailsResponseText().setText(msg);

		}
	},

	onAmendmentDetailsDenyBtnClick: function(){
		var form = this.getAmendmentDetailsForm().getForm(),
			record = form.getRecord(),
			messageField = this.getAmendmentDetailsResponseMessageField(),
			dataStore = this.getAmendmentDetailsDataGrid().getStore(),
			dataRecords = dataStore.data.items,
			amendment_data = {};

		messageField.allowBlank = false;

		if(!messageField.isValid()) return;

		if(dataRecords.length > 0){
			for(var i = 0; i < dataRecords.length; i++){
				dataRecords[i].set({approved: false});
				var key = dataRecords[i].data.data_key;

				if(!amendment_data[key]) amendment_data[key] = [];
				delete dataRecords[i].data.data_key;

				Ext.Array.push(amendment_data[key], dataRecords[i].data);
			}
		}

		record.set({
			amendment_data: amendment_data,
			is_synced: false,
			response_uid: app.user.id,
			response_date: new Date(),
			update_uid: app.user.id,
			update_date: new Date(),
			amendment_status: 'D',
			response_message: this.getAmendmentDetailsResponseMessageField().getValue()
		});

		record.save({
			callback: function(){
				app.msg(_('sweet'), _('record_saved'));
			}
		});

		this.getAmendmentDetailsWindow().close();
	},

	onAmendmentDetailsApproveBtnClick: function(){
		var me = this,
			form = me.getAmendmentDetailsForm().getForm(),
			record = form.getRecord(),
			messageField = me.getAmendmentDetailsResponseMessageField(),
			dataStore = me.getAmendmentDetailsDataGrid().getStore(),
			dataRecords = dataStore.data.items,
			amendment_data = {};

		messageField.allowBlank = true;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('amendment_approval_confirmation'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn == 'yes'){

					if(dataRecords.length > 0){
						for(var i = 0; i < dataRecords.length; i++){
							var key = dataRecords[i].data.data_key;
							if(!amendment_data[key]) amendment_data[key] = [];
							delete dataRecords[i].data.data_key;
							Ext.Array.push(amendment_data[key], dataRecords[i].data);
						}
					}

					record.set({
						amendment_data: amendment_data,
						is_synced: false,
						response_uid: app.user.id,
						response_date: new Date(),
						update_uid: app.user.id,
						update_date: new Date(),
						amendment_status: 'A',
						response_message: me.getAmendmentDetailsResponseMessageField().getValue()
					});

					me.doUpdatePatientData(amendment_data, record.data.pid, record.data.eid);

					record.save({
						callback: function(){
							app.msg(_('sweet'), _('record_saved'));
							app.setPatient(record.data.pid, null, null, function(){
								app.openPatientSummary();
							});

						}
					});
					me.getAmendmentDetailsWindow().close();
				}
			}
		});
	},

	onAmendmentDetailsAssignBtnClick: function(btn){
		var me = this,
			record = me.getAmendmentDetailsForm().getForm().getRecord(),
			searchField = me.getAmendmentDetailsUserLiveSearch(),
			assigned_user = searchField.getValue();

		if(!searchField.isValid()) return;
		me.getAmendmentDetailsWindow().mask(_('saving'));

		record.set({
			assigned_date: new Date(),
			assigned_to_uid: assigned_user
		});

		record.save({
			success: function(){
				app.msg(_('sweet'), _('amendment_assigned'));
				me.getAmendmentDetailsWindow().unmask();
				me.getAmendmentDetailsWindow().close();
			},
			failure: function(){
				app.msg(_('opps'), _('record_error'), true);
				me.getAmendmentDetailsWindow().unmask();
			}
		});

	},


	doUpdatePatientData: function(data, pid, eid){
		if(data.demographics){
			var panel = app.getActivePanel();
			if(panel.itemId == 'PatientSummaryPanel'){
				var values = {};
				for(var i = 0; i < data.demographics.length; i++){
					values[data.demographics[i].field_name] = data.demographics[i].new_value;
				}
				app.patient.record.set(values);
				app.patient.record.save();
			}
		}
	}

});

Ext.define('App.controller.dashboard.panel.DailyVisits', {
	extend: 'App.controller.dashboard.Dashboard',

	init: function(){
		if(!a('view_dashboard_daily_visits')) return;

		var me = this;

		me.control({
			'portalpanel': {
				render: me.onDashboardPanelBeforeRender
			},
			'#DashboardPanel': {
				activate: me.onDashboardPanelActivate
			}
		});

		me.addRef([
			{
				ref: 'DashboardRenderPanel',
				selector: '#DashboardPanel'
			},
			{
				ref: 'DashboardDailyVisitsChart',
				selector: '#DashboardDailyVisitsChart'
			}
		]);
	},

	onDashboardPanelActivate: function(){
		this.loadChart();
	},

	onDashboardPanelBeforeRender: function(){
		this.addRightPanel(_('daily_visits'), Ext.create('App.view.dashboard.panel.DailyVisits'));
	},

	loadChart: function(){
		var me = this,
			store = me.getDashboardDailyVisitsChart().getStore(),
			data = [],
			time,
			i,
			j;

		Encounter.getDashboardTodayEncounters(function(response){

			// var encounters = response;
			//
			// for(i=0; i < encounters.length; i++){
			// 	time = Ext.Date.parse(encounters[i].service_date, 'Y-m-d H:i:s').getHours();
			//
			// 	var found = false;
			//
			// 	say(encounters[i]);
			// 	say(time);
			//
			// 	for(j=0; j < data.length; j++){
			// 		if(data[j].time == time){
			// 			data[j].total = data[j].total + 1;
			// 			found = true;
			// 		}
			// 	}
			//
			// 	if(!found){
			// 		data.push({
			// 			total: 1,
			// 			time: time
			// 		});
			// 	}
			// }
			//
			//
			//
			// say(data);

			store.loadData(response);

			say(store);
		});
	}

});
Ext.define('App.controller.dashboard.panel.OpenEncounters', {
	extend: 'App.controller.dashboard.Dashboard',

	init: function(){
		if(!a('view_dashboard_open_encounters')) return;

		var me = this;

		me.control({
			'portalpanel':{
				render: me.onDashboardPanelBeforeRender
			},
			'#DashboardPanel':{
				activate: me.onDashboardPanelActivate
			},
			'#DashboardOpenEncountersGrid':{
				itemdblclick: me.onDashboardOpenEncountersGridClick
			}
		});

		me.addRef([
			{
				ref: 'PatientSummaryPanel',
				selector:'#PatientSummaryPanel'
			},
			{
				ref: 'DashboardRenderPanel',
				selector:'#DashboardPanel'
			},
			{
				ref: 'DashboardOpenEncountersGrid',
				selector:'#DashboardOpenEncountersGrid'
			}
		]);
	},

	onDashboardOpenEncountersGridClick: function(grid, record){

		var me = this;

		grid.el.mask(_('please_wait'));
		app.setPatient(record.data.pid, null, null, function(){
			app.openEncounter(record.data.eid);

			grid.el.unmask();

			// Ext.Function.defer(function () {
			// 	me.getPatientSummaryPanel().tabPanel.setActiveTab(me.getPatientSummaryPanelVitalsPanel());
			// },500);

		});
	},


	onDashboardPanelActivate: function(){
		this.getDashboardOpenEncountersGrid().getStore().load({params: { provider_uid: app.user.id }});
	},

	onDashboardPanelBeforeRender: function(){
		this.addLeftPanel(_('open_encounters'), Ext.create('App.view.dashboard.panel.OpenEncounters'));
	}

});
Ext.define('App.controller.BarcodeScanner', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [

	],
	socket: undefined,
	host: 'local.tranextgen.com',
	port: 9797,
	connected: false,
	waiting: false,
	callback: undefined,

	reconnect_interval: 1000 * 5, // 5 seconds
	connect_delay: 1000 * 3, // 5 seconds
	debug: false,
	initiated: false,

	init: function(){
		var me = this;
		Ext.Function.defer(me.connect, me.connect_delay, me);
	},

	connect: function () {

		var me = this;

		if(me.socket) return;

		me.socket = new WebSocket('wss://' + me.host +':' + me.port + '/');

		me.socket.onopen = function (event) {
			me.onOpen(event.data);
		};
		me.socket.onclose = function (event) {
			me.onClose(event.data);
		};
		me.socket.onmessage = function (event) {
			me.onMessage(event.data);
		};
		me.socket.onerror = function (event) {
			me.onError(event.data);
		};

	},

	reconnect: function () {
		var me = this;

		if(!me.initiated) return;

		this.log('reconnect');

		me.connected = false;
		delete me.socket;

		Ext.Function.defer(function () {
			me.connect();
		},me.reconnect_interval);
	},

	send: function (message, callback) {
		this.socket.send(message);
		this.callback = callback;
	},

	onOpen: function (data) {
		this.log('onOpen');
		this.log(data);
		this.initiated = true;
		this.connected = true;
		Ext.Function.defer(function () {
			app.fireEvent('barcodescanneropen', this);
		},1000, this);
	},

	onClose: function (data) {
		this.log('onClose');
		this.log(data);
		this.reconnect();
		Ext.Function.defer(function () {
			app.fireEvent('barcodescannerclose', this);
		},1000, this);
	},

	onMessage: function (data) {
		this.log('onMessage');
		this.log(data);

		data = JSON.parse(data);

		if(data.action && data.action === 'barcode'){

			if(data.data.search(/ANSI \d/) !== -1){
				app.fireEvent('barcodelicensescanned',  data.data);
			}else{
				app.fireEvent('barcodescanned',  data.data);
			}
		}else{
			// callback is defined
			if(this.callback){
				this.callback(data);
				this.callback = undefined;
			}
		}
	},

	onError: function (data) {
		this.log('onError');
		this.log(data);
		this.reconnect();
	},


	log: function (msg) {
		if(this.debug){
			say(msg);
		}
	},

	sendMessage: function(message, callback){
		if(this.connected){
			this.send(JSON.stringify(message), callback);
		}else {
			app.msg(_('oops'), _('not_conneted'), true);
		}
	}
});
Ext.define('App.controller.Clock', {
    extend: 'Ext.app.Controller',

	refs:[
		{
			ref: 'ApplicationClockContainer',
			selector: '#ApplicationClockContainer'
		}
	],

	init: function() {
		var me = this;

		me.control({
			'#ApplicationClockContainer' :{
				render: me.initClock
			}
		});

		/**
		 * TaskScheduler
		 */
		me.cronTask = {
			scope: me,
			run: function(){
				me.clock.el.dom.firstChild.firstChild.innerHTML = Ext.Date.format(me.date, 'F j, Y, g:i:s a');
				me.date = Ext.Date.add(me.date, Ext.Date.SECOND, 1);
			},
			interval: 1000
		};
	},

	initClock: function(clock){
		this.clock = clock;
		this.date = new Date();
		Ext.TaskManager.start(this.cronTask);
	},

	updateClock:function(date){
		this.date = new Date(date.year, (date.mon -1), date.mday, date.hours, date.minutes, date.seconds );
	},

	getTime: function () {
		return Ext.clone(this.date);
	},

	getDate: function () {
		return this.getTime();
	}

});

Ext.define('App.controller.Cron', {
    extend: 'Ext.app.Controller',

    // in seconds - interval to run me.cronTask (check PHP session, refresh Patient Pool Areas, and PHP Cron Job)
	cronTaskInterval: 15,

	fns:[
		'app.getPatientsInPoolArea()',
		'me.checkSession()',
		'me.getTime()'
	],

	init: function() {
		var me = this,
            i;

		me.clock = me.getController('Clock');

		/**
		 * TaskScheduler
		 */
		me.cronTask = {
			scope: me,
			run: function(){
				/**
				 * loop for functions
				 */
				for(i=0; i < me.fns.length; i++){
					eval(me.fns[i]);
				}
			},
			interval: me.cronTaskInterval * 1000
		};

	},

	start:function(){
		Ext.TaskManager.start(this.cronTask);
	},

	stop:function(){
		Ext.TaskManager.stop(this.cronTask);
	},


	/**
	 *This will add the function to the functions array
	 *
	 * @param {string} fn example 'app.getPatientsInPoolArea()'
	 */
	addCronFn:function(fn){
		this.fns.push(fn);
	},

	/**
	 * This will remove the function from the functions array
	 *
	 * @param {string} fn example 'app.getPatientsInPoolArea()'
	 */
	removeCronFn:function(fn){
		Ext.Array.remove(this.fns, fn);
	},

	checkSession: function(){
		authProcedures.ckAuth(function(response){
			app.setIpAddress(response.ip);
			if(!response.authorized){
				window.location.reload();
			}
		});

	},

	getTime: function(){
		var me = this;
		AppDate.getDate(function(date){
			me.clock.updateClock(date);
		});
	}

});

Ext.define('App.controller.DualScreen', {
    extend: 'Ext.app.Controller',
	requires:[

	],
	refs: [
        {
            ref:'DualViewport',
            selector:'#dualViewport'
        },
        {
            ref:'Header',
            selector:'#RenderPanel-header'
        },
        {
            ref:'TabPanel',
            selector:'#dualViewport tabpanel'
        },
        {
            ref:'ApplicationDualScreenBtn',
            selector:'#ApplicationDualScreenBtn'
        }
	],

	isDual: false,
	appMask: null,
	pid: null,
	init: function() {
		var me = this;

		me._loggedout = false;
		me._enable = false;
		me._screen = null;

		me.control({
			'#ApplicationDualScreenBtn':{
				toggle: me.onApplicationDualScreenBtnToggle
			},
			'#dualViewport':{
				render:me.onDualViewportRender,
				beforerender:me.onDualViewportBeforeRender
			}
		});

	},

	onApplicationDualScreenBtnToggle: function (btn){
		if(btn.pressed){
			this.startDual();
		}else{
			this.stopDual();
		}
	},

	startDual:function(){
		var me = this;
		me.enable();
		if(me._screen == null || me._screen.closed){
			me._screen = window.open(('./?site='+ app.user.site + '&dual=true'),'_target','fullscreen=yes,menubar=no',true);
		}
	},

	stopDual:function(){
		this.disable();
		//if(this._screen) this._screen.close();
		this._screen = null;
	},

	enable:function(){
		app._dual_enable = true;
		this._enable = true;
	},

	disable:function(){
		app._dual_enable = false;
		this._enable = false;
	},

	isEnabled:function(){
		return this._enable;
	},

	onDualViewportBeforeRender:function(){
		this.isDual = true;
		window.app = window.opener.app;
		// app.on('patientset', this.onPatientSet, this);
		// app.on('patientunset', this.onPatientUnset, this);
	},

	onDualViewportRender:function(){
		Ext.get('mainapp-loading').remove();
		Ext.get('mainapp-loading-mask').fadeOut({
			remove: true
		});
		this.onPatientUnset(false);
		this.initHandShakeTask();
	},

	onPatientSet:function(){
        var title,
            store;

		if(!this.isDual || this._loggedout) return;
		title = app.patient.name + ' - #' + app.patient.pid + ' - ' + app.patient.age.str,
			store = this.getActiveStore();

		this.unmask();
		this.getHeader().update(title);
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onPatientUnset:function(filter){
        var store;

		if(!this.isDual || this._loggedout) return;
		store = this.getActiveStore();

		this.mask(_('no_patient_selected'));
		this.getHeader().update('');

		if(filter === false) return;
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	getActiveStore:function(){
		var panel = this.getTabPanel().getActiveTab();

		if(panel.getStore){
			return panel.getStore();
		}if(panel.xtype == 'patientdocumentspanel' ||
			panel.xtype == 'patientimmunizationspanel' ||
			panel.xtype == 'patientmedicationspanel' ||
			panel.xtype == 'patientimmunizationspanel'){
			return panel.down('grid').getStore();
		}
	},

	mask:function(msg){
		var me = this;
		if(me.appMask == null){
			me.appMask = new Ext.LoadMask(me.getDualViewport(), {
				msg : '<img height="190" width="190" src="resources/images/logo_190_190.jpg"><p>' + msg + '</p>',
				maskCls: 'dualAppMask',
				cls: 'dualAppMaskMsg',
				autoShow: true
			});
		}else{
			me.appMask.show();
			me.appMask.msgEl.query('p')[0].innerHTML = msg;
		}
	},

	unmask:function(){
		if(this.appMask) this.appMask.hide();
	},

	initHandShakeTask:function(){
		var me = this,
			task = {
			run: function(){
				if(window.opener == null || !window.app._dual_enable){
					// window.app.un('patientset', this.onPatientSet, this);
					// window.app.un('patientunset', this.onPatientUnset, this);
					window.app = null;
					me.pid = null;
					window.close();
				}else if(!window.opener.app.logged && !me._loggedout){
					me.pid = null;
					me.mask(_('logged_out'));
					me._loggedout = true;
				}else if(window.opener.app.patient.pid === null){
					me.pid = null;
					me.onPatientUnset();
				}else if(window.opener.app.patient.pid !== me.pid){
					me.pid = Ext.clone(window.opener.app.patient.pid);
					me.onPatientSet(true);
				}
			},
			interval: 1000,
			scope: me
		};
		Ext.TaskManager.start(task);
	}

});

Ext.define('App.controller.AlwaysOnTop', {
	extend: 'Ext.app.Controller',

	alwaysOnTopManager: null,

	init: function() {
		this.control({
			'component{isFloating()}': {
				'render': function (component, options) {
					this.onComponentRender(component, options);
				}
			}
		});
		/* Uncommenting the code below makes sure that all Ext.window.MessageBoxes stay on top. */
		/*
		 Ext.override(Ext.window.MessageBox, {
		 alwaysOnTop: true
		 });
		 */
		/* Uncommenting the code below makes sure that all form errormessages stay on top.
		 Necessary if you have a form inside a alwaysOnTop window. */
		/*
		 Ext.override(Ext.tip.ToolTip, {
		 alwaysOnTop: true
		 });
		 */
	},

	onComponentRender: function (component, options) {
		if (component.alwaysOnTop) {
			if (!this.alwaysOnTopManager) {
				this.alwaysOnTopManager = Ext.create('Ext.ZIndexManager');
			}
			this.alwaysOnTopManager.register(component);
		}
		if (this.alwaysOnTopManager) {
			/* Making sure the alwaysOnTopManager always has the highest zseed */
			if (Ext.ZIndexManager.zBase > this.alwaysOnTopManager.zseed) {
				this.alwaysOnTopManager.zseed = this.alwaysOnTopManager.getNextZSeed();
			}
		}
	}

});
Ext.define('App.controller.Navigation', {
    extend: 'Ext.app.Controller',
	requires:[
		'Ext.util.History'
	],
	refs: [
        {
            ref:'viewport',
            selector:'viewport'
        },
        {
            ref:'mainNavPanel',
            selector:'panel[action=mainNavPanel]'
        },
        {
            ref:'mainNav',
            selector:'treepanel[action=mainNav]'
        },
        {
            ref:'patientPoolArea',
            selector:'panel[action=patientPoolArea]'
        },
        {
            ref:'appFooter',
            selector:'container[action=appFooter]'
        },
        {
            ref:'appFooterDataView',
            selector:'container[action=appFooter] > dataview'
        }
	],

	navKey: 'ALT',
	navKeysEnabled: false,

	init: function() {
		var me = this;

		me.navKey = this.setNavKey(this.navKey);

		me.activePanel = null;
		me.altIsDown = false;

		Ext.util.History.init();
		Ext.util.History.on('change', me.urlChange, me);

		if(me.navKeysEnabled) me.enableNavKeys();

		me.control({
			'viewport':{
				patientset: me.onPatientSet,
				patientunset: me.onPatientUnset
			},
			'treepanel[action=mainNav]':{
				selectionchange: me.onNavigationNodeSelected,
				beforerender: me.onNavigationBeforeRender
			},
			'panel[action=mainNavPanel]':{
				render: me.onNavRender,
				beforecollapse: me.onNavCollapsed,
				beforeexpand: me.onNavExpanded
			}
		});

	},

	getTopNavigation:function(){
		return app
	},

	/**
	 *
	 * @param {object} treepanel
	 */
	onNavigationBeforeRender:function(treepanel){
		treepanel.getStore().on('load', this.afterNavigationLoad, this);
	},

	navigateToDefault: function(){
		this.navigateTo('App.view.dashboard.Dashboard');
	},

	/**
	 *
	 * @param {string} cls  - example: 'App.view.ExamplePanel'
	 * @param {function} [callback] - callback function
	 * @param {bool} resetParams true to reset all params
	 */
	navigateTo: function(cls, callback, resetParams){
		var params = resetParams !== true ? this.getUrlParams() : [];
		params[0] = cls;
		this.setUrlParams(params);
		if(typeof callback == 'function') callback(true);
	},


	goTo: function(cls, callback, resetParams){
		this.navigateTo(cls, callback, resetParams);
	},

	/**
	 *
	 * @param {object} model
	 * @param {array} selected
	 */
	onNavigationNodeSelected: function(model, selected){
		if(0 < selected.length){
			if(selected[0].data.leaf){
				this.navigateTo(selected[0].data.id);
			}
		}
	},

	/**
	 * this logic can be move to here eventually...
	 */
	afterNavigationLoad: function(){
		var me = this;

		app.removeAppMask();
		me.navigateToDefault();

		Ext.Function.defer(function(){
			me.doSortCategory('administration')
		}, 500);
	},

	doSortCategory: function(category){
		var store = this.getMainNav().getStore().getNodeById(category);

		if(!store) return;
		store.sort(function(node1, node2){
			var text1 = node1.get('text'),
				text2 = node2.get('text');

			if(text1 > text2){
				return 1;
			}else if(text1 < text2){
				return -1;
			}else{
				return 0;
			}
		});
	},

	setUrlParams:function(params){
		var url = '#!/';
		if(params.length > 0) url += params.join('/');
		window.location = url;
	},

	getUrlParams:function(){
		if(window.location.hash){
			return window.location.hash.substring(1).replace(/!\//, '').split('/');
		}
		return [];
	},

	getUrlCls: function () {
		return  this.getUrlParams()[0];
	},

	/**
	 * this method handle the card layout when the URL changes
	 * @param {string} url
	 */
	urlChange:function(url){
		var me = this,
			tree = me.getMainNav(),
			treeStore = tree.getStore(),
			cls = me.getUrlCls(),
			ref = me.getNavRefByClass(cls),
			layout = me.getViewport().MainPanel.getLayout(),
			sm = tree.getSelectionModel(),
			node = treeStore.getNodeById(cls);

		this.url = url;
		if(node){
			sm.select(node);
		}else{
			sm.deselectAll();
		}

		// ignore the Login
		if(cls == 'App.view.login.Login') return;

		// if the panel is 'undefined' added to MainPanel
		if (typeof me[ref] == 'undefined') {
			//me.getViewport().MainPanel.el.mask();
			me[ref] = me.getViewport().MainPanel.add(Ext.create(cls));

		// if the class is destroyed then render it
		} else {
			if (me[ref].isDestroyed) me[ref].render();
		}

		// fire global event
		me.getViewport().fireEvent('beforenavigation', me[ref]);

		// call panel onActive method
		me[ref].onActive(function(success){
			//me.getViewport().MainPanel.el.unmask();
			if(success){
				me.activePanel = layout.setActiveItem(me[ref]);
			}
		});

		// fire global event
		me.getViewport().fireEvent('afternavigation', me[ref]);

		app.doLayout();

	},

	/**
	 * this method acts as pressing the browser back btn
	 */
	goBack: function(){
		Ext.util.History.back();
	},

	/**
	 * this method gets the instance reference of a main panel class
	 * @param {string} cls
	 * @returns {*}
	 */
	getPanelByCls:function(cls){
		var me = this,
			ref = me.getNavRefByClass(cls);
		if (typeof me[ref] == 'undefined') {
			return me[ref] = me.getViewport().MainPanel.add(Ext.create(cls));
		}else{
			return me[ref];
		}
	},

	/**
	 * this method gets the reference string of the class string App.view.Panel => App_view_Panel
	 * @param {string} cls
	 * @returns {XML|Ext.dom.AbstractElement|Object|Ext.dom.Element|string|*}
	 */
	getNavRefByClass: function(cls) {
		return  cls.replace(/\./g, '_');
	},

	/**
	 * this method gets the class string of a reference string App_view_Panel => App.view.Panel
	 * @param ref
	 * @returns {XML|Ext.dom.AbstractElement|Object|Ext.dom.Element|string|*}
	 */
	getClassByNavRef: function(ref) {
		return ref.replace(/_/g, '.');
	},

	/**
	 *
	 * @param panel
	 */
	onNavRender: function(panel){
		if(panel.collapsed){
			this.onNavCollapsed();
		}else{
			this.onNavExpanded();
		}
	},

	/**
	 * this method shows the footer poolarea
	 */
	onNavCollapsed: function(){
		var me = this,
			navView = me.getPatientPoolArea(),
			foot = me.getAppFooter(),
			footView = me.getAppFooterDataView();

		if(footView){
			foot.setHeight(60);
			footView.show();
		}

		me.getMainNavPanel().isCollapsed = true;
		navView.hide();
	},

	/**
	 * this method hides the footer poolarea
	 */
	onNavExpanded: function(){
		var me = this,
			navView = me.getPatientPoolArea(),
			foot = me.getAppFooter(),
			footView = me.getAppFooterDataView();

		if(footView){
			foot.setHeight(30);
			footView.hide();
		}

		me.getMainNavPanel().isCollapsed = false;
		navView.show();
	},

	/**
	 *
	 * @param viewport
	 * @param patient
	 */
	onPatientSet:function(viewport, patient){
//		say('onPatientSet');
//		say(patient);
	},

	/**
	 *
	 * @param viewport
	 */
	onPatientUnset:function(viewport){
//		say('onPatientUnset');
	},

	captureDownKey:function(e){

		if(e.getKey() == e.ALT){
			this.altIsDown = true;
			return;
		}
		if(!this.altIsDown) return;
		this.getViewport().fireEvent('navkey', e, e.getKey());
	},

	captureUpKey:function(e){
		if(e.getKey() == e.ALT) this.altIsDown = false;
	},

	setNavKey:function(key){
		return this.navKey = Ext.EventObjectImpl[key];
	},

	getNavKey:function(){
		return this.navKey;
	},

	getExtraParams: function(){
		var params = this.getUrlParams();
		for(var i=0; i < params.length; i++){
			if(params[i].match(/^{.*}$/)) return eval('('+params[i]+')');
		}
		return false;
	},

	enableNavKeys: function(){
		Ext.getBody().on('keydown', this.captureDownKey, this);
		Ext.getBody().on('keyup', this.captureUpKey, this);
	},

	disabledNavKeys: function(){
		Ext.getBody().un('keydown', this.captureDownKey, this);
		Ext.getBody().un('keyup', this.captureUpKey, this);
	},

	addNavigationNodes: function(parentId, node, index){
		var parent,
			firstChildNode,
			nodes,
			i,
			nav = this.getMainNav(),
			store;

		if(!nav){
			Ext.Function.defer(function(){
				this.addNavigationNodes(parentId, node, index);
			}, 5000, this);
			return;
		}

		store = nav.getStore();

		if(!store){
			Ext.Function.defer(function(){
				this.addNavigationNodes(parentId, node, index);
			}, 10000, this);
			return;
		}

		if(parentId == 'root' || parentId == null){
			parent = store.getRootNode();
		}
		else{
			parent = store.getNodeById(parentId);
		}

		say('addNavigationNodes');
		say(parent);

		if(parent){
			firstChildNode = parent.findChildBy(function(node){
				return node.hasChildNodes();
			});

			if(Ext.isArray(node)){
				nodes = [];
				for(i = 0; i < node.length; i++){
					Ext.Array.push(nodes, parent.insertBefore(node[i], firstChildNode));
				}
				return nodes;
			}
			else if(index){
				return parent.insertChild(index, node);
			}else{
				return parent.insertBefore(node, firstChildNode);
			}
		}
	},

});
Ext.define('App.controller.Header', {
    extend: 'Ext.app.Controller',
	requires:[
	],
	refs: [
        {
            ref:'AppHeaderRight',
            selector:'#AppHeaderRight'
        },
        {
            ref:'AppHeaderLeft',
            selector:'#AppHeaderLeft'
        }
	],

	init: function() {
		var me = this;
	},

	/**
	 *
	 * @param {object}  btn         btn config
	 * @param {string}  area        left or right
	 * @param {int}     position    position index
	 */
	addHeaderBtn: function(btn, area, position){

		btn = btn || {};
		area = area || 'left';
		position = position || 0;

		var comp = area == 'left' ? this.getAppHeaderLeft() : this.getAppHeaderRight(),
			btnConf = Ext.apply(btn, {
			xtype: 'button',
			scale: 'large',
			margin: '0 3 0 0',
			cls: 'headerLargeBtn',
			padding: 0
		});

		comp.insert(position, btnConf);

	}

});
Ext.define('App.controller.KeyCommands', {
    extend: 'Ext.app.Controller',
	refs: [
        {
            ref:'viewport',
            selector:'viewport'
        }
	],

	enabled: false,

	init: function() {
		this.enableKeyCommands();
	},

	enableKeyCommands: function(){
		if(this.enabled) return;
		Ext.getBody().on('keyup', this.onKeyUp, this);
		this.enabled = true;
	},

	disableKeyCommands: function(){
		Ext.getBody().un('keyup', this.onKeyUp, this);
		this.enabled = false;
	},


	onKeyUp: function(e, t, eOpts){

		if(e.getKey() == e.ALT || e.getKey() == e.CTRL || e.getKey() == e.SHIFT){
			return;
		}

		if(e.altKey || e.ctrlKey || e.shiftKey){
			var event = 'KEY-';
			if(e.altKey) event += 'ALT-';
			if(e.ctrlKey) event += 'CTRL-';
			if(e.shiftKey) event += 'SHIFT-';
			event += String.fromCharCode(e.getCharCode());
			app.fireEvent(event, e, t);
		}

		if(e.altKey && e.ctrlKey && e.shiftKey){
			var action = '';

			if(e.getKey() == e.A){
				action = 'allergies';
			}else if(e.getKey() == e.I){
				action = 'immunization';
			}else if(e.getKey() == e.M){
				action = 'medications';
			}else if(e.getKey() == e.P){
				action = 'activeproblems';
			}else if(e.getKey() == e.R){
				action = 'laboratories';
			}else if(e.getKey() == e.C){
				action = 'social';

			// close window
			}else if(e.getKey() == e.W){
				var cmp = Ext.getCmp(e.getTarget(null, null, true).id);

				if(cmp.xtype == 'window'){
					cmp.close();
				}else{
					var win = cmp.up('window');
					if(win) win.close();
				}
				return;
			}

			if(action != ''){
				app.onMedicalWin(action);
			}

		}
	}



});
Ext.define('App.controller.InfoButton', {
	extend: 'Ext.app.Controller',
	requires: [


	],

	language: 'patient',

	init: function(){
		var me = this;

		me.medline  = 'http://apps2.nlm.nih.gov/medlineplus/services/mpconnect.cfm?';

		me.codeSytem = {
			'ICD10CM': '2.16.840.1.113883.6.90',
			'ICD10-CM': '2.16.840.1.113883.6.90',
			'ICD-10-CM': '2.16.840.1.113883.6.90',
			'ICD9CM': '2.16.840.1.113883.6.103',
			'ICD9-CM': '2.16.840.1.113883.6.103',
			'ICD-9-CM': '2.16.840.1.113883.6.103',
			'SNOMED': '2.16.840.1.113883.6.96',
			'SNOMEDCT': '2.16.840.1.113883.6.96',
			'SNOMED-CT': '2.16.840.1.113883.6.96',
			'RXCUI': '2.16.840.1.113883.6.88',
			'NDC': '2.16.840.1.113883.6.69',
			'LN': '2.16.840.1.113883.6.1',
			'LOINC': '2.16.840.1.113883.6.1'
		};

		me.control({

		});

	},

	doGetInfo: function(code, codeType, codeText){
		var me = this;

		var url = me.medline;
		url += 'mainSearchCriteria.v.c=' + code;
		url += '&mainSearchCriteria.v.cs=' + me.codeSytem[codeType];

		if(me.language == 'patient' && app.patient.record && app.patient.record.get('language') == 'spa'){
			url += '&informationRecipient.languageCode.c=es';
		}else {
			url += '&informationRecipient.languageCode.c=en';
		}

		window.open(url, "_blank", "toolbar=no, scrollbars=yes, resizable=yes, top=10, left=10, width=1000, height=600");
//		WebSearchCodes.Search({ code: code, codeType: codeType, codeText: codeText }, function(data){
//			me.getInformationWindow(data);
//		})
	},

	doGetInfoByUrl: function(url){
		var me = this;
		window.open(url, "_blank", "toolbar=no, scrollbars=yes, resizable=yes, top=10, left=10, width=1000, height=600");
	},

	getInformationWindow: function(data){
		Ext.widget('window', {
			title: _('information'),
			autoShow: true,
			width: 800,
			height: 600,
			data: data,
			autoScroll: true,
			tpl: new Ext.XTemplate(
				'<div class="externalinfo-container">' +
				'<h1>{feed.title._value}</h1>' +
				'<h2>{feed.subtitle._value}</h2>' +
				'<p><span>Author:</span> {feed.author.name._value}</h1>' +
				'<p><span>Updated:</span> {feed.updated._value}</h1>' +
				'<div class="entries">' +
				'   <tpl for="feed.entry">' +
					'<div class="externalinfo-entry">' +
					'<h3><a href="{link.href}">{title._value}</a></h3>' +
					'{summary._value}' +
					'</div>' +
				'   </tpl>' +
				'</div>' +
				'</div>'
			)
		});
	}


});
Ext.define('App.controller.Labels', {
    extend: 'Ext.app.Controller',
    requires: [
    ],
    refs: [],

    browserHelperCtl: undefined,

    init: function () {
        var me = this;

        me.control({
            '#PatientSummaryImagesPanel': {
                beforerender: me.onPatientSummaryImagesPanelBeforeRender
            }
        });
    },

    onPatientSummaryImagesPanelBeforeRender: function (panel) {

        var me = this;

        panel.addDocked({
            xtype: 'toolbar',
            dock: 'bottom',
            items: [
                // {
                //     xtype: 'button',
                //     text: '2 5/16 x 4',
                //     icon: 'modules/worklist/resources/images/barcode.png',
                //     action: '2.3125-4-5',
                //     flex: 1,
                //     scope: me,
                //     handler: me.onLabelBtnHandler
                // },
                // '-',
                {
                    xtype: 'button',
                    text: 'Postal Label 1 1/8 x 3 1/2',
                    icon: 'modules/worklist/resources/images/barcode.png',
                    action: '1.1250-3.5-1',
                    flex: 1,
                    scope: me,
                    handler: me.onLabelBtnHandler
                }
            ]
        },0);
    },

    onLabelBtnHandler: function (btn) {

        var size = btn.action.split('-'),
            patient_record = btn.up('form').getForm().getRecord(),
            label_data = this.getDemographicsLabelsData(patient_record);

        if(label_data === false){
            app.msg(_('oops'), _('no_order_selected'), true);
            return
        }

        Labels.CreateLabel('patient', label_data, size[0], size[1], 300, function (result) {

            var images = [],
                width = 0,
                height = 0;

            if(width === 0)	width += result.width/3;
            height += result.height/3;
            images.push({
                xtype:'image',
                margin: 2,
                base64data: result.base64data,
                src: ('data:image/jpg;base64,' + result.base64data),
                width: result.width/3,
                height: result.height/3
            });

                height = height + 4;

            width = width + 10;
            height =  height < 250 ? (height + 62) : 350;

            Ext.create('Ext.window.Window', {
                title: _('patient') + ' ' + _('postal_address'),
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                items: images,
                autoScroll: true,
                width: width,
                height: height,
                buttons: [
                    {
                        xtype: 'printerscombo',
                        itemId: 'WorkListOrderPrintersCombo',
                    },
                    '->',
                    {
                        text: _('print'),
                        itemId: 'WorkListOrderPrintBtn'
                    }
                ]
            }).show();

        });
    },

    getDemographicsLabelsData:  function(patient_record){

        if(!patient_record){
            return false;
        }

        var patient_age_yrs = app.calculateAge(app.getDate(), patient_record.get('DOB'));

        say(patient_record);

        return {
            '[PATIENT_NAME]': Ext.String.format('{0}, {1} {2}', patient_record.get('lname'), patient_record.get('fname'), patient_record.get('mname')).trim(),
            '[RECORD_NUMBER]': patient_record.get('pubpid'),
            '[PATIENT_AGE]': (patient_age_yrs + ' yrs'),
            '[PATIENT_SEX]': patient_record.get('sex'),
            '[PATIENT_POSTAL_ADDRESS1]': patient_record.get('postal_address'),
            '[PATIENT_POSTAL_ADDRESS2]': patient_record.get('postal_address_cont'),
            '[PATIENT_POSTAL_CITY]': patient_record.get('postal_city'),
            '[PATIENT_POSTAL_STATE]': patient_record.get('postal_state'),
            '[PATIENT_POSTAL_ZIP]': patient_record.get('postal_zip')
        };

    },

});

Ext.define('App.controller.LogOut', {
    extend: 'Ext.app.Controller',
	requires:[
		'App.ux.ActivityMonitor'
	],
	refs: [
		{
			ref: 'ApplicationLockWindow',
			selector: '#ApplicationLockWindow'
		},
		{
			ref: 'ApplicationLockWindowPingField',
			selector: '#ApplicationLockWindowPingField'
		}
	],

	lockMask: undefined,

	init: function() {
		var me = this;

		/**
		 * in seconds - interval to check for
		 * mouse and keyboard activity
		 */
		me.activityMonitorInterval = 10;
		/**
		 * in minutes - Maximum time application can
		 * be inactive (no mouse or keyboard input)
		 */
		me.activityMonitorMaxInactive = eval(g('timeout'));
		me.activityMonitorMaxLock = eval(g('lockscreen'));

		me.cron = me.getController('Cron');

		me.control({
			'treepanel[action=mainNav]':{
				beforerender: me.onNavigationBeforeRender
			},
			'menuitem[action=logout]':{
				click: me.appLogout
			},
			'#ApplicationLockWindowPingField':{
				keyup: me.onApplicationLockWindowPingFieldKeyUp
			},
			'#ApplicationLockWindowLogoutBtn':{
				click: me.onApplicationLockWindowLogoutBtnClick
			},
			'#ApplicationLockWindowOkBtn':{
				click: me.onApplicationLockWindowOkBtnClick
			}
		});

		window.addEventListener("message", me.receiveMessage, false);

	},

	receiveMessage: function (event) {
    	if(event.data === 'captureActivity'){
		    App.ux.ActivityMonitor.captureActivity();
	    }
	},

	onNavigationBeforeRender:function(treepanel){
		treepanel.getStore().on('load', function(){
			this.ActivityMonitor(true);
		}, this);
	},

	ActivityMonitor:function(start){
		var me = this;

		if(start){
			App.ux.ActivityMonitor.init({
				interval: me.activityMonitorInterval * 1000,
				maxInactive: (1000 * 60 * me.activityMonitorMaxInactive),
				maxLock: (1000 * 60 * me.activityMonitorMaxLock),
				verbose: false,
				controller: me,
				isInactive: function(){
					me.startAutoLogout();
				},
				isLock: function(){
					me.doApplicationLock();
				},
				// isUnLock: function(){
				// 	me.doApplicationUnLock();
				// }
			});
			me.cron.start();
			App.ux.ActivityMonitor.start();
		}else{
			me.cron.stop();
			App.ux.ActivityMonitor.stop();
		}
	},

	cancelAutoLogout: function(){
		var me = this;
		app.el.unmask();
		me.LogoutTask.stop(me.LogoutTaskTimer);
		me.logoutWarinigWindow.destroy();
		delete me.logoutWarinigWindow;
		App.ux.ActivityMonitor.start();
	},

	doApplicationLock: function () {
		this.appMask();
		this.showApplicationLockWindow();
		this.getApplicationLockWindowPingField().focus();
	},

	doApplicationUnLock: function () {
		this.appUnMask();
		this.hideApplicationLockWindow();
	},

	startAutoLogout: function(){
		var me = this;
		me.logoutWarinigWindow = Ext.create('Ext.Container', {
			floating: true,
			cls: 'logout-warning-window',
			html: 'Logging Out in...',
			seconds: 10
		}).show();

		app.el.mask();

		if(!me.LogoutTask)
			me.LogoutTask = new Ext.util.TaskRunner();
		if(!me.LogoutTaskTimer){
			me.LogoutTaskTimer = me.LogoutTask.start({
				scope: me,
				run: me.logoutCounter,
				interval: 1000
			});
		}else{
			me.LogoutTask.start(me.LogoutTaskTimer);
		}
	},

	logoutCounter: function(){
		var me = this, sec = me.logoutWarinigWindow.seconds - 1;
		if(sec <= 0){
			me.logoutWarinigWindow.update('Logging Out... Bye! Bye!');
			me.appLogout(true);
		}else{
			me.logoutWarinigWindow.update('Logging Out in ' + sec + 'sec');
			me.logoutWarinigWindow.seconds = sec;
		}
	},


	doLogout: function(){
		var nav = this.getController('Navigation');
		if(app.patient.pid) Patient.unsetPatient(app.patient.pid);

		if(app.fireEvent('applogut', this) === false) return;

		authProcedures.unAuth(function(){
			nav.navigateTo('App.view.login.Login', null, true);
			window.onbeforeunload = null;
			window.location.reload();
		});

	},

	appLogout: function(force){
		var me = this;

		if(force === true){
			me.ActivityMonitor(false);
			me.doLogout();
		}else{
			Ext.Msg.show({
				title: _('please_confirm') + '...',
				msg: _('are_you_sure_to_quit') + ' mdTimeline?',
				icon: Ext.MessageBox.QUESTION,
				buttons: Ext.Msg.YESNO,
				fn: function(btn){
					if(btn == 'yes'){
						me.doLogout();
					}
				}
			});
		}
	},

	showApplicationLockWindow: function () {
		if(!this.getApplicationLockWindow()){
			Ext.create('App.view.administration.ApplicationLockWindow');
		}
		this.getApplicationLockWindow().setTitle('LOCKED BY: ' + app.user.getFullName());

		return this.getApplicationLockWindow().show();
	},

	hideApplicationLockWindow: function () {
		if(this.getApplicationLockWindow()){
			this.getApplicationLockWindow().close()
		}
	},
	
	appMask: function () {
		var mask = app.el.mask();
		mask.addCls('app-lock-mask');

	},
	
	appUnMask: function () {
		app.el.unmask();
	},

	onApplicationLockWindowLogoutBtnClick: function (btn) {
		this.appLogout();
	},

	onApplicationLockWindowOkBtnClick: function () {
		this.doValidate();
	},

	onApplicationLockWindowPingFieldKeyUp: function (field, e) {
		if(e.getKey() !== e.RETURN) return;
		this.doValidate(field);
	},

	doValidate: function (field) {
		var me = this;

		field = field || me.getApplicationLockWindowPingField();

		if(!field.isValid()) return;

		me.validatePin(field.getValue(), function (user) {
			if(user){
				me.doSwitchUser(user);
			}else {
				app.msg(_('oops'),_('wrong_pin'), true);
				field.reset();
			}
		});
	},

	doSwitchUser: function (user) {

		var me = this,
			params = {
			facility: app.user.facility
		};

		if(app.fireEvent('beforeusersessionswitch', user) === false) return;

		authProcedures.doAuth(params, user, function (session) {
			if(session.user.id != app.user.id){
				app.fireEvent('usersessionswitch', me, session);
			}else{
				me.doApplicationUnLock();
			}
		});
	},

	validatePin: function (pin, callback) {
		User.getUserByPin(pin, function (response) {

			if(response === false){
				callback(false);
			}else{
				callback((response.id == app.user.id || a('allow_user_switch')) ? response : false);
			}


		});
	}

});

Ext.define('App.controller.PrintJob', {
    extend: 'Ext.app.Controller',
    requires: [
        'App.ux.combo.Printers',
        'App.model.administration.PrinterCombo'
    ],
    refs: [
        {
            ref: 'UserTransactionWindow',
            selector: '#UserTransactionWindow'
        },
        {
            selector: '#ApplicationFooterTestDocumentViewerBtn',
            ref: 'ApplicationFooterTestDocumentViewerBtn'
        },
        {
            selector: '#PrintJobsWindow',
            ref: 'PrintJobsWindow'
        },
        {
            selector: '#PrintJobsWindowGird',
            ref: 'PrintJobsWindowGird'
        },
        {
            selector: '#PrintJobsWindowPrintBtn',
            ref: 'PrintJobsWindowPrintBtn'
        },
        {
            selector: '#PrintJobsWindowFromField',
            ref: 'PrintJobsWindowFromField'
        },
        {
            selector: '#PrintJobsWindowToField',
            ref: 'PrintJobsWindowToField'
        },
        {
            selector: '#PrintJobsWindowPriorityChkGroup',
            ref: 'PrintJobsWindowPriorityChkGroup'
        },
        {
            selector: '#PrintJobsWindowStatusChkGroup',
            ref: 'PrintJobsWindowStatusChkGroup'
        },
        {
            selector: '#PrintJobsWindowPrintersCombo',
            ref: 'PrintJobsWindowPrintersCombo'
        },
        {
            selector: '#PrintJobsWindowUserLiveSearch',
            ref: 'PrintJobsWindowUserLiveSearch'
        },
        {
            selector: '#ApplicationFooterDefaultPrinterCmb',
            ref: 'ApplicationFooterDefaultPrinterCmb'
        },
        {
            selector: '#PrintJobsGridContextMenuUsers',
            ref: 'PrintJobsGridContextMenuUsers'
        },
        {
            selector: '#PrintJobsGridContextMenuDetailLog',
            ref: 'PrintJobsGridContextMenuDetailLog'
        },
        {
            selector: '#PrintJobsGridContextMenuDelete',
            ref: 'PrintJobsGridContextMenuDelete'
        },
        {
            selector: '#PrintJobsWindowNumberOfJobCopies',
            ref: 'PrintJobsWindowNumberOfJobCopies'
        }
    ],

    init: function () {
        var me = this;

        me.auditLogCtrl = me.getController('administration.TransactionLog');
        me.usersTransactionWindowCtrl = me.getController('App.controller.administration.UsersTransaction');

        me.control({
            'viewport': {
                printermsg: me.onApplicationPrinterMsg
            },
            '#ApplicationFooterPrintJobsBtn': {
                click: me.onApplicationFooterPrintJobsBtnClick
            },
            '#PrintJobsWindowGird': {
                itemdblclick: me.onPrintJobsWindowGridItemDblClick,
                beforeitemcontextmenu: me.onPrintJobsWindowGridContextMenu,
            },
            '#PrintJobsWindowPrintBtn': {
                click: me.onPrintJobsWindowPrintBtnClick
            },
            '#PrintJobsWindowFromField': {
                change: me.onChangeFilters
            },
            '#PrintJobsWindowToField': {
                change: me.onChangeFilters
            },
            '#PrintJobsWindowPriorityChkGroup': {
                change: me.onChangeFilters
            },
            '#PrintJobsWindowStatusChkGroup': {
                change: me.onChangeFilters
            },
            '#ApplicationFooterTestDocumentViewerBtn': {
                click: me.onApplicationFooterTestDocumentViewerBtnClick
            },
            '#PrintJobsWindowUserLiveSearch': {
                beforerender: me.onPrintJobsWindowUserLiveSearchBeforeRender,
                change: me.onChangeFilters
            },
            '#PrintJobsGridContextMenuUsers': {
                click: me.onPrintJobsGridContextMenuUsersClick
            },
            '#PrintJobsGridContextMenuDetailLog': {
                click: me.onPrintJobsGridContextMenuDetailLogClick
            },
            '#PrintJobsGridContextMenuDelete': {
                click: me.onPrintJobsGridContextMenuDeleteClick
            }
        });

        me.print_job_store = Ext.create('App.store.administration.PrintJob', {
            remoteFilter: true,
            remoteSort: true,
            sorters: [
                {
                    property: 'priority',
                    direction: 'ASC'
                }
            ],
            pageSize: 50
        });

        me.print_task = setInterval(function () {
            me.checkJobsToPrint();
        }, (1000 * 60));
    },

    checkJobsToPrint: function () {
        var me = this,
            is_printjob_window_open = me.getPrintJobsWindow();

        if (is_printjob_window_open) {
            me.print_job_store.reload();
        } else {
            this.print_job_store.each(function (print_job_record) {
                if (print_job_record.get('print_status') === 'QUEUED') {
                    me.doPrintJob(print_job_record);
                }
            });

            this.print_job_store.clearFilter(true);
            this.print_job_store.filter([
                {
                    property: 'uid',
                    value: app.user.id
                },
                {
                    property: 'print_status',
                    value: 'QUEUED'
                },
                {
                    property: 'print_status',
                    value: 'PRINTING'
                },
            ]);
        }
    },

    doPrintJob: function (print_job_record) {

        var me = this,
            printController = app.getController('Print'),
            printers = printController.printers,
            number_of_copies = print_job_record.get('number_of_copies'),
            params = {
                id: print_job_record.get('document_id')
            };

        for (var i = 0; i < printers.length; i++) {

            //* Printer record id is a string and printer_id is an int
            if (printers[i].id == print_job_record.get('printer_id')) {

                var printer_record = Ext.create('App.model.administration.PrinterCombo', printers[i]);

                DocumentHandler.getPatientDocument(params, true, function (patient_document) {
                    if (patient_document === false) {
                        app.msg(_('error'), _('patient_document_not_found'), true);
                        return;
                    }

                    print_job_record.set({print_status: 'PRINTING'});
                    print_job_record.save();

                    for (var i = 0; i < number_of_copies; i++) {
                        printController.doPrint(printer_record, patient_document.document, print_job_record.get('id'), function (printer_response){

                            if(printer_response.success){
                                print_job_record.set({print_status: 'DONE'});
                            }else{
                                print_job_record.set({print_status: 'FAILED'});
                            }
                            print_job_record.save();
                        });
                    }
                });

                break;
            }
        }
    },

    onChangeFilters: function () {

        var me = this,
            from_date_field = me.getPrintJobsWindowFromField(),
            to_date_field = me.getPrintJobsWindowToField(),
            status_checkbox_group = me.getPrintJobsWindowStatusChkGroup(),
            priority_checkbox_group = me.getPrintJobsWindowPriorityChkGroup(),
            from_date = Ext.Date.format(from_date_field.getValue(), 'Y-m-d') + ' 00:00:00',
            to_date = Ext.Date.format(to_date_field.getValue(), 'Y-m-d') + ' 23:59:59',
            status_send = false,
            status_printing = false,
            status_done = false,
            status_waiting = false,
            status_failed = false,
            priority_high = false,
            priority_med = false,
            priority_low = false,
            selected_status_checkboxes = status_checkbox_group.getChecked(),
            selected_priority_checkboxes = priority_checkbox_group.getChecked(),
            user_id = me.getPrintJobsWindowUserLiveSearch().getValue(),
            filters = [];

        say('user_id');
        say(me.getPrintJobsWindowUserLiveSearch());
        say(user_id);

        selected_status_checkboxes.forEach(function (checkbox) {
            switch (checkbox.getName()) {
                case 'status_sended':
                    status_send = true;
                    break;
                case 'status_printing':
                    status_printing = true;
                    break;
                case 'status_waiting':
                    status_waiting = true;
                    break;
                case 'status_done':
                    status_done = true;
                    break;
                case 'status_failed':
                    status_failed = true;
                    break;
            }
        });

        selected_priority_checkboxes.forEach(function (checkbox) {
            switch (checkbox.getName()) {
                case 'priority_high':
                    priority_high = true;
                    break;
                case 'priority_med':
                    priority_med = true;
                    break;
                case 'priority_low':
                    priority_low = true;
                    break;
            }
        });

        filters.push({property: 'create_date', operator: '>=', value: from_date});
        filters.push({property: 'create_date', operator: '<=', value: to_date});

        if (!user_id){
            filters.push({property: 'uid', value: app.user.id});
        } else {
            filters.push({property: 'uid', value: user_id});
        }

        if (status_send) filters.push({property: 'print_status', value: 'QUEUED'});
        if (status_printing) filters.push({property: 'print_status', value: 'PRINTING'});
        if (status_waiting) filters.push({property: 'print_status', value: 'HOLD'});
        if (status_failed) filters.push({property: 'print_status', value: 'FAILED'});
        if (status_done) filters.push({property: 'print_status', value: 'DONE'});
        if (priority_high) filters.push({property: 'priority', value: 1});
        if (priority_med) filters.push({property: 'priority', value: 2});
        if (priority_low) filters.push({property: 'priority', value: 3});

        me.print_job_store.clearFilter(true);
        me.print_job_store.filter(filters);

    },

    onApplicationPrinterMsg: function (msg, data) {
        var me = this,
            print_job_record = me.print_job_store.getById(data.job_id);

        if (print_job_record === null) return;

        print_job_record.set({print_status: data.print_status});
    },

    onPrintJobsWindowPrintBtnClick: function (btn) {
        var me = this,
            window = me.getPrintJobsWindow(),
            grid = me.getPrintJobsWindowGird(),
            printer_combobox = me.getPrintJobsWindowPrintersCombo(),
            printer_id = printer_combobox.getValue(),
            printer_record = printer_combobox.findRecordByValue(printer_id),
            selected_records = grid.getSelectionModel().getSelection();

        if (selected_records.length <= 0) {
            app.msg(_('error'), 'No print jobs selected.', true);
        }

        if (printer_record === false) {
            app.msg(_('error'), 'No printer selected.', true);
        }

        app.msg(_('sending') + '...', selected_records.length.toString() + ' print jobs sent to print.');

        selected_records.forEach(function (print_job_record) {
            print_job_record.set({
                print_status: 'QUEUED',
                printer_id: printer_record.get('id'),
                printer_type: printer_record.get('local') ? 'LOCAL' : 'REMOTE'
            });
            print_job_record.save();

            me.doPrintJob(print_job_record);

            // if (print_job_record.get('print_status') === 'waiting') {
            //     print_job_record.set({
            //         print_status: 'QUEUED',
            //         printer_id: print_job_record.get('printer_id'),
            //         printer_type: printer_record.get('local')
            //     });
            //     me.doPrintJob(print_job_record);
            //     return;
            // }
            //
            // me.addPrintJob(print_job_record.get('document_id'), printer_record, true, print_job_record.get('priority'));
            // me.doPrintJob(print_job_record)
        });

        window.close();
    },

    addPrintJob: function (document_id, printer_record, print_now, priority, number_of_copies) {
        var me = this,
            default_printer_cmb = this.getApplicationFooterDefaultPrinterCmb(),
            default_printer_record =  default_printer_cmb.findRecordByValue(default_printer_cmb.getValue()),
            printer_id,
            printer_type;

        printer_record = printer_record || default_printer_record;
        priority = priority === undefined || priority === null ? 2 : priority;

        if (document_id === null || document_id === 0) {
            app.msg(_('error'), 'Print job could not be added. Document Missing.', true);
            return;
        }

        if (!printer_record) {
            printer_id = null;
            printer_type = 'REMOTE';
        } else {
            printer_id = printer_record.get('id');
            printer_type = printer_record.get('local') ? 'LOCAL' : 'REMOTE';
        }

        // if (printer_record === null || printer_record.get('id') === null) {
        //     app.msg(_('error'), 'Print job could not be added. Printer Missing.', true);
        //     return;
        // }

        if (priority === null || !Number.isInteger(priority)) {
            app.msg(_('error'), 'Print job could not be added. Priority Missing.', true);
            return;
        }

        print_now = print_now && printer_id

        if(!Ext.isNumber(number_of_copies)){
            number_of_copies = 1;
        }

        var print_job_record = me.print_job_store.add({
            uid: app.user.id,
            document_id: document_id,
            printer_id: printer_id,
            printer_type: printer_type,
            print_status: print_now ? 'QUEUED' : 'HOLD',
            priority: priority,
            number_of_copies: number_of_copies,
            create_date: Ext.Date.format(app.getDate(), 'Y-m-d H:i:s')
        })[0];

        say(number_of_copies);
        say(print_job_record);

        print_job_record.save();

        if(print_now){
            me.doPrintJob(print_job_record);
        }
    },

    onApplicationFooterPrintJobsBtnClick: function () {
        this.showPrintJobsWindow();

        this.onChangeFilters();
    },

    showPrintJobsWindow: function (init) {
        if (!this.getPrintJobsWindow()) {
            Ext.create('App.view.administration.PrintJobsWindow');
            var win = this.getPrintJobsWindow().show();
            this.getPrintJobsWindowGird().reconfigure(this.print_job_store);
            return win;
        } else {
            return this.getPrintJobsWindow().show();
        }
    },

    onApplicationFooterTestDocumentViewerBtnClick: function (btn) {
        var me = this,
            params = {
                body: 'test'
            };

        DocumentHandler.createTempDocument(params, function (response) {
            app.getController('DocumentViewer').doDocumentView(response.id, response.document_name);
        })
    },

    onPrintJobsWindowUserLiveSearchBeforeRender: function (cmb){
        var me = this,
            allow_to_see_other_print_jobs = true; //TODO: Check for permission

        if(!allow_to_see_other_print_jobs){
            cmb.setVisible(false);
        }
    },

    onPrintJobsWindowGridItemDblClick: function (grid, record, item, index){
        var me = this,
            document_id = record.get('document_id');

        app.getController('DocumentViewer').doDocumentView(document_id);
    },

    onPrintJobsWindowGridContextMenu: function (print_jobs_grid, print_jobs_record, item, index, e){
        e.preventDefault();

        this.showPrintJobsWindowGridContextMenu(print_jobs_grid, print_jobs_record, e)
    },

    showPrintJobsWindowGridContextMenu: function(print_jobs_grid, print_jobs_record, e) {
        // if (!a('access_patient_notes_transaction_log')) return;

        var me = this;

        me.PrintJobsGridContextMenu = Ext.widget('menu', {
            margin: '0 0 10 0',
            items: [
                {
                    text: _('users'),
                    icon: 'modules/billing/resources/images/user_16.png',
                    itemId: 'PrintJobsGridContextMenuUsers',
                    acl: true
                },
                {
                    xtype: 'menuseparator'
                },
                {
                    text: _('transaction_log'),
                    icon: 'modules/billing/resources/images/icoList.png',
                    itemId: 'PrintJobsGridContextMenuDetailLog',
                    acl: true
                },
                {
                    xtype: 'menuseparator'
                },
                {
                    text: _('delete_selected'),
                    icon: 'modules/billing/resources/images/cross.png',
                    itemId: 'PrintJobsGridContextMenuDelete',
                    acl: true
                }
            ]
        });

        me.PrintJobsGridContextMenu.print_jobs_grid = print_jobs_grid;
        me.PrintJobsGridContextMenu.print_jobs_record = print_jobs_record;

        me.PrintJobsGridContextMenu.showAt(e.getXY());

        return me.PrintJobsGridContextMenu;
    },

    onPrintJobsGridContextMenuUsersClick: function(btn) {
        var me = this,
            print_jobs_record = btn.parentMenu.print_jobs_record,
            user_username = print_jobs_record.get('user_username'),
            create_date = print_jobs_record.get('create_date'),
            update_date = print_jobs_record.get('update_date');

        if(!me.getUserTransactionWindow()){
            Ext.create('App.view.administration.UserTransactionWindow');
        }

        me.getUserTransactionWindow().user_username = user_username;
        me.getUserTransactionWindow().create_date = create_date;
        me.getUserTransactionWindow().update_date = update_date;

        me.getUserTransactionWindow().show();
    },

    onPrintJobsGridContextMenuDetailLogClick: function(btn) {
        var me = this,
            print_jobs_record = btn.parentMenu.print_jobs_record;

        this.auditLogCtrl.doTransactionLogDetailByTableAndPk(print_jobs_record.table.name, print_jobs_record.get('id'));
    },

    onPrintJobsGridContextMenuDeleteClick: function(btn) {
        var me = this,
            print_job_grid = this.getPrintJobsWindowGird(),
            print_job_store = print_job_grid.getStore(),
            print_job_selected_rows = print_job_grid.getSelectionModel().getSelection();

        if (print_job_selected_rows.length) {
            print_job_store.remove(print_job_selected_rows);

            print_job_store.sync({
                callback: function (){
                    app.msg(_('sweet'), _('records_removed'));
                }
            });
        }
    }
});

Ext.define('App.controller.Print', {
    extend: 'Ext.app.Controller',
    requires: [
        'App.ux.combo.Printers'
    ],
    refs: [],

    printers: [],

    browserHelperCtl: undefined,

    init: function () {
        var me = this;

        me.control({
            'viewport': {
                browserhelperopen: me.onBrowserHelperOpen
            },
            'printerscombo': {
                render: me.onPrintersComboBeforeRender
            }
        });

        me.printJobCtl = this.getController('PrintJob');

        me.loadRemotePrinters();

    },

    doPrint: function (printer_record, document_base64, job_id, callback) {
        var me = this;

        if (printer_record.get('local')) {
            if (!me.browserHelperCtl) {
                app.msg(_('oops'), _('no_browser_helper_found'), true);
                return;
            }

            job_id = job_id || "0";

            me.browserHelperCtl.send(JSON.stringify({
                action: 'print',
                printer: printer_record.get('id'),
                payload: document_base64,
                job_id: job_id
            }), function (response) {
                if (!response.success) {
                    app.msg(_('oops'), 'Document could not be printed', true);
                }
                if(callback) callback(response);
            });

        } else {
            Printer.doPrint(printer_record.get('id'), document_base64, job_id, function (response){
                if(callback) callback(response);
            });
        }
    },

    addPrintJob: function (document_id, printer_record, print_now, priority) {
        var me = this;
        me.printJobCtl.addPrintJob(document_id, printer_record, print_now, priority);
    },

    loadRemotePrinters: function () {
        var me = this;

        Printer.getPrinters(function (printers) {
            me.printers = Ext.Array.merge(me.printers, printers);
            var rendered_printer_combos = Ext.ComponentQuery.query('printerscombo[rendered]');
            rendered_printer_combos.forEach(function (rendered_printer_combo){
                rendered_printer_combo.store.loadData(me.printers);
                rendered_printer_combo.showPrintersByFacility();
                rendered_printer_combo.setValue(rendered_printer_combo.getValue());
            });
        });
    },

    onBrowserHelperOpen: function (ctl) {
        var me = this;

        me.browserHelperCtl = ctl;

        me.browserHelperCtl.send('{"action":"printer/list"}', function (printers) {
            //Add local property to each printer
            for (var i = 0; i < printers.length; i++) {
                printers[i].local = true;
            }

            me.printers = Ext.Array.merge(me.printers, printers);

            var rendered_printer_combos = Ext.ComponentQuery.query('printerscombo[rendered]');
            rendered_printer_combos.forEach(function (rendered_printer_combo){
                rendered_printer_combo.store.loadData(me.printers);
                rendered_printer_combo.showPrintersByFacility();
                rendered_printer_combo.setValue(rendered_printer_combo.getValue());
            });

        });

    },

    onPrintersComboBeforeRender: function (cmb) {
        say(this.printers);
        cmb.store.loadData(this.printers);

        //register combobox to change when facility changes
        app.on('appfacilitychanged', function () {
            cmb.showPrintersByFacility();
            // if (cmb.store.getCount() > 0) {
            //     cmb.setValue(cmb.store.first());
            // } else {
            //     cmb.setValue(null);
            // }
        });

        //filter printers by facility and local
        cmb.showPrintersByFacility();

        if (cmb.store.find('id', cmb.getValue()) === cmb.getValue()) {
            // fix to stateful not selecting
            // cmb.setValue(cmb.getValue());
        } else {
            // cmb.store.getCount() > 0 ? cmb.setValue(cmb.store.first()) : cmb.setValue(null);
        }

    },

    getPrinters: function () {
        var me = this;

        return me.printers;
    },

    promptPrint: function () {

    }


});

Ext.define('App.controller.Support', {
    extend: 'Ext.app.Controller',
	requires:[
		'App.ux.ManagedIframe'
	],
	refs: [
        {
            ref:'viewport',
            selector:'viewport'
        }
	],

	init: function() {
		var me = this;
		me.control({
			'button[action=supportBtn]':{
				click: me.supportBtnClick
			}
		});

	},

	supportBtnClick: function(btn){
		var me = this;

		window.open(btn.src, '_blank');

		// me.getSupportWindow();
		// me.winSupport.remove(me.miframe);
		// me.winSupport.add(
		// 	me.miframe = Ext.create('App.ux.ManagedIframe',{src: btn.src})
		// );
	},

	getSupportWindow:function(){
		var me = this;

		if(me.winSupport){
			me.winSupport.show();
		}else{
			me.winSupport = Ext.create('Ext.window.Window', {
				title: _('support'),
				closeAction: 'hide',
				bodyStyle: 'background-color: #ffffff; padding: 5px;',
				animateTarget: me.Footer,
				resizable: false,
				draggable: false,
				maximizable: false,
				autoScroll: true,
				maximized: true,
				dockedItems: {
					xtype: 'toolbar',
					dock: 'top',
					items: ['-', {
						text: 'List issues',
						iconCls: 'list',
						action: 'supportBtn',
						url: 'http://GaiaEHR.org/projects/GaiaEHR001/issues'
					}, '-', {
						text: 'Create an issue',
						iconCls: 'icoAddRecord',
						action: 'supportBtn',
						url: 'http://GaiaEHR.org/projects/GaiaEHR001/issues/new'
					}]
				}
			});
			me.winSupport.show();
		}


	}

});

Ext.define('App.controller.ScriptCam', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'webCamWindow',
			selector: 'scriptcamwindow'
		},
		{
			ref: 'ScriptCamCameras',
			selector: 'combobox[action=ScriptCamCameras]'
		}
		//        {
		//            ref:'photoIdImage',
		//            selector:'image[action=photoIdImage]'
		//        }
	],

	init: function(){
		var me = this;

		me.userMedia = null;


		me.control({
//			'scriptcamwindow': {
//				render: me.onWebCamWindowRender
//			},
//			'image': {
//				render: me.onImageRender
//			},
			'button[action=onWebCam]': {
				click: me.onWebCamClick
			},
			'button[action=onCaptureImage]': {
				click: me.onCapture
			}
		})
	},

//	onImageRender: function(img){
//		img.el.on('click', function(e, el){
//			Ext.widget('window', {
//				html: '<img src="' + img.src + '">'
//			}).show();
//		});
//	},

	onWebCamClick: function(btn){
		var me = this;

		me.action = btn.up('panel').action;
		me.imgPanel = btn.up('panel');

//		if(me.action == 'patientImage'){
//			me.width = 480;
//			me.height = 480;
//		}else{
//			me.width = 595;
//			me.height = 360;
//		}

		navigator.getMedia = ( navigator.getUserMedia ||
			navigator.webkitGetUserMedia ||
			navigator.mozGetUserMedia ||
			navigator.msGetUserMedia);

		me.media = navigator.getMedia({
			video: true,
			audio: false
		}, me.onConnect, me.onError);
	},

	onConnect: function(stream, b, c){

		var me = app.getController('ScriptCam');

		me.win = Ext.create('Ext.window.Window', {
			title: '...',
			html: ('<video id="WebCamVideo" width="640" height="480"></video>'),
			autoShow: true,
			buttons: [
				'->',
				{
					text: _('capture_img'),
					action: 'onCaptureImage'
				}
			],
			listeners: {
				close: function(){
					//stream.active = false;
					stream.getTracks().forEach(function(track) {
						if (track.readyState == 'live') {
							track.stop();
						}
					});
				}
			}
		});

		me.video = document.getElementById('WebCamVideo');

		try {
			me.video.srcObject = stream;
		} catch (error) {
			me.video.src = window.URL.createObjectURL(stream);
		}
		me.video.play();
	},

	onError: function(error){
		say(error);
	},

	onCapture: function(){
		var me = this,
			canvas = document.createElement('canvas'),
			ctx = canvas.getContext('2d'),
			imgCmp = me.imgPanel.down('image'),
			field = me.imgPanel.down('textareafield'),
			dataURL;

		canvas.width = me.video.videoWidth / 4;
		canvas.height = me.video.videoHeight / 4;
		ctx.drawImage(me.video, 0, 0, canvas.width, canvas.height);
		dataURL = canvas.toDataURL();
		canvas.remove();
		imgCmp.setSrc(dataURL);
		field.setValue(dataURL);
		me.win.close();
	}
});
Ext.define('App.controller.Upload', {
	extend: 'Ext.app.Controller',
	requires: [
		// 'App.view.scanner.Window',
		// 'App.view.patient.windows.ArchiveDocument'
	],
	refs: [
		{
			ref: 'UploadDocumentWindow',
			selector: '#UploadDocumentWindow'
		},
		// {
		// 	ref: 'ScannerImageThumbsDataView',
		// 	selector: '#ScannerImageThumbsDataView'
		// },
		// {
		// 	ref: 'ScannerImageViewer',
		// 	selector: '#ScannerImageViewer'
		// },
		// {
		// 	ref: 'ScannerImageViewerPanelImage',
		// 	selector: '#ScannerImageViewerPanel image'
		// },
		// {
		// 	ref: 'ScannerSourceCombo',
		// 	selector: '#ScannerSourceCombo'
		// },
		// {
		// 	ref: 'ScannerImageScanBtn',
		// 	selector: '#ScannerImageScanBtn'
		// },
		// {
		// 	ref: 'ScannerImageScanBtn',
		// 	selector: '#ScannerImageScanBtn'
		// },
		// {
		// 	ref: 'ScannerImageArchiveBtn',
		// 	selector: '#ScannerImageArchiveBtn'
		// }
	],

	init: function(){
		var me = this;

		me.documents_defautls = {};

		me.control({
			'#UploadDocumentWindow': {
				show: me.onUploadDocumentWindowShow,
				close: me.onUploadDocumentWindowClose
			},
			'#UploadCancelBtn': {
				click: me.onUploadCancelBtnClick
			},
			'#UploadSaveBtn': {
				click: me.onUploadSaveBtnClick
			}
		});

	},

	onUploadDocumentWindowShow: function (win) {
		if(win.default_values){
			win.down('form').getForm().setValues(win.default_values);
		}
	},

	onUploadDocumentWindowClose: function () {

	},

	showUploadWindow: function(default_values){

		if(!this.getUploadDocumentWindow()){
			Ext.create('App.view.upload.UploadDocumentWindow');
		}
		this.getUploadDocumentWindow().default_values = default_values;
		return this.getUploadDocumentWindow().show();
	},

	onUploadCancelBtnClick: function(){
		this.getUploadDocumentWindow().close();
	},

	onUploadSaveBtnClick: function(){
		var me = this,
			win = me.getUploadDocumentWindow(),
			form = win.down('form').getForm(),
			record = Ext.create('App.model.patient.PatientDocuments'),
			values = form.getValues(),
			reader = new FileReader(),
			docTypeCodeField = form.findField('docTypeCode'),
			uploadField = form.findField('document');

		if(!form.isValid()) return;

		values.date =  new Date();
		values.pubpid =  app.patient.pubpid;
		values.pid =  app.patient.pid;
		values.eid =  app.patient.eid;
		values.uid =  app.user.id;
		values.facility_id =  app.user.facility;
		values.global_id = app.uuidv4();

		var docTypeRecord = docTypeCodeField.findRecordByValue(values.docTypeCode);
		if(docTypeRecord){
			values.docType = docTypeRecord.get('option_name');
		}

		record.set(values);

		reader.onload = function(e){
			record.set({document: e.target.result});

			if(app.fireEvent('beforeuploaddocumentssave', this, [record]) === false) return;

			record.save({
				success: function () {
					app.fireEvent('uploaddocumentssave', this, [record]);
					win.close();
				}
			});


		};
		reader.readAsDataURL(uploadField.extractFileInput().files[0]);

	}
});

Ext.define('App.controller.patient.Alerts', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'AlertsAddBtn',
			selector: '#AlertsAddBtn'
		},
		{
			ref: 'PatientSummaryAlertsPanel',
			selector: '#PatientSummaryAlertsPanel'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				encounterload: me.onEncounterOpen,
				patientset: me.onPatientSet
			},
			'#PatientSummaryAlertsPanel': {
				activate: me.onPatientSummaryAlertsPanelActivate
			},
			'#AlertsAddBtn': {
				click: me.onAlertsAddBtnClick
			},
			'#AlertsAlertOkBtn': {
				click: me.onAlertsAlertOkBtnClick
			},
			'#AlertsAlertCancelBtn': {
				click: me.onAlertsAlertCancelBtnClick
			}
		});
	},

	onPatientSummaryAlertsPanelActivate: function(){
		this.getPatientSummaryAlertsPanel().getStore().load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			]
		});
	},

	onAlertsAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.store;

		grid.plugins[0].cancelEdit();
		store.insert(0, {
			date: new Date(),
			pid: app.patient.pid,
			uid: app.user.id,
			eid: app.patient.eid
		});
		grid.plugins[0].startEdit(0, 0);
	},

	onAlertsAlertOkBtnClick: function(btn){
		var win = btn.up('window'),
			store = win.down('grid').getStore();

		store.sync();
		win.close();
	},

	onAlertsAlertCancelBtnClick: function(btn){
		var win = btn.up('window'),
			store = win.down('grid').getStore();

		store.rejectChanges();
		win.close();
	},

	onPatientSet: function(patient){
		this.getPatientAlerts('Administrative', patient.pid);
	},

	onEncounterOpen: function(encounterRecord){
		this.getPatientAlerts('Clinical', encounterRecord.data.pid);
	},

	getPatientAlerts: function(type, pid){
		var me = this,
			action = 'RemindersAlertWindow' + type,
			query = Ext.ComponentQuery.query('window[action=' + action + ']'),
			store,
			win;

		if(query.length === 0){
			win = Ext.create('App.view.patient.AlertWindow',{
				title: _('alerts') + ' (' + _(type.toLowerCase()) + ')',
				action: action
			});
		}else{
			win = query[0];
		}

		store = win.down('grid').getStore();
		win.close();
		store.load({
			filters: [
				{
					property: 'pid',
					value: pid
				},
				{
					property: 'type',
					value: type
				},
				{
					property: 'active',
					value: true
				}
			],
			callback: function(records){
				if(records.length > 0){
					me.playSound();
					win.show();
				}
			}
		});
	},

	playSound: function(){
		if(!this.alertAudio){
			this.alertAudio = Ext.core.DomHelper.append(Ext.getBody(), {
				html: '<audio autoplay id="reminderAlert" ><source src="resources/audio/sweetalertsound4.wav" type="audio/wav"></audio>'
			}, true);
		}else{
			this.alertAudio.dom.firstChild.currentTime=0;
			this.alertAudio.dom.firstChild.play();
		}
	}

});
Ext.define('App.controller.patient.AdvanceDirectives', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'AdvanceDirectiveGridPanel',
			selector: 'patientadvancedirectivepanel'
		},
		{
			ref: 'AdvanceDirectiveAddBtn',
			selector: '#AdvanceDirectiveAddBtn'
		},
		{
			ref: 'AdvanceDirectiveReviewBtn',
			selector: '#AdvanceDirectiveReviewBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientadvancedirectivepanel':{
				activate: me.onAdvanceDirectiveGridPanelActivate
			},
			'#AdvanceDirectiveAddBtn':{
				click: me.onAdvanceDirectiveAddBtnClick
			},
			'#AdvanceDirectiveReviewBtn':{
				click: me.onAdvanceDirectiveReviewBtnClick
			}
		});
	},

	onAdvanceDirectiveGridPanelActivate: function(grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onAdvanceDirectiveAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		var records = store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_date: new Date(),
			created_uid: app.user.id,
			start_date: new Date(),
			verified_date: new Date(),
			verified_uid: app.user.id
		});
		grid.editingPlugin.startEdit(records[0], 0);
	},

	onAdvanceDirectiveReviewBtnClick: function(btn){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_advance_directives: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	}

});
Ext.define('App.controller.Theme', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'viewport',
			selector: 'viewport'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#AppThemeSwitcher': {
				click: me.onAppThemeSwitcherClick,
				beforerender: me.onAppThemeSwitcherBeforeRender
			}
		});

	},

	onAppThemeSwitcherBeforeRender: function(btn){

		btn.action = g('mdtimeline_theme');
		btn.setText(btn.action == 'dark' ? _('light_theme') : _('dark_theme'));

		// say('onAppThemeSwitcherBeforeRender');
		// say(btn.action);
	},

	onAppThemeSwitcherClick: function(btn){

		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('theme_change_warning'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(answer){
				if(answer == 'yes'){
					if(btn.action == 'dark'){
						me.goLight(btn);
					}else{
						me.goDark(btn);
					}
				}
			}
		});
	},

	goLight: function(btn){
		btn.action = 'light';
		Ext.util.Cookies.set('mdtimeline_theme', 'light', Ext.Date.add(new Date(), Ext.Date.YEAR, 5));
		window.location.reload();
	},

	goDark: function(btn){
		btn.action = 'dark';
		Ext.util.Cookies.set('mdtimeline_theme', 'dark', Ext.Date.add(new Date(), Ext.Date.YEAR, 5));
		window.location.reload();
	}

});

Ext.define('App.controller.patient.ActiveProblems', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'ActiveProblemsGrid',
			selector: 'patientactiveproblemspanel'
		},
		{
			ref: 'ActiveProblemLiveSearch',
			selector: '#activeProblemLiveSearch'
		},
		{
			ref: 'AddActiveProblemBtn',
			selector: 'patientactiveproblemspanel #addActiveProblemBtn'
		},
        {
            ref: 'PatientProblemsReconciledBtn',
            selector: '#PatientProblemsReconciledBtn'
        },
        {
            ref: 'PatientProblemsActiveBtn',
            selector: '#PatientProblemsActiveBtn'
        },
        {
            ref: 'EncounterPanel',
            selector: '#encounterPanel'
        },
        {
            ref: 'ActiveProblemsReviewBtn',
            selector: '#ActiveProblemsReviewBtn'
        }
	],

	init: function(){
		var me = this;
		me.control({
			'patientactiveproblemspanel':{
				activate: me.onActiveProblemsGridActive,
				beforeitemcontextmenu: me.onActiveProblemsGridBeforeItemContextMenu
			},
			'#activeProblemLiveSearch':{
				select: me.onActiveProblemLiveSearchSelect
			},
			'#ActiveProblemStatusCombo':{
				select: me.onActiveProblemStatusComboSelect
			},
			'#ActiveProblemTypeCmb':{
				select: me.onActiveProblemTypeCmbSelect
			},
			'patientactiveproblemspanel #addActiveProblemBtn':{
				click: me.onAddActiveProblemBtnClick
			},
            '#PatientProblemsReconciledBtn': {
                click: me.onPatientProblemsReconciledBtnClick
            },
            '#PatientProblemsActiveBtn': {
                click: me.onPatientProblemsActiveBtnClick
            },
			'#ActiveProblemsGridActivateMenu': {
				click: me.onActiveProblemsGridActivateMenuClick
			},
			'#ActiveProblemsGridInactivateMenu': {
				click: me.onActiveProblemsGridInactivateMenu
			},
			'#ActiveProblemsReviewBtn': {
				click: me.onActiveProblemsReviewBtnClick
			}
		});


		me.encController = me.getController('patient.encounter.Encounter');
	},

	onActiveProblemsGridBeforeItemContextMenu: function (grid, record, item, index, e, eOpts){
		e.preventDefault();
		this.showContextMenu(grid, record, e);
	},

	showContextMenu: function (grid, record, e){
		if(!grid.context_menu){
			grid.context_menu = Ext.widget('menu', {
				margin: '0 0 10 0',
				items: [
					{
						text: _('activate'),
						itemId: 'ActiveProblemsGridActivateMenu'
					},
					{
						text: _('inactivate'),
						itemId: 'ActiveProblemsGridInactivateMenu'
					}
				]
			});
		}
		grid.context_menu.record = record;
		grid.context_menu.showAt(e.getXY())
	},

	onActiveProblemsGridActivateMenuClick: function (item){
		var record = item.up('menu').record;

		record.set({
			status: 'Active',
			status_code: '55561003',
			status_code_type: 'SNOMEDCT',
			end_date: null
		});

		record.store.sync();
	},

	onActiveProblemsGridInactivateMenu: function (item){
		var record = item.up('menu').record;

		record.set({
			status: 'Inactive',
			status_code: '73425007',
			status_code_type: 'SNOMEDCT',
			end_date: app.getDate()
		});

		record.store.sync();
	},

	onAddActiveProblemBtnClick:function(){
		var me = this,
			grid = me.getActiveProblemsGrid(),
			store = grid.getStore(),
			encounter_record = me.encController.getEncounterRecord(),
			begin_date = encounter_record ? encounter_record.get('service_date') : app.getDate();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			status: 'Active',
			status_code: '55561003',
			status_code_type: 'SNOMEDCT',
			created_uid: app.user.id,
			create_date: app.getDate(),
			begin_date: begin_date
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onActiveProblemsReviewBtnClick:function(btn){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_active_problems: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	},

    onPatientProblemsReconciledBtnClick: function(){
        this.onActiveProblemsGridActive();
    },

    onPatientProblemsActiveBtnClick: function(){
        this.onActiveProblemsGridActive();
    },

	onActiveProblemsGridActive:function(){
		var grid = this.getActiveProblemsGrid(),
            store = grid.getStore(),
            reconciled = this.getPatientProblemsReconciledBtn().pressed,
            onlyActive = this.getPatientProblemsActiveBtn().pressed,
			filters = [
				{
					property: 'pid',
					value: app.patient.pid
				}
			];

		if(onlyActive){
			Ext.Array.push(filters, {
				property: 'status_code',
				value: '55561003'
			});
		}

		store.clearFilter(true);
        store.load({
            filters: filters,
            params: {
                reconciled: reconciled
            }
        });
	},

	onActiveProblemLiveSearchSelect:function(cmb, records){
		var form = cmb.up('form').getForm(),
			record = form.getRecord();

		if(cmb.xtype === 'liveicdxsearch'){
			record.set({
				code: records[0].data.code,
				code_type: records[0].data.code_type
			});
		}else{
			record.set({
				code: records[0].data.ConceptId,
				code_type: records[0].data.CodeType
			});
		}


	},

	onActiveProblemStatusComboSelect:function(cmb, records){
		var form = cmb.up('form').getForm(),
			record = form.getRecord();

		record.set({
			status: records[0].data.option_name,
			status_code: records[0].data.code,
			status_code_type: records[0].data.code_type
		});
	},

	onActiveProblemTypeCmbSelect:function(cmb, records){
		var form = cmb.up('form').getForm(),
			record = form.getRecord();

		record.set({
			problem_type: records[0].data.option_name,
			problem_type_code: records[0].data.code,
			problem_type_code_type: records[0].data.code_type
		});
	}

});

Ext.define('App.controller.patient.Allergies', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'AllergiesGrid',
			selector: 'patientallergiespanel'
		},
		{
			ref: 'AddAllergyBtn',
			selector: 'patientallergiespanel #addAllergyBtn'
		},
		{
			ref: 'ReviewAllergiesBtn',
			selector: 'patientallergiespanel #reviewAllergiesBtn'
		},
		{
			ref: 'ActiveAllergyBtn',
			selector: 'patientallergiespanel #activeAllergyBtn'
		},
		{
			ref: 'PatientAllergyReconciledBtn',
			selector: '#PatientAllergyReconciledBtn'
		},
		{
			ref: 'AllergyCombo',
			selector: '#allergyCombo'
		},
		{
			ref: 'AllergyTypesCombo',
			selector: '#allergyTypesCombo'
		},
		{
			ref: 'AllergySearchCombo',
			selector: '#allergySearchCombo'
		},
		{
			ref: 'AllergyMedicationCombo',
			selector: '#allergyMedicationCombo'
		},
		{
			ref: 'allergyCvxLiveSearch',
			selector: '#allergyCvxLiveSearch'
		},
		{
			ref: 'AllergyFoodCombo',
			selector: '#allergyFoodCombo'
		},
		{
			ref: 'AllergyMetalCombo',
			selector: '#allergyMetalCombo'
		},
		{
			ref: 'AllergyReactionCombo',
			selector: '#allergyReactionCombo'
		},
		{
			ref: 'AllergySeverityCombo',
			selector: '#allergySeverityCombo'
		},
		{
			ref: 'AllergyLocationCombo',
			selector: '#allergyLocationCombo'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientallergiespanel': {
				activate: me.onAllergiesGridActivate,
                beforeedit: me.onAllergiesGridBeforeEdit,
				beforeitemcontextmenu: me.onAllergiesGridBeforeItemContextMenu
			},
			'patientallergiespanel #addAllergyBtn': {
				click: me.onAddAllergyBtnClick
			},
			'patientallergiespanel #activeAllergyBtn': {
				toggle: me.onActiveAllergyBtnToggle
			},
			'patientallergiespanel #PatientAllergyReconciledBtn': {
				toggle: me.onPatientAllergyReconciledBtnToggle
			},
			'patientallergiespanel #reviewAllergiesBtn': {
				click: me.onReviewAllergiesBtnClick
			},
			'#allergyTypeCombo': {
				select: me.onAllergyTypeComboSelect
			},
			'#allergyMedicationCombo': {
				select: me.onAllergyLiveSearchSelect
			},
			'#allergyCvxLiveSearch': {
				select: me.onAllergyCvxLiveSearchSelect
			},
			'#allergyMetalCombo': {
				select: me.onAllergyMetalComboSelect
			},
			'#allergyFoodCombo': {
				select: me.onAllergyFoodComboSelect
			},
			'#allergySearchCombo': {
				select: me.onAllergySearchComboSelect
			},
			'#allergyLocationCombo': {
				change: me.onAllergyLocationComboChange
			},
			'#allergyReactionCombo': {
				select: me.onAllergyReactionComboSelect
			},
			'#allergySeverityCombo': {
				select: me.onAllergySeverityComboSelect
			},
			'#allergyStatusCombo': {
				select: me.onAllergyStatusComboSelect
			},
			'#AllergiesGridActivateMenu': {
				click: me.onAllergiesGridActivateMenuClick
			},
			'#AllergiesGridInactivateMenu': {
				click: me.onAllergiesGridInactivateMenu
			}
		});
	},

	onAllergySearchComboSelect:function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({
			allergy_code: records[0].data.allergy_code,
			allergy_code_type: records[0].data.allergy_code_type
		});
	},

	onAllergyReactionComboSelect:function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({
			reaction_code: records[0].data.code,
			reaction_code_type: records[0].data.code_type
		});
	},

	onAllergySeverityComboSelect:function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({
			severity_code: records[0].data.code,
			severity_code_type: records[0].data.code_type
		});
	},

	onAllergyStatusComboSelect:function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			status_code: records[0].data.code,
			status_code_type: records[0].data.code_type
		});
	},

	onAllergyLiveSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm();

		form.getRecord().set({
			allergy: records[0].data.STR,
			allergy_code: records[0].data.RXCUI,
			allergy_code_type: records[0].data.CodeType
		});
	},

	onAllergyCvxLiveSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm();

		form.getRecord().set({
			allergy: records[0].data.name,
			allergy_code: records[0].data.cvx_code,
			allergy_code_type: 'CVX'
		});
	},

	onAllergyMetalComboSelect: function(cmb, records){
		var form = cmb.up('form').getForm();

		form.getRecord().set({
			allergy: records[0].get('Term'),
			allergy_code: records[0].get('ConceptId'),
			allergy_code_type: records[0].get('CodeType')
		});
	},

	onAllergyFoodComboSelect: function (cmb, records) {
		var form = cmb.up('form').getForm();

		form.getRecord().set({
			allergy: records[0].get('option_name'),
			allergy_code: records[0].get('code'),
			allergy_code_type: records[0].get('code_type')
		});
	},

	onAllergyTypeComboSelect: function(combo, records){

		var me = this,
			record = records[0],
			code = record.data.code,
			isDrug = (code === '419511003' || code === '416098002' || code === '59037007'),
			isFood = (code === '414285001' || code === '235719002' || code === '418471000'),
			isMetal = code === '300915004',
			isDrugCvx = isDrug && record.data.option_value.search(/vaccine/i) !== -1,
			isElse = !isDrug && !isMetal && !isFood;

		// if is CVX can not be Drug
		// this is here because a Vaccine is a drug but not for this purpose
		if(isDrugCvx){
			isDrug = false;
		}

		me.getAllergyMedicationCombo().setVisible(isDrug);
		me.getAllergyMedicationCombo().setDisabled(!isDrug);

		me.getAllergyCvxLiveSearch().setVisible(isDrugCvx);
		me.getAllergyCvxLiveSearch().setDisabled(!isDrugCvx);

		me.getAllergyMetalCombo().setVisible(isMetal);
		me.getAllergyMetalCombo().setDisabled(!isMetal);

		me.getAllergyFoodCombo().setVisible(isFood);
		me.getAllergyFoodCombo().setDisabled(!isFood);

		me.getAllergySearchCombo().setVisible(isElse);
		me.getAllergySearchCombo().setDisabled(!isElse);

		if(isDrug){
			me.getAllergyMedicationCombo().reset();
		}else if(isDrugCvx) {
			me.getAllergyCvxLiveSearch().reset();
		}else if(isMetal) {
			me.getAllergyMedicationCombo().reset();
		}else if(isFood) {
			me.getAllergyFoodCombo().reset();
		}else{
			me.getAllergySearchCombo().store.load();
		}

		combo.up('form').getForm().getRecord().set({
			allergy_type_code: record.data.code,
			allergy_type_code_type: record.data.code_type
		});
	},

	onAllergyLocationComboChange: function(combo, record){
		var me = this,
			list,
			value = combo.getValue();

		if(value == 'Skin'){
			list = 80;
		}else if(value == 'Local'){
			list = 81;
		}else if(value == 'Abdominal'){
			list = 82;
		}else if(value == 'Systemic / Anaphylactic'){
			list = 83;
		}

		me.getAllergyReactionCombo().getStore().load({
			params: {
				list_id: list
			}
		});
	},

	onAllergiesGridBeforeItemContextMenu: function (grid, record, item, index, e, eOpts){
		e.preventDefault();
		this.showContextMenu(grid, record, e);
	},

	showContextMenu: function (grid, record, e){
		if(!grid.context_menu){
			grid.context_menu = Ext.widget('menu', {
				margin: '0 0 10 0',
				items: [
					{
						text: _('activate'),
						itemId: 'AllergiesGridActivateMenu'
					},
					{
						text: _('inactivate'),
						itemId: 'AllergiesGridInactivateMenu'
					}
				]
			});
		}
		grid.context_menu.record = record;
		grid.context_menu.showAt(e.getXY())
	},

	onAllergiesGridActivateMenuClick: function (item){
		var record = item.up('menu').record;

		record.set({
			status: 'Active',
			status_code: '55561003',
			status_code_type: 'SNOMEDCT',
			end_date: null
		});

		record.store.sync();
	},

	onAllergiesGridInactivateMenu: function (item){
		var record = item.up('menu').record;

		record.set({
			status: 'Inactive',
			status_code: '73425007',
			status_code_type: 'SNOMEDCT',
			end_date: app.getDate()
		});

		record.store.sync();
	},

    /**
     * When a row is selected, it will look for the RowEditor plugin and get the form, then set the apropreate COMBO
     * for the Allergy, if it is a RxNorm medication or from the Allergy Combo. Finally set it's original value.
     * @param plugin
     * @param context
     */
    onAllergiesGridBeforeEdit: function(plugin, context){
        var RowForm = plugin.editor.editingPlugin.getEditor(),
            AllergyMedicationCombo = RowForm.query('#allergyMedicationCombo')[0],
            AllergyMetalCombo = RowForm.query('#allergyMetalCombo')[0],
            AllergySearchCombo = RowForm.query('#allergySearchCombo')[0],
	        AllergyFoodCombo = RowForm.query('#allergyFoodCombo')[0],
			AllergyCvxLiveSearch = RowForm.query('#allergyCvxLiveSearch')[0],
	        allergy_type_code = context.record.get('allergy_type_code'),
			allergy_type = context.record.get('allergy_type'),
	        isDrug = (allergy_type_code === '419511003' || allergy_type_code === '416098002' || allergy_type_code === '59037007'),
	        isMetal = allergy_type_code === '300915004',
	        isFood = allergy_type_code === '414285001' || allergy_type_code === '235719002' || allergy_type_code === '418471000',
			isDrugCvx = isDrug && allergy_type.search(/vaccine/i) !== -1,
	        isElse = !isDrug && !isMetal && !isFood;

		// if is CVX can not be Drug
		// this is here because a Vaccine is a drug but not for this purpose
		if(isDrugCvx){
			isDrug = false;
		}

	    AllergyMedicationCombo.setVisible(isDrug);
	    AllergyMedicationCombo.setDisabled(!isDrug);

		AllergyCvxLiveSearch.setVisible(isDrugCvx);
		AllergyCvxLiveSearch.setDisabled(!isDrugCvx);

	    AllergyMetalCombo.setVisible(isMetal);
	    AllergyMetalCombo.setDisabled(!isMetal);

	    AllergyFoodCombo.setVisible(isFood);
	    AllergyFoodCombo.setDisabled(!isFood);

	    AllergySearchCombo.setVisible(isElse);
	    AllergySearchCombo.setDisabled(!isElse);

	    if(isDrug){
		    AllergyMedicationCombo.setValue(context.record.get('allergy'));
	    }else if(isDrugCvx){
			AllergyCvxLiveSearch.setValue(context.record.get('allergy'));
	    }else if(isMetal){
		    AllergyMetalCombo.setValue(context.record.get('allergy'));
	    }else if(isFood){
		    AllergyFoodCombo.setValue(context.record.get('allergy'));
	    }else {
		    AllergySearchCombo.setValue(context.record.get('allergy'));
	    }
    },

	onAllergiesGridActivate: function(){
		var store = this.getAllergiesGrid().getStore(),
			reconciled = this.getPatientAllergyReconciledBtn().pressed,
			active = this.getActiveAllergyBtn().pressed,
			filters = [
				{
					property: 'pid',
					value: app.patient.pid
				}
			];

		if(reconciled){
			filters = Ext.Array.push(filters, {
				property: 'reconciled',
				operator: '!=',
				value: '1'
			});
		}

		if(active){
			filters = Ext.Array.push(filters, {
				property: 'status',
				value: 'Active'
			});
		}

		store.clearFilter(true);
		store.filter(filters);
	},

	onAddAllergyBtnClick: function(){
		var me = this,
			grid = me.getAllergiesGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			created_uid: app.user.id,
			uid: app.user.id,
			pid: app.patient.pid,
			eid: app.patient.eid,
			allergy_type: 'Drug allergy',
			allergy_type_code: '416098002',
			allergy_type_code_type: 'SNOMEDCT',
			status: 'Active',
			status_code: '55561003',
			status_code_type: 'SNOMEDCT',
			create_date: app.getDate(),
			begin_date: app.getDate()
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onActiveAllergyBtnToggle: function(btn, pressed){
		this.onAllergiesGridActivate();
	},

	onPatientAllergyReconciledBtnToggle: function(btn, pressed){
		this.onAllergiesGridActivate();
	},

	beforeAllergyEdit: function(editor, e){
		this.allergieMedication.setValue(e.record.data.allergy);
	},

	onReviewAllergiesBtnClick: function(){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_allergies: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	}

});

Ext.define('App.controller.patient.AppointmentRequests', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'AppointmentRequestWindow',
			selector: '#AppointmentRequestWindow'
		},
		{
			ref: 'AppointmentRequestGrid',
			selector: '#AppointmentRequestGrid'
		},
		{
			ref: 'AppointmentRequestForm',
			selector: '#AppointmentRequestForm'
		},
		{
			ref: 'AppointmentRequestAddBtn',
			selector: '#AppointmentRequestAddBtn'
		},
		{
			ref: 'AppointmentRequestRequestedField',
			selector: '#AppointmentRequestRequestedField'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport':{
				beforeencounterload: me.onAppEncounterLoad
			},
			'#AppointmentRequestGrid':{
				itemdblclick: me.onAppointmentRequestGridItemDblClick
			},
			'#AppointmentRequestWindow':{
				close: me.onAppointmentRequestWindowClose
			},
			'#AppointmentRequestAddBtn':{
				click: me.onAppointmentRequestAddBtnClick
			},
			'#AppointmentRequestSaveBtn':{
				click: me.onAppointmentRequestSaveBtnClick
			},
			'#AppointmentRequestCancelBtn':{
				click: me.onAppointmentRequestCancelBtnClick
			},
			'#AppointmentRequestDateField > button':{
				click: me.onAppointmentRequestDateFieldButtonsClick
			},
			'#AppointmentRequestProcedureFieldSet > combobox':{
				select: me.onAppointmentRequestProcedureFieldSetCombosSelect
			}
		});
	},

	onAppointmentRequestGridItemDblClick: function(grid, record){
		this.getEditWindow(record);
	},

	onAppEncounterLoad: function(encounter){
		this.getAppointmentRequestGrid().reconfigure(encounter.appointmentrequests());
		encounter.appointmentrequests().load();
	},

	onAppointmentRequestDateFieldButtonsClick: function(btn){
		var now = new Date(),
			date;

		switch (btn.action){
			case '1D':
				date = Ext.Date.add(now, Ext.Date.DAY, 1);
				break;
			case '1W':
				date = Ext.Date.add(now, Ext.Date.DAY, 7);
				break;
			case '2W':
				date = Ext.Date.add(now, Ext.Date.DAY, 14);
				break;
			case '6W':
				date = Ext.Date.add(now, Ext.Date.DAY, 42);
				break;
			case '1M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 1);
				break;
			case '2M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 2);
				break;
			case '3M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 3);
				break;
			case '4M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 4);
				break;
			case '5M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 5);
				break;
			case '6M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 6);
				break;
			case '1Y':
				date = Ext.Date.add(now, Ext.Date.YEAR, 1);
				break;
			default:
				date = now;
		}

		this.getAppointmentRequestRequestedField().setValue(date);
	},

	onAppointmentRequestAddBtnClick: function(){

		var record = Ext.create('App.model.patient.AppointmentRequest',{
			pid: app.patient.pid,
			eid: app.patient.eid,
			requested_uid: app.user.id,
			create_uid: app.user.id,
			create_date: new Date()
		});

		this.getEditWindow(record);
	},

	onAppointmentRequestProcedureFieldSetCombosSelect: function(cmb, records){
		var record = this.getAppointmentRequestForm().getForm().getRecord(),
			values = {};

		values[cmb.name] = records[0].data.Term;
		values[cmb.name + '_code'] = records[0].data.ConceptId;
		values[cmb.name + '_code_type'] = records[0].data.CodeType;
		record.set(values);
	},

	onAppointmentRequestSaveBtnClick:function(btn){
		var form = this.getAppointmentRequestForm().getForm(),
			record = form.getRecord(),
			values = form.getValues(),
			store = this.getAppointmentRequestGrid().getStore();

		if(form.isValid()){
			record.set(values);
			if(!record.store){
				store.add(record);
			}
			store.sync();
		}

		btn.up('window').close();
	},

	getEditWindow: function(record){
		if(!this.getAppointmentRequestWindow()){
			Ext.create('App.view.patient.encounter.AppointmentRequestWindow');
		}
		this.getAppointmentRequestWindow().show();

		if(record){
			this.getAppointmentRequestForm().getForm().loadRecord(record);
		}

	},

	onAppointmentRequestCancelBtnClick:function(btn){
		btn.up('window').close();
	},

	onAppointmentRequestWindowClose:function(){
		this.getAppointmentRequestForm().getForm().reset(true);
	}
});

Ext.define('App.controller.patient.EducationResources', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'EducationResourcesGrid',
			selector: '#EducationResourcesGrid'
		},
		{
			ref: 'EducationResourcesGridAddBtn',
			selector: '#EducationResourcesGridAddBtn'
		},
		{
			ref: 'EducationResourcesGridLanguageField',
			selector: '#EducationResourcesGridLanguageField'
		},
		{
			ref: 'EducationResourcesGridSearchField',
			selector: '#EducationResourcesGridSearchField'
		},
		{
			ref: 'EducationResourcesGridFindEncounterRelatedBtn',
			selector: '#EducationResourcesGridFindEncounterRelatedBtn'
		},
		{
			ref: 'EducationResourcesPreviewWindow',
			selector: '#EducationResourcesPreviewWindow'
		},
		{
			ref: 'EducationResourcesPreviewWindowGrid',
			selector: '#EducationResourcesPreviewWindowGrid'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport':{
				beforeencounterload: me.onAppEncounterLoad,
				encountersync: me.onAppEncounterSync
			},
			'#EducationResourcesGrid':{
				itemdblclick: me.onEducationResourcesGridItemDblClick
			},
			'#EducationResourcesGridLanguageField':{
				change: me.onEducationResourcesGridLanguageFieldChange
			},
			'#EducationResourcesGridSearchField':{
				select: me.onEducationResourcesGridSearchFieldSelect
			},
			'#EducationResourcesGridFindEncounterRelatedBtn':{
				click: me.onEducationResourcesGridFindEncounterRelatedBtnClick
			},
			'#EducationResourcesPreviewWindowCancelBtn':{
				click: me.onEducationResourcesPreviewWindowCancelBtnClick
			},
			'#EducationResourcesPreviewWindowSelectBtn':{
				click: me.onEducationResourcesPreviewWindowSelectBtnClick
			},
			'#EducationResourcesPreviewWindow':{
				close: me.onEducationResourcesPreviewWindowClose
			},
			'#EducationResourcesPreviewWindowGrid':{
				itemdblclick: me.onEducationResourcesPreviewWindowGridItemDblClick
			}
		});
	},

	onEducationResourcesGridFindEncounterRelatedBtnClick: function () {

		var me = this,
			language_field_value = me.getEducationResourcesGridLanguageField().getValue(),
			params = {
				eid: app.patient.eid,
				language: 'en'
			};

		if(language_field_value == 'patient'){
			if (app.patient.record && app.patient.record.get('language') == 'spa') {
				params.language = 'es';
			}
		}else {
			if(language_field_value == 'spa' || language_field_value == 'es' || language_field_value == 'esp'){
				params.language = 'es';
			}
		}

		me.getEducationResourcesGrid().el.mask(_('searching'));

		EducationResources.findEncounterEducationResources(params, function (response) {

			me.getEducationResourcesGrid().el.unmask();

			if(response.length > 0){
				me.showEducationResourcesFinderPreview();
				me.getEducationResourcesPreviewWindowGrid().getStore().loadRawData(response);
			}else {
				app.msg(_('info'), _('no_education_resources_found'));
			}
		});
	},

	onEducationResourcesPreviewWindowClose: function () {
		this.getEducationResourcesPreviewWindowGrid().getStore().removeAll();
	},

	onEducationResourcesPreviewWindowCancelBtnClick: function () {
		this.getEducationResourcesPreviewWindow().close();
	},

	onEducationResourcesPreviewWindowSelectBtnClick: function () {

		var me = this,
			selection = this.getEducationResourcesPreviewWindowGrid().getSelectionModel().getSelection(),
			store = this.getEducationResourcesGrid().getStore();

		selection.forEach(function (record) {
			var data = Ext.clone(record.data);
			data.pid = app.patient.pid;
			data.eid = app.patient.eid;
			data.uid = app.user.id;
			store.add(data);
		});

		me.getEducationResourcesPreviewWindow().close();
	},

	onEducationResourcesPreviewWindowGridItemDblClick: function (grid, document_record) {
		window.open(document_record.get('url'), '_blank');
	},

	onEducationResourcesGridItemDblClick: function (grid, document_record) {
		window.open(document_record.get('url'), '_blank');
	},

	onAppEncounterLoad: function(encounter){
		this.getEducationResourcesGrid().reconfigure(encounter.educationresources());
		encounter.educationresources().load();
	},

	onAppEncounterSync: function(encounter){
		encounter.encounter.educationresources().sync();
	},

	onEducationResourcesGridLanguageFieldChange: function (cmb, value) {
		this.getEducationResourcesGridSearchField().language = value;
	},

	onEducationResourcesGridSearchFieldSelect: function (field, selection) {
		var store = this.getEducationResourcesGrid().getStore();

		store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			title: selection[0].get('title'),
			url: selection[0].get('url'),
			snippet: selection[0].get('snippet'),
			organization_name: selection[0].get('organizationName'),
			provided_date: app.getDate()
		});

	},

	showEducationResourcesFinderPreview: function () {

		if(!this.getEducationResourcesPreviewWindow()){
			Ext.create('Ext.window.Window',{
				title: _('select_education_resources'),
				modal: true,
				layout: 'fit',
				itemId: 'EducationResourcesPreviewWindow',
				bodyPadding: 5,
				closeAction: 'hide',
				items: [
					{
						xtype:'grid',
						width: 700,
						height: 200,
						selType: 'checkboxmodel',
						itemId: 'EducationResourcesPreviewWindowGrid',
						store: Ext.create('App.store.patient.EducationResources'),
						columns:[
							{
								text: _('title'),
								dataIndex: 'title',
								flex: 1
							},
							{
								text: _('organization'),
								dataIndex: 'organization_name',
								flex: 1
							}
						]
					}
				],
				buttons: [
					{
						text: _('cancel'),
						itemId: 'EducationResourcesPreviewWindowCancelBtn'
					},
					{
						text: _('select'),
						itemId: 'EducationResourcesPreviewWindowSelectBtn'
					}
				]
			});
		}
		return this.getEducationResourcesPreviewWindow().show();
	}

});

Ext.define('App.controller.patient.CarePlanGoals', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'CarePlanGoalsGrid',
			selector: 'careplangoalsgrid'
		},
		{
			ref: 'CarePlanGoalsNewWindow',
			selector: 'careplangoalsnewwindow'
		},
		{
			ref: 'CarePlanGoalsNewForm',
			selector: '#CarePlanGoalsNewForm'
		},
		{
			ref: 'CarePlanGoalPlanDateField',
			selector: '#CarePlanGoalPlanDateField'
		},
		{
			ref: 'NewCarePlanGoalBtn',
			selector: '#NewCarePlanGoalBtn'
		},
		{
			ref: 'SoapPanelForm',
			selector: '#soapPanel form'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				'beforeencounterload': me.onBeforeOpenEncounter
			},
			'careplangoalsgrid': {
				'itemdblclick': me.onCarePlanGoalsGridItemDblClick
			},
			'#CarePlanGoalSearchField': {
				'select': me.onCarePlanGoalSearchFieldSelect
			},
			'#NewCarePlanGoalBtn': {
				'click': me.onNewCarePlanGoalBtnClick
			},
			'#CarePlanGoalsNewFormCancelBtn': {
				'click': me.onCarePlanGoalsNewFormCancelBtn
			},
			'#CarePlanGoalsNewFormSaveBtn': {
				'click': me.onCarePlanGoalsNewFormSaveBtn
			},
			'#CarePlanGoalPlanDateContainer > button': {
				'click': me.onCarePlanGoalPlanDateContainerButtonsClick
			}
		});
	},

	onCarePlanGoalPlanDateContainerButtonsClick: function(btn){
		var now = new Date(),
			field = this.getCarePlanGoalPlanDateField(),
			date;

		switch (btn.action){
			case '1D':
				date = Ext.Date.add(now, Ext.Date.DAY, 1);
				break;
			case '1W':
				date = Ext.Date.add(now, Ext.Date.DAY, 7);
				break;
			case '2W':
				date = Ext.Date.add(now, Ext.Date.DAY, 14);
				break;
			case '1M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 1);
				break;
			case '3M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 3);
				break;
			case '6M':
				date = Ext.Date.add(now, Ext.Date.MONTH, 6);
				break;
			case '1Y':
				date = Ext.Date.add(now, Ext.Date.YEAR, 1);
				break;
		}

		field.setValue(date || now);

	},

	onCarePlanGoalsGridItemDblClick: function(grid, record){
		var me = this;
		me.getCarePlanGoalsNewWindow().setTitle(record.data.goal + ' [' + record.data.goal_code + ']');
		me.getCarePlanGoalsNewWindow().show(me.getCarePlanGoalsGrid().el);
		me.getCarePlanGoalsNewForm().getForm().loadRecord(record);
	},

	onCarePlanGoalSearchFieldSelect: function(cmb, records){
		var me = this,
			form = me.getCarePlanGoalsNewForm().getForm(),
			record = form.getRecord();

		record.set({
			'goal_code': records[0].data.ConceptId,
			'goal_code_type': records[0].data.CodeType
		});
	},

	onBeforeOpenEncounter: function(encounter){
		if(this.getCarePlanGoalsGrid()){
			this.getCarePlanGoalsGrid().getStore().load({
				filters:[
					{
						property: 'eid',
						value: encounter.data.eid
					}
				]
			});
		}

	},

	onNewCarePlanGoalBtnClick: function(btn){
		var me = this,
			grid = btn.up('grid'),
			store = grid.getStore(),
			records;

		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			created_date: new Date()
		});

		me.getCarePlanGoalsNewWindow().setTitle(_('new_goal'));
		me.getCarePlanGoalsNewWindow().setSize(me.getSoapPanelForm().getSize());
		me.getCarePlanGoalsNewWindow().show(me.getCarePlanGoalsGrid().el);
		me.getCarePlanGoalsNewForm().getForm().loadRecord(records[0]);

	},

	onCarePlanGoalsNewFormSaveBtn:function(btn){
		var me = this,
			form = me.getCarePlanGoalsNewForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(form.isValid()){

			record.set(values);
			record.store.sync({
				success:function(){
					app.msg(_('sweet'), _('record_saved'));
				},
				failure:function(){
					app.msg(_('oops'), _('record_error'), true);
				}
			});

			me.getCarePlanGoalsNewForm().getForm().reset();
			me.getCarePlanGoalsNewWindow().close();
		}

	},

	onCarePlanGoalsNewFormCancelBtn:function(btn){
		var me = this;
		me.getCarePlanGoalsGrid().getStore().rejectChanges();
		me.getCarePlanGoalsNewForm().getForm().reset();
		me.getCarePlanGoalsNewWindow().close();

	}


});

Ext.define('App.controller.patient.CCD', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'PatientCcdPanel',
			selector: 'patientccdpanel'
		},
		{
			ref: 'PatientCcdPanelMiFrame',
			selector: 'patientccdpanel > miframe'
		},
		{
			ref: 'PatientCcdPanelEncounterCmb',
			selector: '#PatientCcdPanelEncounterCmb'
		},
		{
			ref: 'PatientCcdPanelExcludeCheckBoxGroup',
			selector: '#PatientCcdPanelExcludeCheckBoxGroup'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientccdpanel': {
				activate: me.onPanelActivate
			},
			'#viewCcdBtn': {
				click: me.onViewCcdBtnClick
			},
			'#archiveCcdBtn': {
				click: me.onArchiveCcdBtnClick
			},
			'#exportCcdBtn': {
				click: me.onExportCcdBtnClick
			},
			'#importCcdBtn': {
				click: me.onImportCcdBtnClick
			},
			'#printCcdBtn': {
				click: me.onPrintCcdBtnClick
			},
            '#PatientCcdPanelEncounterCmb':{
			    select: me.onPatientCcdPanelEncounterCmbSelect
            }
		});

		me.importCtrl = this.getController('patient.CCDImport');
		me.disclosuresCtrl = this.getController('patient.Disclosures');
		me.logCtrl = this.getController('administration.AuditLog');
	},

	eid: null,

	loadPatientEncounters: function(){
		var me = this,
			cmb = me.getPatientCcdPanelEncounterCmb(),
			store = cmb.store;

		if(app.patient.pid == null){
			store.removeAll();
			cmb.reset();
		}else{
			store.load({
				filters: [
					{
						property: 'pid',
						value: app.patient.pid
					}
				]
			});
		}
	},

	onPanelActivate: function(panel){

		if(this.eid === null){
			panel.down('toolbar').down('#PatientCcdPanelEncounterCmb').setVisible(true);
			this.loadPatientEncounters();
		}else{
			panel.down('toolbar').down('#PatientCcdPanelEncounterCmb').setVisible(false);
		}

		this.onViewCcdBtnClick(panel.down('toolbar').down('button'));
	},

	onViewCcdBtnClick: function(btn) {
		var eid = this.getEid(btn);

		btn.up('panel').query('miframe')[0].setSrc(
			'dataProvider/CCDDocument.php?' +
			'action=view' +
			'&site=' + window.site +
			'&pid=' + app.patient.pid +
			'&eid=' + eid +
			'&exclude=' + this.getExclusions(btn) +
			'&token=' + app.user.token
		);
		btn.up('panel').query('miframe')[0].el.unmask();

		this.logCtrl.addLog(
			app.patient.pid,
			app.user.id,
			eid,
			'encounters',
			'VIEW',
			eid == null ? 'Patient C-CDA VIEWED' : 'Encounter C-CDA VIEWED'
		);

		TransactionLog.saveExportLog({
			pid: app.patient.pid,
			uid: app.user.id,
			eid: eid,
			event: eid ? 'Patient_CCDA_VIEWED' : 'Encounter_CCDA_VIEWED'
		});

	},

	onArchiveCcdBtnClick: function(btn){

		var eid = this.getEid(btn);

		btn.up('panel').query('miframe')[0].setSrc(
			'dataProvider/CCDDocument.php?' +
            'action=archive&' +
            'site=' + window.site +
			'&pid=' + app.patient.pid +
			'&eid=' + eid +
			'&exclude=' + this.getExclusions(btn) +
			'&token=' + app.user.token
		);
        btn.up('panel').query('miframe')[0].el.unmask();

		this.logCtrl.addLog(
			app.patient.pid,
			app.user.id,
			eid,
			'encounters',
			'ARCHIVE',
            eid == null ? 'Patient C-CDA VIEWED' : 'Encounter C-CDA VIEWED'
		);

        TransactionLog.saveExportLog({
            pid: app.patient.pid,
            uid: app.user.id,
            eid: eid,
            event: eid ? 'Patient_CCDA_ARCHIVED' : 'Encounter_CCDA_ARCHIVED'
        });

	},

	onExportCcdBtnClick: function(btn){

		var eid = this.getEid(btn);

		btn.up('panel').query('miframe')[0].setSrc(
			'dataProvider/CCDDocument.php?action=export&site=' + window.site +
			'&pid=' + app.patient.pid +
			'&eid=' + eid +
			'&exclude=' + this.getExclusions(btn) +
			'&token=' + app.user.token
		);
        btn.up('panel').query('miframe')[0].el.unmask();

		this.logCtrl.addLog(
			app.patient.pid,
			app.user.id,
			eid,
			'encounters',
			'EXPORT',
            eid == null ? 'Patient C-CDA VIEWED' : 'Encounter C-CDA VIEWED'
		);

        TransactionLog.saveExportLog({
            pid: app.patient.pid,
            uid: app.user.id,
            eid: eid,
            event: eid ? 'Patient_CCDA_Exported' : 'Encounter_CCDA_Exported'
        });

		this.disclosuresCtrl.addRawDisclosure({
			pid: app.patient.pid,
			eid: eid,
			uid: app.user.id,
			date: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
			type: 'Health care operations',
			recipient: 'patient',
			description: 'Clinical Summary Provided (Exported)',
			active: 1
		});
	},

	onPrintCcdBtnClick: function(btn){
		var cont = btn.up('panel').query('miframe')[0].frameElement.dom.contentWindow;
		cont.focus();
		cont.print();

		var eid = this.getEid(btn);

		this.logCtrl.addLog(
			app.patient.pid,
			app.user.id,
			eid,
			'encounters',
			'PRINT',
            eid == null ? 'Patient C-CDA VIEWED' : 'Encounter C-CDA VIEWED'
		);

        TransactionLog.saveExportLog({
            pid: app.patient.pid,
            uid: app.user.id,
            eid: eid,
            event: eid ? 'Patient_CCDA_PRINTED' : 'Encounter_CCDA_PRINTED'
        });

		this.disclosuresCtrl.addRawDisclosure({
			pid: app.patient.pid,
			eid: eid,
			uid: app.user.id,
			date: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
			type: 'Health care operations',
			recipient: 'patient',
			description: 'Clinical Summary Provided (PRINTED)',
			active: 1
		});
	},

	onPatientCcdPanelEncounterCmbSelect: function(cmb, records){

		var eid = this.getEid(cmb);

		cmb.selectedRecord = records[0];

		cmb.up('panel').query('miframe')[0].setSrc(
			'dataProvider/CCDDocument.php?action=view&site=' + window.site +
			'&pid=' + app.patient.pid +
			'&eid=' + eid +
			'&exclude=' + this.getExclusions(cmb) +
			'&token=' + app.user.token
		);
		cmb.up('panel').query('miframe')[0].el.unmask();

		this.logCtrl.addLog(
			app.patient.pid,
			app.user.id,
			eid,
			'encounters',
			'VIEW',
			eid == null ? 'Patient C-CDA VIEWED' : 'Encounter C-CDA VIEWED'
		);

        TransactionLog.saveExportLog({
            pid: app.patient.pid,
            uid: app.user.id,
            eid: eid,
            event: eid ? 'Patient_CCDA_VIEWED' : 'Encounter_CCDA_VIEWED'
        });
	},

	getEid: function(cmp){
		var cmb = cmp.up('toolbar').query('#PatientCcdPanelEncounterCmb')[0];
		return cmb.selectedRecord ? cmb.selectedRecord.data.eid : this.eid;
	},

	cmbReset: function(cmp){
		var cmb = cmp.up('toolbar').query('#PatientCcdPanelEncounterCmb')[0];
		cmb.reset();
		delete cmb.selectedRecord;
	},

	getExclusions: function(cmp){
		var values = cmp.up('toolbar').query('#PatientCcdPanelExcludeCheckBoxGroup')[0].getValue(),
			excludes = values.exclude || [];
		return excludes.join ? excludes.join(',') : excludes;
	},

	onImportCcdBtnClick: function(btn){

		var me = this,
			win = Ext.create('App.ux.form.fields.UploadString');

		win.allowExtensions = ['xml','ccd','cda','ccda'];
		win.on('uploadready', function(comp, stringXml){
			me.getDocumentData(stringXml);
		});

		win.show();
	},

	getDocumentData: function(xml){
		var me = this;

		CDA_Parser.parseDocument(xml, function(ccdData){
			me.importCtrl.validatePosibleDuplicates = false;
			me.importCtrl.CcdImport(ccdData, app.patient.pid, xml);
			me.importCtrl.validatePosibleDuplicates = true;
			me.promptCcdScore(xml, ccdData);
		});
	},

	promptCcdScore: function(xml, ccdData){

		var me = this;

		Ext.Msg.show({
			title:'C-CDA Score',
			msg: 'Would you like to see this C-CDA score?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn === 'yes'){
					me.doCcdScore(xml, ccdData);
				}
			}
		});
	},

	doCcdScore: function (xml, ccdData) {
		CDA_ScoreCard.getScoreDocument(xml, Ext.String.format('{0}, {1} {3} (C-CDA)', ccdData.patient.lname, ccdData.patient.fname, ccdData.patient.title), function (temp_doc) {
			if(temp_doc) {
				app.getController('DocumentViewer').doDocumentView(temp_doc.id, 'temp');
			}
		});
	}

});

Ext.define('App.controller.patient.CareTeam', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientSummaryCareTeamGrid',
			selector: '#PatientSummaryCareTeamGrid'
		},
		{
			ref: 'CareTeamGridReferringPhysicianSearch',
			selector: '#CareTeamGridReferringPhysicianSearch'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				patientsummaryload: me.onPatientSummaryLoad
			},
			'#CareTeamGridReferringPhysicianSearch': {
				select: me.onCareTeamGridReferringPhysicianSearchSelect
			},
			'#CareTeamGridIdPrimaryCheckColumn': {
				beforecheckchange: me.onCareTeamGridIdPrimaryCheckColumnBeforeCheckChange,
				checkchange: me.onCareTeamGridIdPrimaryCheckColumnCheckChange
			}
		});
	},

	onCareTeamGridIdPrimaryCheckColumnCheckChange: function(col){
		col.up('grid').getStore().sort('is_primary', 'DESC');
	},

	onCareTeamGridIdPrimaryCheckColumnBeforeCheckChange: function(col, row_index, checked){

		if(checked){
			var store = col.up('grid').getStore(),
				records = store.data.items;

			for (var i = 0; i < records.length; i++) {
				if(i === row_index) continue;
				records[i].set({
					is_primary: false
				});
			}
		}
	},

	onCareTeamGridReferringPhysicianSearchSelect: function(field, selection){

		var store = field.up('grid').getStore();

		store.add({
			pid: app.patient.pid,
			npi: selection[0].get('npi'),
			fname: selection[0].get('fname'),
			mname: selection[0].get('mname'),
			lname: selection[0].get('lname'),
			create_uid: app.user.id,
			create_date: app.getDate(),
		});

		field.reset();
	},

	onPatientSummaryLoad: function(ctl, patient){
		var me = this;

		if(!me.getPatientSummaryCareTeamGrid()){
			return;
		}

		Ext.Function.defer(function () {

			var careteamstore = me.getPatientSummaryCareTeamGrid().getStore();

			careteamstore.clearFilter(true);

			careteamstore.filter([{
				property: 'pid',
				value: patient.pid
			}]);

			careteamstore.load();

		}, 250);

	},



});

Ext.define('App.controller.patient.CCDImport', {
	extend: 'Ext.app.Controller',
	requires: [
        'App.view.patient.windows.PossibleDuplicates'
	],
	refs: [
		{
			ref: 'CcdImportWindow',
			selector: 'ccdimportwindow'
		},
		{
			ref: 'CcdImportPreviewWindow',
			selector: 'ccdimportpreviewwindow'
		},

		// import patient...
		{
			ref: 'CcdImportPatientForm',
			selector: '#CcdImportPatientForm'
		},
		{
			ref: 'CcdImportActiveProblemsGrid',
			selector: '#CcdImportActiveProblemsGrid'
		},
		{
			ref: 'CcdImportMedicationsGrid',
			selector: '#CcdImportMedicationsGrid'
		},
		{
			ref: 'CcdImportAllergiesGrid',
			selector: '#CcdImportAllergiesGrid'
		},


		// marge patient...
		{
			ref: 'CcdImportPatient',
			selector: '#CcdImportPatient'
		},
		{
			ref: 'CcdPatientPatientForm',
			selector: '#CcdPatientPatientForm'
		},
		{
			ref: 'CcdPatientActiveProblemsGrid',
			selector: '#CcdPatientActiveProblemsGrid'
		},
		{
			ref: 'CcdPatientMedicationsGrid',
			selector: '#CcdPatientMedicationsGrid'
		},
		{
			ref: 'CcdPatientAllergiesGrid',
			selector: '#CcdPatientAllergiesGrid'
		},

		{
			ref: 'CDAViewer',
			selector: '#CDAViewer'
		},
		{
			ref: 'CDAViewerImportBtn',
			selector: '#CDAViewerImportBtn'
		},


		// preview patient...
		{
			ref: 'CcdImportPreviewPatientForm',
			selector: '#CcdImportPreviewPatientForm'
		},
		{
			ref: 'CcdImportPreviewActiveProblemsGrid',
			selector: '#CcdImportPreviewActiveProblemsGrid'
		},
		{
			ref: 'CcdImportPreviewMedicationsGrid',
			selector: '#CcdImportPreviewMedicationsGrid'
		},
		{
			ref: 'CcdImportPreviewAllergiesGrid',
			selector: '#CcdImportPreviewAllergiesGrid'
		},


		// buttons...
		{
			ref: 'CcdImportWindowPreviewBtn',
			selector: '#CcdImportWindowPreviewBtn'
		},
		{
			ref: 'CcdImportWindowImportBtn',
			selector: '#CcdImportWindowImportBtn'
		},
		{
			ref: 'CcdImportWindowCloseBtn',
			selector: '#CcdImportWindowCloseBtn'
		},
		{
			ref: 'CcdImportWindowPatientSearchField',
			selector: '#CcdImportWindowPatientSearchField'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'ccdimportwindow': {
				show: me.onCcdImportWindowShow
			},
			'#CcdImportPreviewWindowImportBtn': {
				click: me.onCcdImportPreviewWindowImportBtnClick
			},
			'#CcdImportWindowPreviewBtn': {
				click: me.onCcdImportWindowPreviewBtnClick
			},
			'#CcdImportWindowCloseBtn': {
				click: me.onCcdImportWindowCloseBtnClick
			},
			'#CcdImportWindowPatientSearchField': {
				select: me.onCcdImportWindowPatientSearchFieldSelect
			},
			'#CcdImportWindowSelectAllField': {
				change: me.onCcdImportWindowSelectAllFieldChange
			},
			'#CcdImportWindowViewRawCcdBtn': {
				click: me.onCcdImportWindowViewRawCcdBtnClick
			},
			'#CcdImportWindowSaveCcdaBtn': {
				click: me.onCcdImportWindowSaveCcdaBtnClick
			},
			'#PossiblePatientDuplicatesWindow > grid': {
				itemdblclick: me.onPossiblePatientDuplicatesGridItemDblClick
			},
			'#PossiblePatientDuplicatesContinueBtn': {
				click: me.onPossiblePatientDuplicatesContinueBtnClick
			},
			'#CcdImportPreviewWindowCancelBtn': {
				click: me.onCcdImportPreviewWindowCancelBtnClick
			},
			'#CDAViewerImportBtn': {
				click: me.onCDAViewerImportBtnClick
			}
		});

		me.validatePosibleDuplicates = true;

		me.on('importcomplete', me.doPatientSectionsImportComplete, me);

	},

	isSystemReconciliation: function () {
		return this.getCcdImportWindow().enableSystemReconciliation;
	},

	CcdImport: function(ccdData, mergePid, stringXml){
		if(!this.getCcdImportWindow()){
			Ext.create('App.view.patient.windows.CCDImport');
		}
		this.getCcdImportWindow().ccd = stringXml;
		this.getCcdImportWindow().ccdData = ccdData;
		this.getCcdImportWindow().ccdDataImported = false;
		this.getCcdImportWindow().show();

		if(mergePid){
			this.doLoadsystemPatientData(mergePid);
		}
	},

	onCcdImportWindowShow: function(win){
		this.doLoadCcdData(win.ccdData);
	},

    /*
    Event when the CDA Import and Viewer shows up.
    Also will check for duplicates in the database and if a possible duplicate is found
    show the possible duplicate window
     */
	doLoadCcdData: function(data){
		var me = this,
			ccdPatientForm = me.getCcdImportPatientForm().getForm(),
			patient = Ext.create('App.model.patient.Patient', data.patient),
            phone;
        ccdPatientForm.loadRecord(patient);

		if(me.validatePosibleDuplicates){
			App.app.getController('patient.Patient').lookForPossibleDuplicates(
				{
					fname: patient.data.fname,
					lname: patient.data.lname,
					sex: patient.data.sex,
					DOB: patient.data.DOB
				},
				'ccdImportDuplicateAction'
			);
		}

		// list 59 ethnicity
		// list 14 race
        // phone from Patient Contacts
		if(data.patient.race && data.patient.race !== ''){
			CombosData.getRaceByCode(data.patient.race, function(response){
                ccdPatientForm.findField('race_text').setValue(response.code_description);
			});
		}

		if(data.patient.ethnicity && data.patient.ethnicity !== ''){
			CombosData.getEthnicityByCode(data.patient.ethnicity, function(response){
                ccdPatientForm.findField('ethnicity_text').setValue(response.code_description);
			});
		}

        if(data.patient.pid && data.patient.pid !== '') {
	        ccdPatientForm.findField('phones').setValue(patient.get('home_phone'));
        }

		if(data){
			if(data.allergies && data.allergies.length > 0){
				me.reconfigureGrid('getCcdImportAllergiesGrid', data.allergies);
			}
			if(data.medications && data.medications.length > 0){
				me.reconfigureGrid('getCcdImportMedicationsGrid', data.medications);
			}
			if(data.problems && data.problems.length > 0){
				me.reconfigureGrid('getCcdImportActiveProblemsGrid', data.problems);
			}

			if(data.author){
				var title = 'Import Data - From: ';

				if(data.author.fname){
					title += ' ' + data.author.fname;
				}
				if(data.author.lname){
					title += ', ' + data.author.lname;
				}
				if(data.author.address){
					title += ' - ' + data.author.address;
				}
				if(data.author.city){
					title += ' ' + data.author.city;
				}
				if(data.author.state){
					title += ', ' + data.author.state;
				}
				me.getCcdImportPatient().setTitle(title);
			}

		}
	},

    /*
     Event fired when in the duplicate window data grid double click on an item
     this method will copy the patient information selected from the data grid, into
     the system information panel.
     */
    onPossiblePatientDuplicatesGridItemDblClick:function(grid, record){

    	if(!this.getCcdPatientPatientForm()) return;

        var me = this,
            cmb = me.getCcdImportWindowPatientSearchField(),
            systemPatientForm = me.getCcdPatientPatientForm().getForm(),
            store = cmb.getStore(),
            win = grid.up('window');

        if(win.action != 'ccdImportDuplicateAction') return;

        store.removeAll();
        me.doLoadsystemPatientData(record.data.pid);
        cmb.select(record);
        win.close();
        //me.promptVerifyPatientImport(record);
    },

	reconfigureGrid: function(getter, data){
		var me = this,
			grid = me[getter]();
		grid.getStore().loadRawData(data);
	},

	onCcdImportWindowPatientSearchFieldSelect: function(cmb, records){
		var me = this,
			importPatient = me.getCcdImportPatientForm().getForm().getRecord();

		if(importPatient.data.sex != records[0].data.sex){
			app.msg(_('warning'), _('records_sex_are_not_equal'), true);
		}

		if(importPatient.data.DOB.getFullYear() != records[0].data.DOB.getFullYear() &&
			importPatient.data.DOB.getMonth() != records[0].data.DOB.getMonth() &&
			importPatient.data.DOB.getDate() != records[0].data.DOB.getDate()){
			app.msg(_('warning'), _('records_date_of_birth_are_not_equal'), true);
		}

		me.doLoadsystemPatientData(records[0].data.pid);

	},

	doLoadsystemPatientData: function(pid){
		var me = this,
			pForm = me.getCcdPatientPatientForm().getForm(),
            phone;

		App.model.patient.Patient.load(pid, {
			success: function(patient) {
				pForm.loadRecord(patient);

				if(patient.data.race && patient.data.race !== ''){
					CombosData.getRaceByCode(patient.data.race, function(response){
						pForm.findField('race_text').setValue(response.code_description);
					});
				}

				if(patient.data.ethnicity && patient.data.ethnicity !== ''){
					CombosData.getEthnicityByCode(patient.data.ethnicity, function(response){
						pForm.findField('ethnicity_text').setValue(response.code_description);
					});
				}

				pForm.findField('phones').setValue(patient.get('home_phone'));

				me.getCcdPatientMedicationsGrid().reconfigure(patient.medications());
				patient.medications().load({
					params: { reconciled: true }
				});

				me.getCcdPatientAllergiesGrid().reconfigure(patient.allergies());
				patient.allergies().load();

				me.getCcdPatientActiveProblemsGrid().reconfigure(patient.activeproblems());
				patient.activeproblems().load();
			}
		});
	},

	onCcdImportWindowCloseBtnClick: function(){
		this.getCcdImportWindow().close();
	},

	onCcdImportWindowPreviewBtnClick: function(){
		var me = this,

			reconcile = true,

			pForm,
			importPatient = me.getCcdImportPatientForm().getForm().getRecord(),
			importActiveProblems = me.getCcdImportActiveProblemsGrid().getSelectionModel().getSelection(),
			importMedications = me.getCcdImportMedicationsGrid().getSelectionModel().getSelection(),
			importAllergies = me.getCcdImportAllergiesGrid().getSelectionModel().getSelection(),

			systemPatient = me.getCcdPatientPatientForm().getForm().getRecord(),
			systemActiveProblems = me.getCcdPatientActiveProblemsGrid().getStore().data.items,
			systemMedications = me.getCcdPatientMedicationsGrid().getStore().data.items,
			systemAllergies = me.getCcdPatientAllergiesGrid().getStore().data.items,

			systemSelectionActiveProblems = me.getCcdPatientActiveProblemsGrid().getSelectionModel().getSelection(),
			systemSelectionMedications = me.getCcdPatientMedicationsGrid().getSelectionModel().getSelection(),
			systemSelectionAllergies = me.getCcdPatientAllergiesGrid().getSelectionModel().getSelection(),

			systemReconciliationActiveProblems = [],
			systemReconciliationMedications = [],
			systemReconciliationAllergies = [],

			isMerge = systemPatient !== undefined,

			isSystemReconciliation = me.isSystemReconciliation(),

			i, store, records,

            phone;

		// check is merge and nothing is selected
		if(
			isMerge &&
			importActiveProblems.length === 0 &&
			importMedications.length === 0 &&
			importAllergies.length === 0
		){
			app.msg(_('oops'), _('nothing_to_merge'), true);
			return;
		}

		say('import');
		say(importActiveProblems);
		say(importMedications);
		say(importAllergies);

		say('system');
		say(systemActiveProblems);
		say(systemMedications);
		say(systemAllergies);

		if(!me.getCcdImportPreviewWindow()){
			Ext.create('App.view.patient.windows.CCDImportPreview');
		}
		me.getCcdImportPreviewWindow().show();

		pForm = me.getCcdImportPreviewPatientForm().getForm();

		if(isMerge){
			me.getCcdImportPreviewPatientForm().getForm().loadRecord(systemPatient);

			if(systemPatient.data.race && systemPatient.data.race !== ''){
				CombosData.getDisplayValueByListIdAndOptionValue(14, systemPatient.data.race, function(response){
					pForm.findField('race_text').setValue(response);
				});
			}

			if(systemPatient.data.ethnicity && systemPatient.data.ethnicity !== ''){
				CombosData.getDisplayValueByListIdAndOptionValue(59, systemPatient.data.ethnicity, function(response){
					pForm.findField('ethnicity_text').setValue(response);
				});
			}

			pForm.findField('phones').setValue(importPatient.get('home_phone'));

		}else{
			me.getCcdImportPreviewPatientForm().getForm().loadRecord(importPatient);

			if(importPatient.data.race && importPatient.data.race !== ''){
				CombosData.getDisplayValueByListIdAndOptionValue(14, importPatient.data.race, function(response){
					pForm.findField('race_text').setValue(response);
				});
			}

			if(importPatient.data.ethnicity && importPatient.data.ethnicity !== ''){
				CombosData.getDisplayValueByListIdAndOptionCode(59, importPatient.data.ethnicity, function(response){
					pForm.findField('ethnicity_text').setValue(response);
				});
			}

			pForm.findField('phones').setValue(importPatient.get('home_phone'));
		}

		if(reconcile){
			// reconcile active problems
			records = Ext.clone(isSystemReconciliation ? systemSelectionActiveProblems : systemActiveProblems);
			store = me.getCcdPatientActiveProblemsGrid().getStore();
			for(i=0; i < importActiveProblems.length; i++){
				if(store.find('code' , importActiveProblems[i].data.code) !== -1) continue;
				Ext.Array.insert(records, 0, [importActiveProblems[i]]);
			}
			me.getCcdImportPreviewActiveProblemsGrid().getStore().loadRecords(records);

			if(isSystemReconciliation){
				systemReconciliationActiveProblems = Ext.clone(systemActiveProblems);
				// remove is selected
				for (i = 0; i < systemSelectionActiveProblems.length; i++) {
					systemReconciliationActiveProblems = Ext.Array.remove(systemReconciliationActiveProblems, systemSelectionActiveProblems[i]);
				}
			}

			// reconcile medications
			records = Ext.clone(isSystemReconciliation ? systemSelectionMedications : systemMedications);
			store = me.getCcdPatientMedicationsGrid().getStore();
			for(i=0; i < importMedications.length; i++){
				if(store.find('RXCUI' , importMedications[i].data.RXCUI) !== -1) continue;
				Ext.Array.insert(records, 0, [importMedications[i]]);
			}
			me.getCcdImportPreviewMedicationsGrid().getStore().loadRecords(records);

			if(isSystemReconciliation) {
				systemReconciliationMedications = Ext.clone(systemMedications);
				// remove is selected
				for (i = 0; i < systemSelectionMedications.length; i++) {
					systemReconciliationMedications = Ext.Array.remove(systemReconciliationMedications, systemSelectionMedications[i]);
				}
			}

			// reconcile allergies
			records = Ext.clone(isSystemReconciliation ? systemSelectionAllergies : systemAllergies);
			store = me.getCcdPatientAllergiesGrid().getStore();
			for(i=0; i < importAllergies.length; i++){
				if(store.find('allergy_code' , importAllergies[i].data.allergy_code) !== -1) continue;
				Ext.Array.insert(records, 0, [importAllergies[i]]);
			}
			me.getCcdImportPreviewAllergiesGrid().getStore().loadRecords(records);

			if(isSystemReconciliation){
				systemReconciliationAllergies = Ext.clone(systemAllergies);
				// remove is selected
				for (i = 0; i < systemSelectionAllergies.length; i++) {
					systemReconciliationAllergies = Ext.Array.remove(systemReconciliationAllergies, systemSelectionAllergies[i]);
				}
			}

			say('reconcile');
			say(systemReconciliationActiveProblems);
			say(systemReconciliationMedications);
			say(systemReconciliationAllergies);

			var system_reconcile_records = false;
			if(isSystemReconciliation){
				system_reconcile_records = [];
				system_reconcile_records = Ext.Array.merge(system_reconcile_records, systemReconciliationActiveProblems);
				system_reconcile_records = Ext.Array.merge(system_reconcile_records, systemReconciliationMedications);
				system_reconcile_records = Ext.Array.merge(system_reconcile_records, systemReconciliationAllergies);
			}

			me.getCcdImportPreviewWindow().system_reconcile_records = system_reconcile_records;

		}else{
			me.getCcdImportPreviewActiveProblemsGrid().getStore().loadRecords(
				Ext.Array.merge(importActiveProblems, systemActiveProblems)
			);
			me.getCcdImportPreviewMedicationsGrid().getStore().loadRecords(
				Ext.Array.merge(importMedications, systemMedications)
			);
			me.getCcdImportPreviewAllergiesGrid().getStore().loadRecords(
				Ext.Array.merge(importAllergies, systemAllergies)
			);
		}
	},

	onCcdImportPreviewWindowImportBtnClick: function(){
		var me = this,
			patient = me.getCcdImportPreviewPatientForm().getForm().getRecord();

		if(patient.data.pid){
			me.promptVerifyPatientImport(patient);
		}else{
			App.app.getController('patient.Patient').lookForPossibleDuplicates(
				{
					fname: patient.data.fname,
					lname: patient.data.lname,
					sex: patient.data.sex,
					DOB: patient.data.DOB
				},
				'ccdImportDuplicateAction',
				function(win, valid){
					if(valid === true){
						me.promptVerifyPatientImport(patient);
					}
				}
			);
		}
	},

	promptVerifyPatientImport:function(patient){
		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: patient.data.pid ? _('patient_merge_verification') : _('patient_import_verification'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn == 'yes'){
					if(patient.data.pid){
						me.doPatientSectionsImport(patient);
					}else{
						me.doPatientImport(patient);
					}
				}
			}
		});
	},

	doPatientImport: function(patient){
		var me = this;

		patient.set({
			create_uid: app.user.id,
			create_date: new Date()
		});

		patient.save({
			callback:function(record, operation, success){
				if(success){
					me.doPatientSectionsImport(record);
				}else{
					app.msg(_('oops'), _('record_error'), true);
				}
			}
		});
	},

	onCcdImportPreviewWindowCancelBtnClick: function(btn){
		btn.up('window').close();
	},

	doPatientSectionsImport: function(patient){
		var me = this,
			system_reconcile_records = me.getCcdImportPreviewWindow().system_reconcile_records;

		if(system_reconcile_records !== false){
			Ext.Msg.show({
				title: _('wait'),
				msg: 'This action will import and reconcile patient record.<br><br>Would like to continue?',
				buttons: Ext.Msg.YESNO,
				icon: Ext.Msg.QUESTION,
				fn: function (btn) {
					if(btn == 'yes'){
						me.doPatientSectionsImportCont(patient, system_reconcile_records);
					}
				}
			});
		}else{
			me.doPatientSectionsImportCont(patient, system_reconcile_records);
		}
	},

	doPatientSectionsImportCont: function(patient, system_reconcile_records){
		var me = this,
			now = new Date(),
			pid = patient.data.pid,
			i,
            event,

			// Get all the stores of the dataGrids
			problems = me.getCcdImportPreviewActiveProblemsGrid().getStore().data.items,
			medications = me.getCcdImportPreviewMedicationsGrid().getStore().data.items,
			allergies = me.getCcdImportPreviewAllergiesGrid().getStore().data.items;

		say('doPatientSectionsImport');
		say(problems);
		say(medications);
		say(allergies);

		say('system_reconcile_records');
		say(system_reconcile_records);

		me.importing = true;

		if(system_reconcile_records !== false){
			system_reconcile_records.forEach(function (system_reconcile_record) {
				system_reconcile_record.set({
					reconciled: true,
					reconciled_date: now
				});
				system_reconcile_record.save();
			});
		}

		// Allergies
		for(i = 0; i < allergies.length; i++){

			if(allergies[i].data.id && allergies[i].data.id > 0)  continue;

			allergies[i].set({
				pid: pid,
				created_uid: app.user.id,
				create_date: now
			});
			allergies[i].setDirty();
			allergies[i].save({
				callback: function(){
					me.fireEvent('importcomplete', pid);
				}
			});
		}

        if(allergies.length >= 1){
		    if(system_reconcile_records !== false){
                event = 'RECONCILE';
            } else {
                event = 'IMPORT';
            }
            AuditLog.addLog({
                pid: pid,
	            eid: (pid == app.patient.pid ? app.patient.eid : '0'),
                uid: app.user.id,
                foreign_table: 'patient_allergies',
                event: event,
                event_description: 'Patient CDA: Allergies'
            });
        }

		// Medications
		for(i = 0; i < medications.length; i++){

			if(medications[i].data.id && medications[i].data.id > 0)  continue;

			medications[i].set({
				pid: pid,
				created_uid: app.user.id,
				create_date: now
			});
			medications[i].setDirty();
			medications[i].save({
				callback: function(){
					me.fireEvent('importcomplete', pid);
				}
			});
		}

        if(medications.length >= 1){
            if(system_reconcile_records !== false){
                event = 'RECONCILE';
            } else {
                event = 'IMPORT';
            }
            AuditLog.addLog({
                pid: pid,
	            eid: (pid == app.patient.pid ? app.patient.eid : '0'),
                uid: app.user.id,
                foreign_table: 'patient_medications',
                event: event,
                event_description: 'Patient CDA: Medications'
            });
        }

		// Problems
		for(i = 0; i < problems.length; i++){

			if(problems[i].data.id && problems[i].data.id > 0)  continue;

			problems[i].set({
				pid: pid,
				created_uid: app.user.id,
				create_date: now
			});
			problems[i].setDirty();
			problems[i].save({
				callback: function(){
					me.fireEvent('importcomplete', pid);
				}
			});
		}

        if(problems.length >= 1){
            if(system_reconcile_records !== false){
                event = 'RECONCILE';
            } else {
                event = 'IMPORT';
            }
            AuditLog.addLog({
                pid: pid,
	            eid: (pid == app.patient.pid ? app.patient.eid : '0'),
                uid: app.user.id,
                foreign_table: 'patient_active_problems',
                event: event,
                event_description: 'Patient CDA: Problems'
            });
        }

        AuditLog.addLog({
            pid: pid,
	        eid: (pid == app.patient.pid ? app.patient.eid : '0'),
            uid: app.user.id,
            foreign_table: 'patient',
            event: 'CCDA_IMPORT',
	        event_description: 'Patient C-CDA IMPORT'
        });

	},

	addCdaToPatientDocument: function (pid) {
		var me = this,
			win = me.getCcdImportWindow();

		if(win.ccdDataImported) return;

		Ext.Msg.show({
			title:'Save/Archive',
			msg: 'Would you like to save/archive this C-CDA?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn !== 'yes') return;
				me.addCdaToPatientDocumentHandler(pid);
			}
		});

	},

	addCdaToPatientDocumentHandler: function (pid) {
		var me = this,
			win = me.getCcdImportWindow();

		if(win.ccdDataImported) return;

		var record = Ext.create('App.model.patient.PatientDocuments', {
			code: '',
			pid: pid,
			eid: (pid == app.patient.pid ? app.patient.eid : '0'),
			uid: app.user.id,
			facility_id: app.user.facility,
			docType: 'C-CDA',
			docTypeCode: 'CD',
			date: app.getDate(),
			name: 'imported_ccd.xml',
			note: '',
			title: 'C-CDA Imported',
			encrypted: false,
			error_note: '',
			site: app.user.site,
			document: win.ccd
		});

		record.save({
			callback: function () {
				say(_('sweet'), 'C-CDA Imported');
				win.ccdDataImported = true;

				AuditLog.addLog({
					pid: pid,
					eid: (pid == app.patient.pid ? app.patient.eid : '0'),
					uid: app.user.id,
					foreign_table: 'patient',
					event: 'CCDA_ARCHIVED',
					event_description: 'Patient C-CDA Archived'
				});
			}
		});
	},

	doPatientSectionsImportComplete: function (pid) {
		var me = this;

		if(!me.importing) return;

		me.importing = false;

		var panel_cls = app.getActivePanel().$className;

		me.addCdaToPatientDocument(pid);

		me.getCcdImportWindow().close();
		me.getCcdImportPreviewWindow().close();

		if(panel_cls == 'App.view.patient.Encounter'){
			app.setPatient(app.patient.pid, app.patient.eid, null, function(){
				app.getActivePanel().openEncounter(app.patient.eid);
			});

		}else if(panel_cls == 'App.view.patient.Summary') {
			app.setPatient(pid, null, null, function(){
				app.openPatientSummary();
			});
		}

		app.msg(_('sweet'), _('patient_data_imported'));
	},

	onPossiblePatientDuplicatesContinueBtnClick:function(btn){
		if(btn.up('window').action != 'ccdImportDuplicateAction') return;
        if(this.getCcdImportPreviewPatientForm()){
            this.promptVerifyPatientImport(this.getCcdImportPreviewPatientForm().getForm().getRecord());
        }
	},

	onCcdImportWindowSelectAllFieldChange: function(field, selected){
		var me = this,
			grids = me.getCcdImportWindow().query('grid');

		for(var i = 0; i < grids.length; i++){
			var sm = grids[i].getSelectionModel();
			if(selected){
				sm.selectAll();
			}else{
				sm.deselectAll();
			}
		}
	},

	onCcdImportWindowViewRawCcdBtnClick: function(){

		var me = this,
			record = Ext.create('App.model.patient.PatientDocumentsTemp', {
				create_date: new Date(),
				document_name: 'temp_ccd.xml',
				document: me.getCcdImportWindow().ccd || me.getCcdImportWindow().ccr
			});

		record.save({
			callback: function(record){
				app.onDocumentView(record.data.id, 'ccd');
			}
		});
	},

	onCcdImportWindowSaveCcdaBtnClick: function(btn){

    	if(!app.patient.pid){
			app.msg(_('oops'),_('no_patient_selected'), true);
    		return;
	    }

		this.addCdaToPatientDocument(app.patient.pid);
	},

	CcdImportFromXml: function(stringXml, mergePid, validatePossibleDuplicates){

		var me = this;

		CDA_Parser.parseDocument(stringXml, function(ccdData){
			me.validatePosibleDuplicates = validatePossibleDuplicates;
			me.CcdImport(ccdData, mergePid, stringXml);
			me.validatePosibleDuplicates = true;
			me.promptCcdScore(stringXml, ccdData);

		});
	},

	viewCDAByXml: function(xmlString){

    	this.showCDAViewer();
    	var miframe = this.getCDAViewer().down('miframe');

		Ext.Function.defer(function () {
			miframe.frameElement.dom.contentWindow.postMessage(xmlString, document.origin);
			miframe.cdaXmlString = xmlString;
		}, 1000);
	},

	onCDAViewerImportBtnClick: function(btn){
		var miframe = btn.up('window').down('miframe');
		this.CcdImportFromXml(miframe.cdaXmlString, app.patient.pid, false);
	},

	showCDAViewer: function () {

    	if(!this.getCDAViewer()){
			Ext.create('App.view.patient.windows.CDAViewer')
	    }
    	return this.getCDAViewer().show();


	},

	promptCcdScore: function(xml, ccdData){

		var me = this;

		Ext.Msg.show({
			title:'C-CDA Score',
			msg: 'Would you like to see this C-CDA score?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn === 'yes'){
					me.doCcdScore(xml, ccdData);
				}
			}
		});
	},

	doCcdScore: function (xml, ccdData) {
		CDA_ScoreCard.getScoreDocument(xml, Ext.String.format('{0}, {1} {3} (C-CDA)', ccdData.patient.lname, ccdData.patient.fname, ccdData.patient.title), function (temp_doc) {
			if(temp_doc) {
				app.getController('DocumentViewer').doDocumentView(temp_doc.id, 'temp');
			}
		});
	}
});

Ext.define('App.controller.patient.DecisionSupport', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'DecisionSupportWarningPanel',
			selector: '#DecisionSupportWarningPanel'
		},
		{
			ref: 'MedicalDecisionSupportWarningPanel',
			selector: '#MedicalDecisionSupportWarningPanel'
		},
		{
			ref: 'MedicalDecisioMedicalWindownSupportWarningPanel',
			selector: '#MedicalWindow'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport':{
				beforeencounterload: me.onBeforeEncounterLoad
			},
			'#MedicalWindow':{
				show: me.onMedicalWindowShow
			},
			'#DecisionSupportWarningPanelCloseBtn':{
				click: me.DecisionSupportWarningPanelCloseBtnClick
			}
		});

	},

	DecisionSupportWarningPanelCloseBtnClick: function(btn){
		var warning = btn.up('decisionsupportwarningpanel');
		warning.collapse();
		warning.hide();
		warning.removeAll();
	},

	onBeforeEncounterLoad: function(){
		this.getDecisionSupportAlerts();
	},

	onMedicalWindowShow: function(){
		this.getDecisionSupportAlerts();
	},

	getDecisionSupportAlerts:function(){
        var btn,
            warning,
	        win_warning,
            i;

		warning = this.getDecisionSupportWarningPanel();
		win_warning = this.getMedicalDecisionSupportWarningPanel();

		if(!warning && !win_warning) return;

		if(warning){
			// warning.collapse();
			warning.hide();
			warning.removeAll();
		}

		if(win_warning) {
			// win_warning.collapse();
			win_warning.hide();
			win_warning.removeAll();
		}

		DecisionSupport.getAlerts({ pid: app.patient.pid, alertType: 'P' }, function(results){

			for(i=0; i < results.length; i++){

				var cls = 'decision-support-btn',
					reference_type = results[i].reference_type,
					icon = results[i].reference != '' ? 'resources/images/icons/icohelp.png' : null,
					tooltip = null;

				if(icon){
					if(reference_type == 'D'){
						icon = 'resources/images/icons/icohelpYellow.png';
						tooltip = 'Diagnostic and Therapeutic Reference';
					}else if(reference_type == 'E'){
						icon = 'resources/images/icons/icohelpPurple.png';
						tooltip = 'Evidence-Based CDS Intervention';
					}
				}

				btn = {
					xtype: 'button',
					margin: '2 5',
					icon: icon,
					text: results[i].description,
					result: results[i],
					cls: cls,
					tooltip: tooltip,
					handler: function(btn){
						if(btn.result.reference != ''){
							window.open(btn.result.reference, "_blank", "toolbar=no, scrollbars=yes, resizable=yes, top=10, left=10, width=1000, height=600");
						}else{
							app.msg(_('oops'), _('no_reference_provided'), true);
						}
					}
				};

				if(warning) {
					warning.add(btn);
				}
				if(win_warning) {
					win_warning.add(btn);
				}
			}

			if(results.length > 0){
				if(warning) {
					warning.show();
					// warning.expand();
				}
				if(win_warning) {
					win_warning.show();
					// win_warning.expand();
				}
			}

		});
	}

});

Ext.define('App.controller.patient.Dictation', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'DictationPanel',
			selector: '#DictationPanel'
		},
		{
			ref: 'DictationPanelSaveBtn',
			selector: '#DictationPanelSaveBtn'
		}
	],

	encounter: null,
	dictationStore: null,

	init: function(){
		var me = this;

		me.control({
			'viewport':{
				encounterload: me.onViewportEncounterLoad
			},
			'#DictationPanel':{
				activate: me.onDictationPanelActivate
			},
			'#DictationPanelSaveBtn':{
				click: me.onDictationPanelSaveBtnClick
			}
		});
	},

	onViewportEncounterLoad: function(encounter){
		this.encounter = encounter;
	},

	onDictationPanelActivate: function(){

		var me = this,
			form = me.getDictationPanel().getForm();

		me.encounter.dictation().load({
			callback: function(records){

				if(records.length > 0){
					form.loadRecord(records[0]);
					return;
				}

				form.loadRecord(
					Ext.create('App.model.patient.Dictation',{
						pid: me.encounter.get('pid'),
						eid: me.encounter.get('eid'),
						date: new Date(),
						uid: app.user.id
					})
				);
			}
		});
	},

	onDictationPanelSaveBtnClick: function(){

		var me = this,
			form = me.getDictationPanel().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(!form.isValid()) return;

		record.set(values);

		record.save({
			callback: function(){
				app.msg(_('sweet'), _('record_saved'));
			}
		});

	},

});
Ext.define('App.controller.patient.CognitiveAndFunctionalStatus', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'CognitiveAndFunctionalStatusPanel',
			selector: 'patientcognitiveandfunctionalstatuspanel'
		},
		{
			ref: 'NewFunctionalStatusBtn',
			selector: '#newFunctionalStatusBtn'
		}

	],

	init: function(){
		var me = this;
		me.control({
			'patientcognitiveandfunctionalstatuspanel': {
				activate: me.onCognitiveAndFunctionalStatusPanelActive
			},
			'#newFunctionalStatusBtn': {
				click: me.onNewFunctionalStatusBtnClick
			},
			'#functionalStatusCategoryCombo': {
				select: me.onFunctionalStatusCategoryComboSelect
			},
			'#functionalStatusSatausCombo': {
				select: me.onFunctionalStatusStatusComboSelect
			},
			'#functionalStatusCodeCombo': {
				select: me.onFunctionalStatusCodeComboSelect
			}
		});
	},

	onCognitiveAndFunctionalStatusPanelActive: function(grid){
		var store = grid.getStore();

		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onNewFunctionalStatusBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore(),
			records;
		grid.editingPlugin.cancelEdit();
		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			begin_date: new Date(),
			created_date: new Date()
		});
		grid.editingPlugin.startEdit(records[0], 0);
	},

	onFunctionalStatusCategoryComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			category_code: records[0].data.code,
			category_code_type: records[0].data.code_type
		});
	},

	onFunctionalStatusStatusComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			status_code: records[0].data.code,
			status_code_type: records[0].data.code_type
		});
	},

	onFunctionalStatusCodeComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			code: records[0].data.ConceptId,
			code_type: records[0].data.CodeType
		});
	}

});
Ext.define('App.controller.patient.DoctorsNotes', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'DoctorsNotesGrid',
			selector: 'patientdoctorsnotepanel'
		},
		{
			ref: 'DoctorsNoteWindow',
			selector: '#DoctorsNoteWindow'
		},
		{
			ref: 'PatientNoteForm',
			selector: '#PatientNoteForm'
		},
		{
			ref: 'PrintDoctorsNoteBtn',
			selector: '#printDoctorsNoteBtn'
		},
		{
			ref: 'NewDoctorsNoteBtn',
			selector: '#newDoctorsNoteBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientdoctorsnotepanel': {
				activate: me.onDoctorsNotesGridActive,
				selectionchange: me.onDoctorsNotesGridSelectionChange,
				beforerender: me.onDoctorsNotesGridBeforeRender,
				itemdblclick: me.onDoctorsNotesGridItemDblClick
			},
			'#printDoctorsNoteBtn': {
				click: me.onPrintDoctorsNoteBtn
			},
			'#newDoctorsNoteBtn': {
				click: me.onNewDoctorsNoteBtn
			},
			'#DoctorsNoteWindowCancelBtn': {
				click: me.onDoctorsNoteWindowCancelBtnClick
			},
			'#DoctorsNoteWindowSaveBtn': {
				click: me.onDoctorsNoteWindowSaveBtnClick
			}
		});

		me.docTemplates = {};

		/** get the document templates data of grid renderer **/
		CombosData.getTemplatesTypes(function(provider, response){
			for(var i = 0; i < response.result.length; i++){
				if(response.result[i].id) me.docTemplates[response.result[i].id] = response.result[i].title;
			}
		});

	},

	onDoctorsNotesGridBeforeRender: function(grid){
		app.on('patientunset', function(){
			grid.getStore().removeAll();
		});
	},

	onDoctorsNotesGridSelectionChange: function(sm, selected){
		this.getPrintDoctorsNoteBtn().setDisabled(selected.length === 0);
	},

	onNewDoctorsNoteBtn: function(btn){

		this.showDoctorsNoteWindow();

		var grid = btn.up('grid'),
			form = this.getPatientNoteForm().getForm();

		var records = grid.getStore().insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			refill: 0,
			order_date: new Date(),
			from_date: new Date()
		});

		form.loadRecord(records[0]);

	},

	onPrintDoctorsNoteBtn: function(note){
		var me = this,
			grid = me.getDoctorsNotesGrid(),
			record = (note.isModel ? note : grid.getSelectionModel().getSelection()[0]),
			params = {};

		params.pid = record.data.pid;
		params.eid = record.data.eid;
		params.docType = 'Doctors Note';
		params.templateId = record.data.template_id;
		params.docNoteid = record.data.id;

		DocumentHandler.createTempDocument(params, function(provider, response){
			if(window.dual){
				dual.onDocumentView(response.result.id, 'Doctors Note');
			}else{
				app.onDocumentView(response.result.id, 'Doctors Note');
			}
		});
	},

	onDoctorsNotesGridActive: function(grid){
		var store = grid.getStore();

		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	templatesRenderer: function(v){
		return this.docTemplates[v];
	},

	onDoctorsNotesGridItemDblClick: function (grid, record) {
		this.showDoctorsNoteWindow();

		var me = this,
			panel = me.getPatientNoteForm(),
			form = panel.getForm(),
			restrictionsFIeld = panel.query('multitextfield')[0],
			restrictions = record.get('restrictions');

		form.loadRecord(record);
		restrictionsFIeld.setValue(restrictions);

	},

	onDoctorsNoteWindowCancelBtnClick: function () {
		this.getDoctorsNotesGrid().getStore().rejectChanges();
		this.getPatientNoteForm().getForm().reset(true);
		this.getDoctorsNoteWindow().close();
	},

	onDoctorsNoteWindowSaveBtnClick: function () {

		var me = this,
			panel = me.getPatientNoteForm(),
			form = panel.getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			store = record.store,
			restrictionsFIeld = panel.query('multitextfield')[0],
			restrictions = restrictionsFIeld.getValue();

		if(!form.isValid()) return;

		values.restrictions = restrictions;
		record.set(values);

		if(Ext.isEmpty(store.getModifiedRecords())){
			me.getPatientNoteForm().getForm().reset(true);
			me.getDoctorsNoteWindow().close();
		}else{
			store.sync({
				callback: function () {
					me.getPatientNoteForm().getForm().reset(true);
					me.getDoctorsNoteWindow().close();
				}
			});
		}
	},

	showDoctorsNoteWindow: function () {
		if(!this.getDoctorsNoteWindow()){
			Ext.create('App.view.patient.windows.DoctorsNoteWindow');
		}
		return this.getDoctorsNoteWindow().show();
	}

});
Ext.define('App.controller.patient.DriverLicence', {
    extend: 'Ext.app.Controller',
    requires: [],
    refs: [
        {
            ref: 'HeaderPatientLiveSearchField',
            selector: '#HeaderPatientLiveSearchField'
        }
    ],

    fieldMap: {
        'DBA':'drivers_license_exp', // License Expiration Date
        'DAB':'lname', // Family Name
        'DBO':'lname', // Family Name
        'DCS':'lname', // Family Name
        'DAC':'fname', // First Name
        'DBP':'fname', // First Name
        'DCT':'fname', // First Name
        'DAD':'mname', // Middle Name or Initial
        'DBQ':'mname', // Middle Name or Initial
        'DBB':'DOB', // Date of Birth
        'DBL':'DOB', // Date of Birth
        'DBC':'sex', // Sex
        'DAG':'postal_address', // Mailing Street Address1
        'DAH':'postal_address_cont', // Mailing Street Address2
        'DAI':'postal_city', // Mailing City
        'DAJ':'postal_state', // Mailing Jurisdiction Code
        'DAK':'postal_code', // Mailing Postal Code
        'DAQ':'drivers_license', // License or ID Number
        'DCG':'postal_country', // Country territory of issuance
    },

    init: function () {
        var me = this;

        me.control({
            'viewport': {
                'barcodelicensescanned': me.onBarcodeLicenseScanned
            },
            '#DriverLicenceSearchBtn': {
                click: me.onDriverLicenceSearchBtnClick
            },
            '#DriverLicenceCreateBtn': {
                click: me.onDriverLicenceCreateBtnClick
            },
            '#DriverLicenceCancelBtn': {
                click: me.onDriverLicenceCancelBtnClick
            }
        });

    },

    onDriverLicenceSearchBtnClick: function (btn){
        var win = btn.up('window'),
            form = win.down('form').getForm(),
            values = form.getValues(),
            search_field = this.getHeaderPatientLiveSearchField(),
            query = values.lname + ', ' + values.fname;

        say(search_field);
        search_field.setValue(query);
        search_field.doQuery(query)
    },

    onDriverLicenceCreateBtnClick: function (btn){
        var me = this,
            win = btn.up('window'),
            form = win.down('form').getForm(),
            demographics_params = form.getValues(),
            patientCtl = app.getController('patient.Patient');

        patientCtl.lookForPossibleDuplicates(demographics_params, null, function (duplicared_win, response) {

            if(response === true){
                win.el.mask(_('please_wait'));
                // continue clicked
                Patient.createNewPatient(demographics_params, function (response) {
                    app.setPatient(response.pid, null, null, function(){
                        win.el.unmask();
                        win.close();
                        if(win.newPatientCallback){
                            win.newPatientCallback(response);
                        }
                    }, true);
                });

            }else if(response.isModel === true){
                win.el.mask(_('please_wait'));
                // duplicated record clicked
                app.setPatient(response.get('pid'), null, null, function(){
                    duplicared_win.close();
                    win.el.unmask();
                    win.close();
                    if(win.newPatientCallback){
                        win.newPatientCallback(response);
                    }
                }, true);
            }
        });

    },

    onDriverLicenceCancelBtnClick: function (btn){
        btn.up('window').close();
    },

    onBarcodeLicenseScanned: function (driver_lic_data){

        var me = this,
            data = me.parseDriverLic(driver_lic_data);

        if(!data.drivers_license || data.drivers_license === ''){
            app.msg(_('oops'), 'Unable to parse driver license');
            return;
        }

        say(data);

        Patient.getPatients({
            filter: [
                {
                    property: 'drivers_license',
                    value: data.drivers_license
                }
            ]
        }, function (patients){
            if(patients.length === 0){
                me.patientNotFoundHandler(data);
            }else if(patients.length === 1){
                me.patientFoundHandler(data, patients[0]);
            }else{
                me.showMultiplePatientsFound(data, patients);
            }
        });

    },

    patientFoundHandler: function (data, patient){
        app.setPatient(patient.pid, null, app.user.site, function (){
            app.msg(_('sweet'), 'Patient License Found');
            app.openPatientSummary();
        }, true);
    },

    patientNotFoundHandler: function (data){

        Ext.create('Ext.window.Window', {
            title: 'No License Found For:',
            width: 450,
            layout: 'fit',
            bodyPadding: 5,
            items: {  // Let's put an empty grid in just to illustrate fit layout
                xtype: 'form',
                bodyPadding: 5,
                defaults: {
                    anchor: '100%'
                },
                items: [
                    {
                        xtype: 'container',
                        layout: 'hbox',
                        items: [
                            {
                                xtype: 'textfield',
                                name: 'fname',
                                fieldLabel: _('fname'),
                                value: data.fname,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 2
                            },
                            {
                                xtype: 'textfield',
                                name: 'mname',
                                fieldLabel: _('mname'),
                                value: data.mname,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 1
                            },
                            {
                                xtype: 'textfield',
                                name: 'lname',
                                fieldLabel: _('lname'),
                                value: data.lname,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 3
                            },
                            {
                                xtype: 'textfield',
                                name: 'sex',
                                fieldLabel: _('sex'),
                                value: data.sex,
                                labelAlign: 'top',
                                flex: 2
                            },
                        ]
                    },
                    {
                        xtype: 'container',
                        layout: 'hbox',
                        items: [
                            {
                                xtype: 'textfield',
                                name: 'drivers_license',
                                fieldLabel: _('license_no'),
                                value: data.drivers_license,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 1
                            },
                            {
                                xtype: 'datefield',
                                name: 'drivers_license_exp',
                                fieldLabel: _('exp_date'),
                                value: new Date(data.drivers_license_exp),
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 1
                            },
                        ]
                    },

                    {
                        xtype: 'textfield',
                        name: 'postal_address',
                        fieldLabel: _('address'),
                        value: data.postal_address,
                        labelAlign: 'top'
                    },
                    {
                        xtype: 'container',
                        layout: 'hbox',
                        items: [
                            {
                                xtype: 'textfield',
                                name: 'postal_city',
                                fieldLabel: _('city'),
                                value: data.postal_city,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 2
                            },
                            {
                                xtype: 'textfield',
                                name: 'postal_state',
                                fieldLabel: _('state'),
                                value: data.postal_state,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 1
                            },
                            {
                                xtype: 'textfield',
                                name: 'postal_code',
                                fieldLabel: _('postal_code'),
                                value: data.postal_code,
                                labelAlign: 'top',
                                margin: '0 5 0 0',
                                flex: 1
                            },
                            {
                                xtype: 'textfield',
                                name: 'postal_country',
                                fieldLabel: _('country'),
                                value: data.postal_country,
                                labelAlign: 'top',
                                flex: 1
                            }
                        ]
                    }
                ],
                buttons: [
                    {
                        text: _('search'),
                        itemId: 'DriverLicenceSearchBtn'
                    },
                    {
                        text: _('create'),
                        itemId: 'DriverLicenceCreateBtn'
                    },
                    {
                        text: _('cancel'),
                        itemId: 'DriverLicenceCancelBtn'
                    }
                ]
            }
        }).show();

    },

    showMultiplePatientsFound: function (data, patients){
        var search_field = this.getHeaderPatientLiveSearchField();
        search_field.setValue(data.drivers_license);
        search_field.doQuery(data.drivers_license);
        app.msg(_('oops'), 'Multiple Patient Licenses Found', true);
    },

    parseDriverLic: function (driver_lic_data){

        var me = this,
            lines = driver_lic_data.split("\n"),
            data = {};

        lines.forEach(function (line){

            var field  = line.substr(0,3),
                value = line.substr(3, 100);

            if(me.fieldMap[field]){
                data[me.fieldMap[field]] = value.trim();
            }
        });

        if(data.sex){
            data.sex = data.sex === '1' ? 'M' : 'F';
        }

        if(data.drivers_license_exp){
            data.drivers_license_exp = data.drivers_license_exp.replace(/(\d{2})(\d{2})(\d{4})/, '$1-$2-$3')
        }
        if(data.DOB){
            data.DOB = data.DOB.replace(/(\d{2})(\d{2})(\d{4})/, '$1-$2-$3') + ' 00:00:00'
        }

        return data;
    }
});

Ext.define('App.controller.patient.DocumentArchiveLocation', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'PatientDocumentArchiveLocation',
			selector: '#PatientDocumentArchiveLocation'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentsGrid',
			selector: '#PatientDocumentArchiveLocationDocumentsGrid'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentsLocationGrid',
			selector: '#PatientDocumentArchiveLocationDocumentsLocationGrid'
		},
		{
			ref: 'DocumentLocationWindow',
			selector: '#DocumentLocationWindow'
		},
		{
			ref: 'DocumentLocationWindowForm',
			selector: '#DocumentLocationWindowForm'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentsLocationSearch',
			selector: '#PatientDocumentArchiveLocationDocumentsLocationSearch'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentArchivedBtn',
			selector: '#PatientDocumentArchiveLocationDocumentArchivedBtn'
		},

		{
			ref: 'PatientDocumentArchiveLocationFromDate',
			selector: '#PatientDocumentArchiveLocationFromDate'
		},
		{
			ref: 'PatientDocumentArchiveLocationToDate',
			selector: '#PatientDocumentArchiveLocationToDate'
		},
		{
			ref: 'PatientDocumentArchiveLocationPatientSearch',
			selector: '#PatientDocumentArchiveLocationPatientSearch'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentsLocationNewEditBtn',
			selector: '#PatientDocumentArchiveLocationDocumentsLocationNewEditBtn'
		},
		{
			ref: 'PatientDocumentArchiveLocationScannedBySearch',
			selector: '#PatientDocumentArchiveLocationScannedBySearch'
		},
		{
			ref: 'PatientDocumentLocationDepartmentSearch',
			selector: '#PatientDocumentLocationDepartmentSearch'
		},
		{
			ref: 'PatientDocumentArchiveLocationFacilitySearch',
			selector: '#PatientDocumentArchiveLocationFacilitySearch'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentPreview',
			selector: '#PatientDocumentArchiveLocationDocumentPreview'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentPreviewFrame',
			selector: '#PatientDocumentArchiveLocationDocumentPreviewFrame'
		},
		{
			ref: 'PatientDocumentArchiveLocationDocumentsEntryAddBtn',
			selector: '#PatientDocumentArchiveLocationDocumentsEntryAddBtn'
		},
		{
			ref: 'PatientDocumentArchiveLocationEntryWindow',
			selector: '#PatientDocumentArchiveLocationEntryWindow'
		},
		{
			ref: 'PatientDocumentArchiveLocationEntryForm',
			selector: '#PatientDocumentArchiveLocationEntryForm'
		}
	],

	init: function(){
		var me = this;
		me.control({

			'viewport': {
				beforerender: me.onAppBeforeRender
			},
			'#PatientDocumentArchiveLocationDocumentsGrid': {
				beforerender: me.onPatientDocumentLocationDocumentsGridBeforeRender,
				itemdblclick: me.onPatientDocumentLocationDocumentsGridItemDblClick
			},
			'#PatientDocumentArchiveLocationDocumentsGrid gridview': {
				drop: me.onPatientDocumentLocationDocumentsGridDrop
			},
			'#PatientDocumentArchiveLocationDocumentsLocationGrid': {
				beforerender: me.onPatientDocumentLocationDocumentsLocationGridBeforeRender,
				itemdblclick: me.onPatientDocumentLocationDocumentsLocationGridItemDblClick
			},
			'#PatientDocumentArchiveLocationDocumentsLocationGrid gridview': {
				drop: me.onPatientDocumentLocationDocumentsLocationGridDrop,
				beforedrop: me.onPatientDocumentLocationDocumentsLocationGridBeforeDrop
			},
			'#PatientDocumentArchiveLocationDocumentArchivedBtn': {
				toggle: me.onPatientDocumentLocationDocumentArchivedBtnToggle
			},
			'#PatientDocumentArchiveLocationFromDate': {
				change: me.onPatientDocumentLocationFromDateChange
			},
			'#PatientDocumentArchiveLocationToDate': {
				change: me.onPatientDocumentLocationToDateChange
			},
			'#PatientDocumentArchiveLocationPatientSearch': {
				select: me.onPatientDocumentLocationPatientSearchSelect,
				reset: me.onPatientDocumentLocationPatientSearchSelect
			},
			'#PatientDocumentArchiveLocationScannedBySearch': {
				change: me.onPatientDocumentLocationScannedBySearchChange
			},
			'#PatientDocumentLocationDepartmentSearch': {
				change: me.onPatientDocumentLocationDepartmentSearchChange
			},
			'#PatientDocumentArchiveLocationFacilitySearch': {
				change: me.onPatientDocumentLocationFacilitySearchChange
			},
			'#PatientDocumentArchiveLocationDocumentsLocationSearch': {
				select: me.onPatientDocumentLocationDocumentsLocationSearchSelect
			},
			'#PatientDocumentArchiveLocationDocumentsLocationNewEditBtn': {
				click: me.onPatientDocumentLocationDocumentsLocationNewEditBtnClick
			},
			'#PatientDocumentArchiveLocationDocumentsEntryAddBtn': {
				click: me.onPatientDocumentArchiveLocationDocumentsEntryAddBtnClick
			},
			'#DocumentLocationWindowCancelBtn': {
				click: me.onDocumentLocationWindowCancelBtnClick
			},
			'#DocumentLocationWindowSaveBtn': {
				click: me.onDocumentLocationWindowSaveBtnClick
			},
			'#PatientDocumentArchiveLocationDocumentPreview': {
				collapse: me.onPatientDocumentLocationDocumentPreviewCollapse
			},
			'#PatientDocumentArchiveLocationEntryCancelBtn': {
				click: me.onPatientDocumentArchiveLocationEntryCancelBtnClick
			},
			'#PatientDocumentArchiveLocationEntrySaveBtn': {
				click: me.onPatientDocumentArchiveLocationEntrySaveBtnClick
			}
		});


		me.doDocumentsSearchBuffer = Ext.Function.createBuffered(me.doDocumentsSearch, 1000, me);

		me.docExtraParams = {};
		me.locExtraParams = {};
	},

	onPatientDocumentLocationDocumentsGridDrop: function(node, data, overModel, dropPosition, eOpts){

		data.records.forEach(function (record) {

			DocumentArchiveLocation.destroyPatientDocumentLocation(record.data, function () {

				record.set({
					id: 0,
					location_id: 0,
					archive_reference_number: '',
					archive_description: '',
					archived_by_fname: '',
					archived_by_mname: '',
					archived_by_lname: '',
					create_uid: 0,
					create_date: null,
					update_uid: 0,
					update_date: null
				});

				record.commit();

			});

		});


	},

	onPatientDocumentLocationDocumentsLocationGridDrop: function(node, data, overModel, dropPosition, eOpts){

		var records = data.records,
			archive_field = this.getPatientDocumentArchiveLocationDocumentsLocationSearch(),
			archive_record = archive_field.findRecordByValue(archive_field.getValue());

		for (var i = 0; i < records.length; i++) {

			records[i].set({
				location_id: archive_record.get('id'),
				archive_reference_number: archive_record.get('reference_number'),
				archive_description: archive_record.get('description'),
				archived_by_fname: app.user.fname,
				archived_by_mname: app.user.mname,
				archived_by_lname: app.user.lname,
				create_uid: app.user.id,
				create_date: app.getDate(),
				update_uid: app.user.id,
				update_date: app.getDate()
			});

			records[i].save({
				callback: function (r) {
					r.commit();
				}
			});
		}
	},

	onPatientDocumentLocationDocumentsLocationGridBeforeDrop: function(node, data, overModel, dropPosition, eOpts){

		var cmb = this.getPatientDocumentArchiveLocationDocumentsLocationSearch(),
			value = cmb.getValue(),
			record = cmb.findRecordByValue(cmb.getValue());


		if(!value || !record){
			return false;
		}

	},

	onAppBeforeRender: function(){

		if(!a('access_documents_archive_panel'))  return;

		app.HeaderLeft.add({
			xtype: 'button',
			scale: 'large',
			margin: '0 3 0 0',
			cls: 'headerLargeBtn',
			padding: 0,
			//acl: !a('worklist_allow_birads_panel'),
			icon: 'resources/images/icons/archive.png',
			handler: function () {
				app.nav.navigateTo('App.view.patient.DocumentArchiveLocation');
			},
			tooltip: _('document_archive')
		});

	},

	onPatientDocumentLocationDocumentsGridItemDblClick: function(grid, record){
		this.doDocumentPreview(record);
	},


	onPatientDocumentLocationDocumentsLocationGridItemDblClick: function(grid, record){
		this.doDocumentPreview(record);
	},

	doDocumentPreview: function(record){
		var me =this,
			panel = me.getPatientDocumentArchiveLocationDocumentPreview(),
			frame = me.getPatientDocumentArchiveLocationDocumentPreviewFrame(),
			src = Ext.String.format('dataProvider/DocumentViewer.php?site={0}&id={1}&token={2}',
				app.user.site,
				record.get('document_id'),
				app.user.token
			);

		panel.expand();
		frame.setSrc(src);
	},

	onPatientDocumentLocationDocumentPreviewCollapse: function(){
		this.getPatientDocumentArchiveLocationDocumentPreviewFrame().setSrc('about:blank');
	},

	onPatientDocumentLocationDocumentsGridBeforeRender: function(grid){
		var me = this;

		grid.store.on('beforeload', function (store) {
			store.getProxy().extraParams = me.docExtraParams;
		});
	},

	onPatientDocumentLocationDocumentsLocationGridBeforeRender: function(grid){
		var me = this;

		grid.store.on('beforeload', function (store) {
			store.getProxy().extraParams = me.locExtraParams;
		});
	},

	doDocumentsSearch: function(){

		var me = this,
			fromField = me.getPatientDocumentArchiveLocationFromDate(),
			toField = me.getPatientDocumentArchiveLocationToDate(),
			patientField = me.getPatientDocumentArchiveLocationPatientSearch(),
			userField = me.getPatientDocumentArchiveLocationScannedBySearch(),
			facilityField = me.getPatientDocumentArchiveLocationFacilitySearch(),
			departmentField = me.getPatientDocumentLocationDepartmentSearch(),
			archiveBtn = me.getPatientDocumentArchiveLocationDocumentArchivedBtn(),
			store = me.getPatientDocumentArchiveLocationDocumentsGrid().getStore(),
			params = {};


		if(!fromField.isValid() || !toField.isValid()) return;

		params.date_from =  Ext.Date.format(fromField.getValue(), 'Y-m-d 00:00:00');
		params.date_to =  Ext.Date.format(toField.getValue(), 'Y-m-d 23:59:59');
		params.archived = archiveBtn.pressed;
		params.is_worklist = true;

		if(Ext.isNumber(patientField.getValue())){
			params.pid =  patientField.getValue();
		}

		if(userField.getValue()){
			params.uid =  userField.getValue();
		}

		if(facilityField.getValue()){
			params.facility_id =  facilityField.getValue();
		}

		me.docExtraParams = params;

		store.loadPage(1);

	},

	showDocumentLocationWindow: function(){
		if(!this.getDocumentLocationWindow()){
			Ext.create('App.view.administration.DocumentLocationWindow');
		}

		return this.getDocumentLocationWindow().show();
	},

	onPatientDocumentLocationDocumentArchivedBtnToggle: function(){
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationFromDateChange: function(field, value){
		this.getPatientDocumentArchiveLocationToDate().setMinValue(value);
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationToDateChange: function(field, value){
		this.getPatientDocumentArchiveLocationFromDate().setMaxValue(value);
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationPatientSearchSelect: function(){
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationScannedBySearchChange: function(){
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationDepartmentSearchChange: function(){
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationFacilitySearchChange: function(){
		this.doDocumentsSearchBuffer();
	},

	onPatientDocumentLocationDocumentsLocationSearchSelect: function(cmb, selection){

		var grid = this.getPatientDocumentArchiveLocationDocumentsLocationGrid(),
			store = grid.getStore();

		if(selection.length === 0){
			store.removeAll();
			store.commitChanges();
		}else{
			this.locExtraParams = {
				is_worklist: false,
				location_id: selection[0].get('id')
			};
			store.loadPage(1);
		}
	},

	onDocumentLocationWindowCancelBtnClick: function(){
		this.getDocumentLocationWindow().close();
	},

	onDocumentLocationWindowSaveBtnClick: function(){

		var me = this,
			cmb = me.getPatientDocumentArchiveLocationDocumentsLocationSearch(),
			form = me.getDocumentLocationWindowForm().getForm(),
			values = form.getValues(),
			record = form.getRecord();

		if(!form.isValid()) return;

		record.set(values);

		record.save({
			callback: function () {
				me.getDocumentLocationWindow().close();
				cmb.store.add(record);
				cmb.setValue(record.get('id'));
				me.onPatientDocumentLocationDocumentsLocationSearchSelect(cmb, [record])
			}
		});
	},

	onPatientDocumentArchiveLocationDocumentsEntryAddBtnClick: function(){

		var location_id = this.getPatientDocumentArchiveLocationDocumentsLocationSearch().getValue();

		if(!location_id){
			app.msg(_('oops'), _('document_location_required'), true);
			return;
		}

		this.showPatientDocumentArchiveLocationEntryWindow();
		this.getPatientDocumentArchiveLocationEntryForm().getForm().loadRecord(
			Ext.create('App.model.patient.PatientDocumentArchiveLocation',{
				location_id: location_id,
				document_id: 0
			})
		);

	},

	onPatientDocumentArchiveLocationEntryCancelBtnClick: function(btn){

		this.getPatientDocumentArchiveLocationEntryForm().getForm().reset(true);
		this.getPatientDocumentArchiveLocationEntryWindow().close();
	},

	onPatientDocumentArchiveLocationEntrySaveBtnClick: function(){

		var me = this,
			store = me.getPatientDocumentArchiveLocationDocumentsLocationGrid().getStore(),
			form = me.getPatientDocumentArchiveLocationEntryForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		record.set(values);

		if(!record.phantom && Ext.Object.isEmpty(record.getChanges())){
			me.getPatientDocumentArchiveLocationEntryWindow().close();
			return;
		}

		if(record.phantom){
			record.set({
				create_date: app.getDate(),
				update_date: app.getDate(),
				create_uid: app.user.id,
				update_uid: app.user.id,
				archived_by_fname: app.user.fname,
				archived_by_mname: app.user.mname,
				archived_by_lname: app.user.lname,
			});
		}else{
			record.set({
				update_date: app.getDate(),
				update_uid: app.user.id,
			});
		}

		if(!record.store){
			store.add(record);
		}

		store.sync({
			callback: function () {
				me.getPatientDocumentArchiveLocationEntryWindow().close();
			}
		});

	},

	showPatientDocumentArchiveLocationEntryWindow: function(){

		if(!this.getPatientDocumentArchiveLocationEntryWindow()){
			Ext.create('Ext.window.Window', {
				title: _('entry'),
				height: 200,
				width: 400,
				layout: 'fit',
				closeAction: 'hide',
				itemId: 'PatientDocumentArchiveLocationEntryWindow',
				items: {
					xtype: 'form',
					itemId: 'PatientDocumentArchiveLocationEntryForm',
					layout: 'fit',
					items: [
						{
							xtype: 'textarea',
							name: 'notes'
						}
					]
				},
				buttons: [
					{
						text: _('cancel'),
						itemId: 'PatientDocumentArchiveLocationEntryCancelBtn',
					},
					{
						text: _('save'),
						itemId: 'PatientDocumentArchiveLocationEntrySaveBtn',
					}
				]
			});
		}
		return this.getPatientDocumentArchiveLocationEntryWindow().show();
	},


	onPatientDocumentLocationDocumentsLocationNewEditBtnClick: function(){

		var cmb = this.getPatientDocumentArchiveLocationDocumentsLocationSearch(),
			value = cmb.getValue(),
			record = cmb.findRecordByValue(value);


		if(!record){
			record = Ext.create('App.model.patient.DocumentArchiveLocation',{
				reference_number: value
			});
		}

		this.showDocumentLocationWindow();

		this.getDocumentLocationWindowForm().getForm().loadRecord(record);

	},


});
Ext.define('App.controller.patient.FamilyHistory', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'FamilyHistoryWindow',
			selector: 'familyhistorywindow'
		},
		{
			ref: 'FamilyHistoryGrid',
			selector: 'patientfamilyhistorypanel'
		},
		{
			ref: 'FamilyHistoryForm',
			selector: '#FamilyHistoryForm'
		},
		{
			ref: 'FamilyHistorySaveBtn',
			selector: '#familyHistorySaveBtn'
		},
		{
			ref: 'FamilyHistoryOtherConditionField',
			selector: '#FamilyHistoryOtherConditionField'
		},
		{
			ref: 'FamilyHistoryOtherReletionField',
			selector: '#FamilyHistoryOtherReletionField'
		},
		{
			ref: 'FamilyHistoryOtherNoteField',
			selector: '#FamilyHistoryOtherNoteField'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientfamilyhistorypanel': {
				activate: me.onFamilyHistoryGridActivate
			},
			'#FamilyHistoryForm': {
				formitemsadded: me.onFamilyHistoryFormItemsAdded,
				beforerender: me.onFamilyHistoryFormBeforeRneder
			},
			'#FamilyHistoryGridAddBtn': {
				click: me.onFamilyHistoryGridAddBtnClick
			},
			'#FamilyHistoryWindowSaveBtn': {
				click: me.onFamilyHistoryWindowSaveBtnClick
			},
			'#FamilyHistoryWindowCancelBtn': {
				click: me.onFamilyHistoryWindowCancelBtnClick
			},
			'#FamilyHistoryGridRelationField': {
				select: me.onFamilyHistoryGridRelationFieldSelect
			}
		});
	},

	onFamilyHistoryGridRelationFieldSelect: function(cmb, selection){

		var selected_record = cmb.findRecordByValue(cmb.getValue()),
			family_record = cmb.up('form').getForm().getRecord();

		family_record.set({
			relation: selected_record.get('option_name'),
			relation_code: selected_record.get('option_value')
		});

	},

	onFamilyHistoryFormItemsAdded: function (form) {

		form.insert(0, {
			xtype: 'fieldset',
			title: _('other'),
			items: [
				{
					xtype: 'snomedlivesearch',
					itemId: 'FamilyHistoryOtherConditionField',
					fieldLabel: _('contition'),
					name: 'other_contition',
					hideLabel: false,
					anchor: '100%'
				},
				{
					xtype: 'gaiaehr.combo',
					itemId: 'FamilyHistoryOtherReletionField',
					fieldLabel: _('relation'),
					name: 'other_relation',
					action: 'relationcmb',
					width: 300,
					list: 109,
					allowBlank: false,
					loadStore: true,
					editable: false,
					resetable: true,
					value: ''
				},
				{
					xtype: 'textfield',
					itemId: 'FamilyHistoryOtherNoteField',
					fieldLabel: _('note'),
					name: 'other_note',
					anchor: '100%'
				}
			]
		});

	},

	onFamilyHistoryFormBeforeRneder: function (form) {


	},

    /**
     * This event is called from the view, and not from the controller itself.
     * @param grid
     * @param record
     */
    onDeactivateRecord: function(grid, record){
        var store,
            params = {
                id: record.data.id,
                pid: record.data.pid,
                eid: record.data.eid
            };

        Ext.Msg.show({
            title:_('removal'),
            msg: _('sure_for_removal'),
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.QUESTION,
            fn: function(btn) {
                if (btn === 'yes') {
                    store = grid.getStore();
                    FamilyHistory.deleteFamilyHistory(params, function(response){
	                    store.load({
		                    filters: [
			                    {
				                    property: 'pid',
				                    value: app.patient.pid
			                    }
		                    ]
	                    });
                    });
                }
            }
        });
    },

	onFamilyHistoryGridActivate: function(grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			]
		});
	},

	onFamilyHistoryGridAddBtnClick:function(){
		this.showFamilyHistoryWindow();
		this.getFamilyHistoryForm().getForm().reset();
	},

	showFamilyHistoryWindow: function(){
		if(!this.getFamilyHistoryWindow()){
			Ext.create('App.view.patient.windows.FamilyHistory');
		}
		this.getFamilyHistoryWindow().show();
        this.getFamilyHistoryWindow().setAutoScroll(true);
	},

	onFamilyHistoryWindowSaveBtnClick:function(){
		var grid = this.getFamilyHistoryGrid(),
			form = this.getFamilyHistoryForm().getForm(),
			store = grid.getStore(),
			values = form.getValues(),
			histories = [],
			isValid =  true,
            foo,
            condition,
			relations;


		var other_condition = this.getFamilyHistoryOtherConditionField(),
			other_relation = this.getFamilyHistoryOtherReletionField(),
			other_note = this.getFamilyHistoryOtherNoteField();

		if(other_condition.getValue() && other_relation.getValue()){

			var condition_record = other_condition.findRecordByValue(other_condition.getValue()),
				relation_record = other_relation.findRecordByValue(other_relation.getValue());

			Ext.Array.push(histories, {
				pid: app.patient.pid,
				eid: app.patient.eid,
				relation: relation_record.get('option_name'),
				relation_code: relation_record.get('code'),
				relation_code_type: relation_record.get('code_type'),
				condition: condition_record.get('Term'),
				condition_code: condition_record.get('ConceptId'),
				condition_code_type: condition_record.get('CodeType'),
				notes: other_note.getValue(),
				create_uid: app.user.id,
				create_date: new Date()
			});
		}

		Ext.Object.each(values, function(key, value){

			if(value === '0~0' || value === '0~0~') return;

			foo = value.split('~');

			if(foo.length === 1) return;

            condition = foo[0].split(':');
            relations = foo[1].split(',');

			if(isValid && relations.length === 0){
				isValid = false;
			}

			relations.forEach(function (relation) {

				relation = relation.split(':');

				Ext.Array.push(histories, {
					pid: app.patient.pid,
					eid: app.patient.eid,
					relation: relation[2],
					relation_code: relation[1],
					relation_code_type: relation[0],
					condition: condition[2],
					condition_code: condition[1],
					condition_code_type: condition[0],
					notes: relation[3] || '',
					create_uid: app.user.id,
					create_date: new Date()
				});
			});
		});

		if(histories.length === 0){
			app.msg(_('oops'), _('no_history_selected'), true);
			return;
		}

		if(!isValid){
			app.msg(_('oops'), _('missing_required_information'), true);
			return;
		}

		store.add(histories);
		store.sync();
		this.getFamilyHistoryWindow().close();
	},

	onFamilyHistoryWindowCancelBtnClick:function(){
		this.getFamilyHistoryWindow().close();
	}

});

Ext.define('App.controller.patient.HealthConcerns', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'HealthConcernGrid',
			selector: 'healthconcerngird'
		},
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				beforeencounterload: me.onBeforeOpenEncounter
			},
			'#HealthConcernGridAddBtn': {
				click: me.onHealthConcernGridAddBtnClick
			}
		});
	},

	onBeforeOpenEncounter: function(encounter){
		if(this.getHealthConcernGrid()){
			this.getHealthConcernGrid().getStore().load({
				filters:[
					{
						property: 'eid',
						value: encounter.data.eid
					}
				]
			});
		}
	},

	onHealthConcernGridAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore(),
			records;

		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_uid: app.user.id,
			create_date: app.getDate(),
			update_uid: app.user.id,
			update_date: app.getDate()
		});

		grid.editingPlugin.cancelEdit();
		grid.editingPlugin.startEdit(records[0], 0);

	}

});

Ext.define('App.controller.patient.EncounterGrid', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'EncountersGrid',
			selector: '#EncountersGrid'
		},
		{
			ref: 'EncountersGridNewEncounterBtn',
			selector: '#EncountersGridNewEncounterBtn'
		},
		{
			ref: 'EncountersGridNewProgressReportsBtn',
			selector: '#EncountersGridNewProgressReportsBtn'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#EncountersGrid': {
				activate: me.onEncountersGridActivate,
				itemdblclick: me.onEncountersGridItemDblClick,
				selectionchange: me.onEncountersGridSelectionChange
			},
			'#EncountersGridNewEncounterBtn': {
				click: me.onEncountersGridNewEncounterBtnClick
			},
			'#EncountersGridNewProgressReportsBtn': {
				click: me.onEncountersGridNewProgressReportsBtnClick
			}
		});
	},

	onEncountersGridActivate: function (grid){
		grid.store.clearFilter(true);
		grid.store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onEncountersGridNewProgressReportsBtnClick: function (btn) {
		var record = btn.up('grid').getSelectionModel().getLastSelected();
		this.showProgressByEncounterRecord(record);
	},

	showProgressByEncounterRecord: function (record){
		this.showProgressByPidAndEidAndProviderId(record.get('pid'), record.get('eid'), record.get('provider_uid'));
	},

	showProgressByPidAndEidAndProviderId: function(pid, eid, provider_id){

		var params = {
			pid: pid,
			eid: eid,
			provider_uid: provider_id,
			docType: 'EncProgress',
			templateId: '11'
		};

		DocumentHandler.createTempDocument(params, function(provider, response){
			say(response);
			app.onDocumentView(response.result.id, 'EncProgress');
		});
	},

	onEncountersGridSelectionChange: function (sm, selection) {
		sm.view.panel.down('#EncountersGridNewProgressReportsBtn').setDisabled(selection.length === 0);
	},

	onEncountersGridItemDblClick: function(view, record){
		app.openEncounter(record.data.eid);
	},

	onEncountersGridNewEncounterBtnClick: function () {
		app.createNewEncounter();
	}
});

Ext.define('App.controller.patient.Immunizations', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'SubmitImmunizationWindow',
			selector: '#SubmitImmunizationWindow'
		},
		{
			ref: 'SubmitImmunizationGrid',
			selector: '#SubmitImmunizationGrid'
		},
		{
			ref: 'ImmunizationPanel',
			selector: 'patientimmunizationspanel'
		},
		{
			ref: 'ImmunizationsGrid',
			selector: 'patientimmunizationspanel #patientImmunizationsGrid'
		},
		{
			ref: 'CvxGrid',
			selector: 'patientimmunizationspanel #cvxGrid'
		},
		{
			ref: 'CvxMvxCombo',
			selector: 'cvxmanufacturersforcvxcombo'
		},
		{
			ref: 'AddImmunizationBtn',
			selector: 'patientimmunizationspanel #addImmunizationBtn'
		},
		{
			ref: 'ReviewImmunizationsBtn',
			selector: 'patientimmunizationspanel #reviewImmunizationsBtn'
		},
		{
			ref: 'SubmitVxuBtn',
			selector: 'patientimmunizationspanel #submitVxuBtn'
		},
		{
			ref: 'ImmunizationsPresumedImmunityCheckbox',
			selector: '#ImmunizationsPresumedImmunityCheckbox'
		},
		{
			ref: 'ImmunizationsImmunizationSearch',
			selector: '#ImmunizationsImmunizationSearch'
		},
		{
			ref: 'ImmunizationsImmunizationNdcSearch',
			selector: '#ImmunizationsImmunizationNdcSearch'
		},
		{
			ref: 'ImmunizationsDisorderCombo',
			selector: '#ImmunizationsDisorderCombo'
		},
		{
			ref: 'ImmunizationsPresumedImmunityCheckbox',
			selector: '#ImmunizationsPresumedImmunityCheckbox'
		},
		{
			ref: 'ImmunizationsQuickFormWindow',
			selector: '#ImmunizationsQuickFormWindow'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientimmunizationspanel': {
				activate: me.onPatientImmunizationsPanelActive
			},
			'patientimmunizationspanel #patientImmunizationsGrid': {
				selectionchange: me.onPatientImmunizationsGridSelectionChange,
				beforeedit: me.onPatientImmunizationsGridBeforeEdit,
				edit: me.onPatientImmunizationsGridEdit
			},
			'patientimmunizationspanel #cvxGrid': {
				expand: me.onCvxGridExpand
			},
			'patientimmunizationspanel #submitVxuBtn': {
				click: me.onSubmitVxuBtnClick
			},
			'patientimmunizationspanel #reviewImmunizationsBtn': {
				click: me.onReviewImmunizationsBtnClick
			},
			'patientimmunizationspanel #addImmunizationBtn': {
				click: me.onAddImmunizationBtnClick
			},
			'#ImmunizationsInformationSourceCombo': {
				change: me.onInformationSourceComboChange
			},
			'#ImmunizationsImmunizationSearch': {
				select: me.onImmunizationSearchSelect
			},
			'#ImmunizationsImmunizationNdcSearch': {
				select: me.onImmunizationNdcSearchSelect
			},
			'#patientImmunizationsEditFormAdministeredByField': {
				select: me.onPatientImmunizationsEditFormAdministeredByFieldSelect
			},
			'#SubmitImmunizationWindow #ActiveFacilitiesCombo': {
				change: me.onActiveFacilitiesChange
			},
			'#SubmitImmunizationWindow #ApplicationCombo': {
				change: me.onApplicationChange
			},
			'#ImmunizationsPresumedImmunityCheckbox': {
				afterrender: me.onImmunizationsPresumedImmunityCheckboxAfterRender
			},
			'#ImmunizationsUnableToPerformField': {
				select: me.onImmunizationsUnableToPerformFieldSelect
			},
			'#ImmunizationHistorySearchBtn': {
				click: me.onImmunizationHistorySearchBtnClick
			},


			'#ImmunizationsQuickFormWindowCancelBtn': {
				click: me.onImmunizationsQuickFormWindowCancelBtnClick
			},
			'#ImmunizationsQuickFormWindowAddBtn': {
				click: me.onImmunizationsQuickFormWindowAddBtnClick
			},
			'#PatientSummaryImmunizationPanelQuickAddBtn': {
				click: me.onPatientSummaryImmunizationPanelQuickAddBtnClick
			},
			'#ImmunizationPanelQuickAddBtn': {
				click: me.onImmunizationPanelQuickAddBtnClick
			}
		});

		me.immunizations_quick_form_items = [];

		me.getImmunizationsQuickFormWindowFromItems();

	},

	onPatientImmunizationsGridEdit: function(plugin, context){
		app.fireEvent('immunizationedit', this, context.record);

		var pid = context.record.get('pid'),
			immunization_id = context.record.get('id');

		if(context.record.new_immunization === true){
			//this.onImmunizationRecordEdit(pid, immunization_id, 'NEW');
		}else if(context.record.get('is_error')){
			this.onImmunizationRecordEdit(pid, context.record.data, 'DELETE');
		}else{
			this.onImmunizationRecordEdit(pid, context.record.data, 'UPDATE');
		}
	},

	onImmunizationHistorySearchBtnClick: function(btn){
		var me = this;

		ImmunizationRegistry.getImmunizationHxByPid(app.patient.pid, function (response) {

			if(response.success === false || !response.messages === undefined){
				app.msg(_('oops'), 'Immunization Search Failed', true);
				return;
			}

			response.messages.forEach(function (message) {
				me.showImmunizationRegistryResponse(message);
			});
		});
	},

	showImmunizationRegistryResponse: function(message){

		if(message.response.success === false){
			app.msg(_('oops'), message.response.message, true);
			return;
		}

		Ext.create('App.view.patient.windows.ImmunizationRegisterResponseWindow', {
			hl7Message: message.response.message,
			hl7Printed: message.response.print
		}).show();

	},

	onImmunizationRecordEdit: function(pid, immunization, action){
		var me = this,
			params = {};

		params.pid = pid;
		params.facility_id = app.user.facility;
		params.immunizations = [ immunization ];
		params.action = action;

		ImmunizationRegistry.sendImmunization(params, function(response){

			if(response.success === false || !response.messages === undefined){
				app.msg(_('oops'), 'Immunization Search Failed', true);
				return;
			}

			response.messages.forEach(function (message) {
				me.showImmunizationRegistryResponse(message);
			});

		});
	},

	doImmunizationVxuSubmit: function(btn){
		var me = this,
			win = btn.up('window'),
			records = win.down('grid').getStore().data.items,
			params = {
				pid: app.patient.pid,
				eid: app.patient.eid,
				facility_id: app.user.facility,
				action: 'NEW',
				immunizations: []
			};

		records.forEach(function (record) {
			params.immunizations.push(record.data);
		});

		ImmunizationRegistry.sendImmunization(params, function(response){

			if(response.success){
				win.close();
				response.messages.forEach(function (message) {
					me.showImmunizationRegistryResponse(message);
				});
			}else{
				app.msg(_('oops'),'Registry Message Error', true);
			}

		});

	},

	onImmunizationsUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},


	onImmunizationsPresumedImmunityCheckboxAfterRender: function(checkbox){
		var me = this;

		checkbox.el.on('click', function(){
			Ext.Function.defer(function(){
				me.onImmunizationsPresumedImmunityCheckboxClick(checkbox);
			}, 100);

		});
	},

	onImmunizationsPresumedImmunityCheckboxClick: function(checkbox){

		var record = checkbox.up('form').getForm().getRecord(),
			checked = checkbox.getValue(),
			is_ndc = record.get('code_type') === 'NDC';

		this.setImmunizationFields(checked, is_ndc);

		this.getImmunizationsImmunizationSearch().reset();
		this.getImmunizationsDisorderCombo().reset();

		if(checked){
			record.set({
				presumed_immunity_code: '',
				code: '998',
				code_type: 'CVX',
				vaccine_name: 'no vaccine administered'
			});
		}else{
			record.set({
				code: '',
				code_type: '',
				vaccine_name: ''
			});
		}
	},

	setImmunizationFields: function(presumed_immunity, is_ndc){

		this.getImmunizationsDisorderCombo().setVisible(presumed_immunity);
		this.getImmunizationsDisorderCombo().setDisabled(!presumed_immunity);
		this.getImmunizationsImmunizationSearch().setVisible(!presumed_immunity);
		this.getImmunizationsImmunizationSearch().setDisabled(presumed_immunity);

		this.getImmunizationsImmunizationSearch().setVisible(!is_ndc);
		this.getImmunizationsImmunizationSearch().setDisabled(is_ndc);
		this.getImmunizationsImmunizationNdcSearch().setVisible(is_ndc);
		this.getImmunizationsImmunizationNdcSearch().setDisabled(!is_ndc);
	},

	onPatientImmunizationsEditFormAdministeredByFieldSelect: function(comb, records){
		var record = comb.up('form').getForm().getRecord();

		record.set({
			administered_uid: records[0].data.id,
			administered_title: records[0].data.title,
			administered_fname: records[0].data.fname,
			administered_mname: records[0].data.mname,
			administered_lname: records[0].data.lname
		});
	},

	onInformationSourceComboChange: function(combo, value){
		var cvxField = this.getImmunizationsImmunizationSearch(),
			ndcField = this.getImmunizationsImmunizationNdcSearch();

		if(value === '00'){
			cvxField.hide();
			cvxField.disable();

			ndcField.show();
			ndcField.enable();
		}else{
			cvxField.show();
			cvxField.enable();

			ndcField.hide();
			ndcField.disable();
		}
	},

	onImmunizationSearchSelect: function(combo, record){
		var form = combo.up('form').getForm();

		this.getCvxMvxCombo().getStore().load({
			params: {
				cvx_code: record[0].get('cvx_code')
			}
		});
		form.getRecord().set({
			code: record[0].get('cvx_code'),
			code_type: 'CVX'
		});
	},

	onImmunizationNdcSearchSelect: function(combo, record){
		var form = combo.up('form').getForm();

		this.getCvxMvxCombo().getStore().load({
			params: {
				cvx_code: record[0].get('CVXCode')
			}
		});
		form.getRecord().set({
			code: record[0].get('CVXCode'),
			code_type: 'CVX',
			ndc: record[0].get('NDC11')
		});
	},

	onCvxGridExpand: function(grid){
		grid.getStore().load();
	},

	onPatientImmunizationsGridSelectionChange: function(sm, selected){
		this.getSubmitVxuBtn().setDisabled(selected.length === 0);
	},

	onPatientImmunizationsGridBeforeEdit: function(plugin, context){
		var record = context.record,
			is_ndc = record.get('code_type') === 'NDC',
			administer_field = plugin.editor.getForm().findField('administered_by'),
			cvx_field = this.getImmunizationsImmunizationSearch(),
			ndc_field = this.getImmunizationsImmunizationNdcSearch();

		this.setImmunizationFields(context.record.get('is_presumed_immunity'), is_ndc);

		administer_field.forceSelection = false;
		Ext.Function.defer(function(){
			administer_field.setValue(context.record.data.administered_by);
			administer_field.forceSelection = true;

			if(is_ndc){
				ndc_field.setValue(context.record.get('vaccine_name'));
			}else {
				cvx_field.setValue(context.record.get('vaccine_name'));
			}


		}, 200);
	},

	onPatientImmunizationsPanelActive: function(){
		this.loadPatientImmunizations();
	},

	onSubmitVxuBtnClick: function(){
		var me = this,
			selected = me.getImmunizationsGrid().getSelectionModel().getSelection();
		me.vxuWindow = me.getVxuWindow();
		me.vxuWindow.down('grid').getStore().loadData(selected);
	},


	onReviewImmunizationsBtnClick: function(){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_immunizations: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	},

	onAddImmunizationBtnClick: function(){
		var grid = this.getImmunizationsGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		var records = store.insert(0, {
			created_uid: app.user.id,
			uid: app.user.id,
			pid: app.patient.pid,
			eid: app.patient.eid,
			facility_id: app.user.facility,
			create_date: new Date(),
			begin_date: new Date()

		});

		records[0].new_immunization = true;

		grid.editingPlugin.startEdit(records[0], 0);
	},

	loadPatientImmunizations: function(){
		var store = this.getImmunizationsGrid().getStore();
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	getVxuWindow: function(){
		var me = this;

		if(this.getSubmitImmunizationWindow()){
			return this.getSubmitImmunizationWindow().show();
		}

		return Ext.widget('window', {
			title: 'Immunization Registry Submission',
			closable: false,
			itemId: 'SubmitImmunizationWindow',
			modal: true,
			bodyStyle: 'background-color:white',
			layout: 'fit',
			items: [
				{
					xtype: 'grid',
					title: _('please_verify_the_information'),
					store: Ext.create('App.store.patient.PatientImmunization'),
					width: 800,
					minHeight: 200,
					maxHeight: 500,
					itemId: 'SubmitImmunizationGrid',
					viewConfig: {
						plugins: {
							ptype: 'gridviewdragdrop',
							dragText: 'Drag and drop to reorganize'
						}
					},
					columns: [
						{
							text: _('code'),
							dataIndex: 'code',
							width: 75
						},
						{
							text: _('vaccine_name'),
							dataIndex: 'vaccine_name',
							flex: 1
						},
						{
							text: _('administer_amount'),
							dataIndex: 'administer_amount',
							width: 130,
							renderer: function (v,m,r) {
								return v + ' ' + r.get('administer_units');
							}
						},
						{
							text: _('date_administered'),
							dataIndex: 'date_administered',
							flex: 1
						}
					]
				},
				{
					xtype: 'uxiframe',
					itemId: 'downloadHL7',
					hidden: true
				}
			],
			buttons: [
				// {
				// 	xtype: 'activefacilitiescombo',
				// 	fieldLabel: _('send_from'),
				// 	emptyText: _('select'),
				// 	itemId: 'ActiveFacilitiesCombo',
				// 	labelWidth: 60,
				// 	store: Ext.create('App.store.administration.HL7Clients', {
				// 		filters: [
				// 			{
				// 				property: 'active',
				// 				value: true
				// 			}
				// 		]
				// 	})
				// },
				// {
				// 	xtype: 'combobox',
				// 	fieldLabel: _('send_to'),
				// 	emptyText: _('select'),
				// 	allowBlank: false,
				// 	itemId: 'ApplicationCombo',
				// 	forceSelection: true,
				// 	editable: false,
				// 	labelWidth: 60,
				// 	displayField: 'application_name',
				// 	valueField: 'id',
				// 	store: Ext.create('App.store.administration.HL7Clients', {
				// 		filters: [
				// 			{
				// 				property: 'active',
				// 				value: true
				// 			}
				// 		]
				// 	})
				// },
				{
					text: _('send'),
					scope: me,
					itemId: 'send',
					handler: me.doImmunizationVxuSubmit,
					action: 'send'
				},
				{
					text: _('cancel'),
					handler: function(btn){
						btn.up('window').close();
					}
				}
			]
		}).show();
	},

	/**
	 * Only activate the send, & download button when facilities and application has been
	 * selected
	 * @param me
	 * @param newValue
	 * @param oldValue
	 */
	onActiveFacilitiesChange: function(me, newValue, oldValue){
		if(Ext.ComponentQuery.query('#ApplicationCombo')[0].getValue()){
			Ext.ComponentQuery.query('#SubmitImmunizationWindow #send')[0].setDisabled(false);
			Ext.ComponentQuery.query('#SubmitImmunizationWindow #download')[0].setDisabled(false);
		}
	},

	/**
	 * Only activate the send, & download button when facilities and application has been
	 * selected
	 * @param me
	 * @param newValue
	 * @param oldValue
	 */
	onApplicationChange: function(me, newValue, oldValue){
		if(Ext.ComponentQuery.query('#ActiveFacilitiesCombo')[0].getValue()){
			Ext.ComponentQuery.query('#SubmitImmunizationWindow #send')[0].setDisabled(false);
			Ext.ComponentQuery.query('#SubmitImmunizationWindow #download')[0].setDisabled(false);
		}
	},

	// doDownloadVxu: function(btn){
	// 	var me = this,
	// 		sm = me.getImmunizationsGrid().getSelectionModel(),
	// 		ImmunizationSelection = sm.getSelection(),
	// 		params = {},
	// 		immunizations = [],
	// 		form;
	//
	// 	if(me.vxuTo.isValid()){
	//
	// 		for(var i = 0; i < ImmunizationSelection.length; i++){
	// 			immunizations.push(ImmunizationSelection[i].data.id);
	// 			params.pid = ImmunizationSelection[i].data.pid;
	// 		}
	//
	// 		me.vxuWindow.el.mask(_('download'));
	// 		Ext.create('Ext.form.Panel', {
	// 			renderTo: Ext.ComponentQuery.query('#SubmitImmunizationWindow #downloadHL7')[0].el,
	// 			standardSubmit: true,
	// 			url: 'dataProvider/Download.php'
	// 		}).submit({
	// 			params: {
	// 				'pid': params.pid,
	// 				'from': me.vxuFrom.getValue(),
	// 				'to': me.vxuTo.getValue(),
	// 				'immunizations': Ext.encode(immunizations)
	// 			},
	// 			success: function(form, action){
	// 				// Audit log here
	// 			}
	// 		});
	//
	// 		me.vxuWindow.el.unmask();
	// 		me.vxuWindow.close();
	// 		sm.deselectAll();
	//
	// 	}
	// }

	// QUICK FORM

	showImmunizationsQuickFormWindow: function (){

		if(!this.getImmunizationsQuickFormWindow()){
			Ext.create('Ext.window.Window', {
				title: 'Immunizations Quick Form',
				width: 700,
				layout: 'fit',
				itemId: 'ImmunizationsQuickFormWindow',
				closeAction: 'hide',
				items: {
					xtype: 'form',
					bodyPadding: 10,
					frame: true,
					autoScroll: true,
					maxHeight: 650,
					items: this.immunizations_quick_form_items

				},
				buttons: [
					{
						text: _('cancel'),
						itemId: 'ImmunizationsQuickFormWindowCancelBtn'
					},
					{
						text: _('add'),
						itemId: 'ImmunizationsQuickFormWindowAddBtn'
					}
				]
			});
		}

		return this.getImmunizationsQuickFormWindow().show();

	},

	getImmunizationsQuickFormWindowFromItems: function (){
		var me = this;

		me.immunizations_quick_form_items = [];

		Immunizations.getImmunizationQuickCodes(function (quick_cvx_codes){

			quick_cvx_codes.data.forEach(function (quick_cvx_code){

				var manufacturers = JSON.parse(quick_cvx_code.manufacturers);

				var items = [
					{
						xtype: 'container',
						layout: 'hbox',
						anchor: '100%',
						items: [
							{
								xtype: 'datefield',
								labelAlign: 'top',
								fieldLabel: _('administered_date'),
								name: Ext.String.format('{0}~administered_date', quick_cvx_code.cvx_code)
							},
							{
								xtype: 'combobox',
								labelAlign: 'top',
								fieldLabel: _('manufacturer'),
								flex: 1,
								margin: '0 5 0 5',
								queryMode: 'local',
								valueField: 'mvx_code',
								displayField: 'manufacturer',
								editable: false,
								value: manufacturers[0] ? manufacturers[0].mvx_code : '',
								store: Ext.create('Ext.data.Store', {
									fields: ['id','mvx_code', 'manufacturer'],
									data: manufacturers
								}),
								name: Ext.String.format('{0}~manufacturers', quick_cvx_code.cvx_code)
							},
							{
								xtype: 'gaiaehr.combo',
								listKey: 'immu_refusal',
								flex: 1,
								labelAlign: 'top',
								fieldLabel: _('refusal_reason'),
								margin: '0 0 5 0',
								loadStore: true,
								editable: false,
								queryMode: 'local',
								value: '',
								name: Ext.String.format('{0}~refusal_reason_code', quick_cvx_code.cvx_code)
							}
						],
					},
					{
						xtype: 'gaiaehr.combo',
						itemId: 'ImmunizationsInformationSourceCombo',
						listKey: 'immu_info_source',
						anchor: '100%',
						labelAlign: 'top',
						fieldLabel: _('source'),
						loadStore: true,
						editable: false,
						value: '',
						queryMode: 'local',
						name: Ext.String.format('{0}~information_source_code', quick_cvx_code.cvx_code)
					},
					{
						xtype: 'textfield',
						labelAlign: 'top',
						fieldLabel: _('note'),
						anchor: '100%',
						name: Ext.String.format('{0}~note', quick_cvx_code.cvx_code)
					},
					{
						xtype: 'displayfield',
						anchor: '100%',
						submitValue: false,
						value: quick_cvx_code.note
					}
				];

				me.immunizations_quick_form_items.push({
					xtype: 'fieldset',
					title: Ext.String.format('<span style="font-weight: bold; font-size: 15px;">{0}</span>', quick_cvx_code.name),
					style: 'background-color: white;',
					labelAlign: 'top',
					layout: {
						type: 'vbox',
						align: 'stretch'
					},
					margin: '5 0 25 0',
					items: items
				});

			});

		});
	},

	doCloseWindow: function (win){
		win.down('form').getForm().reset();
		win.close();
	},

	onImmunizationsQuickFormWindowCancelBtnClick: function (btn){
		this.doCloseWindow(btn.up('window'));
	},

	onImmunizationsQuickFormWindowAddBtnClick: function (btn){

		var me = this,
			win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			immunizationGrid = me.getImmunizationsGrid(),
			immunizations = {};

		if(app.patient.pid === null){
			app.msg(_('info'), 'No Patient Set', true);
			return;
		}

		Ext.Object.each(values,function (key, value){
			var field_name = key.split('~'),
				cvx_code = field_name[0],
				field = field_name[1];

			if(immunizations[cvx_code] === undefined){
				immunizations[cvx_code] = {};
			}
			immunizations[cvx_code][field] = value;
		});

		Ext.Object.each(immunizations,function (cvx_code, value){
			if(value.administered_date === '' &&  value.refusal_reason_code === ''){
				delete immunizations[cvx_code];
			}else{
				immunizations[cvx_code]['cvx_code'] = cvx_code;
				immunizations[cvx_code]['pid'] = app.patient.pid;
				immunizations[cvx_code]['eid'] = app.patient.eid;
				immunizations[cvx_code]['facility_id'] = app.user.facility;
				immunizations[cvx_code]['uid'] = app.user.id;
				immunizations[cvx_code]['create_uid'] = app.user.id;
				immunizations[cvx_code]['create_date'] = Ext.util.Format.date(app.getDate(), 'Y-m-d H:i:s');
			}

		});

		immunizations = Ext.Object.getValues(immunizations);

		if(immunizations.length === 0){
			app.msg(_('info'), 'No Immunization Recorded', 'yellow');
			//me.doCloseWindow(win);
			return;
		}

		// send to php....
		Immunizations.addQuickImmunization(immunizations, function (){
			me.doCloseWindow(win);
			app.msg(_('sweet'), 'Immunizations Added');

			if(immunizationGrid && immunizationGrid.isVisible(true)){
				immunizationGrid.getStore().reload();
			}


		});

	},

	onPatientSummaryImmunizationPanelQuickAddBtnClick: function (btn){
		app.getController('patient.Immunizations').showImmunizationsQuickFormWindow();
	},

	onImmunizationPanelQuickAddBtnClick: function (btn){
		app.getController('patient.Immunizations').showImmunizationsQuickFormWindow();
	}

});
Ext.define('App.controller.patient.HL7', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'SyndromicSurveillanceBtn',
			selector: '#SyndromicSurveillanceBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#soapForm': {
				render: me.onSoapFormRender
			},
			'#SyndromicSurveillanceBtn': {
				click: me.onAdt04MessageBtnClick
			}
		});
	},

	onSoapFormRender: function(form){
		if(a('hl7_send_adt04')){
			form.getDockedItems()[0].insert(0, {
				xtype:'button',
				text: _('syndromic_surveillance'),
				tooltip: _('report_syndromic_surveillance'),
				itemId: 'SyndromicSurveillanceBtn'
			});
		}
	},

	onAdt04MessageBtnClick: function(){

		HL7Messages.broadcastADT({
			pid: app.patient.pid,
			eid: app.patient.eid,
			fid: app.user.facility,
			event: app.patient.encounterIsClose ? 'A03' : 'A04',
			anonymous: true,
			map_codes_types: {
				ethnicity: 'CDCREC'
			}
		}, function(response){
		});
	}



});

Ext.define('App.controller.patient.ItemsToReview', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'ItemsToReviewPanel',
			selector: '#ItemsToReviewPanel'
		},
		{
			ref: 'ItemsToReviewImmuGrid',
			selector: '#ItemsToReviewPanel #ItemsToReviewImmuGrid'
		},
		{
			ref: 'ItemsToReviewAllergiesGrid',
			selector: '#ItemsToReviewPanel #ItemsToReviewAllergiesGrid'
		},
		{
			ref: 'ItemsToReviewActiveProblemsGrid',
			selector: '#ItemsToReviewPanel #ItemsToReviewActiveProblemsGrid'
		},
		{
			ref: 'ItemsToReviewMedicationsGrid',
			selector: '#ItemsToReviewPanel #ItemsToReviewMedicationsGrid'
		},
		{
			ref: 'ReviewSmokingStatusCombo',
			selector: '#ItemsToReviewPanel #reviewsmokingstatuscombo'
		},
        {
            ref: 'ItemsToReviewEducationGivenField',
            selector: '#ItemsToReviewPanel #ItemsToReviewEducationGivenField'
        },
		{
			ref: 'EncounterMedicationReconciliations',
			selector: '#ItemsToReviewPanel #EncounterMedicationReconciliations'
		},
		{
			ref: 'EncounterMedicationReconciliationsDateField',
			selector: '#ItemsToReviewPanel #EncounterMedicationReconciliationsDateField'
		},
        {
            ref: 'EncounterSummaryCareProvided',
            selector: '#ItemsToReviewPanel #EncounterSummaryCareProvided'
        },
		{
			ref: 'ItemsToReviewActivePainScaleGrid',
			selector: '#ItemsToReviewPanel #ItemsToReviewActivePainScaleGrid'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#ItemsToReviewPanel':{
				activate: me.storesLoad
			},
			'#encounterRecordAdd':{
				click: me.onReviewAll
			},
			'#ItemsToReviewPanel #ItemsToReviewEducationGivenField':{
				change: me.onItemsToReviewEducationGivenFieldChange
			},
            '#ItemsToReviewPanel #EncounterMedicationReconciliations':{
                change: me.onEncounterMedicationReconciliationsChange
            },
            '#ItemsToReviewPanel #EncounterMedicationReconciliationsDateField':{
                change: me.onEncounterMedicationReconciliationsDateFieldChange
            },
            '#ItemsToReviewPanel #EncounterSummaryCareProvided':{
                change: me.onEncounterSummaryCareProvidedChange
            }
		});
	},

	storesLoad: function(){
		var me = this,
			params = {
				filters: [
					{
						property: 'pid',
						value: app.patient.pid
					}
				]
			};

		me.getReviewSmokingStatusCombo().reset();
		me.getItemsToReviewImmuGrid().getStore().load(params);
		me.getItemsToReviewAllergiesGrid().getStore().load(params);
		me.getItemsToReviewActiveProblemsGrid().getStore().load(params);
		me.getItemsToReviewMedicationsGrid().getStore().load(params);
		me.getItemsToReviewActivePainScaleGrid().getStore().load(params);

		me.smokeStatusStore = app.getController('patient.Social').smokeStatusStore;

		/**
		 * add the callback function to handle the Smoking Status
		 */
		params.callback = function(){
			if(this.last()){
				me.getReviewSmokingStatusCombo().setValue(this.last().data.status);
			}
		};
		me.smokeStatusStore.load(params);

		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();

        // me.getEncounterMedicationReconciliations().suspendEvents(false);
        // me.getEncounterMedicationReconciliationsDateField().suspendEvents(false);
        me.getEncounterSummaryCareProvided().suspendEvents(false);
        // me.getItemsToReviewEducationGivenField().suspendEvents(false);

        // me.getEncounterMedicationReconciliations().setValue(encounter.get('medication_reconciliations'));
        // me.getEncounterMedicationReconciliationsDateField().setValue(encounter.get('medication_reconciliations_date'));
        me.getEncounterSummaryCareProvided().setValue(encounter.get('summary_care_provided'));
        // me.getItemsToReviewEducationGivenField().setValue(encounter.get('patient_education_given'));

        // me.getEncounterMedicationReconciliations().resumeEvents();
        // me.getEncounterMedicationReconciliationsDateField().resumeEvents();
        me.getEncounterSummaryCareProvided().resumeEvents();
        // me.getItemsToReviewEducationGivenField().resumeEvents();
	},

	onReviewAll: function(){

		if(this.getReviewSmokingStatusCombo().isValid()){

			var encounterCtrl = this.getController('patient.encounter.Encounter');
			var encounter = encounterCtrl.getEncounterRecord();

			encounter.set({
				review_active_problems: true,
				review_allergies: true,
				review_dental: true,
				review_immunizations: true,
				review_medications: true,
				review_smoke: true,
				review_surgery: true,
				review_pain_scales: true
			});

			encounter.save({
				success: function(){
					app.msg(_('sweet'), _('items_to_review_save_and_review'));
					encounterCtrl.getProgressNote();
				},
				failure: function(){
					app.msg(_('oops'), _('items_to_review_entry_error'));
				}
			});
		}
	},

	onItemsToReviewEducationGivenFieldChange: function(field, newValue, oldValue, eOpts){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({
			patient_education_given: newValue
		});
        this.saveEncounterChanges(encounter);
	},

    onEncounterMedicationReconciliationsChange: function(field, newValue, oldValue, eOpts){
        var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();

        encounter.set({
            medication_reconciliations: newValue
        });

        this.saveEncounterChanges(encounter);
    },

	onEncounterMedicationReconciliationsDateFieldChange: function(field, newValue, oldValue, eOpts){
        var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();

        if(!field.isValid()) return;

        encounter.set({
            medication_reconciliations_date: newValue
        });

        this.saveEncounterChanges(encounter);
    },

    onEncounterSummaryCareProvidedChange: function(field, newValue, oldValue, eOpts){
        var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
        encounter.set({
            summary_care_provided: newValue
        });
        this.saveEncounterChanges(encounter);
    },

    saveEncounterChanges: function(encounterObject){
        encounterObject.setDirty();
        if(!Ext.Object.isEmpty(encounterObject.getChanges())){
            encounterObject.save({
                success: function(){
                    app.msg(_('sweet'), _('record_saved'));
                },
                failure: function(){
                    app.msg(_('oops'), _('record_error'));
                }
            });
        }
    }

});

Ext.define('App.controller.patient.ImplantableDevice', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'ImplantableDeviceGrid',
			selector: '#ImplantableDeviceGrid'
		},
		{
			ref: 'ImplantableDeviceDetailsWindow',
			selector: '#ImplantableDeviceDetailsWindow'
		},
		{
			ref: 'ImplantableDeviceDetailsForm',
			selector: '#ImplantableDeviceDetailsForm'
		},
		{
			ref: 'ImplantableDeviceDetailsUDIField',
			selector: '#ImplantableDeviceDetailsUDIField'
		},
		{
			ref: 'ImplantableDeviceDetailsSaveBtn',
			selector: '#ImplantableDeviceDetailsSaveBtn'
		},
		{
			ref: 'ImplantableDeviceGridAddBtn',
			selector: '#ImplantableDeviceGridAddBtn'
		},
		{
			ref: 'ImplantableDeviceGridActiveBtn',
			selector: '#ImplantableDeviceGridActiveBtn'
		},
		{
			ref: 'ImplantableDeviceReviewBtn',
			selector: '#ImplantableDeviceReviewBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#ImplantableDeviceGrid': {
				'activate': me.onImplantableDeviceGridActivate
			},
			'#ImplantableDeviceDetailsCancelBtn': {
				'click': me.onImplantableDeviceDetailsCancelBtnClick
			},
			'#ImplantableDeviceDetailsSaveBtn': {
				'click': me.onImplantableDeviceDetailsSaveBtnClick
			},
			'#ImplantableDeviceGridAddBtn': {
				'click': me.onImplantableDeviceGridAddBtnClick
			},
			'#ImplantableDeviceDetailsParseBtn': {
				'click': me.onImplantableDeviceDetailsParseBtnClick
			},
			'#ImplantableDeviceGridActiveBtn': {
				'toggle': me.onImplantableDeviceGridActiveBtnToggle
			},
			'#ImplantableDeviceReviewBtn': {
				'click': me.onImplantableDeviceReviewBtnBtnClick
			}
		});
	},

	onImplantableDeviceGridActivate: function (grid) {
		var store = grid.getStore(),
			filters = [
				{
					property: 'pid',
					value: app.patient.pid
				}
			];

		if(this.getImplantableDeviceGridActiveBtn().pressed){
			filters = Ext.Array.push(filters, {
				property: 'status',
				value: 'Active'
			});
		}

		store.clearFilter(true);
		store.filter(filters);
	},

	onImplantableDeviceGridActionClick: function (grid, device_record) {
		this.showImplantableDeviceDetailsWindow();
		this.getImplantableDeviceDetailsForm().getForm().reset();
		this.getImplantableDeviceDetailsForm().getForm().setValues(device_record.data);
		this.getImplantableDeviceDetailsSaveBtn().hide();
	},

	onImplantableDeviceGridAddBtnClick: function () {
		this.showImplantableDeviceDetailsWindow();
	},

	onImplantableDeviceDetailsParseBtnClick: function () {
		var me = this,
			udi = me.getImplantableDeviceDetailsUDIField().getValue();

		ImplantableDevice.getUidData({udi: udi}, function (response) {

			if(response.parse.data.error){
				app.msg(_('oops'), response.parse.data.error, true);
				return;
			}

			var device = response.lookup.data.gudid.device,
				unit = response.parse.data,
				snomed = response.snomed.data.concepts[0] ? response.snomed.data.concepts[0] : {},
				gmdn = device.gmdnTerms.gmdn[0] ? device.gmdnTerms.gmdn[0] : {};

			var values = {
				udi: unit.udi,
				di: unit.di,
				description: snomed.snomedCTName,
				description_code: snomed.snomedIdentifier,
				description_code_type: 'SNOMEDCT',
				gmdnpt_name: gmdn.gmdnPTName || '',
				lot_number: unit.lotNumber || '',
				serial_number: unit.serialNumber || '',
				exp_date: unit.expirationDate || null ,
				mfg_date: unit.manufacturingDateOriginal || null,
				donation_id: device.donationIdNumber || '',
				brand_name: device.brandName || '',
				version_model: device.versionModelNumber || '',
				company_name: device.companyName || '',
				mri_safety_info: device.MRISafetyStatus || '',
				required_lnr: device.labeledContainsNRL || false
			};

			me.getImplantableDeviceDetailsForm().getForm().setValues(values);
			me.getImplantableDeviceDetailsSaveBtn().show();

		});

	},

	onImplantableDeviceGridActiveBtnToggle: function (btn, pressed) {
		this.onImplantableDeviceGridActivate(this.getImplantableDeviceGrid());
	},

	onImplantableDeviceDetailsCancelBtnClick: function () {
		this.getImplantableDeviceDetailsForm().getForm().reset();
		this.getImplantableDeviceDetailsWindow().close();
	},

	onImplantableDeviceDetailsSaveBtnClick: function () {

		var me = this,
			grid = this.getImplantableDeviceGrid(),
			form = this.getImplantableDeviceDetailsForm().getForm(),
			device_record = Ext.create('App.model.patient.ImplantableDevice', form.getValues());

		say(form.getValues());

		device_record.set({
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_uid: app.user.id,
			update_uid: app.user.id,
			create_date: new Date(),
			update_date: new Date()
		});

		grid.getStore().add(device_record);
		grid.getStore().sync({
			callback: function () {
				me.getImplantableDeviceDetailsForm().getForm().reset();
				me.getImplantableDeviceDetailsWindow().close();
			}
		});

	},

	showImplantableDeviceDetailsWindow: function () {
		if(!this.getImplantableDeviceDetailsWindow()){
			Ext.create('App.view.patient.windows.ImplantableDeviceDetails');
		}
		return this.getImplantableDeviceDetailsWindow().show();
	},

	onImplantableDeviceReviewBtnBtnClick: function(btn){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_implantable_devices: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	}

});

Ext.define('App.controller.patient.Interventions', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'InterventionsGrid',
			selector: 'interventionsgrid'
		},
		{
			ref: 'InterventionWindow',
			selector: '#InterventionWindow'
		},
		{
			ref: 'InterventionForm',
			selector: '#InterventionForm'
		},
		{
			ref: 'InterventionGridAddBtn',
			selector: '#InterventionGridAddBtn'
		},
		{
			ref: 'SoapPanelForm',
			selector: '#soapPanel form'
		}
	],

	bmi_underweight_intervention: {
		description: 'Underweight Diet Education Plan Intervention',
		reason: 'BMI below 18.5 OR above > 25 kg/m2',
		code: '370847001',
		code_text: 'Provides instruction regarding dietary needs',
		code_type: 'SNOMEDCT',
		dx_code: '248342006',
		dx_code_text: 'Underweight (finding)',
		dx_code_type: 'SNOMEDCT',
		threshold_in_months: -3
	},

	bmi_overweight_intervention: {
		description: 'Overweight Diet Education Plan Intervention',
		reason: 'BMI below 18.5 OR above > 25 kg/m2',
		code: '370847001',
		code_text: 'Provides instruction regarding dietary needs',
		code_type: 'SNOMEDCT',
		dx_code: '238131007',
		dx_code_text: 'Overweight (finding)',
		dx_code_type: 'SNOMEDCT',
		threshold_in_months: -3
	},

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				beforeencounterload: me.onBeforeOpenEncounter,
				patientvitalsload: me.onPatientVitalsLoad
			},
			'#InterventionsGrid': {
				itemdblclick: me.onInterventionsGridItemDblClick
			},
			'#InterventionGridAddBtn': {
				click: me.onInterventionGridAddBtnClick
			},
			'#InterventionSearchField': {
				select: me.onInterventionSearchFieldSelect
			},
			'#InterventionFormCancelBtn': {
				click: me.onInterventionFormCancelBtnClick
			},
			'#InterventionFormSaveBtn': {
				click: me.onInterventionFormSaveBtnClick
			},
			'#InterventionUnableToPerformField': {
				select: me.onInterventionUnableToPerformFieldSelect
			},


			// '#CarePlanGoalSearchField': {
			// 	'select': me.onCarePlanGoalSearchFieldSelect
			// },
			//

			// '#CarePlanGoalPlanDateContainer > button': {
			// 	'click': me.onCarePlanGoalPlanDateContainerButtonsClick
			// }
		});
	},

	onInterventionUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},

	onBeforeOpenEncounter: function(encounter){

		if(!a('add_patient_interventions')){
			return;
		}

		if(this.getInterventionsGrid()){
			this.getInterventionsGrid().getStore().load({
				filters:[
					{
						property: 'eid',
						value: encounter.data.eid
					}
				]
			});
		}
	},

	onInterventionsGridItemDblClick: function(grid, record){
		this.showInterventionsGrid();
		this.getInterventionForm().getForm().loadRecord(record);
	},

	onInterventionGridAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore(),
			records;

		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			intervention_type: 'RecommendedNutrition',
			create_uid: app.user.id,
			create_date: app.getDate(),
			update_uid: app.user.id,
			update_date: app.getDate()
		});

		this.showInterventionsGrid();
		this.getInterventionForm().getForm().loadRecord(records[0]);
	},

	onInterventionSearchFieldSelect: function(cmb, selection){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			'code': selection[0].get('ConceptId'),
			'code_text': selection[0].get('Term'),
			'code_type': selection[0].get('CodeType')
		});

	},

	onInterventionFormCancelBtnClick: function(btn){
		this.getInterventionsGrid().getStore().rejectChanges();
		this.getInterventionForm().getForm().reset();
		this.getInterventionWindow().close();
	},

	onInterventionFormSaveBtnClick: function(btn){
		var me = this,
			form = me.getInterventionForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(form.isValid()){

			record.set(values);

			if(Ext.Object.isEmpty(record.getChanges()) && !record.phantom){
				form.reset();
				me.getInterventionWindow().close();
				return;
			}

			record.set({
				update_uid: app.user.id,
				update_date: app.getDate()
			});

			record.store.sync({
				success:function(){
					app.msg(_('sweet'), _('record_saved'));
					form.reset();
					me.getInterventionWindow().close();
				},
				failure:function(){
					app.msg(_('oops'), _('record_error'), true);
					form.reset();
					me.getInterventionWindow().close();
				}
			});


		}
	},

	showInterventionsGrid: function(){
		if(!this.getInterventionWindow()){
			Ext.create('App.view.patient.encounter.InterventionWindow');
		}
		return this.getInterventionWindow().show();
	},

	onCarePlanGoalSearchFieldSelect: function(cmb, records){
		var me = this,
			form = me.getCarePlanGoalsNewForm().getForm(),
			record = form.getRecord();

		record.set({
			'goal_code': records[0].data.ConceptId,
			'goal_code_type': records[0].data.CodeType
		});
	},

	onPatientVitalsLoad: function(ctrl, encounter_record, vitals_records, vitals_store){

		if(!a('add_patient_interventions')){
			return;
		}

		var me = this,
			encounter_eid = encounter_record.get('eid'),
			patient_age_years = app.patient.age.DMY.years,

			underweight_found = vitals_store.findBy( function (vital_record) {
				var bmi = vital_record.get('bmi');
				return encounter_eid === vital_record.get('eid') && bmi > 1 && bmi <= 18.5;
			}) !== -1,
			overweight_found = vitals_store.findBy( function (vital_record) {
				var bmi = vital_record.get('bmi');
				return encounter_eid === vital_record.get('eid') && bmi >= 25;
			}) !== -1,
			intervention, params;

		// is adult of no overweight
		// if(patient_age_years < 18) return;

		if(overweight_found){
			intervention = me.bmi_overweight_intervention;
		}else if(underweight_found){
			intervention = me.bmi_underweight_intervention;
		}else{
			return;
		}

		params = {
			filter: [
				{
					property: 'pid',
					value: encounter_record.get('pid')
				},
				{
					property: 'code',
					value: intervention.code
				},
				{
					property: 'dx_code',
					value: intervention.dx_code
				},
				{
					property: 'create_date',
					operator: '>=',
					value: Ext.Date.format(Ext.Date.add(new Date(), Ext.Date.MONTH, intervention.threshold_in_months), 'Y-m-d 00:00:00')
				},
			]
		};

		Interventions.getPatientIntervention(params, function(response) {
			if(response.data === false){
				me.promptIntervention(intervention);
			}
		});

	},

	promptIntervention: function (intervention) {
		var me = this;

		Ext.Msg.show({
			title: intervention.description + ' Required',
			msg: 'Would you like to record this Intervention?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn === 'yes'){
					me.addAutoIntervention(intervention);
				}
			}
		});
	},

	addAutoIntervention: function (intervention) {
		var grid = this.getInterventionsGrid(),
			store = grid.getStore(),
			records;

		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			intervention_type: 'RecommendedNutrition',

			code: intervention.code,
			code_text: intervention.code_text,
			code_type: intervention.code_type,
			dx_code: intervention.dx_code,
			dx_code_text: intervention.dx_code_text,
			dx_code_type: intervention.dx_code_type,

			create_uid: app.user.id,
			create_date: app.getDate(),
			update_uid: app.user.id,
			update_date: app.getDate()
		});

		this.showInterventionsGrid();
		this.getInterventionForm().getForm().loadRecord(records[0]);
	}

});

Ext.define('App.controller.patient.Insurance', {
    extend: 'Ext.app.Controller',
    requires: [],
    refs: [
        {
            ref: 'PatientDemographicsPanel',
            selector: '#PatientDemographicsPanel'
        },
        {
            ref: 'PatientInsuranceFormSubscribeRelationshipCmb',
            selector: '#PatientInsuranceFormSubscribeRelationshipCmb'
        },
        {
            ref: 'PatientInsurancesPanel',
            selector: '#PatientInsurancesPanel'
        },
        {
            ref: 'PatientInsurancesForm',
            selector: '#PatientInsurancesForm'
        },
        {
            ref: 'PatientInsurancesPanelSaveBtn',
            selector: '#PatientInsurancesPanelSaveBtn'
        },
        {
            ref: 'PatientInsurancesPanelCancelBtn',
            selector: '#PatientInsurancesPanelCancelBtn'
        },
        {
            ref: 'InsuranceCardFirstNameField',
            selector: '#InsuranceCardFirstNameField'
        },
        {
            ref: 'InsuranceCardMiddleNameField',
            selector: '#InsuranceCardMiddleNameField'
        },
        {
            ref: 'InsuranceCardLastNameField',
            selector: '#InsuranceCardLastNameField'
        },
        {
            ref: 'InsuranceAddressSameAsPatientBtn',
            selector: '#InsuranceAddressSameAsPatientBtn'
        },


        {
            ref: 'BillingPatientInsuranceCoverInformationCoverGrid',
            selector: '#BillingPatientInsuranceCoverInformationCoverGrid'
        },
        {
            ref: 'BillingPatientInsuranceCoverInformationCoverGridUpdateDateField',
            selector: '#BillingPatientInsuranceCoverInformationCoverGridUpdateDateField'
        },
        {
            ref: 'BillingPatientInsuranceCoverInformationCoverExceptionSearchField',
            selector: '#BillingPatientInsuranceCoverInformationCoverExceptionSearchField'
        },
        {
            ref: 'BillingPatientInsuranceCoverInformationMspInsuranceTypeField',
            selector: '#BillingPatientInsuranceCoverInformationMspInsuranceTypeField'
        },
        {
            ref: 'BillingPatientInsuranceCoverInformationDeductibleField',
            selector: '#BillingPatientInsuranceCoverInformationDeductibleField'
        },
        {
            ref: 'PatientInsurancesFormIsActiveBtn',
            selector: '#PatientInsurancesFormIsActiveBtn'
        },

        // insurance window
        {
            ref: 'PatientInsurancesWindow',
            selector: '#PatientInsurancesWindow'
        }

    ],

    init: function () {
        var me = this;

        me.control({
            'viewport': {
                demographicsrecordload: me.onDemographicsRecordLoad
            },
            '#PatientInsurancesPanel': {
                beforeadd: me.onPatientInsurancesPanelBeforeAdd,
                newtabclick: me.onPatientInsurancesPanelNewTabClick
            },

            'patientinsuranceform': {
                loadrecord: me.onPatientInsurancesFormLoadRecord
            },

            '#PatientInsuranceFormSubscribeRelationshipCmb': {
                select: me.onPatientInsuranceFormSubscribeRelationshipCmbSelect
            },
            '#InsuranceAddressSameAsPatientBtn': {
                click: me.onInsuranceAddressSameAsPatientBtnClick
            },
            '#PatientInsurancesPanelSaveBtn': {
                click: me.onPatientInsurancesPanelSaveBtnClick
            },
            '#PatientInsurancesPanelCancelBtn': {
                click: me.onPatientInsurancesPanelCancelBtnClick
            },

            '#BillingPatientInsuranceCoverInformationCoverGrid': {
                edit: me.onBillingPatientInsuranceCoverInformationCoverGridEdit,
                validateedit: me.onBillingPatientInsuranceCoverInformationCoverGridValidateEdit
            },

            '#BillingPatientInsuranceCoverInformationCoverExceptionSearchField': {
                select: me.onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldSelect,
                change: me.onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldchange,
                render: me.onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldRender
            },
            '#BillingPatientInsuranceCoverInformationMspInsuranceTypeField': {
                select: me.onBillingPatientInsuranceCoverInformationMspInsuranceTypeFieldSelect
            },

            '#PatientInsurancesWindow': {
                show: me.onPatientInsurancesWindowShow
            },
            '#PatientInsurancesWindowSaveBtn': {
                click: me.onPatientInsurancesWindowSaveBtnClick
            },
            '#PatientInsurancesWindowCancelBtn': {
                click: me.onPatientInsurancesWindowCancelBtnClick
            },

            '#InsuranceSubscriberAddressCopyBtn': {
                click: me.onInsuranceSubscriberAddressCopyBtnClick
            },

            '#PatientInsurancesFormIsActiveCkBox': {
                change: me.onPatientInsurancesFormIsActiveCkBoxChange
            },

            '#PatientInsuranceFormScannerBtn': {
                click: me.onPatientInsuranceFormScannerBtnClick
            },
            '#PatientInsuranceFormScannerOcrBtn': {
                click: me.onPatientInsuranceFormScannerOcrBtnClick
            }

        });

        me.scannerCtrl = me.getController('Scanner');

        me.doPatientInsurancesWindowCloseBuffered = Ext.Function.createBuffered(me.doPatientInsurancesWindowClose, 250, me);
    },

    onPatientInsuranceFormScannerBtnClick: function (btn){

        var me = this,
            insurance_img_container = btn.up('#PatientInsuranceFormCardContainer'),
            insurance_img = insurance_img_container.down('image'),
            textareafield = insurance_img_container.down('textareafield');

        // say('onPatientInsuranceFormScannerBtnClick');
        // say(insurance_img_container);
        // say(insurance_img);

        me.scannerCtrl.showBasicScanWindow([], function (scanned_images){

            var img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function () {
                var imageData = me.trimImage(img);
                insurance_img.setSrc(imageData);
                insurance_img_container.doLayout();
            };
            img.src = 'data:image/jpeg;base64,' + scanned_images[0];
            textareafield.setValue('data:image/jpeg;base64,' + scanned_images[0]);

        });
    },

    onPatientInsuranceFormScannerOcrBtnClick: function (btn){
        var me = this,
            insurance_img_container = btn.up('#PatientInsuranceFormCardContainer'),
            insurance_img = insurance_img_container.down('image'),
            mask = new Ext.LoadMask({
                msg: 'Progress... 0%',
                target: insurance_img
            });

        mask.show();

        Tesseract.recognize(
            insurance_img.src,
            'eng',
            {
                logger: function (m){

                    say(m);

                    if(m.status === 'recognizing text'){
                        mask.msgTextEl.update(Ext.String.format('Progress... {0}%', Math.floor(m.progress * 100)));
                    }
                 }
            }
        ).then(function (data) {
            mask.hide();
            mask.destroy();
            me.onOcrComplete(data, insurance_img);
        });

    },

    onOcrComplete: function (data, insurance_img){
        say('onOcrComplete');
        say(data);
        say(insurance_img);



    },

    trimImage: function (imageObject) {

        var rbgThreshold = 255;
        var imgWidth = imageObject.width;
        var imgHeight = imageObject.height;
        var canvas = document.createElement('canvas');
        canvas.setAttribute("width", imgWidth);
        canvas.setAttribute("height", imgHeight);
        var context = canvas.getContext('2d');
        context.drawImage(imageObject, 0, 0);

        var imageData = context.getImageData(0, 0, imgWidth, imgHeight),
            data = imageData.data,
            getRBG = function(x, y) {
                var offset = imgWidth * y + x;
                return {
                    red:     data[offset * 4],
                    green:   data[offset * 4 + 1],
                    blue:    data[offset * 4 + 2],
                    opacity: data[offset * 4 + 3]
                };
            },
            isWhite = function (rgb) {
                // many images contain noise, as the white is not a pure #fff white
                return rgb.red > rbgThreshold && rgb.green > rbgThreshold && rgb.blue > rbgThreshold;
            },
            scanY = function (fromTop) {
                var offset = fromTop ? 1 : -1;

                // loop through each row
                for(var y = fromTop ? 0 : imgHeight - 1; fromTop ? (y < imgHeight) : (y > -1); y += offset) {

                    // loop through each column
                    for(var x = 0; x < imgWidth; x++) {
                        var rgb = getRBG(x, y);
                        if (!isWhite(rgb)) {
                            if (fromTop) {
                                return y;
                            } else {
                                return Math.min(y + 1, imgHeight);
                            }
                        }
                    }
                }
                return null; // all image is white
            },
            scanX = function (fromLeft) {
                var offset = fromLeft? 1 : -1;

                // loop through each column
                for(var x = fromLeft ? 0 : imgWidth - 1; fromLeft ? (x < imgWidth) : (x > -1); x += offset) {

                    // loop through each row
                    for(var y = 0; y < imgHeight; y++) {
                        var rgb = getRBG(x, y);
                        if (!isWhite(rgb)) {
                            if (fromLeft) {
                                return x;
                            } else {
                                return Math.min(x + 1, imgWidth);
                            }
                        }
                    }
                }
                return null; // all image is white
            };

        var cropTop = scanY(true),
            cropBottom = scanY(false),
            cropLeft = scanX(true),
            cropRight = scanX(false),
            cropWidth = cropRight - cropLeft,
            cropHeight = cropBottom - cropTop;

        canvas.setAttribute("width", cropWidth);
        canvas.setAttribute("height", cropHeight);
        // finally crop the guy

        context.drawImage(imageObject,
            cropLeft, cropTop, cropWidth, cropHeight,
            0, 0, cropWidth, cropHeight);

        return canvas.toDataURL();
    },


    onPatientInsurancesFormIsActiveCkBoxChange: function (field){

        var form = field.up('form').getForm(),
            values = form.getValues();


    },

    onInsuranceSubscriberAddressCopyBtnClick: function (btn){
        var form = btn.up('form').getForm(),
            values = form.getValues();

        form.setValues({
            physical_address: values.postal_address,
            physical_address_cont: values.postal_address_cont,
            physical_city: values.postal_city,
            physical_state: values.postal_state,
            physical_zip: values.postal_zip,
            physical_country: values.postal_country,
        });

        app.msg(_('info'), _('postal_address_copied'), 'blue');
    },

    onPatientInsurancesWindowSaveBtnClick: function(btn){

        var me = this,
            win = btn.up('window'),
            insurance_panel = btn.up('insurancestabpanel'),
            insuranceItems = insurance_panel.items;

        insuranceItems.each(function (form_panel) {

            var form = form_panel.getForm(),
                values = form.getValues(),
                record = form.getRecord();

            if (!form.isValid()) return;

            record.set(values);

            record.save({
                callback: function (saved_record) {
                    app.msg(_('sweet'), _('record_saved'));

                    var cover_grid_store = form_panel.down('grid').getStore(),
                        cover_grid_records = cover_grid_store.getRange();

                    for (var i = 0; i < cover_grid_records.length; i++) {
                        cover_grid_records[i].set({
                            patient_insurance_id: record.get('id')
                        });
                    }

                    if(Ext.Object.isEmpty(cover_grid_store.getModifiedRecords())){
                        me.updatePatientInsuranceForm(saved_record);
                        me.doPatientInsurancesWindowCloseBuffered(win);
                    }else{
                        cover_grid_store.sync({
                            success: function () {
                                me.updatePatientInsuranceForm(saved_record);
                                me.doPatientInsurancesWindowCloseBuffered(win);
                            }
                        });
                    }
                }
            });
        });
    },

    updatePatientInsuranceForm: function(){
        say('updatePatientInsuranceForm');

        this.patientInsurancePanelHandler(app.patient.record.insurance(), this.getPatientInsurancesPanel());
    },

    doPatientInsurancesWindowClose: function(win){
        win.close();
    },

    onPatientInsurancesWindowCancelBtnClick: function(btn){
        btn.up('window').close();
    },

    onPatientInsurancesWindowShow: function(win){
        var me = this,
            insurance_store = app.patient.record.insurance(),
            insurance_panel = win.down('insurancestabpanel');

        if(insurance_store.count() > 0){
            me.patientInsurancePanelHandler(insurance_store, insurance_panel);
        }else{
            insurance_store.load({
                filters: [
                    {
                        property: 'pid',
                        value: app.patient.record.get('pid')
                    }
                ],
                callback: function (records) {
                    me.patientInsurancePanelHandler(insurance_store, insurance_panel);
                }
            });
        }
    },

    showPatientInsurancesWindow: function(){
        if(!this.getPatientInsurancesWindow()){
            Ext.create('App.view.patient.windows.PatientInsurancesWindow');
        }
        return this.getPatientInsurancesWindow().show();
    },

    getActiveInsuranceFormPanel: function () {
        return this.getPatientInsurancesPanel().getActiveTab();
    },

    patientInsurancePanelHandler: function (insurance_store, insurance_panel) {

        say('patientInsurancePanelHandler');

        insurance_store.sort([
            {
                sorterFn: function (o1, o2) {
                    var getRank = function (o) {

                            var insurance_type = o.get('insurance_type'),
                                active = o.get('active');

                            if ((insurance_type === 'P') && (active)) {
                                return 1;
                            } else if ((insurance_type === 'C') && (active)) {
                                return 2;
                            } else if ((insurance_type === 'S') && (active)) {
                                return 3;
                            } else if ((insurance_type === 'T') && (active)) {
                                return 4;
                            } else {
                                return 5;
                            }
                        },
                        rank1 = getRank(o1),
                        rank2 = getRank(o2);

                    if (rank1 === rank2) {
                        return 0;
                    }

                    return rank1 < rank2 ? -1 : 1;
                }
            }
        ]);

        // set the insurance panel
        insurance_panel.removeAll(true);

        var insurance_records = insurance_store.data.items,
            items = [], i;

        for (i = 0; i < insurance_records.length; i++) {
            items.push({
                xtype: 'patientinsuranceform',
                closable: false,
                insurance: insurance_records[i],
                action: insurance_records[i].get('insurance_type')
            });
        }

        insurance_panel.add(items);

        say(insurance_panel);

        if (insurance_panel.items.length > 0) insurance_panel.setActiveTab(0);

    },

    onDemographicsRecordLoad: function (patient_record, patient_panel) {

        var me = this,
            insurance_store = app.patient.record.insurance(),
            insurance_panel = patient_panel.ownerCt.down('insurancestabpanel');

        insurance_store.load({
            filters: [
                {
                    property: 'pid',
                    value: patient_record.get('pid')
                }
            ],
            callback: function (records) {
                me.patientInsurancePanelHandler(insurance_store, insurance_panel);
            }
        });
    },

    insuranceFormLoadRecord: function (form, record) {
        form.getForm().loadRecord(record);
        app.fireEvent('insurancerecordload', form, record);
    },

    onPatientInsurancesFormLoadRecord: function (form, insurance_record) {
        var cover_grid = form.owner.down('grid'), //this.getBillingPatientInsuranceCoverInformationCoverGrid(),
            patient_id = insurance_record.get('pid'),
            patient_insurance_id = insurance_record.get('id');

        if (!cover_grid) return;

        cover_grid.getStore().load({
            filters: [
                {
                    property: 'patient_id',
                    value: patient_id
                },
                {
                    property: 'patient_insurance_id',
                    value: patient_insurance_id
                }
            ]
        })
    },

    getPatientInsurancesByType: function (insurance_type) {

        var me = this,
            insurance_panel = me.getPatientInsurancesPanel(),
            insurance_tabs = insurance_panel.query(Ext.String.format('panel[action={0}]', insurance_type)),
            insurance_records = [];

        for (var i = 0; i < insurance_tabs.length; i++) {
            insurance_records.push(insurance_tabs[0].insurance);
        }

        return insurance_records;

    },

    onPatientInsurancesPanelBeforeAdd: function (tapPanel, panel) {
        var me = this,
            form = panel.getForm(),
            record = panel.insurance || Ext.create('App.model.patient.Insurance', {pid: me.pid});

        me.insuranceFormLoadRecord(panel, record);

        if (record.get('image') !== '') panel.down('image').setSrc(record.get('image'));

        if (record.get('active')) {
            panel.setIcon('modules/billing/resources/images/icoDotGreen.png');
        } else {
            panel.setIcon('modules/billing/resources/images/icoDotRed.png');
        }
        panel.title = record.get('ins_synonym') + ' (' + (record.get('insurance_type') ? record.get('insurance_type') : _('new')) + ')' ;
        panel.header.hide(true);

    },

    onPatientInsurancesPanelNewTabClick: function (form) {

        var me = this,
            insurance_panel = me.getPatientInsurancesPanel(),
            insuranceTabs = insurance_panel.items.length;

        /**
         * 01 = Self
         */

        var record = Ext.create('App.model.patient.Insurance', {
            code: insuranceTabs + '~' + app.patient.pubpid,
            pid: app.patient.pid,

            card_name_same_as_patient: true,
            card_first_name: app.patient.record.get('fname'),
            card_middle_name: app.patient.record.get('mname'),
            card_last_name: app.patient.record.get('lname'),

            subscriber_relationship: '01',
            subscriber_title: app.patient.record.get('title'),
            subscriber_given_name: app.patient.record.get('fname'),
            subscriber_middle_name: app.patient.record.get('mname'),
            subscriber_surname: app.patient.record.get('lname'),
            subscriber_dob: app.patient.record.get('DOB'),
            subscriber_sex: app.patient.record.get('sex'),
            subscriber_phone: (app.patient.record.get('phone_mobile') || app.patient.record.get('phone_home')),
            subscriber_employer: app.patient.record.get('employer_name'),

            subscriber_street: app.patient.record.get('postal_address') + ', ' + app.patient.record.get('postal_address_cont'),
            subscriber_city: app.patient.record.get('postal_city'),
            subscriber_state: app.patient.record.get('postal_state'),
            subscriber_country: app.patient.record.get('postal_country'),
            subscriber_postal_code: app.patient.record.get('postal_zip'),

            active: true,
            create_uid: app.user.id,
            update_uid: app.user.id,
            create_date: new Date(),
            update_date: new Date()
        });

        // say('app.patient.record');
        // say(app.patient.record);

        this.insuranceFormLoadRecord(form, record);
    },

    onInsuranceAddressSameAsPatientBtnClick: function (field, value) {

        var insurance_form = field.up('form').getForm(),
            demographic_panel = this.getPatientDemographicsPanel(),
            demographic_form = demographic_panel.down('form').getForm(),
            demographic_values = demographic_form.getValues();

        insurance_form.setValues({
            subscriber_street: Ext.String.format('{0} {1}', demographic_values.postal_address,  demographic_values.postal_address_cont).trim(),
            subscriber_city: demographic_values.postal_city,
            subscriber_state: demographic_values.postal_state,
            subscriber_postal_code: demographic_values.postal_zip,
            subscriber_country: demographic_values.postal_country,
        });

        app.msg(_('info'), _('postal_address_copied'), 'blue');
    },

    onPatientInsuranceFormSubscribeRelationshipCmbSelect: function (cmb, records) {
        var form = cmb.up('form').getForm(),
            ins_record = form.getRecord();

        form.findField('subscriber_relationship').setValue(records[0].get('option_value'));

        /**
         * SEL = Self == 01
         */

        if (records[0].get('option_value') !== '01') return;

        form.findField('subscriber_title').setValue(app.patient.record.get('title'));
        form.findField('subscriber_given_name').setValue(app.patient.record.get('fname'));
        form.findField('subscriber_middle_name').setValue(app.patient.record.get('mname'));
        form.findField('subscriber_surname').setValue(app.patient.record.get('lname'));
        form.findField('subscriber_dob').setValue(app.patient.record.get('DOB'));
        form.findField('subscriber_sex').setValue(app.patient.record.get('sex'));
        form.findField('subscriber_phone').setValue(app.patient.record.get('phone_mobile') || app.patient.record.get('phone_home'));
        form.findField('subscriber_employer').setValue(app.patient.record.get('employer_name'));

        // this.getInsuranceAddressSameAsPatientField().setValue(true);

        // form.findField('subscriber_address_same_as_patient').setValue(true);
    },

    onPatientInsurancesPanelCancelBtnClick: function (btn) {
        var form_panel = this.getActiveInsuranceFormPanel();

        if (!form_panel) return;

        var form = form_panel.getForm(),
            record = form.getRecord();

        if (record.get('id') > 0) {
            form.reset();
            form.loadRecord(record);

            return;
        }

        this.getPatientInsurancesPanel().remove(form_panel);

    },


    /**
     * PATIENT INSURANCE COVER PANEL FUNCTIONS
     */

    onBillingPatientInsuranceCoverInformationCoverGridEdit: function (plugin, context) {

    },

    onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldchange: function (field, newValue, oldValue, eOpts) {

        if (newValue) { return; }

        var cover_grid = field.up('fieldset').down('grid'),
            cover_grid_store = cover_grid.getStore(),
            cover_grid_records = cover_grid_store.getRange();

        for (var c = 0; c < cover_grid_records.length; c++) {
            cover_grid_records[c].set({
                exception_copay: 0.00,
                exception_isDollar: true,
                exception: false
            });
        }
    },

    onBillingPatientInsuranceCoverInformationMspInsuranceTypeFieldSelect: function (field, selected_mspType) {

        if (field.value.length === 0) return;

        var me = this,
            cover_form = field.up('form'),
            insurance_form = cover_form.getForm(),
            insurance_form_record = insurance_form.getRecord();

        insurance_form_record.set({
            msp_insurance_type: selected_mspType[0].get('code')
        });

    },

    //***********************
    //*  NEEDS VALIDATION   *
    //***********************


    //Grid Functions (Elegibility Btn) has its own controller

    onBillingPatientInsuranceCoverInformationCoverGridValidateEdit: function (plugin, context) {

        if (context.field === 'copay') {
            var cover_record = context.record,
                prev_copay = cover_record.get('copay'),
                copay = context.value;

            cover_record.set({
                copay: copay,
                exception_copay: 0.00,
                exception_isDollar: false,
                exception: false,
                update_date: new Date(),
                update_uid: app.user.id
            });
        }

        if (context.field === 'exception_copay') {
            var cover_record = context.record,
                prev_e_copay = cover_record.get('exception_copay'),
                e_copay = context.value;

            cover_record.set({
                copay: 0.00,
                exception_copay: e_copay,
                exception_isDollar: true,
                exception: true,
                update_date: new Date(),
                update_uid: app.user.id
            });
        }


    },

    onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldRender: function(field){

        field.store.on('beforeload', function (store) {

            var insurance_id = field.up('form').getForm().findField('insurance_id').getValue();

            store.getProxy().extraParams = { insurance_id: insurance_id  };

        }, this);
    },

    onBillingPatientInsuranceCoverInformationCoverExceptionSearchFieldSelect: function (field, selected_cover) {

        if (field.value.length === 0) return;

        var me = this,
            cover_form = field.up('form'),
            insurance_form = cover_form.getForm(),
            insurance_form_record = insurance_form.getRecord();

        me.getBillingPatientInsuranceCoverInformationDeductibleField().setValue(selected_cover[0].get('deductible'));
        me.getBillingPatientInsuranceCoverInformationCoverExceptionSearchField().setValue(selected_cover[0].get('cover'));

        var cover_grid = field.up('fieldset').down('grid'),
            cover_grid_store = cover_grid.getStore(),
            cover_grid_records = cover_grid_store.getRange();

        BillingCover.getBillingCoverExceptionByCoverId(selected_cover[0].get('id'), function (response) {

            for (var c = 0; c < cover_grid_records.length; c++) {
                cover_grid_records[c].set({
                    exception_copay: 0.00,
                    exception_isDollar: true,
                    exception: false
                });
            }

            for (var r = 0; r < response.length; r++) {

                for (var i = 0; i < cover_grid_records.length; i++) {

                    if (cover_grid_records[i].get('service_type_id') === response[r].service_type_id ) {
                        cover_grid_records[i].set({
                            exception_copay: response[r].copay,
                            exception_isDollar: response[r].isDollar,
                            exception: true,
                            update_date: new Date(),
                            update_uid: app.user.id
                        });
                    }
                }
            }

        });
    },

    onPatientInsurancesPanelSaveBtnClick: function (btn) {
        var me = this,
            insurance_panel = btn.up('insurancestabpanel'),
            insuranceItems = insurance_panel.items;

        insuranceItems.each(function (form_panel) {

            var form = form_panel.getForm(),
                values = form.getValues(),
                record = form.getRecord();

            if (!form.isValid()) return;

            record.set(values);

            /**
             *  Instruccion en Comentario, si no, el Grid de Cubierta no ejecuta el save. CARLI
             *  if (Ext.Object.isEmpty(record.getChanges())) return;
             */

            record.save({

                callback: function () {

                    app.msg(_('sweet'), _('record_saved'));

                    var cover_grid_store = form_panel.down('grid').getStore(),
                        cover_grid_records = cover_grid_store.getRange();

                    for (var i = 0; i < cover_grid_records.length; i++) {

                        cover_grid_records[i].set({
                            patient_insurance_id: record.get('id')
                        });

                    }

                    cover_grid_store.sync({
                        success: function () {
                        }
                    });
                }

            });
        });
    }



});
Ext.define('App.controller.patient.LegalLetterSignatures', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientLegalLettersGrid',
			selector: '#PatientLegalLettersGrid'
		},
		{
			ref: 'PatientLegalLettersSignDocumentBtn',
			selector: '#PatientLegalLettersSignDocumentBtn'
		},

	],

	init: function(){
		var me = this;
		me.control({
			'#PatientLegalLettersGrid': {
				activate: me.onPatientLegalLettersGridActive,
				selectionchange: me.onPatientLegalLettersGridSelectionChange,
				itemdblclick: me.onPatientLegalLettersGridItemDblClick
			},
			'#PatientLegalLettersSignDocumentBtn': {
				click: me.onPatientLegalLettersSignDocumentBtnClick
			},
			'#PatientLegalLettersSignDocumentSaveBtn': {
				click: me.onPatientLegalLettersSignDocumentSaveBtnClick
			},
			'#PatientLegalLettersPreviewDocumentBtn': {
				click: me.onPatientLegalLettersPreviewDocumentBtnClick
			},
		});

	},

	onPatientLegalLettersSignDocumentBtnClick: function (btn){
		say('onPatientLegalLettersSignDocumentBtnClick')


		var me = this,
			letters = this.getPatientLegalLettersGrid().getSelectionModel().getSelection(),
			letters_to_sign = [];

		letters.forEach(function (letter){
			if(letter.get('signature') === ''){
				letters_to_sign.push({
					pid: app.patient.pid,
					id: letter.get('letter_id'),
					version: letter.get('letter_version'),
					content: letter.get('letter_content'),
					document_code: letter.get('document_code')
				});
			}
		});

		if(letters_to_sign.length === 0){
			return;
		}

		var win = Ext.create('Ext.window.Window', {
			title: 'Capture Signature',
			layout: 'fit',
			items: [
				{
					xtype: 'topazsignature',
					firstName: app.patient.fname,
					lastName: app.patient.lname,
					eMail: app.patient.email,
					height: 120,
					width: 400
				}
			],
			letters_to_sign: letters_to_sign,
			buttons: [
				{
					xtype: 'button',
					text: 'Topaz Download',
					href: 'http://www.topazsystems.com/Software/SigPlusExtLite.exe',
				},
				{
					xtype: 'button',
					text: 'Chrome Extension',
					href: 'https://chrome.google.com/webstore/detail/Topaz-SigPlusExtLiteback/dhcpobccjkdnmibckgpejmbpmpembgco',
				},
				'->',
				{
					text: _('save'),
					itemId: 'PatientLegalLettersSignDocumentSaveBtn'
				}
			]
		});

		win.show();
		win.StartSignature();

	},

	onPatientLegalLettersSignDocumentSaveBtnClick: function (btn) {

		var me = this,
			win =  btn.up('window'),
			signature_obj = win.down('topazsignature').signatureObj;

		if (!signature_obj) {
			app.msg(_('oops'), 'No signature found', true);
			return;
		}

		var signature = ("data:image/png;base64," + signature_obj.imageData);

		LegalLetters.doSignDocuments(win.letters_to_sign , signature, function (){
			win.close();
			me.getPatientLegalLettersGrid().getStore().reload();
		});

	},

	onPatientLegalLettersPreviewDocumentBtnClick: function (btn){

		var me = this,
			letters = this.getPatientLegalLettersGrid().getSelectionModel().getSelection(),
			letters_to_sign = [],
			signature = 'data:image/jpeg;base64,/9j/4QVRRXhpZgAATU0AKgAAAAgABwESAAMAAAABAAEAAAEaAAUAAAABAAAAYgEbAAUAAAABAAAAagEoAAMAAAABAAIAAAExAAIAAAAhAAAAcgEyAAIAAAAUAAAAk4dpAAQAAAABAAAAqAAAANQALcbAAAAnEAAtxsAAACcQQWRvYmUgUGhvdG9zaG9wIDIyLjIgKE1hY2ludG9zaCkAMjAyMTowOToyOCAyMDoyMzoxMQAAAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAligAwAEAAAAAQAAAMgAAAAAAAAABgEDAAMAAAABAAYAAAEaAAUAAAABAAABIgEbAAUAAAABAAABKgEoAAMAAAABAAIAAAIBAAQAAAABAAABMgICAAQAAAABAAAEFwAAAAAAAABIAAAAAQAAAEgAAAAB/9j/7QAMQWRvYmVfQ00AAf/uAA5BZG9iZQBkgAAAAAH/2wCEAAwICAgJCAwJCQwRCwoLERUPDAwPFRgTExUTExgRDAwMDAwMEQwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwBDQsLDQ4NEA4OEBQODg4UFA4ODg4UEQwMDAwMEREMDAwMDAwRDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDP/AABEIADAAkAMBIgACEQEDEQH/3QAEAAn/xAE/AAABBQEBAQEBAQAAAAAAAAADAAECBAUGBwgJCgsBAAEFAQEBAQEBAAAAAAAAAAEAAgMEBQYHCAkKCxAAAQQBAwIEAgUHBggFAwwzAQACEQMEIRIxBUFRYRMicYEyBhSRobFCIyQVUsFiMzRygtFDByWSU/Dh8WNzNRaisoMmRJNUZEXCo3Q2F9JV4mXys4TD03Xj80YnlKSFtJXE1OT0pbXF1eX1VmZ2hpamtsbW5vY3R1dnd4eXp7fH1+f3EQACAgECBAQDBAUGBwcGBTUBAAIRAyExEgRBUWFxIhMFMoGRFKGxQiPBUtHwMyRi4XKCkkNTFWNzNPElBhaisoMHJjXC0kSTVKMXZEVVNnRl4vKzhMPTdePzRpSkhbSVxNTk9KW1xdXl9VZmdoaWprbG1ub2JzdHV2d3h5ent8f/2gAMAwEAAhEDEQA/APVUkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJT//0PVUlzGR9aM6h2V0n0aj9YPtIo6fQRY2m2q7fbi9Qcdr3/ZsbGryPt/pPf8Ap8K+n1KvWoXTCY157pKXSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJT//R6nJ6X1+3Ou+srKy3qONaKsHp3qja/p7CWX0WuHp0syuoOc7OZ6nrfZ309Pp/wd66sGQDxPYrAf0n64F7iz6wUtaSS1v2BpgTo3d9qTfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKehSXPfsj65f/ADw0/wDuPb/71Jfsj65f/PDT/wC49v8A71JKf//Z/+0NSlBob3Rvc2hvcCAzLjAAOEJJTQQlAAAAAAAQAAAAAAAAAAAAAAAAAAAAADhCSU0EOgAAAAAA5QAAABAAAAABAAAAAAALcHJpbnRPdXRwdXQAAAAFAAAAAFBzdFNib29sAQAAAABJbnRlZW51bQAAAABJbnRlAAAAAENscm0AAAAPcHJpbnRTaXh0ZWVuQml0Ym9vbAAAAAALcHJpbnRlck5hbWVURVhUAAAAAQAAAAAAD3ByaW50UHJvb2ZTZXR1cE9iamMAAAAMAFAAcgBvAG8AZgAgAFMAZQB0AHUAcAAAAAAACnByb29mU2V0dXAAAAABAAAAAEJsdG5lbnVtAAAADGJ1aWx0aW5Qcm9vZgAAAAlwcm9vZkNNWUsAOEJJTQQ7AAAAAAItAAAAEAAAAAEAAAAAABJwcmludE91dHB1dE9wdGlvbnMAAAAXAAAAAENwdG5ib29sAAAAAABDbGJyYm9vbAAAAAAAUmdzTWJvb2wAAAAAAENybkNib29sAAAAAABDbnRDYm9vbAAAAAAATGJsc2Jvb2wAAAAAAE5ndHZib29sAAAAAABFbWxEYm9vbAAAAAAASW50cmJvb2wAAAAAAEJja2dPYmpjAAAAAQAAAAAAAFJHQkMAAAADAAAAAFJkICBkb3ViQG/gAAAAAAAAAAAAR3JuIGRvdWJAb+AAAAAAAAAAAABCbCAgZG91YkBv4AAAAAAAAAAAAEJyZFRVbnRGI1JsdAAAAAAAAAAAAAAAAEJsZCBVbnRGI1JsdAAAAAAAAAAAAAAAAFJzbHRVbnRGI1B4bEBywAAAAAAAAAAACnZlY3RvckRhdGFib29sAQAAAABQZ1BzZW51bQAAAABQZ1BzAAAAAFBnUEMAAAAATGVmdFVudEYjUmx0AAAAAAAAAAAAAAAAVG9wIFVudEYjUmx0AAAAAAAAAAAAAAAAU2NsIFVudEYjUHJjQFkAAAAAAAAAAAAQY3JvcFdoZW5QcmludGluZ2Jvb2wAAAAADmNyb3BSZWN0Qm90dG9tbG9uZwAAAAAAAAAMY3JvcFJlY3RMZWZ0bG9uZwAAAAAAAAANY3JvcFJlY3RSaWdodGxvbmcAAAAAAAAAC2Nyb3BSZWN0VG9wbG9uZwAAAAAAOEJJTQPtAAAAAAAQASwAAAABAAEBLAAAAAEAAThCSU0EJgAAAAAADgAAAAAAAAAAAAA/gAAAOEJJTQQNAAAAAAAEAAAAWjhCSU0EGQAAAAAABAAAAB44QklNA/MAAAAAAAkAAAAAAAAAAAEAOEJJTScQAAAAAAAKAAEAAAAAAAAAAThCSU0D9QAAAAAASAAvZmYAAQBsZmYABgAAAAAAAQAvZmYAAQChmZoABgAAAAAAAQAyAAAAAQBaAAAABgAAAAAAAQA1AAAAAQAtAAAABgAAAAAAAThCSU0D+AAAAAAAcAAA/////////////////////////////wPoAAAAAP////////////////////////////8D6AAAAAD/////////////////////////////A+gAAAAA/////////////////////////////wPoAAA4QklNBAAAAAAAAAIAAjhCSU0EAgAAAAAABgAAAAAAADhCSU0EMAAAAAAAAwEBAQA4QklNBC0AAAAAAAIAADhCSU0ECAAAAAAAEAAAAAEAAAJAAAACQAAAAAA4QklNBB4AAAAAAAQAAAAAOEJJTQQaAAAAAANJAAAABgAAAAAAAAAAAAAAyAAAAlgAAAAKAFUAbgB0AGkAdABsAGUAZAAtADEAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAlgAAADIAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAEAAAAAAABudWxsAAAAAgAAAAZib3VuZHNPYmpjAAAAAQAAAAAAAFJjdDEAAAAEAAAAAFRvcCBsb25nAAAAAAAAAABMZWZ0bG9uZwAAAAAAAAAAQnRvbWxvbmcAAADIAAAAAFJnaHRsb25nAAACWAAAAAZzbGljZXNWbExzAAAAAU9iamMAAAABAAAAAAAFc2xpY2UAAAASAAAAB3NsaWNlSURsb25nAAAAAAAAAAdncm91cElEbG9uZwAAAAAAAAAGb3JpZ2luZW51bQAAAAxFU2xpY2VPcmlnaW4AAAANYXV0b0dlbmVyYXRlZAAAAABUeXBlZW51bQAAAApFU2xpY2VUeXBlAAAAAEltZyAAAAAGYm91bmRzT2JqYwAAAAEAAAAAAABSY3QxAAAABAAAAABUb3AgbG9uZwAAAAAAAAAATGVmdGxvbmcAAAAAAAAAAEJ0b21sb25nAAAAyAAAAABSZ2h0bG9uZwAAAlgAAAADdXJsVEVYVAAAAAEAAAAAAABudWxsVEVYVAAAAAEAAAAAAABNc2dlVEVYVAAAAAEAAAAAAAZhbHRUYWdURVhUAAAAAQAAAAAADmNlbGxUZXh0SXNIVE1MYm9vbAEAAAAIY2VsbFRleHRURVhUAAAAAQAAAAAACWhvcnpBbGlnbmVudW0AAAAPRVNsaWNlSG9yekFsaWduAAAAB2RlZmF1bHQAAAAJdmVydEFsaWduZW51bQAAAA9FU2xpY2VWZXJ0QWxpZ24AAAAHZGVmYXVsdAAAAAtiZ0NvbG9yVHlwZWVudW0AAAARRVNsaWNlQkdDb2xvclR5cGUAAAAATm9uZQAAAAl0b3BPdXRzZXRsb25nAAAAAAAAAApsZWZ0T3V0c2V0bG9uZwAAAAAAAAAMYm90dG9tT3V0c2V0bG9uZwAAAAAAAAALcmlnaHRPdXRzZXRsb25nAAAAAAA4QklNBCgAAAAAAAwAAAACP/AAAAAAAAA4QklNBBQAAAAAAAQAAAADOEJJTQQMAAAAAAQzAAAAAQAAAJAAAAAwAAABsAAAUQAAAAQXABgAAf/Y/+0ADEFkb2JlX0NNAAH/7gAOQWRvYmUAZIAAAAAB/9sAhAAMCAgICQgMCQkMEQsKCxEVDwwMDxUYExMVExMYEQwMDAwMDBEMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAQ0LCw0ODRAODhAUDg4OFBQODg4OFBEMDAwMDBERDAwMDAwMEQwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAwAJADASIAAhEBAxEB/90ABAAJ/8QBPwAAAQUBAQEBAQEAAAAAAAAAAwABAgQFBgcICQoLAQABBQEBAQEBAQAAAAAAAAABAAIDBAUGBwgJCgsQAAEEAQMCBAIFBwYIBQMMMwEAAhEDBCESMQVBUWETInGBMgYUkaGxQiMkFVLBYjM0coLRQwclklPw4fFjczUWorKDJkSTVGRFwqN0NhfSVeJl8rOEw9N14/NGJ5SkhbSVxNTk9KW1xdXl9VZmdoaWprbG1ub2N0dXZ3eHl6e3x9fn9xEAAgIBAgQEAwQFBgcHBgU1AQACEQMhMRIEQVFhcSITBTKBkRShsUIjwVLR8DMkYuFygpJDUxVjczTxJQYWorKDByY1wtJEk1SjF2RFVTZ0ZeLys4TD03Xj80aUpIW0lcTU5PSltcXV5fVWZnaGlqa2xtbm9ic3R1dnd4eXp7fH/9oADAMBAAIRAxEAPwD1VJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSU//9D1VJcxkfWjOodldJ9Go/WD7SKOn0EWNptqu324vUHHa9/2bGxq8j7f6T3/AKfCvp9Sr1qF0wmNee6Sl0kkklKSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSU//0epyel9ftzrvrKyst6jjWirB6d6o2v6ewll9Frh6dLMrqDnOzmep632d9PT6f8HeurBkA8T2KwH9J+uBe4s+sFLWkktb9gaYE6N3fak37I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSnoUlz37I+uX/wA8NP8A7j2/+9SX7I+uX/zw0/8AuPb/AO9SSn//2QA4QklNBCEAAAAAAFcAAAABAQAAAA8AQQBkAG8AYgBlACAAUABoAG8AdABvAHMAaABvAHAAAAAUAEEAZABvAGIAZQAgAFAAaABvAHQAbwBzAGgAbwBwACAAMgAwADIAMQAAAAEAOEJJTQQGAAAAAAAHAAgBAQABAQD/4Q7faHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA2LjAtYzAwNiA3OS4xNjQ2NDgsIDIwMjEvMDEvMTItMTU6NTI6MjkgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMi4yIChNYWNpbnRvc2gpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMS0wOS0yOFQyMDoyMzoxMS0wNDowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMS0wOS0yOFQyMDoyMzoxMS0wNDowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjEtMDktMjhUMjA6MjM6MTEtMDQ6MDAiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6YzgzZmUzYmEtNTBkYi00ZDdjLTkzNGUtNjQ3MWQyZTg4MDFlIiB4bXBNTTpEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6ZjYyYWNiM2QtZTkwMC05MjQzLThlZjEtN2QyZGQ4MjZiYWMyIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6MjI1NzEyYmQtY2U5Mi00MDNiLWFhNTUtNTc1N2Y0YTkyOTE3IiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiIGRjOmZvcm1hdD0iaW1hZ2UvanBlZyI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MjI1NzEyYmQtY2U5Mi00MDNiLWFhNTUtNTc1N2Y0YTkyOTE3IiBzdEV2dDp3aGVuPSIyMDIxLTA5LTI4VDIwOjIzOjExLTA0OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjIuMiAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6YzgzZmUzYmEtNTBkYi00ZDdjLTkzNGUtNjQ3MWQyZTg4MDFlIiBzdEV2dDp3aGVuPSIyMDIxLTA5LTI4VDIwOjIzOjExLTA0OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjIuMiAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPHBob3Rvc2hvcDpUZXh0TGF5ZXJzPiA8cmRmOkJhZz4gPHJkZjpsaSBwaG90b3Nob3A6TGF5ZXJOYW1lPSJYICAgICAgICAiIHBob3Rvc2hvcDpMYXllclRleHQ9IlggICAgICAgICIvPiA8cmRmOmxpIHBob3Rvc2hvcDpMYXllck5hbWU9Il9fX19fX19fX19fXyIgcGhvdG9zaG9wOkxheWVyVGV4dD0iX19fX19fX19fX19fIi8+IDwvcmRmOkJhZz4gPC9waG90b3Nob3A6VGV4dExheWVycz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPD94cGFja2V0IGVuZD0idyI/Pv/iDFhJQ0NfUFJPRklMRQABAQAADEhMaW5vAhAAAG1udHJSR0IgWFlaIAfOAAIACQAGADEAAGFjc3BNU0ZUAAAAAElFQyBzUkdCAAAAAAAAAAAAAAABAAD21gABAAAAANMtSFAgIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEWNwcnQAAAFQAAAAM2Rlc2MAAAGEAAAAbHd0cHQAAAHwAAAAFGJrcHQAAAIEAAAAFHJYWVoAAAIYAAAAFGdYWVoAAAIsAAAAFGJYWVoAAAJAAAAAFGRtbmQAAAJUAAAAcGRtZGQAAALEAAAAiHZ1ZWQAAANMAAAAhnZpZXcAAAPUAAAAJGx1bWkAAAP4AAAAFG1lYXMAAAQMAAAAJHRlY2gAAAQwAAAADHJUUkMAAAQ8AAAIDGdUUkMAAAQ8AAAIDGJUUkMAAAQ8AAAIDHRleHQAAAAAQ29weXJpZ2h0IChjKSAxOTk4IEhld2xldHQtUGFja2FyZCBDb21wYW55AABkZXNjAAAAAAAAABJzUkdCIElFQzYxOTY2LTIuMQAAAAAAAAAAAAAAEnNSR0IgSUVDNjE5NjYtMi4xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYWVogAAAAAAAA81EAAQAAAAEWzFhZWiAAAAAAAAAAAAAAAAAAAAAAWFlaIAAAAAAAAG+iAAA49QAAA5BYWVogAAAAAAAAYpkAALeFAAAY2lhZWiAAAAAAAAAkoAAAD4QAALbPZGVzYwAAAAAAAAAWSUVDIGh0dHA6Ly93d3cuaWVjLmNoAAAAAAAAAAAAAAAWSUVDIGh0dHA6Ly93d3cuaWVjLmNoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGRlc2MAAAAAAAAALklFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQgAAAAAAAAAAAAAALklFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQgAAAAAAAAAAAAAAAAAAAAAAAAAAAABkZXNjAAAAAAAAACxSZWZlcmVuY2UgVmlld2luZyBDb25kaXRpb24gaW4gSUVDNjE5NjYtMi4xAAAAAAAAAAAAAAAsUmVmZXJlbmNlIFZpZXdpbmcgQ29uZGl0aW9uIGluIElFQzYxOTY2LTIuMQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdmlldwAAAAAAE6T+ABRfLgAQzxQAA+3MAAQTCwADXJ4AAAABWFlaIAAAAAAATAlWAFAAAABXH+dtZWFzAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAACjwAAAAJzaWcgAAAAAENSVCBjdXJ2AAAAAAAABAAAAAAFAAoADwAUABkAHgAjACgALQAyADcAOwBAAEUASgBPAFQAWQBeAGMAaABtAHIAdwB8AIEAhgCLAJAAlQCaAJ8ApACpAK4AsgC3ALwAwQDGAMsA0ADVANsA4ADlAOsA8AD2APsBAQEHAQ0BEwEZAR8BJQErATIBOAE+AUUBTAFSAVkBYAFnAW4BdQF8AYMBiwGSAZoBoQGpAbEBuQHBAckB0QHZAeEB6QHyAfoCAwIMAhQCHQImAi8COAJBAksCVAJdAmcCcQJ6AoQCjgKYAqICrAK2AsECywLVAuAC6wL1AwADCwMWAyEDLQM4A0MDTwNaA2YDcgN+A4oDlgOiA64DugPHA9MD4APsA/kEBgQTBCAELQQ7BEgEVQRjBHEEfgSMBJoEqAS2BMQE0wThBPAE/gUNBRwFKwU6BUkFWAVnBXcFhgWWBaYFtQXFBdUF5QX2BgYGFgYnBjcGSAZZBmoGewaMBp0GrwbABtEG4wb1BwcHGQcrBz0HTwdhB3QHhgeZB6wHvwfSB+UH+AgLCB8IMghGCFoIbgiCCJYIqgi+CNII5wj7CRAJJQk6CU8JZAl5CY8JpAm6Cc8J5Qn7ChEKJwo9ClQKagqBCpgKrgrFCtwK8wsLCyILOQtRC2kLgAuYC7ALyAvhC/kMEgwqDEMMXAx1DI4MpwzADNkM8w0NDSYNQA1aDXQNjg2pDcMN3g34DhMOLg5JDmQOfw6bDrYO0g7uDwkPJQ9BD14Peg+WD7MPzw/sEAkQJhBDEGEQfhCbELkQ1xD1ERMRMRFPEW0RjBGqEckR6BIHEiYSRRJkEoQSoxLDEuMTAxMjE0MTYxODE6QTxRPlFAYUJxRJFGoUixStFM4U8BUSFTQVVhV4FZsVvRXgFgMWJhZJFmwWjxayFtYW+hcdF0EXZReJF64X0hf3GBsYQBhlGIoYrxjVGPoZIBlFGWsZkRm3Gd0aBBoqGlEadxqeGsUa7BsUGzsbYxuKG7Ib2hwCHCocUhx7HKMczBz1HR4dRx1wHZkdwx3sHhYeQB5qHpQevh7pHxMfPh9pH5Qfvx/qIBUgQSBsIJggxCDwIRwhSCF1IaEhziH7IiciVSKCIq8i3SMKIzgjZiOUI8Ij8CQfJE0kfCSrJNolCSU4JWgllyXHJfcmJyZXJocmtyboJxgnSSd6J6sn3CgNKD8ocSiiKNQpBik4KWspnSnQKgIqNSpoKpsqzysCKzYraSudK9EsBSw5LG4soizXLQwtQS12Last4S4WLkwugi63Lu4vJC9aL5Evxy/+MDUwbDCkMNsxEjFKMYIxujHyMioyYzKbMtQzDTNGM38zuDPxNCs0ZTSeNNg1EzVNNYc1wjX9Njc2cjauNuk3JDdgN5w31zgUOFA4jDjIOQU5Qjl/Obw5+To2OnQ6sjrvOy07azuqO+g8JzxlPKQ84z0iPWE9oT3gPiA+YD6gPuA/IT9hP6I/4kAjQGRApkDnQSlBakGsQe5CMEJyQrVC90M6Q31DwEQDREdEikTORRJFVUWaRd5GIkZnRqtG8Ec1R3tHwEgFSEtIkUjXSR1JY0mpSfBKN0p9SsRLDEtTS5pL4kwqTHJMuk0CTUpNk03cTiVObk63TwBPSU+TT91QJ1BxULtRBlFQUZtR5lIxUnxSx1MTU19TqlP2VEJUj1TbVShVdVXCVg9WXFapVvdXRFeSV+BYL1h9WMtZGllpWbhaB1pWWqZa9VtFW5Vb5Vw1XIZc1l0nXXhdyV4aXmxevV8PX2Ffs2AFYFdgqmD8YU9homH1YklinGLwY0Njl2PrZEBklGTpZT1lkmXnZj1mkmboZz1nk2fpaD9olmjsaUNpmmnxakhqn2r3a09rp2v/bFdsr20IbWBtuW4SbmtuxG8eb3hv0XArcIZw4HE6cZVx8HJLcqZzAXNdc7h0FHRwdMx1KHWFdeF2Pnabdvh3VnezeBF4bnjMeSp5iXnnekZ6pXsEe2N7wnwhfIF84X1BfaF+AX5ifsJ/I3+Ef+WAR4CogQqBa4HNgjCCkoL0g1eDuoQdhICE44VHhauGDoZyhteHO4efiASIaYjOiTOJmYn+imSKyoswi5aL/IxjjMqNMY2Yjf+OZo7OjzaPnpAGkG6Q1pE/kaiSEZJ6kuOTTZO2lCCUipT0lV+VyZY0lp+XCpd1l+CYTJi4mSSZkJn8mmia1ZtCm6+cHJyJnPedZJ3SnkCerp8dn4uf+qBpoNihR6G2oiailqMGo3aj5qRWpMelOKWpphqmi6b9p26n4KhSqMSpN6mpqhyqj6sCq3Wr6axcrNCtRK24ri2uoa8Wr4uwALB1sOqxYLHWskuywrM4s660JbSctRO1irYBtnm28Ldot+C4WbjRuUq5wro7urW7LrunvCG8m70VvY++Cr6Evv+/er/1wHDA7MFnwePCX8Lbw1jD1MRRxM7FS8XIxkbGw8dBx7/IPci8yTrJuco4yrfLNsu2zDXMtc01zbXONs62zzfPuNA50LrRPNG+0j/SwdNE08bUSdTL1U7V0dZV1tjXXNfg2GTY6Nls2fHadtr724DcBdyK3RDdlt4c3qLfKd+v4DbgveFE4cziU+Lb42Pj6+Rz5PzlhOYN5pbnH+ep6DLovOlG6dDqW+rl63Dr++yG7RHtnO4o7rTvQO/M8Fjw5fFy8f/yjPMZ86f0NPTC9VD13vZt9vv3ivgZ+Kj5OPnH+lf65/t3/Af8mP0p/br+S/7c/23////uACFBZG9iZQBkQAAAAAEDABADAgMGAAAAAAAAAAAAAAAA/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQEBAQECAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wgARCADIAlgDAREAAhEBAxEB/8QAhQABAAMBAQAAAAAAAAAAAAAAAAkKCwgGAQEAAAAAAAAAAAAAAAAAAAAAEAADAAICAQUBAAAAAAAAAAAAGQoICQYHYHCgAgMFBBEAAAUEAwAABgIDAQAAAAAAAgMEBQYAAQcIN9iZYBESExQJIhVwoBYnEgEAAAAAAAAAAAAAAAAAAACg/9oADAMBAQIRAxEAAAC/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADPrLsB1oZ6RepOhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARAFNgtblfAv8AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM3sjvNVY98AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADPFIYzWaPeAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAET5TsLGpCWX8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADM8NBs6oMyI0KTrQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGYIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAafYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/9oACAECAAEFAPep/wD/2gAIAQMAAQUA96n/AP/aAAgBAQABBQD2DW+TaBvP1JZ8YL5g9ZZ7YoG4mizYJ+3syxS4Z3x1/jv4Nu+1kfh7TcEpLdlP7+J+VtEu0j4azMCpANTnz/Q+/wAIrP1j8gxayQ/K5ZlZVHtO6r6v4D0l1r4RWhsm5Zkb31xD+PKKX/b91b2dwPurrbwfc/st4tqzwYkv1y8pyqyipe1TfXsawfjx2vfD7v5vB96nW+1bcTs0wkxH6xwTxVN22m3NbCbaXgxkNznKfFT1cWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2SC07JBadkgtOyQWnZILTskFp2Sei//9oACAECAgY/AGp//9oACAEDAgY/AGp//9oACAEBAQY/AP8AQaLaIhtoCR6l5dWCyxru1S7X/WFzal0WbHRtMneD5O/NOGmOcnggbuuA2jUFOpTydH17epu4fnHGHgwpthiVSXeK5dhqB8VMglqNc4wuVp/qb5nAn4xCceQB9hknSqm9Ta1/kIZH3A/wGG96tpN+o/KqePMEHlbLr0AUbxfhXJrxnbY94kRTI/p2p3y7C5q3tsdjEjVEx1D+J+AQarSLlh6hQlOSiT4liuz+YTs87Bt8PazMvZQFFoPC0UgnS4r89/IY43juMxGLt0bZFykSFuuWiAecjTlmqBDPGYO/wNP8JIUzamzhCbnZQ1vky80tEU1ZXj7asKSR5zc7plJiSL5Ba1B7M4/xEAmykpX9AjEhXynX6v8AYY9dFoZniYOxeN26VCVN6vGm00XsJieYAqQKiLf1YsoNrQJvNKOGXcuQNCJOWXc1cbepQtgL8W3bN7Dhd8R6/lplact4jC1e2CtM8uJ0xpCv6isZMSwJyUYyhEXe1beUZ/AwVqef2uZ7jpik4SqSwjUdG+lEqhqVIhOMcylnAFzDz1H5AVAlkaaTDgAM+uzod9N7XSnX+CIP+1fWlE6xWMZcnLLfMTnDvy0CnF+zDCIh4h+VEipBcImK2TC2f741Zf2glyZtMOMMuqcyrD17hs5SKYJB4PiLH0fyeqiCsxQw4lxNBELSrzzlBsTu1j2kiYZVyW9KgNAPxB3Ac5MzequpTtw1VQPD+LIw1wvG+MomxQeDxRmIsnbGCMRtuTtTQ2pS7fMQgp0aYNhDHcRho/mMYhDEIV/gjGn6etYDlcp/pJzBlmcG2ODCYsyBnuWqECTEWFkKktcWlWJ4taQELl6c21yhvq9GAVyz2wdr4/XZEsolzQyRyMHTk2JJyEjHn/WzKaJrMnrXGiXByEUJfG5O0KC0YFSlOEEmjJBw72TXCIcDy9i6Stsyxxk2Ix+dQeVNB1j21/i0obEzwyuiUfysKwFaBWAVwCsEwsV7hGEIrXtb4HyLsCea3L8tv/8A5trxDlv2T7yjL8kQrRMytWgMMLupjMJQJVD27XvcIRo0N04RffUEAHk79s+yydzljXjCcSm2KXqUlHGnZL2cnFljtkHKKkRxYErwHHrbIzRhNuAZd5C8FHkiApbBfQ45ExnH/wA7aTU1DJMl4r/r04BO89hVkBazJuIv4lDPXnyBqaSnBnJD8zbvbcQQXcAFij6339Vma5KAJ6b/AKXJeorm8L0RFjUohHSDKGEm4BgCFKtWScYsljUVYR5tyRPFriAUQmL+CI5jfHmj+58U1XxnNm/X/AMtnusec4filMW+yRvZ8g7ETSVvECSMzLHJS8lhV3cVBwCk0Xa0V7hCbY+5mEtUMRJQlw3DUIbY1Z1GiRoXGYSMVhr5jPn8lCWUlFI53K1ix2XiAGwPyVY7AtYFghtTZtv+sbXnYOfQXJEwT7LY5cNaMSZGykbgfNLXI07vOYi8ooEwyL/mmNdKzrO7OmVATtyhrczW1MWMlvPADDebspYRybrjlSWxVMHJ+FctQKb45lsCyC1CG1yxrKYsgMEckCuMHu6QxQzuAk1i1zYcSba/13GEP+XORt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3ciuRt//AFig3cj/AAv/AP/Z';

		letters.forEach(function (letter){
			letters_to_sign.push({
				pid: app.patient.pid,
				id: letter.get('letter_id'),
				version: letter.get('letter_version'),
				content: letter.get('letter_content'),
				document_code: letter.get('document_code'),
				facility_id: app.user.facility
			});
		});

		LegalLetters.doPreviewDocuments(letters_to_sign, signature, function (document_ids){
			document_ids.forEach(function (document_id){
				app.onDocumentView(document_id, 'temp');
			});
		});

	},

	onPatientLegalLettersGridSelectionChange: function (grid, selection){
		var disabled = true;

		selection.forEach(function (record){
			if(!disabled) return;
			disabled = record.get('signature') !== '';
		});

		this.getPatientLegalLettersSignDocumentBtn().setDisabled(disabled);
	},

	onPatientLegalLettersGridItemDblClick: function (grid, signature_record){
		var document_id = signature_record.get('document_id');

		if(document_id > 0){
			app.onDocumentView(signature_record.get('document_id'));
		}

	},

	onPatientLegalLettersGridActive: function (grid){

		var store = grid.getStore();

		store.getProxy().extraParams = { include_not_signed: true };
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);

		this.getLegalLettersToSign(store)

	},

	getLegalLettersToSign: function (store){

		var me = this;

		LegalLetters.getLegalLettersToSignByPid(
			app.patient.pid,
			app.user.facility,
			'PRE-REGISTRATION',
			function (letters){

				letters.forEach(function (letter){
					store.add({
						letter_id: letter.id,
						letter_version: letter.version,
						letter_title: letter.title,
						letter_content: letter.content,
						document_code: letter.document_code,
						pid: app.patient.pid,
						signature: ''
					});
				});
			}
		);
	}

});

Ext.define('App.controller.patient.Medical', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'MedicalWindow',
			selector: '#MedicalWindow'
		},
		{
			ref: 'EncounterMedicalToolbar',
			selector: '#EncounterMedicalToolbar'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				'navkey': me.onNavKey
			},
			'#MedicalWindow #immunization': {
				'show': me.onPanelShow
			},
			'#MedicalWindow #allergies': {
				'show': me.onPanelShow
			},
			'#MedicalWindow #activeproblems': {
				'show': me.onPanelShow
			},
            '#MedicalWindow #familyhistory': {
                'show': me.onPanelShow
            },
            '#MedicalWindow #patientprocedureshistorygrid': {
                'show': me.onPanelShow
            },
            '#MedicalWindow #advancedirectives': {
                'show': me.onPanelShow
            },
			'#MedicalWindow #medications': {
				'show': me.onPanelShow
			},
			'#MedicalWindow #laboratories': {
				'show': me.onPanelShow
			},
			'#MedicalWindow #socialhistory': {
				'show': me.onPanelShow
			},
			'#MedicalWindow #referrals': {
				'show': me.onPanelShow
			}
		});

		me.items_indexes = Ext.state.Manager.get('appmedicalwinodwtaborder') || {};
	},

	onMedicalPanelIndexChange: function (items_indexes) {
		this.items_indexes = items_indexes;
		Ext.state.Manager.set('appmedicalwinodwtaborder' , items_indexes);
	},

	onMedicalWindowTabPanelDrop: function (plugin, container, dragCmp, startIdx, idx, eOpts) {
		var tabs = container.items.items,
			items_indexes = {};

		tabs.forEach(function (tab, i) {
			items_indexes[tab.card.itemId] = i;
		});

		this.onMedicalPanelIndexChange(items_indexes);

		this.reorderEnvounterMedicalToolbar(startIdx, idx);

	},

	reorderEnvounterMedicalToolbar: function (startIdx, idx) {

		say('reorderEnvounterMedicalToolbar');
		say(startIdx);
		say(idx);

		var toobar = this.getEncounterMedicalToolbar(),
			removeBtn = toobar.remove(startIdx, false);

		toobar.insert(idx, removeBtn);
		toobar.doLayout();
	},

	getMedicalTabButtons: function () {

		var buttons = [],
			index,
			outofindex = 100;

		if(a('access_patient_immunizations')) {
			index = this.items_indexes['immunization'] !== undefined ? this.items_indexes['immunization'] : outofindex++;

			Ext.Array.insert(buttons, index, [
				{
					text: _('vaccs') + ' ',
					action: 'immunization',
					margin: '0 3 0 0',
					tooltip: _('vaccines_immunizations'),
					style: {
						backgroundColor: g('immunizations_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_immunizations')
				}
			]);
		}

		if(a('access_patient_allergies')) {
			index = this.items_indexes['allergies'] !== undefined ? this.items_indexes['allergies'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('al') + ' ',
					action: 'allergies',
					margin: '0 3 0 0',
					tooltip: _('allergies'),
					style: {
						backgroundColor: g('allergies_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_allergies')
				}
			]);
		}

		if(a('access_active_problems')) {
			index = this.items_indexes['activeproblems'] !== undefined ? this.items_indexes['activeproblems'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('act_prob') + ' ',
					action: 'activeproblems',
					margin: '0 3 0 0',
					tooltip: _('active_problems'),
					style: {
						backgroundColor: g('problems_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_active_problems')
				}
			]);
		}

		if(a('access_family_history')) {
			index = this.items_indexes['familyhistory'] !== undefined ? this.items_indexes['familyhistory'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('fam_hx') + ' ',
					action: 'familyhistory',
					margin: '0 3 0 0',
					tooltip: _('family_history'),
					style: {
						backgroundColor: g('family_history_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_family_history')
				}
			]);
		}

		if(a('access_procedures_history')) {
			index = this.items_indexes['procedureshistory'] !== undefined ? this.items_indexes['procedureshistory'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('proc_hx') + ' ',
					action: 'procedureshistory',
					margin: '0 3 0 0',
					tooltip: _('procedure_history'),
					style: {
						backgroundColor: g('procedure_history_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_procedures_history')
				}
			]);
		}

		if(a('access_patient_advance_directive')) {
			index = this.items_indexes['advancedirectives'] !== undefined ? this.items_indexes['advancedirectives'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('adv_dir') + ' ',
					action: 'advancedirectives',
					margin: '0 3 0 0',
					tooltip: _('advance_directives'),
					style: {
						backgroundColor: g('advance_directive_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_advance_directive')
				}
			]);
		}

		if(a('access_patient_medications')) {
			index = this.items_indexes['medications'] !== undefined ? this.items_indexes['medications'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('meds') + ' ',
					action: 'medications',
					margin: '0 3 0 0',
					tooltip: _('medications'),
					style: {
						backgroundColor: g('medications_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_medications')
				}
			]);
		}

		if(a('access_patient_results')) {
			index = this.items_indexes['laboratories'] !== undefined ? this.items_indexes['laboratories'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('res') + ' ',
					action: 'laboratories',
					margin: '0 3 0 0',
					tooltip: _('results'),
					style: {
						backgroundColor: g('results_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_results')
				}
			]);
		}

		if(a('access_patient_social_history')) {
			index = this.items_indexes['social'] !== undefined ? this.items_indexes['social'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('soc_hx') + ' ',
					action: 'social',
					margin: '0 3 0 0',
					tooltip: _('social_history'),
					style: {
						backgroundColor: g('social_history_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_social_history')
				}
			]);
		}

		if(a('access_patient_functional_status')) {
			index = this.items_indexes['functionalstatus'] !== undefined ? this.items_indexes['functionalstatus'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('func_stat') + ' ',
					action: 'functionalstatus',
					margin: '0 3 0 0',
					tooltip: _('functional_status'),
					style: {
						backgroundColor: g('functional_status_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_functional_status')
				}
			]);
		}

		if(a('access_patient_referrals')) {
			index = this.items_indexes['referrals'] !== undefined ? this.items_indexes['referrals'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('refs') + ' ',
					action: 'referrals',
					margin: '0 3 0 0',
					tooltip: _('referrals'),
					style: {
						backgroundColor: g('referrals_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_referrals')
				}
			]);
		}

		if(a('access_patient_implantable_devices')) {
			index = this.items_indexes['ImplantableDeviceGrid'] !== undefined ? this.items_indexes['ImplantableDeviceGrid'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('imp_devs') + ' ',
					action: 'ImplantableDeviceGrid',
					margin: '0 3 0 0',
					tooltip: _('implantable_devices'),
					style: {
						backgroundColor: g('implantable_devices_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_implantable_devices')
				}
			]);
		}

		if(a('access_patient_pain_scales')){
			index = this.items_indexes['PainScaleGrid'] !== undefined ? this.items_indexes['PainScaleGrid'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('pain_scale') + ' ',
					action: 'PainScaleGrid',
					margin: '0 3 0 0',
					tooltip: _('pain_scale'),
					style: {
						backgroundColor: g('pain_scales_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_implantable_devices')
				}
			]);

		}

		if(a('access_patient_doctors_notes')) {
			index = this.items_indexes['DoctorsNotes'] !== undefined ? this.items_indexes['DoctorsNotes'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('doc_nt'),
					action: 'DoctorsNotes',
					margin: '0 3 0 0',
					tooltip: _('doctors_notes'),
					style: {
						backgroundColor: g('doctors_notes_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_doctors_notes')
				}
			]);
		}

		if(a('access_patient_lab_orders')) {
			index = this.items_indexes['LabOrders'] !== undefined ? this.items_indexes['LabOrders'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('lab_orders'),
					action: 'LabOrders',
					margin: '0 3 0 0',
					style: {
						backgroundColor: g('lab_orders_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_lab_orders')
				}
			]);
		}

		if(a('access_patient_rad_orders')) {
			index = this.items_indexes['RadOrders'] !== undefined ? this.items_indexes['RadOrders'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('xray_ct_orders'),
					action: 'RadOrders',
					margin: '0 3 0 0',
					style: {
						backgroundColor: g('rad_orders_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_rad_orders')
				}
			]);
		}

		if(a('access_patient_rx_orders')) {
			index = this.items_indexes['RxOrderGrid'] !== undefined ? this.items_indexes['RxOrderGrid'] : outofindex++;
			Ext.Array.insert(buttons, index, [
				{
					text: _('rx_orders'),
					action: 'RxOrderGrid',
					margin: '0 3 0 0',
					style: {
						backgroundColor: g('rx_orders_tab_color'),
						backgroundImage: 'none'
					},
					acl: a('access_patient_rx_orders')
				}
			]);
		}



		Ext.Array.push(buttons, ['-',
			{
				text: _('documents'),
				itemId: 'EncounterPatientDocumentsBtn',
				icon: 'resources/images/icons/icoDOC-16.png',
				//acl: a('access_patient_rx_orders')
			}
		]);

		return buttons;
	},

	getMedicalTabPanelItems: function () {
		var tapPanelItems = [],
			index = 0,
			outofindex = 100;

		if(a('access_patient_immunizations')){

			index = this.items_indexes['immunization'] !== undefined ? this.items_indexes['immunization'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'patientimmunizationspanel',
				itemId: 'immunization',
				tabConfig: {
					tooltip: _('vaccines_immunizations'),
					style: {
						backgroundColor: g('immunizations_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_allergies')){

			index = this.items_indexes['allergies'] !== undefined ? this.items_indexes['allergies'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientallergiespanel',
				itemId: 'allergies',
				tabConfig: {
					tooltip: _('allergies'),
					style: {
						backgroundColor: g('allergies_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_active_problems')){

			index = this.items_indexes['activeproblems'] !== undefined ? this.items_indexes['activeproblems'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientactiveproblemspanel',
				itemId: 'activeproblems',
				tabConfig: {
					tooltip: _('active_problems'),
					style: {
						backgroundColor: g('problems_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_family_history')){

			index = this.items_indexes['familyhistory'] !== undefined ? this.items_indexes['familyhistory'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientfamilyhistorypanel',
				itemId: 'familyhistory',
				tabConfig: {
					tooltip: _('family_history'),
					style: {
						backgroundColor: g('family_history_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_procedures_history')){

			index = this.items_indexes['procedureshistory'] !== undefined ? this.items_indexes['procedureshistory'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientprocedureshistorygrid',
				itemId: 'procedureshistory',
				tabConfig: {
					tooltip: _('procedure_history'),
					style: {
						backgroundColor: g('procedure_history_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_advance_directive')){

			index = this.items_indexes['advancedirectives'] !== undefined ? this.items_indexes['advancedirectives'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientadvancedirectivepanel',
				itemId: 'advancedirectives',
				tabConfig: {
					tooltip: _('advance_directives'),
					style: {
						backgroundColor: g('advance_directive_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_medications')){

			index = this.items_indexes['medications'] !== undefined ? this.items_indexes['medications'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'patientmedicationspanel',
				itemId: 'medications',
				tabConfig: {
					tooltip: _('medications'),
					style: {
						backgroundColor: g('medications_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_results')){

			index = this.items_indexes['laboratories'] !== undefined ? this.items_indexes['laboratories'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'patientresultspanel',
				itemId: 'laboratories',
				tabConfig: {
					tooltip: _('results'),
					style: {
						backgroundColor: g('results_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_social_history')){

			index = this.items_indexes['social'] !== undefined ? this.items_indexes['social'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientsocialpanel',
				itemId: 'social',
				tabConfig: {
					tooltip: _('social_history'),
					style: {
						backgroundColor: g('social_history_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_functional_status')){

			index = this.items_indexes['functionalstatus'] !== undefined ? this.items_indexes['functionalstatus'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientcognitiveandfunctionalstatuspanel',
				itemId: 'functionalstatus',
				tabConfig: {
					tooltip: _('functional_status'),
					style: {
						backgroundColor: g('functional_status_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_referrals')){

			index = this.items_indexes['referrals'] !== undefined ? this.items_indexes['referrals'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientreferralspanel',
				itemId: 'referrals',
				tabConfig: {
					tooltip: _('referrals'),
					style: {
						backgroundColor: g('referrals_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_implantable_devices')){

			index = this.items_indexes['ImplantableDeviceGrid'] !== undefined ? this.items_indexes['ImplantableDeviceGrid'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'implantabledevicepanel',
				tabConfig: {
					tooltip: _('implantable_devices'),
					style: {
						backgroundColor: g('implantable_devices_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_pain_scales')){

			index = this.items_indexes['PainScaleGrid'] !== undefined ? this.items_indexes['PainScaleGrid'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'painscalepanel',
				tabConfig: {
					tooltip: _('pain_scales'),
					style: {
						backgroundColor: g('pain_scales_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		// if(a('access_patient_psy_behavioral')){
		// 	tapPanelItems = Ext.Array.push(tapPanelItems, {
		// 		xtype:'socialpsychologicalbehavioralpanel',
		// 		tabConfig: {
		// 			tooltip: _('social_psychological_behavioral'),
		// 			style: {
		// 				backgroundColor: g('psy_behavioral_tab_color'),
		// 				backgroundImage: 'none'
		// 			}
		// 		}
		// 	});
		// }

		if(a('access_patient_doctors_notes')){

			index = this.items_indexes['DoctorsNotes'] !== undefined ? this.items_indexes['DoctorsNotes'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientdoctorsnotepanel',
				tabConfig: {
					tooltip: _('doctors_notes'),
					style: {
						backgroundColor: g('doctors_notes_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_lab_orders')){

			index = this.items_indexes['LabOrders'] !== undefined ? this.items_indexes['LabOrders'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientlaborderspanel',
				tabConfig: {
					tooltip: _('laboratory_orders'),
					style: {
						backgroundColor: g('lab_orders_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_rad_orders')){

			index = this.items_indexes['RadOrders'] !== undefined ? this.items_indexes['RadOrders'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype: 'patientradorderspanel',
				tabConfig: {
					tooltip: _('radiology_orders'),
					style: {
						backgroundColor: g('rad_orders_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		if(a('access_patient_rx_orders')){

			index = this.items_indexes['RxOrderGrid'] !== undefined ? this.items_indexes['RxOrderGrid'] : outofindex++;

			Ext.Array.insert(tapPanelItems, index, [{
				xtype:'patientrxorderspanel',
				tabConfig: {
					tooltip: _('medication_orders'),
					style: {
						backgroundColor: g('rx_orders_tab_color'),
						backgroundImage: 'none'
					}
				}
			}]);
		}

		return tapPanelItems;
	},

	onNavKey: function(e, key){
		if(!app.patient.pid) {
			app.msg(_('oops'), _('patient_error'), true);
			return;
		}
		var win = this.getMedicalWindow().show();

		switch(key){
			case e.ONE:
				win.cardSwitch('immunization');
				break;
			case e.TWO:
				win.cardSwitch('allergies');
				break;
			case e.THREE:
				win.cardSwitch('activeproblems');
				break;
			case e.FOUR:
				win.cardSwitch('medications');
				break;
			case e.FIVE:
				win.cardSwitch('laboratories');
				break;
			case e.SIX:
				win.cardSwitch('socialhistory');
				break;
			case e.SEVEN:
				win.cardSwitch('referrals');
				break;
		}
	},

	onPanelShow:function(panel){
		this.setWindowTitle(panel.title);
	},

	setWindowTitle:function(title){
		this.getMedicalWindow().setTitle(
            app.patient.name +
            ' (' + title + ') ' +
            (app.patient.readOnly ? '-  <span style="color:red">[Read Mode]</span>' :'')
        );
	}


});

Ext.define('App.controller.patient.MedicationsAdministered', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'MedicationsAdministeredGrid',
			selector: '#MedicationsAdministeredGrid'
		},
		{
			ref: 'MedicationsAdministeredGridAddBtn',
			selector: '#MedicationsAdministeredGridAddBtn'
		},
		{
			ref: 'MedicationsAdministeredEditWindow',
			selector: '#MedicationsAdministeredEditWindow'
		},
		{
			ref: 'MedicationsAdministeredEditForm',
			selector: '#MedicationsAdministeredEditForm'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				encounterload: me.onViewportEncounterLoad
			},
			'#MedicationsAdministeredGrid': {
				itemdblclick: me.onMedicationsAdministeredGridItemDblClick
			},
			'#MedicationsAdministeredEditCancelBtn': {
				click: me.onMedicationsAdministeredEditCancelBtnClick
			},
			'#MedicationsAdministeredEditSaveBtn': {
				click: me.onMedicationsAdministeredEditSaveBtnClick
			},
			'#MedicationsAdministeredEditAdministerSearchField': {
				select: me.onMedicationsAdministeredEditAdministerSearchFieldSelect
			},
			'#MedicationsAdministeredEditAdverseReactionField': {
				select: me.onMedicationsAdministeredEditAdverseReactionFieldSelect
			}
		});
	},

	onViewportEncounterLoad: function(encounter){
		var store = this.getMedicationsAdministeredGrid().getStore();

		store.clearFilter(true);
		store.load({
			filters: [
				{
					property: 'pid',
					value: encounter.get('pid')
				},
				{
					property: 'eid',
					value: encounter.get('eid')
				}
			],
			params: {
				pid: encounter.get('pid'),
				eid: encounter.get('eid'),
				include_not_administered: true
			}
		});
	},

	onMedicationsAdministeredEditAdministerSearchFieldSelect: function (field, selection) {
		var me = this,
			form = me.getMedicationsAdministeredEditForm().getForm(),
			record = form.getRecord();

		record.set({
			administered_uid: selection[0].get('id'),
			administered_title: selection[0].get('title'),
			administered_fname: selection[0].get('fname'),
			administered_mname: selection[0].get('mname'),
			administered_lname: selection[0].get('lname')
		});

	},

	onMedicationsAdministeredEditAdverseReactionFieldSelect: function (field, selection) {
		var me = this,
			form = me.getMedicationsAdministeredEditForm().getForm(),
			record = form.getRecord();

		record.set({
			adverse_reaction_text: selection[0].get('option_name'),
			adverse_reaction_code: selection[0].get('code'),
			adverse_reaction_code_type: selection[0].get('code_type')
		});
	},
	
	onMedicationsAdministeredGridItemDblClick: function (grid, record) {

		this.showMedicationsAdministeredEditWindow();

		var form = this.getMedicationsAdministeredEditForm().getForm();
		form.loadRecord(record);
	},

	onMedicationsAdministeredEditCancelBtnClick: function () {
		this.getMedicationsAdministeredEditForm().getForm().reset();
		this.getMedicationsAdministeredEditWindow().close();
	},

	onMedicationsAdministeredEditSaveBtnClick: function () {
		var me = this,
			form = me.getMedicationsAdministeredEditForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(!form.isValid()) return;
		record.set(values);

		record.save({
			callback:  function () {
				me.getMedicationsAdministeredEditForm().getForm().reset();
				me.getMedicationsAdministeredEditWindow().close();
			}
		});
	},

	showMedicationsAdministeredEditWindow: function () {
		if(!this.getMedicationsAdministeredEditWindow()){
			Ext.create('App.view.patient.windows.MedicationsAdministeredEditWindow')
		}
		return this.getMedicationsAdministeredEditWindow().show();
	},

});

Ext.define('App.controller.patient.Medications', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'MedicationsPanel',
			selector: 'patientmedicationspanel'
		},
		{
			ref: 'PatientMedicationsGrid',
			selector: '#patientMedicationsGrid'
		},
		{
			ref: 'addPatientMedicationBtn',
			selector: '#addPatientMedicationBtn'
		},
		{
			ref: 'PatientMedicationReconciledBtn',
			selector: '#PatientMedicationReconciledBtn'
		},
        {
            ref: 'PatientMedicationActiveBtn',
            selector: '#PatientMedicationActiveBtn'
        },
		{
			ref: 'PatientMedicationUserLiveSearch',
			selector: '#PatientMedicationUserLiveSearch'
		},
		{
			ref: 'PatientMedicationLiveSearch',
			selector: '#PatientMedicationLiveSearch'
		},

		// administer refs
		{
			ref: 'AdministeredMedicationsGrid',
			selector: '#AdministeredMedicationsGrid'
		},
		{
			ref: 'AdministeredMedicationsLiveSearch',
			selector: '#AdministeredMedicationsLiveSearch'
		},
		{
			ref: 'AdministeredMedicationsUserLiveSearch',
			selector: '#AdministeredMedicationsUserLiveSearch'
		},
		{
			ref: 'AdministeredMedicationsAddBtn',
			selector: '#AdministeredMedicationsAddBtn'
		},
		{
			ref: 'ReviewMedicationsBtn',
			selector: '#ReviewMedicationsBtn'
		},
		{
			ref: 'EncounterProcedureGrid',
			selector: '#EncounterProcedureGrid'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				encounterload: me.onViewportEncounterLoad
			},
            'patientmedicationspanel': {
                activate: me.onMedicationsPanelActive
            },
			'#patientMedicationsGrid': {
				beforeedit: me.onPatientMedicationsGridBeforeEdit,
				beforeitemcontextmenu: me.onPatientMedicationsGridBeforeItemContextMenu
			},
			'#PatientMedicationEndDateField': {
				select: me.onPatientMedicationEndDateFieldSelect
			},
			'#addPatientMedicationBtn': {
				click: me.onAddPatientMedicationBtnClick
			},
			'#PatientMedicationLiveSearch': {
				select: me.onMedicationLiveSearchSelect
			},
			'#PatientMedicationActiveBtn': {
				click: me.onPatientMedicationActiveBtnClick
			},
            '#PatientMedicationReconciledBtn': {
                click: me.onPatientMedicationReconciledBtnClick
            },
			'#PatientMedicationUserLiveSearch': {
				select: me.onPatientMedicationUserLiveSearchSelect,
                reset: me.onPatientMedicationUserLiveSearchReset
			},

			// Administrator controls
			'#AdministeredMedicationsGrid': {
				beforeedit: me.onAdministeredMedicationsGridBeforeEdit
			},
			'#AdministeredMedicationsLiveSearch': {
				select: me.onAdministeredMedicationsLiveSearchSelect
			},
			'#AdministeredMedicationsUserLiveSearch': {
				select: me.onAdministeredMedicationsUserLiveSearchSelect
			},
			'#AdministeredMedicationsAddBtn': {
				click: me.onAdministeredMedicationsAddBtnClick
			},
			'#PatientMedicationsGridActivateMenu': {
				click: me.onPatientMedicationsGridActivateMenuClick
			},
			'#ReviewMedicationsBtn': {
				click: me.onReviewMedicationsBtnClick
			},
			'#PatientMedicationsGridInactivateMenu': {
				click: me.onPatientMedicationsGridInactivateMenu
			}
		});
	},

	onPatientMedicationEndDateFieldSelect: function (field){
		var form = field.up('form').getForm();

		form.findField('is_active').setValue(false);

		form.getRecord().set({
			is_active: false,
			active: false
		});
	},

	onPatientMedicationsGridBeforeItemContextMenu: function (grid, record, item, index, e, eOpts){
		e.preventDefault();
		this.showContextMenu(grid, record, e);
	},

	showContextMenu: function (grid, record, e){
		if(!grid.context_menu){
			grid.context_menu = Ext.widget('menu', {
				margin: '0 0 10 0',
				items: [
					{
						text: _('activate'),
						itemId: 'PatientMedicationsGridActivateMenu'
					},
					{
						text: _('inactivate'),
						itemId: 'PatientMedicationsGridInactivateMenu'
					}
				]
			});
		}
		grid.context_menu.record = record;
		grid.context_menu.showAt(e.getXY())
	},

	onPatientMedicationsGridActivateMenuClick: function (item){
		var record = item.up('menu').record;

		record.set({
			is_active: true,
			end_date: null
		});

		record.store.sync();
	},

	onPatientMedicationsGridInactivateMenu: function (item){
		var record = item.up('menu').record;

		record.set({
			is_active: false,
			end_date: app.getDate()
		});

		record.store.sync();
	},


	onViewportEncounterLoad: function(encounter){

	},

	onAdministeredMedicationsGridBeforeEdit: function(plugin, context){
		var me = this,
			field = me.getAdministeredMedicationsUserLiveSearch();

		field.forceSelection = false;
		field.setValue(context.record.data.administered_by);
		Ext.Function.defer(function(){
			field.forceSelection = true;
		}, 200);

	},

	onAdministeredMedicationsLiveSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm();

		form.getRecord().set({
			RXCUI: records[0].data.RXCUI,
			CODE: records[0].data.CODE,
            GS_CODE: records[0].data.GS_CODE,
			NDC: records[0].data.NDC,
			TTY: records[0].data.TTY
		});
	},

	onAdministeredMedicationsUserLiveSearchSelect: function(cmb, records){
		var administered_by = records[0],
			record = cmb.up('form').getForm().getRecord();

		record.set({administered_uid: administered_by.data.id});
	},

	onAdministeredMedicationsAddBtnClick: function(){
		var me = this,
			grid = me.getAdministeredMedicationsGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			created_uid: app.user.id,
			created_date: new Date(),
			begin_date: new Date(),
			end_date: new Date(),
			administered_date: new Date(),
			administered_uid: app.user.id,
			title: app.user.title,
			fname: app.user.fname,
			mname: app.user.mname,
			lname: app.user.lname
		});

		grid.editingPlugin.startEdit(0, 0);
	},

	onPatientMedicationsGridBeforeEdit: function(plugin, context){

	},

	onPatientMedicationUserLiveSearchSelect: function(cmb, records){
		var user = records[0],
			record = cmb.up('form').getForm().getRecord();
        record.set({fname: user.data.fname});
        record.set({lname: user.data.lname});
        record.set({mname: user.data.mname});
        record.set({title: user.data.title});
		record.set({administered_uid: user.data.id});
	},

    onPatientMedicationUserLiveSearchReset: function(cmb){
        var record = cmb.up('form').getForm().getRecord();
        record.set({fname: ''});
        record.set({lname: ''});
        record.set({mname: ''});
        record.set({title: ''});
        record.set({administered_uid: ''});
    },

	onAddPatientMedicationBtnClick: function(){
		var me = this,
			grid = me.getPatientMedicationsGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			created_uid: app.user.id,
			create_date: new Date(),
			created_date: new Date(),
			begin_date: new Date(),
			is_active: true
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onReviewMedicationsBtnClick: function(){
		var me = this;
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_medications: true});
		encounter.save({
			success: function(){
				var store = me.getEncounterProcedureGrid().getStore(),
					now = new Date();

				app.msg(_('sweet'), _('items_to_review_save_and_review'));

				var record_index = store.findBy(function(record, id){
					var enc_id = record.get('eid');
					var procedure_code = record.get('code')

					return enc_id === app.patient.eid && procedure_code === '428191000124101';
				});

				if(record_index === -1) {

					store.add({
						pid: app.patient.pid,
						eid: app.patient.eid,
						create_uid: app.user.id,
						update_uid: app.user.id,
						create_date: now,
						update_date: now,
						code: '428191000124101',
						code_text: 'Documentation of current medications (procedure)',
						code_type: 'SNOMED-CT',
						performer_id: 0,
						procedure_date: now,
						encounter_dx_id:0
					});

					// store.add(procedure_record);
					store.sync({
						callback: function (){
							app.msg(_('sweet'), 'Documentation of current medications (procedure) Added');
						}
					});


				}
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	},

	onMedicationLiveSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm(),
			record = records[0],
			order_record = form.getRecord();

		order_record.set({
			RXCUI: record.data.RXCUI,
			CODE: record.data.CODE,
            GS_CODE: record.data.GS_CODE,
			NDC: record.data.NDC,
			TTY: record.data.TTY
		});

		var data = {};

		Rxnorm.getMedicationAttributesByRxcuiApi(record.data.RXCUI, function(response){

			if(response.propConceptGroup){
				response.propConceptGroup.propConcept.forEach(function(propConcept){

					if(propConcept.propCategory != 'ATTRIBUTES' && propConcept.propCategory != 'CODES') return;

					if(!data[propConcept.propCategory]){
						data[propConcept.propCategory] = {};
					}
					var propName = propConcept.propName.replace(' ', '_');
					data[propConcept.propCategory][propName] = propConcept.propValue;
				});
			}

			if(data.ATTRIBUTES && data.ATTRIBUTES.SCHEDULE && data.ATTRIBUTES.SCHEDULE != '0'){
				order_record.set({ is_controlled: true });
			}
		});

	},

	onPatientMedicationReconciledBtnClick: function(){
		this.onMedicationsPanelActive();
	},

    onPatientMedicationActiveBtnClick: function(){
        this.onMedicationsPanelActive();
    },

    onMedicationsPanelActive: function(){
        var store = this.getPatientMedicationsGrid().getStore(),
            reconciled = this.getPatientMedicationReconciledBtn().pressed,
            active = this.getPatientMedicationActiveBtn().pressed;

        store.clearFilter(true);
        store.load({
            filters: [
                {
                    property: 'pid',
                    value: app.patient.pid
                }
            ],
            params: {
                reconciled: reconciled,
                active: active
            }
        });
    }

});

Ext.define('App.controller.patient.MiniMentalStateExam', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'MiniMentalStateExamGridPanel',
			selector: '#MiniMentalStateExamGridPanel'
		},
		{
			ref: 'MiniMentalStateExamWindow',
			selector: '#MiniMentalStateExamWindow'
		},
		{
			ref: 'MiniMentalStateExamForm',
			selector: '#MiniMentalStateExamForm'
		},
	],

	init: function () {
		var me = this;
		me.control({
			'#MiniMentalStateExamGridPanel': {
				activate: me.onMiniMentalStateExamGridPanelActivate,
				itemdblclick: me.onMiniMentalStateExamGridPanelItemDblClick
			},
			'#MiniMentalStateExamAddBtn': {
				click: me.onMiniMentalStateExamAddBtnClick
			},
			'#MiniMentalStateExamWindowCancelBtn': {
				click: me.onMiniMentalStateExamWindowCancelBtnClick
			},
			'#MiniMentalStateExamWindowSaveBtn': {
				click: me.onMiniMentalStateExamWindowSaveBtnClick
			}
		});

		//me.showMiniMentalStateExamWindow();

	},

	onMiniMentalStateExamGridPanelActivate: function (grid) {
		grid.getStore().load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			]
		})
	},

	onMiniMentalStateExamGridPanelItemDblClick: function (grid, record) {
		this.showMiniMentalStateExamWindow();
		this.getMiniMentalStateExamForm().getForm().loadRecord(record);
	},


	onMiniMentalStateExamWindowSaveBtnClick: function () {
		var win = this.getMiniMentalStateExamWindow(),
			form = this.getMiniMentalStateExamForm().getForm(),
			store = this.getMiniMentalStateExamGridPanel().getStore(),
			values = form.getValues(),
			record = form.getRecord(),
			total_score = 0;

		if(!form.isValid()) return;


		if(values.orientation_time_score){
			total_score = total_score + parseInt(values.orientation_time_score);
		}
		if(values.orientation_place_score){
			total_score = total_score + parseInt(values.orientation_place_score);
		}
		if(values.registration_score){
			total_score = total_score + parseInt(values.registration_score);
		}
		if(values.attention_calculation_score){
			total_score = total_score + parseInt(values.attention_calculation_score);
		}
		if(values.recall_score){
			total_score = total_score + parseInt(values.recall_score);
		}
		if(values.language_score){
			total_score = total_score + parseInt(values.language_score);
		}
		if(values.repetition_score){
			total_score = total_score + parseInt(values.repetition_score);
		}
		if(values.complex_commands_score){
			total_score = total_score + parseInt(values.complex_commands_score);
		}

		values.total_score = total_score;

		record.set(values);

		if(!record.store){
			store.add(record);
		}

		if(
			store.getModifiedRecords().length === 0 &&
			store.getNewRecords().length === 0 &&
			store.getRemovedRecords().length === 0
		){
			form.reset();
			win.close();
		}

		store.sync({
			callback: function () {
				form.reset();
				win.close();
			}
		});

	},

	onMiniMentalStateExamAddBtnClick: function () {
		this.showMiniMentalStateExamWindow();

		var record = Ext.create('App.model.patient.MiniMentalStateExam', {
				pid: app.patient.pid,
				eid:  app.patient.eid,
				create_uid: app.user.id,
				create_date: new Date()
			}),
			form = this.getMiniMentalStateExamForm().getForm();

		form.loadRecord(record);
	},

	onMiniMentalStateExamWindowCancelBtnClick: function () {
		this.getMiniMentalStateExamWindow().close();
	},

	showMiniMentalStateExamWindow: function () {
		if(!this.getMiniMentalStateExamWindow()){
			Ext.create('App.view.patient.windows.MiniMentalStateExam');
		}
		return this.getMiniMentalStateExamWindow().show();
	}

});
Ext.define('App.controller.patient.NursesNotes', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'NursesNotesGrid',
			selector: '#NursesNotesGrid'
		},
		{
			ref: 'NursesNoteEditWindow',
			selector: '#NursesNoteEditWindow'
		},
		{
			ref: 'NursesNoteSnippetsGrid',
			selector: '#NursesNoteSnippetsGrid'
		},
		{
			ref: 'NursesNoteSnippetEditWindow',
			selector: '#NursesNoteSnippetEditWindow'
		},
		{
			ref: 'NursesNoteSnippetEditWindowForm',
			selector: '#NursesNoteSnippetEditWindowForm'
		},
		{
			ref: 'NursesNoteEditWindowFormNoteField',
			selector: '#NursesNoteEditWindowFormNoteField'
		},
	],

	init: function(){
		var me = this;
		me.control({
			'#NursesNoteEditWindow': {
				close: me.onNursesNoteEditWindowClose
			},
			'#NursesNotesGrid': {
				activate: me.onNursesNotesGridActive,
				itemdblclick: me.onNursesNotesGridItemDblClick
			},
			'#NursesNotesGridAddBtn': {
				click: me.onNursesNotesGridAddBtnClick
			},
			'#NursesNoteEditWindowCancelBtn': {
				click: me.onNursesNoteEditWindowCancelBtnClick
			},
			'#NursesNoteEditWindowSaveBtn': {
				click: me.onNursesNoteEditWindowSaveBtnClick
			},
			'#NursesNoteEditWindowSignBtn': {
				click: me.onNursesNoteEditWindowSignBtnClick
			},
			'#NursesNoteSnippetAddBtn': {
				click: me.onNursesNoteSnippetAddBtnClick
			},
			'#NursesNoteSnippetsGrid': {
				render: me.onNursesNoteEditWindowRender,
				itemdblclick: me.onNursesNoteSnippetsGridItemDblClick
			},
			'#NursesNoteSnippetEditWindowCancelBtn': {
				click: me.onNursesNoteSnippetEditWindowCancelBtnClick
			},
			'#NursesNoteSnippetEditWindowSaveBtn': {
				click: me.onNursesNoteSnippetEditWindowSaveBtnClick
			},
		});
	},

	onNursesNoteEditWindowClose: function(){
		var panel = app.getActivePanel();
		if(panel.$className === 'App.view.patient.Encounter'){
			panel.getProgressNote();
		}
	},

	onNursesNoteSnippetsGridItemDblClick: function(grid, record){

		var snippet = record.get('snippet'),
			field = this.getNursesNoteEditWindowFormNoteField();

		if(Ext.isChrome){
			field.inputEl.dom.focus();
			document.execCommand("insertText", false, snippet);
		}else{
			field.inputEl.dom.value += ' ' + snippet;
		}
	},

	onNursesNoteSnippetEditWindowCancelBtnClick: function(btn){
		btn.up('window').close();
		this.getNursesNoteSnippetsGrid().getStore().rejectChanges();
	},

	onNursesNoteSnippetEditWindowSaveBtnClick: function(btn){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			store = this.getNursesNoteSnippetsGrid().getStore();

		record.set(values);
		store.sync({
			callback: function () {
				win.close();
			}
		});
	},

	onNursesNoteSnippetAddBtnClick: function(btn){
		var form  = this.showNursesNoteSnippetEditWindow().down('form').getForm(),
			store = btn.up('grid').getStore(),
			records = store.add({
				uid: app.user.id,
				index: 0,
				create_uid: app.user.id,
				update_uid: app.user.id,
				create_date: app.getDate(),
				update_date: app.getDate()
			});

		form.loadRecord(records[0]);

	},

	onSnippetBtnEdit: function(grid, rowIndex, colIndex, actionItem, event, record){
		var form  = this.showNursesNoteSnippetEditWindow().down('form').getForm();
		form.loadRecord(record);
	},

	onNursesNoteEditWindowRender: function(grid){
		grid.getStore().load();
	},

	onNursesNoteEditWindowCancelBtnClick: function(btn){
		this.getNursesNotesGrid().getStore().rejectChanges();
		btn.up('window').close();
	},

	onNursesNoteEditWindowSaveBtnClick: function(btn){
		var me = this,
			win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			store = this.getNursesNotesGrid().getStore();

		record.set(values);

		if(Ext.Object.isEmpty(record.getChanges())){
			win.close();
			return;
		}

		store.sync({
			callback: function () {
				win.close();
			}
		});

	},

	onNursesNoteEditWindowSignBtnClick: function(btn){
		var me = this,
			win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			store = this.getNursesNotesGrid().getStore();

		app.passwordVerificationWin(function(ver_btn, password){

			if(ver_btn === 'ok'){

				User.verifyUserPass(password, function(response){
					if(response){

						values.signer_uid = app.user.id;
						values.signer_date = app.getDate();
						values.nurse_fname = app.user.fname;
						values.nurse_mname = app.user.mname;
						values.nurse_lname = app.user.lname;
						values.nurse_name = '';

						record.set(values);
						store.sync({
							callback: function () {
								win.close();
							}
						});

					}else{
						Ext.Msg.show({
							title: 'Oops!',
							msg: _('incorrect_password'),
							buttons: Ext.Msg.OKCANCEL,
							icon: Ext.Msg.ERROR,
							fn: function(msg_btn){
								if(msg_btn === 'ok'){
									me.onNursesNoteEditWindowSaveBtnClick(btn);
								}
							}
						});
					}
				});
			}
		});

	},

	onNursesNotesGridAddBtnClick: function(btn){

		var form  = this.showNursesNotesWindow().down('form').getForm(),
			store = btn.up('grid').getStore(),
			records = store.add({
				pid: app.patient.pid,
				eid: app.patient.eid,
				in_error: false,
				create_uid: app.user.id,
				update_uid: app.user.id,
				create_date: app.getDate(),
				update_date: app.getDate(),
				nurse_name: app.user.getFullName()
			});

		form.loadRecord(records[0]);
	},

	onNursesNotesGridItemDblClick: function(grid, record){
		// validate user is the owner of this note
		if(record.get('create_uid') > 0 && record.get('create_uid') !== app.user.id){
			app.msg(_('oops'), 'Cannot modify notes from another user', true);
			return;
		}
		if(record.get('signer_uid') > 0){
			app.msg(_('oops'), 'Cannot modify signed notes', true);
			return;
		}
		var form  = this.showNursesNotesWindow().down('form').getForm();
		form.loadRecord(record);
	},

	showNursesNotesWindow: function(){
		if(!this.getNursesNoteEditWindow()){
			Ext.create('App.view.patient.windows.NursesNoteEditWindow');
		}
		return this.getNursesNoteEditWindow().show();
	},

	showNursesNoteSnippetEditWindow: function(){
		if(!this.getNursesNoteSnippetEditWindow()){
			Ext.create('App.view.patient.windows.NursesNoteSnippetEditWindow');
		}
		return this.getNursesNoteSnippetEditWindow().show();
	},

	onNursesNotesGridActive: function(grid){

		grid.getStore().load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				},
				{
					property: 'eid',
					value: app.patient.eid
				}
			]
		});
	}

});
Ext.define('App.controller.patient.PainScale', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PainScaleGrid',
			selector: '#PainScaleGrid'
		},
		{
			ref: 'PainScaleGridAddBtn',
			selector: '#PainScaleGridAddBtn'
		},
		{
			ref: 'PainScaleReviewBtn',
			selector: '#PainScaleReviewBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#PainScaleGrid':{
				activate: me.onPainScaleGridActivate,
				validateedit: me.onPainScaleGridValidateEdit,
				beforeedit: me.onPainScaleGridBeforeEdit
			},
			'#PainScaleGridAddBtn':{
				click: me.onPainScaleGridAddBtnClick
			},
			'#PainScaleReviewBtn':{
				click: me.onPainScaleReviewBtnClick
			}
		});
	},

	onPainScaleGridActivate: function(grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onPainScaleGridAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		var records = store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_date: new Date(),
			created_uid: app.user.id,
			update_date: new Date(),
			update_uid: app.user.id,
			pain_scale: 0
		});
		grid.editingPlugin.startEdit(records[0], 0);
	},

	onPainScaleReviewBtnClick: function(btn){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord();
		encounter.set({review_pain_scales: true});
		encounter.save({
			success: function(){
				app.msg(_('sweet'), _('items_to_review_save_and_review'));
			},
			failure: function(){
				app.msg(_('oops'), _('items_to_review_entry_error'));
			}
		});
	},

	onPainScaleGridValidateEdit: function (plugin, context) {
		var me = this,
			form = plugin.editor.getForm(),
			anatomical_region_field = form.findField('anatomical_region_code_text'),
			anatomical_region_record = anatomical_region_field.findRecordByValue(anatomical_region_field.getValue()),
			values = form.getValues(),
			record = form.getRecord(),
			store = this.getPainScaleGrid().getStore();

		if(anatomical_region_record){
			values.anatomical_region_code = anatomical_region_record.get('ConceptId');
			values.anatomical_region_code_type = anatomical_region_record.get('CodeType');
			values.update_date = new Date();
		}

		record.set(values);

	},

	onPainScaleGridBeforeEdit:function(plugin, context){
		if(!a('edit_patient_pain_scales')) return false;
	}

});
Ext.define('App.controller.patient.PictureIdCard', {
	extend: 'Ext.app.Controller',
	requires: [
	],
	refs: [
		{
			ref: 'PatientSummaryImagesPanel',
			selector: '#PatientSummaryImagesPanel'
		},
		{
			ref: 'PatientSummaryImagesPictureIdCardPrintersCombo',
			selector: '#PatientSummaryImagesPictureIdCardPrintersCombo'
		},
		{
			ref: 'PatientSummaryImagesPictureIdCardPrinterImage',
			selector: '#PatientSummaryImagesPictureIdCardPrinterImage'
		},
		{
			ref: 'PatientSummaryImagesPictureIdCardPrintBtn',
			selector: '#PatientSummaryImagesPictureIdCardPrintBtn'
		},

	],

	init: function(){
		var me = this;

		me.control({
			'#PatientSummaryImagesPanel':{
				beforerender: me.onPatientSummaryImagesPanelBeforeRender
			},
			'#PatientSummaryImagesPictureIdCardBtn':{
				click: me.onPatientSummaryImagesPictureIdCardBtnClick
			},
			'#PatientSummaryImagesPictureIdCardPrintBtn':{
				click: me.onPatientSummaryImagesPictureIdCardPrintBtnClick
			}
		});
	},

	onPatientSummaryImagesPictureIdCardBtnClick: function(btn){

		var patient_img = btn.up('patientdeomgraphics').down('#PatientSummaryImagesPanel').down('image'),
			data = {
			'[PATIENT_NAME]': app.patient.name,
			'[RECORD_NUMBER]': app.patient.pubpid,
			'[FACILITY]': app.getController('Main').getCurrentFacilityName(),
			'[IMAGE]': patient_img.src
		};

		PictureIdCard.Create(data, function (response) {

			if(response.success){

				Ext.create('Ext.window.Window', {
					title: _('picture_id_card'),
					layout: 'fit',
					items: [
						{
							xtype:'image',
							itemId: 'PatientSummaryImagesPictureIdCardPrinterImage',
							base64data: response.base64data,
							src: ('data:image/jpg;base64,' + response.base64data),
							width: response.width/4,
							height: response.height/4
						}
					],
					dockedItems: [{
						xtype: 'toolbar',
						dock: 'bottom',
						ui: 'footer',
						defaults: { minWidth: 70 },
						items: [
							'->',
							{
								xtype: 'printerscombo',
								itemId: 'PatientSummaryImagesPictureIdCardPrintersCombo',
							},
							{
								text: _('print'),
								itemId: 'PatientSummaryImagesPictureIdCardPrintBtn'
							}
						]
					}]
				}).show();

			}
		});

	},


	onPatientSummaryImagesPictureIdCardPrintBtnClick: function(btn){

		var printer_record = this.getPatientSummaryImagesPictureIdCardPrintersCombo().findRecordByValue(this.getPatientSummaryImagesPictureIdCardPrintersCombo().getValue()),
			img = this.getPatientSummaryImagesPictureIdCardPrinterImage();

		if(!printer_record){
			app.msg(_('oops'), _('no_printer_selected'), true);
			return;
		}

		app.getController('Print').doPrint(printer_record, img.base64data);

	},


	onPatientSummaryImagesPanelBeforeRender: function (panel) {
		panel.addDocked({
			xtype: 'toolbar',
			dock: 'top',
			items: [
				{
					xtype: 'button',
					text: _('picture_id_card'),
					itemId: 'PatientSummaryImagesPictureIdCardBtn',
					flex: 1
				}
			]
		});

	},



});
Ext.define('App.controller.patient.Patient', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'NewPatientWindow',
			selector: '#NewPatientWindow'
		},
		{
			ref: 'NewPatientWindowForm',
			selector: '#NewPatientWindowForm'
		},
		{
			ref: 'NewPatientWindowInsuranceForm',
			selector: '#NewPatientWindowInsuranceForm'
		},
		{
			ref: 'PossiblePatientDuplicatesWindow',
			selector: '#PossiblePatientDuplicatesWindow'
		},
		{
			ref: 'PatientDemographicForm',
			selector: '#PatientDemographicForm'
		},
		{
			ref: 'PatientDemographicsPanel',
			selector: '#PatientDemographicsPanel'
		},
		{
			ref: 'PatientSummaryPatientImage',
			selector: '#PatientSummaryPatientImage'
		},
		{
			ref: 'PatientSummaryQrcodeImage',
			selector: '#PatientSummaryQrcodeImage'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				afterdemographicssave: me.onAfterDemographicsSave,
				demographicsrecordload: me.onDemographicsRecordLoad
			},
			'#NewPatientWindow': {
				close: me.onNewPatientWindowClose
			},
			'#HeaderNewPatientBtn': {
				click: me.onHeaderNewPatientBtnClick
			},
			'#SearchNewPatientBtn': {
				click: me.onSearchNewPatientBtnClick
			},
			'#NewPatientWindowCancelBtn': {
				click: me.onNewPatientWindowCancelBtnClick
			},
			'#NewPatientWindowSaveBtn': {
				click: me.onNewPatientWindowSaveBtnClick
			},

			'#NewPatientWindowImportFromCdaBtn': {
				click: me.onNewPatientWindowImportFromCdaBtnClick
			},
			'#PatientCdaImportBtn': {
				click: me.onPatientCdaImportBtnClick
			},

			'#PossiblePatientDuplicatesWindow': {
				close: me.onPossiblePatientDuplicatesWindowClose
			},
			'#PossiblePatientDuplicatesWindow > grid': {
				itemdblclick: me.onPossiblePatientDuplicatesGridItemDblClick
			},
			'#PatientPossibleDuplicatesBtn': {
				click: me.onPatientPossibleDuplicatesBtnClick
			},
			'#PossiblePatientDuplicatesContinueBtn': {
				click: me.onPossiblePatientDuplicatesContinueBtnClick
			},
			'#PossiblePatientDuplicatesCancelBtn': {
				click: me.onPossiblePatientDuplicatesCancelBtnClick
			},

			'textfield[action=last_name_field]': {
				keyup: me.onPatientLastNameFieldKeyUp
			},

			'#DemographicAddressCopyBtn': {
				click: me.onDemographicAddressCopyBtnClick
			},

			'#PatientSummaryQrcodeImagePrintBtn': {
				click: me.onPatientSummaryQrcodeImagePrintBtnClick
			}
		});

		me.importCtrl = this.getController('patient.CCDImport');

	},

	onAfterDemographicsSave: function (patient, panel){
		this.setPatientImages(patient, panel);
	},

	onDemographicsRecordLoad: function (patient, panel){
		this.setPatientImages(patient, panel);
	},

	setPatientImages: function (patient, panel){
		var patient_image = this.getPatientSummaryPatientImage(),
			qrcode_image = this.getPatientSummaryQrcodeImage();
		patient_image.setSrc((patient.data.image !== '' ? patient.data.image : panel.defaultPatientImage));
		qrcode_image.setSrc((patient.data.qrcode !== '' ? patient.data.qrcode : panel.defaultQRCodeImage));

	},

	onPatientSummaryQrcodeImagePrintBtnClick: function (btn){
		var qrcode_image = this.getPatientSummaryQrcodeImage();
		printJS({ printable: qrcode_image.imgEl.dom.src, type: 'image', documentTitle: ''});
	},

	onDemographicAddressCopyBtnClick: function (btn){
		var form = btn.up('form').getForm(),
			values = form.getValues();

		form.setValues({
			physical_address: values.postal_address,
			physical_address_cont: values.postal_address_cont,
			physical_city: values.postal_city,
			physical_state: values.postal_state,
			physical_zip: values.postal_zip,
			physical_country: values.postal_country,
		});

		app.msg(_('info'), _('postal_address_copied'), 'blue');

	},

	onPatientLastNameFieldKeyUp: function(field){
		var has_two_last_names = field.getValue().trim().split(' ').length > 1;
		field.has_two_last_names = has_two_last_names;

		if(!has_two_last_names){
			field.has_two_last_names =('x-field-yellow');
			field.addCls('x-field-yellow');
		}else{
			field.removeCls('x-field-yellow');
		}
	},

	onNewPatientWindowClose: function () {
		this.getNewPatientWindowForm().getForm().reset();
		this.getNewPatientWindowInsuranceForm().getForm().reset();
	},

	onHeaderNewPatientBtnClick: function () {
		this.showNewPatientWindow();
	},

	onSearchNewPatientBtnClick: function (btn) {
		this.showNewPatientWindow(btn.newPatientCallback);
	},

	onNewPatientWindowCancelBtnClick: function () {
		this.getNewPatientWindowForm().getForm().reset(true);
		this.getNewPatientWindow().close();
	},

	onNewPatientWindowSaveBtnClick: function (btn) {

		var me = this,
			win = me.getNewPatientWindow(),
			demographics_form = me.getNewPatientWindowForm().getForm(),
			demographics_values = demographics_form.getValues(),
			demographics_params = {
				fname: demographics_values.fname,
				mname: demographics_values.mname,
				lname: demographics_values.lname,
				DOB: demographics_values.DOB,
				sex: demographics_values.sex,
				phone_mobile: demographics_values.phone_mobile,
				email: demographics_values.email,
				phone_home: demographics_values.phone_home,
				phone_work: demographics_values.phone_work,
				postal_address: demographics_values.postal_address,
				postal_address_cont: demographics_values.postal_address_cont,
				postal_city: demographics_values.postal_city,
				postal_state: demographics_values.postal_state,
				postal_zip: demographics_values.postal_zip,
				postal_country: demographics_values.postal_country,
				physical_address: demographics_values.physical_address,
				physical_address_cont: demographics_values.physical_address_cont,
				physical_city: demographics_values.physical_city,
				physical_state: demographics_values.physical_state,
				physical_zip: demographics_values.physical_zip,
				physical_country: demographics_values.physical_country,
				first_visit_date: app.getDate(),
				primary_facility: app.user.facility
			},
			insurance_form = me.getNewPatientWindowInsuranceForm().getForm(),
			insurance_values = insurance_form.getValues(),
			has_insurance = insurance_values.insurance_id > 0;

		if(!demographics_form.isValid()) return;

		if(has_insurance){
			demographics_params.insurance = {
				insurance_id: insurance_values.insurance_id,
				insurance_type: 'P',
				effective_date: null,
				expiration_date: null,
				policy_number: insurance_values.policy_number,
				group_number: insurance_values.group_number,
				card_first_name: insurance_values.subscriber_given_name,
				card_middle_name: insurance_values.subscriber_middle_name,
				card_last_name: insurance_values.subscriber_surname,
				subscriber_relationship: '01',
				subscriber_given_name: insurance_values.subscriber_given_name,
				subscriber_middle_name: insurance_values.subscriber_middle_name,
				subscriber_surname: insurance_values.subscriber_surname,
				subscriber_sex: demographics_params.sex,
				subscriber_dob: demographics_params.DOB,
				subscriber_policy_number: insurance_values.subscriber_policy_number,
				subscriber_phone: demographics_params.phone_mobile || demographics_params.phone_home,

				subscriber_street: demographics_params.postal_address + ', ' + demographics_params.postal_address_cont,
				subscriber_city: demographics_params.postal_city,
				subscriber_state: demographics_params.postal_state,
				subscriber_country: demographics_params.postal_country,
				subscriber_postal_code: demographics_params.postal_zip,

				display_order: 1,
				create_uid: app.user.id,
				update_uid: app.user.id,
				create_date: Ext.Date.format(new Date(), 'Y-m-d H:i:s'),
				update_date: Ext.Date.format(new Date(), 'Y-m-d H:i:s')
			};

			demographics_params.policy_number = insurance_values.policy_number || null;

		}

		me.lookForPossibleDuplicates(demographics_params, null, function (duplicared_win, response) {

			if(response === true){
				win.el.mask(_('please_wait'));
				// continue clicked
				Patient.createNewPatient(demographics_params, function (response) {
					app.setPatient(response.pid, null, null, function(){
						win.el.unmask();
						win.close();
						if(win.newPatientCallback){
							win.newPatientCallback(response);
						}
					}, true);
				});

			}else if(response.isModel === true){
				win.el.mask(_('please_wait'));
				// duplicated record clicked
				app.setPatient(response.get('pid'), null, null, function(){
					duplicared_win.close();
					win.el.unmask();
					win.close();
					if(win.newPatientCallback){
						win.newPatientCallback(response);
					}
				}, true);
			}
		});

	},

	showNewPatientWindow: function (newPatientCallback) {
		if(!this.getNewPatientWindow()){
			Ext.create('App.view.patient.windows.NewPatient');
		}
		this.getNewPatientWindow().newPatientCallback = newPatientCallback;
		return this.getNewPatientWindow().show();
	},

	doCapitalizeEachLetterOnKeyUp: function(){

	},

	onPossiblePatientDuplicatesGridItemDblClick: function(grid, record){

		var win = this.getPossiblePatientDuplicatesWindow();

		if(typeof win.callbackFn === 'function'){
			win.callbackFn(win, record);
		}else if(win.action === 'openPatientSummary'){
			app.setPatient(record.data.pid, null, null, function(){
				app.openPatientSummary();
				grid.up('window').close();
			});
		}

	},

    onPossiblePatientDuplicatesWindowClose: function(window){
		var store = window.down('grid').getStore();
		store.removeAll();
		store.commitChanges();
	},

	checkForPossibleDuplicates: function(cmp){
		var me = this,
            params,
			form = cmp.isPanel ? cmp.getForm() : cmp.up('form').getForm();

		if(!form.isValid()) return;

		params = {
			fname: form.findField('fname').getValue(),
			lname: form.findField('lname').getValue(),
			sex: form.findField('sex').getValue(),
			DOB: form.findField('DOB').getValue()
		};

		if(form.getRecord()){
			params.pid = form.getRecord().data.pid;
		}

		me.lookForPossibleDuplicates(params, 'openPatientSummary');

	},

	lookForPossibleDuplicates: function(params, action, callback){
		var me = this,
			win = me.getPossiblePatientDuplicatesWindow() || Ext.create('App.view.patient.windows.PossibleDuplicates'),
			store = win.down('grid').getStore();

		win.action = action;
		win.callbackFn = callback;
		store.getProxy().extraParams = params;
		store.load({
			callback: function(records){
				if(records.length > 0){
					win.show();
				}else{
					app.msg(_('sweet'), _('no_possible_duplicates_found'));
					if(typeof win.callbackFn === 'function') {
						win.callbackFn(win, true);
					}
				}
			}
		});
	},

	onPatientPossibleDuplicatesBtnClick: function(btn){
		this.checkForPossibleDuplicates(btn.up('panel').down('form'));
	},

	onPossiblePatientDuplicatesContinueBtnClick: function(btn){
		var win = this.getPossiblePatientDuplicatesWindow();
		win.fireEvent('continue', win);

		if(typeof win.callbackFn === 'function') {
			win.callbackFn(win, true);
		}
		win.close();
	},

	onPossiblePatientDuplicatesCancelBtnClick: function(){
		var win = this.getPossiblePatientDuplicatesWindow();
		win.fireEvent('cancel', win);

		if(typeof win.callbackFn === 'function') {
			win.callbackFn(win, false);
		}
		win.close();
	},


	// C-CDA Patient Import
	onNewPatientWindowImportFromCdaBtnClick: function(btn){

		btn.up('window').close();

		var me = this,
			win = Ext.create('App.ux.form.fields.UploadString');

		win.allowExtensions = ['xml','ccd','cda','ccda'];
		win.on('uploadready', function(comp, stringXml){
			me.getDocumentData(stringXml, null);
		});

		win.show();
	},

	// C-CDA Patient Import
	onPatientCdaImportBtnClick: function(btn){

		var me = this,
			win = Ext.create('App.ux.form.fields.UploadString');

		win.allowExtensions = ['xml','ccd','cda','ccda'];
		win.on('uploadready', function(comp, stringXml){
			me.getDocumentData(stringXml, app.patient.pid);
		});

		win.show();
	},

	getDocumentData: function(stringXml, mergePid){
		var me = this;

		CDA_Parser.parseDocument(stringXml, function(ccdData){
			me.importCtrl.validatePosibleDuplicates = false;
			me.importCtrl.CcdImport(ccdData, mergePid, stringXml);
			me.importCtrl.validatePosibleDuplicates = true;
			me.promptCcdScore(stringXml, ccdData);

		});
	},

	promptCcdScore: function(xml, ccdData){

		var me = this;

		Ext.Msg.show({
			title:'C-CDA Score',
			msg: 'Would you like to see this C-CDA score?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn === 'yes'){
					me.doCcdScore(xml, ccdData);
				}
			}
		});
	},

	doCcdScore: function (xml, ccdData) {
		CDA_ScoreCard.getScoreDocument(xml, Ext.String.format('{0}, {1} {3} (C-CDA)', ccdData.patient.lname, ccdData.patient.fname, ccdData.patient.title), function (temp_doc) {
			if(temp_doc) {
				app.getController('DocumentViewer').doDocumentView(temp_doc.id, 'temp');
			}
		});
	}

});

Ext.define('App.controller.patient.PatientSearch', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientSearchFrom',
			selector: '#PatientSearchFrom'
		},
		{
			ref: 'PatientSearchGrid',
			selector: '#PatientSearchGrid'
		},
		{
			ref: 'PatientSearchFromSearchBtn',
			selector: '#PatientSearchFromSearchBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'#PatientSearchFromSearchBtn': {
				click: me.onPatientSearchFromSearchBtnClick
			}
		});
	},

	onPatientSearchFromSearchBtnClick:function() {
		var me = this,
			store = me.getPatientSearchGrid().getStore(),
			form = me.getPatientSearchFrom().getForm(),
			values = form.getValues(),
			searchValues = {};


		if(!form.isValid()) return;

		Ext.Object.each(values, function (key, value) {
			if (value == '') return;
			if (key == 'lab_results' && Ext.isObject(value)) {
				value = [value];
			}
			searchValues[key] = value;
		});

		store.getProxy().extraParams = searchValues;
		store.load();
	}

});

Ext.define('App.controller.patient.PatientMerge', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'PatientMergeWindow',
			selector: '#PatientMergeWindow'
		},
		{
			ref: 'PatientMergeBtn',
			selector: '#PatientMergeBtn'
		},
		{
			ref: 'PatientMergeRecordOneForm',
			selector: '#PatientMergeRecordOneForm'
		},
		{
			ref: 'PatientMergeRecordTwoForm',
			selector: '#PatientMergeRecordTwoForm'
		}
	],

	init: function () {
		var me = this;
		me.control({
			'#PatientMergeBtn': {
				click: me.onPatientMergeBtnClick
			},
			'button[toggleGroup=patientmergegroup]': {
				toggle: me.onPatientMergeGroupBtnToggle
			},
			'#PatientMergeCancelBtn': {
				click: me.onPatientMergeCancelBtnClick
			},
			'#PatientMergeMergeBtn': {
				click: me.onPatientMergeMergeBtnClick
			},
			'#PatientMergeRecordSerchField': {
				select: me.onPatientMergeRecordSerchFieldSelect
			}
		});

		me.bufferMergeForms = Ext.Function.createBuffered(me.setMergeForms, 100, me);
	},

	onPatientMergeBtnClick: function () {
		if(!a('allow_merge_patients')) return;

		this.showPatientMergeWindow();

		this.getPatientMergeRecordOneForm().getForm().loadRecord(app.patient.record);

	},

	onPatientMergeGroupBtnToggle: function (btn, pressed) {
		var form = btn.up('form');
		form.primaryRecord = pressed;

		this.bufferMergeForms();
	},

	setMergeForms: function () {
		var primary_form = this.getPatientMergeWindow().query('form[primaryRecord=true]')[0],
			secondary_form = this.getPatientMergeWindow().query('form[primaryRecord=false]')[0];

		primary_form.body.setStyle({backgroundColor: '#c3ffc3'});
		secondary_form.body.setStyle({backgroundColor: '#ffc3c3'});

		primary_form.setTitle(_('primary_record'));
		secondary_form.setTitle(_('merge_record'));

	},

	onPatientMergeCancelBtnClick: function () {
		this.getPatientMergeWindow().close();
	},

	onPatientMergeMergeBtnClick: function () {
		var me = this,
			primaryRecord = me.getPrimaryRecord(),
			secondaryRecord = me.getSecondaryRecord();

		if (!primaryRecord || !secondaryRecord) {
			app.msg(_('oops'), _('merge_record_missing'), true);
			return;
		}

		var primaryPid = primaryRecord.get('pid'),
			secondaryPid = secondaryRecord.get('pid');

		Ext.Msg.show({
			title: _('wait'),
			msg: Ext.String.format(_('merge_action_msg'), secondaryPid, primaryPid, secondaryPid),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {

				if (btn !== 'yes') return;

				me.getPatientMergeWindow().el.mask(_('merging'));

				Merge.merge(primaryPid, secondaryPid, function (success) {

					me.getPatientMergeWindow().el.unmask();

					if (success !== true) {
						say(success);
						app.msg(_('oops'), _('error_merging_patient'), true);
						return;
					}

					me.getPatientMergeWindow().close();
					app.msg(_('sweet'), _('patients_merged'));

					app.setPatient(primaryPid, null, null, function () {
						app.openPatientSummary();
					});
				});
			}
		});
	},

	onPatientMergeRecordSerchFieldSelect: function (field, records) {
		var me = this;

		App.model.patient.Patient.load(records[0].get('pid'), {
			callback: function (merge_patient_record, operation, success) {
				me.getPatientMergeRecordTwoForm().getForm().loadRecord(merge_patient_record);
			}
		});
	},

	getPrimaryRecord: function () {

		var primary_form = this.getPatientMergeWindow().query('form[primaryRecord=true]');

		if (primary_form.length === 0) {
			app.msg(_('oops'), _('not_primary_record_selected'), true);
			return false;
		}

		if (primary_form.length > 1) {
			app.msg(_('oops'), _('multiple_primary_records_found'), true);
			return false;
		}

		return primary_form[0].getForm().getRecord() || false;

	},

	getSecondaryRecord: function () {
		var secondary_form = this.getPatientMergeWindow().query('form[primaryRecord=false]');
		return secondary_form[0].getForm().getRecord() || false;
	},

	showPatientMergeWindow: function () {
		if (!this.getPatientMergeWindow()) {
			Ext.create('App.view.patient.windows.PatientMerge');
		}
		return this.getPatientMergeWindow().show();
	}

});

Ext.define('App.controller.patient.Referrals', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'ReferralPanelGrid',
			selector: 'patientreferralspanel'
		},
		{
			ref: 'AddReferralBtn',
			selector: 'button[action=addReferralBtn]'
		},
		{
			ref: 'PrintReferralBtn',
			selector: '#printReferralBtn'
		},
		{
			ref: 'ReferralProviderCombo',
			selector: '#ReferralProviderCombo'
		},
		{
			ref: 'ReferralLocalProviderCombo',
			selector: '#ReferralLocalProviderCombo'
		},
		{
			ref: 'ReferralExternalProviderCombo',
			selector: '#ReferralExternalProviderCombo'
		},
		{
			ref: 'ReferralExternalReferralCheckbox',
			selector: '#ReferralExternalReferralCheckbox'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'patientreferralspanel': {
				activate: me.onReferralActive,
				selectionchange: me.onGridSelectionChange,
				beforeedit: me.onGridBeforeEdit
			},
			'button[action=addReferralBtn]': {
				click: me.onAddReferralBtnClicked
			},
			'#ReferralServiceSearch': {
				select: me.onReferralServiceSearchSelect
			},
			'#referralDiagnosisSearch': {
				select: me.onReferralDiagnosisSearchSelect
			},
			'#ReferralExternalReferralCheckbox': {
				change: me.onReferralExternalReferralCheckboxChange
			},
			'#printReferralBtn': {
				click: me.onPrintReferralBtnClick
			},
			'#ReferralProviderCombo':{
				select: me.onReferralProviderComboSelect
			},
			'#ReferralLocalProviderCombo':{
				select: me.onReferralLocalProviderComboSelect
			},
			'#ReferralExternalProviderCombo':{
				select: me.onReferralExternalProviderComboSelect
			}
		});
	},

	onGridBeforeEdit: function(editor, context, eOpts){
		this.getReferralExternalReferralCheckbox().setValue(context.record.data.is_external_referral);
		this.getReferralLocalProviderCombo().setValue(context.record.data.refer_to_text);
		this.getReferralExternalProviderCombo().setValue(context.record.data.refer_to_text);
	},

	onReferralProviderComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({refer_by: records[0].data.option_value});
	},

	onReferralLocalProviderComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({refer_to: records[0].data.id});
	},

	onReferralExternalProviderComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();
		record.set({refer_to: records[0].data.id});
	},

	onPrintReferralBtnClick:function(referral, print){
		var me = this,
			grid = me.getReferralPanelGrid(),
			sm = grid.getSelectionModel(),
			selection = (referral.isModel ? [referral] : sm.getSelection()),
            params,
            i;

		if(grid.view.el) grid.view.el.mask(_('generating_documents'));

		for(i=0; i < selection.length; i++){
			params = {
                pid: app.patient.pid,
                eid: app.patient.eid,
                referralId: selection[i].data.id,
                templateId: 10,
                docType: 'Referral'
            };
			DocumentHandler.createTempDocument(params, function(provider, response){

				if(print === true){
					Printer.doTempDocumentPrint(1, response.result.id);
				}else {
					if(window.dual){
						dual.onDocumentView(response.result.id, 'Referral');
					}else{
						app.onDocumentView(response.result.id, 'Referral');
					}
				}
				if(grid.view.el) grid.view.el.unmask();
			});
		}
	},

	onGridSelectionChange:function(grid, models){
		this.getPrintReferralBtn().setDisabled(models.length == 0);
	},

	onReferralServiceSearchSelect: function(cmb, records){
		var referral = cmb.up('form').getForm().getRecord();
		referral.set({
			service_code: records[0].get('ConceptId'),
			service_code_type: records[0].get('CodeType')
		});
	},

	onReferralDiagnosisSearchSelect: function(cmb, records){
		var referral = cmb.up('form').getForm().getRecord();
		referral.set({
			diagnosis_code: records[0].data.code,
			diagnosis_code_type: records[0].data.code_type
		});
	},

	onReferralExternalReferralCheckboxChange: function(checkbox, isExternal){
		this.getReferralLocalProviderCombo().setVisible(!isExternal);
		this.getReferralLocalProviderCombo().setDisabled(isExternal);
		this.getReferralExternalProviderCombo().setVisible(isExternal);
		this.getReferralExternalProviderCombo().setDisabled(!isExternal);
	},

	onReferralActive: function(grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	onAddReferralBtnClicked: function(){
		var me = this,
			store = me.getReferralPanelGrid().getStore(),
			plugin = me.getReferralPanelGrid().editingPlugin,
			records;

		plugin.cancelEdit();
		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_date: app.getDate(),
			create_uid: app.user.id,
			referral_date: app.getDate()
		});
		plugin.startEdit(records[0], 0);
	},

	doAddReferralByTemplate: function (data) {
		var me = this,
			grid = me.getReferralPanelGrid(),
			store = grid.getStore();

		data.pid = app.patient.pid;
		data.eid = app.patient.eid;
		data.refer_by = app.user.id;
		data.refer_by_text = "";
		data.referral_date = app.getDate();
		data.create_uid =  app.user.id;
		data.update_uid =  app.user.id;
		data.create_date = app.getDate();
		data.update_date = app.getDate();

		var record = store.add(data)[0];

		record.save({
			success: function(){
				app.msg(_('sweet'), data.service_text + ' Referral ' + _('added'));
			}
		});

	}

});

Ext.define('App.controller.patient.ProceduresHistory', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref:'ProceduresHistoryGrid',
			selector: 'patientprocedureshistorygrid'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientprocedureshistorygrid': {
				activate: me.onProceduresHistoryGridActivate
			},
			'#ProceduresHistoryGridAddBtn': {
				click: me.onProceduresHistoryGridAddBtnClick
			},
			'#ProceduresHistoryGridProcedureField': {
				select: me.onProceduresHistoryGridProcedureFieldSelect
			},
			'#ProceduresHistoryGridTargetSiteField': {
				select: me.onProceduresHistoryGridTargetSiteFieldSelect
			}
		});
	},

	onProceduresHistoryGridProcedureFieldSelect: function(cmb, selection){
		var procedure_record = cmb.up('form').getForm().getRecord();
		procedure_record.set({
			procedure_code: selection[0].get('ConceptId'),
			procedure_code_type: selection[0].get('CodeType'),
			procedure: selection[0].get('Term')
		});
	},

	onProceduresHistoryGridTargetSiteFieldSelect: function(cmb, selection){
		var procedure_record = cmb.up('form').getForm().getRecord();
		procedure_record.set({
			target_site_code: selection[0].get('ConceptId'),
			target_site_code_type: selection[0].get('CodeType'),
			target_site_code_text: selection[0].get('Term')
		});
	},

	onProceduresHistoryGridAddBtnClick: function (btn) {
		var grid = btn.up('grid'),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			created_uid: app.user.id,
			create_date: new Date()
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onProceduresHistoryGridActivate: function(grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			]
		});
	}

});

Ext.define('App.controller.patient.ProgressNotesHistory', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref:'EncounterProgressNotesHistoryGrid',
			selector: '#EncounterProgressNotesHistoryGrid'
		},
		{
			ref:'ProgressNotesHistoryMineBtn',
			selector: '#ProgressNotesHistoryMineBtn'
		},
		{
			ref:'ProgressNotesHistorySpecialtyBtn',
			selector: '#ProgressNotesHistorySpecialtyBtn'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				beforeencounterload: me.onBeforeEncounterLoad,
				encounterload: me.onEncounterLoad
			},
			'#EncounterProgressNotesHistoryGrid': {
				afterrender: me.onEncounterProgressNotesHistoryGridAfterRender
			},
			'#ProgressNotesHistoryMineBtn': {
				toggle: me.onProgressNotesHistoryMineBtnToggle
			},
			'#ProgressNotesHistorySpecialtyBtn': {
				toggle: me.onProgressNotesHistorySpecialtyBtnToggle
			}
		});

		me.encOunterCtl = this.getController('patient.encounter.Encounter');

	},

	onProgressNotesHistoryMineBtnToggle: function(btn, pressed){
		this.doEncounterProgressNotesHistoryGridFilter();
	},

	onProgressNotesHistorySpecialtyBtnToggle: function(btn, pressed){
		this.doEncounterProgressNotesHistoryGridFilter();
	},

	doEncounterProgressNotesHistoryGridFilter: function(){

		var me = this,
			store = me.getEncounterProgressNotesHistoryGrid().getStore(),
			mine_btn = me.getProgressNotesHistoryMineBtn(),
			specialty_btn = me.getProgressNotesHistorySpecialtyBtn(),
			encounter_record = me.encOunterCtl.getEncounterRecord(),
			filters = [], provider_uid, specialty_id;

		if(encounter_record === null) return;

		provider_uid = encounter_record.get('provider_uid');
		specialty_id = encounter_record.get('specialty_id');


		if(mine_btn.pressed && provider_uid != null){
			filters.push({
				property: 'provider_uid',
				value: provider_uid
			});
		}

		if(specialty_btn.pressed && specialty_id != null){
			filters.push({
				property: 'specialty_id',
				value: specialty_id
			});
		}

		if(filters.length === 0){
			store.clearFilter();
		}else{
			store.clearFilter(true);
			store.filter(filters);
		}
	},

	onEncounterProgressNotesHistoryGridAfterRender: function(grid){
		//grid.getStore().load();
	},

	onBeforeEncounterLoad: function(encounter){

	},

	onEncounterLoad: function(encounter){
		this.loadPatientProgressHistory(encounter.get('pid'), encounter.get('eid'));
	},

	loadPatientProgressHistory: function(pid, eid){
		var grid = this.getEncounterProgressNotesHistoryGrid(),
			store = grid ? grid.getStore() : false;

		say('loadPatientProgressHistory --->>>');
		say('pid: ' + pid);
		say('eid: ' + eid);
		say(grid);
		say(store);
		say(app.patient);
		say('loadPatientProgressHistory <<<---');
		// store.getProxy().extraParams = { pid:pid, eid:eid };

		if(grid && grid.rendered) {
			store.tree.root.removeAll();
		}

		if(store){
			store.load({
				params: { pid:pid, eid:eid },
				callback: function (records){
					say('loadPatientProgressHistory load callback --->>>');
					say(records);
					say('loadPatientProgressHistory load callback <<<---');
				}
			});
		}
	}

});
Ext.define('App.controller.patient.PdfForms', {
	extend: 'Ext.app.Controller',
	requires: [
	],
	refs: [
		{
			ref: 'PatientSummaryImagesPanel',
			selector: '#PatientSummaryImagesPanel'
		},
		{
			ref: 'PatientPdfFormsWindow',
			selector: '#PatientPdfFormsWindow'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#PatientSummaryImagesPanel':{
				beforerender: me.onPatientSummaryImagesPanelBeforeRender
			},
			'#PatientPdfFormsBtn':{
				click: me.onPatientPdfFormsBtnClick
			},
			'#PatientPdfFormsWindowCancelBtn':{
				click: me.onPatientPdfFormsWindowCancelBtnClick
			},
			'#PatientPdfFormsWindowGenerateBtn':{
				click: me.onPatientPdfFormsWindowGenerateBtnClick
			}
		});

		me.pdf_forms_fieldsets = [];

		me.getDocumentPdfFormFieldsets();

	},

	onPatientPdfFormsWindowCancelBtnClick: function (btn){
		var win = btn.up('window'),
			form = win.down('form').getForm();

		win.pid = undefined;
		win.facility_id = undefined;
		win.referring_id = undefined;
		win.custom_fields = undefined;

		form.reset();
		win.close();
	},

	onPatientPdfFormsWindowGenerateBtnClick: function (btn){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			pdf_form_ids = [];

		if(Ext.isArray(values.pdf_form_id)){
			values.pdf_form_id.forEach(function (pdf_form_id){
				if(pdf_form_id > 0){
					pdf_form_ids.push(pdf_form_id);
				}
			});
		}else{
			pdf_form_ids.push(values.pdf_form_id);
		}

		if(pdf_form_ids.length === 0){
			app.msg(_('oops'), 'Nothing to Generate', 'yellow');
			return;
		}

		win.el.mask('Generating...');

		win.facility_id = win.facility_id > 0 ?  win.facility_id : app.user.facility;

		DocumentPdfForms.generatePdfForms(pdf_form_ids, win.pid, win.facility_id, win.referring_id, win.custom_fields, function (document){

			win.el.unmask();
			form.reset();
			win.pid = undefined;
			win.facility_id = undefined;
			win.referring_id = undefined;
			win.custom_fields = undefined;
			win.close();

			app.getController('DocumentViewer').doDocumentView(document.id, 'pdf_form');


		});


		// DocumentPdfForms.generatePdfForm();
		// form.reset();
		// win.close();

	},


	getDocumentPdfFormFieldsets: function (){

		var me = this,
			fieldset_map = {};

		DocumentPdfForms.getDocumentPdfForms({
			is_active: true
		}, function (pdf_forms){

			pdf_forms.forEach(function (pdf_form){

				var fieldset_mapped = fieldset_map[pdf_form.document_type],
					checkbox = {
					xtype: 'checkboxfield',
					name: 'pdf_form_id',
					inputValue: pdf_form.id,
					boxLabel: pdf_form.document_title
				};

				if(fieldset_mapped !== undefined){
					me.pdf_forms_fieldsets[fieldset_mapped].items.push(checkbox);
				}else{

					var fieldset = {
						xtype: 'fieldset',
						title: pdf_form.document_type,
						items: [ checkbox ]
					};

					me.pdf_forms_fieldsets.push(fieldset);
					fieldset_map[pdf_form.document_type] = me.pdf_forms_fieldsets.indexOf(fieldset);
				}

			});

		});
	},

	doShowPdfForm: function (pid, facility_id, referring_id, custom_fields){
		var  win = this.showPatientPdfFormsWindow();

		win.pid = pid;
		win.facility_id = facility_id;
		win.referring_id = referring_id;
		win.custom_fields = custom_fields;

		win.el.unmask();
		win.down('form').getForm().reset();
	},

	onPatientPdfFormsBtnClick: function (btn){
		this.doShowPdfForm(app.patient.pid);
	},

	showPatientPdfFormsWindow: function (){
		var me = this;

		if(!me.getPatientPdfFormsWindow()){
			Ext.create('Ext.window.Window', {
				title: 'Patient Forms',
				itemId: 'PatientPdfFormsWindow',
				width: 600,
				layout: 'fit',
				closeAction: 'hide',
				bodyPadding: 5,
				items: [
					{
						xtype: 'form',
						itemId: 'PatientPdfFormsWindowForm',
						bodyPadding: 10,
						items: me.pdf_forms_fieldsets
					}
				],
				buttons: [
					{
						xtype: 'button',
						text: _('cancel'),
						itemId: 'PatientPdfFormsWindowCancelBtn',
					},
					{
						xtype: 'button',
						text: _('generate'),
						itemId: 'PatientPdfFormsWindowGenerateBtn',
					}
				]
			});
		}
		return me.getPatientPdfFormsWindow().show();
	},

	onPatientSummaryImagesPanelBeforeRender: function (panel) {
		panel.addDocked({
			xtype: 'toolbar',
			dock: 'bottom',
			items: [
				{
					xtype: 'button',
					text: _('pdf_forms'),
					itemId: 'PatientPdfFormsBtn',
					iconCls: 'far fa-file-alt',
					flex: 1
				}
			]
		}, 0);
	},



});
Ext.define('App.controller.patient.RadOrders', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'RadOrdersGrid',
			selector: 'patientradorderspanel'
		},
		{
			ref: 'PrintRadOrderBtn',
			selector: 'patientradorderspanel #printRadOrderBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientradorderspanel': {
				activate: me.onRadOrdersGridActive,
				selectionchange: me.onRadOrdersGridSelectionChange,
				beforerender: me.onRadOrdersGridBeforeRender
			},
			'#radOrderliveSearch': {
				select: me.onRadSearchSelect
			},
			'patientradorderspanel #newRadOrderBtn': {
				click: me.onNewRadOrderBtnClick
			},
			'patientradorderspanel #printRadOrderBtn': {
				click: me.onPrintRadOrderBtnClick
			},
			'#RadOrdersUnableToPerformField': {
				select: me.onRadOrdersUnableToPerformFieldSelect,
				fieldreset: me.onRadOrdersUnableToPerformFieldReset
			}
		});

		me.encounterCtl = me.getController('patient.encounter.Encounter');

	},

	onRadOrdersUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},

	onRadOrdersUnableToPerformFieldReset: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord();

		combo.setValue(null);
		form_record.set({
			not_performed_code: null,
			not_performed_code_type: null,
			not_performed_code_text: null,
		});
	},

	onOrdersDeleteActionHandler: function (grid, rowIndex, colIndex, item, e, record) {

		if(!a('remove_patient_order')){
			app.msg(_('oops'), _('not_authorized'), true);
			return;
		}

		var me = this,
			store = grid.getStore();

		Ext.Msg.show({
			title: _('wait'),
			msg: ('<b>' + record.get('STR') + '</b><br><br>' + _('delete_this_record')),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn1) {
				if(btn1 === 'yes'){
					Ext.Msg.show({
						title: _('wait'),
						msg: _('this_action_can_not_be_undone_continue'),
						buttons: Ext.Msg.YESNO,
						icon: Ext.Msg.QUESTION,
						fn: function (btn2) {
							if(btn2 === 'yes'){
								store.remove(record);
								store.sync({
									callback: function () {
										store.remove(record);
										store.sync({
											callback: function () {

											}
										});
									}
								});
							}
						}
					});
				}
			}
		});
	},

	onRadOrdersGridBeforeRender: function(grid){
		app.on('patientunset', function(){
			grid.editingPlugin.cancelEdit();
			grid.getStore().removeAll();
		});
	},

	onRadSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm();
		form.getRecord().set({
			code: records[0].data.loinc_number,
			code_type: records[0].data.code_type
		});
		if(form.findField('code')) form.findField('code').setValue(records[0].data.code);
		if(form.findField('note')) form.findField('note').focus(false, 200);
	},

	onRadOrdersGridSelectionChange: function(sm, selected){
		this.getPrintRadOrderBtn().setDisabled(selected.length === 0);
	},

	onNewRadOrderBtnClick: function(){
		var me = this,
			grid = me.getRadOrdersGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			date_ordered: new Date(),
			order_type: 'rad',
			status: 'Pending',
			priority: 'Normal'
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onPrintRadOrderBtnClick: function(input, print){
		var me = this,
			grid = me.getRadOrdersGrid(),
			orders = (Ext.isArray(input) ? input : grid.getSelectionModel().getSelection()),
			documents = {};

		orders.forEach(function(order){

			var date_ordered = Ext.Date.format(order.get('date_ordered'),'Y-m-d'),
				pdf_format = (g('order_pdf_format') || null),
				doc_key = '_' + order.get('eid') + order.get('pid') + order.get('uid') + date_ordered;

			if(!documents[doc_key]){
				documents[doc_key] = {};
				documents[doc_key].pid = order.get('pid');
				documents[doc_key].eid = order.get('eid');
				documents[doc_key].date_ordered = date_ordered;
				documents[doc_key].provider_uid = order.get('uid');
				documents[doc_key].orderItems = [];
				documents[doc_key].docType = 'Rad';
				documents[doc_key].templateId = 6;
				documents[doc_key].pdf_format = pdf_format;
				documents[doc_key].dx_required = false;
				documents[doc_key].orderItems.push(['Description', 'Notes']);
			}

			documents[doc_key].orderItems.push([
				order.get('description') + ' [' + order.get('code_type') + ':' + order.get('code') + ']',
				order.get('note')
			]);
		});

		Ext.Object.each(documents, function(key, params){
			DocumentHandler.createTempDocument(params, function(response){

				if(Ext.isString(response)){
					app.msg(_('oops'), response, true);
					return;
				}

				if(print === true){
					Printer.doTempDocumentPrint(1, response.id);
				}else{
					if(window.dual){
						dual.onDocumentView(response.id, 'Rad');
					}else{
						app.onDocumentView(response.id, 'Rad');
					}
				}

			});
		});
	},

	onRadOrdersGridActive: function(grid){
		var store = grid.getStore();
		if(!grid.editingPlugin.editing){
			store.clearFilter(true);
			store.filter([
				{
					property: 'pid',
					value: app.patient.pid
				},
				{
					property: 'order_type',
					value: 'rad'
				},
				{
					property: 'is_external_order',
					value: 0
				}
			]);
		}
	},

	radOrdersGridStatusColumnRenderer: function(v){
		var color = 'black';

		if(v == 'Canceled'){
			color = 'red';
		}else if(v == 'Pending'){
			color = 'orange';
		}else if(v == 'Routed'){
			color = 'blue';
		}else if(v == 'Complete'){
			color = 'green';
		}

		return '<div style="color:' + color + '">' + v + '</div>';
	},

	doAddOrderByTemplate: function(data){
		var me = this,
			grid = me.getRadOrdersGrid(),
			store = grid.getStore();

		data.pid = app.patient.pid;
		data.eid = app.patient.eid;
		data.uid = app.user.id;
		data.date_ordered = new Date();
		data.order_type = 'rad';
		data.status = 'Pending';
		data.priority = 'Normal';

		var record = store.add(data)[0];

		record.save({
			success: function(){
				app.msg(_('sweet'), data.description + ' ' + _('added'));
			}
		});

	}

});

Ext.define('App.controller.patient.Reminders', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientRemindersAddBtn',
			selector: '#RemindersAddBtn'
		},
		{
			ref: 'PatientSummaryRemindersPanel',
			selector: '#PatientSummaryRemindersPanel'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#PatientSummaryRemindersPanel':{
				activate: me.onPatientSummaryRemindersPanelActivate
			},
			'#PatientRemindersAddBtn':{
				click: me.onPatientRemindersAddBtnClick
			}
		});
	},

	onPatientSummaryRemindersPanelActivate: function(){
		this.getPatientSummaryRemindersPanel().getStore().load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			]
		});
	},

	onPatientRemindersAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.store;

		grid.plugins[0].cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			reminder_type: 'appointment',
			reminder_date: new Date(),
			reminder_note: '',
			create_date: new Date(),
			create_uid: app.user.id
		});
		grid.plugins[0].startEdit(0, 0);
	}

});

Ext.define('App.controller.patient.Social', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'SocialPanel',
			selector: 'patientsocialpanel'
		},
		{
			ref: 'SocialHistoryGrid',
			selector: 'patientsocialhistorypanel'
		},
		{
			ref: 'SocialHistoryTypeCombo',
			selector: 'combobox[action=socialHistoryTypeCombo]'
		},
		{
			ref: 'SocialHistoryAddBtn',
			selector: 'button[action=socialHistoryAddBtn]'
		},
		{
			ref: 'ObservationColumn',
			selector: '#socialhistorypanelobservationcolumn'
		},
		{
			ref: 'SmokingStatusCombo',
			selector: '#socialsmokingstatuscombo'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientsocialpanel': {
				activate: me.onSocialPanelActive
			},
			'patientsocialhistorypanel': {
				beforeedit: me.onSocialHistoryBeforeEdit
			},
			'button[action=socialHistoryAddBtn]': {
				click: me.onAddBtnClicked
			},
			'combobox[action=socialHistoryTypeCombo]': {
				select: me.onHistoryTypeComboSelectionChanged
			},
			'#socialsistoryobservationcombo': {
				select: me.onHistoryObservationComboSelect
			},
			'#socialsmokingstatuscombo': {
				select: me.onSmokingStatusComboSelect
			},
			'#reviewsmokingstatuscombo': {
				select: me.onSmokingStatusComboSelect
			},
			'#PatientSmokingStatusGridCounselingField': {
				select: me.onPatientSmokingStatusGridCounselingFieldSelect
			}
		});

		me.smokeStatusStore = Ext.create('App.store.patient.SmokeStatus',{
			pageSize: 1000,
			listeners:{
				scope: me,
				load: me.onSmokeStatusStoreLoad
			}
		});
	},

	onPatientSmokingStatusGridCounselingFieldSelect: function (cmb, selected_records){

		var record = cmb.up('form').getForm().getRecord();

		record.set({
			counseling_code: selected_records[0].get('code'),
			counseling_code_type: selected_records[0].get('code_type'),
		})
	},

	onSmokeStatusStoreLoad: function(store, records){
		if(store.last() && this.getSmokingStatusCombo()){
			this.getSmokingStatusCombo().setValue(store.last().data.status);
		}
	},

	onSmokingStatusComboSelect: function(cmb, records){
		var me = this;

		me.smokeStatusStore.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			status: records[0].data.option_name,
			status_code: records[0].data.code,
			status_code_type: records[0].data.code_type,
			create_uid: app.user.id,
			create_date: new Date()
		});

		me.smokeStatusStore.sync({
			success:function(){
				if(window.dual){
					dual.msg(_('sweet'), _('record_updated'));
				}else{
					app.msg(_('sweet'), _('record_updated'));
				}

				me.loadSmokeStatusStore(cmb.up('grid').up('panel'));
			},
			failure:function(){
				if(window.dual){
					dual.msg(_('oops'), _('record_error'), true);
				}else{
					app.msg(_('oops'), _('record_error'), true);
				}
			}
		});
	},

	onAddBtnClicked: function(){
		var record = this.getSocialHistoryTypeCombo().lastSelection[0],
			plugin = this.getSocialHistoryGrid().editingPlugin,
			addedRecs;

		if(!this.getSocialHistoryTypeCombo().isValid()) return;

		plugin.cancelEdit();
		addedRecs = this.getSocialHistoryGrid().getStore().add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_uid: app.user.id,
			update_uid: app.user.id,
			create_date: new Date(),
			update_date: new Date(),
			category_code: record.data.code,
			category_code_type: record.data.code_type,
			category_code_text: record.data.option_name
		});

		plugin.startEdit(addedRecs[0], 0);
	},

	onSocialHistoryBeforeEdit: function(plugin, e){
		var column = this.getObservationColumn(),
			editor;

		if(e.record.data.category_code == '229819007'){ // tobacco use
			editor = {
				xtype: 'gaiaehr.combo',
				valueField: 'option_name',
				itemId: 'socialsistoryobservationcombo',
				list: 106
			};
		}else if(e.record.data.category_code == '160573003'){ // alcohol intake
			editor = {
				xtype: 'gaiaehr.combo',
				valueField: 'option_name',
				itemId: 'socialsistoryobservationcombo',
				list: 105
			};
		}else if(e.record.data.category_code == '256235009'){ // exercise
			editor = {
				xtype: 'gaiaehr.combo',
				valueField: 'option_name',
				itemId: 'socialsistoryobservationcombo',
				list: 107
			};
		}else if(e.record.data.category_code == '363908000'){ // drug abuse
			editor = {
				xtype: 'gaiaehr.combo',
				valueField: 'option_name',
				itemId: 'socialsistoryobservationcombo',
				list: 108
			};
		}else{
			editor = {
				xtype: 'textfield'
			};
		}

		editor._marginWidth = 2;
		column.setEditor(editor);
		plugin.editor.onColumnResize(column);

	},

	onHistoryObservationComboSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			observation_code: records[0].data.code,
			observation_code_type: records[0].data.code_type
		});

	},

	onHistoryTypeComboSelectionChanged: function(){
		this.getSocialHistoryAddBtn().enable();
	},

	loadSmokeStore:function(){
		this.smokeStatusStore.clearFilter(true);
		this.smokeStatusStore.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	loadSmokeStatusStore:function(panel){
		var grids = panel.query('#PatientSmokingStatusGrid');

		if(grids.length > 0){
			var store = grids[0].getStore();
			store.clearFilter(true);
			store.filter([
				{
					property: 'pid',
					value: app.patient.pid
				}
			]);
		}
	},

	loadSocialHistoryStore: function(panel){
		var grids = panel.query('#PatientSocialHistoryGrid');

		if(grids.length > 0){
			var store = grids[0].getStore();
			store.clearFilter(true);
			store.filter([
				{
					property: 'pid',
					value: app.patient.pid
				}
			]);
		}
	},

	onSocialPanelActive: function(panel){
		this.loadSmokeStatusStore(panel);
		this.loadSocialHistoryStore(panel);
		this.loadSmokeStore();
		this.getSmokingStatusCombo().reset();

	}

});
Ext.define('App.controller.patient.SocialPsychologicalBehavioral', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'SocialPsychologicalBehavioralPanel',
			selector: '#SocialPsychologicalBehavioralPanel'
		},
		{
			ref: 'SocialPsychologicalBehavioralWindow',
			selector: '#SocialPsychologicalBehavioralWindow'
		},
		{
			ref: 'SocialPsychologicalBehavioralForm',
			selector: '#SocialPsychologicalBehavioralForm'
		},
		{
			ref: 'SocialPsychologicalBehavioralGrid',
			selector: '#SocialPsychologicalBehavioralGrid'
		},
		{
			ref: 'SocialPsychologicalBehavioralChart',
			selector: '#SocialPsychologicalBehavioralChart'
		}
	],

	init: function () {
		var me = this;
		me.control({
			'#SocialPsychologicalBehavioralPanel': {
				activate: me.onSocialPsychologicalBehavioralPanelActivate
			},
			'#SocialPsychologicalBehavioralGrid': {
				itemdblclick: me.onSocialPsychologicalBehavioralGridItemDblClick
			},
			'#SocialPsychologicalBehavioralAddBtn': {
				click: me.onSocialPsychologicalBehavioralAddBtnClick
			},
			'#SocialPsychologicalBehavioralPanelSaveBtn': {
				click: me.onSocialPsychologicalBehavioralPanelSaveBtnClick
			},
			'#SocialPsychologicalBehavioralPanelCancelBtn': {
				click: me.onSocialPsychologicalBehavioralPanelCancelBtnClick
			}
		});

		//me.doTest();

	},

	doTest: function () {
		var me = this;

		me.showSocialPsychologicalBehavioralWindow();
		return;

		Ext.create('Ext.window.Window', {
			title: 'Hello',
			height: 500,
			width: 1200,
			layout: 'fit',
			items: [
				Ext.create('App.view.patient.SocialPsychologicalBehavioral')
			]
		}).show();

		Ext.Function.defer(function () {
			me.onSocialPsychologicalBehavioralPanelActivate();
		}, 3000, me);
	},

	onSocialPsychologicalBehavioralPanelActivate: function () {
		var store = this.getSocialPsychologicalBehavioralGrid().getStore();

		store.clearFilter();
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid || 0 // TODO remove || 0 after development ...
			}
		]);
	},

	onSocialPsychologicalBehavioralAddBtnClick: function () {

		this.showSocialPsychologicalBehavioralWindow();

		var store = this.getSocialPsychologicalBehavioralGrid().getStore(),
			form = this.getSocialPsychologicalBehavioralForm().getForm();

		var records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_uid: app.user.id,
			create_date: new Date()
		});

		form.reset();
		form.loadRecord(records[0]);
	},

	onSocialPsychologicalBehavioralGridItemDblClick: function (grid, psy_record) {
		this.showSocialPsychologicalBehavioralWindow();

		var form = this.getSocialPsychologicalBehavioralForm().getForm();

		form.reset();
		form.loadRecord(psy_record);
	},

	onSocialPsychologicalBehavioralPanelSaveBtnClick: function () {
		var me = this,
			form = me.getSocialPsychologicalBehavioralForm().getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(!form.isValid()) return;

		values.patient_health_score =
			values.interest_pleasure +
			values.feeling_down_depressed;

		values.patient_drink_score =
			values.drink_often +
			values.drink_per_day +
			values.drink_more_than_6;

		values.patient_isolation_score =
			values.marital_status +
			values.phone_family +
			values.together_friends +
			values.religious_services +
			values.belong_organizations;

		values.patient_humiliation_score =
			values.abused_by_partner +
			values.afraid_of_partner +
			values.raped_by_partner +
			values.physically_hurt_by_partner;

		record.set(values);

		if(Ext.Object.isEmpty(record.getChanges())) {
			me.getSocialPsychologicalBehavioralWindow().close();
			return;
		}

		record.store.sync({
			callback: function (){
				me.getSocialPsychologicalBehavioralWindow().close();
			}
		});
	},

	onSocialPsychologicalBehavioralPanelCancelBtnClick: function () {
		this.getSocialPsychologicalBehavioralWindow().close();
	},

	showSocialPsychologicalBehavioralWindow: function () {
		if(!this.getSocialPsychologicalBehavioralWindow()){
			Ext.create('App.view.patient.windows.SocialPsychologicalBehavioral');
		}
		return this.getSocialPsychologicalBehavioralWindow().show();
	}

});
Ext.define('App.controller.patient.RxOrders', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [
		{
			ref: 'RxOrdersGrid',
			selector: 'patientrxorderspanel'
		},
		{
			ref: 'RxOrdersGridTopToolbar',
			selector: '#RxOrdersGridTopToolbar'
		},
		{
			ref: 'RxNormOrderLiveSearch',
			selector: '#RxNormOrderLiveSearch'
		},
		{
			ref: 'CloneRxOrderBtn',
			selector: '#cloneRxOrderBtn'
		},
		{
			ref: 'PrintRxOrderBtn',
			selector: '#printRxOrderBtn'
		},
		{
			ref: 'RxEncounterDxLiveSearch',
			selector: '#rxEncounterDxLiveSearch'
		},
		{
			ref: 'RxEncounterDxCombo',
			selector: '#RxEncounterDxCombo'
		},
		{
			ref: 'RxOrderMedicationInstructionsCombo',
			selector: '#RxOrderMedicationInstructionsCombo'
		},
		{
			ref: 'RxOrderGridFormNotesField',
			selector: '#RxOrderGridFormNotesField'
		},
		{
			ref: 'RxOrderCompCheckBox',
			selector: '#RxOrderCompCheckBox'
		},
		{
			ref: 'RxOrderSplyCheckBox',
			selector: '#RxOrderSplyCheckBox'
		},
		{
			ref: 'RxOrdersShowAllMedicationsBtn',
			selector: '#RxOrdersShowAllMedicationsBtn'
		},
		{
			ref: 'RxOrderActiveDrugAllergyFieldset',
			selector: '#RxOrderActiveDrugAllergyFieldset'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientrxorderspanel': {
				activate: me.onRxOrdersGridActive,
				selectionchange: me.onRxOrdersGridSelectionChange,
				beforerender: me.onRxOrdersGridBeforeRender,
				beforeedit: me.onRxOrdersGridBeforeEdit,
				edit: me.onRxOrdersGridEdit,
				validedit: me.onRxOrdersGridValidEdit
			},
			'#RxOrdersGridTopToolbar > button[action=rx_show]': {
				toggle: me.onRxOrdersGridShowBtnToggle
			},
			'#RxOrderEndDateField': {
				select: me.onRxOrderEndDateFieldSelect
			},
			'#RxNormOrderLiveSearch': {
				beforeselect: me.onRxNormOrderLiveSearchBeforeSelect
			},
			'#newRxOrderBtn': {
				click: me.onNewRxOrderBtnClick
			},
			'#cloneRxOrderBtn': {
				click: me.onCloneRxOrderBtnClick
			},
			'#printRxOrderBtn': {
				click: me.onPrintRxOrderBtnClick
			},
			'#RxOrderCompCheckBox': {
				change: me.onRxOrderCompCheckBoxChange
			},
			'#RxOrderSplyCheckBox': {
				change: me.onRxOrderSplyCheckBoxChange
			},
			'#RxOrdersShowAllMedicationsBtn': {
				toggle: me.onRxOrdersShowAllMedicationsBtnToggle
			},
			'#RxOrderGridFormUnableToPerformField': {
				select: me.onRxOrderGridFormUnableToPerformFieldSelect,
				fieldreset: me.onRxOrderGridFormUnableToPerformFieldReset
			}
		});
	},

	onRxOrderEndDateFieldSelect: function (field){
		var form = field.up('form').getForm();

		say('onRxOrderEndDateFieldSelect');
		say(field);

		form.getRecord().set({
			is_active: false,
			active: false
		});
	},

	onRxOrderGridFormUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},

	onRxOrderGridFormUnableToPerformFieldReset: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord();

		combo.setValue(null);
		form_record.set({
			not_performed_code: null,
			not_performed_code_type: null,
			not_performed_code_text: null,
		});
	},

	onRxOrdersShowAllMedicationsBtnToggle: function (btn, pressed) {
		this.doLoadOrdersGrid();
	},

	onRxOrdersDeleteActionHandler: function (grid, rowIndex, colIndex, item, e, record) {

		if(!a('remove_patient_medication')){
			app.msg(_('oops'), _('not_authorized'), true);
			return;
		}

		var me = this,
			store = grid.getStore();

		Ext.Msg.show({
			title: _('wait'),
			msg: ('<b>' + record.get('STR') + '</b><br><br>' + _('delete_this_record')),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn1) {
				if(btn1 === 'yes'){
					Ext.Msg.show({
						title: _('wait'),
						msg: _('this_action_can_not_be_undone_continue'),
						buttons: Ext.Msg.YESNO,
						icon: Ext.Msg.QUESTION,
						fn: function (btn2) {
							if(btn2 === 'yes'){
								store.remove(record);
								store.sync({
									callback: function () {
										store.remove(record);
										store.sync({
											callback: function () {

											}
										});
									}
								});
							}
						}
					});
				}
			}
		});
	},

	onRxOrderCompCheckBoxChange: function(field, value){
		if(value){
			this.getRxOrderSplyCheckBox().setValue(false);
		}
	},

	onRxOrderSplyCheckBoxChange: function(field, value){
		if(value){
			this.getRxOrderCompCheckBox().setValue(false);
		}
	},

	doSelectOrderByOrderId: function(id){
		var sm = this.getRxOrdersGrid().getSelectionModel(),
			record = this.getRxOrdersGrid().getStore().getById(id);

		if(record){
			sm.select(record);
			return record;
		}

		return false;
	},

	onRxOrdersGridBeforeRender: function(grid){
		app.on('patientunset', function(){
			grid.editingPlugin.cancelEdit();
			grid.getStore().removeAll();
		});
	},

	onRxOrdersGridSelectionChange: function(sm, selected){
		this.getCloneRxOrderBtn().setDisabled(selected.length === 0);
		this.getPrintRxOrderBtn().setDisabled(selected.length === 0);
	},

	onRxNormOrderLiveSearchBeforeSelect: function(combo, record){
		var form = combo.up('form').getForm(),
			insCmb = this.getRxOrderMedicationInstructionsCombo(),
			order_record = form.getRecord(),
            store;

		order_record.set({
			STR: record.data.STR,
			RXCUI: record.data.RXCUI,
			CODE: record.data.CODE,
            GS_CODE: record.data.GS_CODE,
			NDC: record.data.NDC,
			TTY: record.data.TTY
		});

		try{
			var data = {};

			Rxnorm.getMedicationAttributesByRxcuiApi(record.data.RXCUI, function(response){

				if(response.propConceptGroup){
					response.propConceptGroup.propConcept.forEach(function(propConcept){

						if(propConcept.propCategory !== 'ATTRIBUTES' && propConcept.propCategory !== 'CODES') return;

						if(!data[propConcept.propCategory]){
							data[propConcept.propCategory] = {};
						}
						var propName = propConcept.propName.replace(' ', '_');
						data[propConcept.propCategory][propName] = propConcept.propValue;
					});
				}

				if(data.ATTRIBUTES && data.ATTRIBUTES.SCHEDULE && data.ATTRIBUTES.SCHEDULE != '0'){
					order_record.set({ is_controlled: true });
				}
			});


			store = record.instructions();
			insCmb.bindStore(store, true);
			insCmb.store = store;
			insCmb.store.load();
			form.findField('dispense').focus(false, 200);

		}catch (e){

		}

	},

	onRxOrdersGridBeforeEdit: function(plugin, context){

		if(!context.record.data.date_ordered){
			app.msg(_('oops'), _('unable_to_edit_non_ordered_medication'), true);
			return false;
		}

		this.getRxEncounterDxCombo().getStore().load({
			filters: [
				{
					property: 'eid',
					value: context.record.data.eid
				}
			]
		});

		this.getRxOrderMedicationInstructionsCombo().getStore().load({
			filters: [
				{
					property: 'rxcui',
					value: context.record.data.RXCUI
				}
			]
		});

		var me = this;
		//get patient allergies
		Allergies.getPatientAllergiesByEid(10, function (response){
			if(response === false) return;

			var fs = me.getRxOrderActiveDrugAllergyFieldset();

			var text = '<ul>';

			for(var i = 0; i < response.length; i++){
				text += '<li><b>' + response[i].allergy + '</b> - ' + response[i].reaction + ' - ' + response[i].severity + '</li>';
			}

			text += '</ul>';
			fs.update(text);
		});


	},

	onRxOrdersGridValidEdit: function (){

	},

	onRxOrdersGridEdit: function(plugin, context){
		var insCmb = this.getRxOrderMedicationInstructionsCombo(),
			instructions = context.record.data.directions,
			record = insCmb.findRecordByValue(instructions),
            store;

		// record found
		if(record !== false) return true;

		Ext.Msg.show({
			title: _('new_instruction'),
			msg: '<p>' + instructions + '</p><p>' + _('would_you_like_to_save_it') + '</p>',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn === 'yes'){
					store = insCmb.getStore();
					store.add({
						rxcui: context.record.data.RXCUI,
						occurrence: '1',
						instruction: instructions
					});
					store.sync();
				}
			}
		});
		return true;
	},

	onNewRxOrderBtnClick: function(btn){
		var grid = btn.up('grid');

		grid.editingPlugin.cancelEdit();

		grid.getStore().insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			refill: 0,
			daw: null,
			date_ordered: new Date(),
			begin_date: new Date(),
			created_date: new Date(),
			is_active: true,
			active: true,
		});

		grid.editingPlugin.startEdit(0, 0);
	},

	onCloneRxOrderBtnClick: function(btn){

		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('sure_you_want_clone_prescription'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn === 'yes'){
					me.doCloneOrder();
				}
			}
		});
	},

	doCloneOrder: function(additionalReference){

		var me = this,
			grid = me.getRxOrdersGrid(),
			sm = grid.getSelectionModel(),
			store = grid.getStore(),
			selection = sm.getSelection(),
			newDate = app.getDate(),
			records_data = [],
			records,
			data;

		grid.editingPlugin.cancelEdit();
		sm.deselectAll();

		for(var i = 0; i < selection.length; i++){

			data = Ext.clone(selection[i].data);

			// inactivate previous order
			selection[i].set({
				is_active: false,
				active: false,
				end_date: newDate
			});

			// make sure new order is active
			data.is_active = true;
			data.active = true;
			data.end_date = null

			data.pid = app.patient.pid;
			data.eid = app.patient.eid;
			data.uid = app.user.id;

			data.ref_order = data.id;
			if(typeof additionalReference === 'string'){
				data.ref_order += ('~' + additionalReference);
			}

			data.date_ordered = newDate;
			data.begin_date = newDate;
			data.created_date = newDate;

			// clear the id
			data.id = null;
			records_data.push(data);
		}

		records = store.insert(0, records_data);

		store.sync();

		//grid.editingPlugin.startEdit(records[0], 0);

		return records;
	},

	onPrintRxOrderBtnClick: function(input, print){
		var me = this,
			grid = me.getRxOrdersGrid(),
			orders = (Ext.isArray(input) ? input : grid.getSelectionModel().getSelection()),
			pdf_format = (g('order_pdf_format') || null),
			isSingleColumnTable = true,
			references = '',
			documents = {},
			columns,
            refs,
            text;

		orders.forEach(function(order){

			var date_ordered = Ext.Date.format(order.get('date_ordered'),'Y-m-d'),
				doc_key = '_' + order.get('eid') +
					order.get('pid') +
					order.get('uid') +
					date_ordered;

			if(!documents[doc_key]){
				documents[doc_key] = {};
				documents[doc_key].pid = order.get('pid');
				documents[doc_key].eid = order.get('eid');
				documents[doc_key].date_ordered = date_ordered;
				documents[doc_key].provider_uid = order.get('uid');
				documents[doc_key].orderItems = [];
				documents[doc_key].docType = 'Rx';
				documents[doc_key].templateId = 5;
				documents[doc_key].pdf_format = pdf_format;
				if(isSingleColumnTable){
					columns = [''];
				}else{
					columns = [
						'Description',
						'Instructions',
						'Dispense',
						'Refill',
						'Days Supply',
						'Dx',
						'Notes',
						'References'
					];
				}
				documents[doc_key].orderItems.push(columns);
			}

			if(order.get('ref_order') !== ''){
				refs = order.get('ref_order').split('~');
				if(refs.length >= 3){
					references = 'Rx Reference#: ' + refs[2];
				}
			}

			if(isSingleColumnTable){

				var lines = [];

				lines.push('<u>' + _('order_number') + '</u>: ' + g('rx_order_number_prefix') + order.get('id'));
				lines.push('<u>' + _('description') + '</u>: ' + '<b>' + order.get('STR').toUpperCase() + '</b>');
				lines.push('<u>' + _('dispense_as_written') + '</u>: ' + (order.get('daw') ? _('yes') : _('no')));
				lines.push('<u>' + _('quantity') + '</u>: ' + order.get('dispense'));

				if(order.get('days_supply')){
					lines.push('<u>' + _('days_supply') + '</u>: ' + order.get('days_supply'));
				}

				lines.push('<u>' + _('refill') + '</u>: ' + order.get('refill'));
				lines.push('<u>' + _('instructions') + '</u>: ' + order.get('directions'));

				var dxs = (order.get('dxs').join ? order.get('dxs').join(', ') : order.get('dxs'));
				if(dxs && dxs !== ''){
					lines.push('<u>' + _('dx') + '</u>: ' + (order.get('dxs').join ? order.get('dxs').join(', ') : order.get('dxs')));
				}

				if(order.get('notes') !== ''){
					lines.push('<u>' + _('notes_to_pharmacist') + '</u>: ' + order.get('notes'));
				}

				if(references !== ''){
					lines.push('<u>References</u>: ' + references);
				}

				if(order.get('system_notes') !== ''){
					lines.push('<b>' + order.get('system_notes') + '</b>');
				}

				documents[doc_key].orderItems.push([lines.join('<br>')]);

			}else{

				documents[doc_key].orderItems.push([
					order.get('STR') + ' ' + order.get('dose') + ' ' + order.get('route') + ' ' + order.get('form'),
					order.get('directions'),
					order.get('dispense'),
					order.get('refill'),
					order.get('days_supply'),
					(order.get('dxs').join ? order.get('dxs').join(', ') : order.get('dxs')),
					order.get('notes'),
					references
				]);
			}

		});



		Ext.Object.each(documents, function(key, params){




			DocumentHandler.createTempDocument(params, function(provider, response){
				if(print === true){
					Printer.doTempDocumentPrint(1, response.result.id);
				}else{
					if(window.dual){
						dual.onDocumentView(response.result.id, 'Rx');
					}else{
						app.onDocumentView(response.result.id, 'Rx');
					}
				}

			});
		});
	},

	onRxOrdersGridShowBtnToggle: function (btn, pressed){
		if(pressed){
			this.doLoadOrdersGrid();
		}
	},

	onRxOrdersGridActive: function(){
		this.doLoadOrdersGrid();
	},

	doAddOrderByTemplate: function(data){
		var me = this,
			grid = me.getRxOrdersGrid(),
			store = grid.getStore(),
			newDate = new Date();

		data.pid = app.patient.pid;
		data.eid = app.patient.eid;
		data.uid = app.user.id;
		data.date_ordered = newDate;
		data.begin_date = newDate;
		data.created_date = newDate;

		store.add(data);
		store.sync({
			success: function(){
				app.msg(_('sweet'), data.STR + ' ' + _('added'));
			}
		});

	},

	doLoadOrdersGrid: function () {

		if(!this.getRxOrdersGrid()) return;

		var grid = this.getRxOrdersGrid(),
			store = grid.getStore(),
			show_btn = this.getRxOrdersGridTopToolbar().query('button[pressed]');

		if(!grid.editingPlugin.editing){

			var filters = [
				{
					property: 'pid',
					value: app.patient.pid
				}
			];

			if(show_btn.length > 0 && show_btn[0].action2 === 'last_6_months'){
				filters.push({
					property: 'date_ordered',
					operator: '>=',
					value: Ext.util.Format.date(Ext.Date.subtract(new Date(), Ext.Date.MONTH, 6), 'Y-m-d H:i:s')
				});
			}else if(show_btn.length > 0 && show_btn[0].action2 === 'last_year'){
				filters.push({
					property: 'date_ordered',
					operator: '>=',
					value: Ext.util.Format.date(Ext.Date.subtract(new Date(), Ext.Date.MONTH, 12), 'Y-m-d H:i:s')
				});
			}

			if(!this.getRxOrdersShowAllMedicationsBtn().pressed){
				filters.push({
					property: 'date_ordered',
					operator: '!=',
					value: null
				});
			}

			store.clearFilter(true);
			store.filter(filters);

		}
	},

	ndcConvertToElevenDigits: function (ndc){

		if(ndc === '') return ndc;

		var ndcArray = ndc.split('-');
		// if [0] equals 11 number then return that number
		if(ndcArray[0].length === 11) return ndcArray[0];

		// if the number does not have 3 groups something went wrong
		// return the number glued back
		if(ndcArray.length !== 3) return ndcArray.join('');

		if(ndcArray[0].length === 4){
			ndcArray[0] = '0' + ndcArray[0];
		}else if(ndcArray[1].length === 3){
			ndcArray[1] = '0' + ndcArray[1];
		}else if(ndcArray[2].length === 1){
			ndcArray[2] = '0' + ndcArray[2];
		}

		return ndcArray.join('');

	}

});

Ext.define('App.controller.patient.Visits', {
	extend: 'Ext.app.Controller',
	refs: [

	],

	init: function(){
		var me = this;

		me.control({
			'#PatientVisitsPanel': {
				activate: me.onPatientVisitsPaneActivate
			}
		});
	},

	onPatientVisitsPaneActivate: function (panel) {
		panel.updateTitle(app.patient.name + ' (' + _('encounters') + ')');
		panel.historyGrid.store.clearFilter(true);
		panel.historyGrid.store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},


});

Ext.define('App.controller.patient.Summary', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientSummaryPanel',
			selector: '#PatientSummaryPanel'
		},
		{
			ref: 'PatientSummaryEncounterServicesPanel',
			selector: '#PatientSummaryEncounterServicesPanel'
		},
		{
			ref: 'PatientSummaryEncounterServicesPanelRenderingPhysicianField',
			selector: '#PatientSummaryEncounterServicesPanelRenderingPhysicianField'
		},
		{
			ref: 'PatientDocumentPanel',
			selector: 'patientdocumentspanel'
		},
		{
			ref: 'PatientCcdPanel',
			selector: 'patientccdpanel'
		},
		{
			ref: 'ReferralPanelGrid',
			selector: 'patientreferralspanel'
		},
		{
			ref: 'AddReferralBtn',
			selector: 'button[action=addReferralBtn]'
		},
		{
			ref: 'PrintReferralBtn',
			selector: '#printReferralBtn'
		}
	],

	/**
	 * summary panel is active
	 */
	summary_panel_is_active: false,

	init: function(){
		var me = this;
		me.control({
			'viewport': {
				patientset: me.onPatientSet
			},
			'#PatientSummaryPanel': {
				activate: me.onPatientSummaryPanelActivate,
				deactivate: me.onPatientSummaryPanelDeactivate
			},
			'#PatientSummaryEncountersPanel': {
				itemdblclick: me.onPatientSummaryEncounterDblClick,
				// TODO preguntar a Carli pr esto esta aqui
                //selectionchange: me.onPatientSummaryEncounterServicesPanelClick
			},
            '#PatientSummaryContactsPanel': {
                activate: me.reloadGrid
            },
			'#PatientSummeryNotesPanel': {
				activate: me.reloadGrid
			},
			// '#PatientSummaryRemindersPanel': {
			// 	activate: me.reloadGrid
			// },
			'#PatientSummaryVitalsPanel': {
				activate: me.reloadGrid
			},
			'#PatientEncounterHistoryPanel': {
				activate: me.reloadGrid
			},
			'#PatientAmendmentsPanel': {
				activate: me.reloadGrid
			},
			'#PatientSummaryDocumentsPanel': {
				activate: me.reloadGrid
			},
			'#PatientSummaryPreventiveCareAlertsPanel': {
				activate: me.reloadGrid
			}
		});

		me.nav = me.getController('Navigation');
	},

	onPatientSet: function (){


		say('summary_panel.....');

		var summary_panel = this.getPatientSummaryPanel();

		say(summary_panel);


		if(summary_panel){
			summary_panel.loadPatient();
		}
	},

	onPatientSummaryPanelActivate: function(panel){

		this.summary_panel_is_active = true;

		var params = this.nav.getExtraParams();

		if(params){
			if(params.document){
				panel.down('tabpanel').setActiveTab(this.getPatientDocumentPanel());
			}else if(params.ccd){
				panel.down('tabpanel').setActiveTab(this.getPatientCcdPanel());
			}
		}
	},


	onPatientSummaryPanelDeactivate: function(panel){
		this.summary_panel_is_active = false;
	},

	onPatientSummaryEncounterDblClick: function(grid, record){
		app.openEncounter(record.data.eid);
	},

	reloadGrid:function(grid){
		var store;

		if(grid.itemId == 'PatientSummaryVitalsPanel'){
			store = grid.down('vitalsdataview').getStore();
		}else{
			store = grid.getStore();
		}
		store.load({
			filters:[
				{
					property:'pid',
					value: app.patient.pid
				}
			]
		})
	}


});

Ext.define('App.controller.patient.encounter.Addenda', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'EncounterSoapAddendaFieldSet',
			selector: '#EncounterSoapAddendaFieldSet'
		},
		{
			ref: 'EncounterSoapAddendaGrid',
			selector: '#EncounterSoapAddendaGrid'
		},
		{
			ref: 'EncounterAddendumWindow',
			selector: '#EncounterAddendumWindow'
		},
		{
			ref: 'EncounterAddendumForm',
			selector: '#EncounterAddendumForm'
		}
	],

	init: function () {
		var me = this;

		me.control({
			'viewport': {
				encounterload: me.onEncounterLoad
			},
			'#EncounterMedicalToolbarAddendumAddBtn': {
				click: me.onEncounterMedicalToolbarAddendumAddBtnClick
			},
			'#EncounterAddendumFormCancelBtn': {
				click: me.onEncounterAddendumFormCancelBtnClick
			},
			'#EncounterAddendumFormSaveBtn': {
				click: me.onEncounterAddendumFormSaveBtnClick
			}
		});

	},

	onEncounterLoad: function (encounter, encounter_panel) {

		var me = this,
			addenda_fieldset = me.getEncounterSoapAddendaFieldSet(),
			addenda_grid = me.getEncounterSoapAddendaGrid();

		if (!addenda_fieldset || !addenda_grid) return;

		addenda_grid.store.load({
			filters: [
				{
					property: 'eid',
					value: encounter.get('eid')
				}
			],
			callback: function (addenda_records) {
				addenda_fieldset.setVisible(addenda_records.length > 0);
			}
		});
	},

	onEncounterMedicalToolbarAddendumAddBtnClick: function (btn) {
		var win = this.showEncounterAddendumWindow();


	},

	showEncounterAddendumWindow: function (){
		if(!this.getEncounterAddendumWindow()){
			Ext.create('App.view.patient.encounter.EncounterAddendumWindow');
		}
		return this.getEncounterAddendumWindow().show();
	},

	onEncounterAddendumFormCancelBtnClick: function (btn) {
		var win = btn.up('window'),
			form = win.down('form').getForm();

		form.reset();
		win.close();
	},

	onEncounterAddendumFormSaveBtnClick: function (btn) {

		var me = this,
			win = btn.up('window'),
			form = win.down('form').getForm(),
			values = form.getValues(),
			addenda_fieldset = me.getEncounterSoapAddendaFieldSet(),
			addenda_grid = me.getEncounterSoapAddendaGrid();

		if(!form.isValid()){
			return;
		}

		win.el.mask('Saving...');

		values.pid = app.patient.pid;
		values.eid = app.patient.eid;
		values.create_uid = app.user.id;
		values.update_uid = app.user.id;
		values.create_date = app.getDate();
		values.update_date = app.getDate();
		values.created_by_fname = app.user.fname;
		values.created_by_mname = app.user.mname;
		values.created_by_lname = app.user.lname;
		values.created_by = '';

		var addendum_record = Ext.create('App.model.patient.encounter.Addendum', values);

		addenda_fieldset.setVisible(true);
		addenda_grid.getStore().add(addendum_record);

		addenda_grid.getStore().sync({
			callback: function (){
				win.el.unmask();
				form.reset();
				win.close();

				app.msg(_('sweet'), 'Addendum Added');

				// TODO: whats next...

			}
		});

	}


});

Ext.define('App.controller.patient.Vitals', {
	extend: 'Ext.app.Controller',
	refs: [
		{
			ref: 'EncounterPanelVitalsPanel',
			selector: '#encounterPanel vitalspanel'
		},
		{
			ref: 'VitalsPanel',
			selector: 'vitalspanel'
		},
		{
			ref: 'VitalsBlocksPanel',
			selector: 'vitalspanel #vitalsBlocks'
		},
		{
			ref: 'VitalsBlocksPanel',
			selector: 'vitalspanel #vitalsBlocks'
		},
		{
			ref: 'VitalsHistoryGrid',
			selector: 'vitalspanel #historyGrid'
		},
		{
			ref: 'VitalsAddBtn',
			selector: 'vitalspanel #vitalAddBtn'
		},
		{
			ref: 'VitalSignBtn',
			selector: 'vitalspanel #vitalSignBtn'
		},
		//
		{
			ref: 'VitalTempFField',
			selector: '#vitalTempFField'
		},
		{
			ref: 'VitalTempCField',
			selector: '#vitalTempCField'
		},
		{
			ref: 'VitalHeightInField',
			selector: '#vitalHeightInField'
		},
		{
			ref: 'VitalHeightCmField',
			selector: '#vitalHeightCmField'
		},
		{
			ref: 'VitalWeightKgField',
			selector: '#vitalWeightKgField'
		},
		{
			ref: 'VitalWeightLbsField',
			selector: '#vitalWeightLbsField'
		},

		// blocks
		{
			ref: 'BpBlock',
			selector: 'vitalspanel #pulseBlock'
		},
		{
			ref: 'BpBlock',
			selector: 'vitalspanel #bpBlock'
		},
		{
			ref: 'TempBlock',
			selector: 'vitalspanel #tempBlock'
		},
		{
			ref: 'WeighBlock',
			selector: 'vitalspanel #weighBlock'
		},
		{
			ref: 'HeightBlock',
			selector: 'vitalspanel #heightBlock'
		},
		{
			ref: 'BmiBlock',
			selector: 'vitalspanel #bmiBlock'
		},
		{
			ref: 'NotesBlock',
			selector: 'vitalspanel #notesBlock'
		},
		{
			ref: 'PatientChartsWindow',
			selector: '#PatientChartsWindow'
		},
		{
			ref: 'PatientChartsIframe',
			selector: '#PatientChartsIframe'
		},
		{
			ref: 'PatientChartWeightVsAgeToFiveBtn',
			selector: '#PatientChartWeightVsAgeToFiveBtn'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				beforeencounterload: me.onAppBeforeEncounterLoad
			},
			'#PatientSummaryPanel vitalspanel': {
				activate: me.onPatientSummaryPanelVitalsPanelActivate
			},
			'vitalspanel #historyGrid': {
				selectionchange: me.onHistoryGridSelectionChange,
				beforeselect: me.onHistoryGridBeforeSelect,
				beforeedit: me.onHistoryGridBeforeEdit,
				validateedit: me.onHistoryGridValidEdit,
				edit: me.onHistoryGridEdit
			},
			'vitalspanel #vitalAddBtn': {
				click: me.onVitalAddBtnClick
			},
			'vitalspanel #vitalSignBtn': {
				click: me.onVitalSignBtnClick
			},
			'vitalspanel #vitalChartsBtn': {
				click: me.onVitalChartsBtnClick
			},
			'#PatientChartWeightVsAgeToFiveBtn': {
				click: me.onPatientChartWeightVsAgeToFiveBtnClick
			},
			'#PatientChartWeightVsAgeToTwentyBtn': {
				click: me.onPatientChartWeightVsAgeToTwentyBtnClick
			},
			'#PatientChartHeadCircumferenceVsAgeToFiveBtn': {
				click: me.onPatientChartHeadCircumferenceVsAgeToFiveBtnClick
			},
			'#PatientChartLengthVsAgeToFiveBtn': {
				click: me.onPatientChartLengthVsAgeToFiveBtnClick
			},
			'#PatientChartBMIBtn': {
				click: me.onPatientChartBMIBtnClick
			},

			/** conversions **/
			'#vitalTempFField':{
				keyup:me.onVitalTempFFieldKeyUp
			},
			'#vitalTempCField':{
				keyup:me.onVitalTempCFieldKeyUp
			},
			'#vitalHeightInField':{
				keyup:me.onVitalHeightInFieldKeyUp
			},
			'#vitalHeightCmField':{
				keyup:me.onVitalHeightCmFieldKeyUp
			},
			'#vitalWeightLbsField':{
				keyup:me.onVitalWeightLbsFieldKeyUp
			},
			'#vitalWeightKgField':{
				keyup:me.onVitalWeightKgFieldKeyUp
			}
		});
	},

	getVitalRecordsByDate: function (date){
		if(!date || !date.toLocaleDateString){
			return [];
		}
		var date_string = date.toLocaleDateString(),
			store = this.getVitalsHistoryGrid().getStore();
		return store.queryBy(function (vital){
			return vital.get('date').toLocaleDateString() === date_string;
		}).items;
	},

	onVitalChartsBtnClick: function(){
		if(!this.getPatientChartsWindow()){
			Ext.create('App.view.patient.windows.Charts');
		}
		this.getPatientChartsWindow().show();
	},

	onPatientChartWeightVsAgeToFiveBtnClick: function(){
		var chart_data = this.getChatData('weight_kg'),
			genger = app.patient.sex === 'M' ? 'boys' : 'girls';
 		this.getPatientChartsIframe().setSrc('lib/growthchart/index.html?type=wfa_'+genger+'_0_to_5&data=' + JSON.stringify(chart_data));
	},

	onPatientChartWeightVsAgeToTwentyBtnClick: function(){
		var chart_data = this.getChatData('weight_kg'),
			genger = app.patient.sex === 'M' ? 'boys' : 'girls';
		this.getPatientChartsIframe().setSrc('lib/growthchart/index.html?type=wfa_'+genger+'_2_to_20&data=' + JSON.stringify(chart_data));

	},

	onPatientChartHeadCircumferenceVsAgeToFiveBtnClick: function(){
		var chart_data = this.getChatData('head_circumference_cm'),
			genger = app.patient.sex === 'M' ? 'boys' : 'girls';
		this.getPatientChartsIframe().setSrc('lib/growthchart/index.html?type=hcfa_'+genger+'_0_to_5&data=' + JSON.stringify(chart_data));

	},

	onPatientChartLengthVsAgeToFiveBtnClick: function(){
		var chart_data = this.getChatData('height_cm'),
			genger = app.patient.sex === 'M' ? 'boys' : 'girls';
		this.getPatientChartsIframe().setSrc('lib/growthchart/index.html?type=lfa_'+genger+'_0_to_5&data=' + JSON.stringify(chart_data));
	},

	onPatientChartBMIBtnClick: function(){
		var chart_data = this.getChatData('bmi'),
			genger = app.patient.sex === 'M' ? 'boys' : 'girls';
		this.getPatientChartsIframe().setSrc('lib/growthchart/index.html?type=bmi_'+genger+'_2_to_20&data=' + JSON.stringify(chart_data));
	},

	getChatData: function(measurement){
		var me = this,
			grid_store = me.getVitalsHistoryGrid().getStore(),
			vital_records = grid_store.data.items,
			patient_dob = app.patient.record.get('DOB'),
			chart_data = [];

		vital_records.forEach(function (vital_record) {

			var value = vital_record.get(measurement),
				age = app.getAge(patient_dob, vital_record.get('date')),
				age_in_months = (age.years * 12) + age.months;

			if(Ext.isEmpty(value) || value === 0) return;

			chart_data.push([age_in_months, value]);

		});

		return chart_data;
	},

	onPatientSummaryPanelVitalsPanelActivate: function (vitals_panel) {
		var grid = vitals_panel.down('grid'),
			sm = grid.getSelectionModel(),
			store  = grid.getStore();

		store.clearFilter(true);
		store.load({
			filters: [
				{
					property: 'pid',
					value: app.patient.pid
				}
			],
			callback: function (records) {
				if(records.length > 0){
					sm.select(records[0]);
				}
			}
		});

	},

	onRxOrdersDeleteActionHandler: function (grid, rowIndex, colIndex, item, e, record) {

		if(!a('remove_patient_vitals')){
			app.msg(_('oops'), _('not_authorized'), true);
			return;
		}

		var me = this,
			store = grid.getStore();

		if(record.get('eid') !== app.patient.eid){
			app.msg(_('oops'), _('remove_encounter_related_error'), true);
			return;
		}

		Ext.Msg.show({
			title: _('wait'),
			msg: ('<b>' + Ext.Date.format(record.get('date'), g('date_time_display_format')) + '</b><br><br>' + _('delete_this_record')),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn1) {
				if(btn1 === 'yes'){
					Ext.Msg.show({
						title: _('wait'),
						msg: _('this_action_can_not_be_undone_continue'),
						buttons: Ext.Msg.YESNO,
						icon: Ext.Msg.QUESTION,
						fn: function (btn2) {
							if(btn2 === 'yes'){
								store.remove(record);
								store.sync({
									callback: function () {
										store.remove(record);
										store.sync({
											callback: function () {

											}
										});
									}
								});
							}
						}
					});
				}
			}
		});
	},

	onAppBeforeEncounterLoad: function(encounter_record, encounterPanel){
		if(encounterPanel.down('vitalspanel')){

			var me = this,
				grid = encounterPanel.down('vitalspanel').down('grid'),
				sm = grid.getSelectionModel(),
				vitals_store  = grid.getStore();

			vitals_store.clearFilter(true);
			vitals_store.load({
				filters: [
					{
						property: 'pid',
						value: encounter_record.get('pid')
					}
				],
				callback: function (vitals_records) {
					if(vitals_records.length > 0){
						sm.select(vitals_records[0]);
						app.fireEvent('patientvitalsload', me, encounter_record, vitals_records, vitals_store);
					}
				}
			});
		}
	},

	onHistoryGridSelectionChange: function(sm, records){
		var btn = sm.view.panel.down('#vitalSignBtn');

		this.doUpdateBlocks(sm.view.panel.up('vitalspanel'), records);
		if(records.length === 0 || records[0].data.auth_uid > 0){
			btn.disable();
		}else{
			btn.enable();
		}
	},

	onHistoryGridBeforeSelect: function(sm, record){
		var selected = sm.getSelection().length;

		if(selected > 0 && record.data.auth_uid > 0){
			app.msg(_('oops'),_('multi_select_signed_records_not_authorized'), true);
			return false;
		}

		return true;

	},

	onHistoryGridValidEdit: function(plugin, context){
		var me = this,
			form = plugin.editor.getForm(),
			w = me.isMetric() ? form.findField('weight_kg').getValue() : form.findField('weight_lbs').getValue(),
			h = me.isMetric() ? form.findField('height_cm').getValue() : form.findField('height_in').getValue(),
			bmi = me.bmi(w, h),
			bmiStatus = me.bmiStatus(bmi);

		context.record.set({
			bmi: bmi,
			bmi_status: bmiStatus
		});

		if(a('sign_enc') && context.record.get('auth_uid') === 0){
			context.record.set({
				authorized_by: app.getUserFullname(),
				auth_uid: app.user.id
			});
		}
	},

	onHistoryGridEdit: function(plugin, context){
		this.doUpdateBlocks(plugin.view.panel.up('vitalspanel'), [context.record])
	},

	onHistoryGridBeforeEdit: function(plugin, context){
		var auth_uid = context.record.get('auth_uid');
		if(auth_uid !== 0 && auth_uid !== app.user.id){
			app.msg(_('oops'), _('this_record_can_not_be_modified_because_it_has_been_signed_by') + ' ' + context.record.data.authorized_by, true);
			return false;
		}
		return true;
	},

	onVitalAddBtnClick: function(btn){
		var grid = btn.up('grid'),
			store = grid.getStore(),
			records;

		grid.editingPlugin.cancelEdit();
		records = store.add({
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			administer_by: app.getUserFullname(),
			date: new Date()
		});
		grid.editingPlugin.startEdit(records[0], 1);
	},

	onVitalSignBtnClick: function(){
		var me = this,
			grid = me.getVitalsHistoryGrid(),
			sm = grid.getSelectionModel(),
			records = sm.getSelection();

		app.fireEvent('beforevitalssigned', records);

		app.passwordVerificationWin(function(btn, password){

			if(btn === 'ok'){

				User.verifyUserPass(password, function(provider, response){
					if(response.result){

						for(var i = 0; i < records.length; i++){
							records[i].set({
								auth_uid: app.user.id
							});
						}

						records[0].store.sync({
							callback: function(){
								app.msg('Sweet!', _('vitals_signed'));
								app.fireEvent('vitalssigned', records);
							}
						});
					}else{
						Ext.Msg.show({
							title: 'Oops!',
							msg: _('incorrect_password'),
							buttons: Ext.Msg.OKCANCEL,
							icon: Ext.Msg.ERROR,
							fn: function(btn){
								if(btn === 'ok'){
									me.onVitalSignBtnClick();
								}
							}
						});
					}
				});
			}
		});

	},

	doUpdateBlocks: function(vitalspanel, records){
		var me = this,
			pulseBlock = vitalspanel.down('#pulseBlock'),
			bpBlock = vitalspanel.down('#bpBlock'),
			tempBlock = vitalspanel.down('#tempBlock'),
			weighBlock = vitalspanel.down('#weighBlock'),
			heightBlock = vitalspanel.down('#heightBlock'),
			bmiBlock = vitalspanel.down('#bmiBlock'),
			notesBlock = vitalspanel.down('#notesBlock');

		if(records.length > 0){
			pulseBlock.update(me.getBlockTemplate('pulse', records[0]));
			bpBlock.update(me.getBlockTemplate('bp', records[0]));
			if(me.isMetric()){
				tempBlock.update(me.getBlockTemplate('temp_c', records[0]));
				weighBlock.update(me.getBlockTemplate('weight_kg', records[0]));
				heightBlock.update(me.getBlockTemplate('height_cm', records[0]));
			}else{
				tempBlock.update(me.getBlockTemplate('temp_f', records[0]));
				weighBlock.update(me.getBlockTemplate('weight_lbs', records[0]));
				heightBlock.update(me.getBlockTemplate('height_in', records[0]));
			}
			bmiBlock.update(me.getBlockTemplate('bmi', records[0]));
			notesBlock.update(me.getBlockTemplate('other_notes', records[0]));
		}else{
			pulseBlock.update(me.getBlockTemplate('pulse', false));
			bpBlock.update(me.getBlockTemplate('bp', false));
			if(me.isMetric()){
				tempBlock.update(me.getBlockTemplate('temp_c', false));
				weighBlock.update(me.getBlockTemplate('weight_kg', false));
				heightBlock.update(me.getBlockTemplate('height_cm', false));
			}else{
				tempBlock.update(me.getBlockTemplate('temp_f', false));
				weighBlock.update(me.getBlockTemplate('weight_lbs', false));
				heightBlock.update(me.getBlockTemplate('height_in', false));
			}

			bmiBlock.update(me.getBlockTemplate('bmi', false));
			notesBlock.update(me.getBlockTemplate('other_notes', false));
		}
	},

	getBlockTemplate: function(property, record){
		var title = '',
			value = '',
			extra = '',
			symbol = '',
			align = 'center';

		if(record !== false){
			if(property === 'pulse'){
				title = _(property);
				value = record.data.pulse ?  + record.data.pulse : '--';
				extra = _('bpm');
			}else if(property === 'bp'){
				title = _(property);
				value = (record.data.bp_systolic + '/' + record.data.bp_diastolic);
				value = value === 'null/null' || value === '/' ? '--/--' : value;
				extra = _('systolic') + '/' + _('diastolic');

			}else if(property === 'temp_c' || property === 'temp_f'){
				title = _('temp');
				symbol = property === 'temp_c' ? '&deg;C' : '&deg;F';
				value = record.data[property] === null || record.data[property] === '' ? '--' : record.data[property] + symbol;
				extra = record.data.temp_location === '' ? '--' : record.data.temp_location;

			}else if(property === 'weight_lbs' || property === 'weight_kg'){
				title = _('weight');
				//				symbol = property == 'weight_lbs' ? ' lbs' : ' kg';
				value = record.data[property] === null || record.data[property] === '' ? '--' : record.data[property] + symbol;
				extra = property === 'weight_lbs' ? 'lbs/oz' : 'Kg';

			}else if(property === 'height_in' || property === 'height_cm'){
				title = _('height');
				symbol = property === 'height_in' ? ' in' : ' cm';
				value = record.data[property] === null || record.data[property] === '' ? '--' : record.data[property] + symbol;

			}else if(property === 'bmi'){
				title = _(property);
				value = record.data[property] === null || record.data[property] === '' ? '--' : this.decimalRound10(record.data[property], -1);
				extra = record.data.bmi_status === '' ? '--' : record.data.bmi_status;

			}else if(property === 'other_notes'){
				title = _('notes');
				value = record.data[property] === null || record.data[property] === '' ? '--' : record.data[property];
				align = 'left'
			}
		}else{
			if(property == 'temp_c' || property == 'temp_f'){
				title = _('temp');
			}else if(property == 'weight_lbs' || property == 'weight_kg'){
				title = _('weight');
			}else if(property == 'height_in' || property == 'height_cm'){
				title = _('height');
			}else if(property == 'other_notes'){
				title = _('notes');
				align = 'left'
			}else{
				title = _(property);
			}
			value = property == 'bp' ? '--/--' : '--';
			extra = '--';
		}

		return '<p class="title">' + title + '</p><p class="value" style="text-align: ' + align + '">' + value + '</p><p class="extra">' + extra + '</p>';
	},


	onVitalStoreWrite:function(store, operation, e){
		app.fireEvent('vitalwrite', store, operation, e);
	},

	onVitalTempFFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({temp_c: this.fc(field.getValue())});
	},

	onVitalTempCFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({temp_f: this.cf(field.getValue())});
	},

	onVitalHeightInFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({height_cm: this.incm(field.getValue())});
	},

	onVitalHeightCmFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({height_in: this.cmin(field.getValue())});
	},

	onVitalWeightLbsFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({weight_kg: this.lbskg(field.getValue())});
	},

	onVitalWeightKgFieldKeyUp:function(field){
		field.up('form').getForm().getRecord().set({weight_lbs: this.kglbs(field.getValue())});
	},


	/** Conversions **/

	/**
	 * Convert Celsius to Fahrenheit
	 * @param v
	 */
	cf: function(v){
		return Ext.util.Format.round((9 * v / 5 + 32), 1);
	},

	/**
	 * Convert Fahrenheit to Celsius
	 * @param v
	 */
	fc: function(v){
		return Ext.util.Format.round(((v - 32) * 5 / 9), 1);
	},

	/**
	 * Convert Lbs to Kg
	 * @param v
	 */
	lbskg: function(v){
		var lbs = v[0] || 0,
			oz = v[1] || 0,
			kg = 0,
			res;
		if(lbs > 0) kg = kg + (lbs / 2.2046);
		if(oz > 0) kg = kg + (oz / 35.274);
		return Ext.util.Format.round(kg, 1);
	},

	/**
	 * Convert Kg to Lbs
	 * @param v
	 */
	kglbs: function(v){
		return Ext.util.Format.round((v * 2.2046), 1);
	},

	/**
	 * Convert Inches to Centimeter
	 * @param v
	 */
	incm: function(v){
		return Math.floor(v * 2.54);
	},

	/**
	 * Convert Centimeter to Inches
	 * @param v
	 */
	cmin: function(v){
		return  Ext.util.Format.round((v / 2.54), 0);
	},

	/**
	 * Get BMI from weight and height
	 * @param weight
	 * @param height
	 * @returns {*}
	 */
	bmi: function(weight, height){
		var bmi = '',
			foo = weight.split('/');

		if(foo.length > 1){
			weight = eval(foo[0]) + (foo[1] / 16);
		}

		if(weight > 0 && height > 0){
			if(!this.isMetric()){
				bmi = weight / (height * height) * 703;
			}else{
				bmi = weight / ((height / 100) * (height / 100));
			}
		}

		return bmi.toFixed ? bmi.toFixed(1) : bmi;
	},

	bmiStatus:function(bmi){
		var status = '';
		if(bmi == '') return '';
		if(bmi < 15){
			status = _('very_severely_underweight')
		}else if(bmi >= 15 && bmi < 16){
			status = _('severely_underweight')
		}else if(bmi >= 16 && bmi < 18.5){
			status = _('underweight')
		}else if(bmi >= 18.5 && bmi < 25){
			status = _('normal')
		}else if(bmi >= 25 && bmi < 30){
			status = _('overweight')
		}else if(bmi >= 30 && bmi < 35){
			status = _('obese_class_1')
		}else if(bmi >= 35 && bmi < 40){
			status = _('obese_class_2')
		}else if(bmi >= 40){
			status = _('obese_class_3')
		}
		return status;
	},

	/**
	 * return true if units of measurement is metric
	 */
	isMetric:function(){
		return g('units_of_measurement') === 'metric';
	},

    /*
    decimalAdjust:
        Method to correctly round numbers, with decimals.
        Thanks, to the excellentt guys a Mozilla Developer Network
        https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round
     */
    decimalAdjust: function(type, value, exp) {
        // If the exp is undefined or zero...
        if (typeof exp === 'undefined' || +exp === 0) {
            return Math[type](value);
        }
        value = +value;
        exp = +exp;
        // If the value is not a number or the exp is not an integer...
        if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
            return NaN;
        }
        // Shift
        value = value.toString().split('e');
        value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
        // Shift back
        value = value.toString().split('e');
        return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
    },

    /*
     decimalRound10:
        Method to correctly round numbers, with decimals.
        Thanks, to the excellentt guys a Mozilla Developer Network
        https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round
     */
    decimalRound10: function(value, exp) {
        return this.decimalAdjust('round', value, exp);
    },
    floorRound10: function(value, exp) {
        return decimalAdjust('floor', value, exp);
    },
    ceilRound10: function(value, exp) {
        return decimalAdjust('ceil', value, exp);
    }

});

Ext.define('App.controller.patient.encounter.EncounterDocuments', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [],

	init: function(){
		var me = this;

		this.control({
			'#EncounterDocumentsViewBtn': {
				click: me.onEncounterDocumentsViewBtnClick
			},
			'#EncounterDocumentsPrintBtn': {
				click: me.onEncounterDocumentsPrintBtnClick
			}
		});
	},

	onEncounterDocumentsPrintBtnClick: function (btn) {
		var grid = btn.up('grid'),
			selections = grid.getSelectionModel().getSelection(),
			groups = {};

		for(var i = 0; i < selections.length; i++){
			var data = selections[i].data;

			if(!groups[data.document_type]){
				groups[data.document_type] = {};
				groups[data.document_type]['controller'] = data.controller;
				groups[data.document_type]['method'] = data.method;
				groups[data.document_type]['items'] = [];
			}

			Ext.Array.push(groups[data.document_type]['items'], data.record_id);
		}

		this.doEncounterDocumentsView(groups, true);
	},

	onEncounterDocumentsViewBtnClick: function(btn){
		var grid = btn.up('grid'),
			selections = grid.getSelectionModel().getSelection(),
			groups = {};

		for(var i = 0; i < selections.length; i++){
			var data = selections[i].data;

			if(!groups[data.document_type]){
				groups[data.document_type] = {};
				groups[data.document_type]['controller'] = data.controller;
				groups[data.document_type]['method'] = data.method;
				groups[data.document_type]['items'] = [];
			}

			Ext.Array.push(groups[data.document_type]['items'], data.record_id);
		}

		this.doEncounterDocumentsView(groups, false);
	},

	doEncounterDocumentsView: function(groups, print){
		var me = this, store, filters, i;

		Ext.Object.each(groups, function(group, data){

			if(group.toUpperCase() === 'NOTE') {
				var note_store = Ext.data.StoreManager.lookup('DoctorsNotesStore'),
					note_filters = [];

				for (i = 0; i < data.items.length; i++) {
					Ext.Array.push(note_filters, {
						property: 'id',
						value: data.items[i]
					});
				}

				note_store.load({
					filters: note_filters,
					callback: function (records) {
						me.getController(data.controller)[data.method](records[0], print);
					}
				});

			}else if(group.toUpperCase() === 'REFERRAL'){
				var ref_store = Ext.data.StoreManager.lookup('ReferralsStore'),
					referral_filters = [];

				for(i = 0; i < data.items.length; i++){
					Ext.Array.push(referral_filters, {
						property: 'id',
						value: data.items[i]
					});
				}

				ref_store.load({
					filters: referral_filters,
					callback: function(records){
						me.getController(data.controller)[data.method](records[0], print);
					}
				});

			}else if(group.toUpperCase() === 'RX'){
				var rx_store = Ext.data.StoreManager.lookup('RxOrderStore'),
					rx_filters = [];

				for(i = 0; i < data.items.length; i++){
					Ext.Array.push(rx_filters, {
						property: 'id',
						value: data.items[i]
					});
				}

				rx_store.load({
					filters: rx_filters,
					callback: function(records){
						me.getController(data.controller)[data.method](records, print);
					}
				});


			}else if(group.toUpperCase() === 'RAD'){
				var lab_store = Ext.data.StoreManager.lookup('LabOrderStore'),
					lab_filters = [];

				for(i = 0; i < data.items.length; i++){
					Ext.Array.push(lab_filters, {
						property: 'id',
						value: data.items[i]
					});
				}

				lab_store.load({
					filters: lab_filters,
					callback: function(records){
						me.getController(data.controller)[data.method](records, print);
					}
				});

			}else if(group.toUpperCase() === 'LAB'){
				var rad_store = Ext.data.StoreManager.lookup('RadOrderStore'),
					rad_filters = [];

				for(i = 0; i < data.items.length; i++){
					Ext.Array.push(rad_filters, {
						property: 'id',
						value: data.items[i]
					});
				}

				rad_store.load({
					filters: rad_filters,
					callback: function(records){
						me.getController(data.controller)[data.method](records, print);
					}
				});

			}
		});
	},


	loadDocumentsByEid: function(grid, eid){
		var store = grid.getStore();

		store.removeAll();

		Encounter.getEncounterPrintDocumentsByEid(eid, function(results){
			var data = [];

			for(var i = 0; i < results.length; i++){
				var document = results[i];

				/**
				 * This define the Controller.Method to call for this document
				 *
				 */
				if(document.document_type == 'rx'){
					document.controller = 'patient.RxOrders';
					document.method = 'onPrintRxOrderBtnClick';
				}else if(document.document_type == 'rad'){
					document.controller = 'patient.RadOrders';
					document.method = 'onPrintRadOrderBtnClick';
				}else if(document.document_type == 'lab'){
					document.controller = 'patient.LabOrders';
					document.method = 'onPrintLabOrderBtnClick';
				}else if(document.document_type == 'note'){
					document.controller = 'patient.DoctorsNotes';
					document.method = 'onPrintDoctorsNoteBtn';
				}else if(document.document_type == 'referral'){
					document.controller = 'patient.Referrals';
					document.method = 'onPrintReferralBtnClick';
				}

				document.document_type = Ext.String.capitalize(document.document_type);

				Ext.Array.push(data, document);
			}

			if(data.length > 0){
				store.loadRawData(data);
				app.fireEvent('encounterdocumentsload', store);

			}
		});

	}

});

Ext.define('App.controller.patient.encounter.EncounterSign', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'EncounterSignWindow',
			selector: '#EncounterSignWindow'
		},
		{
			ref: 'EncounterCoSignSupervisorCombo',
			selector: '#EncounterCoSignSupervisorCombo'
		},
		{
			ref: 'EncounterCoSignSupervisorBtn',
			selector: '#EncounterCoSignSupervisorBtn'
		},
		{
			ref: 'EncounterCancelSignBtn',
			selector: '#EncounterCancelSignBtn'
		},
		{
			ref: 'EncounterSignBtn',
			selector: '#EncounterSignBtn'
		},
		{
			ref: 'EncounterSignDocumentGrid',
			selector: '#EncounterSignDocumentGrid'
		},
		{
			ref: 'EncounterSignAlertGrid',
			selector: '#EncounterSignAlertGrid'
		}
	],

	init: function(){
		var me = this;

		this.control({
			'#EncounterSignWindow': {
				show: me.onEncounterSignWindowShow
			},
			'#EncounterCoSignSupervisorCombo': {
				beforerender: me.onEncounterCoSignSupervisorComboBeforeRender
			},
			// Buttons
			'#EncounterCoSignSupervisorBtn': {
				click: me.onEncounterCoSignSupervisorBtnClick
			},
			'#EncounterSignBtn': {
				click: me.onEncounterSignBtnClick
			},
			'#EncounterCancelSignBtn': {
				click: me.onEncounterCancelSignBtnClick
			}
		});
	},

	onEncounterCoSignSupervisorBtnClick: function(){
		this.coSignEncounter();
	},

	onEncounterSignBtnClick: function(){
		this.signEncounter();
	},

	onEncounterCancelSignBtnClick: function(){
		this.cancelCheckout();
	},

	coSignEncounter: function(){
		this.getEncounterSignWindow().enc.doSignEncounter(true);
	},

	signEncounter: function(){
		if(a('require_enc_supervisor')){
			if(this.getEncounterCoSignSupervisorCombo().isValid()){
				this.getEncounterSignWindow().enc.doSignEncounter(false);
			}
		}else{
			this.getEncounterSignWindow().enc.doSignEncounter(false);
		}
	},

	cancelCheckout: function(){
		this.getEncounterSignWindow().close();
		this.getEncounterSignWindow().down('form').getForm().reset();
	},

	onEncounterCoSignSupervisorComboBeforeRender: function(cmb){
		cmb.getStore().load();
	},

	onEncounterSignWindowShow: function(){
		var me = this,
			win = me.getEncounterSignWindow(),
			coSignCombo = me.getEncounterCoSignSupervisorCombo(),
			coSignBtn = me.getEncounterCoSignSupervisorBtn(),
			signBtn = me.getEncounterSignBtn();

		me.encounter = win.enc.encounter;

		me.pid = win.enc.pid;
		me.eid = win.enc.eid;

		if(a('access_encounter_checkout')){

			App.app.getController('patient.encounter.SuperBill').reconfigureSupperBillGrid(me.encounter.services());

			me.getEncounterSignAlertGrid().getStore().load({
				params: {
					eid: me.eid
				}
			});
		}

		me.getEncounterSignDocumentGrid().loadDocs(app.patient.eid);

		var isCoSigned = win.enc.encounter.data.supervisor_uid != null && win.enc.encounter.data.supervisor_uid > 0;

		if(isCoSigned){
			coSignCombo.setValue(win.enc.encounter.data.supervisor_uid);
		}else{
			coSignCombo.reset();
		}

		if(win.enc.isClose() || !a('sign_enc')){
			signBtn.disable();
			coSignBtn.disable();
			coSignCombo.setVisible(isCoSigned);
			coSignCombo.disable();
		}else{
			// not previously signed and required supervisor
			if(!isCoSigned && a('require_enc_supervisor')){
				signBtn.enable();
				coSignBtn.disable();
				coSignCombo.show();
				coSignCombo.enable();

				// previously signed and supervisor
			}else if(isCoSigned && a('sign_enc_supervisor')){
				signBtn.disable();
				coSignBtn.enable();
				coSignCombo.show();
				coSignCombo.enable();
				// not previously and
			}else{
				signBtn.enable();
				coSignBtn.disable();
				coSignCombo.hide();
				coSignCombo.disable();
			}
		}
	},

	alertIconRenderer: function(v){
		if(v == 1){
			return '<img src="resources/images/icons/icoLessImportant.png" />'
		}else if(v == 2){
			return '<img src="resources/images/icons/icoImportant.png" />'
		}
		return v;
	}

});

Ext.define('App.controller.patient.encounter.SuperBill', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		// super bill stuff
		{
			ref: 'SuperBillGrid',
			selector: 'superbillpanel'
		},
		{
			ref: 'SuperBillServiceAddBtn',
			selector: '#SuperBillServiceAddBtn'
		},
		{
			ref: 'SuperBillEncounterDxCombo',
			selector: '#SuperBillEncounterDxCombo'
		},
		{
			ref: 'SuperBillPoceduresQuickPick',
			selector: '#SuperBillPoceduresQuickPick'
		},
		{
			ref: 'SuperBillPoceduresQuickPickForm',
			selector: '#SuperBillPoceduresQuickPickForm'
		}
	],

	init: function(){
		var me = this;

		this.control({
			'viewport': {
				immunizationedit: me.onImmunizationEdit
			},
			'superbillpanel': {
				beforeedit: me.onSuperBillGridBeforeEdit
			},
			'#SuperBillServiceAddBtn': {
				click: me.onSuperBillServiceAddBtnClick
			},
			'#SuperCptSearchCmb': {
				select: me.onSuperCptSearchCmbSelect
			},
			'#SuperBillServiceQuickPickBtn': {
				click: me.onSuperBillServiceQuickPickBtnClick
			},
			'#SuperBillPoceduresQuickPickCancelBtn': {
				click: me.onSuperBillPoceduresQuickPickCancelBtnClick
			},
			'#SuperBillPoceduresQuickPickSaveBtn': {
				click: me.onSuperBillPoceduresQuickPickSaveBtnClick
			}
		});


		me.encounterCtl = this.getController('patient.encounter.Encounter');
	},

	onImmunizationEdit:function(controller, record){
		var serviceRecords = this.getServiceFormEncounterRecord('cvx', record.data.id);

		if(serviceRecords.length == 0){
			this.promptAddService(record, 'cvx');
		}
	},

	promptAddService: function(record, type){
		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('super_bill_prompt_add_question'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){

				if(btn == 'yes'){
					me.addService(record, type);
				}
			}
		});
	},

	addService: function(record, type){
		var me = this;

		if(type == 'cvx'){
			Immunizations.getCptByCvx(record.data.code, function(services){
				if(services.length == 0){
					app.msg(_('oops'), _('no_service_code_found'), true);
				} else if(services.length == 1){
					me.doAddService(record, type, services[0]);
				}else{

				}
			});
		}

	},

	doAddService: function(record, type, service, callback){
		var store = this.ecounterCtl.getEncounterRecord().services(),
			serviceData = {
				pid: record.data.pid,
				eid: record.data.eid,
				units: 1,
				reference_type: type,
				reference_id: record.data.id,
				code: service ? service.data.code : record.data.code,
				code_type: service ? service.data.code_type : record.data.code_type,
				code_text: service ? service.data.code_text : record.data.code_text,
				create_uid: app.user.id,
				date_create: new Date()
			};

		if(record.data.tooth){
			serviceData.tooth = record.data.tooth;
		}

		if(record.data.surfaceString){
			serviceData.surface = record.data.surfaceString;
		}

		if(record.data.cavity_quadrant){
			serviceData.cavity_quadrant = record.data.cavity_quadrant;
		}

		var records = store.add(serviceData);

		store.sync({
			callback:function(){
				app.msg(_('sweet'), _('service_added'));
				if(typeof callback == 'function') callback(records[0]);
			}
		});
	},

	getServiceRecord: function(reference_id){
		var store = this.getController('patient.encounter.Encounter').getEncounterRecord().services();

		return store.getById(reference_id);
	},

	onSuperBillGridBeforeEdit: function(plugin, context){

		this.getSuperBillEncounterDxCombo().getStore().load({
			filters: [
				{
					property: 'eid',
					value: context.record.data.eid
				}
			]
		});
	},

	// super bill stuff
	onSuperBillServiceAddBtnClick: function(){
		var me = this,
			grid = me.getSuperBillGrid(),
			store = grid.getStore(),
			encounter = me.getController('patient.encounter.EncounterSign').encounter;

		grid.editingPlugin.cancelEdit();
		var records = store.add({
			pid: encounter.data.pid,
			eid: encounter.data.eid,
			units: 1,
			create_uid: app.user.id,
			date_create: new Date()
		});
		grid.editingPlugin.startEdit(records[0], 0);
	},

	onSuperCptSearchCmbSelect: function(cmb, records){
		var record = cmb.up('form').getForm().getRecord();

		record.set({
			code: records[0].data.code,
			code_type: records[0].data.code_type
		});
	},

	onRemoveService: function(record){
		var me = this;

		//TODO: handle the remove logic
		record.destroy();

	},

	reconfigureSupperBillGrid: function(store){
		this.getSuperBillGrid().reconfigure(store);
	},

	getServiceFormEncounterRecord: function(referenceType, referenceId){
		var encounter = this.getController('patient.encounter.Encounter').getEncounterRecord(),
			services = [];

		if(encounter == null) return services;

		var store = encounter.services(),
			records = store.data.items,
			len = store.data.items.length;

		for(var i = 0; i < len; i++){
			var record = records[i];

			if(record.data.reference_type == referenceType && record.data.reference_id == referenceId){
				Ext.Array.push(services, record);
			}
		}

		return services;
	},

	onSuperBillServiceQuickPickBtnClick: function(){

		this.showoSuperBillPoceduresQuickPick();
		var form_panel = this.getSuperBillPoceduresQuickPickForm(),
			encounter_record = this.encounterCtl.getEncounterRecord();

		form_panel.getForm().reset();
		this.loadQuickProceduresFields(form_panel, encounter_record.get('specialty_id'))

	},

	onSuperBillPoceduresQuickPickCancelBtnClick: function(){
		this.getSuperBillPoceduresQuickPickForm().getForm().reset();
		this.getSuperBillPoceduresQuickPick().close();
	},

	onSuperBillPoceduresQuickPickSaveBtnClick: function(){

		var me = this,
			form_panel = me.getSuperBillPoceduresQuickPickForm(),
			form = form_panel.getForm(),
			values = form.getValues(),
			encounter_record = this.encounterCtl.getEncounterRecord(),
			pid = encounter_record.get('pid'),
			eid = encounter_record.get('eid'),
			services = [];

		if(!values.services || encounter_record == null) return;

		values.services.forEach(function (service) {
			if(service === '0') return;
			var buff = service.split(':');
			services.push({
				pid: pid,
				eid: eid,
				units: 1,
				reference_type: '',
				reference_id: 0,
				code: buff[1],
				code_type: buff[0],
				code_text: buff[2],
				create_uid: app.user.id,
				date_create: app.getDate()
			});

		});

		var services_store = encounter_record.services();
		services_store.add(services);

		form_panel.el.mask(_('saving'));

		services_store.sync({
			callback: function () {
				form_panel.el.unmask();
				me.getSuperBillPoceduresQuickPickForm().getForm().reset();
				me.getSuperBillPoceduresQuickPick().close();
			}
		});

	},

	showoSuperBillPoceduresQuickPick: function(){
		if(!this.getSuperBillPoceduresQuickPick()){
			Ext.create('App.view.patient.windows.SuperBillPoceduresQuickPick');
		}
		return this.getSuperBillPoceduresQuickPick().show();
	},

	loadQuickProceduresFields: function (form_panel, specialty_id) {

		if(form_panel.specialty_id === specialty_id) return;

		form_panel.specialty_id = specialty_id;

		form_panel.removeAll();
		form_panel.el.mask(_('loading'));

		Services.getServicesQuickPickFieldsBySpecialty(1, function (fields) {
			form_panel.add(fields);
			form_panel.el.unmask();

		});

	}


});
Ext.define('App.controller.patient.encounter.PhysicalExam', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'EncounterPhysicalExamForm',
			selector: '#EncounterPhysicalExamForm'
		}
	],

	init: function () {
		var me = this;

		me.control({
			'viewport': {
				encounterload: me.onEncounterLoad,
				encounterbeforesync: me.onEncounterSync
			}
		});

	},

	onEncounterSync: function (encounter_panel, store, form, encounter_record) {

		var me = this,
			physical_exam_form = me.getEncounterPhysicalExamForm().getForm(),
			physical_exam_record = physical_exam_form.getRecord(),
			physical_exam_values =  physical_exam_form.getValues();

		// say('onEncounterSync');
		// say(encounter_record);
		// say(encounter_panel);
		// say(physical_exam_form);
		// say(physical_exam_record);
		// say(physical_exam_values);
		// say(physical_exam_record.get('id'));

		if(physical_exam_record.get('id') === undefined){
			physical_exam_record.set({
				exam_data: physical_exam_values,
				create_uid: app.user.id,
				create_date: app.getDate(),
				update_uid: app.user.id,
				update_date: app.getDate()
			});
		}else{
			physical_exam_record.set({
				exam_data: physical_exam_values,
				update_uid: app.user.id,
				update_date: app.getDate()
			});
		}

		if(!Ext.Object.isEmpty(physical_exam_record.getChanges())){
			physical_exam_record.save({
				callback: function (rec) {
					say(physical_exam_record);
					say(rec);
				}
			});
		}

	},

	onEncounterLoad: function (encounter_record, encounter_panel) {

		var me = this,
			physical_exam_form = me.getEncounterPhysicalExamForm().getForm(),
			physical_exam_record = encounter_record.physicalexams().getAt(0);

		if(physical_exam_record){
			physical_exam_record.set({
				pid: encounter_record.get('pid')
			});
		}else{
			physical_exam_record = encounter_record.physicalexams().add({
				eid: encounter_record.get('eid'),
				pid: encounter_record.get('pid')
			})[0];
		}

		// say('onEncounterLoad --->>> physical_exam_record');
		// say(physical_exam_form);
		// say(physical_exam_record);

		physical_exam_form.loadRecord(physical_exam_record);
		physical_exam_form.setValues(physical_exam_record.get('exam_data'));

	}





});

Ext.define('App.model.administration.ReferringProviderInsuranceBlacklist', {
	extend: 'Ext.data.Model',
	table: {
		name: 'referring_providers_insurance_blacklist'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'npi',
			type: 'string',
			len: 10,
			index: true
		},
		{
			name: 'specialty_id',
			type: 'int',
			useNull: true,
			index: true
		},
		{
			name: 'specialty_name',
			type: 'string',
			store: false
		},
		{
			name: 'insurance_id',
			type: 'int',
			useNull: true,
			index: true
		},
		{
			name: 'insurance_name',
			type: 'string',
			store: false
		},
		{
			name: 'note',
			type: 'string',
			len: 255
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ReferringProviders.getReferringProviderInsuranceBlacklists',
			create: 'ReferringProviders.addReferringProviderInsuranceBlacklist',
			update: 'ReferringProviders.updateReferringProviderInsuranceBlacklist',
			destroy: 'ReferringProviders.deleteReferringProviderInsuranceBlacklist'
		}
	}
});
Ext.define('App.controller.patient.encounter.SOAP', {
	extend: 'Ext.app.Controller',

	// defaults
	recognition: null,
	speechAction: null,
	recognizing: false,
	isError: false,

	final_transcript: '',
	interim_transcript: '',

	field: {
		name: 'subjective'
	},

	refs: [
		{
			ref: 'Viewport',
			selector: 'viewport'
		},
		{
			ref: 'SoapPanel',
			selector: '#soapPanel'
		},
		{
			ref: 'SoapForm',
			selector: '#soapPanel #soapForm'
		},
		{
			ref: 'SoapProcedureWindow',
			selector: '#soapProcedureWindow'
		},
		{
			ref: 'SoapProcedureForm',
			selector: '#soapProcedureWindow > form'
		},
		{
			ref: 'SnippetsTreePanel',
			selector: '#soapPanel #SnippetsTreePanel'
		},
		{
			ref: 'SpeechBtn',
			selector: '#soapPanel button[action=speechBtn]'
		},
		{
			ref: 'EncounterProgressNotesPanel',
			selector: '#EncounterProgressNotesPanel'
		},
		{
			ref: 'SoapDxCodesField',
			selector: '#SoapDxCodesField'
		},

		// templates specialties combo
		{
			ref: 'SoapTemplateSpecialtiesCombo',
			selector: '#SoapTemplateSpecialtiesCombo'
		},

		{
			ref: 'EncounterPanel',
			selector: '#encounterPanel'
		},
		{
			ref: 'EncounterDetailForm',
			selector: '#EncounterDetailForm'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				'encounterbeforesync': me.onEncounterBeforeSync
			},
			// '#soapPanel': {
			// 	// afterrender: me.onPanelBeforeRender
			// 	//activate: me.onPanelActive,
			// 	//deactivate: me.onPanelDeActive
			// },
			'#soapPanel #soapForm': {
				render: me.onPanelFormRender,
				write: me.onSoapFormWrite
			},
			'#SoapFormReformatTextBtn': {
				render: me.onSoapFormReformatTextBtnRender,
				click: me.onSoapFormReformatTextBtnClick
			},
			'#soapPanel button[action=speechBtn]': {
				toggle: me.onSpeechBtnToggle
			},
			'#soapForm > fieldset > textarea': {
				focus: me.onSoapTextFieldFocus
			},
			'#soapProcedureWindow > form > textarea': {
				focus: me.onProcedureTextFieldFocus
			},
			'#SoapDxCodesField': {
				recordadd: me.onSoapDxCodesFieldRecordAdd
			},
			'#SoapHealthStatusCmb': {
				select: me.onSoapHealthStatusCmbSelect
			}
		});


	},

	onSoapFormReformatTextBtnRender: function () {
		app.on('KEY-ALT-W', this.onSoapFormReformatTextBtnClick, this);
	},

	onSoapFormReformatTextBtnClick: function () {
		var me = this,
			form = me.getSoapForm().getForm(),
			subjectiveField = form.findField('subjective'),
			objectiveField = form.findField('objective'),
			assessmentField = form.findField('assessment'),
			instructionsField = form.findField('instructions');

		// say('onSoapFormReformatTextBtnClick');
		// say(me);
		// say(form);
		// say(subjectiveField);
		// say(objectiveField);
		// say(assessmentField);
		// say(instructionsField);

		subjectiveField.setValue(me.textParser(subjectiveField.getValue(),false,false,true,true,true,true));
		objectiveField.setValue(me.textParser(objectiveField.getValue(),false,false,true,true,true,true));
		assessmentField.setValue(me.textParser(assessmentField.getValue(),false,false,true,true,true,true));
		instructionsField.setValue(me.textParser(instructionsField.getValue(),false,false,true,true,true,true));

	},

	onSoapDxCodesFieldRecordAdd: function (field, record) {
		if(this.getSoapForm().autoSync) this.getSoapDxCodesField().sync();

	},

	onSoapHealthStatusCmbSelect: function(cmb, selection){
		var soap_record = cmb.up('form').getForm().getRecord();
		soap_record.set({
			health_status_code: selection[0].get('code'),
			health_status_code_type: selection[0].get('code_type')
		});
	},

	doChiefComplaintHandler: function (soap_record) {
		var encounter_record = this.getEncounterPanel().encounter;
		encounter_record.set({brief_description: soap_record.get('chief_complaint')});
		if(Ext.Object.isEmpty(encounter_record.getChanges())) return;
		encounter_record.save();
	},

	onSoapFormWrite: function (store, operation) {
		if(operation && operation.records && operation.records[0]){
			this.doChiefComplaintHandler(operation.records[0]);
		}
	},

	onEncounterBeforeSync: function(panel, store, form, record){

		if(form.owner.itemId !== 'soapForm') return;

		this.doChiefComplaintHandler(record);

		this.getSoapDxCodesField().sync();

	},

	onSoapTextFieldFocus: function(field){
		this.field = field;

		if(!Ext.isWebKit) return;
		this.final_transcript = field.getValue();
		this.interim_transcript = '';

		if(this.field.tip) return;

		this.field.tip = Ext.create('Ext.tip.ToolTip', {
			target: this.field.el,
			anchor: 'top',
			anchorOffset: 85,
			disabled: true,
			html: 'Press this button to clear the form'
		});
	},

	onProcedureTextFieldFocus: function(field){
		this.field = field;

		if(!Ext.isWebKit) return;
		this.final_transcript = field.getValue();
		this.interim_transcript = '';
	},

	// onPanelBeforeRender: function(panel){
	// 	if(!Ext.isWebKit) return;
	//
	// 	var btn = [
	// 		{
	// 			xtype: 'button',
	// 			icon: 'modules/worklist/resources/images/wand.png',
	// 			itemId: 'SoapFormReformatTextBtn',
	// 			tooltip: 'Reformat Text :: ALT-W',
	// 			minWidth: null,
	// 			hidden: !Ext.isWebKit
	// 		},
	// 		{
	// 			xtype: 'button',
	// 			action: 'speechBtn',
	// 			iconCls: 'speech-icon-inactive',
	// 			enableToggle: true,
	// 			minWidth: null,
	// 			hidden: !Ext.isWebKit
	// 		},
	// 		{ xtype: 'tbfill' }
	// 	];
	//
	// 	panel.down('form').getDockedItems('toolbar[dock="bottom"]')[0].insert(0, btn);
	// },

	onPanelFormRender: function(panel){
		Ext.widget('careplangoalsnewwindow', {
			constrainTo: panel.el.dom
		});
	},

	onSpeechBtnToggle: function(btn, pressed){
		if(pressed){
			this.initSpeech();
		}else{
			this.stopSpeech();
		}
	},

	stopSpeech: function(){
		this.recognition.stop();
		this.final_transcript = '';
		this.interim_transcript = '';
		delete this.recognition;
	},

	initSpeech: function(){
		var me = this;
		if(me.recognition) me.stopSpeech();
		me.final_transcript = me.field.getValue();
		me.recognition = new webkitSpeechRecognition();
		me.recognition.continuous = true;
		me.recognition.interimResults = true;
		me.recognition.lang = app.user.localization;

		me.recognition.onstart = function(){
			me.recognizing = true;
			me.setRecordButton(true);
		};

		me.recognition.onerror = function(event){
			me.recognizing = false;
			me.isError = true;
			me.setRecordButton(false);
		};

		me.recognition.onend = function(){
			me.recognizing = false;
			me.setRecordButton(false);
		};

		me.recognition.onresult = function(event){
			for(var i = event.resultIndex; i < event.results.length; ++i){
				if(event.results[i].isFinal){
					if(me.field.tip){
						me.field.tip.hide();
						me.field.tip.setDisabled(true);
					}
					me.field.setValue(me.field.getValue() + event.results[i][0].transcript);
				}else{
					if(me.field.tip){
						me.field.tip.setDisabled(false);
						me.field.tip.update(event.results[i][0].transcript);
						me.field.tip.show();
					}
				}
			}
		};

		me.recognition.start();
	},

	setRecordButton: function(recording){
		this.getSpeechBtn().setIconCls(recording ? 'speech-icon-active' : 'speech-icon-inactive');
	},

	textParser:  function (report, upperFullTitle, capsFullText, fixEndSentences, fixStartSentences, fixEndSentences2Spaces, fixTextAfterColon) {

		report = report.replace(/^[a-z]/, function(str){
			return str.toUpperCase();
		});

		if(upperFullTitle){
			report = report.replace(/.*:.*/g, function(str){
				return str.toUpperCase();
			});
		}else{
			report = report.replace(/.*:/g, function(str){
				return str.toUpperCase();
			});
		}

		if(capsFullText){
			report = report.replace(/[.\n]\s*[a-z]/g, function(str){
				return str.toUpperCase();
			});
		}

		if(fixEndSentences){
			if(fixEndSentences2Spaces){
				report = report.replace(/([a-z]\.)( |)([a-z])/gi, function(str, p1, p2, p3){
					return p1 + '  ' + p3.toUpperCase();
				});
			}else{
				report = report.replace(/([a-z]\.)(  |)([a-z])/gi, function(str, p1, p2, p3){
					return p1 + ' ' + p3.toUpperCase();
				});
			}
		}

		if(fixStartSentences){
			report = report.replace(/([a-z]\.)( |  )([a-z])/gi, function(str, p1, p2, p3){
				return p1 + '  ' + p3.toUpperCase();
			});

			report = report.replace(/(\r|\n|\r\n)([a-z])/gi, function(str, p1, p2, p3){
				return p1 + p2.toUpperCase();
			});
		}

		if(fixTextAfterColon){
			report = report.replace(/:( |  )[a-z]/g, function(str){
				return str.toUpperCase();
			});
		}



		return report;
	}

});

Ext.define('App.controller.patient.encounter.Procedure', {
	extend: 'Ext.app.Controller',

	refs: [
		{
			ref: 'EncounterProcedureWindow',
			selector: '#EncounterProcedureWindow'
		},
		{
			ref: 'EncounterProcedureForm',
			selector: '#EncounterProcedureForm'
		},
		{
			ref: 'EncounterProcedureSnomedProblemSearch',
			selector: '#EncounterProcedureSnomedProblemSearch'
		},
		{
			ref: 'EncounterProcedureSnomedSiteSearch',
			selector: '#EncounterProcedureSnomedSiteSearch'
		},
		{
			ref: 'EncounterProcedureGrid',
			selector: '#EncounterProcedureGrid'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'#EncounterProcedureSnomedProcedureSearch': {
				select: me.onEEncounterProcedureSnomedProcedureSearchSelect
			},
			'#EncounterProcedureSnomedSiteSearch': {
				select: me.onEncounterProcedureSnomedSiteSearchSelect
			},
			'#EncounterProcedureStatusField': {
				select: me.onEncounterProcedureStatusFieldSelect
			},
			'#EncounterProcedureFormSaveBtn': {
				click: me.onEncounterProcedureFormSaveBtnClick
			},
			'#EncounterProcedureFormCancelBtn': {
				click: me.onEncounterProcedureFormCancelBtnClick
			},
			'#EncounterProcedureGrid': {
				itemdblclick: me.onEncounterProcedureGridItemDblClick
			},
			'#EncounterProcedureGridAddBtn': {
				click: me.onEncounterProcedureGridAddBtnClick
			},
			'#EncounterProcedureUnableToPerformField': {
				select: me.onEncounterProcedureUnableToPerformFieldSelect
			}
		});

	},

	onEncounterProcedureUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},

	onEEncounterProcedureSnomedProcedureSearchSelect: function(cmb, selection){
		var soap_record = cmb.up('form').getForm().getRecord();
		soap_record.set({
			code: selection[0].get('ConceptId'),
			code_type: selection[0].get('CodeType'),
			code_text: selection[0].get('Term')
		});
	},

	onEncounterProcedureSnomedSiteSearchSelect: function(cmb, selection){
		var soap_record = cmb.up('form').getForm().getRecord();
		soap_record.set({
			target_site_code: selection[0].get('ConceptId'),
			target_site_code_type: selection[0].get('CodeType'),
			target_site_code_text: selection[0].get('Term')
		});
	},

	onEncounterProcedureStatusFieldSelect: function(cmb, selection){
		var record = cmb.up('form').getForm().getRecord();
		record.set({
			status_code: selection[0].get('code'),
			status_code_type: selection[0].get('code_type'),
			status_code_text: selection[0].get('code_type')
		});
	},

	onEncounterProcedureFormSaveBtnClick: function(btn){
		var win = this.getEncounterProcedureWindow(),
			form = this.getEncounterProcedureForm().getForm(),
			values = form.getValues(),
			record = form.getRecord(),
			encounter_ctl = app.getController('patient.encounter.Encounter');

		if(!form.isValid()) return;

		record.set(values);

		if(Ext.Object.isEmpty(record.getChanges())){
			form.reset();
			win.close();
		}else{
			record.store.sync({
				callback: function () {
					form.reset();
					win.close();
					encounter_ctl.getProgressNote();
				}
			});
		}

	},

	onEncounterProcedureFormCancelBtnClick: function(btn){
		var win = this.getEncounterProcedureWindow(),
			form = this.getEncounterProcedureForm().getForm(),
			record = form.getRecord();

		record.store.rejectChanges();
		form.reset();
		win.close();

	},

	onEncounterProcedureGridItemDblClick: function(grid, procedure_record){
		this.showEncounterProcedureWindow();
		this.getEncounterProcedureForm().getForm().loadRecord(procedure_record);

	},

	onEncounterProcedureGridAddBtnClick: function(btn){

		var gird = this.getEncounterProcedureGrid(),
			store = gird.getStore(),
			procedure_record = Ext.create('App.model.patient.encounter.Procedures', {
			pid: app.patient.pid,
			eid: app.patient.eid,
			create_uid: app.user.id,
			update_uid: app.user.id,
			create_date: new Date(),
			update_date: new Date()
		});

		store.add(procedure_record);

		this.onEncounterProcedureGridItemDblClick(gird, procedure_record);
	},

	showEncounterProcedureWindow: function () {
		if(!this.getEncounterProcedureWindow()){
			Ext.create('App.view.patient.windows.EncounterProcedureWindow');
		}
		return this.getEncounterProcedureWindow().show();
	}

});

Ext.define('App.view.patient.Medications', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.store.patient.Medications',
		'App.store.administration.Medications',
		'Ext.form.field.Trigger',
		'App.ux.LiveRXNORMSearch',
		'App.ux.combo.PrescriptionHowTo',
		'App.ux.combo.PrescriptionTypes',
		'App.ux.LiveSigsSearch',
		'App.ux.LiveUserSearch',
		'App.ux.form.fields.DateTime'
	],
	xtype: 'patientmedicationspanel',
	title: _('meds'),
	layout: 'border',
	border: false,
	items: [
		{
			xtype: 'grid',
			region: 'center',
			action: 'patientMedicationsListGrid',
			itemId: 'patientMedicationsGrid',
			columnLines: true,
            features: [{ftype:'grouping'}],
			store: Ext.create('App.store.patient.Medications', {
				autoSync: false,
                startCollapsed: true
			}),
			columns: [
				{
					xtype: 'griddeletecolumn',
					acl: a('remove_patient_medication'),
					width: 25
				},
				{
					xtype: 'actioncolumn',
					width: 25,
                    groupable: false,
					items: [
						{
							icon: 'resources/images/icons/blueInfo.png',  // Use a URL in the icon config
							tooltip: 'Get Info',
							handler: function(grid, rowIndex, colIndex, item, e, record){
								App.app.getController('InfoButton').doGetInfo(
                                    record.data.RXCUI,
                                    'RXCUI',
                                    record.data.STR
                                );
							}
						}
					]
				},
				{
					header: _('medication'),
					flex: 1,
                    groupable: true,
                    hidden: false,
					minWidth: 200,
					dataIndex: 'STR',
					editor: {
						xtype: 'rxnormlivetsearch',
						itemId: 'PatientMedicationLiveSearch',
						displayField: 'STR',
						valueField: 'STR',
						action: 'medication',
						allowBlank: false
					},
					renderer: function(v, mets, record){
						var codes = '';
						if(record.data.RXCUI != ''){
							codes += ' RxNorm: ' + record.data.RXCUI;
						}
						if(record.data.NDC != ''){
							codes += ' NDC: ' + record.data.NDC;
						}
						codes = codes != '' ? (' (' + codes + ' )') : '';
						return '<b>' + v + '</b>' + codes;
					}
				},
				{
					header: _('instructions') + ' (SIG)',
					flex: 1,
                    groupable: true,
                    hidden: false,
					minWidth: 200,
					dataIndex: 'directions',
					editor: {
						xtype: 'textfield'
					}
				},
				{
					xtype: 'datecolumn',
                    groupable: false,
					format: 'Y-m-d',
					header: _('begin_date'),
					width: 150,
					dataIndex: 'begin_date',
					sortable: false,
					hideable: false,
                    editor: {
                        xtype: 'datefield',
                        format: 'Y-m-d'
                    }
				},
				{
					xtype: 'datecolumn',
                    groupable: false,
					format: 'Y-m-d',
					header: _('end_date'),
					width: 150,
					dataIndex: 'end_date',
					sortable: false,
					hideable: false,
					editor: {
						xtype: 'datefield',
						format: 'Y-m-d',
						itemId: 'PatientMedicationEndDateField'
					}
				},
				{
					header: _('active?'),
                    groupable: false,
					width: 60,
					dataIndex: 'is_active',
					editor: {
						xtype: 'checkbox'
					},
					renderer: function(v){
						return app.boolRenderer(v);
					}
				}
			],
			plugins: Ext.create('Ext.grid.plugin.RowEditing', {
				autoCancel: false,
				errorSummary: false,
				clicksToEdit: 2
			}),
			bbar: [
				'-',
				{
					text: _('reconciled'),
					itemId: 'PatientMedicationReconciledBtn',
					enableToggle: true,
					pressed: true
				},
				'-',
                {
                    text: _('active'),
                    itemId: 'PatientMedicationActiveBtn',
                    enableToggle: true,
                    pressed: false
                },
				'->',
				{
					text: _('review'),
					itemId: 'ReviewMedicationsBtn'
				}
			]
		}
	],
	tbar: [
		'->',
		{
			text: _('add_new'),
			itemId: 'addPatientMedicationBtn',
			iconCls: 'icoAdd'
		}
	]


});

Ext.define('App.view.patient.Referrals', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.LiveCPTSearch',
		'App.ux.LiveICDXSearch',
		'App.ux.LiveReferringPhysicianSearch',
		'App.ux.combo.ActiveProviders',
		'Ext.selection.CheckboxModel',
		'App.ux.grid.RowFormEditing'
	],
	xtype: 'patientreferralspanel',
	title: _('refs'),
	action: 'referralsGrid',
	itemId: 'patientReferralsGrid',
	columnLines: true,
	allowDeselect: true,
	store: Ext.create('App.store.patient.Referrals', {
		remoteFilter: true,
		storeId: 'ReferralsStore'
	}),
	plugins: [
		{
			ptype: 'rowformediting',
			clicksToEdit: 2,
			items: [
				{
					xtype: 'container',
					defaults: {
						layout: 'anchor'
					},
					layout: {
						type: 'hbox',
						align: 'stretch'
					},
					items: [
						{
							xtype: 'container',
							flex: 1,
							defaults: {
								labelAlign: 'right',
								margin: '0 0 5 0'
							},
							items: [
								{
									xtype: 'datefield',
									fieldLabel: _('referral_date'),
									name: 'referral_date',
									format: 'Y-m-d',
									validateBlank: true
								},
								{
									xtype: 'snomedliveproceduresearch',
									fieldLabel: _('requested_service'),
									displayField: 'Term',
									valueField: 'Term',
									name: 'service_text',
									hideLabel: false,
									itemId: 'ReferralServiceSearch',
									anchor: '100%'
								},
								{
									xtype: 'textareafield',
									fieldLabel: _('reason'),
									name: 'referal_reason',
									anchor: '100%',
									height: 60
								},
								{
									xtype: 'liveicdxsearch',
									margin: '0 0 10',
									fieldLabel: _('diagnosis'),
									name: 'diagnosis_text',
									hideLabel: false,
									displayField: 'code_text',
									valueField: 'code_text',
									itemId: 'referralDiagnosisSearch',
									anchor: '100%'
								}
							]
						},
						{
							xtype: 'container',
							flex: 1,
							defaults: {
								labelAlign: 'right',
								margin: '0 0 5 0'
							},
							items: [
								{
									xtype: 'activeproviderscombo',
									fieldLabel: _('refer_by'),
									name: 'refer_by_text',
									width: 350,
									displayField: 'option_name',
									valueField: 'option_name',
									itemId: 'ReferralProviderCombo'
								},
								{
									xtype: 'container',
									layout: 'hbox',
									items: [
										{
											xtype: 'activeproviderscombo',
											fieldLabel: _('refer_to'),
											name: 'refer_to_text',
											labelAlign: 'right',
											margin: '0 5 5 0',
											width: 350,
											displayField: 'fullname',
											valueField: 'fullname',
											itemId: 'ReferralLocalProviderCombo'
										},
										{
											xtype: 'referringphysicianlivetsearch',
											fieldLabel: _('refer_to'),
											name: 'refer_to_text',
											labelAlign: 'right',
											margin: '0 5 5 0',
											hideLabel: false,
											width: 350,
											disabled: true,
											hidden: true,
											displayField: 'fullname',
											valueField: 'fullname',
											itemId: 'ReferralExternalProviderCombo'
										},
										{
											xtype: 'checkboxfield',
											boxLabel: _('external_referral'),
											itemId: 'ReferralExternalReferralCheckbox',
											name: 'is_external_referral'
										}
									]
								},

								{
									xtype: 'gaiaehr.combo',
									fieldLabel: _('risk_level'),
									name: 'risk_level',
									list: 17,
									width: 350
								},
//								{
//									xtype: 'checkboxfield',
//									fieldLabel: _('send_vitals'),
//									name: 'send_vitals',
//									width: 300
//								},
								{
									xtype: 'checkboxfield',
									fieldLabel: _('send_record'),
									name: 'send_record',
									width: 300
								}
							]
						}
					]
				}
			]
		}
	],
	selModel: Ext.create('Ext.selection.CheckboxModel'),
	columns: [
		{
			xtype: 'datecolumn',
			text: _('date'),
			dataIndex: 'referral_date',
			format: 'Y-m-d',
			menuDisabled: true,
			resizable: false
		},
		{
			text: _('request'),
			dataIndex: 'service_text',
			menuDisabled: true,
			resizable: false,
			flex: 1
		},
		{
			text: _('refer_by'),
			dataIndex: 'refer_by_text',
			menuDisabled: true,
			resizable: false,
			width: 200
		},
		{
			text: _('refer_to'),
			dataIndex: 'refer_to_text',
			menuDisabled: true,
			resizable: false,
			width: 200
		}
	],
	tbar: [
		'->',
		{
			text: _('referral'),
			iconCls: 'icoAdd',
			itemId: 'encounterRecordAdd',
			action: 'addReferralBtn'
		},
		'-',
		{
			text: _('print'),
			iconCls: 'icoPrint',
			disabled: true,
			itemId: 'printReferralBtn'
		}
	]
});
Ext.define('App.model.patient.EncounterDx', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_dx',
		comment: 'Encounter Diagnosis'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'dx_group',
			type: 'int',
			index: true
		},
		{
			name: 'dx_order',
			type: 'int',
			index: true
		},
		{
			name: 'dx_type',
			type: 'string',
			index: true,
			len: 5
		},
		{
			name: 'code',
			type: 'string',
			len: 25
		},
		{
			name: 'code_type',
			type: 'string',
			len: 25
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Encounter.getEncounterDxs',
			create: 'Encounter.createEncounterDx',
			update: 'Encounter.updateEncounterDx',
			destroy: 'Encounter.destroyEncounterDx'
		}
	},
	belongsTo: {
		model: 'App.model.patient.SOAP',
		foreignKey: 'eid'
	}
});
Ext.define('App.model.patient.ProcedureHistory', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_procedure_history'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'performed_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'procedure',
			type: 'string',
			len: 300
		},
		{
			name: 'procedure_code',
			type: 'string',
			len: 40
		},
		{
			name: 'procedure_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'target_site_code',
			type: 'string',
			len: 40
		},
		{
			name: 'target_site_code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'target_site_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'performer',
			type: 'string',
			len: 300
		},
		{
			name: 'performer_id',
			type: 'int',
			index: true
		},
		{
			name: 'service_location',
			type: 'string',
			len: 300
		},
		{
			name: 'service_location_id',
			type: 'int',
			index: true
		},
		{
			name: 'notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ProcedureHistory.getProcedureHistories',
			create: 'ProcedureHistory.addProcedureHistory',
			update: 'ProcedureHistory.updateProcedureHistory',
			destroy: 'ProcedureHistory.destroyProcedureHistory'
		}
	}
});

Ext.define('App.store.patient.ProcedureHistory', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.ProcedureHistory'
});
Ext.define('App.model.administration.ReferringProvider', {
    extend: 'Ext.data.Model',
    requires: [
        'App.model.administration.ReferringProviderFacility',
        'App.model.administration.ReferringProviderInsuranceBlacklist'
    ],
    table: {
        name: 'referring_providers'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'title',
            type: 'string',
            len: 10
        },
        {
            name: 'fname',
            type: 'string',
            len: 35
        },
        {
            name: 'mname',
            type: 'string',
            len: 25
        },
        {
            name: 'lname',
            type: 'string',
            len: 120
        },
        {
            name: 'organization_name',
            type: 'string',
            len: 120
        },
        {
            name: 'upin',
            type: 'string',
            len: 15,
            comment: 'Carrier Claim Referring Physician UPIN Number'
        },
        {
            name: 'lic',
            type: 'string',
            len: 15
        },
        {
            name: 'npi',
            type: 'string',
            len: 15
        },
        {
            name: 'ssn',
            type: 'string',
	        len: 15
        },
        {
            name: 'taxonomy',
            type: 'string',
            len: 15,
            comment: 'taxonomy',
            defaultValue: '207Q00000X'
        },
        {
            name: 'accept_mc',
            type: 'bool',
            comment: 'Accepts Medicare'
        },
        {
            name: 'notes',
            type: 'string',
            len: 600
        },
        {
            name: 'alerts',
            type: 'string',
            dataType: 'TEXT'
        },
        {
            name: 'email',
            type: 'string',
            len: 180
        },
        {
            name: 'direct_address',
            type: 'string',
            len: 180
        },
        {
            name: 'phone_number',
            type: 'string',
            len: 25
        },
        {
            name: 'fax_number',
            type: 'string',
            len: 25
        },
        {
            name: 'cel_number',
            type: 'string',
            len: 25
        },
        {
            name: 'allow_mail_notifications',
            type: 'bool'
        },
        {
            name: 'code',
            type: 'string',
            len: 50
        },
        {
            name: 'username',
            type: 'string',
            len: 40,
            useNull: true,
            index: true
        },
        {
            name: 'password',
            type: 'string',
            len: 300,
            encrypt: true
        },
        {
            name: 'authorized',
            type: 'bool',
            index: true
        },
        {
            name: 'external_id',
            type: 'string',
            len: 25
        },
        {
            name: 'global_id',
            type: 'string',
            len: 50,
            useNull: true
        },
        {
            name: 'authy_id',
            type: 'string',
            len: 45,
            index: true
        },
        {
            name: 'active',
            type: 'bool',
            index: true
        },
        {
            name: 'create_uid',
            type: 'int'

        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'create_date',
            type: 'date',
            comment: 'create date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            comment: 'last update date',
            dateFormat: 'Y-m-d H:i:s'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'ReferringProviders.getReferringProviders',
            create: 'ReferringProviders.addReferringProvider',
            update: 'ReferringProviders.updateReferringProvider'
        },
        reader: {
            root: 'data'
        }
    },
    hasMany: [
        {
            model: 'App.model.administration.ReferringProviderFacility',
            name: 'facilities',
            foreignKey: 'referring_provider_id'
        },
        {
            model: 'App.model.administration.ReferringProviderInsuranceBlacklist',
            name: 'blacklist',
            primaryKey: 'npi',
            foreignKey: 'npi'
        }
    ]
});

Ext.define('App.model.patient.SOAP', {
	extend: 'Ext.data.Model',
	requires: [
		'App.model.patient.Encounter',
		'App.model.patient.EncounterDx',
		'App.model.patient.encounter.Procedures'
	],
	table: {
		name: 'encounter_soap',
		comment: 'SOAP Data'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'chief_complaint',
			type: 'string',
			store: false
		},
		{
			name: 'subjective',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'objective',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'assessment',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'plan',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'instructions',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'health_status',
			type: 'string',
			len: 80
		},
		{
			name: 'health_status_code',
			type: 'string',
			len: 25
		},
		{
			name: 'health_status_code_type',
			type: 'string',
			len: 25
		}
	],
	proxy: {
		type: 'direct',
		api: {
			update: 'Encounter.updateSoap'
		},
		writer: {
			writeAllFields: true
		}
	},
	hasMany: [
		{
			model: 'App.model.patient.EncounterDx',
			name: 'dxCodes',
			primaryKey: 'eid',
			foreignKey: 'eid'
		},
		{
			model: 'App.model.patient.encounter.Procedures',
			name: 'procedures',
			primaryKey: 'eid',
			foreignKey: 'eid'
		}
	],
	belongsTo: {
		model: 'App.model.patient.Encounter',
		foreignKey: 'eid'
	}

});

Ext.define('App.view.miscellaneous.AddressBook', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'App.store.miscellaneous.AddressBook',
		'Ext.toolbar.Paging',
		'Ext.ux.SlidingPager'
	],
	pageTitle: _('address_book'),

	initComponent: function(){
		var me = this;

		me.grid = Ext.create('Ext.grid.Panel', {
			store: me.store = Ext.create('App.store.miscellaneous.AddressBook'),
			columns: [
				{
					header: _('name'),
					width: 200,
					dataIndex: 'fullname'
				},
				{
					header: _('primary_phone'),
					dataIndex: 'phone',
					width: 120
				},
				{
					header: _('cell_phone'),
					dataIndex: 'mobile',
					width: 120
				},
				{
					header: _('fax'),
					dataIndex: 'fax',
					width: 120
				},
				{
					header: _('email'),
					dataIndex: 'email',
					width: 120
				},
				{
					header: _('direct_address'),
					dataIndex: 'direct_address',
					width: 120
				},
				{
					header: _('notes'),
					dataIndex: 'notes',
					flex: 1
				}
			],
			plugins: [
				{
					ptype: 'rowformediting',
					items: [
						{
							xtype: 'container',
							layout: 'column',
							defaults: {
								xtype: 'container',
								layout: 'anchor',
								margin: 5
							},
							items: [
								{
									width: 500,
									defaults: {
										labelWidth: 80,
										anchor: '100%'
									},
									items: [
										{
											xtype: 'fieldcontainer',
											fieldLabel: _('name'),
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0'
											},
											items: [
												{
													xtype: 'textfield',
													emptyText: _('first_name'),
													name: 'fname',
													width: 130
												},
												{
													xtype: 'textfield',
													emptyText: _('middle_name'),
													name: 'mname',
													width: 50
												},
												{
													xtype: 'textfield',
													emptyText: _('last_name'),
													name: 'lname',
													flex: 1,
													margin: 0
												}
											]
										},
										{
											xtype: 'fieldcontainer',
											fieldLabel: _('address'),
											layout: 'anchor',
											defaults: {
												anchor: '100%',
												margin: '0 0 5 0'
											},
											items: [
												{
													xtype: 'textfield',
													emptyText: _('street'),
													name: 'street'
												},
												{
													xtype: 'textfield',
													name: 'street_cont'
												},
												{
													xtype: 'container',
													layout: 'hbox',
													defaults: {
														margin: '0 5 0 0'
													},
													items: [
														{
															xtype: 'textfield',
															emptyText: _('city'),
															name: 'city',
															flex: 1
														},
														{
															xtype: 'textfield',
															emptyText: _('state'),
															name: 'state',
															width: 120
														},
														{
															xtype: 'textfield',
															emptyText: _('zip'),
															name: 'zip',
															width: 100,
															margin: 0
														}
													]
												},
												{
													xtype: 'textfield',
													emptyText: _('country'),
													name: 'country',
													margin: '5 0 0 0'
												}
											]
										},
										{
											xtype: 'textfield',
											fieldLabel: _('notes'),
											name: 'notes',
											margin: '5 0 5 0'
										}
									]
								},
								{
									width: 300,
									layout: 'anchor',
									defaults: {
										anchor: '100%',
										labelWidth: 80,
										margin: '0 0 5 0'
									},
									items: [
										{
											xtype: 'textfield',
											fieldLabel: _('phone') + ' (1)',
											name: 'phone'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('phone') + ' (2)',
											name: 'phone2'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('cell_phone'),
											name: 'mobile'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('fax'),
											name: 'fax'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('email'),
											name: 'email',
											margin: '5 0 5 0',
											vtype: 'email'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('url'),
											name: 'url'
										}
									]
								},
								{
									width: 300,
									layout: 'anchor',
									defaults: {
										anchor: '100%',
										labelWidth: 100,
										margin: '0 0 5 0'
									},
									items: [
										{
											xtype: 'textfield',
											fieldLabel: _('direct_address'),
											name: 'direct_address'
										}
									]
								}
							]
						}
					]
				}
			],
			tbar: [
				{
					text: _('add_contact'),
					iconCls: 'icoAdd',
					scope: me,
					handler: me.onAddContact
				}
			],
			bbar: Ext.create('Ext.PagingToolbar', {
				store: me.store,
				displayInfo: true,
				plugins: Ext.create('Ext.ux.SlidingPager', {})
			})
		});

		me.pageBody = [ me.grid ];

		me.callParent(arguments);
	},

	onAddContact: function(){
		var me = this,
			grid = me.grid,
			store = grid.getStore(),
			plugin = grid.editingPlugin,
			record;
		plugin.cancelEdit();
		record = store.add({})[0];
		plugin.startEdit(record, 0);

	},

	onActive: function(callback){
		this.grid.getStore().load();
		callback(true);
	}
});

Ext.define('App.view.patient.AdvanceDirectives', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'patientadvancedirectivepanel',
	title: _('adv_dir'),
	columnLines: true,
	store: Ext.create('App.store.patient.AdvanceDirectives', {
		remoteFilter: true,
		autoSync: false
	}),
	columns: [
		{
			text: _('directive'),
			flex: 1,
			dataIndex: 'code_text',
			editor:{
				xtype:'gaiaehr.combo',
				list: 129,
				loadStore: true
			}
		},
		{
			text: _('status'),
			dataIndex: 'status_code_text',
			flex: 1,
			editor:{
				xtype:'gaiaehr.combo',
				list: 128,
				loadStore: true
			}
		},
		{
			text: _('notes'),
			flex: 2,
			dataIndex: 'notes',
			editor:{
				xtype:'textfield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('start_date'),
			dataIndex: 'start_date',
			editor:{
				xtype:'datefield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('end_date'),
			dataIndex: 'end_date',
			editor:{
				xtype:'datefield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('verified_date'),
			dataIndex: 'verified_date',
			editor:{
				xtype:'datefield'
			}
		}
	],
	plugins: [
		{
			ptype:'rowediting',
			errorSummary: false
		}
	],
	tbar:[
		'->',
		{
			text: _('add_new'),
			itemId: 'AdvanceDirectiveAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	],
	bbar: [
		'->',
		{
			text: _('review'),
			itemId: 'AdvanceDirectiveReviewBtn',
			action: 'encounterRecordAdd'
		}
	]


});
Ext.define('App.view.patient.LabOrders', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'Ext.grid.feature.Grouping',
		'Ext.selection.CheckboxModel',
		'App.ux.LiveLabsSearch',
		'App.ux.combo.Combo'
	],
	xtype: 'patientlaborderspanel',
	title: _('lab_orders'),
	itemId: 'LabOrders',
	columnLines: true,
	tabConfig: {
		cls: 'order-tab'
	},
	store: Ext.create('App.store.patient.PatientsOrders', {
		storeId: 'LabOrderStore',
		remoteFilter: true,
		pageSize: 200,
		sorters: [
			{
				property: 'date_ordered',
				direction: 'DESC'
			}
		],
        proxy: {
            type: 'direct',
            api: {
                read: 'Orders.getPatientLabOrders',
                create: 'Orders.addPatientOrder',
                update: 'Orders.updatePatientOrder',
                destroy: 'Orders.deletePatientOrder'
            },
            remoteGroup: false
        }
	}),
	selModel: Ext.create('Ext.selection.CheckboxModel', {
		showHeaderCheckbox: false
	}),
	plugins: [
		{
			ptype: 'rowediting',
			clicksToEdit: 2
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove'),
					handler: function (grid, rowIndex, colIndex, item, e, record) {
						App.app.getController('patient.LabOrders').onOrdersDeleteActionHandler(grid, rowIndex, colIndex, item, e, record);
					}
				}
			]
		},
		{
            header: _('void'),
            groupable: false,
            width: 50,
            align: 'center',
            dataIndex: 'void',
            tooltip: _('void'),
            editor:
            {
                xtype: 'checkbox'
            },
            renderer: function(v, meta, record)
            {
                return app.voidRenderer(v);
            }
		},
		{
			header: _('order#'),
			width: 60,
			dataIndex: 'id',
            renderer: function(v, meta, record)
            {
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		},
		{
			header: _('status'),
			width: 75,
			dataIndex: 'status',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 40
			},
			renderer: function(v, meta, record){
                var look = app.getController('patient.LabOrders').labOrdersGridStatusColumnRenderer(v);
                if(record.data.void) return '<span style="text-decoration: line-through;">'+look+'</span>';
                return look;
			}
		},
		{
			xtype: 'datecolumn',
			header: _('date_ordered'),
			width: 100,
			dataIndex: 'date_ordered',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield'
			},
            renderer: function(v, meta, record)
            {
            	var dt = Ext.Date.format(v, g('date_display_format'));
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ dt + '</span>';
                return '<span>'+ dt + '</span>';
            }
		},
		{
			header: _('code'),
			width: 100,
			dataIndex: 'code',
            renderer: function(v, meta, record)
            {
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		},
		{
			header: _('description'),
			flex: 1,
			dataIndex: 'description',
			editor: {
				xtype: 'labslivetsearch',
				itemId: 'rxLabOrderLabsLiveSearch'
			},
            renderer: function(v, meta, record)
            {
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		},
		{
			header: _('notes'),
			flex: 1,
			dataIndex: 'note',
			editor: {
				xtype: 'textfield'
			},
            renderer: function(v, meta, record)
            {
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		},
		{
			header: _('unable_to_perform'),
			flex: 1,
			dataIndex: 'not_performed_code_text',
			editor: {
				xtype: 'gaiaehr.combo',
				listKey: 'unable_to_perform_ord',
				displayField: 'option_name',
				valueField: 'option_name',
				itemId: 'LabOrdersUnableToPerformField',
				loadStore: true,
				editable: false,
				queryMode: 'local',
				resetable: true
			}
		},
		{
			header: _('priority'),
			width: 100,
			dataIndex: 'priority',
			editor: {
				xtype: 'gaiaehr.combo',
				listKey: 'proority'
			},
            renderer: function(v, meta, record)
            {
                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		},
		{
			header: _('date_collected'),
			width: 100,
			dataIndex: 'date_collected',
			editor: {
				xtype: 'datefield'
			},
            renderer: function(v, meta, record)
            {
            	v = v ? Ext.Date(v, g('date_display_format')) : '';

                if(record.data.void) return '<span style="text-decoration: line-through;">'+ v + '</span>';
                return '<span>'+ v + '</span>';
            }
		}
	],
	tbar: [
		{
			text: _('eLab'),
			iconCls: 'icoSend',
			itemId:'electronicLabOrderBtn'
		},
		'-',
		'->',
		'-',
		{
			text: _('new_order'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId:'newLabOrderBtn'
		},
		'-',
		{
			text: _('print'),
			iconCls: 'icoPrint',
			disabled: true,
			margin: '0 5 0 0',
			itemId:'printLabOrderBtn'
		}
	]
});

Ext.define('App.model.patient.ImplantableDevice', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_implantable_device'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'di',
			type: 'string',
			index: true,
			len: 180
		},
		{
			name: 'udi',
			type: 'string',
			index: true,
			len: 600
		},
		{
			name: 'description',
			type: 'string',
			len: 160
		},
		{
			name: 'description_code',
			type: 'string',
			len: 20
		},
		{
			name: 'description_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'gmdnpt_name',
			type: 'string',
			len: 160
		},
		{
			name: 'lot_number',
			type: 'string',
			len: 20
		},
		{
			name: 'serial_number',
			type: 'string',
			len: 20
		},
		{
			name: 'exp_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'mfg_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'donation_id',
			type: 'string',
			len: 160
		},
		{
			name: 'brand_name',
			type: 'string',
			len: 80
		},
		{
			name: 'version_model',
			type: 'string',
			len: 20
		},
		{
			name: 'company_name',
			type: 'string',
			len: 80
		},
		{
			name: 'mri_safety_info',
			type: 'string',
			len: 600
		},
		{
			name: 'required_lnr',
			type: 'bool'
		},
		{
			name: 'status',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code',
			type: 'string',
			len: 20
		},
		{
			name: 'status_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'implanted_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'removed_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ImplantableDevice.getPatientImplantableDevices',
			create: 'ImplantableDevice.addPatientImplantableDevice',
			update: 'ImplantableDevice.updatePatientImplantableDevice'
		}
	}
});

Ext.define('App.store.patient.ImplantableDevices', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.ImplantableDevice',
	remoteSort: true
});
Ext.define('App.view.patient.ImplantableDevice', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'implantabledevicepanel',
	itemId: 'ImplantableDeviceGrid',
	title: _('imp_devs'),
	store: Ext.create('App.store.patient.ImplantableDevices',{
		remoteFilter: true,
		remoteSort: true
	}),
	plugins: [{
		ptype: 'rowediting'
	}],
	columns: [
		{
			xtype:'actioncolumn',
			width: 25,
			icon: 'resources/images/icons/icoPatientInfo.png',
			tooltip: _('device_data'),
			handler: function(grid, rowIndex, colIndex, item, e, record) {
				app.getController('patient.ImplantableDevice').onImplantableDeviceGridActionClick(grid, record);
			}
		},
		{
			text: _('description'),
			dataIndex: 'description',
			flex: 1
		},
		{
			text: _('udi'),
			dataIndex: 'udi',
			flex: 2
		},
		{
			xtype: 'datecolumn',
			text: _('implanted'),
			dataIndex: 'implanted_date',
			format: g('date_display_format'),
			editor: {
				xtype: 'datefield',
				format: g('date_display_format')
			}
		},
		{
			xtype: 'datecolumn',
			text: _('removed'),
			dataIndex: 'removed_date',
			format: g('date_display_format'),
			editor: {
				xtype: 'datefield',
				format: g('date_display_format')
			}
		},
		{
			text: _('note'),
			dataIndex: 'note',
			flex: 2,
			editor: {
				xtype: 'textfield'
			}
		},
		{
			text: _('status'),
			dataIndex: 'status',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 113
			}
		}
	],
	tbar: [
		'->',
		{
			xtype: 'button',
			text: _('add'),
			iconCls: 'icoAdd',
			itemId: 'ImplantableDeviceGridAddBtn'
		}
	],
	bbar: [
		{
			xtype: 'button',
			text: _('active'),
			enableToggle: true,
			itemId: 'ImplantableDeviceGridActiveBtn'
		},
		'-',
		'->',
		{
			text: _('review'),
			itemId: 'ImplantableDeviceReviewBtn'
		}
	]
});

Ext.define('App.store.patient.FamilyHistories', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.FamilyHistory'
});
Ext.define('App.view.patient.FamilyHistory', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'Ext.grid.feature.Grouping'
	],
	xtype: 'patientfamilyhistorypanel',
	title: _('fam_hx'),
	columnLines: true,
	store: Ext.create('App.store.patient.FamilyHistories', {
		remoteFilter: true,
		groupField: 'relation'
	}),
	features: [
		{
			ftype: 'grouping'
		}
	],
	plugins: [
		{
			ptype: 'rowediting',
			clicksToEdit: 2
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove'),
                    handler: function(grid, rowIndex, colIndex, item, e, record){
                        App.app.getController('patient.FamilyHistory').onDeactivateRecord(grid, record);
                    }
				}
			]
		},
		{
			xtype: 'datecolumn',
			header: _('date'),
			width: 100,
			dataIndex: 'create_date',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield'
			}
		},
		{
			header: _('condition'),
			flex: 1,
			dataIndex: 'condition'
		},
		{
			header: _('relation'),
			flex: 1,
			dataIndex: 'relation',
            editor:{
                xtype: 'gaiaehr.listcombosimple',
                list: 109,
	            itemId: 'FamilyHistoryGridRelationField',
	            valueField: 'option_name',
                value: null
            }
		},
		{
			header: _('notes'),
			flex: 2,
			dataIndex: 'notes',
            editor:{
                xtype: 'textfield'
            }
		},
		{
			header: _('status'),
			flex: 1,
			dataIndex: 'status'
		}
	],
	tbar: [
		'->',
		{
			text: _('history'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId:'FamilyHistoryGridAddBtn'
		}
	]
});

Ext.define('App.view.patient.RadOrders', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'Ext.selection.CheckboxModel',
		'App.ux.combo.Combo',
		'App.ux.LiveRadsSearch'
	],
	xtype: 'patientradorderspanel',
	title: _('xray_ct_orders'),
	columnLines: true,
	tabConfig: {
		cls: 'order-tab'
	},
	itemId: 'RadOrders',
	store: Ext.create('App.store.patient.PatientsOrders', {
		storeId: 'RadOrderStore',
		remoteFilter: true,
		pageSize: 200,
		sorters: [
			{
				property: 'date_ordered',
				direction: 'DESC'
			}
		]
	}),
	selModel: Ext.create('Ext.selection.CheckboxModel', {
		showHeaderCheckbox: false
	}),
	plugins: [
		{
			ptype: 'rowediting',
			clicksToEdit: 2
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove'),
					handler: function (grid, rowIndex, colIndex, item, e, record) {
						App.app.getController('patient.RadOrders').onOrdersDeleteActionHandler(grid, rowIndex, colIndex, item, e, record);
					}
				}
			]
		},
		{
			header: _('order#'),
			width: 60,
			dataIndex: 'id'
		},
		{
			header: _('status'),
			width: 75,
			dataIndex: 'status',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 40
			},
			renderer: function(v){
				return app.getController('patient.RadOrders').radOrdersGridStatusColumnRenderer(v)
			}
		},
		{
			xtype: 'datecolumn',
			header: _('date_ordered'),
			width: 100,
			dataIndex: 'date_ordered',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield'
			}
		},
		{
			header: _('code'),
			width: 100,
			dataIndex: 'code'
		},
		{
			header: _('description'),
			flex: 2,
			dataIndex: 'description',
			editor: {
				xtype: 'radslivetsearch',
				itemId: 'radOrderliveSearch'
			}
		},
		{
			header: _('notes'),
			flex: 2,
			dataIndex: 'note',
			editor: {
				xtype: 'textfield'
			}
		},
		{
			header: _('unable_to_perform'),
			flex: 1,
			dataIndex: 'not_performed_code_text',
			editor: {
				xtype: 'gaiaehr.combo',
				listKey: 'unable_to_perform_ord',
				displayField: 'option_name',
				valueField: 'option_name',
				itemId: 'RadOrdersUnableToPerformField',
				loadStore: true,
				editable: false,
				queryMode: 'local',
				resetable: true
			}
		},
		{
			header: _('priority'),
			width: 100,
			dataIndex: 'priority',
			editor: {
				xtype: 'gaiaehr.combo',
				listKey: 'proority'
			}
		},
		{
			xtype: 'datecolumn',
			header: _('date_collected'),
			width: 100,
			dataIndex: 'date_collected',
			format: g('date_display_format'),
			editor: {
				xtype: 'datefield'
			}
		}
	],
	tbar: [
		{
			text: _('eRad'),
			iconCls: 'icoSend',
			itemId: 'electronicRadOrderBtn'
		},
		'-',
		'->',
		'-',
		{
			xtype: 'button',
			text: _('new_order'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId: 'newRadOrderBtn'
		},
		'-',
		{
			text: _('print'),
			iconCls: 'icoPrint',
			disabled: true,
			margin: '0 5 0 0',
			itemId: 'printRadOrderBtn'
		}
	]
});

Ext.define('App.view.patient.SupperBill', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'App.ux.LiveCPTSearch',
		'App.ux.combo.EncounterICDS'
	],
	xtype: 'superbillpanel',
	store: Ext.create('App.store.patient.EncounterServices'),
	columnLines: true,
	plugins: [
		{
			ptype: 'rowediting',
			errorSummary: false
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			menuDisabled: true,
			items: [
				{
					icon: 'resources/images/icons/delete.png',
					tooltip: _('remove'),
					handler: function(view, rowIndex, colIndex, item, e, record){
						return App.app.getController('patient.encounter.SuperBill').onRemoveService(record);
					}
				}
			]
		},
		{
			header: _('units'),
			dataIndex: 'units',
			width: 40,
			// menuDisabled: true,
			editor: {
				xtype: 'numberfield',
				minValue: 1,
				allowBlank: false
			}
		},
		{
			header: _('code'),
			dataIndex: 'code',
			// menuDisabled: true,
			width: 75
		},
		{
			text: _('service'),
			dataIndex: 'code_text',
			flex: 1,
			// menuDisabled: true,
			editor: {
				xtype: 'livecptsearch',
				itemId: 'SuperCptSearchCmb',
				valueField: 'code_text_medium',
				allowBlank: false
			}
		},
        {
            text: _('financial'),
            dataIndex: 'financial_class',
            flex: 1,
            //menuDisabled: true,
	        hidden: true,
            editor: {
                xtype: 'gaiaehr.listcombo',
                displayField: 'option_name',
                valueField: 'option_value',
                loadStore: true,
                queryMode: 'local',
                list: 135
            }
        },
		{
			header: _('modifiers'),
			dataIndex: 'modifiers',
			width: 100,
			// menuDisabled: true,
			editor: {
				xtype: 'textfield'
			}
		},
		//{
		//	header: _('tooth'),
		//	dataIndex: 'tooth',
		//	width: 50,
		//	menuDisabled: true
		//},
		//{
		//	header: _('surface'),
		//	dataIndex: 'surface',
		//	width: 60,
		//	menuDisabled: true,
		//	renderer: function(value, meta, record){
		//		var len = value.length,
		//			str = '',
		//			isMolar = App.app.getController('Modules.dental.controller.Plan').isMolar(record.data.tooth);
        //
		//		for(var i = 0; i < len; i++){
		//			if(value[i] == '0') continue;
        //
		//			if(value[i] == 'OI'){
		//				str += isMolar ? 'O' : 'I';
		//			}else if(value[i] == 'BF'){
		//				str += isMolar ? 'B' : 'F';
		//			}else{
		//				str += value[i];
		//			}
		//		}
		//		return str;
		//	}
		//},
		{
			header: _('diagnosis'),
			dataIndex: 'dx_pointers',
			menuDisabled: true,
			width: 250,
			editor: {
				xtype: 'encountericdscombo',
				itemId: 'SuperBillEncounterDxCombo',
				allowBlank: false
			}
		}
	],
	dockedItems: [
		{
			xtype: 'toolbar',
			dock: 'top',
			items: [
				'->',
				{
					text: _('quick_pick'),
					iconCls: 'icoAdd',
					itemId: 'SuperBillServiceQuickPickBtn'
				},
				'-',
				{
					text: _('service'),
					iconCls: 'icoAdd',
					itemId: 'SuperBillServiceAddBtn'
				}
			]
		}
	]
});
Ext.define('App.model.patient.PainScale', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_pain_scales'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'anatomical_region_code',
			type: 'string',
			len: 40
		},
		{
			name: 'anatomical_region_code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'anatomical_region_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'pain_scale',
			type: 'int'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'create user ID'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'update user ID'
		},
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'service_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PainScale.getPainsScales',
			create: 'PainScale.addPainScale',
			update: 'PainScale.addPainScale',
			destroy: 'PainScale.destroyPainScale'
		},
		reader: {
			root: 'data'
		},
		writer: {
			writeAllFields: true
		},
		remoteGroup: false
	}
});
Ext.define('App.store.patient.PainScales', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PainScale'
});



Ext.define('App.view.patient.PainScale', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'painscalepanel',
	itemId: 'PainScaleGrid',
	title: _('pain_scale'),
	store: Ext.create('App.store.patient.PainScales',{
		remoteFilter: true,
		remoteSort: true
	}),
	plugins: [{
		ptype: 'rowediting'
	}],
	columns: [
		{
			xtype:'griddeletecolumn',
			acl: a('delete_patient_pain_scales'),
			width: 25,

		},
		{
			text: _('anatomical_region'),
			dataIndex: 'anatomical_region_code_text',
			flex: 1,
			editor: {
				xtype: 'snomedlivebodysitesearch',
				name: 'anatomical_region_code_text',
				displayField: 'Term',
				valueField: 'Term',
				allowBlank: false
			}
		},
		{
			text: _('pain_scale'),
			dataIndex: 'pain_scale',
			flex: 2,
			renderer: function(val, meta, rec){
				var percent = val + '0';

				say(val);
				say(percent);

				meta.style = Ext.String.format('background: linear-gradient(90deg, rgb(37 157 249) 0%, rgb(37 157 249) {0}%, rgb(255 255 255) {0}%)',percent);

				return val;
			},
			editor: {
				xtype: 'slider',
				value: 0,
				increment: 1,
				minValue: 0,
				maxValue: 10
			}
		},
		{
			xtype: 'datecolumn',
			text: _('service_date'),
			dataIndex: 'service_date',
			format: g('date_display_format')
		}
	],
	tbar: [
		'->',
		{
			xtype: 'button',
			acl: a('add_patient_pain_scales'),
			text: _('add'),
			iconCls: 'icoAdd',
			itemId: 'PainScaleGridAddBtn'
		}
	],
	bbar: [
		{
			text: _('review'),
			itemId: 'PainScaleReviewBtn'
		}
	]
});
Ext.define('App.view.dashboard.panel.Portlet', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.portlet',
    layout: 'fit',
    anchor: '100%',
    frame: true,
    closable: true,
    collapsible: true,
    animCollapse: true,
    draggable: {
        moveOnDrag: false
    },
    cls: 'x-portlet',

    // Override Panel's default doClose to provide a custom fade out effect
    // when a portlet is removed from the portal
    doClose: function() {
        if (!this.closing) {
            this.closing = true;
            this.el.animate({
                opacity: 0,
                callback: function(){
                    this.fireEvent('close', this);
                    this[this.closeAction]();
                },
                scope: this
            });
        }
    }
});
Ext.define('App.ux.combo.EncounterSupervisors', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.encountersupervisorscombo',
	initComponent: function(){
		var me = this;

		Ext.define('EncounterSupervisorsComboModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'option_name',
					type: 'string'
				},
				{
					name: 'option_value',
					type: 'int'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getEncounterSupervisors'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'EncounterSupervisorsComboModel',
			autoLoad: false
		});

		Ext.apply(this, {
			editable: false,
			queryMode: 'local',
			displayField: 'option_name',
			valueField: 'option_value',
			emptyText: _('select'),
			store: me.store
		});

		me.callParent(arguments);
	}
}); 
Ext.define('App.ux.grid.AreasViewDropZone', {
	extend: 'Ext.grid.ViewDropZone',

	handleNodeDrop: function(data, record, position){
		var view = this.view,
			store = view.getStore(),
			index, records, i, len;
		/**
		 * fixed to handle the patient button data
		 */
		if(!data.patient){

			if(data.copy){
				records = data.records;
				data.records = [];
				for(i = 0, len = records.length; i < len; i++){
					data.records.push(records[i].copy());
				}
			}else{
				data.view.store.remove(data.records, data.view === view);
			}
		}

		if (record && position) {
			index = store.indexOf(record);

			// 'after', or undefined (meaning a drop at index -1 on an empty View)...
			if (position !== 'before') {
				index++;
			}
			store.insert(index, data.records);
		}
		// No position specified - append.
		else {
			store.add(data.records);
		}

//		view.getSelectionModel().select(data.records);
	},

	notifyEnter : function(dd, e, data){
		Ext.get(data.ddel.id).update(_('drop_patient_to_new_area'));
		this.callParent(arguments);
	},

	// While over a target node, return the default drop allowed class which
	// places a "tick" icon into the drag proxy.
	notifyOut : function(dd, e, data){
		Ext.get(data.ddel.id).update(_('drag_patient_to_new_area'));
		this.callParent(arguments);
	}

});


Ext.define('App.ux.grid.AreasDragDrop', {
	extend: 'Ext.grid.plugin.DragDrop',
	alias: 'plugin.areasgridviewdragdrop',

	onViewRender : function(view) {
		var me = this,
			scrollEl;

		if (me.enableDrag) {
			if (me.containerScroll) {
				scrollEl = view.getEl();
			}

			me.dragZone = new Ext.view.DragZone({
				view: view,
				ddGroup: me.dragGroup || me.ddGroup,
				dragText: me.dragText,
				containerScroll: me.containerScroll,
				scrollEl: scrollEl
			});
		}

		if (me.enableDrop) {
			me.dropZone = new App.ux.grid.AreasViewDropZone({
				view: view,
				ddGroup: me.dropGroup || me.ddGroup
			});
		}
	}
});
Ext.define('App.ux.LiveEducationResourceSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'educationresourcelivetsearch',
	hideLabel: true,
	displayField: 'surgery',
	valueField: 'id',
	emptyText: _('search') + '...',
	typeAhead: false,
	hideTrigger: true,
	minChars: 1,
	queryParam: 'term',
	pageSize: 10,
	language: 'patient',
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{
					name: 'title'
				},
				{
					name: 'url'
				},
				{
					name: 'rank'
				},
				{
					name: 'snippet'
				},
				{
					name: 'FullSummary'
				},
				{
					name: 'groupName'
				},
				{
					name: 'mesh'
				},
				{
					name: 'organizationName'
				}
			],
			model: 'liveLiveEducationResourceSearchModel',
			pageSize: me.pageSize,
			autoLoad: false,
			proxy: {
				type: 'direct',
				api: {
					read: 'EducationResources.search'
				},
				startParam: 'retstart',
				limitParam: 'retmax',
				reader: {
					root: 'data'
				}
			}
		});

		me.listConfig = {
			loadingText: _('searching') + '...',
			getInnerTpl: function () {
				return '<div class="search-item"><h3>{title}<span style="font-weight: normal"> ({snippet}) </span></h3></div>';
			}
		};

		me.listeners = {
			beforequery: function () {
				var db = 'healthTopics';

				if(me.language == 'patient'){
					if (app.patient.record && app.patient.record.get('language') == 'spa') {
						db = 'healthTopicsSpanish';
					}
				}else {
					if(me.language == 'spa' || me.language == 'es' || me.language == 'esp'){
						db = 'healthTopicsSpanish';
					}
				}

				me.store.getProxy().extraParams = { db: db };
			}
		};

		me.callParent();
	}
});

Ext.define('App.ux.AddTabButton', {
	alias: 'plugin.AddTabButton',
	extend: 'Ext.AbstractPlugin',

	// start defaults
	toolTip: 'Add Tab',     // add btn ToolTip
	iconCls: null,          // add btn icon class
	btnText: '+',           // add btn text, button text is not use if iconCls is set
	forceText: false,       // use the btnText even if an icon is used
	panelConfig: {              // default config for new added panel
		xtype: 'panel',
		title: 'New Tab',
		closable: true,
		hidden: false
	},
	// end defaults

	constructor: function(config){
		this.panelConfig = Ext.apply(this.panelConfig, config.tabConfig || {});
		this.callParent(arguments);
	},

	/**
	 * @param tabPanel
	 */
	init: function(tabPanel){
		var me = this;

		// set tabPanel global
		me.tabPanel = tabPanel;

		if(tabPanel instanceof Ext.TabPanel){
			// add add btn tab to the TabBar
			me.btn = me.tabPanel.getTabBar().add({
				xtype: 'tab',
				minWidth: 25,
				text: me.iconCls && !me.forceText ? '' : me.btnText, // if icon is used remove text
				iconCls: me.iconCls,
				tooltip: me.toolTip,
				handler: me.onAddTabClick,
				closable: false,
				acl: me.acl,
				scope: me
			});

			// fix the tab margin and padding
			me.btn.on('render', function(){
				if(me.iconCls && !me.forceText){
					var style;
					if(me.tabPanel.tabPosition == 'top'){
						style = 'margin: 0 0 3px 0; padding: 0';
					} else if(me.tabPanel.tabPosition == 'bottom'){
						style = 'margin: 3px 0 0 0; padding: 0';
					}
					me.btn.btnWrap.applyStyles(style);
				}
			});
		}
	},

	/**
	 *  Adds new Tab to TabPanel
	 */
	onAddTabClick: function(){
		var tab = this.tabPanel.add(this.panelConfig);
		this.tabPanel.fireEvent('newtabclick', tab, this.tabPanel);
		this.tabPanel.setActiveTab(tab);
	},

	/**
	 * disable or enable the Add button
	 * @param value
	 */
	setDisabled: function(value){
		this.btn.setDisabled(value);
	},

	/**
	 * hide or show the Add button
	 * @param value
	 */
	setVisible: function(value){
		this.btn.setVisible(value);
	}
});
Ext.define('App.ux.combo.Specialties', {
	extend: 'App.ux.combo.ComboResettable',
	xtype: 'specialtiescombo',
	displayField: 'text_details',
	valueField: 'id',
	editable: false,
	emptyText: _('select'),
	queryMode: 'local',
	store: Ext.create('App.store.administration.Specialties',{
		pageSize: 500,
		autoLoad: true
	})
});
Ext.define('App.view.patient.encounter.CarePlanGoals', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.store.patient.CarePlanGoals'
	],
	xtype: 'careplangoalsgrid',
	store: Ext.create('App.store.patient.CarePlanGoals'),

	frame: true,
	columns: [
		{
			text: _('goal'),
			dataIndex: 'goal',
			width: 200
		},
		{
			text: _('instructions'),
			dataIndex: 'instructions',
			flex: 1
		}
	],
	tbar: [
		_('care_plan_goals'),
		'->',
		{
			text: _('new_goal'),
			iconCls: 'icoAdd',
			itemId: 'NewCarePlanGoalBtn'
		}
	]
});
Ext.define('App.model.patient.MedicationAdministered', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_medications_administered'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'order_id',
			type: 'int',
			index: true
		},
		{
			name: 'rxcui',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'description',
			type: 'string',
			len: 180
		},
		{
			name: 'instructions',
			type: 'string',
			len: 180
		},
		{
			name: 'administered',
			type: 'bool'
		},
		{
			name: 'administered_uid',
			type: 'int',
			index: true
		},
		{
			name: 'administered_amount',
			type: 'string',
			len: 40
		},
		{
			name: 'administered_units',
			type: 'string',
			len: 40
		},
		{
			name: 'administered_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'administered_by',
			type: 'string',
			store: false,
			convert: function(v, record){
				return (record.data.administered_title + ' ' +
					record.data.administered_fname + ' ' +
					(record.data.administered_mname || '') + ' ' +
					record.data.administered_lname).trim();
			}
		},
		{
			name: 'administered_title',
			type: 'string',
			store: false
		},
		{
			name: 'administered_fname',
			type: 'string',
			store: false
		},
		{
			name: 'administered_mname',
			type: 'string',
			store: false
		},
		{
			name: 'administered_lname',
			type: 'string',
			store: false
		},
		{
			name: 'administration_site',
			type: 'string',
			len: 40
		},
		{
			name: 'adverse_reaction_text',
			type: 'string',
			len: 120
		},
		{
			name: 'adverse_reaction_code',
			type: 'string',
			len: 40
		},
		{
			name: 'adverse_reaction_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'manufacturer',
			type: 'string',
			len: 180
		},
		{
			name: 'exp_date',
			type: 'date',
			dataType: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'lot_number',
			type: 'string',
			len: 60
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
		{
			name: 'note',
			type: 'string',
			len: 600
		},
		{
			name: 'created_uid',
			type: 'int'
		},
		{
			name: 'updated_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Medications.getPatientMedicationsAdministered',
			create: 'Medications.addPatientMedicationAdministered',
			update: 'Medications.updatePatientMedicationAdministered',
			destroy: 'Medications.destroyPatientMedicationAdministered'
		},
        writer: {
            writeAllFields: true
        },
		remoteGroup: false
	}
});


Ext.define('App.store.patient.MedicationsAdministered', {
	extend: 'Ext.data.Store',
	requires: ['App.model.patient.MedicationAdministered'],
	model: 'App.model.patient.MedicationAdministered',
});

Ext.define('App.view.dashboard.panel.PortalColumn', {
	extend     : 'Ext.container.Container',
	alias      : 'widget.portalcolumn',

    requires: [
        'Ext.layout.container.Anchor',
        'App.view.dashboard.panel.Portlet'
    ],

    layout: 'anchor',
    defaultType: 'portlet',
    cls: 'x-portal-column'
	//
	// This is a class so that it could be easily extended
	// if necessary to provide additional behavior.
	//
});
Ext.define('App.view.patient.windows.EncounterCheckOut', {
	extend: 'App.ux.window.Window',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'App.view.patient.SupperBill',
		'App.ux.combo.EncounterSupervisors',
		'App.ux.LiveCPTSearch'
	],
	title: _('checkout_and_signing'),
	itemId: 'EncounterSignWindow',
	closeAction: 'hide',
	modal: true,
	layout: 'border',
	width: 1200,
	height: 690,
	bodyPadding: 5,

	pid: null,
	eid: null,

	items: [
		{
			xtype: 'superbillpanel',
			title: _('super_bill'),
			region: 'center',
			flex: 2
		},
		{
			xtype: 'encounterdocumentsgrid',
			title: _('documents'),
			region: 'east',
			itemId: 'EncounterSignDocumentGrid',
			width: 250
		},
		{
			xtype: 'form',
			title: _('additional_info'),
			region: 'south',
			split: true,
			height: 250,
			layout: 'column',
			defaults: {
				xtype: 'fieldset',
				padding: 8
			},
			items: [
				{
					xtype: 'container',
					columnWidth: .5,
					defaults: {
						xtype: 'fieldset',
						padding: 8,
						margin: '5 1 5 5'
					},
					padding: 0,
					layout: {
						type: 'vbox',
						align: 'stretch'
					},
					items: [
						{
							title: _('messages_notes_and_reminders'),
							defaults: {
								anchor: '100%'
							},
							items: [
								{
									xtype: 'textfield',
									name: 'message',
									fieldLabel: _('message')
								},
								{
									xtype: 'textfield',
									name: 'reminder',
									fieldLabel: _('reminder')
								},
								{
									xtype: 'textfield',
									grow: true,
									name: 'note',
									fieldLabel: _('note'),
									margin: 0
								}
							]
						},
						{
							title: _('follow_up'),
							flex: 1,
							defaults: {
								anchor: '100%'
							},
							items: [
								{
									xtype: 'mitos.followupcombo',
									fieldLabel: _('time_interval'),
									name: 'followup_time'
								},
								{
									fieldLabel: _('facility'),
									xtype: 'activefacilitiescombo',
									name: 'followup_facility',
									margin: 0
								}
							]
						}
					]
				},
				{
					xtype: 'fieldset',
					margin: 5,
					padding: 8,
					columnWidth: .5,
					layout: 'fit',
					height: 208,
					title: _('warnings_alerts'),
					items: [
						{
							xtype: 'grid',
							hideHeaders: true,
							store: Ext.create('App.store.patient.CheckoutAlertArea'),
							itemId: 'EncounterSignAlertGrid',
							border: false,
							rowLines: false,
							header: false,
							viewConfig: {
								stripeRows: false,
								disableSelection: true
							},
							columns: [
								{
									dataIndex: 'alertType',
									width: 30,
									renderer: function(v){
										return App.app.getController('patient.encounter.EncounterSign').alertIconRenderer(v);
									}
								},
								{
									dataIndex: 'alert',
									flex: 1
								}
							]
						}
					]
				}
			]
		}
	],
	dockedItems: [
		{
			xtype: 'toolbar',
			dock: 'bottom',
			ui: 'footer',
			itemId: 'EncounterSignWindowBottomToolbar',
			defaults: {
				minWidth: 70
			},
			items: [
				'->',
				{
					xtype: 'encountersupervisorscombo',
					itemId: 'EncounterCoSignSupervisorCombo',
					allowBlank: false,
					width: 250
				},
				{
					text: _('co_sign') + ' (' + _('supervisor') + ')',
					itemId: 'EncounterCoSignSupervisorBtn'
				},
				{
					text: _('sign'),
					itemId: 'EncounterSignBtn'
				},
				{
					text: _('cancel'),
					itemId: 'EncounterCancelSignBtn'
				}
			]
		}
	]
});

Ext.define('App.view.dashboard.panel.PortalPanel', {
	extend: 'Ext.panel.Panel',
	alias: 'widget.portalpanel',
	requires: [
		'Ext.layout.container.Column',

		'App.view.dashboard.panel.PortalDropZone',
		'App.view.dashboard.panel.PortalColumn'
	],

	cls: 'x-portal',
	bodyCls: 'x-portal-body',
	defaultType: 'portalcolumn',
	//componentLayout: 'body',
	autoScroll: true,

	manageHeight: false,

	initComponent: function(){
		var me = this;

		// Implement a Container beforeLayout call from the layout to this Container
		this.layout = {
			type: 'column'
		};
		this.callParent();

		this.addEvents({
			validatedrop: true,
			beforedragover: true,
			dragover: true,
			beforedrop: true,
			drop: true
		});
	},

	// Set columnWidth, and set first and last column classes to allow exact CSS targeting.
	beforeLayout: function(){
		var items = this.layout.getLayoutItems(),
			len = items.length,
			firstAndLast = ['x-portal-column-first', 'x-portal-column-last'],
			i, item, last;

		for(i = 0; i < len; i++){
			item = items[i];
			item.columnWidth = 1 / len;
			last = (i == len - 1);

			if(!i){ // if (first)
				if(last){
					item.addCls(firstAndLast);
				}else{
					item.addCls('x-portal-column-first');
					item.removeCls('x-portal-column-last');
				}
			}else if(last){
				item.addCls('x-portal-column-last');
				item.removeCls('x-portal-column-first');
			}else{
				item.removeCls(firstAndLast);
			}
		}

		return this.callParent(arguments);
	},

	// private
	initEvents: function(){
		this.callParent();
		this.dd = Ext.create('App.view.dashboard.panel.PortalDropZone', this, this.dropConfig);
	},

	// private
	beforeDestroy: function(){
		if(this.dd){
			this.dd.unreg();
		}
		this.callParent();
	}
});

Ext.define('App.view.areas.PatientPoolAreas', {
	extend: 'App.ux.RenderPanel',

	requires:[
		'App.ux.grid.AreasDragDrop'
	],

	itemId: 'PatientPoolAreasPanel',

	pageTitle: _('patient_pool_areas'),

	initComponent: function(){
		var me = this;

		me.pageBody = Ext.create('Ext.container.Container', {
			defaults: {
				flex: 1,
				margin: 2,
				frame: false
			},
			layout: {
				type: 'hbox',
				align: 'stretch'
			}
		});

		me.listeners = {
			beforerender: me.setPoolAreas
		};

		me.pageBBar = [
			{
				xtype: 'button',
				text: _('disable_alert_colors'),
				enableToggle: true,
				stateful: true,
				stateId: 'PatientPoolAreasDisableAlertColorsBtnState',
				itemId: 'PatientPoolAreasDisableAlertColorsBtn',

			},
			'->',
			{
				xtype: 'button',
				icon: 'resources/images/icons/gear.png',
				itemId: 'PatientPoolAreasRulesBtn'
			}
		];


		me.patientPoolAreaCtl = app.getController('areas.PatientPoolAreas');

		me.callParent(arguments);

	},

	onPatientDrop: function(node, data, overModel, dropPosition, eOpts){

		var me = this,
			name = (data.records[0].data) ? data.records[0].data.name : data.records[0].name,
			pid = (data.records[0].data) ? data.records[0].data.pid : data.records[0].pid;

		app.msg(_('sweet'), name + ' ' + _('sent_to') + ' ' + me.panel.title);

		app.nav.activePanel.doSendPatientToPoolArea(pid, me.panel.action, undefined, function (response) {

			// say('onPatientDrop');
			// say(data);
			// say(response);
			// say(response.zone.data.zone);

			if(response.zone){
				data.records[0].set({zone: response.zone.data.zone, time_in: app.getDate()});
			}else{
				data.records[0].set({time_in: app.getDate()});
			}
			data.records[0].commit();

		});
	},

	doSendPatientToPoolArea: function (pid, area_id, appointment_id, callback) {

		var me = this;

		app.fireEvent('beforesendpatienttoarea', me, pid, area_id, appointment_id);

		PoolArea.sendPatientToPoolArea({
			pid: pid,
			sendTo: area_id,
			appointment_id: appointment_id
		}, function(response){

			app.fireEvent('sendpatienttoarea', me, pid, area_id, appointment_id);

			if(response.floor_plan_id == null || response.zone){
				app.unsetPatient(null, true);
				app.nav['App_view_areas_PatientPoolAreas'].reloadStores();
				app.getPatientsInPoolArea();
				if(callback) callback(response);
				return;
			}

			app.getController('areas.FloorPlan').promptPatientZoneAssignment(response.record.pid, response.floor_plan_id, area_id, response.zone);

			if(callback) callback(response);

		});
	},

	doSendPatientToPoolAreaByConcept: function (pid, area_concept, appointment_id, callback) {

		var me = this,
			area_id = me.patientPoolAreaCtl.getPoolAreaIdByConcept(area_concept);

		me.doSendPatientToPoolArea(pid, area_id, appointment_id, callback)
	},

	reRenderPoolAreas:function(){
		var me = this,
			panel = me.getPageBody().down('container');

		panel.removeAll();
		me.setPoolAreas();
	},

	getPoolAreas: function () {
		return this.getPageBody().down('container').items.items;
	},

	setPoolAreas: function(){
		var me = this,
			panel = me.getPageBody().down('container'),
			poolarea_order_by = g('poolarea_order_by'),
			areas;
		// sorters appointment_time | time_in
		if(poolarea_order_by === 'appointment'){
			poolarea_order_by = 'appointment_time'
		}if(poolarea_order_by === 'checkin'){
			poolarea_order_by = 'time_in'
		}

		me.stores = [];

		PoolArea.getFacilityActivePoolAreas(function(provider, response){

			areas = response.result;

			for(var i = 0; i < areas.length; i++){

				var store = Ext.create('App.store.areas.PoolDropAreas', {
					groupField: (areas[i].floor_plan_id !== null ? 'zone' : undefined),
					sorters: [
						{
							property: poolarea_order_by,
							direction: 'asc'
						}
					],
					proxy: {
						type: 'direct',
						api: {
							read: 'PoolArea.getPoolAreaPatients'
						},
						extraParams: {
							area_id: areas[i].id
						}
					}
				});

				me.stores.push(store);

				panel.add({
					xtype: 'grid',
					multiSelect: true,
					title: areas[i].title,
					action: areas[i].id,
					store: store,
					floorPlanId: areas[i].floor_plan_id,
					floorPlanConcept: areas[i].concept,
					features: (areas[i].floor_plan_id !== null ? [{ftype:'grouping'}] : []),
					collapsible: true,
					collapseDirection: 'left',
					animCollapse: false,
					showAlertColor: true,
					columns: [
						Ext.create('Ext.grid.RowNumberer'),
						{
							header: _('record') + ' #',
							width: 100,
							dataIndex: 'pubpid',
							hidden: true,
							renderer: function (v,m,r) {
								if(this.showAlertColor){
									m.style = 'background-color:' + r.get('alert_color');
								}
								return v;
							}
						},
						{
							header: _('patient_name'),
							flex: 1,
							dataIndex: 'lname',
							renderer: function (v,m,r) {
								if(this.showAlertColor) {
									m.style = 'background-color:' + r.get('alert_color');
								}
								return Ext.String.format(
									'{0}{1}, {2} {3}',
									(r.get('eid') ? '*':''),
									r.get('lname'),
									r.get('fname'),
									r.get('mname')
								);
							}
						},
						{
							header: _('time_in'),
							width: 65,
							dataIndex: 'time_in',
							renderer: function (v,m,r) {
								if(this.showAlertColor) {
									m.style = 'background-color:' + r.get('alert_color');
								}
								return Ext.Date.format(v,g('time_display_format'));
							}
						},
						{
							header: _('schedule'),
							width: 65,
							dataIndex: 'appointment_time',
							renderer: function (v,m,r) {
								if(this.showAlertColor) {
									m.style = 'background-color:' + r.get('alert_color');
								}
								return Ext.Date.format(v,g('time_display_format'));
							}
						},
						{
							header: _('timer'),
							width: 65,
							dataIndex: 'timer',
							renderer: function (v,m,r) {
								if(this.showAlertColor) {
									m.style = 'background-color:' + r.get('alert_color');
								}
								return v;
							}
						}
					],
					viewConfig: {
						loadMask: false,
						plugins: {
							ptype: 'areasgridviewdragdrop',
							dragGroup: 'patientPoolAreas',
							dropGroup: 'patientPoolAreas'
						},
						listeners: {
							//scope:me,
							drop: me.onPatientDrop
						}
					},
					listeners: {
						scope: me,
						itemdblclick: me.onPatientDblClick
					}
				})
			}

			me.reloadStores();
		});
	},

	onPatientDblClick: function(store, record){
		var data = record.data;
		// TODO: set priority
		app.setPatient(data.pid, data.name, null, function(){
			app.openPatientSummary();
		});
	},

	reloadStores: function(){
		if(this.stores){
			for(var i = 0; i < this.stores.length; i++){
				this.stores[i].load();
			}
		}
	},

	onActive: function(callback){
//		this.reloadStores();
		if(typeof callback == 'function') callback(true);
	}
});

Ext.define('App.view.patient.encounter.EducationResourcesGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.DeleteColumn',
		'App.ux.LiveEducationResourceSearch'
	],
	xtype: 'educationresourcesgrid',
	itemId: 'EducationResourcesGrid',
	frame: true,
	initComponent: function(){
		var me = this;

		me.columns = [
			{
				xtype: 'griddeletecolumn',
				width: 25,
				acl: 'remove_encounter_education_resources'
			},
			{
				text: _('title'),
				dataIndex: 'title',
				width: 250
			},
			// {
			// 	text: _('snippet'),
			// 	dataIndex: 'snippet',
			// 	flex: 1
			// },
			{
				text: _('organization'),
				dataIndex: 'organization_name',
				flex: 1
			}
		];

		me.callParent();
	},
	tbar: [
		_('education_resources'),
		{
			xtype: 'educationresourcelivetsearch',
			itemId: 'EducationResourcesGridSearchField',
			width: 400,
			margin: '0 5 0 0'
		},
		'-',
		{
			xtype: 'button',
			text: _('find_encounter_related_education'),
			itemId: 'EducationResourcesGridFindEncounterRelatedBtn',
			margin: '0 5 0 5'
		},
		'-',
		{
			xtype: 'combobox',
			width: 150,
			labelWidth: 50,
			fieldLabel: _('language'),
			queryMode: 'local',
			displayField: 'option',
			valueField: 'value',
			editable: false,
			value: 'patient',
			stateful: true,
			margin: '0 0 0 5',
			stateId: 'EducationResourcesGridLanguageField',
			itemId: 'EducationResourcesGridLanguageField',
			store: Ext.create('Ext.data.Store', {
				fields: ['option', 'value'],
				data : [
					{option: _('patient'), value: 'patient'},
					{option: _('english'), value: 'en'},
					{option: _('spanish'), value: 'es'}
				]
			})
		},

	]


});
Ext.define('App.view.patient.ItemsToReview', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.view.patient.PainScale'
	],
	alias: 'widget.itemstoreview',
	layout: {
		type: 'vbox',
		align: 'stretch'
	},
	frame: true,
	bodyPadding: 5,
	bodyBorder: true,
	//bodyStyle: 'background-color:white',
	showRating: true,
	autoScroll: true,
	itemId: 'ItemsToReviewPanel',
	items: [
		{
			xtype: 'container',
			layout: {
				type: 'hbox',
				align: 'stretch'
			},
			defaults: {
				xtype: 'grid',
				margin: '0 0 5 0'
			},
			items: [
				{
					title: _('immunizations'),
					frame: true,
					height: 180,
					flex: 1,
					store: Ext.create('App.store.patient.PatientImmunization'),
					itemId: 'ItemsToReviewImmuGrid',
					margin: '0 5 5 0',
					columns: [
						{
							header: _('immunization'),
							width: 250,
							dataIndex: 'vaccine_name'
						},
						{
							header: _('date'),
							width: 90,
							xtype: 'datecolumn',
							format: 'Y-m-d',
							dataIndex: 'administered_date'
						},
						{
							header: _('notes'),
							flex: 1,
							dataIndex: 'note'
						}
					]
				},
				{
					title: _('allergies'),
					frame: true,
					height: 180,
					flex: 1,
					store: Ext.create('App.store.patient.Allergies'),
					itemId: 'ItemsToReviewAllergiesGrid',
					columns: [
						{
							header: _('type'),
							width: 100,
							dataIndex: 'allergy_type'
						},
						{
							header: _('name'),
							width: 100,
							dataIndex: 'allergy'
						},
						{
							header: _('severity'),
							flex: 1,
							dataIndex: 'severity'
						}
					]
				}
			]
		},
		{
			xtype: 'container',
			layout: {
				type: 'hbox',
				align: 'stretch'
			},
			defaults: {
				xtype: 'grid',
				margin: '0 0 5 0'
			},
			items: [
				{
					title: _('active_problems'),
					frame: true,
					height: 180,
					flex: 1,
					margin: '0 5 5 0',
					store: Ext.create('App.store.patient.PatientActiveProblems'),
					itemId: 'ItemsToReviewActiveProblemsGrid',
					columns: [
						{
							header: _('problem'),
							width: 250,
							dataIndex: 'code_text'
						},
						{
							xtype: 'datecolumn',
							header: _('begin_date'),
							width: 90,
							format: 'Y-m-d',
							dataIndex: 'begin_date'
						},
						{
							xtype: 'datecolumn',
							header: _('end_date'),
							flex: 1,
							format: 'Y-m-d',
							dataIndex: 'end_date'
						}
					]
				},
				{
					title: _('medications'),
					frame: true,
					height: 180,
					flex: 1,
					store: Ext.create('App.store.patient.Medications'),
					itemId: 'ItemsToReviewMedicationsGrid',
					columns: [
						{
							header: _('medication'),
							width: 250,
							dataIndex: 'STR'
						},
						{
							xtype: 'datecolumn',
							header: _('begin_date'),
							width: 90,
							format: 'Y-m-d',
							dataIndex: 'begin_date'
						},
						{
							xtype: 'datecolumn',
							header: _('end_date'),
							flex: 1,
							format: 'Y-m-d',
							dataIndex: 'end_date'
						}
					]
				}
			]
		},
		{

			xtype: 'painscalepanel',
			itemId: 'ItemsToReviewActivePainScaleGrid',
			margin: '0 0 5 0',
			frame: true,
			bbar: null
		},
		{
			xtype:'container',
			layout: 'hbox',
			items: [
				{
					xtype: 'fieldset',
					title: _('social_history'),
					margin: '0 10 0 0',
					items: [
						{
							fieldLabel: _('smoking_status'),
							xtype: 'mitos.smokingstatuscombo',
							itemId: 'reviewsmokingstatuscombo',
							allowBlank: false,
							labelWidth: 100,
							width: 325
						}
					]
				},
				// {
				// 	xtype: 'fieldset',
				// 	title: _('patient_education'),
                //     margin: '0 10 0 0',
				// 	items: [
				// 		{
				// 			xtype: 'checkbox',
				// 			boxLabel: _('education_given'),
				// 			itemId: 'ItemsToReviewEducationGivenField'
				// 		}
				// 	]
				// },
                // {
                //     xtype: 'fieldset',
                //     title: _('medical_reconciliation'),
                //     layout: 'hbox',
	            //     margin: '0 10 0 0',
                //     items: [
                //         {
                //             xtype: 'checkboxfield',
                //             checked: false,
                //             itemId: 'EncounterMedicationReconciliations',
                //             name: 'medication_reconciliations',
	            //             margin: '0 5 0 0'
                //         },
                //         {
                //             xtype: 'datefield',
                //             fieldLabel: _('performed_date'),
                //             labelWidth: 100,
                //             width: 210,
                //             itemId: 'EncounterMedicationReconciliationsDateField',
                //             name: 'medication_reconciliations_date'
                //         }
                //     ]
                // },
				{
					xtype: 'fieldset',
					title: _('patient_summary'),
					layout: 'hbox',
					items: [
						{
							xtype: 'checkboxfield',
							checked: false,
							padding: '0 0 5 10',
							itemId: 'EncounterSummaryCareProvided',
							boxLabel: _('ccda_available'),
							name: 'summary_care_provided',
							width: 150
						}
					]
				}
			]
		}
	],
	buttons: [
		{
			text: _('review_all'),
			name: 'review',
			itemId: 'encounterRecordAdd'
		}
	]
});

Ext.define('App.view.patient.encounter.MedicationsAdministeredGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'medicationsadministeredgrid',
	itemId: 'MedicationsAdministeredGrid',
	frame: true,
	disableSelection: true,
	store: Ext.create('App.store.patient.MedicationsAdministered'),
	columns: [
		{
			xtype: 'actioncolumn',
			width: 25,
			groupable: false,
			items: [
				{
					icon: 'resources/images/icons/blueInfo.png',  // Use a URL in the icon config
					tooltip: 'Get Info',
					handler: function(grid, rowIndex, colIndex, item, e, record){
						App.app.getController('InfoButton').doGetInfo(
							record.data.rxcui,
							'RXCUI',
							record.data.description
						);
					}
				}
			]
		},
		{
			text: _('description'),
			flex: 1,
			dataIndex: 'description',
			renderer: function (v, meta, record) {
				if(!record.get('administered')) {
					meta.style = 'background-color: #FFCCCC';
				}
				return v;
			}
		},
		{
			text: _('instructions'),
			flex: 1,
			dataIndex: 'instructions',
			renderer: function (v, meta, record) {
				if(!record.get('administered')) {
					meta.style = 'background-color: #FFCCCC';
				}
				return v;
			}
		},
		{
			text: _('note'),
			flex: 2,
			dataIndex: 'note',
			renderer: function (v, meta, record) {
				if(!record.get('administered')) {
					meta.style = 'background-color: #FFCCCC';
				}
				return v;
			}
		},
		{
			text: _('administered_by'),
			dataIndex: 'administered_by',
			width: 150,
			renderer: function (v, meta, record) {
				if(!record.get('administered')) {
					meta.style = 'background-color: #FFCCCC';
				}
				return v;
			}
		},
		{
			text: _('adverse_reaction'),
			dataIndex: 'adverse_reaction_text',
			width: 150,
			renderer: function (v, meta, record) {
				if(!record.get('administered')) {
					meta.style = 'background-color: #FFCCCC';
				}
				return v;
			}
		}
	],
	tbar: [
		_('medications_administered'),
		'->',
		{
			text: _('medication'),
			itemId: 'MedicationsAdministeredGridAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	]


});
Ext.define('App.ux.LiveSnomedProcedureSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'snomedliveproceduresearch',
	hideLabel: true,
	displayField: 'Term',
	valueField: 'ConceptId',
	emptyText: _('procedure_search') + '...',
	typeAhead: false,
	hideTrigger: true,
	minChars: 3,
	initComponent: function(){
		var me = this;

		Ext.define('liveSnomedProcedureSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'ConceptId',
					type: 'string'
				},
				{
					name: 'Term',
					type: 'string'
				},
				{
					name: 'CodeType',
					type: 'string',
					defaultValue: 'SNOMED-CT'
				},
				{
					name: 'Occurrence',
					type: 'int'
				}
			],
			idProperty: 'ConceptId',
			proxy: {
				type: 'direct',
				api: {
					read: 'SnomedCodes.liveProcedureCodeSearch',
					update: 'SnomedCodes.updateLiveProcedureCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveSnomedProcedureSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{Term}<span style="font-weight: normal"> ({ConceptId}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', function(cmb, records){
			records[0].set({
				Occurrence: records[0].data.Occurrence + 1
			});
			records[0].save();
		});
	}
});

Ext.define('App.view.patient.encounter.EncounterAddendaGrid', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'encounteraddendagrid',
	frame: true,
	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.patient.encounter.Addenda');

		me.columns = [
			{
				xtype: 'griddeletecolumn',
				width: 25,
				acl: 'remove_encounter_addendum'
			},
			{
				xtype: 'datecolumn',
				text: _('date'),
				dataIndex: 'create_date',
				width: 80
			},
			{
				text: _('source'),
				dataIndex: 'source'
			},
			{
				text: _('notes'),
				dataIndex: 'notes',
				flex: 1
			},
			{
				text: _('user'),
				dataIndex: 'created_by'
			}
		];

		me.callParent();
	},
	tbar: [
		_('addenda'),
		'->',
		// {
		// 	xtype: 'button',
		// 	text: _('addendum'),
		// 	itemId: 'EncounterAddendaGridAddBtn',
		// 	iconCls: 'icoAdd',
		// 	margin: '0 5 0 5'
		// }
	]
});
Ext.define('App.model.patient.Intervention', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_interventions'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'intervention_type',
			type: 'string',
			index: true,
			len: 25
		},
		{
			name: 'code',
			type: 'string',
			len: 80
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'dx_code',
			type: 'string',
			len: 80
		},
		{
			name: 'dx_code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'dx_code_type',
			type: 'string',
			len: 20
		},
		{
			name: 'not_performed_code',
			type: 'string',
			len: 10
		},
		{
			name: 'not_performed_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'not_performed_code_text',
			type: 'string',
			len: 255
		},
		{
			name: 'notes',
			type: 'string',
			dataTYpe: 'text'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Interventions.getPatientInterventions',
			create: 'Interventions.addPatientIntervention',
			update: 'Interventions.updatePatientIntervention',
			destroy: 'Interventions.destroyPatientIntervention'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.store.patient.Interventions', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.Intervention'
});

Ext.define('App.view.patient.encounter.CarePlanGoalsNewWindow', {
	extend: 'Ext.window.Window',
	requires: [
		'App.ux.LiveSnomedProcedureSearch'
	],
	xtype: 'careplangoalsnewwindow',
	title: _('new_goal'),
	closable: false,
	constrain: true,
	closeAction: 'hide',
	layout: 'fit',
	items: [
		{
			xtype: 'form',
			itemId: 'CarePlanGoalsNewForm',
			layout: {
				type: 'vbox',
				align: 'stretch'
			},
			bodyPadding: 10,
			items: [
				{
					xtype: 'fieldcontainer',
					layout: 'hbox',
					itemId: 'CarePlanGoalPlanDateContainer',
					fieldLabel: _('plan_date'),
					labelAlign: 'top',
					defaults: {
						margin: '0 5 0 0'
					},
					items: [
						{
							xtype: 'datefield',
							itemId: 'CarePlanGoalPlanDateField',
							allowBlank: false,
							format: 'Y-m-d',
							name: 'plan_date'
						},
						{
							xtype: 'button',
							text: '+1 Day',
							action: '1D'
						},
						{
							xtype: 'button',
							text: '+1 Week',
							action: '1W'
						},
						{
							xtype: 'button',
							text: '+2 Week',
							action: '2W'
						},
						{
							xtype: 'button',
							text: '+1 Month',
							action: '1M'
						},
						{
							xtype: 'button',
							text: '+3 Month',
							action: '3M'
						},
						{
							xtype: 'button',
							text: '+6 Month',
							action: '6M'
						},
						{
							xtype: 'button',
							text: '+1 Year',
							action: '1Y'
						}
					]
				},
				{
					xtype: 'snomedliveproceduresearch',
					itemId: 'CarePlanGoalSearchField',
					fieldLabel: _('goal'),
					displayField: 'Term',
					valueField: 'Term',
					labelAlign: 'top',
					allowBlank: false,
					hideLabel: false,
					name: 'goal'
				},
				{
					xtype: 'textareafield',
					fieldLabel: _('instructions'),
					labelAlign: 'top',
					name: 'instructions',
					flex: 1
				}
			]
		}
	],
	buttons: [
		{
			text: _('cancel'),
			itemId: 'CarePlanGoalsNewFormCancelBtn'
		},
		{
			text: _('save'),
			itemId: 'CarePlanGoalsNewFormSaveBtn'
		}
	]
});
Ext.define('App.view.patient.encounter.InterventionsGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'interventionsgrid',
	itemId: 'InterventionsGrid',
	frame: true,
	disableSelection: true,
	store: Ext.create('App.store.patient.Interventions'),
	columns: [
		{
			xtype: 'griddeletecolumn',
			width: 25
		},
		{
			text: _('type'),
			width: 150,
			dataIndex: 'intervention_type'
		},
		{
			text: _('description'),
			flex: 1,
			dataIndex: 'code_text'
		},
		{
			text: _('instructions'),
			flex: 2,
			dataIndex: 'notes'
		}
	],
	tbar: [
		_('interventions'),
		'->',
		{
			text: _('intervention'),
			itemId: 'InterventionGridAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	]


});

Ext.define('App.model.patient.HealthConcern', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_health_concerns'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'health_concern_type',
			type: 'string',
			index: true,
			len: 25
		},
		{
			name: 'description',
			type: 'string',
			len: 300
		},
		{
			name: 'instructions',
			type: 'string',
			dataTYpe: 'text'
		},
		{
			name: 'active_from',
			type: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'active_to',
			type: 'date',
			dateFormat: 'Y-m-d'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'HealthConcerns.getPatientHealthConcerns',
			create: 'HealthConcerns.addPatientHealthConcern',
			update: 'HealthConcerns.updatePatientHealthConcern',
			destroy: 'HealthConcerns.destroyPatientHealthConcern'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.store.patient.HealthConcerns', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.HealthConcern'
});

Ext.define('App.view.patient.encounter.HealthConcernGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'healthconcerngird',
	itemId: 'HealthConcernGrid',
	frame: true,
	disableSelection: true,
	store: Ext.create('App.store.patient.HealthConcerns'),
	columns: [
		{
			xtype: 'griddeletecolumn',
			width: 25
		},
		{
			text: _('type'),
			width: 170,
			dataIndex: 'health_concern_type',
			editor: {
				xtype: 'combobox',
				editable: false,
				store: [
					['HealthConcernAct', 'Health Concern'],
					['Narrative', 'Narrative'],
				]
			}
		},
		{
			text: _('description'),
			flex: 1,
			dataIndex: 'description',
			editor: {
				xtype: 'textfield'
			}
		},
		{
			text: _('instructions'),
			flex: 2,
			dataIndex: 'instructions',
			editor: {
				xtype: 'textfield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('from'),
			dataIndex: 'active_from',
			editor: {
				xtype: 'datefield'
			}
		},
		{
			xtype: 'datecolumn',
			text: _('to'),
			dataIndex: 'active_to',
			editor: {
				xtype: 'datefield'
			}
		}
	],
	plugins: [
		Ext.create('Ext.grid.plugin.RowEditing')
	],
	tbar: [
		_('health_concerns'),
		'->',
		{
			text: _('health_concern'),
			itemId: 'HealthConcernGridAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	]
});

Ext.define('App.ux.form.fields.plugin.FieldTab', {
	extend: 'Ext.AbstractPlugin',
	alias: 'plugin.fieldtab',

	loop_around: true,
	SHIFT_DOWN: false,
	ALT_DOWN: false,
	CTRL_DOWN: false,

	keys_down_time: {},
	keys_up_time: {},
	is_buffing: false,
	start_index: -1,
	buff: '',

	properties: [
		'boxSizing',
		'width',  // on Chrome and IE, exclude the scrollbar, so the mirror div wraps exactly as the textarea does
		'height',
		'overflowX',
		'overflowY',  // copy the scrollbar for IE

		'borderTopWidth',
		'borderRightWidth',
		'borderBottomWidth',
		'borderLeftWidth',

		'paddingTop',
		'paddingRight',
		'paddingBottom',
		'paddingLeft',

		// https://developer.mozilla.org/en-US/docs/Web/CSS/font
		'fontStyle',
		'fontVariant',
		'fontWeight',
		'fontStretch',
		'fontSize',
		'lineHeight',
		'fontFamily',

		'textAlign',
		'textTransform',
		'textIndent',
		'textDecoration',  // might not make a difference, but better be safe

		'letterSpacing',
		'wordSpacing'
	],

	tooltipConfig: {},

	/**
	 *
	 * @param field
	 */
	init: function(field){
		var me = this;

		me.field = field;

		field.enableKeyEvents = true;

		me.last_key_time = new Date().getTime();
		me.working_textfield = null;

		field.on('render', function (f) {
			me.initTooltip(field);
			f.inputEl.on('keydown', me.onKeyDown, me);
			f.inputEl.on('keyup', me.onKeyUp, me);
			f.inputEl.on('click', me.onClick, me);
		});
		field.on('beforedestroy', function (f) {
			f.inputEl.un('keydown', me.onKeyDown, me);
			f.inputEl.un('keyup', me.onKeyUp, me);
			f.inputEl.un('click', me.onClick, me);
		});

		me.speakCtrl = app.getController('App.controller.Speak');

		app.on((me.field.id + '-' + 'optionclick'), me.onOptionClick, me);
		me.field.on('destroy', function (){
			app.un((me.field.id + '-' + 'optionclick'), me.onOptionClick, me);
		});


	},

	initTooltip: function (field){

		this.tip =  Ext.create('Ext.tip.ToolTip', Ext.apply({
			target: field.id,
			anchor: 'top',
			disabled: true,
			autoShow: false,
			autoHide: false,
			closable: true,
			listeners: {
				'close': function(){
					this.disable();
				}
			}
		}, this.tooltipConfig));
	},

	showTooltipOptions: function (field_text, start, end){

		var me = this, options, links, event;

		if(field_text.search(/|/) === -1){
			return;
		}

		options = field_text.replace(/\[|]/g, '').split('|').map(function (x){
			return x.replace(/^.*:/, '').trim();
		})
		if(options.length === 1 && options[0] === ''){
			return;
		}

		links = [];
		event = me.field.id + '-' + 'optionclick';

		options.forEach(function (option){
			if(option === ''){
				return;
			}
			links.push(Ext.String.format('<a href="#" data-option="{0}" data-start="{1}" data-end="{2}" onclick="app.fireEvent(\'{3}\', this)">{0}</a>', option, start, end, event));
		});

		me.tip.update(links.join(' | '));
		me.tip.enable();
		me.tip.show();
	},

	hideTooltipOptions: function (){
		if(this.tip.isVisible()){
			this.tip.update('');
			this.tip.hide();
			this.tip.disable();
		}
	},

	onOptionClick: function (link){

		this.field.focus(false);
		document.execCommand("insertText", false, link.dataset.option);

		this.hideTooltipOptions();

		if(this.hasFields(this.field.inputEl.dom)) {
			this.doNextField(this.field.inputEl.dom);
		}
	},

	doPrevField: function(input){
		var me = this,
			cursor = me.getCursorPos(input);
		me.getPrevField(cursor, input);
	},

	doNextField: function(input){
		var me = this,
			cursor = me.getCursorPos(input);
		me.getNextField(cursor, input);
	},

	onKeyDown: function(e, t, eOpts){
		var key = e.getKey();

		this.hideTooltipOptions();

		if(!this.is_buffing){
			this.keys_down_time[key] = new Date().getTime();
		}

		if(key == e.SHIFT){
			e.preventDefault();
			this.SHIFT_DOWN = true;

		}else if(key == e.ALT){
			e.preventDefault();
			this.ALT_DOWN = true;

		}else if(key == e.CTRL){
			e.preventDefault();
			this.CTRL_DOWN = true;

		}else if(key == e.TAB){
			e.preventDefault();
		}
	},

	onKeyUp: function(e, t, eOpts){
		var key = e.getKey(),
			code = e.getCharCode();

		if(!this.is_buffing){
			this.keys_up_time[key] = new Date().getTime();
		}

		if(key == e.SHIFT){
			e.preventDefault();
			this.SHIFT_DOWN = false;

		}else if(key == e.ALT){
			e.preventDefault();
			this.ALT_DOWN = false;

		}else if(key == e.CTRL){
			e.preventDefault();
			this.CTRL_DOWN = false;

		}else if((key == e.TAB && this.SHIFT_DOWN) || (key == e.F5)){
			e.preventDefault();
			if(this.hasFields(t)) {
				this.doPrevField(t);
			}

		}else if(key == e.TAB || (key == e.F6)){
			e.preventDefault();
			if(this.hasFields(t)) {
				this.doNextField(t);
			}
		}
	},

	onClick: function (){
		this.hideTooltipOptions();
	},

	hasFields: function(input){
		return input.value.search(/\[.*?]/) != -1;
	},

	getPrevField: function(cursor, input){
		var str = input.value.substr(0, cursor.start),
			marches = str.match(/\[.*?]/g),
			start,
			end;

		if(marches == null || marches.length === 0){
			if(this.loop_around){
				this.getPrevField({start: input.value.length, end: input.value.length}, input);
			}
			return;
		}

		start = str.lastIndexOf(marches[marches.length - 1]);
		end = str.substr(start).search(/(](?=([^\]])))|(]$)/) + start + 1;

		this.setCursorPos(input, start, end);
		this.setScroll(input, start, end);

		var field_text = input.value.substr(start, (end - start));
		this.speak(field_text);
		this.showTooltipOptions(field_text);
	},

	getNextField: function(cursor, input){
		var str = input.value.substr(cursor.end),
			start = str.search(/\[.*]/),
			end = str.substr(start).search(/(](?=([^\]])))|(]$)/) + 1;

		if(start == -1){
			if(this.loop_around){
				this.getNextField({start: 0, end: 0}, input);
			}
			return;
		}

		start = cursor.end + start;
		end = start + end;
		this.setCursorPos(input, start, end);
		this.setScroll(input, start, end);

		var field_text = input.value.substr(start, (end - start));
		this.speak(field_text);
		this.showTooltipOptions(field_text);

	},

	setScroll: function(input, start, end){
		var coordinates = this.getCaretCoordinates(input, start);
		input.scrollTop = coordinates[3] - 600;
	},

	getCaretCoordinates: function (element, position) {

		var rect = element.getBoundingClientRect();

		var isFirefox = !(window.mozInnerScreenX == null);
		//var mirrorDivDisplayCheckbox = document.getElementById('mirrorDivDisplay');
		var mirrorDiv, computed, style;

		// mirrored div
		mirrorDiv = document.getElementById(element.nodeName + '--mirror-div');
		if (!mirrorDiv) {
			mirrorDiv = document.createElement('div');
			mirrorDiv.id = element.nodeName + '--mirror-div';
			document.body.appendChild(mirrorDiv);
		}

		style = mirrorDiv.style;
		computed = getComputedStyle(element);

		// default textarea styles
		style.whiteSpace = 'pre-wrap';
		if (element.nodeName !== 'INPUT')
			style.wordWrap = 'break-word';  // only for textarea-s

		// position off-screen
		style.position = 'absolute';  // required to return coordinates properly
		style.top = element.offsetTop + parseInt(computed.borderTopWidth) + 'px';
		style.left = "0";
		style.visibility = 'hidden';  // not 'display: none' because we want rendering

		// transfer the element's properties to the div
		this.properties.forEach(function (prop) {
			style[prop] = computed[prop];
		});

		if (isFirefox) {
			style.width = parseInt(computed.width) - 2 + 'px';  // Firefox adds 2 pixels to the padding - https://bugzilla.mozilla.org/show_bug.cgi?id=753662
			// Firefox lies about the overflow property for textareas: https://bugzilla.mozilla.org/show_bug.cgi?id=984275
			if (element.scrollHeight > parseInt(computed.height))
				style.overflowY = 'scroll';
		} else {
			style.overflow = 'hidden';  // for Chrome to not render a scrollbar; IE keeps overflowY = 'scroll'
		}

		mirrorDiv.textContent = element.value.substring(0, position);
		// the second special handling for input type="text" vs textarea: spaces need to be replaced with non-breaking spaces - http://stackoverflow.com/a/13402035/1269037
		if (element.nodeName === 'INPUT')
			mirrorDiv.textContent = mirrorDiv.textContent.replace(/\s/g, "\u00a0");

		var span = document.createElement('span');
		// Wrapping must be replicated *exactly*, including when a long word gets
		// onto the next line, with whitespace at the end of the line before (#7).
		// The  *only* reliable way to do that is to copy the *entire* rest of the
		// textarea's content into the <span> created at the caret position.
		// for inputs, just '.' would be enough, but why bother?
		span.textContent = element.value.substring(position) || '.';  // || because a completely empty faux span doesn't render at all
		span.style.backgroundColor = "lightgrey";
		mirrorDiv.appendChild(span);

		var left = span.offsetLeft + parseInt(computed['borderLeftWidth']) + rect.left - 20;
		var top = span.offsetTop + parseInt(computed['borderTopWidth']) + rect.top + 30;

		return [
			left,
			top - element.scrollTop,
			left,
			top
		];
	},

	getCursorPos: function(input){
		if("selectionStart" in input && document.activeElement == input){
			return {
				start: input.selectionStart,
				end: input.selectionEnd
			};
		}else if(input.createTextRange){
			var sel = document.selection.createRange();
			if(sel.parentElement() === input){
				var rng = input.createTextRange();
				rng.moveToBookmark(sel.getBookmark());
				for(var len = 0; rng.compareEndPoints("EndToStart", rng) > 0; rng.moveEnd("character", -1)){
					len++;
				}
				rng.setEndPoint("StartToStart", input.createTextRange());
				for(var pos = {
					start: 0,
					end: len
				}; rng.compareEndPoints("EndToStart", rng) > 0; rng.moveEnd("character", -1)){
					pos.start++;
					pos.end++;
				}
				return pos;
			}
		}
		return -1;
	},

	setCursorPos: function(input, start, end){
		if(arguments.length < 3) end = start;
		if("selectionStart" in input){
			setTimeout(function(){
				input.selectionStart = start;
				input.selectionEnd = end;
			}, 1);
		}else if(input.createTextRange){
			var rng = input.createTextRange();
			rng.moveStart("character", start);
			rng.collapse();
			rng.moveEnd("character", end - start);
			rng.select();
		}
	},

	speak: function(field_text){

		if(field_text.search(/^\[*#/) === -1){
			return;
		}

		field_text = field_text.replace(/^\[#([a-z 0-9]*).*/g,'$1');

		say(field_text);

		this.speakCtrl.speak(field_text);
	},

});
Ext.define('App.view.patient.encounter.DictationPanel', {
	extend: 'Ext.form.Panel',
	requires: [

	],
	itemId: 'DictationPanel',
	title: _('dictation'),
	layout: 'fit',
	frame: true,
	bodyPadding: 10,

	initComponent: function(){
		var me = this;

		me.items = [
			{
				xtype: 'textareafield',
				name: 'dictation',
				allowBlank:  false
			}
		];

		me.buttons = [
			{
				text: _('save'),
				iconCls: 'save',
				itemId: 'DictationPanelSaveBtn'
			}
		];

		me.callParent(arguments);

	}
});

Ext.define('App.model.patient.NursesNote', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_nurses_notes'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 120,
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'note',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'in_error',
			type: 'bool'
		},
		{
			name: 'signer_uid',
			type: 'int',
			index: true
		},
		{
			name: 'signer_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'create user ID'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'update user ID'
		},
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'nurse_fname',
			type: 'string',
			store: false
		},
		{
			name: 'nurse_mname',
			type: 'string',
			store: false
		},
		{
			name: 'nurse_lname',
			type: 'string',
			store: false
		},
		{
			name: 'nurse_name',
			type: 'string',
			convert: function(v,r){
				return v !== '' ? v : Ext.String.format('{0}, {1} {2}', r.get('nurse_lname'), r.get('nurse_fname'), r.get('nurse_mname'))
			},
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'NursesNotes.getNursesNotes',
			create: 'NursesNotes.addNursesNote',
			update: 'NursesNotes.updateNursesNote',
			destroy: 'NursesNotes.destroyNursesNote'
		},
		reader: {
			root: 'data'
		},
		writer: {
			writeAllFields: true
		},
		remoteGroup: false
	}
});


Ext.define('App.store.patient.NursesNotes', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.NursesNote'
});



Ext.define('App.view.patient.encounter.SOAP', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.ux.combo.Specialties',
		'App.ux.grid.RowFormEditing',
		'App.ux.grid.RowFormEditing',
		'App.view.patient.encounter.CarePlanGoals',
		'App.view.patient.encounter.CarePlanGoalsNewWindow',
		'App.ux.LiveSnomedProcedureSearch',
		'App.view.patient.encounter.AppointmentRequestGrid',
		'App.view.patient.encounter.EducationResourcesGrid',
		'App.view.patient.encounter.EncounterAddendaGrid',
		'App.view.patient.encounter.MedicationsAdministeredGrid',
		'App.view.patient.encounter.InterventionsGrid',
		'App.view.patient.encounter.HealthConcernGrid',
		'App.ux.form.fields.plugin.FieldTab'
	],
	action: 'patient.encounter.soap',
	itemId: 'soapPanel',
	title: _('soap'),
	layout: 'border',
	frame: true,

	pid: null,
	eid: null,

	initComponent: function(){
		var me = this;

		me.snippetStore = Ext.create('App.store.administration.EncounterSnippets', {
			autoLoad: false,
			pageSize: 1000,
			groupField: 'category'
		});

		me.procedureStore = Ext.create('App.store.patient.encounter.Procedures');

		var snippetCtrl = App.app.getController('administration.EncounterSnippets');

		me.snippets = Ext.create('Ext.grid.Panel', {
			title: _('snippets'),
			itemId: 'SnippetsTreePanel',
			region: 'west',
			width: 300,
			split: true,
			animate: false,
			hideHeaders: true,
			useArrows: true,
			rootVisible: false,
			singleExpand: true,
			collapsed: !eval(g('enable_encounter_soap_templates')),
			stateful: true,
			stateId: 'SnippetsTreePanelState',
			collapsible: true,
			// collapseMode: 'mini',
			animCollapse: false,
			hideCollapseTool: true,
			store: me.snippetStore,
			features: [{ ftype:'grouping' }],
			tools: [
				{
					xtype: 'button',
					text: _('snippet'),
					iconCls: 'icoAdd',
					itemId: 'SnippetAddBtn'
				}
			],
			columns: [
				{
					text: _('edit'),
					width: 25,
					menuDisabled: true,
					xtype: 'actioncolumn',
					tooltip: 'Edit Snippet',
					align: 'center',
					icon: 'resources/images/icons/edit.png',
					handler: function(grid, rowIndex, colIndex, actionItem, event, record){
						snippetCtrl.onSnippetBtnEdit(grid, rowIndex, colIndex, actionItem, event, record);
					}
				},
				{
					text: _('description'),
					dataIndex: 'description',
					flex: 1
				}
			],
			bbar:[
				{
					xtype: 'specialtiescombo',
					itemId: 'SoapTemplateSpecialtiesCombo',
					flex: 1
				}
			],
			viewConfig: {
				disableSelection: true,
				plugins: {
					ptype: 'treeviewdragdrop',
					dragText: _('drag_and_drop_reorganize')
				},
				listeners: {
					scope: me,
					drop: function (node, data, overModel) {
						snippetCtrl.onSnippetDrop(node, data, overModel);
					}
				}
			}
		});

		me.form = Ext.create('Ext.form.Panel', {
			autoScroll: true,
			action: 'encounter',
			region: 'center',
			itemId: 'soapForm',
			cls: 'encounter-soap-form',
			frame: true,
			fieldDefaults: {
				msgTarget: 'side'
			},
			plugins: {
				ptype: 'advanceform',
				autoSync: g('autosave'),
				syncAcl: a('edit_encounters')
			},
			items: [
				{
					xtype: 'fieldset',
					title: _('chief_complaint'),
					margin: 10,
					items: [
						{
							xtype: 'textarea',
							anchor: '100%',
							height: 100,
							enableKeyEvents: true,
							nusaEnabled: true,
							margin: '5 0 10 0',
							name: 'chief_complaint',
							plugins: [
								{
									ptype: 'fieldtab'
								}
							]
						}
					]
				},
				{
					xtype: 'fieldset',
					title: _('subjective'),
					margin: 10,
					items: [
						me.sField = Ext.widget('textarea', {
							name: 'subjective',
							anchor: '100%',
							height: 200,
							enableKeyEvents: true,
							nusaEnabled: true,
							margin: '5 0 10 0',
							plugins: [
								{
									ptype: 'fieldtab'
								}
							]
						})
					]
				},
				{
					xtype: 'fieldset',
					title: _('objective'),
					margin: 10,
					items: [
						me.oField = Ext.widget('textarea', {
							name: 'objective',
							anchor: '100%',
							height: 200,
							nusaEnabled: true,
							plugins: [
								{
									ptype: 'fieldtab'
								}
							]
						}),
						me.physicalExamForm = Ext.widget('form', {
							title: 'Physical Exam',
							itemId: 'EncounterPhysicalExamForm',
							layout: 'fit'
						}),
						{
							xtype: 'grid',
							frame: true,
							name: 'procedures',
							emptyText: _('no_procedures'),
							margin: '5 0 10 0',
							store: me.procedureStore,
							itemId: 'EncounterProcedureGrid',
							minHeight: 100,
							columns: [
								{
									text: _('code'),
									dataIndex: 'code'
								},
								{
									text: _('description'),
									dataIndex: 'code_text',
									flex: 2
								},
								{
									text: _('body_site'),
									dataIndex: 'target_site_code_text',
									flex: 1
								}
							],
							dockedItems: [
								{
									xtype: 'toolbar',
									items: [
										{
											xtype: 'tbtext',
											text: _('procedures')
										},
										'->',
										{
											text: _('new_procedure'),
											itemId: 'EncounterProcedureGridAddBtn',
											iconCls: 'icoAdd'
										}
									]
								}

							]
						}
					]
				},
				{
					xtype: 'fieldset',
					title: _('assessment'),
					margin: 10,
					items: [
						me.aField = Ext.widget('textarea', {
							name: 'assessment',
							anchor: '100%',
							height: 200,
							nusaEnabled: true,
							plugins: [
								{
									ptype: 'fieldtab'
								}
							]
						}),
						me.dxField = Ext.widget('icdsfieldset', {
							name: 'dxCodes',
							margin: '5 0 10 0',
							itemId: 'SoapDxCodesField'
						}),
						{
							xtype: 'gaiaehr.combo',
							itemId: 'SoapHealthStatusCmb',
							editable: false,
							loadStore: true,
							queryMode: 'local',
							listKey: 'health_stat',
							name: 'health_status',
							fieldLabel: _('health_status'),
							labelAlign: 'top',
							margin: '0 0 10 0',
							width: 300,
						}
					]
				},
				{
					xtype: 'fieldset',
					title: _('plan'),
					margin: 10,
					items: [
						me.pField = Ext.widget('textarea', {
							fieldLabel: _('instructions'),
							labelAlign: 'top',
							name: 'instructions',
							height: 200,
							margin: '0 0 10 0',
							anchor: '100%',
							nusaEnabled: true,
							plugins: [
								{
									ptype: 'fieldtab'
								}
							]
						}),
						{
							xtype: 'medicationsadministeredgrid',
							minHeight: 125,
							margin: '0 0 10 0'
						},
						{
							xtype: 'appointmentrequestgrid',
							minHeight: 125,
							margin: '0 0 10 0'
						},
						{
							xtype: 'interventionsgrid',
							minHeight: 125,
							margin: '0 0 10 0'
						},
						{
							xtype: 'careplangoalsgrid',
							minHeight: 125,
							margin: '0 0 10 0'
						},
						{
							xtype: 'educationresourcesgrid',
							minHeight: 125,
							margin: '0 0 10 0'
						},
						{
							xtype: 'healthconcerngird',
							minHeight: 125,
							margin: '0 0 10 0'
						}
					]
				},
				{
					xtype: 'fieldset',
					title: _('addenda'),
					margin: 10,
					itemId: 'EncounterSoapAddendaFieldSet',
					items: [
						{
							xtype: 'encounteraddendagrid',
							itemId: 'EncounterSoapAddendaGrid',
							minHeight: 125,
							margin: '0 0 10 0'
						}
					]
				}
			],
			buttons: [
				{
					xtype: 'button',
					icon: 'modules/worklist/resources/images/wand.png',
					itemId: 'SoapFormReformatTextBtn',
					tooltip: 'Reformat Text :: ALT-W',
					minWidth: null,
					hidden: !Ext.isWebKit
				},
				{
					xtype: 'button',
					action: 'speechBtn',
					iconCls: 'speech-icon-inactive',
					enableToggle: true,
					minWidth: null,
					hidden: !Ext.isWebKit
				},
				'->',
				{
					text: _('save'),
					iconCls: 'save',
					action: 'soapSave',
					scope: me,
					itemId: 'encounterRecordAdd',
					handler: me.onSoapSave
				}
			],
			listeners: {
				scope: me,
				recordloaded: me.formRecordLoaded
			}
		});

		Ext.apply(me, {
			items: [ me.snippets, me.form ]
		});


		me.physicalExamForm.getFormItems(me.physicalExamForm, 17, function(){


		});

		me.callParent(arguments);

	},

	/**
	//  *
	//  * @param cmb
	//  * @param record
	//  */
	// onProcedureSelect: function(cmb, record){
	// 	var me = this,
	// 		form = me.pForm.getForm(),
	// 		procedure = form.getRecord();
	// 	procedure.set({
	// 		code: record[0].data.ConceptId,
	// 		code_type: record[0].data.CodeType,
	// 		code_text: record[0].data.Term
	// 	});
	// },
	//
	// /**
	//  *
	//  */
	// onProcedureAdd: function(){
	// 	var me = this,
	// 		rec;
	// 	rec = Ext.create('App.model.patient.encounter.Procedures', {
	// 		pid: me.pid,
	// 		eid: me.eid,
	// 		create_uid: app.user.id,
	// 		update_uid: app.user.id,
	// 		create_date: new Date(),
	// 		update_date: new Date()
	// 	});
	//
	// 	me.procedureStore.add(rec);
	// 	me.procedureEdit(null, rec);
	// },

	// /**
	//  *
	//  */
	// onProcedureCancel: function(){
	// 	this.procedureStore.rejectChanges();
	// 	this.pWin.close();
	// 	this.query('button[action=soapSave]')[0].enable();
	// 	this.pWin.setTitle(_('procedure'));
	// },
	//
	// /**
	//  *
	//  */
	// onProcedureSave: function(){
	// 	var me = this,
	// 		form = me.pForm.getForm(),
	// 		record = form.getRecord(),
	// 		values = form.getValues();
	//
	// 	record.set(values);
	//
	// 	this.procedureStore.sync();
	// 	this.pWin.close();
	// 	this.query('button[action=soapSave]')[0].enable();
	// 	this.pWin.setTitle(_('procedure'));
	// },

	/**
	 *
	 */
	onShow: function(){
		var me = this;
		me.callParent();

		me.sField.focus();

		if(me.eid != app.patient.eid){
			me.pid = app.patient.pid;
			me.eid = app.patient.eid;
			me.procedureStore.load({
				filters: [
					{
						property: 'eid',
						value: me.eid
					}
				]
			});
		}
	},

	// /**
	//  *
	//  * @param view
	//  * @param record
	//  */
	// procedureEdit: function(view, record){
	// 	if(record.data.code_text !== '' || record.data.code !== ''){
	// 		this.pWin.setTitle(record.data.code_text + ' [' + record.data.code + ']');
	// 	}else{
	// 		this.pWin.setTitle(_('new_procedure'));
	// 	}
	//
	// 	this.pForm.getForm().loadRecord(record);
	// 	this.pWin.show(this.pGrid.el);
	// 	this.query('button[action=soapSave]')[0].disable();
	// },

	/**
	 *
	 * @param btn
	 */
	onSoapSave: function(btn){
		this.enc.onEncounterUpdate(btn)
	},

	/**
	 *
	 * @param form
	 * @param record
	 */
	formRecordLoaded: function(form, record){
		var store = record.dxCodes();
		store.on('write', function(){
			record.store.fireEvent('write');
		});
		this.dxField.loadIcds(record.dxCodes());
	}
});

Ext.define('App.view.patient.encounter.NursesNotesGrid', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'nursesnotesgrid',
	itemId: 'NursesNotesGrid',
	title: _('nurse_notes'),
	frame: true,
	disableSelection: true,
	store: Ext.create('App.store.patient.NursesNotes'),
	columns: [
		{
			xtype: 'datecolumn',
			text: _('date'),
			width: 150,
			format: g('date_time_display_format'),
			dataIndex: 'create_date'
		},
		{
			text: _('note'),
			flex: 1,
			dataIndex: 'note',
			renderer: function(value, metaData) {
				metaData.style = "white-space: normal;";
				return value;
			}
		},
		{
			text: _('nurse'),
			width: 200,
			dataIndex: 'nurse_name'
		}
	],
	tbar: [
		'->',
		{
			text: _('note'),
			itemId: 'NursesNotesGridAddBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	]
});

Ext.define('App.view.patient.DecisionSupportWarningPanel', {
	extend: 'Ext.panel.Panel',
	xtype: 'decisionsupportwarningpanel',
	cls: 'decisionSupportWarning',
	header: false,
	// collapsible: true,
	// collapsed: true,
	hidden: true,
	margin: 0,
	dockedItems:[
		{
			xtype: 'toolbar',
			dock: 'right',
			ui: 'plain',
			items: [
				{
					xtype: 'button',
					icon: 'resources/images/icons/close_exit.png',
					itemId: 'DecisionSupportWarningPanelCloseBtn'
				}
			]
		}
	]
});
Ext.define('App.view.patient.Documents', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.ux.grid.LiveSearchGridPanel',
		'App.ux.combo.Templates',
		'Ext.grid.plugin.RowEditing',
		'App.store.patient.PatientDocuments',
		'App.ux.ManagedIframe',
		'Ext.grid.feature.Grouping',
		'Ext.form.ComboBox'
	],
	xtype: 'patientdocumentspanel',
	title: _('documents'),
	layout: 'border',
	orientation: 'west',
	initComponent: function(){
		var me = this,
			store = Ext.create('App.store.patient.PatientDocuments', {
				autoLoad: false,
				remoteFilter: true,
				remoteSort: false,
				autoSync: false,
				pageSize: 500,
				groupField: 'docTypeCode',
				sorters: [
					{
						property: 'date',
						direction: 'DESC'
					},
					{
						property: 'docTypeCode',
						direction: 'ASC'
					}
				]
			}),
			docCtrl = App.app.getController('patient.Documents');

		me.items = [
			{
				xtype: 'gridlivesearch',
				region: me.orientation,
				split: true,
				flex: 1,
				columnLines: true,
				selType: 'checkboxmodel',
				stateful: true,
				stateId: 'patientDocumentGridState',
				viewConfig: {
					plugins: {
						ptype: 'gridviewdragdrop',
						dragText: 'Drag and drop to move document to another category'
					}
				},
				features: [
					{
						ftype: 'grouping',
						hideGroupedHeader: true,
						startCollapsed: true,
						groupHeaderTpl: Ext.create('Ext.XTemplate',
							'{children:this.getGroupName}',
							{
								getGroupName: function(children){
									return docCtrl.getGroupName(children[0].store, children[0]);
								}
							}
						)
					}
				],
				itemId: 'patientDocumentGrid',
				store: store,
				columns: [
					{
						xtype: 'actioncolumn',
						width: 23,
						icon: 'resources/images/icons/icoLessImportant.png',
						tooltip: _('validate_file_integrity_hash'),
						stateId: 'patientDocumentGridStateActionCol',
						handler: function(grid, rowIndex){
							docCtrl.onDocumentHashCheckBtnClick(grid, rowIndex);
						},
						getClass: function(){
							return 'x-grid-icon-padding';
						}
					},
					//{
					//	xtype: 'actioncolumn',
					//	width: 23,
					//	icon: 'resources/images/icons/delete.png',
					//	tooltip: _('delete'),
					//	hidden: !eval(a('delete_patient_documents')),
					//	handler: function(grid, rowIndex, colIndex, item, e, recprd){
					//
					//
					//		alert('hello');
					//
					//	},
					//	getClass: function(){
					//		return 'x-grid-icon-padding';
					//	}
					//},
					{
						header: _('category'),
						dataIndex: 'docTypeCode',
						itemId: 'docTypeCode',
						editor: {
							xtype: 'textfield'
						},
						stateId: 'patientDocumentGridStateDocTypeCol',
						renderer: function(v, meta, record){
							if(record.get('entered_in_error')){
								meta.tdCls += ' entered-in-error ';
								meta.tdAttr = 'data-qtip="' + _('error_note') + ': ' + record.get('error_note') + '"';
							}
							return record.get('docType');
						}
					},
					{
						xtype: 'datecolumn',
						header: _('date'),
						dataIndex: 'date',
						format: g('date_display_format'),
						itemId: 'groupDate',
						stateId: 'patientDocumentGridStateGroupDateCol',
						renderer: function(v, meta, record){
							var val = v != null ? Ext.util.Format.date(v, g('date_display_format')) : '-';

							if(record.get('entered_in_error')){
								meta.tdCls += ' entered-in-error ';
								meta.tdAttr = 'data-qtip="' + _('error_note') + ': ' + record.get('error_note') + '"';
							}
							return val;
						}
					},
					{
						header: _('title'),
						dataIndex: 'title',
						flex: 1,
						editor: {
							xtype: 'textfield',
							action: 'title'
						},
						stateId: 'patientDocumentGridStateTitleCol',
						renderer: function(v, meta, record){
							if(record.get('entered_in_error')){
								meta.tdCls += ' entered-in-error ';
								meta.tdAttr = 'data-qtip="' + _('error_note') + ': ' + record.get('error_note') + '"';
							}
							return v.split('|').join('<br>');
						}
					},
					// {
					// 	header: _('encrypted'),
					// 	dataIndex: 'encrypted',
					// 	width: 70,
					// 	stateId: 'patientDocumentGridStateEncryptedCol',
					// 	renderer: function(v, meta, record){
					// 		if(record.get('entered_in_error')){
					// 			meta.tdCls += ' entered-in-error ';
					// 			meta.tdAttr = 'data-qtip="' + _('error_note') + ': ' + record.get('error_note') + '"';
					// 		}
					// 		return app.boolRenderer(v);
					// 	}
					// }
				],
				plugins: Ext.create('Ext.grid.plugin.RowEditing', {
					autoCancel: true,
					errorSummary: false,
					clicksToEdit: 2
				}),
				tbar: [
					_('group_by') + ':',
					{
						xtype: 'button',
						text: _('category'),
						enableToggle: true,
						action: 'docTypeCode',
						pressed: true,
						disabled: true,
						toggleGroup: 'documentgridgroup'
					},
					{
						xtype: 'button',
						text: _('date'),
						enableToggle: true,
						action: 'groupDate',
						toggleGroup: 'documentgridgroup'
					},
					'->',
					'-',
					{
						icon: 'resources/images/icons/no.png',
						itemId: 'PatientDocumentEnteredInErrorBtn',
						tooltip: _('entered_in_error'),
						acl: a('allow_document_enter_in_error')
					},
					'-',
					{
						icon: 'resources/images/icons/icoScanner.png',
						itemId: 'documentScanBtn',
						tooltip: _('scan')
					},
					'-',
					{
						icon: 'resources/images/icons/upload.png',
						itemId: 'documentUploadBtn',
						tooltip: _('upload')
					}
				],
				bbar: Ext.create('Ext.PagingToolbar', {
					pageSize: 10,
					store: store,
					displayInfo: true,
					items: [
						{
							text: 'Show...',
							destroyMenu: true,
							itemId: 'PatientDocumentGridGroupBtn',
							menu: []
						}
					]
				})
			},
			{
				xtype: 'panel',
				region: 'center',
				flex: 2,
				layout: {
					type: 'vbox',
					align: 'stretch'
				},
				frame: true,
				itemId: 'patientDocumentViewerPanel',
				cls: 'document-viewer-backgroud',
				items: [
					{
						xtype: 'miframe',
						style: 'document-viewer-backgroud',
						autoMask: false,
						flex: 1,
						itemId: 'patientDocumentViewerFrame'
					}
				],
				bbar: [
					{
						xtype: 'sliderfield',
						value: 1,
						increment: 0.1,
						decimalPrecision: 1,
						minValue: 0.1,
						maxValue: 1,
						flex: 1,
						margin: '0 10',
						stateId: 'PatientDocumentViewerOpacityField',
						stateful: true,
						itemId: 'PatientDocumentViewerOpacityField',
						getState: function(){
							return {"value": this.getValue()};
						},
						applyState: function(state){
							this.setValue(state.value);
						},
						stateEvents: [
							'change'
						]
					}
				]
			}
		];

		me.callParent(arguments);
	}
});
Ext.define('App.view.patient.CCD', {
	extend: 'Ext.panel.Panel',
	requires: [
		'Ext.ux.IFrame',
		'App.ux.ManagedIframe'
	],
	xtype: 'patientccdpanel',
	title: _('ccd'),
	columnLines: true,
	itemId: 'CcdPanel',
	layout: 'fit',
	items: [
		{
			xtype: 'miframe',
			style: 'background-color:white',
			autoMask: true,
			itemId: 'patientDocumentViewerFrame'
		}
	],
	tbar: [
        {
            xtype: 'fieldcontainer',
            border: 1,
            layout: 'vbox',
            defaults: {
                margin: '0 5 5 5'
            },
            items:[
                {
                    xtype: 'patientEncounterCombo',
                    itemId: 'PatientCcdPanelEncounterCmb',
                    width: 300,
                    fieldLabel: _('filter_encounter'),
                    hideLabel: false,
                    labelAlign: 'top',
	                includeAllSelection: true
                }
            ]

        },
		'-',
		{
			xtype: 'checkboxgroup',
			fieldLabel: _('exclude'),
			columns: 4,
			vertical: true,
			labelWidth: 80,
			itemId: 'PatientCcdPanelExcludeCheckBoxGroup',
			flex: 1,
			items: [
				{boxLabel: _('procedures'), name: 'exclude', inputValue: 'procedures'},
				{boxLabel: _('vitals'), name: 'exclude', inputValue: 'vitals'},
				{boxLabel: _('immunizations'), name: 'exclude', inputValue: 'immunizations'},
				{boxLabel: _('medications'), name: 'exclude', inputValue: 'medications'},
				{boxLabel: _('meds_administered'), name: 'exclude', inputValue: 'administered'},
				{boxLabel: _('problems'), name: 'exclude', inputValue: 'problems'},
				{boxLabel: _('allergies'), name: 'exclude', inputValue: 'allergies'},
				{boxLabel: _('social'), name: 'exclude', inputValue: 'social'},
				{boxLabel: _('results'), name: 'exclude', inputValue: 'results'},
                {boxLabel: _('provider_information'), name: 'exclude', inputValue: 'provider_information'},
                {boxLabel: _('clinical_instructions'), name: 'exclude', inputValue: 'clinical_instructions'},
                {boxLabel: _('plan_of_care'), name: 'exclude', inputValue: 'planofcare'},
                // {boxLabel: _('future_appointments'), name: 'exclude', inputValue: 'future_appointments'},
				{boxLabel: _('visit_date_location'), name: 'exclude', inputValue: 'visit_date_location'},
                {boxLabel: _('reason_for_visit'), name: 'exclude', inputValue: 'reason_for_visit'},
                {boxLabel: _('patient_decision_aids'), name: 'exclude', inputValue: 'patient_decision_aids'},

				{boxLabel: _('future_appointments'), name: 'exclude', inputValue: 'future_appointments'},
				{boxLabel: _('future_schedule_test'), name: 'exclude', inputValue: 'future_schedule_test'},
				{boxLabel: _('diagnostic_test_pending'), name: 'exclude', inputValue: 'diagnostic_test_pending'},
				{boxLabel: _('patient_information'), name: 'exclude', inputValue: 'patient_information'},

                {boxLabel: _('patient_name'), name: 'exclude', inputValue: 'patient_name'},
                {boxLabel: _('patient_sex'), name: 'exclude', inputValue: 'patient_sex'},
                {boxLabel: _('patient_dob'), name: 'exclude', inputValue: 'patient_dob'},
                {boxLabel: _('patient_race'), name: 'exclude', inputValue: 'patient_race'},
                {boxLabel: _('patient_ethnicity'), name: 'exclude', inputValue: 'patient_ethnicity'},
                {boxLabel: _('patient_preferred_language'), name: 'exclude', inputValue: 'patient_preferred_language'},
                {boxLabel: _('patient_marital_status'), name: 'exclude', inputValue: 'patient_marital_status'},
				{boxLabel: _('patient_smoking_status'), name: 'exclude', inputValue: 'patient_smoking_status'},
			]
		},
		'-',
		{
			xtype: 'button',
			text: _('refresh'),
			margin: '0 0 5 0',
			itemId: 'viewCcdBtn',
			icon: 'resources/images/icons/refresh.png'
		},
		'-',
		{
			xtype: 'container',
			layout: 'vbox',
			items: [
				{
					xtype: 'button',
					text: _('upload'),
					margin: '0 0 5 0',
					itemId: 'importCcdBtn',
					icon: 'resources/images/icons/upload.png',
					width: 100
				},
				{
					xtype: 'button',
					text: _('download'),
					itemId: 'exportCcdBtn',
					icon: 'resources/images/icons/download.png',
					width: 100
				}
			]
		},
		'-',
		{
			xtype: 'container',
			layout: 'vbox',
			items: [
				{
					xtype: 'button',
					text: _('archive'),
					margin: '0 0 5 0',
					itemId: 'archiveCcdBtn',
					icon: 'resources/images/icons/archive_16.png',
					width: 100
				},
				{
					xtype: 'button',
					text: 'Print',
					iconCls: 'icon-print',
					itemId: 'printCcdBtn',
					width: 100
				}
			]
		}
	]

});

Ext.define('App.view.patient.Amendments', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'patientamendmentspanel',
	title: _('amendments'),
	initComponent: function () {

		var me = this;

		me.store = Ext.create('App.store.miscellaneous.Amendments',{
			remoteFilter: true
		});

		me.columns = [
			{
				text: _('type'),
				width: 70,
				dataIndex: 'amendment_type',
				renderer: function(v, meta, record){
					var str;

					if(v === 'P'){
						str = _('patient');
					}else if(v === 'G'){
						str = _('guardian');
					}else if(v === 'E'){
						str = _('emergency_contact');
					}else if(v === 'D'){
						str = _('doctor');
					}else if(v === 'O'){
						str = _('organization');
					}else{
						str = v;
					}

					return str;
				}
			},
			{
				text: _('dates'),
				columns: [
					{
						text: _('received'),
						width: 140,
						dataIndex: 'create_date',
						// renderer: me.dateNewRenderer
					},
					{
						text: _('appended'),
						width: 140,
						dataIndex: 'create_date',
						// renderer: me.dateNewRenderer
						// renderer: function(v, meta, record){
						// 	if(record.get('amendment_status') === 'A'){
						// 		return me.dateNewRenderer(v, meta, record);
						// 	}else{
						// 		return me.dateNewRenderer(null, meta, record);
						// 	}
						// }
					},
					{
						text: _('responded'),
						width: 140,
						dataIndex: 'response_date',
						// renderer: me.dateNewRenderer
					}
				]
			},
			{
				text: _('message'),
				flex: 1,
				dataIndex: 'amendment_message',
				// renderer: me.newRenderer
			},
			{
				text: _('response_message'),
				flex: 1,
				dataIndex: 'response_message',
				// renderer: me.newRenderer
			},
			{
				text: _('status'),
				width: 100,
				dataIndex: 'amendment_status',
				renderer: function(v, meta, record){
					var str;

					if(v === 'W'){
						str = _('waiting_response');
					}else if(v === 'A'){
						str = _('approved');
					}else if(v === 'D'){
						str = _('denied');
					}else if(v === 'C'){
						str = _('canceled');
					}else if(v === 'E'){
						str = _('error');
					}else{
						str = v;
					}

					// me.controller.updateIsViewed(record);

					return str;
				}
			},
			{
				text: _('approved_denied_by'),
				width: 200,
				dataIndex: 'responded_by',
				// renderer: me.newRenderer
			}
		];
		me.bbar = {
			xtype: 'pagingtoolbar',
				pageSize: 25,
				store: me.store,
				displayInfo: true,
				plugins: new Ext.ux.SlidingPager()
		};


		me.callParent();
	}
});

Ext.define('App.model.patient.CareTeamMember', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_care_team_members'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'npi',
			type: 'string',
			len: 10,
			index: true
		},
		{
			name: 'is_primary',
			type: 'bool',
			index: true
		},
		{
			name: 'fname',
			type: 'string',
			store: false
		},
		{
			name: 'mname',
			type: 'string',
			store: false
		},
		{
			name: 'lname',
			type: 'string',
			store: false
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'CareTeamMember.getCareTeamMembers',
			create: 'CareTeamMember.addCareTeamMember',
			update: 'CareTeamMember.updateCareTeamMember',
			destroy: 'CareTeamMember.destroyCareTeamMember'
		}
	}
});


Ext.define('App.store.patient.CareTeamMembers', {
	extend: 'Ext.data.Store',
	requires: [
		'App.model.patient.CareTeamMember'
	],
	model: 'App.model.patient.CareTeamMember'
});
Ext.define('App.view.patient.CareTeamGrid', {
	extend: 'Ext.grid.Panel',
	xtype: 'patientcareteamgrid',
	requires: [
		'Ext.grid.feature.Grouping',
		'App.ux.LiveReferringPhysicianSearch'
	],
	title: 'Care Team',
	hideHeaders: true,
	store: Ext.create('App.store.patient.CareTeamMembers',{
		autoSync: true,
		sorters: [
			{
				property: 'is_primary',
				direction: 'DESC'
			}
		]
	}),
	columns: [
		{
			xtype: 'checkcolumn',
			dataIndex: 'is_primary',
			width: 25,
			itemId: 'CareTeamGridIdPrimaryCheckColumn',
			tooltip: 'Is Primary Provider'
		},
		{
			header: _('npi'),
			dataIndex: 'npi',
			width: 80
		},
		{
			header: _('name'),
			dataIndex: 'lname',
			flex: 1,
			renderer: function (v,m,r) {
				return Ext.String.format('{0}, {1} {2}',
					r.get('lname'),
					r.get('fname'),
					r.get('mname')
				);
			}
		},
		{
			xtype: 'griddeletecolumn',
			width: 25,
			acl: true
		}
	],
	tbar: [
		{
			xtype: 'referringphysicianlivetsearch',
			itemId: 'CareTeamGridReferringPhysicianSearch',
			flex: 1
		}
	]
});
Ext.define('App.view.patient.EncountersGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.feature.Grouping'
	],
	xtype: 'encountersgrid',
	title: _('encounter_history'),
	itemId: 'EncountersGrid',
	initComponent: function (){
		var me = this;

		me.store = Ext.create('App.store.patient.Encounters', {
			remoteFilter: true,
			pageSize: 500
		});

		me.columns = [
			{
				header: 'eid',
				sortable: false,
				dataIndex: 'eid',
				hidden: true
			},
			{
				width: 180,
				header: _('service_date'),
				sortable: true,
				dataIndex: 'service_date',
				renderer: Ext.util.Format.dateRenderer('F j, Y, g:i a')
			},
			{
				flex: 1,
				header: _('chief_complaint'),
				sortable: true,
				dataIndex: 'brief_description',
				renderer: function (v,m,r){
					var  str = v;
					if(r.isPrivate()){
						str = '<i class="fas fa-shield-check" style="color: red"></i> ' + str;
					}

					if(r.isClose()){
						str = '<i class="fas fa-shield-check" style="color: #1b9bfc"></i> ' + str;
					}
					return str;
				}
			},
			{
				width: 200,
				header: _('provider'),
				sortable: false,
				dataIndex: 'provider_uid',
				renderer: function (v, m, r){
					return Ext.String.format(
						'{0}, {1} {2}',
						r.get('provider_lname'),
						r.get('provider_fname'),
						r.get('provider_mname')
					);
				}
			},
			{
				width: 200,
				header: _('facility'),
				sortable: false,
				dataIndex: 'facility_name'
			},
			{
				width: 70,
				header: _('signed') + '?',
				sortable: true,
				dataIndex: 'close_date',
				renderer: function (v){
					return  app.boolRenderer(v !== null);
				}
			}
		];

		me.tbar = Ext.create('Ext.PagingToolbar', {
			store: me.store,
			displayInfo: true,
			emptyMsg: 'No Encounters Found',
			plugins: Ext.create('Ext.ux.SlidingPager', {}),
			items: [
				'-',
				{
					text: _('new_encounter'),
					itemId: 'EncountersGridNewEncounterBtn'
				},
				'-',
				{
					text: _('progress_report'),
					disabled: true,
					itemId: 'EncountersGridNewProgressReportsBtn'
				}
			]
		});

		me.callParent(arguments);
	}
});
Ext.define('App.view.patient.PatientNotesGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.feature.Grouping',
		'App.ux.grid.RowFormEditing',
	],
	xtype: 'patientnotesgrid',

	initComponent: function (){
		var me = this;

		me.store = Ext.create('App.store.patient.Notes', {
			autoSync: false,
			remoteFilter: true,
			pageSize: 50
		});

		me.columns = [
			{
				xtype: 'griddeletecolumn',
				acl: a('delete_patient_notes'),
				width: 20
			},
			{
				xtype: 'datecolumn',
				text: _('date'),
				format: 'Y-m-d',
				dataIndex: 'date'
			},
			{
				text: _('type'),
				dataIndex: 'type'
			},
			{
				text: _('note'),
				dataIndex: 'body',
				flex: 1
			},
			{
				text: _('user'),
				width: 200,
				dataIndex: 'user_name'
			},
			{
				text: _('update') + ' ' + _('user'),
				width: 200,
				dataIndex: 'update_user_name'
			},
			{
				xtype: 'datecolumn',
				text: _('update') + ' ' + _('date'),
				format: 'Y-m-d',
				dataIndex: 'update_date'
			}
		];

		me.plugins = Ext.create('App.ux.grid.RowFormEditing', {
			// autoCancel: false,
			// errorSummary: false,
			clicksToEdit: 2,
			items: [
				{
					xtype: 'gaiaehr.combo',
					// xtype: 'textfield',
					fieldLabel: _('type'),
					name: 'type',
					emptyText: _('type'),
					queryMode: 'local',
					listKey: 'admin_note_types',
					width: 300,
					margin: '0 0 5 0',
					loadStore: true,
					editable: false
				},
				{
					xtype: 'textareafield',
					fieldLabel: _('note'),
					name: 'body',
					height: 50,
					anchor: '100%'
				}
			]
		});



		me.tbar = [
			'->',
			{
				text: _('add_note'),
				iconCls: 'icoAdd',
				action: 'note',
				itemId: 'PatientNotesGridAddNotesBtn',
				//handler: me.onAddNew,
				acl: a('add_patient_notes')
			}
		];

		me.bbar = {
			xtype: 'pagingtoolbar',
			store: me.store,
			displayInfo: true,
			plugins: new Ext.ux.SlidingPager()
		};

		me.callParent();
	}
});
Ext.define('App.ux.combo.ServiceLocation', {
	extend: 'Ext.form.ComboBox',
	xtype: 'servicelocationcombo',
	typeAhead: true,
	typeAheadDelay: 50,
	queryMode: 'local',
	displayField: 'valueFieldText',
	valueField: 'code',
	editable: false,
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{name: 'code', type: 'string'},
				{name: 'displayName', type: 'string'},
				{
					name: 'valueFieldText', convert: function(v, r){
						return Ext.String.format('{0} - {1}', r.get('code'), r.get('displayName'));
					}
				}
			],
			autoLoad: true,
			proxy: {
				type: 'ajax',
				url: 'resources/code_sets/PH_HealthcareServiceLoc_NHSN.json',
				reader: {
					type: 'json'
				}
			}
		});

		me.callParent(arguments);
	}
});

Ext.define('App.view.patient.LegalLetters', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	xtype: 'patientlegalletters',
	title: _('legal_letters'),
	selType: 'checkboxmodel',
	features: [{
		ftype: 'grouping',
		groupHeaderTpl: '{columnName}: {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',
		// hideGroupedHeader: true,
		// startCollapsed: true
	}],
	initComponent: function (){
		var me = this;

		me.store = Ext.create('App.store.administration.LegalLetterSignatures', {
			pageSize: 100,
			remoteFilter: true,
			groupField: 'letter_title'
		});

		me.columns = [
			{
				text: _('letter'),
				dataIndex: 'letter_title',
				flex: 1
			},
			{
				text: _('letter_version'),
				dataIndex: 'letter_version',
				width: 120
			},
			{
				text: _('ip_address'),
				dataIndex: 'signature_ip',
				width: 120
			},
			{
				xtype: 'datecolumn',
				text: _('date_signed'),
				dataIndex: 'signature_date',
				flex: 1,
				format: g('date_time_display_format')
			},
			{
				text: _('signature'),
				dataIndex: 'signature',
				width: 200,
				renderer: function (v){
					if(v === ''){
						return '<span style="color: red;">SIGNATURE REQUIRED</span>'
					}else{
						return Ext.String.format('<img src="{0}" style="width: 100%" alt="Document Signature"/>', v);
					}
				}
			},

		];

		me.tbar = [
			{
				xtype: 'button',
				text: 'Preview Document',
				iconCls: 'fal fa-file',
				itemId: 'PatientLegalLettersPreviewDocumentBtn'
			},
			'->',
			{
				xtype: 'button',
				text: 'Sign Document',
				iconCls: 'fal fa-file-signature',
				itemId: 'PatientLegalLettersSignDocumentBtn'
			}
		];
		me.bbar = {
			xtype: 'pagingtoolbar',
			pageSize: 100,
			store: me.store,
			displayInfo: true,
			plugins: new Ext.ux.SlidingPager()
		};

		me.callParent();

	}
});

Ext.define('App.ux.grid.ColumnSearchField', {
	extend: 'Ext.form.field.Trigger',
	xtype: 'columnsearchfield',
	triggerCls: 'x-form-clear-trigger',
	operator: '=',
	prefix: '',
	suffix: '',
	enableKeyEvents: true,
	initComponent:function(){

		var me = this;

		if(me.autoSearch !== true){
			me.trigger2Cls = 'x-form-search-trigger';
		}

		me.setFilterBuffer = Ext.Function.createBuffered(me.setFilter, 500, me);

		me.callParent(arguments);

		me.on('render', function() {
			var mee = this;
			mee.ownerCt.on('resize', function () {
				mee.setWidth(this.getEl().getWidth());
			});
		});

		me.on('change', function() {
			if(me.autoSearch){
				me.setFilterBuffer(me.up().dataIndex, me.getSubmitValue());
			}
		});

		me.on('keyup', function(f, e) {
			if(e.getKey() === e.ENTER) {
				me.setFilterBuffer(me.up().dataIndex, me.getSubmitValue());
			}
		});

	},

	onTriggerClick: function() {
		this.setValue('');
		this.setFilter(this.up().dataIndex, undefined);
	},

	onTrigger2Click: function() {
		this.setFilter(this.up().dataIndex, this.getValue());
	},

	setFilter: function(filterId, value){
		var store = this.up('grid').getStore();
		if(value){
			store.removeFilter(filterId, false);
			var filter = {
				id: filterId,
				property: filterId,
				operator: this.operator,
				value: this.prefix + value + this.suffix
			};
			if(this.anyMatch) filter.anyMatch = this.anyMatch;
			if(this.caseSensitive) filter.caseSensitive = this.caseSensitive;
			if(this.exactMatch) filter.exactMatch = this.exactMatch;
			if(this.operator) filter.operator = this.operator;
			store.addFilter(filter)
		} else {
			store.filters.removeAtKey(filterId);
			store.reload()
		}
	}
});
Ext.define('App.ux.grid.Button', {
	extend: 'Ext.grid.column.Column',
	alias: ['widget.gridbutton'],
	header: '&#160;',
	sortable: false,
	context: {},
	applicationProperties: {
		/*
		 * this is where the icons will be picked up.
		 */
		iconStore: ''
	},
	constructor: function(config){
		var me = this, cfg, items,
			i, item;
		cfg = Ext.apply({}, config);
		items = cfg.items || [me];
		me.callParent(arguments);
		me.items = items;
		me.context = cfg.scope;
		/*
		 * create a render for this special button.
		 */
		me.renderer = function(v, meta, rec, rowIndex, colIndex, store, view){
			/*
			 * iterate each item creating a div holder for each button
			 */
			Ext.Array.each(items, function(anItem){
				var anId;
				item = anItem;
				anId = Ext.id(); //generate an ID for multiple buttons
				/*
				 * simply defer instead of callback ensuring the basic div for the button is executed & previous call has completed.
				 */
				Ext.Function.defer(me.addButton, 100, me, [anId, rec, item, me.context]);
				/*
				 * create a place holder for the button.
				 */
				v ? v += '<div id="' + anId + '">&#160;</div>' : v = '<div id="' + anId + '">&#160;</div>';
			});
			return v;
		};
	},
	/*
	 * simple function when no hanlder click events are passed in.
	 */
	noHandler: function(){
		Ext.Msg.alert("Oops", "No Handler set up");
	},

	addButton: function(id, record, theItem, context){
		var me = this, target = Ext.get(id), btn, handler,
			menuItems, functionHandler, buttonConfig, menuIcon;

		if(target){
			if(theItem.menu){ //handle the split button
				menuItems = [];
				Ext.Array.each(theItem.menu, function(aMenuItem){
					aMenuItem.handler ? functionHandler = Ext.bind(aMenuItem.handler, me, [record, context]) : functionHandler = me.noHandler;
					aMenuItem.icon ? menuIcon = me.applicationProperties.iconStore + aMenuItem.icon : menuIcon = undefined;
					var newMenu = { text: aMenuItem.text, handler: functionHandler, icon: menuIcon};
					menuItems.push(newMenu);
				});
				buttonConfig = {
					text: theItem.text,
					icon: theItem.icon ? me.applicationProperties.iconStore + theItem.icon : "",
					menu: menuItems,
					renderTo: target.parent()
				};
			} //handle a standard button
			else{
				theItem.handler ? functionHandler = Ext.bind(theItem.handler, me, [record, context]) : functionHandler = me.noHandler;
				buttonConfig = {
					text: theItem.text,
					tooltip: theItem.tooltip,
					icon: theItem.icon ? me.applicationProperties.iconStore + theItem.icon : "",
					handler: functionHandler,
					cls: theItem.cls || null,
					listeners: theItem.listeners || null,
					record: record,
					width: theItem.width || 50,
					margin: theItem.margin || 0,
					renderTo: target.parent()
				};
			}
			btn = Ext.create("Ext.button.Button", buttonConfig);
			/*
			 * clean up the DIV
			 */
			Ext.get(id).remove();
		}
	},

	destroy: function(){
		delete this.items;
		delete this.renderer;
		this.callParent(arguments);
	},

	cascade: function(fn, scope){
		fn.call(scope || this, this);
	},

	getRefItems: function(){
		return [];
	}
});
Ext.define('App.view.administration.practice.DecisionAids', {
	extend: 'Ext.grid.Panel',
	xtype: 'decisionaidspanel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'Ext.ux.SlidingPager'
	],
	title: _('patient_decision_aids'),

	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			store: me.store = Ext.create('App.store.administration.DecisionAids', {
				autoSync: false
			}),
			columns: [
				{
					text: _('trigger_code'),
					dataIndex: 'trigger_code',
					sortable: true,
					width: 150,
					editor: {
						xtype: 'textfield',
						maxLength: 40
					}
				},
				{
					text: _('description_code'),
					dataIndex: 'instruction_code',
					width: 150,
					editor: {
						xtype: 'textfield',
						maxLength: 40
					}
				},
				{
					text: _('description_code_type'),
					dataIndex: 'instruction_code_type',
					width: 150,
					editor: {
						xtype: 'textfield',
						maxLength: 40
					}
				},
				{
					text: _('description'),
					dataIndex: 'instruction_code_description',
					flex: 1,
					editor: {
						xtype: 'textfield',
						maxLength: 600
					}
				},
				{
					text: _('active'),
					sortable: true,
					dataIndex: 'active',
					renderer: me.boolRenderer,
					editor: {
						xtype: 'checkboxfield'
					}
				}
			],
			plugins: [
				{
					ptype: 'rowediting',
					clicksToEdit: 1
				}
			],
			tbar: [
				'->',
				{
					xtype: 'button',
					text: _('decision_aid'),
					iconCls: 'icoAdd',
					itemId: 'DecisionAidsAddBtn'
				}
			],
			bbar: Ext.create('Ext.PagingToolbar', {
				pageSize: 10,
				store: me.store,
				displayInfo: true,
				plugins: Ext.create('Ext.ux.SlidingPager', {})
			})
		});

		me.callParent(arguments);

	}

});

Ext.define('App.ux.combo.XCombo', {
	extend: 'Ext.form.field.ComboBox',
	xtype: 'xcombo',

	trigger1Class: 'x-form-select-trigger',
	trigger2Class: 'x-form-add-trigger',
	trigger3Class: 'x-form-update-trigger',

	editable: false,

	addTooltip: 'Add Item',
	saveText: 'Save',
	cancelText: 'Cancel',
	maskText: 'Saving Data',

	windowConfig: {
		title: 'New Record',
		modal: true
	},

	formConfig: {
		width: 400,
		height: 240,
		border: false,
		html: 'Form placeholder, please add a formConfig property<br>' +
			'Exmaple:<br>' +
			'<pre>' +
			'{<br>' +
			'   ptype: "comboadd",<br>' +
			'   windowConfig: {<br>' +
			'       title: "New Record"<br>' +
			'       modal: true<br>' +
			'   }<br>' +
			'   formConfig: {<br>' +
			'       width: 600,<br>' +
			'       height: 400,<br>' +
			'       border: false,<br>' +
			'       items:[ {...},{...} ]<br>' +
			'   }<br>' +
			'}<br>' +
			'</pre>'
	},

	initComponent: function (config) {
		var me = this;

		me.addEvents(
			'cancel',
			'beforesync',
			'sync',
			'failure'
		);

		me.on('select', me.setUpdateTrigger, me);

		me.callParent(arguments);
	},

	onRender: function (ct, position) {

		var me = this,
			id = me.getId();

		me.callParent(arguments);

		me.triggerWidth = 51;

		me.triggerConfig = {
			tag: 'td',
			valign: 'top',
			cls: 'x-trigger-cell',
			style: 'width:34px',
			cn: [
				{
					tag: "img",
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger1" + id,
					name: "trigger1" + id,
					style: "float:left",
					cls: "x-form-trigger " + this.trigger1Class,
					role: 'button'
				},
				{
					tag: "img",
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger2" + id,
					name: "trigger2" + id,
					style: "float:left",
					cls: "x-form-trigger " + this.trigger2Class,
					role: 'button'
				},
				{
					tag: "img",
					src: Ext.BLANK_IMAGE_URL,
					id: "trigger3" + id,
					name: "trigger3" + id,
					style: "float:left;display:none",
					cls: "x-form-trigger " + this.trigger3Class,
					role: 'button'
				}
			]
		};

		me.triggerCell.replaceWith(me.triggerConfig);

		me.trigger1 = Ext.get("trigger1" + id);
		me.trigger2 = Ext.get("trigger2" + id);
		me.trigger3 = Ext.get("trigger3" + id);

		me.trigger1.on('mouseup', me.triggerClick, me);
		me.trigger2.on('mouseup', me.triggerClick, me);
		me.trigger3.on('mouseup', me.triggerClick, me);

		me.trigger1.addClsOnOver('x-form-trigger-over');
		me.trigger2.addClsOnOver('x-form-trigger-over');
		me.trigger3.addClsOnOver('x-form-trigger-over');
	},

	setUpdateTrigger: function () {
		if (!this.trigger3.isVisible()) {
			this.setWidth(this.getWidth() + 17);
			this.triggerCell.setWidth(51);
			this.trigger3.show();
		}
	},

	triggerClick: function (e) {
		var id = this.getId();
		if (e.target.name == "trigger1" + id) {
			this.onTriggerClick();
		} else if (e.target.name == "trigger2" + id) {
			this.onTriggerAddClick();
		} else if (e.target.name == "trigger3" + id) {
			this.onTriggerUpdateClick();
		}
	},

	/**
	 * Start the window
	 */
	onTriggerAddClick: function () {
		var me = this;
		me.reset();
		me.getWindow().show();
		me.uWindow.down('form').getForm().loadRecord(me.getNewRecord());
	},

	/**
	 * Start the window
	 */
	onTriggerUpdateClick: function () {
		var me = this;
		me.getWindow().show();
		me.uWindow.down('form').getForm().loadRecord(me.getSelectedRecord());
	},

	getSelectedRecord: function () {
		return this.findRecordByValue(this.getValue());
	},

	getNewRecord: function () {
		return Ext.create(this.getStore().model);
	},

	/**
	 * Creates a new window
	 */
	getWindow: function () {
		var me = this;

		me.uWindow = Ext.widget('window', {
			items: [Ext.widget('form', me.formConfig)],
			buttons: [
				{
					text: me.cancelText,
					scope: me,
					handler: me.doCancelRecord
				},
				{
					text: me.saveText,
					scope: me,
					handler: me.doSaveRecord
				}
			]
		});

		return Ext.apply(me.uWindow, me.windowConfig);
	},

	/**
	 * Saves the record and to combobox sotore everything
	 */
	doSaveRecord: function () {
		var me = this,
			panel = me.uWindow.down('form'),
			form = panel.getForm(),
			record = form.getRecord(),
			values = form.getValues(),
			index = me.store.indexOf(record);

		record.set(values);
		if (index == -1) me.store.add(record);

		if (me.store.getNewRecords().length || me.store.getUpdatedRecords().length) {
			panel.el.mask(me.maskText);
			// fires the beforesync event and add the values to the store
			me.fireEvent('beforesync', me.store, record);

			me.store.sync({
				// hanlde sync success
				success: function(batch, options) {
					me.select(record);
					me.fireEvent('sync', me.store, record, batch, options);
				},
				// handle sync failure
				failure: function() {
					me.fireEvent('failure', me.store, record, batch, options);
				},
				// handle all request
				callback: function() {
					panel.el.unmask();
					form.reset();
					me.uWindow.close();
				}
			});
		} else {
			form.reset();
			me.uWindow.close();
		}
	},

	/**
	 * Cancels everything
	 */
	doCancelRecord: function () {
		var me = this,
			form = me.uWindow.down('form').getForm();

		me.fireEvent('cancel', me, me.form, me.store);
		form.reset();
		me.uWindow.close();
	}
});

Ext.define("App.ux.form.fields.plugin.PasswordStrength", {
	extend : "Ext.AbstractPlugin",
	alias  : "plugin.passwordstrength",
	colors : [
		"ffcccc",
		"ffcc99",
		"ffff99",
		"99ccff",
		"99ff99"
	],

	init: function(cmp) {
		var me = this;

		cmp.on("change", me.onFieldChange, me);
	},

	onFieldChange: function(field, newVal, oldVal) {
		if (newVal === "") {
			field.inputEl.setStyle({
				"background-color" : null,
				"background-image" : null
			});
			field.score = 0;
			return ;
		}
		var me    = this,
			score = me.scorePassword(newVal);

		field.score = score;

		me.processValue(field, score);
	},

	processValue: function(field, score) {
		var me     = this,
			colors = me.colors,
			color;

		if (score < 16) {
			color = colors[0]; //very weak
		} else if (score > 15 && score < 25) {
			color = colors[1]; //weak
		} else if (score > 24 && score < 35) {
			color = colors[2]; //mediocre
		} else if (score > 34 && score < 45) {
			color = colors[3]; //strong
		} else {
			color = colors[4]; //very strong
		}

		field.inputEl.setStyle({
			"background-color" : "#" + color,
			"background-image" : "none"
		});
	},

	scorePassword: function(passwd) {
		var score = 0;

		if (passwd.length < 5) {
			score += 3;
		} else if (passwd.length > 4 && passwd.length < 8) {
			score += 6;
		} else if (passwd.length > 7 && passwd.length < 13) {
			score += 12;
		} else if (passwd.length > 12) {
			score += 18;
		}

		if (passwd.match(/[a-z]/)) {
			score += 1;
		}

		if (passwd.match(/[A-Z]/)) {
			score += 5;
		}

		if (passwd.match(/\d+/)) {
			score += 5;
		}

		if (passwd.match(/(.*[0-9].*[0-9].*[0-9])/)) {
			score += 5;
		}

		if (passwd.match(/.[!,@,#,$,%,^,&,*,?,_,~]/)) {
			score += 7;
		}

		if (passwd.match(/(.*[!,@,#,$,%,^,&,*,?,_,~].*[!,@,#,$,%,^,&,*,?,_,~])/)) {
			score += 7;
		}

		if (passwd.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/)) {
			score += 3;
		}

		if (passwd.match(/([a-zA-Z])/) && passwd.match(/([0-9])/)) {
			score += 3;
		}

		if (passwd.match(/([a-zA-Z0-9].*[!,@,#,$,%,^,&,*,?,_,~])|([!,@,#,$,%,^,&,*,?,_,~].*[a-zA-Z0-9])/)) {
			score += 3;
		}

		return score;
	}
});
Ext.define('App.ux.combo.ActiveSpecialties', {
	extend: 'Ext.form.ComboBox',
	xtype: 'activespecialtiescombo',
	displayField: 'title',
	valueField: 'id',
	editable: false,
	emptyText: _('select'),
	queryMode: 'local',
	includeAllOption: false,
	initComponent: function(){
		var me = this;

		this.store = Ext.create('App.store.administration.Specialties',{
			pageSize: 500,
			autoLoad: true,
			listeners: {
				load: function (){
					if(me.includeAllOption){
						me.store.insert(0,{
							id: -1,
							title: 'ALL',
							combo_text: 'ALL',
							active: true
						});
						me.setValue(-1);
					}
				}
			}
		});

		this.store.clearFilter(true);
		this.store.filter([
			{
				property: 'active',
				value: true
			}
		]);
		this.callParent();
	}

});
Ext.define('App.ux.combo.Departments', {
	extend: 'Ext.form.ComboBox',
	xtype: 'depatmentscombo',
	editable: false,
	queryMode: 'local',
	valueField: 'id',
	displayField: 'title',
	emptyText: _('select'),
	store: Ext.create('App.store.administration.Departments', {
		autoLoad: true
	})
});
Ext.define("App.ux.grid.exporter.Exporter", {
    uses: [
        "App.ux.grid.exporter.ExporterButton",
        "App.ux.grid.exporter.csvFormatter.CsvFormatter",
        "App.ux.grid.exporter.excelFormatter.ExcelFormatter",
        "App.ux.grid.exporter.FileSaver"],

    statics: {
        /**
         * Exports a grid, using formatter
         * @param {Ext.grid.Panel/Ext.data.Store/Ext.tree.Panel} componet/store to export from
         * @param {String/App.ux.grid.exporter.Formatter} formatter
         * @param {Object} config Optional config settings for the formatter
         * @return {Object} with data, mimeType, charset, ext(extension)
         */
        exportAny: function(component, format, config) {

            var func = "export";
            if (!component.is) {
                func = func + "Store";
            } else if (component.is("gridpanel")) {
                func = func + "Grid";
            } else if (component.is("treepanel")) {
                func = func + "Tree";
            } else {
                func = func + "Store";
                component = component.getStore();
            }
            var formatter = this.getFormatterByName(format);
            return this[func](component, formatter, config);
        },

        /**
         * Exports a grid, using formatter
         * @param {Ext.grid.Panel} grid The grid to export from
         * @param {String/App.ux.grid.exporter.Formatter} formatter
         * @param {Object} config Optional config settings for the formatter
         */
        exportGrid: function(grid, formatter, config) {

            config = config || {};
            formatter = this.getFormatterByName(formatter);

            var store = grid.getStore() || config.store;
            var columns = Ext.Array.filter(grid.view.headerCt.getVisibleGridColumns(), function(col) {
                return !col.hidden && (!col.xtype || col.xtype !== "actioncolumn" || col.xtype !== "rownumberer" || col.xtype !== "templatecolumn") && col.isCheckerHd !== true;
            });
            var isGrouped = store.isGrouped ? store.isGrouped() : false;
            var hasSummary;
            var hasGroupingSummary;
            var groupField;
            var grouping;
            var summary = this.getFeature(grid, 'summary');

            if(isGrouped){
                //var feature = this.getFeature( grid, featureId );
                grouping = this.getFeature(grid, 'grouping');
                if(grouping){
                    groupField = grouping.getGroupField();
                    hasGroupingSummary = (grouping.ftype === "groupingsummary");
                }else {
                    isGrouped = false;  // isGrouped turned off if grouping feature not defined
                }
            }

            if(summary){
                hasSummary = true
            }

            Ext.apply(config, {
                title: grid.title,
                columns: columns,
                isGrouped: isGrouped,
                hasGroupingSummary: hasGroupingSummary,
                hasSummary: hasSummary,
                groupField: groupField,
                grouping: grouping,
                summary: summary
            });

            return {
                data: formatter.format(store, config),
                mimeType: formatter.mimeType,
                charset: formatter.charset,
                ext: formatter.extension
            };
        },

        /**
         * Exports a grid, using formatter
         * @param {Ext.data.Store} store to export from
         * @param {String/App.ux.grid.exporter.Formatter} formatter
         * @param {Object} config Optional config settings for the formatter
         */
        exportStore: function(store, formatter, config) {

            config = config || {};
            formatter = this.getFormatterByName(formatter);
            Ext.applyIf(config, {
                columns: store.fields ? store.fields.items : store.model.prototype.fields.items
            });

            return {
                data: formatter.format(store, config),
                mimeType: formatter.mimeType,
                charset: formatter.charset,
                ext: formatter.extension
            };
        },

        /**
         * Exports a tree, using formatter
         * @param {Ext.tree.Panel} store to export from
         * @param {String/App.ux.grid.exporter.Formatter} formatter
         * @param {Object} config Optional config settings for the formatter
         */
        exportTree: function(tree, formatter, config) {

            config = config || {};
            formatter = this.getFormatterByName(formatter);
            var store = tree.getStore() || config.store;

            Ext.applyIf(config, {
                title: tree.title
            });

            return {
                data: formatter.format(store, config),
                mimeType: formatter.mimeType,
                charset: formatter.charset,
                ext: formatter.extension
            };
        },

        /**
         * Method returns the instance of {App.ux.grid.exporter.Formatter} based on format
         * @param {String/App.ux.grid.exporter.Formatter} formatter
         * @return {App.ux.grid.exporter.Formatter}
         */
        getFormatterByName: function(formatter) {
            formatter = formatter ? formatter : "excel";
            formatter = !Ext.isString(formatter) ? formatter : Ext.create("App.ux.grid.exporter." + formatter + "Formatter." + Ext.String.capitalize(formatter) + "Formatter");
            return formatter;
        },

        getFeature: function(grid, featureFType){
            var view = grid.getView();

            var features;
            if(view.features)
                features = view.features;
            else if(view.featuresMC)
                features = view.featuresMC.items;
            else if(view.normalView.featuresMC)
                features = view.normalView.featuresMC.items;

            if(features)
                for(var i = 0; i < features.length; i++){
                    if(featureFType == 'grouping')
                        if(features[i].ftype == 'grouping' || features[i].ftype == 'groupingsummary')
                            return features[i];
                    if(featureFType == 'groupingsummary')
                        if(features[i].ftype == 'groupingsummary')
                            return features[i];
                    if(featureFType == 'summary')
                        if(features[i].ftype == 'summary')
                            return features[i];
                }
            return undefined;
        },
    }
});
Ext.define('App.model.administration.AclGroupPerm', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'title',
			type: 'string'
		},
		{
			name: 'group_id',
			type: 'int'
		},
		{
			name: 'category',
			type: 'string'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'ACL.getGroupPerms',
			create: 'ACL.updateGroupPerms',
			update: 'ACL.updateGroupPerms'
		},
		reader: {
			type: 'json',
			root: 'data'
		}
	}
});
Ext.define('App.view.patient.windows.ArchiveDocument', {
    extend: 'Ext.window.Window',
    xtype: 'patientarchivedocumentwindow',
    draggable: false,
    modal: true,
    autoShow: true,
    closeAction: 'hide',
    title: _('archive_document'),
    items: [
        {
            xtype: 'form',
            bodyPadding: 10,
            width: 400,
            defaults: {
                xtype: 'textfield',
                anchor: '100%',
                labelWidth: 70
            },
            items: [
                {
                    name: 'id',
                    hidden: true
                },
                {
                    xtype: 'gaiaehr.combo',
                    fieldLabel: _('category'),
                    list: 102,
                    name: 'docTypeCode',
                    editable: false,
                    allowBlank: false
                },
                {
                    fieldLabel: _('title'),
                    name: 'title'
                },
                {
                    xtype: 'textareafield',
                    name: 'note',
                    fieldLabel: _('notes')
                },
                {
                    xtype: 'fieldset',
                    itemId: 'ArchiveDocumentOptionalFieldSet',
                    title: 'Print (' + _('optional') + ')',
                    margin: '0 0 0 10',
                    // width: 220,
                    items: [
                        // {
                        //     xtype: 'printerscombo',
                        //     itemId: 'archiveDocumentPrintersCombo',
                        //     emptyText: _('select_print_optional'),
                        //     fieldLabel: 'Printer',
                        //     name: 'printer',
                        //     editable: false,
                        //     width: 300
                        // },
                        {
                            xtype: 'numberfield',
                            itemId: 'archiveDocumentNumberOfJobCopies',
                            name: 'number_of_copies',
                            fieldLabel:_('number_of_copies'),
                            value: 1,
                            maxValue: 10,
                            minValue: 1,
                            hideLabel: false,
                            allowBlank: false,
                            width: 300
                        },
                        {
                            xtype: 'combobox',
                            fieldLabel: _('priority'),
                            name: 'priority',
                            store: Ext.create('Ext.data.Store', {
                                fields: ['value', 'display'],
                                data : [
                                    {"value": 1, "display":"High"},
                                    {"value": 2, "display":"Med"},
                                    {"value": 3, "display":"Low"},
                                ]
                            }),
                            value: 2,
                            displayField: 'display',
                            valueField: 'value',
                            editable: false,
                            width: 300
                        },
                        // {
                        //     xtype: 'checkbox',
                        //     name: 'printNow',
                        //     fieldLabel: 'Print Now',
                        // },
                    ]
                },
            ]
        }
    ],
    buttons: [
        {
            text: _('cancel'),
            handler: function (btn) {
                btn.up('window').close();
            }
        },
        {
            text: _('archive'),
            itemId: 'archiveBtn'
        }
    ]
});
Ext.define('App.view.notifications.Grid', {
	extend: 'Ext.grid.Panel',
	xtype: 'notificationsgrid',
	width: 400,
	header: false,
	hideHeaders: true,
	columns: [
		{
			text: _('description'),
			dataIndex: 'description',
			flex: 1
		}
	]

});
Ext.define("App.ux.grid.Printer", {

	requires: 'Ext.XTemplate',

	statics: {
		/**
		 * Prints the passed grid. Reflects on the grid's column model to build a table, and fills it using the store
		 * @param {Ext.grid.Panel} grid The grid to print
		 */
		print: function(grid, featureId){

			//featureId is no longer needed and is ignored

			// We generate an XTemplate here by using 2 intermediary
			// XTemplates - one to create the header, the other
			// to create the body (see the escaped {} below)
			var isGrouped = grid.store.isGrouped ? grid.store.isGrouped() : false;
			var groupField;
			if(isGrouped){
				//var feature = this.getFeature( grid, featureId );
				var feature = this.getFeature(grid, 'grouping');
				if(feature)
					groupField = feature.getGroupField();
				else
					isGrouped = false;  // isGrouped turned off if grouping feature not defined
			}

			var columns

			if(grid.columnManager){
				// use the column manager to get the columns.
				//var columns = grid.columnManager.getColumns(); // Not supported in ExtJS-4.1.x
				columns = grid.view.headerCt.getVisibleGridColumns();

			}else{
				//account for grouped columns
				columns = [];
				Ext.each(grid.columns, function(c){
					if(c.items && c.items.length > 0){
						columns = columns.concat(c.items.items);
					}else{
						columns.push(c);
					}
				});
			}

			//build a usable array of store data for the XTemplate
			var data = [];
			//          //This code is no longer needed
			//            grid.store.data.each(function(item, row) {
			//                var convertedData = {};
			//
			//                //apply renderers from column model
			//                for (var key in item.data) {
			//                    var value = item.data[key];
			//                    var found = false;
			//
			//                    Ext.each(columns, function(column, col) {
			//
			//                        if (column && column.dataIndex == key) {
			//                            var meta = { 'align'            : column.align,
			//                            			 'cellIndex'        : col,
			//                            			 'classes'          : [],
			//                            			 'column'           : column,
			//                            			 'innerCls'         : '',
			//                            			 'record'           : item,
			//                            			 'recordIndex'      : grid.store.indexOf(item),
			//                            			 'style'            : '',
			//                            			 'tdAttr'           : '',
			//                            			 'tdCls'            : '',
			//                            			 'unselectableAttr' : 'unselectable="on"',
			//                            			 'value'            : value
			//                                       };
			//                            value = column.renderer ? column.renderer.call(grid, value, meta, item, row, col, grid.store, grid.view) : value;
			//                            var varName = Ext.String.createVarName(column.dataIndex);
			//                            convertedData[varName] = value;
			//                            found = true;
			//
			//                        } else if (column && column.xtype === 'rownumberer'){
			//
			//                            var varName = Ext.String.createVarName(column.id);
			//                            convertedData[varName] = (row + 1);
			//                            found = true;
			//
			//                        } else if (column && column.xtype === 'templatecolumn'){
			//
			//                            value = column.tpl ? column.tpl.apply(item.data) : value;
			//
			//                            var varName = Ext.String.createVarName(column.id);
			//                            convertedData[varName] = value;
			//                            found = true;
			//
			//                        }
			//                    }, this);
			//
			//                    if (!found) { // model field not used on Grid Column, can be used on RowExpander
			//                        var varName = Ext.String.createVarName(key);
			//                        convertedData[varName] = value;
			//                    }
			//                }
			//
			//                data.push(convertedData);
			//            });

			// remove columns that do not contain dataIndex
			// or dataIndex is empty.
			// for example: columns filter or columns button
			var clearColumns = [];
			Ext.each(
				columns,
				function(column){
					if(column){
						if(!Ext.isEmpty(column.dataIndex) && !column.hidden && !isGrouped){
							clearColumns.push(column);
						}else if(column.xtype === 'rownumberer'){
							if(!column.text) column.text = 'Row';
							clearColumns.push(column);
						}else if(column.xtype === 'templatecolumn'){
							clearColumns.push(column);
						}else if(isGrouped &&
							column.dataIndex !== groupField &&
							column.xtype !== 'actioncolumn'){
							clearColumns.push(column);
						}
					}
				}
			);
			columns = clearColumns;

			//get Styles file relative location, if not supplied
			if(this.stylesheetPath === null){
				var scriptPath = Ext.Loader.getPath('App.ux.grid.Printer');
				this.stylesheetPath = scriptPath.substring(0, scriptPath.indexOf('Printer.js')) + 'gridPrinterCss/print.css';
			}

			//use the headerTpl and bodyTpl markups to create the main XTemplate below
			var headings = Ext.create('Ext.XTemplate', this.headerTpl).apply(columns);
			var body = this.generateBody(grid, columns, feature);
			var expanderTemplate,
				pluginsBodyMarkup = [];

			//add relevant plugins
			Ext.each(grid.plugins, function(p){
				if(p.ptype == 'rowexpander'){
					expanderTemplate = p.rowBodyTpl;
				}
			});

			if(expanderTemplate){
				pluginsBodyMarkup = [
					'<tr class="{[xindex % 2 === 0 ? "even" : "odd"]}"><td colspan="' + columns.length + '">',
					'{[ this.applyTpl(values) ]}',
					'</td></tr>'
				];
			}

			var title = (grid.title) ? grid.title : this.pageTitle;
			var summaryFeature = this.getFeature(grid, 'summary');

			//Here because inline styles using CSS, the browser did not show the correct formatting of the data the first time that loaded
			var htmlMarkup = [
				'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',
				'<html class="' + Ext.baseCSSPrefix + 'ux-grid-printer">',
				'<head>',
				'<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />',
				'<link href="' + this.stylesheetPath + '" rel="stylesheet" type="text/css" />',
				'<title>' + title + '</title>',
				'<script type="text/javascript">',
				'function printOnload() {["{"]}',
				'if (' + this.printAutomatically + ') {["{"]}',
				'window.print();',
				'if (' + this.closeAutomaticallyAfterPrint + ') {["{"]}',
				'window.close();',
				'{["}"]}',
				'{["}"]}',
				'{["}"]}',
				'</script>',
				'</head>',
				'<body class="' + Ext.baseCSSPrefix + 'ux-grid-printer-body" onload="printOnload();">',
				'<div class="' + Ext.baseCSSPrefix + 'ux-grid-printer-noprint ' + Ext.baseCSSPrefix + 'ux-grid-printer-links">',
				'<a class="' + Ext.baseCSSPrefix + 'ux-grid-printer-linkprint" href="javascript:void(0);" onclick="window.print();">' + this.printLinkText + '</a>',
				'<a class="' + Ext.baseCSSPrefix + 'ux-grid-printer-linkclose" href="javascript:void(0);" onclick="window.close();">' + this.closeLinkText + '</a>',
				'</div>',
				'<img src="'+ this.mainLogo +'" style="height: 75px; padding-bottom: 10px;">',
				'<h1 style="padding-bottom: 5px;">' + this.mainTitle + '</h1>',
				'<div cllass="rep-filters-class">' + this.filtersHtml + '</div>',
				'<table>',
				'<tr>',
				headings,
				'</tr>',
				'<tpl for=".">',
				'<tr class="{[xindex % 2 === 0 ? "even" : "odd"]}">',
				body,
				'</tr>',
				pluginsBodyMarkup.join(''),
				'{% if (this.isGrouped && xindex > 0) break; %}',
				'</tpl>',
				'<tpl if="this.hasSummary">',
				'<tr>',
				'<tpl for="this.columns">',
				'{[ this.renderSummary(values, xindex) ]}',
				'</tpl>',
				'</tr>',
				'</tpl>',
				'</table>',
				'</body>',
				'</html>',
				{
					isGrouped: isGrouped,
					grid: grid,
					columns: columns,
					hasSummary: Ext.isObject(summaryFeature),
					summaryFeature: summaryFeature,
					expanderTemplate: expanderTemplate,
					renderColumn: function(column, value, rcd, col){
						var meta = {
							'align': column.align,
							'cellIndex': col,
							'classes': [],
							'column': column,
							'css': '',
							'innerCls': '',
							'record': rcd,
							'recordIndex': grid.store.indexOf ? grid.store.indexOf(rcd) : undefined,
							'style': '',
							'tdAttr': '',
							'tdCls': '',
							'unselectableAttr': 'unselectable="on"',
							'value': value
						};
						if(column.xtype == 'templatecolumn'){
							value = column.tpl ? column.tpl.apply(rcd.data) : value;
						}
						else if(column.renderer){
							if(column instanceof Ext.tree.Column){
								value = column.renderer.call(column, value, meta, rcd, -1, col - 1, this.grid.store, this.grid.view);
							}else{
								value = column.renderer.call(this.grid, value, meta, rcd, -1, col - 1, this.grid.store, this.grid.view);
							}
						}

						return this.getHtml(value, meta);
					},
					applyTpl: function(rcd){
						var html = this.expanderTemplate.apply(rcd.data);

						return html;
					},
					renderSummary: function(column, colIndex){
						var value;
						if(this.summaryFeature.remoteRoot){
							var summaryRecord = this.summaryFeature.summaryRecord || (new this.grid.view.store.model(null, this.grid.view.id + '-summary-record'));
							if(this.grid.view.store.proxy.reader.rawData){
								if(Ext.isArray(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]))
									summaryRecord.set(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot][0]);
								else
									summaryRecord.set(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]);
							}
							value = summaryRecord.get(column.dataIndex);
						}
						else{
							value = this.getSummary(this.grid.store, column.summaryType, column.dataIndex, false);
						}

						if(column.summaryRenderer){
							var summaryObject;
							if(Ext.getVersion().isLessThan('4.2.0')){
								summaryObject = this.getSummaryObject(column.align);
								value = column.summaryRenderer.call(column, value, summaryObject, column.dataIndex);
								return this.getHtml(value, summaryObject);
							}
							else{
								var summaryRcd = this.getSummaryRecord42();
								summaryObject = this.getSummaryObject42(value, column, colIndex, summaryRcd);
								value = column.summaryRenderer.call(this.grid,
									value,
									summaryObject,
									summaryRcd,
									-1,
									colIndex,
									this.grid.store,
									this.grid.view);

								return this.getHtml(value, summaryObject);
							}
						}
						else{
							var meta = this.getSummaryObject42(column, colIndex);
							if(value === undefined || value == 0){
								return this.getHtml("&nbsp;", meta);
							}else{
								return this.getHtml(value, meta);
							}
						}
					},
					getSummaryObject: function(align){
						var summaryValues = {};
						for(var i = 0; i < columns.length; i++){
							var valueObject = this.getSummary(this.grid.store, this.columns[i].summaryType, this.columns[i].dataIndex, false);
							if(valueObject === undefined){
								// Do nothing
							}else{
								summaryValues[columns[i].id] = valueObject;
							}
						}
						summaryValues['style'] = "text-align:" + align + ';';
						return summaryValues;
					},
					getSummaryRecord42: function(){
						if(this.summaryFeature.remoteRoot){
							var summaryRecord = this.summaryFeature.summaryRecord || (new this.grid.view.store.model(null, this.grid.view.id + '-summary-record'));
							if(this.grid.view.store.proxy.reader.rawData){
								if(Ext.isArray(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]))
									summaryRecord.set(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot][0]);
								else
									summaryRecord.set(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]);
							}
							return summaryRecord;
						}

						var rcd = Ext.create(this.grid.store.model);
						for(var i = 0; i < this.columns.length; i++){
							var valueObject = this.getSummary(this.grid.store, this.columns[i].summaryType, this.columns[i].dataIndex, false);
							if(valueObject === undefined){
								// Do nothing
							}else{
								rcd.set(this.columns[i].dataIndex, valueObject);
							}
						}
						return rcd;
					},
					getSummaryObject42: function(value, column, colIndex, rcd){
						return {
							align: column.align,
							cellIndex: colIndex,
							'column': column,
							classes: [],
							css: '',
							innerCls: '',
							record: rcd,
							recordIndex: -1,
							style: '',
							tdAttr: '',
							tdCls: '',
							unselectableAttr: 'unselectable="on"',
							'value': value
						};
					},
					// Use the getSummary from Ext 4.1.3.  This function for 4.2.1 has been changed without updating the documentation
					// In 4.2.1, group is a group object from the store (specifically grid.store.groups[i].items).
					/**
					 * Get the summary data for a field.
					 * @private
					 * @param {Ext.data.Store} store The store to get the data from
					 * @param {String/Function} type The type of aggregation. If a function is specified it will
					 * be passed to the stores aggregate function.
					 * @param {String} field The field to aggregate on
					 * @param {Boolean} group True to aggregate in grouped mode
					 * @return {Number/String/Object} See the return type for the store functions.
					 */
					getSummary: function(store, type, field, group){
						if(type){
							if(Ext.isFunction(type)){
								return store.aggregate(type, null, group, [field]);
							}

							switch(type){
								case 'count':
									return store.count(group);
								case 'min':
									return store.min(field, group);
								case 'max':
									return store.max(field, group);
								case 'sum':
									return store.sum(field, group);
								case 'average':
									return store.average(field, group);
								default:
									return group ? {} : '';
							}
						}
					},
					getHtml: function(value, meta){
						if(value == undefined)
							value = '&nbsp;';

						var html = '<td ';
						var tdClasses = '';
						if(meta.tdCls)
							tdClasses = meta.tdCls;
						if(meta.css)
							if(tdClasses.length > 0)
								tdClasses += " " + meta.css;
							else
								tdClasses = meta.css;
						if(tdClasses.length > 0)
							html += 'class="' + tdClasses + '"';
						if(meta.tdAttr)
							html += ' ' + meta.tdAttr;
						html += '><div ';
						if(meta.innerCls)
							html += 'class="' + meta.innerCls + '"';
						html += ' style="text-align: ' + meta.align + ';';
						if(meta.style)
							html += meta.style;
						html += '" ';
						if(meta.unselectableAttr)
							html += meta.unselectableAttr;
						html += '>' + value + '</div></td>';

						return html;
					}
				}
			];

			//            var html = Ext.create('Ext.XTemplate', htmlMarkup).apply(data);
			var records;
			if(grid.store instanceof Ext.data.TreeStore){
				records = [];
				grid.store.getRootNode().cascadeBy(function(node){
					if(node.isRoot() && !grid.rootVisible) return;
					if(!node.isVisible()) return;
					records.push(node);
				}, this);
			}else{
				records = grid.store.getRange();
			}
			var html = Ext.create('Ext.XTemplate', htmlMarkup).apply(records);

			//open up a new printing window, write to it, print it and close
			var win = window.open('', 'printgrid');

			//document must be open and closed
			win.document.open();
			win.document.write(html);
			win.document.close();

			// Not needed.  Auto-printing handled in htmlMarkup XTemplate.
			//            if (this.printAutomatically){
			//                win.print();
			//            }
			//
			//            //Another way to set the closing of the main
			//            if (this.closeAutomaticallyAfterPrint){
			//                if(Ext.isIE){
			//                    window.close();
			//                } else {
			//                    win.close();
			//                }
			//            }
		},

		//        getFeature : function( grid, featureId ) {
		//            var feature;
		//            var view     = grid.getView();
		//            if ( featureId ) {
		//                feature = view.getFeature( featureId );
		//            }
		//            else {
		//                var features = view.features;
		//                if ( features.length > 1 ) {
		//                    alert( "More than one feature requires to pass " +
		//                           "featureId as parameter to 'print'." );
		//                    return;
		//                }
		//                else {
		//                    feature = features[0];
		//                }
		//            }
		//            return feature;
		//        },

		getFeature: function(grid, featureFType){
			var view = grid.getView();

			var features;
			if(view.features)
				features = view.features;
			else if(view.featuresMC)
				features = view.featuresMC.items;
			else if(view.normalView.featuresMC)
				features = view.normalView.featuresMC.items;

			if(features)
				for(var i = 0; i < features.length; i++){
					if(featureFType == 'grouping')
						if(features[i].ftype == 'grouping' || features[i].ftype == 'groupingsummary')
							return features[i];
					if(featureFType == 'groupingsummary')
						if(features[i].ftype == 'groupingsummary')
							return features[i];
					if(featureFType == 'summary')
						if(features[i].ftype == 'summary')
							return features[i];
				}
			return undefined;
		},

		generateBody: function(grid, columns, feature){
			var groups = [];
			var fields = grid.store.getProxy().getModel().getFields();
			var hideGroupField = true;
			var groupField;
			var body;
			var groupingSummaryFeature = this.getFeature(grid, 'groupingsummary');

			if(grid instanceof Ext.grid.Panel){
				groups = grid.store.getGroups();
			}

			//if (groups.length && grid.store.isGrouped() && feature )
			if(grid.store.isGrouped() && groups && groups.length && feature){
				hideGroupField = feature.hideGroupedHeader;  // bool
				groupField = feature.getGroupField();

				var groupColumn;
				Ext.each(grid.columns, function(col){
					if(col.dataIndex == groupField)
						groupColumn = col;
				});

				if(!feature || !fields || !groupField){
					return;
				}

				if(hideGroupField){
					var removeGroupField = function(item){
						return ( item.name != groupField );
					};
					// Remove group field from fields array.
					// This could be done later in the template,
					// but it is easier to do it here.
					fields = fields.filter(removeGroupField);
				}

				// Use group header template for the header.
				var html = feature.groupHeaderTpl.html || '';

				// #$%! ExtJS 5.x changed the output of getGroups().  It is now an Ext.util.GroupCollection object.
				// We need to transform it back into the 4.x structure which our template expects.
				if(Ext.getVersion().isGreaterThanOrEqual('5.0.0')){
					var newGroups = [];
					for(var i = 0; i < groups.getCount(); i++){
						var groupObj = groups.getAt(i);
						newGroups.push({
							name: groupObj.getGroupKey(),
							children: groupObj.getRange()
						});
					}
					groups = newGroups;
				}

				var bodyTpl = [
					'<tpl for=".">',
					'<tr class="group-header">',
					'<td colspan="{[this.colSpan]}">',
					'{[ this.applyGroupTpl(values) ]}',
					'</td>',
					'</tr>',
					'<tpl for="children">',
					'<tr class="{[xindex % 2 === 0 ? "even" : "odd"]}">',
					'<tpl for="this.columns">',
					'{[ this.renderColumn(values, parent.get(values.dataIndex), parent, xindex) ]}',
					'</tpl>',
					'</tr>',
					'</tpl>',
					'<tpl if="this.hasSummary">',
					'<tr>',
					'<tpl for="this.columns">',
					'{[ this.renderSummary(values, xindex) ]}',
					'</tpl>',
					'</tr>',
					'</tpl>',
					'</tpl>',
					{
						// XTemplate configuration:
						columns: columns,
						groupColumn: groupColumn,
						colSpan: columns.length,
						grid: grid,
						groupName: "",
						groupTpl: feature.groupHeaderTpl,
						hasSummary: Ext.isObject(groupingSummaryFeature) && groupingSummaryFeature.showSummaryRow,
						summaryFeature: groupingSummaryFeature,
						// XTemplate member functions:
						childCount: function(c){
							return c.length;
						},
						renderColumn: function(column, value, rcd, col){
							var meta = {
								'align': column.align,
								'cellIndex': col,
								'classes': [],
								'column': column,
								'css': '',
								'innerCls': '',
								'record': rcd,
								'recordIndex': grid.store.indexOf(rcd),
								'style': '',
								'tdAttr': '',
								'tdCls': '',
								'unselectableAttr': 'unselectable="on"',
								'value': value
							};
							if(column.renderer)
								value = column.renderer.call(this.grid, value, meta, rcd, -1, col - 1, this.grid.store, this.grid.view);

							return this.getHtml(value, meta);
						},
						getHtml: function(value, meta){
							if(value == undefined)
								value = '&nbsp;';

							var html = '<td ';
							var tdClasses = '';
							if(meta.tdCls)
							//html += 'class="' + meta.tdCls + '"';
								tdClasses = meta.tdCls;
							if(meta.css)
								if(tdClasses.length > 0)
									tdClasses += " " + meta.css;
								else
									tdClasses = meta.css;
							if(tdClasses.length > 0)
								html += 'class="' + tdClasses + '"';
							if(meta.tdAttr)
								html += ' ' + meta.tdAttr;
							html += '><div ';
							if(meta.innerCls)
								html += 'class="' + meta.innerCls + '"';
							html += ' style="text-align: ' + meta.align + ';';
							if(meta.style)
								html += meta.style;
							html += '" ';
							if(meta.unselectableAttr)
								html += meta.unselectableAttr;
							html += '>' + value + '</div></td>';

							return html;
						},
						renderSummary: function(column, colIndex){
							var value;
							var summaryObject;
							if(this.summaryFeature.remoteRoot){
								var summaryRecord = this.summaryFeature.summaryRecord || (new this.grid.view.store.model(null, this.grid.view.id + '-summary-record'));
								if(this.grid.view.store.proxy.reader.rawData){
									if(Ext.isArray(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]))
										summaryRecord.set(this.getSummaryRcd(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot], this.grid.store.groupField, this.groupName));
									else
										summaryRecord.set(this.grid.view.store.proxy.reader.rawData[this.summaryFeature.remoteRoot]);
								}
								value = summaryRecord.get(column.dataIndex);
							}
							else{
								value = this.getSummary(this.grid.store, column.summaryType, column.dataIndex, this.grid.store.isGrouped());
							}

							if(Ext.isObject(value))
								value = value[this.groupName];

							if(column.summaryRenderer)
								if(Ext.getVersion().isLessThan('4.2.0')){
									value = column.summaryRenderer.call(column, value, this.getSummaryObject(column.align), column.dataIndex);
								}
								else{
									summaryObject = this.getSummaryObject42(column, colIndex);
									value = column.summaryRenderer.call(this.grid,
										value,
										this.getSummaryObject42(column, colIndex),
										this.getSummaryRecord42(),
										-1,
										colIndex,
										this.grid.store,
										this.grid.view);

									return this.getHtml(value, summaryObject);
								}
							else if(value == undefined || value == 0)
								value = '&nbsp;';

							return '<td><div>' + value + '</div></td>';
						},
						applyGroupTpl: function(rcd){
							// The only members in rcd are name and children
							this.groupName = rcd.name;
							rcd.groupField = this.grid.store.groupField;

							var meta = {
								'align': '',
								'cellIndex': -1,
								'classes': [],
								'column': this.groupColumn,
								'css': '',
								'innerCls': '',
								'record': rcd.children[0],
								'recordIndex': this.grid.store.indexOf(rcd.children[0]),
								'style': '',
								'tdAttr': '',
								'tdCls': '',
								'unselectableAttr': 'unselectable="on"',
								'value': rcd.name
							};

							if(this.groupColumn)
								rcd.columnName = this.groupColumn.text;
							else
								rcd.columnName = this.groupField;

							rcd.groupValue = rcd.name;

							if(this.groupColumn && this.groupColumn.renderer){
								rcd.renderedGroupValue = this.groupColumn.renderer.call(this.grid, rcd.name, meta, rcd.children[0], -1, -1, this.grid.store, this.grid.view);
							}
							else
								rcd.renderedGroupValue = rcd.name;
							//rcd.rows = null;  // We don't support rcd.rows yet
							return this.groupTpl.apply(rcd);
						},
						getSummaryObject: function(align){
							var summaryValues = {};
							for(var i = 0; i < this.columns.length; i++){
								var valueObject = this.getSummary(this.grid.store, this.columns[i].summaryType, this.columns[i].dataIndex, this.grid.store.isGrouped());
								if(valueObject === undefined){
									// Do nothing
								}else if(Ext.isObject(valueObject)){
									summaryValues[columns[i].id] = valueObject[this.groupName];
								}else{
									summaryValues[columns[i].id] = valueObject;
								}

							}
							summaryValues['style'] = "text-align:" + align + ';';
							return summaryValues;
						},
						getSummaryRecord42: function(){
							var rcd = Ext.create(this.grid.store.model);
							for(var i = 0; i < this.columns.length; i++){
								var valueObject = this.getSummary(this.grid.store, this.columns[i].summaryType, this.columns[i].dataIndex, this.grid.store.isGrouped());
								if(valueObject === undefined){
									// Do nothing
								}else if(Ext.isObject(valueObject)){
									rcd.set(this.columns[i].dataIndex, valueObject[this.groupName]);
								}else{
									rcd.set(this.columns[i].dataIndex, valueObject);
								}
							}
							return rcd;
						},
						getSummaryObject42: function(column, colIndex){
							return {
								align: column.align,
								cellIndex: colIndex,
								classes: [],
								css: '',
								innerCls: '',
								record: this.getSummaryRecord42(),
								recordIndex: -1,
								style: '',
								tdAttr: '',
								tdCls: '',
								unselectableAttr: 'unselectable="on"',
								value: '&#160;'
							};
						},
						// Use the getSummary from Ext 4.1.3.  This function for 4.2.1 has been changed without updating the documentation
						// In 4.2.1, group is a group object from the store (specifically grid.store.groups[i].items).
						/**
						 * Get the summary data for a field.
						 * @private
						 * @param {Ext.data.Store} store The store to get the data from
						 * @param {String/Function} type The type of aggregation. If a function is specified it will
						 * be passed to the stores aggregate function.
						 * @param {String} field The field to aggregate on
						 * @param {Boolean} group True to aggregate in grouped mode
						 * @return {Number/String/Object} See the return type for the store functions.
						 */
						getSummary: function(store, type, field, group){
							if(type){
								if(Ext.isFunction(type)){
									return store.aggregate(type, null, group, [field]);
								}

								switch(type){
									case 'count':
										return store.count(group);
									case 'min':
										return store.min(field, group);
									case 'max':
										return store.max(field, group);
									case 'sum':
										return store.sum(field, group);
									case 'average':
										return store.average(field, group);
									default:
										return group ? {} : '';

								}
							}
						},

						// return the record having fieldName == value
						getSummaryRcd: function(rawDataObject, fieldName, value){
							if(Ext.isArray(rawDataObject)){
								for(var i = 0; i < rawDataObject.length; i++){
									if(rawDataObject[i][fieldName] && rawDataObject[i][fieldName] == value)
										return rawDataObject[i];
								}
								return undefined;
							}
							else if(rawDataObject.data[fieldName])
								return rawDataObject;
							else
								return undefined;
						}
					}
				];

				body = Ext.create('Ext.XTemplate', bodyTpl).apply(groups);
			}
			else{
				var bodyTpl = [
					'<tpl for="this.columns">',
					'{[ this.renderColumn(values, parent.get(values.dataIndex), parent, xindex) ]}',
					'</tpl>'
				];

				body = bodyTpl.join('');
			}

			return body;
		},

		/**
		 * It's like the slogan of a logo, this is custome made.
		 */
		filtersHtml: '',

		/**
		 * @property stylesheetPath
		 * @type String
		 * The path at which the print stylesheet can be found (defaults to 'ux/grid/gridPrinterCss/print.css')
		 */
		stylesheetPath: null,

		/**
		 * @property printAutomatically
		 * @type Boolean
		 * True to open the print dialog automatically and close the window after printing. False to simply open the print version
		 * of the grid (defaults to false)
		 */
		printAutomatically: false,

		/**
		 * @property closeAutomaticallyAfterPrint
		 * @type Boolean
		 * True to close the window automatically after printing.
		 * (defaults to false)
		 */
		closeAutomaticallyAfterPrint: false,

		/**
		 * @property pageTitle
		 * @type String
		 * Title to be used on top of the table
		 * (defaults to empty)
		 */
		pageTitle: 'Print View',

		/**
		 * @property mainTitle
		 * @type String
		 * Title to be used on top of the table
		 * (defaults to empty)
		 */
		mainTitle: '',

		/**
		 * @property mainTitle
		 * @type String
		 * (defaults to empty)
		 */
		mainLogo: 'sites/default/logo-email.png',

		/**
		 * Text show on print link
		 * @property printLinkText
		 * @type String
		 */
		printLinkText: 'Print',

		/**
		 * Text show on close link
		 * @property closeLinkText
		 * @type String
		 */
		closeLinkText: 'Close',

		/**
		 * @property headerTpl
		 * @type {Object/Array} values
		 * The markup used to create the headings row. By default this just uses <th> elements, override to provide your own
		 */
		headerTpl: [
			'<tpl for=".">',
			'<th style="text-align: {align}">{text}</th>',
			'</tpl>'
		],

		/**
		 * @property bodyTpl
		 * @type {Object/Array} values
		 * The XTemplate used to create each row. This is used inside the 'print' function to build another XTemplate, to which the data
		 * are then applied (see the escaped dataIndex attribute here - this ends up as "{dataIndex}")
		 */
		bodyTpl: [
			'<tpl for="columns">',
			'\{\[ this.renderColumn(values, parent.get(values.dataIndex), parent, xindex) \]\}',
			'</tpl>'
		]

	}
});

Ext.define('App.view.documents.windows.UploadAdministrativeDocument', {
	extend: 'Ext.window.Window',
	xtype: 'uploadadministrativedocumentwindow',
	draggable: false,
	modal: true,
	autoShow: true,
	title: _('new_document'),
	items: [
		{
			xtype: 'form',
			bodyPadding: 10,
			width: 400,
			defaults: {
				xtype: 'textfield',
				anchor: '100%',
				labelWidth: 70
			},
			items: [
				{
					fieldLabel: _('title'),
					name: 'title'
				},
				{
					xtype: 'gaiaehr.combo',
					listKey: 'doc_type_admin_cat',
					fieldLabel: _('type'),
					name: 'docTypeCode',
					allowBlank: false,
					itemId: 'adminDocTypeCatCombo'
				},
				{
					xtype: 'container',
					layout: 'hbox',
					items: [
						{
							xtype: 'fileuploadfield',
							labelWidth: 70,
							name: 'document',
							buttonText: _('select'),
							fieldLabel: _('file'),
							allowBlank: false,
							flex: 1,
							itemId: 'fileUploadField',
							margin: '0 5 0 0'
						},
						{
							xtype:'button',
							text: _('scan'),
							itemId: 'scanBtn',
							hidden: true
						}
					]
				},
				{
					xtype: 'textareafield',
					name: 'note',
					fieldLabel: _('notes')
				}
			]
		}
	],
	buttons: [
		{
			text: _('cancel'),
			handler: function(btn){
				btn.up('window').close();
			}
		},
		{
			text: _('upload'),
			itemId: 'uploadBtn'
		}
	]
});
Ext.define('App.model.administration.ReviewOfSystemSettings', {
	extend: 'Ext.data.Model',
	table: {
		name: 'review_of_system_settings'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'user_id',
			type: 'int',
			index: true
		},
		{
			name: 'settings_data',
			type: 'array'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Encounter.getReviewOfSystemSettingsByUserId',
			create: 'Encounter.saveReviewOfSystemSettings',
			update: 'Encounter.saveReviewOfSystemSettings'
		},
		remoteGroup: false
	}
});

Ext.define('App.ux.LiveSnomedProblemSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.snomedliveproblemsearch',
	hideLabel: true,
	displayField: 'Term',
	valueField: 'ConceptId',
	emptyText: _('problem_search') + '...',
	typeAhead: false,
	hideTrigger: true,
	minChars: 3,
	initComponent: function(){
		var me = this;

		Ext.define('liveSnomedProblemSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'ConceptId',
					type: 'string'
				},
				{
					name: 'Term',
					type: 'string'
				},
				{
					name: 'CodeType',
					type: 'string',
					defaultValue: 'SNOMEDCT'
				},
				{
					name: 'OCCURRENCE',
					type: 'int'
				}
			],
			idProperty: 'ConceptId',
			proxy: {
				type: 'direct',
				api: {
					read: 'SnomedCodes.liveProblemCodeSearch',
					update: 'SnomedCodes.updateLiveProblemCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveSnomedProblemSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{Term}<span style="font-weight: normal"> ({ConceptId}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', function(cmb, records){
			records[0].set({
				OCCURRENCE: records[0].data.OCCURRENCE + 1
			});
			records[0].save();
		});
	}
});

Ext.define('App.view.administration.HL7MessageViewer', {
	xtype: 'hl7messageviewer',
	extend: 'Ext.window.Window',
	title: _('hl7_viewer'),
	itemId: 'HL7MessageViewerWindow',
	width: 1200,
	maximizable: true,
	modal: true,
	layout: 'fit',
	items: [
		{
			xtype: 'form',
			itemId: 'HL7MessageViewerForm',
			bodyPadding: 10,
			border: false,
			fieldDefaults: {
				labelAlign: 'top',
				readOnly: true,
				anchor: '100%'
			},
			items: [
				{
					xtype: 'hiddenfield',
					name: 'id'
				},
				{
					xtype: 'hiddenfield',
					name: 'isOutbound'
				},
				{
					xtype: 'hiddenfield',
					name: 'reference'
				},
				{
					xtype: 'fieldcontainer',
					layout: 'hbox',
					items:[
						{
							fieldLabel: _('type'),
							xtype: 'textfield',
							name: 'msg_type',
							margin: '0 5 0 0',
							flex: 1
						},
						{
							fieldLabel: _('date'),
							xtype: 'textfield',
							name: 'date_processed',
							flex: 1
						}
					]
				},
				{
					xtype: 'fieldcontainer',
					layout: 'hbox',
					items:[
						{
							fieldLabel: _('facility'),
							xtype: 'textfield',
							name: 'foreign_facility',
							margin: '0 5 0 0',
							flex: 1
						},
						{
							fieldLabel: _('application'),
							xtype: 'textfield',
							name: 'foreign_application',
							flex: 1
						}
					]
				},
				{
					xtype: 'button',
					text: 'Edit Message',
					itemId: 'HL7MessageViewerMessageEditBtn',
					enableToggle: true
				},
				{
					xtype: 'textareafield',
					fieldLabel: 'Editable Message',
					name: 'raw_message',
					readOnly: false,
					height: 250,
					hidden: true,
					itemId: 'HL7MessageViewerRawMessageField',
				},
				{
					xtype: 'htmleditor',
					fieldLabel: _('message'),
					name: 'message',
					height: 250,
					enableAlignments: false,
					enableColors: false,
					enableFont: false,
					enableFontSize: false,
					enableFormat: false,
					enableLinks: false,
					enableLists: false,
					enableSourceEdit: false,
					itemId: 'HL7MessageViewerMessageField',
				},
				{
					xtype: 'htmleditor',
					fieldLabel: _('acknowledge'),
					name: 'response',
					readOnly: true,
					height: 100,
					enableAlignments: false,
					enableColors: false,
					enableFont: false,
					enableFontSize: false,
					enableFormat: false,
					enableLinks: false,
					enableLists: false,
					enableSourceEdit: false
				},
				{
					xtype: 'textareafield',
					fieldLabel: _('error'),
					name: 'error',
					readOnly: true,
					height: 60
				}
			]
		}
	],
	buttons: [
		{
			text: _('resend'),
			itemId: 'HL7MessageViewerWindowResendBtn'
		},
		{
			text: '<',
			itemId: 'HL7MessageViewerWindowPreviousBtn'
		},
		{
			text: '>',
			itemId: 'HL7MessageViewerWindowNextBtn'
		},
		{
			text: _('close'),
			itemId: 'HL7MessageViewerWindowCloseBtn'
		}
	]
}); 
Ext.define('App.view.patient.windows.UploadDocument', {
	extend: 'Ext.window.Window',
	xtype: 'patientuploaddocumentwindow',
	draggable: false,
	modal: true,
	autoShow: true,
	title: _('new_document'),
	items: [
		{
			xtype: 'form',
			bodyPadding: 10,
			width: 400,
			defaults: {
				xtype: 'textfield',
				anchor: '100%',
				labelWidth: 70
			},
			items: [
				{
					fieldLabel: _('title'),
					name: 'title'
				},
				{
					xtype: 'gaiaehr.combo',
					fieldLabel: _('type'),
					list: 102,
					name: 'docTypeCode',
					allowBlank: false
				},
				{
					xtype: 'container',
					layout: 'hbox',
					items: [
						{
							xtype: 'fileuploadfield',
							labelWidth: 70,
							name: 'document',
							buttonText: _('select'),
							fieldLabel: _('file'),
							allowBlank: false,
							flex: 1,
							itemId: 'fileUploadField',
							margin: '0 5 0 0'
						},
						{
							xtype:'button',
							text: _('scan'),
							itemId: 'scanBtn',
							hidden: true
						}
					]
				},
				{
					xtype: 'textareafield',
					name: 'note',
					fieldLabel: _('notes')
				}
			]
		}
	],
	buttons: [
		{
			text: _('cancel'),
			handler: function(btn){
				btn.up('window').close();
			}
		},
		{
			text: _('upload'),
			itemId: 'uploadBtn'
		}
	]
});
Ext.define('App.view.scanner.Window', {
	extend: 'Ext.window.Window',
	xtype: 'scannerwindow',
	itemId: 'ScannerWindow',
	width: 900,
	height: 500,
	closeAction: 'hide',
	title: _('scanner'),
	layout: 'border',
	modal: true,
	items: [
		{
			xtype: 'panel',
			region: 'west',
			width: 150,
			split: true,
			itemId: 'ScannerImageDataViewPanel',
			autoScroll: true,
			items: [
				{
					xtype: 'dataview',
					itemId: 'ScannerImageThumbsDataView',
					store: Ext.create('Ext.data.Store', {
						fields: [
							{
								name: 'id',
								type: 'string'
							},
							{
								name: 'src',
								type: 'string'
							},
							{
								name: 'archived',
								type: 'bool'
							},
							{
								name: 'style',
								type: 'string'
							}
						]
					}),
					tpl: new Ext.XTemplate(
						'<tpl for=".">' +
						'<div style="margin-bottom:10px;" class="thumb-wrap">' +
						'<img width="100%" src="{src}" style="padding:10px;{style}" />' +
						'</div>' +
						'</tpl>'
					),
					// selModel: {
					// 	mode: 'MULTI'
					// },
					trackOver: true,
					overItemCls: 'x-item-over',
					itemSelector: 'div.thumb-wrap',
					emptyText: 'No images to display',
				}
			],
			tbar: [
				{
					xtype: 'combobox',
					itemId: 'ScannerSourceCombo',
					editable: false,
					queryMode: 'local',
					displayField: 'name',
					valueField: 'id',
					flex: 1,
					margin: 1,
					store: Ext.create('Ext.data.Store', {
						fields: [
							{
								name: 'id',
								type: 'string'
							},
							{
								name: 'name',
								type: 'string'
							}
						]
					})
				}
			]
		},
		{
			xtype: 'panel',
			region: 'center',
			itemId: 'ScannerImageViewerPanel',
			layout: 'anchor',
			autoScroll: true,
			frame: true,
			items: [
				{
					xtype: 'image',
					anchor: '100%',
					style: 'background-color:white',
					itemId: 'ScannerImageViewer'
				}
			],
			tbar: [
				{
					text: _('scan'),
					itemId: 'ScannerImageScanBtn',
					scale: 'medium',
					width: 100
				},
				'-',
				'->',
				'-',
				{
					text: _('edit'),
					enableToggle: true,
					toggleGroup: 'ScannerImageEditGroup',
					itemId: 'ScannerImageEditBtn',
					scale: 'medium',
					width: 100
				}
				// {
				// 	text: _('archive'),
				// 	itemId: 'ScannerImageArchiveBtn',
				// 	scale: 'medium',
				// 	width: 150
				// }
			]
		}
	],
	buttons: [
		{
			text: _('close'),
			itemId: 'ScannerImageCloseBtn'
		}
	]
});
Ext.define('App.ux.LiveSnomedBodySiteSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'snomedlivebodysitesearch',
	hideLabel: true,
	displayField: 'Term',
	valueField: 'ConceptId',
	emptyText: _('body_site_search') + '...',
	typeAhead: false,
	hideTrigger: true,
	minChars: 3,
	initComponent: function(){
		var me = this;

		Ext.define('liveSnomedBodySiteSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'ConceptId',
					type: 'string'
				},
				{
					name: 'Term',
					type: 'string'
				},
				{
					name: 'CodeType',
					type: 'string',
					defaultValue: 'SNOMEDCT'
				},
				{
					name: 'OCCURRENCE',
					type: 'int'
				}
			],
			idProperty: 'ConceptId',
			proxy: {
				type: 'direct',
				api: {
					read: 'SnomedCodes.liveBodySiteCodeSearch',
					update: 'SnomedCodes.updateLiveBodySiteCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveSnomedBodySiteSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{Term}<span style="font-weight: normal"> ({ConceptId}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', function(cmb, records){
			records[0].set({
				OCCURRENCE: records[0].data.OCCURRENCE + 1
			});
			records[0].save();
		});
	}
});

Ext.define('App.ux.LiveImmunizationNdcSearch', {
	extend: 'Ext.form.ComboBox',
	xtype: 'immunizationndclivesearch',
	hideLabel: true,
	displayField: 'UseUnitPropName',
	valueField: 'NDC11',
	emptyText: _('immunization_search') + '...',
	typeAhead: true,
	minChars: 1,
	initComponent: function(){
		var me = this;

		Ext.define('liveImmunizationNdcSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'NDCInnerID', type: 'string'},
				{name: 'CVXCode', type: 'string'},
				{name: 'CVXShortDescription', type: 'string'},
				{name: 'UseUnitPropName', type: 'string'},
				{name: 'UseUnitGenericName', type: 'string'},
				{name: 'UseUnitLabelerName', type: 'string'},
				{name: 'NoInner', type: 'string'},
				{name: 'NDC11', type: 'string'},
				{name: 'status', type: 'string'},
				{name: 'update_date', type: 'date', dateFormat: 'Y-m-d H:i:s'}
			],
			idProperty: 'NDCInnerID',
			proxy: {
				type: 'direct',
				api: {
					read: 'Immunizations.getImmunizationNDCLiveSearch'
				},
				reader: {
					totalProperty: 'total',
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveImmunizationNdcSearchModel',
			pageSize: 10,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item">NDC - {NDC11}: <span style="font-weight: normal;" class="list-status-{status}">{UseUnitPropName} ({CVXShortDescription})</span></div>';
				}
			},
			pageSize: 10
		});

		me.callParent();
	}
});

Ext.define('App.view.patient.SmokingStatus', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'App.store.patient.SmokeStatus',
		'App.ux.combo.SmokingStatus',
		'App.ux.grid.DeleteColumn'
	],
	xtype: 'patientsmokingstatusgrid',
	itemId: 'PatientSmokingStatusGrid',
	columnLines: true,
	store: Ext.create('App.store.patient.SmokeStatus', {
		remoteFilter: true
	}),
	plugins: [
		{
			ptype: 'rowediting'
		}
	],
	columns: [
		{
			xtype: 'griddeletecolumn',
			acl: a('delete_smoking_status'),
			width: 25
		},
		{
			text: _('status'),
			dataIndex: 'status',
			width: 250,
			renderer: function(v, meta, record){
				return v + ' (' + record.data.status_code +')';
			}
		},
		{
			text: _('counseling_given'),
			dataIndex: 'counseling',
			width: 120,
			editor: {
				xtype: 'checkbox'
			},
			renderer: function(v){
				return app.boolRenderer(v);
			}
		},
		{
			text: _('cessation_counseling_type'),
			flex: 1,
			dataIndex: 'counseling_text',
			editor:{
				xtype:'gaiaehr.combo',
				listKey: 'tobacco_use_cessation_counseling',
				displayField: 'option_name',
				valueField: 'option_name',
				itemId: 'PatientSmokingStatusGridCounselingField',
				loadStore: true
			}
		},
		{
			text: _('note'),
			dataIndex: 'note',
			flex: 1,
			editor: {
				xtype: 'textfield'
			}
		},
		{
			xtype: 'datecolumn',
			format: 'Y-m-d',
			text: _('start_date'),
			dataIndex: 'start_date',
			width: 120,
			editor: {
				xtype: 'datefield',
				format: g('date_display_format'),
				submitFormat: 'Y-m-d'
			}
		},
		{
			xtype: 'datecolumn',
			format: 'Y-m-d',
			text: _('end_date'),
			dataIndex: 'end_date',
			width: 120,
			editor: {
				xtype: 'datefield',
				format: g('date_display_format'),
				submitFormat: 'Y-m-d'
			}
		}
	],
	tbar: [
		{
			xtype: 'tbtext',
			text: _('smoking_status'),
			width: 100
		},
		{
			xtype: 'mitos.smokingstatuscombo',
			itemId: 'socialsmokingstatuscombo',
			width: 250
		}
	]
});

Ext.define('App.ux.LiveSnomedSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.snomedlivesearch',
	hideLabel: true,
	displayField: 'Term',
	valueField: 'ConceptId',
	initComponent: function(){
		var me = this;

		Ext.define('liveSnomedSearchModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'ConceptId',
					type: 'string'
				},
				{
					name: 'Term',
					type: 'string'
				},
				{
					name: 'CodeType',
					type: 'string',
					defaultValue: 'SNOMED'
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'SnomedCodes.liveCodeSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'liveSnomedSearchModel',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			emptyText: _('search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 3,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{Term}<span style="font-weight: normal"> ({ConceptId}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();
	}
});

Ext.define('App.store.administration.MedicationInstructions', {
	extend: 'Ext.data.Store',
	model: 'App.model.administration.MedicationInstruction'
});
Ext.define('App.view.administration.practice.Facilities', {
	extend: 'Ext.grid.Panel',
	xtype: 'facilitiespanel',
	title: _('facilities'),

	requires: [
		'App.ux.combo.ServiceLocation',
		'App.ux.form.fields.InputTextMask'
	],


	initComponent: function(){
		var me = this;

		Ext.apply(me, {
			store: me.store = Ext.create('App.store.administration.Facility'),
			columns: [
				{
					text: _('id'),
					sortable: true,
					dataIndex: 'id'
				},
				{
					text: _('code'),
					sortable: true,
					dataIndex: 'code'
				},
				{
					text: _('name'),
					flex: 1,
					sortable: true,
					dataIndex: 'name'
				},
				{
					text: _('region'),
					width: 100,
					sortable: true,
					dataIndex: 'region'
				},
				{
					text: _('phone'),
					width: 100,
					sortable: true,
					dataIndex: 'phone'
				},
				{
					text: _('fax'),
					width: 100,
					sortable: true,
					dataIndex: 'fax'
				},
				{
					text: _('city'),
					width: 100,
					sortable: true,
					dataIndex: 'city'
				},
				{
					text: _('pos_code'),
					width: 100,
					sortable: true,
					dataIndex: 'pos_code'
				},
				{
					text: _('ein'),
					width: 100,
					sortable: true,
					dataIndex: 'ein'
				},
				{
					text: _('clia'),
					width: 100,
					sortable: true,
					dataIndex: 'clia'
				},
				{
					text: _('fda'),
					width: 100,
					sortable: true,
					dataIndex: 'fda'
				},
				{
					text: _('npi'),
					width: 100,
					sortable: true,
					dataIndex: 'npi'
				},
				{
					text: _('tin'),
					width: 100,
					sortable: true,
					dataIndex: 'ess'
				},

                {
                    text: _('active'),
                    sortable: true,
                    dataIndex: 'active',
                    renderer: function(v){
                        return app.boolRenderer(v);
                    },
                    editor: {
                        xtype: 'checkboxfield'
                    }
                }
			],
			plugins: Ext.create('App.ux.grid.RowFormEditing', {
				autoCancel: false,
				errorSummary: false,
				clicksToEdit: 1,
				items: [
					{
						xtype: 'container',
						layout: 'column',
						defaults: {
							xtype: 'container',
							padding: 5,
                            labelWidth: 100,
							layout: 'anchor',
							defaultType: 'textfield'
						},
						items: [
							{
								defaults: {
									anchor: '100%'
								},
                                columnWidth: 0.4,
								items: [
									{
                                        xtype: 'textfield',
										fieldLabel: _('name'),
										name: 'name',
										allowBlank: false
									},
									{
                                        xtype: 'textfield',
										fieldLabel: _('phone'),
										name: 'phone',
										plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')]
									},
									{
                                        xtype: 'textfield',
										fieldLabel: _('fax'),
										name: 'fax'
									},
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('address'),
                                        name: 'address'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('address'),
                                        name: 'address_cont'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('city'),
                                        name: 'city'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('state'),
                                        name: 'state'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('postal_code'),
                                        name: 'postal_code'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('country_code'),
                                        name: 'country_code'
                                    },
                                    {
                                        xtype: 'textfield',
                                        name: 'facility_entity',
                                        width: 100,
                                        fieldLabel: _('entity')
                                    },
                                    {
                                        xtype: 'gaiaehr.combo',
                                        fieldLabel: _('region'),
                                        editable: false,
                                        listKey: 'regions',
                                        name: 'region'
                                    }

								]
							},
                            {
                                defaults: {
                                    anchor: '100%'
                                },

                                columnWidth: 0.4,
                                items: [
                                    {
                                        xtype: 'fieldcontainer',
                                        layout: 'hbox',
                                        items: [
                                            {
                                                xtype: 'textfield',
                                                fieldLabel: _('contact') + ' ' + _('name'),
                                                flex: 2,
                                                name: 'lname',
                                                margin: '0 10 0 0'
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'fname',
                                                labelWidth: 30,
                                                fieldLabel: _('first'),
                                                flex: 1,
                                                margin: '0 10 0 0'
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'mname',
                                                flex: 1,
                                                labelWidth: 40,
                                                fieldLabel: _('middle'),
                                                width: 20
                                            }
                                        ]
                                    },

                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('ess'),
                                        name: 'ess'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('ein'),
                                        name: 'ein'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' + _('address'),
                                        name: 'postal_address'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' +  _('address'),
                                        name: 'postal_address_cont'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' +  _('city'),
                                        name: 'postal_city'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' +  _('state'),
                                        name: 'postal_state'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' + _('postal_code'),
                                        name: 'postal_zip_code'
                                    },
                                    {
                                        fieldLabel: 'PO' + ' ' + _('country_code'),
                                        name: 'postal_country_code'
                                    }
                                ]

                            },
							{
                                defaults: {
                                    anchor: '100%'
                                },
                                columnWidth: 0.2,
								items: [
									{
										fieldLabel: _('billing_attn'),
										name: 'attn',
										anchor: '100%'
									},
									{
										xtype: 'mitos.poscodescombo',
										fieldLabel: _('pos_code'),
										name: 'pos_code',
										anchor: '100%'
									},
									{
										xtype: 'servicelocationcombo',
										fieldLabel: _('service_location'),
										name: 'service_loc_code',
										anchor: '100%'
									},
									{
										fieldLabel: _('clia_number'),
										name: 'clia',
										anchor: '100%'
									},
									{
										fieldLabel: _('npi'),
										name: 'npi',
										anchor: '100%'
									},
									{
										fieldLabel: _('fda_number'),
										name: 'fda',
										anchor: '100%'
									},
									{
										xtype: 'checkbox',
										fieldLabel: _('active'),
										name: 'active'
									},
									{
										xtype: 'checkbox',
										fieldLabel: _('billing_location'),
										name: 'billing_location'
									},
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('external_id'),
                                        name: 'external_id'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('global_id'),
                                        name: 'global_id'
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: _('code'),
                                        name: 'code'
                                    }

                                    // {
                                    //     xtype: 'checkbox',
                                    //     fieldLabel: _('accepts_assignment'),
                                    //     labelWidth: 120,
                                    //     width: 140,
                                    //     name: 'accepts_assignment',
                                    //     margin: '10 10 0 0'
                                    // },



                                    // {
                                    //     xtype: 'fieldcontainer',
                                    //     layout: 'hbox',
                                    //     items: [
                                    //     ]
                                    // }


								]
							}
						]
					}
				]
			}),
			tbar: Ext.create('Ext.PagingToolbar', {
				pageSize: 30,
				store: me.store,
				displayInfo: true,
				plugins: Ext.create('Ext.ux.SlidingPager', {
				}),
				items: ['-', {
					text: _('add_new_facility'),
					iconCls: 'save',
					scope: me,
					handler: me.addFacility
				}, '-', {
					text: _('show_active_facilities'),
					action: 'active',
					scope: me,
					handler: me.filterFacilitiesby
				}, '-', {
					text: _('show_inactive_facilities'),
					action: 'inactive',
					scope: me,
					handler: me.filterFacilitiesby
				}]

			})
		});

		me.callParent(arguments);
	},

	filterFacilitiesby: function(btn){

//		this.setTitle(_('facilities') + ' (' + Ext.String.capitalize(btn.action) + ')');

		this.store.load({
			filters: [
				{
					property: 'active',
					value: btn.action == 'active' ? 1 : 0
				}
			]
		});
	},

	addFacility: function(){
		var me = this,
			grid = me,
			store = grid.store;

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			active: 1,
			service_location: 1,
			billing_location: 0,
			accepts_assignment: 0
		});
		grid.editingPlugin.startEdit(0, 0);
	}
});

Ext.define('App.view.administration.practice.ReferringProviders', {
    extend: 'Ext.grid.Panel',
    xtype: 'referringproviderspanel',
    requires: [
        'Ext.ux.SlidingPager',
	    'App.ux.grid.ColumnSearchField'
    ],
    title: _('referring_providers'),

    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.ReferringProviders', {
            autoSync: false,
            remoteSort: true,
            remoteFilter: true,
            sorters: [
                {
                    property: 'lname',
                    direction: 'ASC'
                }
            ]
        });

        Ext.apply(me, {
            columns: [
                {
                    width: 200,
                    text: _('name'),
                    sortable: true,
	                dataIndex: 'lname',
                    renderer:function(v, meta, record){
                        return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
                    },
	                items: [
		                {
			                xtype: 'columnsearchfield',
			                autoSearch: true,
			                operator: 'LIKE',
			                suffix: '%'
		                }
	                ]
                },
                {
                    width: 200,
                    text: _('email'),
                    sortable: true,
                    dataIndex: 'email',
                    items: [
                        {
                            xtype: 'columnsearchfield',
                            autoSearch: true,
                            operator: 'LIKE',
                            suffix: '%'
                        }
                    ]
                },
                {
                    width: 100,
                    text: _('npi'),
                    sortable: true,
                    dataIndex: 'npi',
                    items: [
                        {
                            xtype: 'columnsearchfield',
                            autoSearch: true,
                            operator: 'LIKE',
                            suffix: '%'
                        }
                    ]
                },
                {
                    flex: 1,
                    text: _('cell_number'),
                    sortable: true,
                    dataIndex: 'cel_number',
                    items: [
                        {
                            xtype: 'columnsearchfield',
                            autoSearch: true,
                            operator: 'LIKE',
                            suffix: '%'
                        }
                    ]
                },
                {
                    flex: 1,
                    text: _('fax_number'),
                    sortable: true,
                    dataIndex: 'fax_number',
                    items: [
                        {
                            xtype: 'columnsearchfield',
                            autoSearch: true,
                            operator: 'LIKE',
                            suffix: '%'
                        }
                    ]
                },
                {
                    flex: 1,
                    text: _('aditional_info'),
                    sortable: true,
                    dataIndex: 'notes'
                },
                {
                    flex: 1,
                    text: _('authy_id'),
                    sortable: true,
                    dataIndex: 'authy_id'
                },
                {
                    text: _('authorized'),
                    sortable: true,
                    dataIndex: 'authorized',
                    renderer: me.boolRenderer
                },
                {
                    text: _('active'),
                    sortable: true,
                    dataIndex: 'active',
                    renderer: me.boolRenderer
                }
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'top',
                    items: [
	                    {
		                    xtype: 'button',
		                    text: _('referring_provider'),
		                    iconCls: 'icoAdd',
		                    itemId: 'referringProviderAddBtn',
	                    },
                        '->',
	                    {
		                    xtype: 'button',
		                    text: _('authy_register'),
		                    itemId: 'ReferringProviderAuthyRegisterBtn'
	                    },
                        '-',
                        {
                            xtype: 'button',
                            text: _('referring_provider'),
                            iconCls: 'icoAdd',
                            itemId: 'referringProviderAddBtn',
                        }
                    ]
                },
                {
                    xtype: 'pagingtoolbar',
                    dock: 'bottom',
                    pageSize: 25,
                    store: me.store,
                    displayInfo: true,
                    plugins: Ext.create('Ext.ux.SlidingPager')
                }
            ]
        });

        me.callParent(arguments);

    }

});

Ext.define('App.view.administration.practice.Practice', {
	extend: 'App.ux.RenderPanel',
	xtype: 'practicepanel',
	pageTitle: _('practice_settings'),
	requires: [
		'App.view.administration.practice.Facilities',
		'App.view.administration.practice.FacilityConfig',
		'App.view.administration.practice.Laboratories',
		'App.view.administration.practice.Pharmacies',
		//'App.view.administration.practice.ProviderNumbers',
		'App.view.administration.practice.ReferringProviders',
		'App.view.administration.practice.DecisionAids'

    ],
	pageBody: [
		{
			xtype: 'tabpanel',
			activeTab: 0,
			items: [
				{
					xtype: 'pharmaciespanel'
				},
				{
					xtype: 'laboratoriespanel'
				},
				{
					xtype: 'insurancecompaniespanel'
				},
				// {
				// 	xtype: 'providersnumberspanel'
				// },
				{
					xtype: 'referringproviderspanel'
				},
//				{
//					xtype: 'specialtiespanel'
//				},
				{
					xtype: 'facilitiespanel'
				},
				{
					xtype: 'facilityconfigpanel'
				},
				{
					xtype: 'decisionaidspanel'
				}

			]
		}
	]
});

Ext.define('App.view.administration.Documents', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('document_template_editor'),
	pageLayout: 'border',
	requires: [
		'App.ux.grid.Button',
		'Ext.grid.Panel'
	],
	itemId: 'AdministrationDocuments',
	initComponent: function(){

		var me = this;

		// *************************************************************************************
		// Documents Stores
		// *************************************************************************************
		me.templatesDocumentsStore = Ext.create('App.store.administration.DocumentsTemplates');
		me.defaultsDocumentsStore = Ext.create('App.store.administration.DefaultDocuments');

		me.DocumentsDefaultsGrid = Ext.create('Ext.grid.Panel', {
			title: _('documents_defaults'),
			frame: true,
			store: me.defaultsDocumentsStore,
			hideHeaders: true,
			flex: 1,
			itemId: 'AdministrationDocumentsDefaultsGrid',
			columns: [
				{
					flex: 1,
					sortable: true,
					dataIndex: 'title',
					editor: {
						xtype: 'textfield',
						allowBlank: false
					}
				},
				{
					icon: 'resources/images/icons/delete.png',
					tooltip: _('remove'),
					scope: me,
					handler: me.onRemoveDocument
				}
			],
			listeners: {
				scope: me,
				itemclick: me.onDocumentsGridItemClick
			},
			tbar: ['->',
				{
					text: _('add'),
					scope: me,
					handler: me.newDefaultTemplates,
					itemId: 'AdministrationDocumentsNewDefaulTemplateBtn',
				}],
			plugins: [me.rowEditor3 = Ext.create('Ext.grid.plugin.RowEditing',
				{
					clicksToEdit: 2
				})]
		});

		me.DocumentsGrid = Ext.create('Ext.grid.Panel', {
			title: _('document_templates'),
			frame: true,
			store: me.templatesDocumentsStore,
			hideHeaders: true,
			flex: 1,
			itemId: 'AdministrationDocumentsTemplatesGrid',
			columns: [
				{
					flex: 1,
					sortable: true,
					dataIndex: 'title',
					editor: {
						xtype: 'textfield',
						allowBlank: false
					}
				},
				{
					icon: 'resources/images/icons/delete.png',
					tooltip: _('remove'),
					scope: me,
					handler: me.onRemoveDocument
				}
			],
			listeners: {
				scope: me,
				itemclick: me.onDocumentsGridItemClick
			},
			tbar: ['->',
				{
					text: _('add'),
					scope: me,
					itemId: 'AdministrationDocumentsNewTemplateBtn',
					//handler: me.newDocumentTemplate
				}],
			plugins: [me.rowEditor = Ext.create('Ext.grid.plugin.RowEditing',
				{
					clicksToEdit: 2
				})]
		});

		me.LeftCol = Ext.create('Ext.container.Container', {
			layout: {
				type: 'vbox',
				align: 'stretch'
			},
			region: 'west',
			width: 250,
			border: false,
			split: true,
			items: [
				me.DocumentsDefaultsGrid,
				me.DocumentsGrid,
				{
					xtype:'grid',
					title: _('pdf_templates'),
					itemId: 'AdministrationDocumentsPdfTemplatesGrid',
					store: Ext.create('App.store.administration.DocumentsPdfTemplates'),
					flex: 1,
					frame: true,
					hideHeaders: true,
					columns:[
						{
							flex: 1,
							dataIndex: 'template'
						}
					],
					tbar: [
						'->',
						{
							xtype:'button',
							text: _('add'),
							itemId: 'AdministrationDocumentsPdfTemplatesAddBtn'
						}
					]
				}
			]
		});

		me.TeamplateEditor = Ext.create('Ext.form.Panel', {
			title: _('document_editor'),
			region: 'center',
			layout: 'fit',
			autoScroll: false,
			border: true,
			split: true,
			hideHeaders: true,
			itemId: 'AdministrationDocumentsTemplatesEditorForm',
			items: {
				xtype: 'htmleditor',
				enableFontSize: false,
				name: 'body',
				margin: 5
			},
			buttons: [
				{
					text: _('save'),
					scope: me,
					handler: me.onSaveEditor
				},
				{
					text: _('cancel'),
					scope: me,
					handler: me.onCancelEditor
				}
			]
		});

		me.TokensGrid = Ext.create('Ext.grid.Panel', {
			title: _('available_tokens'),
			region: 'east',
			width: 250,
			border: true,
			split: true,
			hideHeaders: true,
			store: Ext.create('App.store.administration.DocumentToken'),
			disableSelection: true,
			itemId: 'AdministrationDocumentsTokensGrid',
			viewConfig: {
				stripeRows: false
			},
			plugins: [
				{
					ptype: 'cellediting'

				}
			],
			columns: [
				{
					flex: 1,
					sortable: false,
					dataIndex: 'token',
					editor: {
						xtype: 'textfield',
						editable: false,
						itemId: 'AdministrationDocumentsTokenTextField'
					}
				},
				{
					xtype: 'actioncolumn',
					width: 50,
					items: [
						{
							icon: 'resources/images/icons/copy.png',
							tooltip: _('copy'),
							margin: '0 5 0 0',
							handler: function(grid, rowIndex, colIndex, item, e, record){
								app.getController('administration.Documents').doCopy(grid, record);

							}
						}
					]
				}
			]
		});

		me.pageBody = [me.LeftCol, me.TeamplateEditor, me.TokensGrid];
		me.callParent();
	},
	/**
	 * Delete logic
	 */
	onDelete: function(){

	},

	onTokensGridItemClick: function(){

	},

	onSaveEditor: function(){
		var me = this,
			form = me.down('form').getForm(),
			record = form.getRecord(),
			values = form.getValues();
		record.set(values);
		app.msg(_('sweet'), _('record_saved'));
	},

	onCancelEditor: function(){
		var me = this, form = me.down('form').getForm(), grid = me.DocumentsGrid;
		form.reset();
		grid.getSelectionModel().deselectAll();
	},

	onDocumentsGridItemClick: function(grid, record){
		var me = this;
		var form = me.down('form').getForm();
		form.loadRecord(record);

	},
	newDocumentTemplate: function(){
		var me = this, store = me.templatesDocumentsStore;
		me.rowEditor.cancelEdit();
		store.insert(0,
			{
				title: _('new_document'),
				template_type: 'documenttemplate',
				date: new Date(),
				type: 1
			});
		me.rowEditor.startEdit(0, 0);

	},

	newDefaultTemplates: function(){
		var me = this, store = me.defaultsDocumentsStore;
		me.rowEditor3.cancelEdit();
		store.insert(0,
			{
				title: _('new_defaults'),
				template_type: 'defaulttemplate',
				date: new Date(),
				type: 1
			});
		me.rowEditor3.startEdit(0, 0);

	},

	//	newHeaderOrFooterTemplate:function(){
	//        var me = this,
	//            store = me.headersAndFooterStore;
	//        me.rowEditor2.cancelEdit();
	//        store.insert(0,{
	//            title: _('new_header_or_footer'),
	//	        template_type:'headerorfootertemplate',
	//            date: new Date(),
	//	        type: 2
	//        });
	//        me.rowEditor2.startEdit(0, 0);
	//
	//    },

	copyToClipBoard: function(grid, rowIndex, colIndex){
		var rec = grid.getStore().getAt(rowIndex),
			text = rec.get('token');
	},

	onRemoveDocument: function(){

	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		var me = this;
		me.templatesDocumentsStore.load();
		//        me.headersAndFooterStore.load();
		me.defaultsDocumentsStore.load();
		callback(true);
	}
});

Ext.define('App.view.administration.Roles', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'App.ux.combo.XCombo',
		'Ext.grid.plugin.CellEditing',
		'Ext.ux.DataTip'
	],
	itemId: 'AdministrationRolePanel',
	pageTitle: _('roles_and_permissions'),
	pageBody: [
		{
			xtype:'gridlivesearch',
			bodyStyle: 'background-color:white',
			itemId: 'AdministrationRoleGrid',
			frame: true,
			columnLines: true,
			searchBuffer: 500,
			filterStore: true,
			tbar: [
				{
					xtype: 'xcombo',
					emptyText: _('select'),
					labelWidth: 50,
					width: 250,
					valueField: 'id',
					displayField: 'title',
					queryMode: 'local',
					store: Ext.create('App.store.administration.AclGroups'),
					itemId: 'AdministrationRoleGroupCombo',
					windowConfig: {
						title: _('add_group')
					},
					formConfig: {
						border: false,
						bodyPadding: 10,
						items: [
							{
								xtype: 'textfield',
								fieldLabel: _('group_name'),
								name: 'title'
							},
							{
								xtype: 'checkbox',
								fieldLabel: _('active'),
								name: 'active'
							}
						]
					}
				},
				'-',
				'->',
				{
					xtype: 'button',
					text: _('print'),
					itemId: 'AdministrationRoleGridPrintBtn'
				},
				'-',
				{
					xtype: 'button',
					text: _('add_role'),
					iconCls: 'icoAdd',
					action: 'adminAclAddRole'
				},
				'-'
			],
			features: [
				{
					ftype: 'grouping'
				}
			],
			plugins: [
				{
					ptype: 'cellediting',
					clicksToEdit: 1
				},
				{
					ptype: 'datatip',
					tpl: _('click_to_edit')
				}
			],
			columns: [
				{
					text: 'Permission',
					width: 250,
					// locked: true
				}
			]
		}
	],
	pageButtons: [
		{
			text: _('refresh'),
			itemId: 'AdministrationRoleRefreshBtn'
		},
		'->',
		{
			text: _('cancel'),
			cls: 'cancelBtn',
			action: 'adminAclCancel'
		},
		'-',
		{
			text: _('save'),
			cls: 'saveBtn',
			action: 'adminAclSave'
		}
	]
});

Ext.define('App.view.administration.Users', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'App.ux.form.fields.plugin.PasswordStrength',
		'App.ux.combo.ActiveSpecialties',
		'App.ux.combo.Departments',
		'App.ux.grid.exporter.Exporter',
		'App.ux.form.fields.InputTextMask'
	],
	pageTitle: _('users'),
	itemId: 'AdminUsersPanel',
	initComponent: function(){
		var me = this;

		me.userStore = Ext.create('App.store.administration.User', {
			remoteFilter: true,
			remoteSort: true,
			autoSync: false,
			pageSize: 100
		});

		me.userGrid = Ext.create('Ext.grid.Panel', {
			itemId: 'AdminUserGridPanel',
			store: me.userStore,
			columns: [
				{
					text: 'id',
					sortable: false,
					dataIndex: 'id',
					width: 50
				},
				{
					width: 150,
					text: _('code'),
					sortable: true,
					dataIndex: 'code',
					items: [
						{
							xtype: 'columnsearchfield',
							autoSearch: true,
							operator: 'LIKE',
							suffix: '%'
						}
					]
				},
				{
					width: 150,
					text: _('username'),
					sortable: true,
					dataIndex: 'username',
					items: [
						{
							xtype: 'columnsearchfield',
							autoSearch: true,
							operator: 'LIKE',
							suffix: '%'
						}
					]
				},
				{
					width: 200,
					text: _('name'),
					sortable: true,
					dataIndex: 'lname',
					renderer: function(v, meta, rec){
						return rec.get('fullname');
					},
					items: [
						{
							xtype: 'columnsearchfield',
							autoSearch: true,
							operator: 'LIKE',
							suffix: '%'
						}
					]
				},
				{
					flex: 1,
					text: _('role'),
					sortable: false,
					dataIndex: 'role'
				},
				{
					flex: 1,
					text: _('department'),
					sortable: false,
					dataIndex: 'department'
				},
				{
					flex: 1,
					text: _('aditional_info'),
					sortable: true,
					dataIndex: 'notes'
				},
				{
					text: _('authy_id'),
					sortable: true,
					dataIndex: 'authy_id'
				},
				{
					text: _('active'),
					sortable: true,
					dataIndex: 'active',
					renderer: me.boolRenderer
				},
				{
					text: _('authorized'),
					sortable: true,
					dataIndex: 'authorized',
					renderer: me.boolRenderer
				},
				{
					text: _('is_attending'),
					sortable: true,
					dataIndex: 'is_attending',
					renderer: me.boolRenderer
				},
				{
					text: _('is_resident'),
					sortable: true,
					dataIndex: 'is_resident',
					renderer: me.boolRenderer
				}
			],
			plugins: [
				me.formEditing = Ext.create('App.ux.grid.RowFormEditing', {
					clicksToEdit: 2,
					items: [
						{
							xtype: 'tabpanel',
							items: [
								{
									title: _('general'),
									itemId: 'UserGridEditFormContainer',
									layout: 'hbox',
									items: [
										{
											xtype: 'container',
											itemId: 'UserGridEditFormContainerLeft',
											items: [
												{
													width: 250,
													xtype: 'textfield',
													fieldLabel: _('code'),
													name: 'code',
													allowBlank: false,
													validateOnBlur: true,
													margin: '0 0 5 0',
													labelAlign: 'right'
												},
												{
													xtype: 'fieldcontainer',
													layout: {
														type: 'hbox'
													},
													fieldDefaults: {
														labelAlign: 'right'
													},
													items: [
														{
															width: 250,
															xtype: 'textfield',
															fieldLabel: _('username'),
															name: 'username',
															allowBlank: false,
															validateOnBlur: true,
															vtype: 'usernameField'
														},
														{
															width: 200,
															labelWidth: 60,
															xtype: 'textfield',
															fieldLabel: _('password'),
															name: 'password',
															inputType: 'password',
															vtype: 'strength',
															strength: 24,
															plugins: {
																ptype: 'passwordstrength'
															}
														},
														{
															width: 100,
															xtype: 'checkbox',
															boxLabel: _('force_reset'),
															name: 'password_force_reset'
														},
														{
															width: 125,
															labelWidth: 40,
															xtype: 'textfield',
															fieldLabel: _('pin'),
															name: 'pin',
															inputType: 'password'
														}
													]
												},
												{
													xtype: 'fieldcontainer',
													layout: {
														type: 'hbox'
													},
													fieldDefaults: {
														labelAlign: 'right'
													},
													fieldLabel: _('name'),
													items: [
														{
															width: 50,
															xtype: 'mitos.titlescombo',
															name: 'title'
														},
														{
															width: 145,
															xtype: 'textfield',
															name: 'fname',
															allowBlank: false
														},
														{
															width: 100,
															xtype: 'textfield',
															name: 'mname'
														},
														{
															width: 175,
															xtype: 'textfield',
															name: 'lname'
														}
													]
												},
												{
													xtype: 'fieldcontainer',
													layout: {
														type: 'hbox'
													},
													fieldDefaults: {
														labelAlign: 'right'
													},
													items: [
														{
															width: 125,
															xtype: 'checkbox',
															fieldLabel: _('active'),
															name: 'active'
														},
														{
															width: 100,
															labelWidth: 85,
															xtype: 'checkbox',
															fieldLabel: _('authorized'),
															name: 'authorized'
														},
														{
															width: 100,
															labelWidth: 85,
															xtype: 'checkbox',
															fieldLabel: _('calendar_q'),
															name: 'calendar'
														},
														{
															width: 250,
															labelWidth: 50,
															xtype: 'gaiaehr.combo',
															fieldLabel: _('type'),
															name: 'doctor_type',
															list: 121,
															loadStore: true
														}
													]
												},
												{
													xtype: 'fieldcontainer',
													layout: {
														type: 'hbox'
													},
													fieldDefaults: {
														labelAlign: 'right'
													},
													items: [
														{
															width: 280,
															xtype: 'mitos.facilitiescombo',
															fieldLabel: _('default_facility'),
															name: 'facility_id',
															allowBlank: false
														},
														// {
														// 	width: 300,
														// 	xtype: 'combobox',
														// 	fieldLabel: _('ldap_domain'),
														// 	editable: false,
														// 	name: 'ldap_domain',
														// 	queryMode: 'local',
														// 	store: g('ldap_user_domains') ? g('ldap_user_domains').split(',') : []
														// }
													]
												},
												{
													xtype: 'fieldcontainer',
													layout: {
														type: 'hbox'
													},
													fieldDefaults: {
														labelAlign: 'right'
													},
													items: [
														{
															width: 280,
															xtype: 'depatmentscombo',
															fieldLabel: _('department'),
															name: 'department_id',
															allowBlank: false
														},
														{
															width: 300,
															xtype: 'mitos.rolescombo',
															fieldLabel: _('access_control'),
															name: 'role_id',
															allowBlank: false
														}
													]
												}
											]
										},
										{
											xtype: 'container',
											itemId: 'UserGridEditFormContainerRight',
											items: []
										}
									]
								},
								{
									xtype: 'panel',
									title: _('contact_info'),
									itemId: 'UserGridEditFormContactInfoPanel',
									layout: 'column',
									bodyPadding: 10,
									items: [
										{
											xtype: 'fieldset',
											title: _('address'),
											margin: '0 10 0 0',
											padding: 5,
											defaults: {
												margin: '0 0 5 0',
												width: 300
											},
											items: [
												{
													xtype: 'textfield',
													fieldLabel: _('address'),
													name: 'street'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('address_cont'),
													name: 'street_cont'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('city'),
													name: 'city'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('state'),
													name: 'state'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('postal_code'),
													name: 'postal_code'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('country_code'),
													name: 'country_code'
												}
											]
										},
										{
											xtype: 'fieldset',
											title: _('phone') + ' / ' + _('email'),
											padding: 5,
											defaults: {
												margin: '0 0 5 0',
												width: 300
											},
											items: [
												{
													xtype: 'textfield',
													fieldLabel: _('home'),
													name: 'phone',
													plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
												},
												{
													xtype: 'textfield',
													fieldLabel: _('mobile'),
													name: 'mobile'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('email'),
													name: 'email',
													vtype: 'email'
												}
											]
										}
									]
								},
								{
									xtype: 'panel',
									title: _('provider'),
									itemId: 'UserGridEditFormProviderPanel',
									layout: 'hbox',
									items: [
										{
											xtype: 'fieldcontainer',
											itemId: 'UserGridEditFormProviderPanelLeft',
											fieldDefaults: {
												labelAlign: 'right',
												width: 500,
												margin: '0 0 5 0'
											},
											margin: '20 10 0 0',
											items: [
												{
													xtype: 'checkbox',
													fieldLabel: _('is_attending'),
													name: 'is_attending'
												},
												{
													xtype: 'checkbox',
													fieldLabel: _('is_resident'),
													name: 'is_resident'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('federal_tax_id'),
													name: 'fedtaxid'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('fed_drug_id'),
													name: 'feddrugid'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('state_drug_id'),
													name: 'statedrugid'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('lic'),
													name: 'lic'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('npi'),
													name: 'npi',
													maxLength: 10,
													vtype: 'npi'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('tin'),
													name: 'ess'
												},
												{
													xtype: 'activespecialtiescombo',
													fieldLabel: _('specialties'),
													name: 'specialty',
													margin: '5 0',
													labelAlign: 'right',
													multiSelect: true
												},
												{
													xtype: 'textfield',
													fieldLabel: _('additional_info'),
													name: 'notes',
													labelAlign: 'right'
												},
												{
													xtype: 'textfield',
													fieldLabel: _('signature'),
													name: 'signature',
													labelAlign: 'right'
												}
											]
										},
										{
											xtype: 'grid',
											title: _('provider_credentialization'),
											itemId: 'UserGridEditFormProviderCredentializationGrid',
											flex: 1,
											maxHeight: 210,
											frame: true,
											store: Ext.create('App.store.administration.ProviderCredentializations', {
												pageSize: 1000
											}),
											plugins:[
												{
													ptype:'cellediting'
												}
											],
											tools: [
												{
													xtype: 'button',
													text: _('active_all'),
													icon: 'resources/images/icons/yes.png',
													margin: '0 5 0 0',
													itemId: 'UserGridEditFormProviderCredentializationActiveBtn'
												},
												{
													xtype:'button',
													text: _('inactive_all'),
													icon: 'resources/images/icons/no.png',
													itemId: 'UserGridEditFormProviderCredentializationInactiveBtn'
												}
											],
											columns: [
												{
													text: _('insurance'),
													width: 150,
													dataIndex: 'insurance_company_id',
													renderer: function(v, meta, record){
														return record.data.insurance_company_id +
															': ' +
															record.data.insurance_company_name;
													}
												},
												{
													xtype:'datecolumn',
													format: g('date_display_format'),
													text: _('start'),
													dataIndex: 'start_date',
													editor: {
														xtype: 'datefield'
													}
												},
												{
													xtype:'datecolumn',
													format: g('date_display_format'),
													text: _('end'),
													dataIndex: 'end_date',
													editor: {
														xtype: 'datefield'
													}
												},
												{
													text: _('note'),
													dataIndex: 'credentialization_notes',
													flex: 1,
													editor: {
														xtype: 'textfield'
													}
												},
												{
													text: _('active'),
													dataIndex: 'active',
													renderer: app.boolRenderer
												}
											]
										}
									]
								}
							]
						}

					]
				})
			],
			tbar: [
				{
					xtype: 'button',
					text: _('user'),
					iconCls: 'icoAdd',
					scope: me,
					handler: me.onNewUser
				},
				'-',
				{
					xtype: 'button',
					text: 'LDAP Sync',
					itemId: 'AdminUserGridPanelLDAPSyncBtn',
					acl: g('ldap_enabled')
				},
				'-',
				'->',
				'-',
				{
					xtype: 'button',
					text: _('authy_register'),
					itemId: 'AdminUserGridPanelAuthyRegisterBtn'
				},
				'-',
				{
					xtype: 'button',
					text: _('print'),
					iconCls: 'icoPrint',
					itemId: 'AdminUserGridPanelPrintBtn'
				},
				'-',
				{
					xtype: 'exporterbutton',
					text: 'Save As CSV',
				},
				'-',
				{
					xtype: 'exporterbutton',
					text: 'Save As XLS',
					format: 'excel'
				}
			],
			bbar: {
				xtype: 'pagingtoolbar',
				pageSize: 1000,
				store: me.userStore,
				displayInfo: true,
				plugins: new Ext.ux.SlidingPager()
			}

		});

		me.pageBody = [me.userGrid];
		me.callParent(arguments);

	},

	onNewUser: function(){
		var me = this;

		me.formEditing.cancelEdit();
		me.userStore.insert(0, {
			create_date: new Date(),
			update_date: new Date(),
			create_uid: app.user.id,
			update_uid: app.user.id,
			active: 1,
			authorized: 0,
			calendar: 0
		});
		me.formEditing.startEdit(0, 0);
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		this.userStore.load();
		callback(true);
	}

});

Ext.define('App.view.miscellaneous.MyAccount', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('my_account'),

	requires: [
		'App.ux.combo.Titles',
		'App.ux.window.Window',
		'App.ux.combo.Facilities',
		'App.ux.combo.ActiveSpecialties',
		'App.ux.form.fields.plugin.PasswordStrength'
	],

	initComponent: function(){
		var me = this;

		// *************************************************************************************
		// My Account Data Store
		// *************************************************************************************
		me.store = Ext.create('App.store.miscellaneous.Users');

		// *************************************************************************************
		// User Settings Form
		// Add or Edit purpose
		// *************************************************************************************
		me.myAccountForm = Ext.create('App.ux.form.Panel', {
			cls: 'form-white-bg',
			frame: true,
			hideLabels: true,
			defaults: {
				labelWidth: 89,
				layout: {
					type: 'hbox',
					defaultMargins: {
						top: 0,
						right: 5,
						bottom: 0,
						left: 0
					}
				}
			},
			items: [
				{
					xtype: 'textfield',
					hidden: true,
					name: 'id'
				},
				{
					xtype: 'fieldset',
					title: _('personal_info'),
					defaultType: 'textfield',
					layout: 'anchor',
					defaults: {
						labelWidth: 89,
						anchor: '100%',
						layout: {
							type: 'hbox',
							defaultMargins: {
								top: 0,
								right: 5,
								bottom: 0,
								left: 0
							}
						}
					},
					items: [
						{
							xtype: 'fieldcontainer',
							defaults: {
								hideLabel: true
							},
							msgTarget: 'under',
							items: [
								{
									width: 110,
									xtype: 'displayfield',
									value: 'First, Middle, Last: '
								},
								{
									width: 55,
									xtype: 'mitos.titlescombo',
									name: 'title'
								},
								{
									width: 105,
									xtype: 'textfield',
									name: 'fname'
								},
								{
									width: 100,
									xtype: 'textfield',
									name: 'mname'
								},
								{
									width: 175,
									xtype: 'textfield',
									name: 'lname'
								}
							]
						}
					]
				},
				{
					xtype: 'fieldset',
					title: _('login_info'),
					defaultType: 'textfield',
					layout: 'anchor',
					defaults: {
						labelWidth: 89,
						anchor: '100%',
						layout: {
							type: 'hbox',
							defaultMargins: {
								top: 0,
								right: 5,
								bottom: 0,
								left: 0
							}
						}
					},
					items: [
						{
							xtype: 'fieldcontainer',
							defaults: {
								hideLabel: true
							},
							msgTarget: 'under',
							items: [
								{
									width: 110,
									xtype: 'displayfield',
									value: 'Username: '
								},
								{
									width: 170,
									xtype: 'textfield',
									name: 'username'
								},
								{
									width: 100,
									xtype: 'displayfield',
									value: 'Password: '
								},
								{
									width: 175,
									xtype: 'textfield',
									name: 'password',
									inputType: 'password',
									disabled: true
								},
								{
									width: 50,
									xtype: 'displayfield',
									value: 'PIN: '
								},
								{
									width: 50,
									xtype: 'textfield',
									name: 'pin'
								}
							]
						}
					]
				}
			],
			tbar:[
				{
					text: _('change_password'),
					iconCls: 'save',
					scope: me,
					handler: me.onPasswordChange
				}
			],
			buttons: [
				{
					text: _('save'),
					iconCls: 'save',
					scope: me,
					handler: me.onSaveClick
				}
			]
		});

		me.win = Ext.create('App.ux.window.Window', {
			width: 420,
			title: _('change_you_password'),
			items: [
				{
					xtype: 'form',
					bodyPadding: 15,
					defaultType: 'textfield',
					defaults: {
						labelWidth: 130,
						width: 380,
						inputType: 'password'
					},
					items: [
						{
							name: 'id',
							hidden: true
						},
						{
							fieldLabel: _('old_password'),
							name: 'oPassword',
							allowBlank: false
						},
						{
							fieldLabel: _('new_password'),
							name: 'nPassword',
							allowBlank: false,
							id: 'myAccountPage_nPassword',
							vtype      : 'strength',
							strength   : 24,
							plugins    : {
								ptype : 'passwordstrength'
							}
						},
						{
							fieldLabel: _('re_type_password'),
							name: 'vPassword',
							allowBlank: false,
							vtype: 'password',
							initialPassField: 'myAccountPage_nPassword',
							validateOnChange: true
						}
					]
				}
			],
			buttons: [
				{
					text: _('save'),
					scope: me,
					handler: me.onPasswordSave
				},
				{
					text: _('cancel'),
					scope: me,
					handler: me.onCancel
				}
			],
			listeners: {
				scope: me,
				close: me.onClose
			}

		});
		me.pageBody = [me.myAccountForm];

		me.callParent(arguments);
	},

	onPasswordSave: function(btn){
		var me = this,
			form = me.win.down('form').getForm(),
			values = form.getValues(),
			id = me.myAccountForm.getForm().getRecord().data.id,
			params;

		if(values.nPassword != values.vPassword){
			app.msg(_('oops'), _('password_does_not_match'), true);
			return;
		}

		if(form.isValid()){
			params = {
				id:id,
				old_password:values.oPassword,
				new_password:values.nPassword
			};

			User.updatePassword(params, function(provider, response){

				if(response.result.success){
					app.msg(_('sweet'), _('record_updated'));
					me.win.close();
				}else{
					app.msg(_('oops'), _(response.result.message), true);
				}
			});

		}


	},

	onPasswordChange: function(){
		this.win.show();
	},

	onCancel: function(){
		this.win.close();
	},

	onClose: function(){
		this.win.down('form').getForm().reset();
	},

	onSaveClick:function(btn){
		var me = this,
			form = me.myAccountForm.getForm(),
			record = form.getRecord(),
			values = form.getValues();

		record.set(values);
		record.save({
			callback:function(){
				app.msg(_('sweet'), _('record_update'))
			}
		});
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		var me = this,
			form = me.myAccountForm.getForm();

		this.store.load({
			callback: function(record){
				form.loadRecord(record[0]);
			}
		});

		callback(true);

	}
}); 

Ext.define('App.controller.administration.Roles', {
	extend: 'Ext.app.Controller',

	requires: [
		'App.model.administration.AclGroupPerm',
		'App.ux.grid.Printer'
	],

	refs: [
		{
			ref: 'AdministrationRoleGroupCombo',
			selector: '#AdministrationRoleGroupCombo'
		},
		{
			ref: 'AdministrationRoleGrid',
			selector: '#AdministrationRoleGrid'
		}
	],

	init: function(){
		this.control({
			'#AdministrationRolePanel': {
				render: this.onAdministrationRolePanelRender
			},
			'#AdministrationRoleGrid': {
				beforeedit: this.beforeCellEdit
			},
			'#AdministrationRoleGroupCombo': {
				select: this.doAdministrationRoleGridReconfigure
			},
			'button[action=adminAclAddRole]': {
				click: this.doAddRole
			},
			'button[action=adminAclSave]': {
				click: this.doSaveAcl
			},
			'button[action=adminAclCancel]': {
				click: this.doCancelAcl
			},
			'#AdministrationRoleGridPrintBtn': {
				click: this.onAdministrationRoleGridPrintBtnClick
			},
			'#AdministrationRoleRefreshBtn': {
				click: this.onAdministrationRoleRefreshBtnClick
			}
		});
	},

	onAdministrationRoleRefreshBtnClick: function (btn){

		var grid = this.getAdministrationRoleGrid(),
			store = grid.getStore();

		grid.view.el.mask('Loading');

		ACL.getGroupPerms({group_id: grid.group_id}, function(response){
			store.loadRawData(response.data);
			grid.view.el.unmask();
		});

	},

	onAdministrationRoleGridPrintBtnClick: function(){
		App.ux.grid.Printer.print(this.getAdministrationRoleGrid());
	},

	onAdministrationRolePanelRender: function(){
		var me = this,
			cmb = me.getAdministrationRoleGroupCombo(),
			store = cmb.getStore();

		store.load({
			callback: function(records){
				cmb.select(records[0]);
				me.doAdministrationRoleGridReconfigure();
			}
		});

	},

	doSaveAcl: function(){
		var me = this,
			store = this.getAdministrationRoleGrid().getStore();

		if(store.getUpdatedRecords().length > 0){
			me.getAdministrationRoleGrid().el.mask(_('saving'));
		}

		store.sync({
			callback: function(response){
				app.msg(_('sweet'), _('record_saved'));
				me.getAdministrationRoleGrid().el.unmask();
			}
		});
	},

	doCancelAcl: function(){
		this.getAdministrationRoleGrid().getStore().rejectChanges();
	},

	beforeCellEdit: function(editor, e){
		return e.field != 'title';
	},

	doAdministrationRoleGridReconfigure: function(){
		var me = this,
			cmb = me.getAdministrationRoleGroupCombo(),
			group_id = cmb.getValue(),
			grid = me.getAdministrationRoleGrid(),
			fields = [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'group_id',
					type: 'int'
				},
				{
					name: 'category',
					type: 'string'
				}
			], columns, store, model;

		// add mask to view while we get the data and grid configurations
		grid.view.el.mask('Loading');
		// Ext.direct method to get grid configuration and data

		grid.group_id = group_id;

		ACL.getGroupPerms({group_id: group_id}, function(response){
			// new columns
			columns = response.columns;

			// set model fields merging default fields and role fields
			fields = fields.concat(response.fields);
			me.getModel('administration.AclGroupPerm').setFields(fields);

			var store = Ext.create('Ext.data.Store', {
				model: 'App.model.administration.AclGroupPerm',
				groupField: 'category'
			});

			// add raw data to the store
			store.loadRawData(response.data);

			// add the checkbox editor and renderer to role fields
			for(var i = 0; i < columns.length; i++){
				columns[i].editor = {xtype: "checkbox"};
				columns[i].renderer = app.boolRenderer;
			}

			columns.push({
				flex: 1
			});

			// reconfigure grid
			grid.reconfigure(store, columns);
			// remove grid view mask
			grid.view.el.unmask();

		});
	},

	doAddRole: function(){
		var me = this,
			record = Ext.create('App.model.administration.AclRoles', {
				group_id: me.getAdministrationRoleGroupCombo().getValue()
			});

		me.getRoleWindow().show();
		me.roleWindow.down('form').getForm().loadRecord(record);
	},

	doSaveRole: function(){
		var me = this,
			panel = me.roleWindow.down('form'),
			form = panel.getForm(),
			record = form.getRecord(),
			values = form.getValues();

		if(form.isValid()){
			panel.el.mask(_('be_right_back'));
			record.set(values);
			record.save({
				callback: function(rec){
					me.doAdministrationRoleGridReconfigure();
					panel.el.unmask();
					me.roleWindow.close();
				}
			});
		}
	},

	doCancelRole: function(){
		this.roleWindow.close();
	},

	getRoleWindow: function(){
		var me = this;

		me.roleWindow = Ext.widget('window', {
			title: _('new_role'),
			items: [
				{
					xtype: 'form',
					border: false,
					bodyPadding: 10,
					items: [
						{
							xtype: 'textfield',
							fieldLabel: _('role_name'),
							name: 'role_name',
							allowBlank: false
						},
						{
							xtype: 'checkbox',
							fieldLabel: _('active'),
							name: 'active'
						}
					]
				}
			],
			buttons: [
				{
					text: _('cancel'),
					cls: 'cancelBtn',
					scope: me,
					handler: me.doCancelRole,
					action: 'adminAclRoleCancel'
				},
				{
					text: _('save'),
					cls: 'saveBtn',
					scope: me,
					handler: me.doSaveRole,
					action: 'adminAclRoleSave'
				}
			]
		});

		return me.roleWindow;
	}

});
Ext.define('App.controller.documents.AdministrativeDocuments', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.documents.windows.UploadAdministrativeDocument'
	],
	refs: [
		{
			ref: 'AdministrativeDocumentPanel',
			selector: 'administrativedocumentspanel'
		},
		{
			ref: 'AdministrativeDocumentGrid',
			selector: 'administrativedocumentspanel #AdministrativeDocumentGrid'
		},
		{
			ref: 'AdministrativeDocumentViewerFrame',
			selector: 'administrativedocumentspanel #AdministrativeDocumentViewerFrame'
		},
		{
			ref: 'AdministrativeDocumentUploadWindow',
			selector: '#AdministrativeDocumentUploadWindow'
		},
		{
			ref: 'AdministrativeDocumentUploadScanBtn',
			selector: '#AdministrativeDocumentUploadWindow #scanBtn'
		},
		{
			ref: 'AdministrativeDocumentUploadFileUploadField',
			selector: '#AdministrativeDocumentUploadWindow #fileUploadField'
		},
		{
			ref: 'AdministrativeDocumentHashCheckBtn',
			selector: '#AdministrativeDocumentHashCheckBtn'
		},
		{
			ref: 'AdministrativeDocumentHashCheckBtn',
			selector: '#AdministrativeDocumentHashCheckBtn'
		},
		{
			ref: 'AddAdministrativeDocumentBtn',
			selector: 'administrativedocumentspanel #AddAdministrativeDocumentBtn'
		},
		{
			ref: 'AdministrativeDocumentUploadBtn',
			selector: 'administrativedocumentspanel #AdministrativeDocumentUploadBtn'
		},
		{
			ref: 'AdministrativeDocumentUploadBtn',
			selector: 'administrativedocumentspanel #AdministrativeDocumentUploadBtn'
		},
		{
			ref: 'AdministrativeDocumentScanBtn',
			selector: 'administrativedocumentspanel #AdministrativeDocumentScanBtn'
		},
		{
			ref: 'AdministrativeDocumentErrorNoteWindow',
			selector: 'administrativedocumenterrornotewindow'
		},
		{
			ref: 'AdministrativeDocumentViewerOpacityField',
			selector: 'AdministrativeDocumentViewerOpacityField'
		},
		{
			ref: 'AdministrativeDocumentWindow',
			selector: '#AdministrativeDocumentWindow'
		}
	],

	scannedDocument: null,

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				browserhelperopen: me.onBrowserHelperOpen,
				browserhelperclose: me.onBrowserHelperClose,
				documentedit: me.onAdministrativeDocumentEdit
			},
			'administrativedocumentspanel': {
				activate: me.onAdministrativeDocumentPanelActive,
				beforerender: me.onAdministrativeDocumentBeforeRender
			},
			'administrativedocumentspanel #AdministrativeDocumentGrid': {
				selectionchange: me.onAdministrativeDocumentGridSelectionChange,
				afterrender: me.onAdministrativeDocumentGridAfterRender,
				beforerender: me.onAdministrativeDocumentGridBeforeRender,
				beforeitemcontextmenu: me.onAdministrativeDocumentGridBeforeItemContextMenu
			},
			'administrativedocumentspanel #administrativeDocumentGrid gridview': {
				beforedrop: me.onAdministrativeDocumentGridViewBeforeDrop,
				drop: me.onAdministrativeDocumentGridViewDrop,
			},
			'administrativedocumentspanel [toggleGroup=administrativedocumentgridgroup]': {
				toggle: me.onAdministrativeDocumentGroupBtnToggle
			},
			'administrativedocumentspanel #AdministrativeDocumentGroupBtn': {
				toggle: me.onAdministrativeDocumentGroupBtnToggle
			},
			'administrativedocumentspanel #AdministrativeDocumentUploadBtn': {
				click: me.onAdministrativeDocumentUploadBtnClick
			},
			'administrativedocumentspanel #AdministrativeDocumentScanBtn': {
				click: me.onAdministrativeDocumentScanBtnClick
			},
			'#AdministrativeDocumentUploadWindow': {
				show: me.onAdministrativeDocumentUploadWindowShow
			},
			'#AdministrativeDocumentUploadWindow #uploadBtn': {
				click: me.onAdministrativeDocumentUploadSaveBtnClick
			},
			'#AdministrativeDocumentGridGroupBtn': {
				beforerender: me.onAdministrativeDocumentGridGroupBtnBeforeRender
			},
			'#AdministrativeDocumentGridGroupBtn menucheckitem': {
				checkchange: me.onAdministrativeDocumentGridGroupBtnCheckChange
			},
			'#AdministrativeDocumentErrorNoteSaveBtn': {
				click: me.onAdministrativeDocumentErrorNoteSaveBtnClick
			},
			'#AdministrativeDocumentViewerOpacityField': {
				afterrender: me.onAdministrativeDocumentViewerOpacityFieldAfterRender,
				change: me.onAdministrativeDocumentViewerOpacityFieldChange
			},
			'#AdministrativeDocumentViewerFrame': {
				render: me.onAdministrativeDocumentViewerFrameRender
			},
			'#AdministrativeDocumentEnteredInErrorBtn': {
				click: me.onAdministrativeDocumentEnteredInErrorBtnClick
			},
			// '#EncounterPatientDocumentsBtn': {
			// 	click: me.onEncounterPatientDocumentsBtnClick
			// },
			'#AdministrativeDocumentWindow': {
				show: me.onAdministrativeDocumentWindowShow
			}
		});

		me.nav = this.getController('Navigation');

		me.document_group_menu = [];
		me.document_groups = {};

		// CombosData.getAdministrativeDocumentsOptionsByListId({list_key : 'doc_type_admin_cat', code: 'CD'}, function (groups){
		// 	groups.forEach(function (group){
		//
		// 		var stateId = ((group.option_value+ '-' + group.option_name + '_').replace(' ', '_') + app.user.id),
		// 			state = Ext.state.Manager.get(stateId, {});
		//
		// 		me.document_groups[group.option_value] = state.checked || false;
		//
		// 		me.document_group_menu.push({
		// 			xtype: 'menucheckitem',
		// 			text: group.option_value + ' - ' + group.option_name,
		// 			stateful: true,
		// 			stateId: stateId,
		// 			_document_group: group.option_value
		// 		});
		// 	});
		// });
	},

	// getAdministrativeDocumentsOptionsByListId: function(docTypeCode) {
	// 	var me = this;
	// 	//
	// 	// me.document_group_menu = [];
	// 	// me.document_groups = {};
	//
	// 	CombosData.getAdministrativeDocumentsOptionsByListId({list_key : 'doc_type_admin_cat', code: docTypeCode}, function (groups){
	// 		groups.forEach(function (group){
	//
	// 			var stateId = ((group.option_value+ '-' + group.option_name + '_').replace(' ', '_') + app.user.id),
	// 				state = Ext.state.Manager.get(stateId, {});
	//
	// 			me.document_groups[group.option_value] = state.checked || false;
	//
	// 			me.document_group_menu.push({
	// 				xtype: 'menucheckitem',
	// 				text: group.option_value + ' - ' + group.option_name,
	// 				stateful: true,
	// 				stateId: stateId,
	// 				_document_group: group.option_value
	// 			});
	// 		});
	// 	});
	// },

	onAdministrativeDocumentHashCheckBtnClick: function(grid, rowIndex){
		var rec = grid.getStore().getAt(rowIndex);

		DocumentHandler.checkDocHash(rec.data, function(provider, response){

			var message = Ext.String.htmlDecode(response.result.msg);

			Ext.Msg.show({
				title: _('document_hash'),
				msg: message,
				buttons: Ext.Msg.OK,
				icon: Ext.Msg.INFO
			});
		});
	},

	onAdministrativeDocumentEdit: function(data){

		var store = this.getAdministrativeDocumentGrid().getStore(),
			record = store.getById(data.save.id);

		if(record){
			var src = data.save.document.split(','),
				document = src[1] || src[0],
				record_data;

			record.set({ document: document });

			record_data = record.data;
			record_data.edit_document = true;

			DocumentHandler.updateAdministrativeDocument(record_data, function (response) {

				record.commit();

				if(window.dual){
					dual.msg('sweet', _('record_saved'));
				}else{
					app.msg('sweet', _('record_saved'));
				}

			});

		}
	},

	onBrowserHelperOpen: function(){
		if(this.getAdministrativeDocumentScanBtn()){
			this.getAdministrativeDocumentScanBtn().show();
		}
	},

	onBrowserHelperClose: function(){
		if(this.getAdministrativeDocumentScanBtn()){
			this.getAdministrativeDocumentScanBtn().hide();
		}
	},

	onAdministrativeDocumentPanelActive: function(panel, win){
		var me = this,
			grid = panel.down('grid'),
			store = grid.getStore(),
			params = me.nav.getExtraParams();

		me.activePanel = panel;

		if(params && params.document){
			store.on('load', me.doSelectDocument, me);
		}

		if(panel.defereOnActiveReload) return;

		me.doAdministrativeDocumentReload(panel, win);
	},

	doSelectDocument: function(store){
		var me = this,
			grid = me.activePanel.down('grid'),
			params = me.nav.getExtraParams();

		var doc = store.getById(params.document);
		if(doc){
			grid.getSelectionModel().select(doc);

		}else{
			app.msg(_('oops'), _('unable_to_find_document'), true);
		}
		store.un('load', me.doSelectDocument, me);
	},

	onAdministrativeDocumentBeforeRender: function(panel){
		this.setViewerSite(app.user.site);
		panel.defereOnActiveReload = false;
	},

	doAdministrativeDocumentReload: function(panel, win){
		var me = this,
			grid = panel.down('grid'),
			store = grid.getStore();

		store.clearFilter(true);

		store.filter([
			{
				property: 'belongs_to_id',
				value: win.belongs_to_id
			},
			{
				property: 'belongs_to',
				value: win.belongs_to
			}
		]);
	},

	onAdministrativeDocumentGridSelectionChange: function(sm, selection){
		var frame = sm.view.panel.up('panel').query('#AdministrativeDocumentViewerFrame')[0];

		if(selection.length === 0 || selection[selection.length - 1].get('disabled_selection')){
			frame.setSrc('about:blank');
		}else{
			frame.setSrc('dataProvider/DocumentViewer.php?site=' + this.site + '&token=' + app.user.token + '&id=' + selection[selection.length - 1].data.id + '&_dc=' + Ext.Date.now()
				+ '&doctype=' + 'claimdoc');
		}
	},

	onAdministrativeDocumentGridAfterRender: function (container) {
		if(eval(a('allow_document_drag_drop_upload'))) {
			this.initDocumentDnD(container);
		}
	},

	onAdministrativeDocumentGridBeforeRender: function (grid) {
		grid.store.on('load', function (store){
			this.onAdministrativeDocumentGridBeforeRefresh(grid, store);
		}, this);
	},

	onAdministrativeDocumentGridBeforeItemContextMenu: function (grid, record, item, index, e, eOpts) {
		var me = this,
			activePanelCls = this.getController('Navigation').getUrlCls();

		//if(activePanelCls !== 'App.view.patient.Summary') return;

		e.preventDefault();
		Ext.Msg.show({
			title:'C-CDA',
			msg: 'Would you like to view the raw xml data?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if (btn === 'yes'){
					var frame = grid.up('panel').up('panel').query('#AdministrativeDocumentViewerFrame')[0];

					if(record){
						frame.setSrc('dataProvider/DocumentViewer.php?site=' + me.site + '&token=' + app.user.token + '&id=' + record.data.id + '&rawXml');
					}
				}
			}
		});
	},

	onAdministrativeDocumentGridBeforeRefresh: function (grid){
		// var me = this,
		// 	groups = grid.store.getGroups(),
		// 	v = grid.view;
		//
		// if(groups.length === 0){
		// 	return;
		// }
		//
		// groups.forEach(function (group){
		// 	try{
		// 		if(me.document_groups[group.name]){
		// 			v.summaryFeature.expand(group.name);
		// 		}else{
		// 			v.summaryFeature.collapse(group.name);
		// 		}
		// 	}catch (e){
		// 		say('Document Group Collapse/Expand Error');
		// 		say(e);
		// 	}
		// });
	},

	initDocumentDnD: function(grid){
		var me = this;

		me.dnding = false;

		grid.on({
			drop: {
				element: 'el',
				fn: me.documentDrop,
				scope: me
			},
			dragstart: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragenter: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragover: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragleave: {
				element: 'el',
				fn: me.documentRemoveDropZone
			},
			dragexit: {
				element: 'el',
				fn: me.documentRemoveDropZone
			}
		});
	},

	documentDrop: function (e) {
		var me = this;
		e.stopEvent();

		var files = Ext.Array.from(e.browserEvent.dataTransfer.files);
		me.fileHandler(files[0]);

		Ext.get(e.target).removeCls('drag-over');

	},

	documentAddDropZone: function (e) {
		if (!e.browserEvent.dataTransfer || Ext.Array.from(e.browserEvent.dataTransfer.types).indexOf('Files') === -1) {
			return;
		}
		e.stopEvent();

		this.addCls('drag-over');
	},

	documentRemoveDropZone: function (e) {

		var el = e.getTarget(),
			thisEl = this.el;

		e.stopEvent();

		if (el === thisEl.dom) {
			this.removeCls('drag-over');
			return;
		}

		while (el !== thisEl.dom && el && el.parentNode) {
			el = el.parentNode;
		}

		if (el !== thisEl.dom) {
			this.removeCls('drag-over');
		}
	},

	onAdministrativeDocumentGridViewBeforeDrop: function (node, data, over_record, drop_position) {
		// say('onPatientDocumentGridViewBeforeDrop');
		// say(node);
		// say(data);
		// say(over_record);
		// say(drop_position);

		if(data.records.length === 0) {
			return false;
		}

		// id validation
		if(!a('allow_document_drag_drop')){
			app.msg(_('oops'), 'Unable to Edit, Not Authorized to Drag & Drop Document', true);
			return false;
		}

		// id validation
		if(data.records[0].get('id') <= 0){
			app.msg(_('oops'), 'Unable to Edit, Document is not a stored document', true);
			return false;
		}
		// ZZZ "ENTERED IN ERROR" validation
		if(data.records[0].get('docTypeCode') === 'ZZZ'){
			app.msg(_('oops'), 'Unable to Edit, Document entered in error', true);
			return false;
		}

		// Drop outside group
		if(data.records[0].get('docType') === ''){
			app.msg(_('oops'), 'Unable to Edit, Please drop the document inside group', true);
			return false;
		}

		// Drop  different group
		if(data.records[0].get('docTypeCode') === over_record.get('docTypeCode')){
			app.msg(_('oops'), 'Please drop the document inside a different group', true);
			return false;
		}

	},

	onAdministrativeDocumentGridViewDrop: function (node, data, over_record, drop_position) {
		// say('onPatientDocumentGridViewDrop');
		// say(node);
		// say(data);
		// say(over_record);
		// say(drop_position);

		data.records[0].set({
			docTypeCode: over_record.get('docTypeCode'),
			docType: over_record.get('docType'),
			date: data.records[0].get('date')
		});

		data.records[0].store.sync();

	},

	getGroupName: function(store, record){
		var group = store.groupers.items[0].property;

		if(group === 'docTypeCode'){
			return Ext.String.capitalize(record.get('docTypeCode') + ' - ' + record.get('docType'));
		}else{
			return record.get('groupDate');
		}
	},

	onAdministrativeDocumentGroupBtnToggle: function(btn, pressed){
		var grid = btn.up('grid'),
			selector = '#' + btn.action,
			header = grid.headerCt.down(selector);

		if(pressed){
			grid.getStore().group(btn.action);
			header.hide();
			btn.disable();
		}else{
			header.show();
			btn.enable();
		}
	},

	onAdministrativeDocumentUploadBtnClick: function(btn){
		this.setAdministrativeDocumentUploadWindow(btn, 'click');
	},

	setAdministrativeDocumentUploadWindow: function(btn, action){
		var document_win = btn.up('window'),
			record = this.getNewAdministrativeDocumentRecord(document_win),
			upload_win = this.getUploadWindow(action),
			admin_doc_type_cat_combo_store = upload_win.down('form').down('#adminDocTypeCatCombo').getStore();

		admin_doc_type_cat_combo_store.clearFilter(true);

		admin_doc_type_cat_combo_store.filter([
			{
				property: 'code',
				value: document_win.doc_type_code
			}
		]);

		admin_doc_type_cat_combo_store.load();

		upload_win.down('form').getForm().loadRecord(record);

		return upload_win;
	},

	getUploadWindow: function(action){
		return Ext.create('App.view.documents.windows.UploadAdministrativeDocument', {
			action: action,
			itemId: 'AdministrativeDocumentUploadWindow'
		});
	},

	getNewAdministrativeDocumentRecord: function(document_win){
		return Ext.create('App.model.documents.AdministrativeDocuments', {
			belongs_to: document_win.belongs_to, // acc_billing_claim_payment_headers
			belongs_to_id: document_win.belongs_to_id, // TODO
			uid: app.user.id,
			date: new Date()
		})
	},

	onAdministrativeDocumentScanBtnClick: function (btn) {
		var administrative_documents_grid = btn.up('grid');

		this.getController('Scanner').showDocumentScanWindow(undefined, function (documents){
			if(documents){
				administrative_documents_grid.add(documents);
			}
		});
	},

	onAdministrativeDocumentUploadWindowShow: function(){
		this.scannedDocument = null;
		this.getAdministrativeDocumentUploadFileUploadField().enable();
		this.getAdministrativeDocumentUploadScanBtn().setVisible(this.getController('Scanner').conencted);
	},

	onAdministrativeDocumentUploadSaveBtnClick: function(){
		var me = this,
			win = me.getAdministrativeDocumentUploadWindow(),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			values = form.getValues(),
			reader = new FileReader(),
			uploadField = form.findField('document');

		if(!form.isValid()) return;

		record.set(values);

		if(win.action == 'click'){
			var uploadValue = uploadField.getValue();
			record.set({name: uploadValue});

			if(me.scannedDocument){
				record.set({document: me.scannedDocument});
				me.doNewAdministrativeDocumentRecordSave(record);
			}else{
				reader.onload = function(e){
					record.set({document: e.target.result});
					me.doNewAdministrativeDocumentRecordSave(record);
				};
				reader.readAsDataURL(uploadField.extractFileInput().files[0]);
			}
		}else{
			me.doNewAdministrativeDocumentRecordSave(record);
		}
	},

	doNewAdministrativeDocumentRecordSave: function(record){
		var me = this,
			store = me.getAdministrativeDocumentGrid().getStore(),
			index = store.indexOf(record);

		//record.set({facility_id: app.user.facility});

		if(index == -1){
			store.add(record);
		}

		store.sync({
			success: function(){
				app.msg(_('sweet'), _('document_added'));
				me.getAdministrativeDocumentUploadWindow().close();
				me.getAdministrativeDocumentGrid().getSelectionModel().select(record);

			},
			failure: function(){
				store.rejectChanges();
				if(window.dual){
					dual.msg(_('oops'), _('document_error'), true);
				}else{
					app.msg(_('oops'), _('document_error'), true);
				}
			}
		})
	},

	onAdministrativeDocumentGridGroupBtnBeforeRender: function (btn){
		var me = this,
			admin_doc_window = btn.up('window'),
			docTypeCode = admin_doc_window.doc_type_code;

		//me.getAdministrativeDocumentsOptionsByListId(admin_doc_window.doc_type_code);

		CombosData.getAdministrativeDocumentsOptionsByListId({list_key : 'doc_type_admin_cat', code: docTypeCode}, function (groups){
			groups.forEach(function (group){

				var stateId = ((group.option_value+ '-' + group.option_name + '_').replace(' ', '_') + app.user.id),
					state = Ext.state.Manager.get(stateId, {});

				me.document_groups[group.option_value] = state.checked || false;

				me.document_group_menu.push({
					xtype: 'menucheckitem',
					text: group.option_value + ' - ' + group.option_name,
					stateful: true,
					stateId: stateId,
					_document_group: group.option_value
				});

				btn.menu.add({
					xtype: 'menucheckitem',
					text: group.option_value + ' - ' + group.option_name,
					stateful: true,
					stateId: stateId,
					_document_group: group.option_value
				});
			});
		});

		//btn.menu.add(Ext.clone(me.document_group_menu));
	},

	onAdministrativeDocumentGridGroupBtnCheckChange: function (btn){
		var me = this;

		me.document_groups[btn._document_group] = btn.checked;
	},

	onAdministrativeDocumentErrorNoteSaveBtnClick: function(){
		var me = this,
			win = me.getAdministrativeDocumentErrorNoteWindow(),
			form = win.down('form').getForm(),
			values = form.getValues(),
			document_record = form.getRecord(),
			site = document_record.site ? document_record.site : null;

		if(form.isValid()){
			values.entered_in_error = true;
			values.site = site;
			document_record.set(values);
			document_record.save({
				success: function(){
					win.close();
					document_record.set({groupDate:''});
					document_record.commit();
				}
			});
		}
	},

	onAdministrativeDocumentViewerOpacityFieldAfterRender: function (field) {
		field.el.set({'data-qtip': _('document_brightness')});
	},

	onAdministrativeDocumentViewerOpacityFieldChange: function (feild, value) {
		var frame = feild.up('panel').query('#AdministrativeDocumentViewerFrame')[0];
		if(frame) this.setOpacity(frame, value);
	},

	setOpacity: function (frame, opacity) {
		frame.el.applyStyles({ opacity: opacity });
	},

	onAdministrativeDocumentViewerFrameRender:function (frame) {
		var field = frame.up('panel').query('#AdministrativeDocumentViewerOpacityField')[0];
		if(field) this.setOpacity(frame, field.getValue());
	},

	onAdministrativeDocumentEnteredInErrorBtnClick: function (btn) {

		var me = this,
			sm = btn.up('grid').getSelectionModel(),
			document_records = sm.getSelection();

		if(document_records.length === 0) return;

		var document_record = document_records[0];

		if(app.fireEvent('beforeadministrativedocumententeredinerror', me, document_record) === false){
			return;
		}

		if(document_record.get('entered_in_error')){
			app.msg(_('oops'), _('document_entered_in_error'), true);
			return;
		}

		me.setAdministrativeDocumentInError(document_record);

	},

	setAdministrativeDocumentInError: function(document_record){
		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('document_entered_in_error_message'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn == 'yes'){
					var win = me.showAdministrativeDocumentErrorNoteWindow();
					win.down('form').getForm().loadRecord(document_record);
				}
			}
		});
	},

	showAdministrativeDocumentErrorNoteWindow: function(){
		if(!this.getAdministrativeDocumentErrorNoteWindow()){
			Ext.create('App.view.documents.windows.AdministrativeDocumentErrorNote');
		}
		return this.getAdministrativeDocumentErrorNoteWindow().show();
	},

	onAdministrativeDocumentWindowShow: function (win) {
		var panel = win.down('panel');
		this.onAdministrativeDocumentPanelActive(panel, win);
	},

	showAdministrativeDocumentWindow: function (configs) {
		if(!this.getAdministrativeDocumentWindow()){
			configs = configs || {};
			Ext.create('App.view.documents.windows.AdministrativeDocumentWindow', configs);
		}
		return this.getAdministrativeDocumentWindow().show();
	},

	setViewerSite: function(site){
		this.site = site;
	}
});
Ext.define('App.controller.DocumentViewer', {
    extend: 'Ext.app.Controller',
    requires: [
        'App.view.patient.windows.ArchiveDocument'
    ],
    refs: [
        {
            ref: 'DocumentViewerWindow',
            selector: 'documentviewerwindow'
        },
        {
            ref: 'DocumentViewerWindow',
            selector: 'documentviewerwindow > form'
        },
        {
            ref: 'ArchiveDocumentBtn',
            selector: 'documentviewerwindow #archiveDocumentBtn'
        },
        {
            ref: '#documentViewerAddToPrintJobBtn',
            selector: 'documentViewerAddToPrintJobBtn'
        },
        {
            ref: 'ArchiveWindow',
            selector: 'patientarchivedocumentwindow'
        },
        {
            ref: 'ArchiveForm',
            selector: 'patientarchivedocumentwindow > form'
        },
        {
            selector: '#ArchiveDocumentOptionalFieldSet',
            ref: 'ArchiveDocumentOptionalFieldSet'
        }
    ],

    init: function () {
        var me = this;

        me.control({
            'documentviewerwindow': {
                close: me.onViewerDocumentsWinClose
            },
            'documentviewerwindow #archiveDocumentBtn': {
                click: me.onArchiveDocumentBtnClick
            },
            '#documentViewerAddToPrintJobBtn': {
                click: me.onDocumentViewerAddToPrinterJobBtn
            },
            'patientarchivedocumentwindow #archiveBtn': {
                click: me.onArchiveBtnClick
            }
        });
    },

    onArchiveBtnClick: function (btn) {
        var win = btn.up('window'),
            form = win.down('form').getForm(),
            values = form.getValues(),
            docTypeField = form.findField('docTypeCode'),
            // printerCmb = form.findField('printer'),
            // printerRecord = printerCmb.findRecordByValue(printerCmb.getValue()),
            // priority = form.findField('priority').getValue(),
            // printNow = form.findField('printNow').getValue(),
            // number_of_copies = form.findField('number_of_copies').getValue();
            printNow = false;

        if (form.isValid()) {
            values.pid = app.patient.pid;
            values.eid = app.patient.eid;
            values.uid = app.user.id;

            var docTypeRecord = docTypeField.findRecordByValue(values.docTypeCode);
            values.docType = docTypeRecord.get('option_name');

            // scanner archive logic
            if (Ext.getClassName(win.documentWindow) === 'App.view.scanner.Window') {

                var controller = app.getController('Scanner');
                controller.doArchive(values, function (success) {
                    if (success) win.close();
                });

            } else {
                DocumentHandler.transferTempDocument(values, function (response) {
                    if (response.success) {
                        if (window.dual) {
                            window.dual.msg(_('sweet'), 'document_transferred');
                        } else {
                            window.app.msg(_('sweet'), 'document_transferred');
                        }

                        if (win.doAddPrintJobCallback) {
                            win.doAddPrintJobCallback(response.record,null,0,undefined,undefined);
                        }
                        win.documentWindow.close();
                        win.close();
                    } else {
                        say(response);
                        if (window.dual) {
                            window.dual.msg(_('oops'), 'document_transfer_failed', true);
                        } else {
                            window.app.msg(_('oops'), 'document_transfer_failed', true);
                        }
                    }
                });
            }
        }
    },

    onArchiveDocumentBtnClick: function (btn) {
        var win = btn.up('window'),
            values = {
                id: win.documentId,
                docType: win.documentType,
                title: win.documentType + ' ' + _('order')
            };
        var archive_window = Ext.widget('patientarchivedocumentwindow', {
            documentWindow: win,
            doAddPrintJobCallback: undefined
        });

        var form = archive_window.down('form').getForm();
        form.setValues(values);

        //optional fieldset not visible
        archive_window.down('fieldset').setVisible(false);
    },

    onDocumentViewerAddToPrinterJobBtn: function (btn) {
        var win = btn.up('window'),
            values = {
                id: win.documentId,
                docType: win.documentType,
                title: win.documentType + ' ' + _('order')
            };
        var archive_window = Ext.widget('patientarchivedocumentwindow', {
            documentWindow: win,
            doAddPrintJobCallback: this.doAddPrintJob
        });

        archive_window.down('form').getForm().setValues(values);
    },

    doAddPrintJob: function (document, printer_record, print_now, priority, number_of_copies) {
        app.getController('PrintJob').addPrintJob(document.id,printer_record, print_now, priority, number_of_copies);
    },

    onViewerDocumentsWinClose: function (win) {
        DocumentHandler.destroyTempDocument({id: win.documentId});
    },

    doDocumentView: function (id, type, site, closable) {

        var windows = Ext.ComponentQuery.query('documentviewerwindow'),
            src = 'dataProvider/DocumentViewer.php?site=' + (site || app.user.site) + '&id=' + id + '&token=' + app.user.token,
            isTempDoc = (typeof type != 'undefined'),
            win;

        if (isTempDoc){
            src += '&temp=' + type;
        }

        src += '&_dc=' + Ext.Date.now();

        win = Ext.create('App.view.patient.windows.DocumentViewer', {
            documentType: type,
            documentId: id,
            closable: (closable !== undefined ? closable : true),
            items: [
                {
                    xtype: 'miframe',
                    autoMask: false,
                    src: src
                }
            ]
        });

        if(!isTempDoc){
            win.down('#documentViewerAddToPrintJobBtn').hide();
            win.down('#archiveDocumentBtn').hide();
        }


        if (windows.length > 0) {
            var last = windows[(windows.length - 1)];
            for (var i = 0; i < windows.length; i++) {
                windows[i].toFront();
            }
            win.showAt((last.x + 25), (last.y + 5));

        } else {
            win.show();
        }

        return win;
    }


});
Ext.define('App.controller.Notification', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.notifications.Grid'
	],
	refs: [
		{
			ref: 'UserSplitButton',
			selector: '#userSplitButton'
		},
		{
			ref: 'NotificationsGrid',
			selector: 'notificationsgrid'
		}
	],

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				beforerender: me.onViewportBeforeRender
			},
			'#userSplitButton': {
				badgeclick: me.onUserSplitButtonBadgeClick
			},
			'notificationsgrid': {
				itemclick: me.onNotificationsGridItemClick
			},
			'notificationsgrid > header': {
				click: me.onNotificationsGridHeaderClick
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			fields: [
				{
					name: 'id',
					type: 'string'
				},
				{
					name: 'description',
					type: 'string'
				},
				{
					name: 'data',
					type: 'auto'
				},
				{
					name: 'controller',
					type: 'string'
				},
				{
					name: 'method',
					type: 'string'
				}
			]

		});

		me.store.on('add', me.onNotificationAdd, me);
		me.store.on('remove', me.onNotificationRemove, me);

	},

	onNotificationAdd:function(store, records){
		this.setBadgeText(store.count());
	},

	onNotificationRemove:function(store, record){
		this.setBadgeText(store.count());
	},

	onNotificationsGridItemClick: function(grid, record){
		var me = this,
			controller = App.app.getController(record.data.controller),
			method = record.data.method,
			data = record.data.data;

		if(typeof controller == 'object' && typeof controller[method] == 'function'){

			if(data){
				controller[method](data, function(success){
					if(success){
						me.store.remove(record);
					}
					me.doHideNotifications();
				});
			}else{
				controller[method](function(success){
					if(success){
						me.store.remove(record);
					}
					me.doHideNotifications();
				});
			}

		}else{
			me.store.remove(record);
			me.doHideNotifications();
			app.msg(_('oops'), _('notification_handler_error'), true);
		}

	},

	onNotificationsGridHeaderClick: function(){
		this.doHideNotifications();
	},

	onUserSplitButtonBadgeClick: function(btn, text){
		this.doShowNotifications();
	},

	onViewportBeforeRender: function(viewport){
		var me = this;

		me.grid = viewport.add(Ext.widget('notificationsgrid',{
			floatable: true,
			floating: true,
			store: me.store
		}));
	},



	setBadgeText: function(text){
		this.getUserSplitButton().setBadgeText(text);
	},

	getBadgeText: function(){
		this.getUserSplitButton().getBadgeText();
	},

	doHideNotifications: function(){
		this.getNotificationsGrid().collapse(Ext.Component.DIRECTION_TOP, true);
		this.getNotificationsGrid().hide();
		Ext.getBody().un('click', this.doHideNotifications, this);
	},

	doShowNotifications: function(){
		this.grid.showBy(this.getUserSplitButton(), 'tr-br', [-1, 4]);
		this.grid.expand(true);
		this.grid.toFront();
		Ext.getBody().on('click', this.doHideNotifications, this);
	},

	add: function(id, description, data, controller, method){
		var record;
		if(this.store.getById(id)){
			record = this.store.getById(id);
			record.set({
				description: description,
				data: data,
				controller: controller,
				method: method
			});
			record.commit();
			return record;
		}

		record = this.store.add({
			id: id,
			description: description,
			data: data,
			controller: controller,
			method: method
		})[0];

		app.msg(_('new_notification'), description, 'yellow');

		return record;
	},

	remove: function(id){
		if(!this.store.getById(id)) return;
		this.store.remove(this.store.getById(id));
	},

	testNotification:function(data, callback){
		if(typeof callback == 'function'){
			callback(true);
		}
	}

});

Ext.define('App.controller.Scanner', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.scanner.Window',
		'App.view.patient.windows.ArchiveDocument'
	],
	refs: [
		{
			ref: 'DocumentScanWindow',
			selector: '#DocumentScanWindow'
		},
		{
			ref: 'DocumentScanDataViewPanel',
			selector: '#DocumentScanDataViewPanel'
		},
		{
			ref: 'DocumentScanThumbsDataView',
			selector: '#DocumentScanThumbsDataView'
		},
		{
			ref: 'DocumentScanForm',
			selector: '#DocumentScanForm'
		},
		{
			ref: 'DocumentScanSourceCombo',
			selector: '#DocumentScanSourceCombo'
		},
		{
			ref: 'DocumentScanDocTypeCombo',
			selector: '#DocumentScanDocTypeCombo'
		},
		{
			ref: 'DocumentScanProgressBar',
			selector: '#DocumentScanProgressBar'
		},
		{
			ref: 'DocumentScanRemoveDocumentBtn',
			selector: '#DocumentScanRemoveDocumentBtn'
		},


		{
			ref: 'BasicScanWindow',
			selector: '#BasicScanWindow'
		},
		{
			ref: 'BasicScanSourceCombo',
			selector: '#BasicScanSourceCombo'
		},




		// old...
		{
			ref: 'ScannerImageThumbsDataView',
			selector: '#ScannerImageThumbsDataView'
		},
		{
			ref: 'ScannerImageViewer',
			selector: '#ScannerImageViewer'
		},
		{
			ref: 'ScannerImageViewerPanelImage',
			selector: '#ScannerImageViewerPanel image'
		},
		{
			ref: 'ScannerSourceCombo',
			selector: '#ScannerSourceCombo'
		},
		{
			ref: 'ScannerImageScanBtn',
			selector: '#ScannerImageScanBtn'
		},
		{
			ref: 'ScannerImageScanBtn',
			selector: '#ScannerImageScanBtn'
		},
		{
			ref: 'ScannerImageArchiveBtn',
			selector: '#ScannerImageArchiveBtn'
		}
	],

	init: function(){
		var me = this;

		me.documents_defautls = {};
		me.is_chrome_scan = window.chrome && window.chrome.documentScan;

		me.control({
			'#DocumentScanWindow': {
				show: me.onDocumentScanWindowShow,
				close: me.onDocumentScanWindowClose,
				beforeclose: me.onDocumentScanWindowBeforeClose
			},
			'#DocumentScanThumbsDataView': {
				beforeitemcontextmenu: me.onDocumentScanThumbsDataViewBeforeContextMenu,
				selectionchange: me.onDocumentScanThumbsDataViewSelectionChange,
			},
			'#DocumentScanSaveBtn': {
				click: me.onDocumentScanSaveBtnClick
			},
			'#DocumentScanCancelBtn': {
				click: me.onDocumentScanCancelBtnClick
			},
			'#DocumentScanStartScanBtn': {
				click: me.onDocumentScanStartScanBtnClick
			},
			'#DocumentScanRemoveDocumentBtn': {
				click: me.onDocumentScanRemoveDocumentBtnClick
			},


			'#BasicScanWindow': {
				show: me.onBasicScanWindowShow
			},
			'#BasicScanCancelBtn': {
				click: me.onBasicScanCancelBtnClick
			},
			'#BasicScanScanBtn': {
				click: me.onBasicScanScanBtnClick
			},

		});

		me.helperCtrl = me.getController('App.controller.BrowserHelper');

	},

	onBasicScanWindowShow: function (win){

		var progress_bar = win.down('progressbar');
		progress_bar.reset();
		progress_bar.updateProgress(0);
		progress_bar.updateText('');

		this.doScannerComboLoad(win.down('#BasicScanSourceCombo'));
	},

	onBasicScanCancelBtnClick: function (btn){
		this.getBasicScanWindow().close();
	},

	onBasicScanScanBtnClick: function (btn){

		var me = this,
			win = btn.up('window'),
			cmb = win.down('#BasicScanSourceCombo'),
			landscape = win.down('#BasicScanLandscapeCheckbox').getValue(),
			options = [];

		if(!cmb.isValid()){
			return;
		}

		if(landscape){
			options.push('CAP_ORIENTATION_LANDSCAPE');
		}

		if(win.scan_options && win.scan_options.length > 0){
			options = Ext.Array.merge(options, win.scan_options);
		}

		me.doScan(win, cmb.getValue(), options, win.scan_callback);
	},


	doScan: function (win, scannerId, options, callback) {
		var me = this;

		if(!me.is_chrome_scan){

			var progress_bar = win.down('progressbar');

			progress_bar.wait({
				interval: 100,
				duration: (60 * 1000),
				increment: 10,
				text: _('scanning') + '...',
				fn: function(){
					progrss_bar.updateText(_('no_document_scanned'));
				}
			});

			me.helperCtrl.sendMessage({
				action: 'scan',
				data: scannerId,
				options: options.join('|')
			}, function (response) {

				progress_bar.reset();

				if(response.documents && response.documents.length > 0){
					if(callback){
						win.close();
						callback(response.documents);
					}else{
						me.loadDocuments(response.documents, false);
					}
					progress_bar.updateProgress(1, response.documents.length + ' ' + _('documents_scanned'));

				} else {

					if(response.error && response.error != ''){
						app.msg(_('oops'), response.error, true);
						say(response.error);
						progress_bar.updateProgress(0, response.error);
					} else {
						progress_bar.updateProgress(0, _('no_document_scanned'));
					}

					if(response.stacktrace && response.stacktrace != ''){
						say(response.stacktrace);
					}
					return;
				}

				if(response.error && response.error != ''){
					progress_bar.reset();
					progress_bar.updateProgress(0, response.error);
					say(response.error)
				}

			});
		}else {
			chrome.documentScan.scan({ maxImages: 10 }, function(result){
				if(callback){
					callback(result.dataUrls);
				}else{
					me.loadDocuments(result.dataUrls, true);
				}
			});
		}

	},

	loadDocuments: function (data, mime_type_included) {

		var me = this,
			form = me.getDocumentScanForm().getForm(),
			values = form.getValues(),
			docTypeCmb = me.getDocumentScanDocTypeCombo(),
			view = me.getDocumentScanThumbsDataView(),
			store = view.getStore(),
			documents = [];

		data.forEach(function (document) {
			Ext.Array.push(documents, {
				pubpid: app.patient.pubpid,
				pid: app.patient.pid,
				eid: app.patient.eid,
				uid: app.user.id,
				global_id: app.uuidv4(),
				facility_id: app.user.facility,
				docType: docTypeCmb.findRecordByValue(values.docTypeCode).get('option_name'),
				docTypeCode: values.docTypeCode,
				date: app.getDate(),
				title: values.title,
				error_note: '',
				document: mime_type_included ? document : ('data:image/jpeg;base64,' + document)
			});
		});

		store.loadData(documents, true);
		view.refresh();
	},

	onDocumentScanStartScanBtnClick: function(btn){

		var me = this,
			win = btn.up('window'),
			form = this.getDocumentScanForm().getForm(),
			values = form.getValues(),
			options = [];

		if(!form.isValid()) return;

		if(values.duplex == '1'){
			options.push('CAP_DUPLEX_ENABLED');
		}
		if(values.color == '1'){
			options.push('CAP_PIXEL_TYPE_RBG');
		}
		if(values.landscape == '1'){
			options.push('CAP_ORIENTATION_LANDSCAPE');
		}
		if(values.resolution == '1'){
			options.push('CAP_RESOLUTION_NORMAL');
		}
		if(values.resolution == '2'){
			options.push('CAP_RESOLUTION_HIGH');
		}

		me.doScan(win, values.scannerId, options);

	},

	onDocumentScanWindowShow: function(win){
		if(this.is_chrome_scan) return;

		var progress_bar = this.getDocumentScanProgressBar();
		progress_bar.reset();
		progress_bar.updateProgress(0);
		progress_bar.updateText('');

		this.doScannerComboLoad(win.down('#DocumentScanSourceCombo'));
	},

	onDocumentScanWindowClose: function(win){
		win.skip_validation = false;
		this.getDocumentScanThumbsDataView().store.removeAll();
		this.getDocumentScanThumbsDataView().store.commitChanges();
	},

	onDocumentScanWindowBeforeClose: function(win){
		if(win.skip_validation === true || this.allArchived()){
			return true;
		}else{
			Ext.Msg.show({
				title: _('wait'),
				msg: _('document_not_archived_error'),
				buttons: Ext.Msg.YESNO,
				icon: Ext.Msg.QUESTION,
				fn: function (btn) {
					if(btn == 'yes'){
						win.skip_validation = true;
						win.close();
					}
				}
			});

			return false;
		}
	},

	onDocumentScanSaveBtnClick: function(){

		var me = this,
			win = me.getDocumentScanWindow(),
			scan_documents_view = me.getDocumentScanThumbsDataView(),
			scan_documents_store = scan_documents_view.getStore(),
			scan_documents_records = scan_documents_store.data.items;

		if(me.allArchived()) {
			app.msg(_('oops'), 'Nothing to save', true);
			return;
		}

		if(win.default_values){
			scan_documents_records.forEach(function (scan_documents_record){
				scan_documents_record.set(win.default_values);
			});
		}

		if(app.fireEvent('beforescandocumentssave', this, scan_documents_records) === false) return;

		win.mask(_('please_wait'));

		scan_documents_store.sync({
			success: function () {

				app.fireEvent('scandocumentssave', this, scan_documents_records);

				scan_documents_store.removeAll();
				scan_documents_store.commitChanges();
				win.unmask();
				win.close();
			},
			failure: function () {

				app.msg(_('oops'), _('record_error'), true);
				win.unmask();
				win.close();
			}
		});
	},

	onDocumentScanCancelBtnClick: function(){
		this.getDocumentScanWindow().close();
	},

	onDocumentScanThumbsDataViewBeforeContextMenu: function(view, record, item, index, e, eOpts ){
		e.preventDefault();
	},

	onDocumentScanThumbsDataViewSelectionChange: function(sm, selection){
		this.getDocumentScanRemoveDocumentBtn().setDisabled(selection.length === 0);
	},

	onDocumentScanRemoveDocumentBtnClick: function(){

		var me = this,
			scan_documents_view = me.getDocumentScanThumbsDataView(),
			scan_documents_store = scan_documents_view.getStore(),
			scan_documents_record = scan_documents_view.getSelectionModel().getLastSelected();

		scan_documents_store.remove(scan_documents_record);

	},

	showDocumentScanWindow: function(default_values, scan_callback){

		if(!this.is_chrome_scan && !this.helperCtrl.connected){
			app.msg(_('oops'), _('browser_helper_not_connected'), true);
			return false;
		}

		if(!this.getDocumentScanWindow()){
			Ext.create('App.view.scanner.DocumentScanWindow');
		}

		this.getDocumentScanWindow().default_values = default_values;
		this.getDocumentScanWindow().scan_callback = scan_callback;
		this.getDocumentScanWindow().skip_validation = false;

		return this.getDocumentScanWindow().show();
	},

	showBasicScanWindow: function(options, callback){

		if(!this.helperCtrl.connected){
			app.msg(_('oops'), _('browser_helper_not_connected'), true);
			return false;
		}

		if(!this.getBasicScanWindow()){
			Ext.create('App.view.scanner.BasicScanWindow');
		}

		this.getBasicScanWindow().scan_options = options;
		this.getBasicScanWindow().scan_callback = callback;

		return this.getBasicScanWindow().show();
	},

	doScannerComboLoad: function (cmb) {
		var me = this;

		me.helperCtrl.sendMessage(
			{
				action: 'scanner/list'
			}, function (response) {

				if(response){

					say(response);

					cmb.store.loadRawData(response);

					if(!cmb.getValue()) {
						cmb.select(cmb.store.getAt(0));
					}
				}
			});
	},

	allArchived: function () {
		var store = this.getDocumentScanThumbsDataView().store;
		return store.data.items.length == 0;
	},

});

Ext.define('App.controller.patient.Documents', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.patient.windows.UploadDocument'
	],
	refs: [
		{
			ref: 'PatientDocumentPanel',
			selector: 'patientdocumentspanel'
		},
		{
			ref: 'PatientDocumentGrid',
			selector: 'patientdocumentspanel #patientDocumentGrid'
		},
		{
			ref: 'PatientDocumentViewerFrame',
			selector: 'patientdocumentspanel #patientDocumentViewerFrame'
		},
		{
			ref: 'PatientDocumentUploadWindow',
			selector: '#patientDocumentUploadWindow'
		},
		{
			ref: 'PatientDocumentUploadScanBtn',
			selector: '#patientDocumentUploadWindow #scanBtn'
		},
		{
			ref: 'PatientDocumentUploadFileUploadField',
			selector: '#patientDocumentUploadWindow #fileUploadField'
		},
		{
			ref: 'DocumentHashCheckBtn',
			selector: '#documentHashCheckBtn'
		},
		{
			ref: 'DocumentHashCheckBtn',
			selector: '#documentHashCheckBtn'
		},
		{
			ref: 'AddDocumentBtn',
			selector: 'patientdocumentspanel #addDocumentBtn'
		},
		{
			ref: 'DocumentUploadBtn',
			selector: 'patientdocumentspanel #documentUploadBtn'
		},
		{
			ref: 'DocumentUploadBtn',
			selector: 'patientdocumentspanel #documentUploadBtn'
		},
		{
			ref: 'DocumentScanBtn',
			selector: 'patientdocumentspanel #documentScanBtn'
		},
		{
			ref: 'PatientDocumentErrorNoteWindow',
			selector: 'patientdocumenterrornotewindow'
		},
		{
			ref: 'PatientDocumentViewerOpacityField',
			selector: 'PatientDocumentViewerOpacityField'
		},
		{
			ref: 'DocumentWindow',
			selector: '#DocumentWindow'
		}
	],

	scannedDocument: null,

	init: function(){
		var me = this;

		// me.onPatientDocumentGridBeforeRefreshBuffered = Ext.Function.createBuffered(me.onPatientDocumentGridBeforeRefresh, 100, me);

		me.control({
			'viewport': {
				browserhelperopen: me.onBrowserHelperOpen,
				browserhelperclose: me.onBrowserHelperClose,
				documentedit: me.onDocumentEdit
			},
			'patientdocumentspanel': {
				activate: me.onPatientDocumentPanelActive,
				beforerender: me.onPatientDocumentBeforeRender
			},
			'patientdocumentspanel #patientDocumentGrid': {
				selectionchange: me.onPatientDocumentGridSelectionChange,
				afterrender: me.onPatientDocumentGridAfterRender,
				beforerender: me.onPatientDocumentGridBeforeRender,
				beforeitemcontextmenu: me.onPatientDocumentGridBeforeItemContextMenu
			},
			'patientdocumentspanel #patientDocumentGrid gridview': {
				beforedrop: me.onPatientDocumentGridViewBeforeDrop,
				drop: me.onPatientDocumentGridViewDrop,
			},
			// 'patientdocumentspanel #patientDocumentGrid gridview': {
			// 	beforerefresh: me.onPatientDocumentGridBeforeRefresh
			// },
			'patientdocumentspanel [toggleGroup=documentgridgroup]': {
				toggle: me.onDocumentGroupBtnToggle
			},
			'patientdocumentspanel #documentGroupBtn': {
				toggle: me.onDocumentGroupBtnToggle
			},
			'patientdocumentspanel #documentUploadBtn': {
				click: me.onDocumentUploadBtnClick
			},
			'patientdocumentspanel #documentScanBtn': {
				click: me.onDocumentScanBtnClick
			},
			'#patientDocumentUploadWindow': {
				show: me.onPatientDocumentUploadWindowShow
			},
			'#patientDocumentUploadWindow #uploadBtn': {
				click: me.onDocumentUploadSaveBtnClick
			},
			'#PatientDocumentGridGroupBtn': {
				beforerender: me.onPatientDocumentGridGroupBtnBeforeRender
			},
			'#PatientDocumentGridGroupBtn menucheckitem': {
				checkchange: me.onPatientDocumentGridGroupBtnCheckChange
			},
			'#DocumentErrorNoteSaveBtn': {
				click: me.onDocumentErrorNoteSaveBtnClick
			},
			'#PatientDocumentViewerOpacityField': {
				afterrender: me.onPatientDocumentViewerOpacityFieldAfterRender,
				change: me.onPatientDocumentViewerOpacityFieldChange
			},
			'#patientDocumentViewerFrame': {
				render: me.onPatientDocumentViewerFrameRender
			},
			'#PatientDocumentEnteredInErrorBtn': {
				click: me.onPatientDocumentEnteredInErrorBtnClick
			},
			'#EncounterPatientDocumentsBtn': {
				click: me.onEncounterPatientDocumentsBtnClick
			},
			'#DocumentWindow': {
				show: me.onDocumentWindowShow
			}
		});

		me.nav = this.getController('Navigation');

		me.document_group_menu = [];
		me.document_groups = {};

		CombosData.getOptionsByListId({list_key : 'doc_type_cat'}, function (groups){
			groups.forEach(function (group){

				var stateId = ((group.option_value+ '-' + group.option_name + '_').replace(' ', '_') + app.user.id),
					state = Ext.state.Manager.get(stateId, {});

				me.document_groups[group.option_value] = state.checked || false;

				me.document_group_menu.push({
					xtype: 'menucheckitem',
					text: group.option_value + ' - ' + group.option_name,
					stateful: true,
					stateId: stateId,
					_document_group: group.option_value
				});
			});
		});

	},

	onPatientDocumentGridViewBeforeDrop: function (node, data, over_record, drop_position) {
		// say('onPatientDocumentGridViewBeforeDrop');
		// say(node);
		// say(data);
		// say(over_record);
		// say(drop_position);

		if(data.records.length === 0) {
			return false;
		}

		// id validation
		if(!a('allow_document_drag_drop')){
			app.msg(_('oops'), 'Unable to Edit, Not Authorized to Drag & Drop Document', true);
			return false;
		}

		// id validation
		if(data.records[0].get('id') <= 0){
			app.msg(_('oops'), 'Unable to Edit, Document is not a stored document', true);
			return false;
		}
		// ZZZ "ENTERED IN ERROR" validation
		if(data.records[0].get('docTypeCode') === 'ZZZ'){
			app.msg(_('oops'), 'Unable to Edit, Document entered in error', true);
			return false;
		}

		// Drop outside group
		if(data.records[0].get('docType') === ''){
			app.msg(_('oops'), 'Unable to Edit, Please drop the document inside group', true);
			return false;
		}

		// Drop  different group
		if(data.records[0].get('docTypeCode') === over_record.get('docTypeCode')){
			app.msg(_('oops'), 'Please drop the document inside a different group', true);
			return false;
		}

	},

	onPatientDocumentGridViewDrop: function (node, data, over_record, drop_position) {
		// say('onPatientDocumentGridViewDrop');
		// say(node);
		// say(data);
		// say(over_record);
		// say(drop_position);

		data.records[0].set({
			docTypeCode: over_record.get('docTypeCode'),
			docType: over_record.get('docType'),
			date: data.records[0].get('date')
		});

		data.records[0].store.sync();

	},

	onPatientDocumentGridBeforeRefresh: function (grid){
		var me = this,
			groups = grid.store.getGroups(),
			v = grid.view;

		if(groups.length === 0){
			return;
		}

		groups.forEach(function (group){
			try{
				if(me.document_groups[group.name]){
					v.summaryFeature.expand(group.name);
				}else{
					v.summaryFeature.collapse(group.name);
				}
			}catch (e){
				say('Document Group Collapse/Expand Error');
				say(e);
			}
		});
		},

	onPatientDocumentGridGroupBtnBeforeRender: function (btn){
		btn.menu.add(Ext.clone(this.document_group_menu));
	},

	onPatientDocumentGridGroupBtnCheckChange: function (btn){
		this.document_groups[btn._document_group] = btn.checked;
	},

	onEncounterPatientDocumentsBtnClick: function () {
		this.showDocumentWindow();
	},

	onDocumentWindowShow: function (win) {
		var panel = win.down('panel');
		this.onPatientDocumentPanelActive(panel);
	},

	showDocumentWindow: function (configs) {
		if(!this.getDocumentWindow()){
			configs = configs || {};
			Ext.create('App.view.patient.windows.DocumentWindow', configs);
		}
		return this.getDocumentWindow().show();
	},

	onPatientDocumentEnteredInErrorBtnClick: function (btn) {

		var me = this,
			sm = btn.up('grid').getSelectionModel(),
			document_records = sm.getSelection();

		if(document_records.length === 0) return;

		var document_record = document_records[0];

		if(app.fireEvent('beforedocumententeredinerror', me, document_record) === false){
			return;
		}

		if(document_record.get('entered_in_error')){
			app.msg(_('oops'), _('document_entered_in_error'), true);
			return;
		}

		me.setDocumentInError(document_record);

	},

	onPatientDocumentViewerFrameRender:function (frame) {
		var field = frame.up('panel').query('#PatientDocumentViewerOpacityField')[0];
		if(field) this.setOpacity(frame, field.getValue());
	},

	onPatientDocumentViewerOpacityFieldAfterRender: function (field) {
		field.el.set({'data-qtip': _('document_brightness')});
	},

	onPatientDocumentViewerOpacityFieldChange: function (feild, value) {
		var frame = feild.up('panel').query('#patientDocumentViewerFrame')[0];
		if(frame) this.setOpacity(frame, value);
	},

	setOpacity: function (frame, opacity) {
		frame.el.applyStyles({ opacity: opacity });
	},

	onPatientDocumentGridBeforeItemContextMenu: function (grid, record, item, index, e, eOpts) {
		var me = this,
		activePanelCls = this.getController('Navigation').getUrlCls();

		if(activePanelCls !== 'App.view.patient.Summary') return;

		e.preventDefault();
		Ext.Msg.show({
			title:'C-CDA',
			msg: 'Would you like to view the raw xml data?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if (btn === 'yes'){
					var frame = grid.up('panel').up('panel').query('#patientDocumentViewerFrame')[0];

					if(record){
						frame.setSrc('dataProvider/DocumentViewer.php?site=' + me.site + '&token=' + app.user.token + '&id=' + record.data.id + '&rawXml');
					}
				}
			}
		});
	},

	setDocumentInError: function(document_record){
		var me = this;

		Ext.Msg.show({
			title: _('wait'),
			msg: _('document_entered_in_error_message'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn == 'yes'){
					var win = me.showPatientDocumentErrorNoteWindow();
					win.down('form').getForm().loadRecord(document_record);
				}
			}
		});
	},

	onDocumentErrorNoteSaveBtnClick: function(){
		var me = this,
			win = me.getPatientDocumentErrorNoteWindow(),
			form = win.down('form').getForm(),
			values = form.getValues(),
			document_record = form.getRecord(),
			site = document_record.site ? document_record.site : null;

		if(form.isValid()){
			values.entered_in_error = true;
			values.site = site;
			document_record.set(values);
			document_record.save({
				success: function(){
					win.close();
					document_record.set({groupDate:''});
					document_record.commit();
				}
			});
		}
	},

	showPatientDocumentErrorNoteWindow: function(){
		if(!this.getPatientDocumentErrorNoteWindow()){
			Ext.create('App.view.patient.windows.DocumentErrorNote');
		}
		return this.getPatientDocumentErrorNoteWindow().show();
	},

	onPatientDocumentBeforeRender: function(panel){
		this.setViewerSite(app.user.site);
		panel.defereOnActiveReload = false;
	},

	onDocumentEdit: function(data){

		var store = this.getPatientDocumentGrid().getStore(),
			record = store.getById(data.save.id);

		if(record){
			var src = data.save.document.split(','),
				document = src[1] || src[0],
				record_data;

			record.set({ document: document });

			record_data = record.data;
			record_data.edit_document = true;

			DocumentHandler.updatePatientDocument(record_data, function (response) {

				record.commit();

				if(window.dual){
					dual.msg('sweet', _('record_saved'));
				}else{
					app.msg('sweet', _('record_saved'));
				}

			});

		}
	},

	onBrowserHelperOpen: function(){
		if(this.getDocumentScanBtn()){
			this.getDocumentScanBtn().show();
		}
	},

	onBrowserHelperClose: function(){
		if(this.getDocumentScanBtn()){
			this.getDocumentScanBtn().hide();
		}
	},

	onPatientDocumentUploadWindowShow: function(){
		this.scannedDocument = null;
		this.getPatientDocumentUploadFileUploadField().enable();
		this.getPatientDocumentUploadScanBtn().setVisible(this.getController('Scanner').conencted);
	},

	onPatientDocumentGridSelectionChange: function(sm, selection){
		var frame = sm.view.panel.up('panel').query('#patientDocumentViewerFrame')[0];

		if(selection.length === 0 || selection[selection.length - 1].get('disabled_selection')){
			frame.setSrc('about:blank');
		}else{
			frame.setSrc('dataProvider/DocumentViewer.php?site=' + this.site + '&token=' + app.user.token + '&id=' + selection[selection.length - 1].data.id + '&_dc=' + Ext.Date.now());
		}
	},

	onPatientDocumentGridAfterRender: function (container) {
		if(eval(a('allow_document_drag_drop_upload'))) {
			this.initDocumentDnD(container);
		}
	},

	onPatientDocumentGridBeforeRender: function (grid) {
		grid.store.on('load', function (store){
			this.onPatientDocumentGridBeforeRefresh(grid, store);
		}, this);
	},

	onPatientDocumentPanelActive: function(panel){
		var me = this,
			grid = panel.down('grid'),
			store = grid.getStore(),
			params = me.nav.getExtraParams();

		me.activePAnel = panel;

		if(params && params.document){
			store.on('load', me.doSelectDocument, me);
		}

		if(panel.defereOnActiveReload) return;

		me.doPatientDocumentReload(panel);
	},

	doPatientDocumentReload: function(panel, pid){
		var me = this,
			grid = panel.down('grid'),
			store = grid.getStore();

		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: pid || app.patient.pid
			}
		]);
	},

	doSelectDocument: function(store){
		var me = this,
			grid = me.activePAnel.down('grid'),
			params = me.nav.getExtraParams();

		var doc = store.getById(params.document);
		if(doc){
			grid.getSelectionModel().select(doc);

		}else{
			app.msg(_('oops'), _('unable_to_find_document'), true);
		}
		store.un('load', me.doSelectDocument, me);
	},

	onDocumentGroupBtnToggle: function(btn, pressed){
		var grid = btn.up('grid'),
			selector = '#' + btn.action,
			header = grid.headerCt.down(selector);

		if(pressed){
			grid.getStore().group(btn.action);
			header.hide();
			btn.disable();
		}else{
			header.show();
			btn.enable();
		}
	},

	onDocumentScanBtnClick: function (btn) {
		var documents_grid = btn.up('grid');

		this.getController('Scanner').showDocumentScanWindow(undefined, function (documents){
			if(documents){
				documents_grid.add(documents);
			}
		});
	},

	onDocumentUploadBtnClick: function(){
		this.setDocumentUploadWindow('click');
	},

	setDocumentUploadWindow: function(action){
		var record = this.getNewPatientDocumentRecord(),
			win = this.getUploadWindow(action);
		win.down('form').getForm().loadRecord(record);
		return win;
	},

	getNewPatientDocumentRecord: function(){
		return Ext.create('App.model.patient.PatientDocuments', {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			facility_id: app.user.facility,
			date: new Date()
		})
	},

	getGroupName: function(store, record){
		var group = store.groupers.items[0].property;

		if(group === 'docTypeCode'){
			return Ext.String.capitalize(record.get('docTypeCode') + ' - ' + record.get('docType'));
		}else{
			return record.get('groupDate');
		}
	},

	onDocumentHashCheckBtnClick: function(grid, rowIndex){
		var rec = grid.getStore().getAt(rowIndex);

		DocumentHandler.checkDocHash(rec.data, function(provider, response){

			var message = Ext.String.htmlDecode(response.result.msg);

			Ext.Msg.show({
				title: _('document_hash'),
				msg: message,
				buttons: Ext.Msg.OK,
				icon: Ext.Msg.INFO
			});
		});
	},

	getUploadWindow: function(action){
		return Ext.create('App.view.patient.windows.UploadDocument', {
			action: action,
			itemId: 'patientDocumentUploadWindow'
		})
	},

	onDocumentUploadSaveBtnClick: function(){
		var me = this,
			win = me.getPatientDocumentUploadWindow(),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			values = form.getValues(),
			reader = new FileReader(),
			uploadField = form.findField('document');

		if(!form.isValid()) return;

		record.set(values);

		if(win.action == 'click'){
			var uploadValue = uploadField.getValue();
			record.set({name: uploadValue});

			if(me.scannedDocument){
				record.set({document: me.scannedDocument});
				me.doNewDocumentRecordSave(record);
			}else{
				reader.onload = function(e){
					record.set({document: e.target.result});
					me.doNewDocumentRecordSave(record);
				};
				reader.readAsDataURL(uploadField.extractFileInput().files[0]);
			}
		}else{
			me.doNewDocumentRecordSave(record);
		}
	},

	onDocumentUploadScanBtnClick: function(){
		var me = this,
			scanCtrl = this.getController('Scanner');

		scanCtrl.initScan();
		app.on('scancompleted', this.onScanCompleted, me);
	},

	onScanCompleted: function(controller, document){
		var me = this,
			win = me.getPatientDocumentUploadWindow(),
			form = win.down('form').getForm(),
			uploadField = form.findField('document');

		uploadField.disable();

		me.scannedDocument = document;
		app.un('scancompleted', this.onScanCompleted, me);
	},

	doNewDocumentRecordSave: function(record){
		var me = this,
			store = me.getPatientDocumentGrid().getStore(),
			index = store.indexOf(record);

		record.set({facility_id: app.user.facility});

		if(index == -1){
			store.add(record);
		}

		store.sync({
			success: function(){
				app.msg(_('sweet'), _('document_added'));
				me.getPatientDocumentUploadWindow().close();
				me.getPatientDocumentGrid().getSelectionModel().select(record);

			},
			failure: function(){
				store.rejectChanges();
				if(window.dual){
					dual.msg(_('oops'), _('document_error'), true);
				}else{
					app.msg(_('oops'), _('document_error'), true);
				}
			}
		})
	},

	initDocumentDnD: function(grid){
		var me = this;

		me.dnding = false;

		grid.on({
			drop: {
				element: 'el',
				fn: me.documentDrop,
				scope: me
			},
			dragstart: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragenter: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragover: {
				element: 'el',
				fn: me.documentAddDropZone
			},
			dragleave: {
				element: 'el',
				fn: me.documentRemoveDropZone
			},
			dragexit: {
				element: 'el',
				fn: me.documentRemoveDropZone
			}
		});
	},

	documentDrop: function (e) {
		var me = this;
		e.stopEvent();

		var files = Ext.Array.from(e.browserEvent.dataTransfer.files);
		me.fileHandler(files[0]);

		Ext.get(e.target).removeCls('drag-over');

	},

	documentAddDropZone: function (e) {
		if (!e.browserEvent.dataTransfer || Ext.Array.from(e.browserEvent.dataTransfer.types).indexOf('Files') === -1) {
			return;
		}
		e.stopEvent();

		this.addCls('drag-over');
	},

	documentRemoveDropZone: function (e) {

		var el = e.getTarget(),
			thisEl = this.el;

		e.stopEvent();

		if (el === thisEl.dom) {
			this.removeCls('drag-over');
			return;
		}

		while (el !== thisEl.dom && el && el.parentNode) {
			el = el.parentNode;
		}

		if (el !== thisEl.dom) {
			this.removeCls('drag-over');
		}
	},

	fileHandler: function(file){
		var me = this,
			win = me.setDocumentUploadWindow('drop'),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			reader = new FileReader(),
			uploadField = form.findField('document');

		uploadField.hide();
		uploadField.disable();

		reader.onload = function(e){
			record.set({
				document: e.target.result,
				name: file.name
			});
		};

		reader.readAsDataURL(file);
	},

	setViewerSite: function(site){
		this.site = site;
	}
});
Ext.define('App.controller.patient.LabOrders', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.patient.windows.UploadDocument'
	],
	refs: [
		{
			ref: 'LabOrdersGrid',
			selector: 'patientlaborderspanel'
		},
		{
			ref: 'ElectronicLabOrderBtn',
			selector: 'patientlaborderspanel #electronicLabOrderBtn'
		},
		{
			ref: 'NewLabOrderBtn',
			selector: 'patientlaborderspanel #newLabOrderBtn'
		},
		{
			ref: 'PrintLabOrderBtn',
			selector: 'patientlaborderspanel #printLabOrderBtn'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientlaborderspanel': {
				activate: me.onLabOrdersGridActive,
				selectionchange: me.onLabOrdersGridSelectionChange,
				beforerender: me.onLabOrdersGridBeforeRender,
				validateedit: me.onLabOrdersGridValidateEdit
			},
			'#rxLabOrderLabsLiveSearch': {
				select: me.onLoincSearchSelect
			},
			'patientlaborderspanel #electronicLabOrderBtn': {
				click: me.onElectronicLabOrderBtnClick
			},
			'patientlaborderspanel #newLabOrderBtn': {
				click: me.onNewLabOrderBtnClick
			},
			'patientlaborderspanel #printLabOrderBtn': {
				click: me.onPrintLabOrderBtnClick
			},
			'#LabOrdersUnableToPerformField': {
				select: me.onLabOrdersUnableToPerformFieldSelect,
				fieldreset: me.onLabOrdersUnableToPerformFieldReset
			}
		});

		me.encounterCtl = me.getController('patient.encounter.Encounter');

	},

	onOrdersDeleteActionHandler: function (grid, rowIndex, colIndex, item, e, record) {

		if(!a('remove_patient_order')){
			app.msg(_('oops'), _('not_authorized'), true);
			return;
		}

		var me = this,
			store = grid.getStore();

		Ext.Msg.show({
			title: _('wait'),
			msg: ('<b>' + record.get('description') + '</b><br><br>' + _('delete_this_record')),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn1) {
				if(btn1 === 'yes'){
					Ext.Msg.show({
						title: _('wait'),
						msg: _('this_action_can_not_be_undone_continue'),
						buttons: Ext.Msg.YESNO,
						icon: Ext.Msg.QUESTION,
						fn: function (btn2) {
							if(btn2 === 'yes'){
								store.remove(record);
								store.sync({
									callback: function () {
										store.remove(record);
										store.sync({
											callback: function () {

											}
										});
									}
								});
							}
						}
					});
				}
			}
		});
	},

	onLabOrdersGridValidateEdit: function(plugin, context){
		var form = plugin.editor.getForm(),
			combo = form.findField('description'),
			combo_value = combo.getValue(),
			selected_record = combo.findRecordByValue(combo_value);

		if(combo_value === null){
			context.record.set({
				code: null,
				description: null,
			});
		}else if(selected_record){
			context.record.set({
				code: selected_record.get('loinc_number'),
				code_type: 'LOINC',
				description: selected_record.get('loinc_name')
			});
		}
	},

	onLabOrdersUnableToPerformFieldSelect: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord(),
			selected_record = combo.findRecordByValue(combo.getValue());

		form_record.set({
			not_performed_code: selected_record.get('code'),
			not_performed_code_type: selected_record.get('code_type'),
			not_performed_code_text: selected_record.get('option_name'),
		});
	},

	onLabOrdersUnableToPerformFieldReset: function(combo){
		var form = combo.up('form').getForm(),
			form_record = form.getRecord();
		combo.setValue(null);
		form_record.set({
			not_performed_code: null,
			not_performed_code_type: null,
			not_performed_code_text: null,
		});
	},

	onLabOrdersGridBeforeRender: function(grid){
		app.on('patientunset', function(){
			grid.editingPlugin.cancelEdit();
			grid.getStore().removeAll();
		});
	},

	onLabOrdersGridSelectionChange: function(sm, selected){
		this.getPrintLabOrderBtn().setDisabled(selected.length === 0);
	},

	onLoincSearchSelect: function(cmb, records){
		var form = cmb.up('form').getForm();

		form.getRecord().set({code: records[0].data.loinc_number});
		if(form.findField('code')) form.findField('code').setValue(records[0].data.loinc_number);
		if(form.findField('note')) form.findField('note').focus(false, 200);
	},

	onElectronicLabOrderBtnClick: function(){
		// say('TODO!');
	},

	onNewLabOrderBtnClick: function(){
		var me = this,
			grid = me.getLabOrdersGrid(),
			store = grid.getStore();

		grid.editingPlugin.cancelEdit();
		store.insert(0, {
			pid: app.patient.pid,
			eid: app.patient.eid,
			uid: app.user.id,
			date_ordered: new Date(),
			order_type: 'lab',
			status: 'Pending',
			priority: 'Normal'
		});
		grid.editingPlugin.startEdit(0, 0);
	},

	onPrintLabOrderBtnClick: function(input, print){
		var me = this,
			grid = me.getLabOrdersGrid(),
			orders = (Ext.isArray(input) ? input : grid.getSelectionModel().getSelection()),
			documents = {};

		orders.forEach(function(order){
			var date_ordered = Ext.Date.format(order.get('date_ordered'),'Y-m-d'),
				pdf_format = (g('order_pdf_format') || null),
				doc_key = '_' + order.get('eid') + order.get('pid') + order.get('uid') + date_ordered;

			if(order.get('void')){
				app.msg(_('oops'), Ext.String.format('Unable to print voided order #{0}', order.get('id')), true);
				return;
			}

			if(!documents[doc_key]){
				documents[doc_key] = {};
				documents[doc_key].pid = order.get('pid');
				documents[doc_key].eid = order.get('eid');
				documents[doc_key].date_ordered = date_ordered;
				documents[doc_key].provider_uid = order.get('uid');
				documents[doc_key].orderItems = [];
				documents[doc_key].docType = 'Lab';
				documents[doc_key].templateId = 4;
				documents[doc_key].pdf_format = pdf_format;
				documents[doc_key].dx_required = false;
				documents[doc_key].orderItems.push(['Description', 'Notes']);
			}

			documents[doc_key].orderItems.push([
				order.get('description') + ' [' + order.get('code_type') + ':' + order.get('code') + ']',
				order.get('note')
			]);
		});

		if(Ext.Object.isEmpty(documents)){
			return;
		}

		Ext.Object.each(documents, function(key, params){
			DocumentHandler.createTempDocument(params, function(response){

				if(Ext.isString(response)){
					app.msg(_('oops'), response, true);
					return;
				}

				if(print === true){
					Printer.doTempDocumentPrint(1, response.id);
				}else{
					if(window.dual){
						dual.onDocumentView(response.id, 'Lab');
					}else{
						app.onDocumentView(response.id, 'Lab');
					}
				}
			});
		});
	},

	onLabOrdersGridActive:function(grid){
		var store = grid.getStore();

		if(!grid.editingPlugin.editing){
			store.clearFilter(true);
			store.filter([
				{
					property: 'pid',
					value: app.patient.pid
				},
				{
					property: 'order_type',
					value: 'lab'
				},
				{
					property: 'is_external_order',
					value: 0
				}
			]);
		}
	},

	labOrdersGridStatusColumnRenderer:function(v){
		var color = 'black';

		switch(v){
			case 'Canceled':
				color = 'red';
				break;
			case 'Pending':
				color = 'orange';
				break;
			case 'Routed':
				color = 'blue';
				break;
			case 'Complete':
				color = 'green';
				break;
			default:
				color = '';
		}

		return '<div style="color:' + color + '">' + v + '</div>';
	},

	doAddOrderByTemplate: function(data){
		var me = this,
			grid = me.getLabOrdersGrid(),
			store = grid.getStore();

		data.pid = app.patient.pid;
		data.eid = app.patient.eid;
		data.uid = app.user.id;
		data.date_ordered = new Date();
		data.order_type = 'lab';
		data.status = 'Pending';
		data.priority = 'Normal';

		var record = store.add(data)[0];

		record.save({
			success: function(){
				app.msg(_('sweet'), data.description + ' ' + _('added'));
			}
		});
	}
});

Ext.define('App.controller.patient.ReviewOfSystem', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.model.administration.ReviewOfSystemSettings'
	],
	refs: [
		{
			ref:'ReviewOfSystemSetupBtn',
			selector: '#ReviewOfSystemSetupBtn'
		},
		{
			ref:'ReviewOfSystemForm',
			selector: '#ReviewOfSystemForm'
		}
	],

	reviewOfSystemSetupWindow: undefined,
	reviewOfSystemSetup: {
		id: null,
		user_id: 0,
		settings_data: {}
	},

	init: function(){
		var me = this;

		me.control({
			'viewport': {
				render: me.onViewportRender
			},
			'#ReviewOfSystemForm': {
				beforerender: me.onReviewOfSystemFormBeforeRender
			},
			'#ReviewOfSystemSetupBtn': {
				click: me.onReviewOfSystemSetupBtnClick
			},
			'#ReviewOfSystemSetupCancelBtn': {
				click: me.onReviewOfSystemSetupCancelBtnClick
			},
			'#ReviewOfSystemSetupSaveBtn': {
				click: me.onReviewOfSystemSetupSaveBtnClick
			}
		});



	},

	onViewportRender: function(){
		var me = this;

		if(a('access_review_of_systems')) {
			Encounter.getReviewOfSystemSettingsByUserId(app.user.id, function (settings) {
				if(settings !== false){
					me.reviewOfSystemSetup = settings;
				}
			});
		}
	},

	onReviewOfSystemSetupCancelBtnClick: function(){
		this.reviewOfSystemSetupWindow.close();
	},

	onReviewOfSystemSetupSaveBtnClick: function(){
		var me = this,
			values = me.reviewOfSystemSetupWindow.down('form').getForm().getValues();


		me.reviewOfSystemSetup.user_id = app.user.id;
		Ext.apply(me.reviewOfSystemSetup.settings_data, values);

		Encounter.saveReviewOfSystemSettings(me.reviewOfSystemSetup, function (settings) {
			if(settings !== false){
				me.reviewOfSystemSetup = settings;
				me.setReviewOfSystemFormField();
				me.reviewOfSystemSetupWindow.close();
			}
		});
	},

	onReviewOfSystemSetupBtnClick: function(btn){
		this.showReviewOfSystemSetup(btn.up('form'));
	},

	onReviewOfSystemFormBeforeRender: function(){
		this.setReviewOfSystemFormField();
	},

	setReviewOfSystemFormField: function(){
		var me = this,
			fields = this.getReviewOfSystemForm().getForm().getFields();

		fields.each(function (field) {
			if(me.reviewOfSystemSetup.settings_data[field.name] !== undefined){
				field.setVisible(eval(me.reviewOfSystemSetup.settings_data[field.name]));
			}
		});
	},

	getReviewOfSystemSetupFields: function(form){
		var me = this,
			fieldsets = [];

		form.items.each(function (fieldset) {

			var fieldset_buff = {
				xtype: 'fieldset',
				title: fieldset.title,
				items: []
			};

			fieldset.items.each(function (switchfield) {
				fieldset_buff.items.push({
					xtype: 'checkbox',
					boxLabel: switchfield.fieldLabel,
					checked: true,
					name: switchfield.name
				});
			});

			fieldsets.push(fieldset_buff);
		});

		return fieldsets;

	},

	showReviewOfSystemSetup: function (form) {

		if(this.reviewOfSystemSetupWindow){
			return this.reviewOfSystemSetupWindow.show();
		}

		var items = this.getReviewOfSystemSetupFields(form);

		this.reviewOfSystemSetupWindow = Ext.create('Ext.window.Window', {
			title: 'Review Of System Setup',
			height: 600,
			width: 400,
			layout: 'fit',
			bodyPadding: 5,
			closeAction: 'hide',
			items: [
				{
					xtype: 'form',
					bodyPadding: 5,
					autoScroll: true,
					items: items
				}
			],
			buttons: [
				{
					text: _('cancel'),
					itemId: 'ReviewOfSystemSetupCancelBtn'
				},
				{
					text: _('save'),
					itemId: 'ReviewOfSystemSetupSaveBtn'
				}
			]
		}).show();

		this.reviewOfSystemSetupWindow.down('form').getForm().setValues(this.reviewOfSystemSetup.settings_data);


		return this.reviewOfSystemSetup;

	}

});
Ext.define('App.controller.patient.Results', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.view.administration.HL7MessageViewer'
	],
	refs: [
		{
			ref: 'ResultsPanel',
			selector: 'patientresultspanel'
		},
		{
			ref: 'ResultsOrdersGrid',
			selector: '#ResultsOrdersGrid'
		},
		{
			ref: 'ResultsCardPanel',
			selector: '#ResultsCardPanel'
		},
		{
			ref: 'ResultsOrderSignBtn',
			selector: '#ResultsOrderSignBtn'
		},
		{
			ref: 'ResultsOrderNewBtn',
			selector: '#ResultsOrderNewBtn'
		},
		{
			ref: 'ResultsOrderResetBtn',
			selector: '#ResultsOrderResetBtn'
		},
		{
			ref: 'ResultsOrderSaveBtn',
			selector: '#ResultsOrderSaveBtn'
		},

		// Laboratory
		{
			ref: 'ResultsLaboratoryPanel',
			selector: '#ResultsLaboratoryPanel'
		},
		{
			ref: 'ResultsLaboratoryForm',
			selector: '#ResultsLaboratoryForm'
		},
		{
			ref: 'ResultsLaboratoryFormUploadField',
			selector: '#ResultsLaboratoryFormUploadField'
		},
		{
			ref: 'ResultsLaboratoryObservationsGrid',
			selector: '#ResultsLaboratoryObservationsGrid'
		},


		// Radiology
		{
			ref: 'ResultsRadiologyPanel',
			selector: '#ResultsRadiologyPanel'
		},
		{
			ref: 'ResultsRadiologyForm',
			selector: '#ResultsRadiologyForm'
		},
		{
			ref: 'ResultsRadiologyFormUploadField',
			selector: '#ResultsRadiologyFormUploadField'
		},
		{
			ref: 'ResultsRadiologyFormViewStudyBtn',
			selector: '#ResultsRadiologyFormViewStudyBtn'
		},
		{
			ref: 'ResultsRadiologyDocumentIframe',
			selector: '#ResultsRadiologyDocumentIframe'
		},
		{
			ref: 'ResultsRadiologyReportBody',
			selector: '#ResultsRadiologyReportBody'
		}
	],

	init: function(){
		var me = this;
		me.control({
			'patientresultspanel': {
				activate: me.onResultPanelActive
			},
			'#ResultsOrdersGrid': {
				render: me.onResultsOrdersGridRender,
				selectionchange: me.onOrderSelectionChange
			},
			'#ResultsLaboratoryFormUploadField': {
				change: me.onOrderDocumentChange
			},
			'#ResultsOrderResetBtn': {
				click: me.onResultsOrderResetBtnClick
			},
			'#ResultsOrderSaveBtn': {
				click: me.onResultsOrderSaveBtnClick
			},

			'#ResultsLabsLiveSearchField': {
				select: me.onResultsLabsLiveSearchFieldSelect
			},
			'#ResultsRadsLiveSearchField': {
				select: me.onResultsRadsLiveSearchFieldSelect
			},
			'#ResultsLaboratoryPanelDocumentViewBtn': {
				click: me.onOrderDocumentViewBtnClicked
			},
			'#ResultsLabOrderNewBtn': {
				click: me.onNewOrderLabResultBtnClick
			},
			'#ResultsRadOrderNewBtn': {
				click: me.onNewOrderRadResultBtnClick
			},
			'#ResultsOrderSignBtn': {
				click: me.onOrderResultSignBtnClick
			},
			'#ResultsOrdersGridOrderTypeCombo': {
				change: me.onOrderTypeSelect
			},
			'#ResultsOrdersGridRowEditor': {
				beforeedit: me.onOrderResultGridRowEdit
			},
			'#ResultsOrdersGridOrderVoidCheckbox': {
				change: me.onResultsOrdersGridOrderVoidCheckboxChange
			},
			'#ResultsRadiologyFormViewStudyBtn': {
				click: me.onResultsRadiologyFormViewStudyBtnClick
			},
			'#ResultsCardPanel referringphysicianlivetsearch': {
				select: me.onResultsCardPanelReferringPhysicianLiveSearchSelect
			}
		});
	},

	onResultsCardPanelReferringPhysicianLiveSearchSelect: function(field, selection){
		var form = field.up('form').getForm();
		var record = form.getRecord();

		record.set({
			performer_id: selection[0].get('id'),
		});

		form.setValues({
			performer_name: selection[0].get('fullname'),
		});

	},

	onResultsLabsLiveSearchFieldSelect: function(cmb, records){
		cmb.up('form').getRecord().set({
			code: records[0].get('loinc_number'),
			code_text: records[0].get('loinc_name'),
			code_type: 'LOINC'
		});
	},

	onResultsRadsLiveSearchFieldSelect: function(cmb, records){
		cmb.up('form').getRecord().set({
			code: records[0].get('loinc_number'),
			code_text: records[0].get('loinc_name'),
			code_type: 'LOINC'
		});
	},

	onResultsOrdersGridOrderVoidCheckboxChange: function(){

	},

	onOrderResultSignBtnClick: function(){
		var me = this,
			record;

		app.passwordVerificationWin(function(btn, password){
			if(btn === 'ok'){
				User.verifyUserPass(password, function(success){
					if(success){
						record = me.getActiveForm().getForm().getRecord();
						record.set({signed_uid: app.user.id});
						record.save({
							success: function(){
								app.msg(_('sweet'), _('result_signed'));
							},
							failure: function(){
								app.msg(_('sweet'), _('record_error'), true);
							}
						});
					}else{
						me.onOrderResultSignBtnClick();
					}
				});
			}
		});
	},

	onResultsOrdersGridRender: function (grid) {
		grid.store.on('write', this.onResultsOrdersGridStoreWrite, this);
	},

	onResultsOrdersGridStoreWrite: function (store, operation) {

		var me = this,
			sm = me.getResultsOrdersGrid().getSelectionModel(),
			lastSelected = sm.getLastSelected();

		if(operation.action === 'create'){

			if(lastSelected.data.order_type === 'lab') {
				this.getLabOrderResult(lastSelected);
			}else if(lastSelected.data.order_type === 'lab'){
				this.getRadOrderResult(lastSelected);
			}
		}
	},

	onOrderSelectionEdit: function(editor, context){
		this.getLabOrderResult(context.record);
	},

	onNewOrderLabResultBtnClick: function(){
		this.doNewOrderResult('lab');
	},

	onNewOrderRadResultBtnClick: function(){
		this.doNewOrderResult('rad');
	},

	doNewOrderResult: function(order_type){
		var grid = this.getResultsOrdersGrid(),
			store = grid.getStore(),
			records,
			fields;

		grid.editingPlugin.cancelEdit();
		records = store.add({
			pid: app.patient.pid,
			uid: app.user.id,
            eid: app.patient.eid,
			is_external_order: 1,
			order_type: order_type,
			status: 'Pending'
		});
		grid.getPlugin('ResultsOrdersGridRowEditor').startEdit(records[0], 0);

		this.setEditor(grid, order_type);
		this.onOrderSelectionChange(null, records);
	},

	onOrderResultGridRowEdit: function(editor, context, eOpts){
		//say(context);
	},

	onOrderTypeSelect: function(combo, newValue, oldValue, eOpts){
		var grid = combo.up('grid');

		this.setEditor(grid, newValue);

	},

	setEditor: function(grid, order_type){
		if(order_type === 'lab'){
			// Change the Card panel, to show the Laboratory results form
			this.getResultsCardPanel().getLayout().setActiveItem('ResultsLaboratoryPanel');
			// Change the field to look for laboratories
			grid.columns[4].setEditor({
				xtype: 'labslivetsearch',
				itemId: 'ResultsLabsLiveSearchField',
				allowBlank: false,
				flex: 1,
				value: ''
			});
			// Enabled the New Order Result Properties
			//this.getResultsOrderNewBtn().disable(false);
		}

		if(order_type === 'rad'){
			// Change the Card panel, to show the Radiology results form
			this.getResultsCardPanel().getLayout().setActiveItem('ResultsRadiologyPanel');
			// Change the field to look for radiologists
			grid.columns[4].setEditor({
				xtype: 'radslivetsearch',
				itemId: 'ResultsRadsLiveSearchField',
				allowBlank: false,
				flex: 1,
				value: ''
			});
			// Enabled the New Order Result Properties
			//this.getResultsOrderNewBtn().disable(false);
		}
	},

	onResultPanelActive: function(){
		this.setResultPanel();
	},

	setResultPanel: function(){
		var me = this,
			ordersStore = me.getResultsOrdersGrid().getStore();

		if(app.patient){
			ordersStore.clearFilter(true);
			ordersStore.filter([
				{
					property: 'pid',
					value: app.patient.pid
				}
			]);
		}
		else{
			ordersStore.clearFilter(true);
			ordersStore.load();
		}
	},

	onOrderSelectionChange: function(model, records){

		var carDpanel = this.getResultsCardPanel();

		if(!carDpanel.isVisible())
			carDpanel.setVisible(true);

		if(records.length > 0){
			if(records[0].data.order_type === 'lab'){
				carDpanel.getLayout().setActiveItem('ResultsLaboratoryPanel');
				if(records.length > 0){
					this.getLabOrderResult(records[0]);
				}
			}else if(records[0].data.order_type === 'rad'){
				carDpanel.getLayout().setActiveItem('ResultsRadiologyPanel');
				if(records.length > 0){
					this.getRadOrderResult(records[0]);
				}
			}else{
				this.resetOrderResultForm();
			}
		}else{
			this.resetOrderResultForm();
		}
	},

	getLabOrderResult: function(order_record){
		var me = this,
			form = me.getResultsLaboratoryForm(),
			results_store = order_record.results(),
			observationGrid = me.getResultsLaboratoryObservationsGrid(),
			observationStore,
			newResult,
			i;

		observationGrid.editingPlugin.cancelEdit();

		if(order_record.get('id') === 0) return;

		results_store.load({
			callback: function(records){
				if(records.length > 0){
					var last_result = records.length - 1;

					records[last_result].order_record = order_record;

					form.loadRecord(records[last_result]);
					me.getResultsOrderSignBtn().setDisabled(records[last_result].data.signed_uid > 0);
					observationStore = records[last_result].observations();
					observationGrid.reconfigure(observationStore);
					observationStore.load();
				}else{
					newResult = results_store.add({
						pid: order_record.data.pid,
						code: order_record.data.code,
						code_text: order_record.data.description,
						code_type: order_record.data.code_type,
						order_id: order_record.data.id,
						ordered_uid: order_record.data.uid,
						create_date: new Date()
					});

					newResult[0].order_record = order_record;
					newResult[0].set({
						order_id: order_record.data.id
					});

					form.loadRecord(newResult[0]);
					me.getResultsOrderSignBtn().setDisabled(true);
					observationStore = newResult[0].observations();
					observationGrid.reconfigure(observationStore);
					observationStore.load({

						params: {
							loinc: order_record.data.code
						},
						callback: function(ObsRecords){
							for(i = 0; i < ObsRecords.length; i++){
								ObsRecords[i].phantom = true;
							}
						}
					});
				}
			}
		});
	},

	getRadOrderResult: function(order_record){

		var me = this,
			form = me.getResultsRadiologyForm().getForm(),
			results_store = order_record.results();

		results_store.load({
			callback: function(records){
				if(records.length > 0){
					var last_result = records.length - 1;

					records[last_result].order_record = order_record;

					form.loadRecord(records[last_result]);
					me.getResultsOrderSignBtn().setDisabled(records[last_result].data.signed_uid > 0);
					me.getResultsRadiologyReportBody().setValue(records[last_result].get('report_body'));
					me.loadRadiologyDocument(records[last_result]);
					me.setViewStudyBtn(records[last_result]);
				}else{
					var newResult = results_store.add({
						pid: order_record.data.pid,
						code: order_record.data.code,
						code_text: order_record.data.description,
						code_type: order_record.data.code_type,
						order_id: order_record.data.id,
						report_body: '',
						ordered_uid: order_record.data.uid,
						create_date: new Date()
					});


					newResult[0].order_record = order_record;
					newResult[0].set({
						order_id: order_record.data.id
					});

					form.loadRecord(newResult[0]);
					me.getResultsRadiologyReportBody().setValue(newResult[0].get('report_body'));
					me.loadRadiologyDocument(newResult[0]);
					me.setViewStudyBtn(newResult[0]);
				}
			}
		});
	},

	setViewStudyBtn: function(result_record){
		this.getResultsRadiologyFormViewStudyBtn().setDisabled(result_record.get('study_link') == '');
	},

	onResultsRadiologyFormViewStudyBtnClick: function(){
		var record = this.getActiveForm().getForm().getRecord();
		var win = window.open(record.get('study_link'), 'dicom_viewer');

		if(win){
			win.focus();
		} else{
			app.msg(_('oops'), _('unable_to_open_new_tab'), true);
		}
	},


	/**
	 * SAVE RESULTS FOMR
	 */
	onResultsOrderSaveBtnClick: function(){
		var form = this.getActiveForm();

		if(form.itemId == 'ResultsLaboratoryForm'){
			this.saveLabOrderResultForm(form.getForm());
		}else if(form.itemId == 'ResultsRadiologyForm'){
			this.saveRadOrderResultForm(form.getForm());
		}
	},

	saveLabOrderResultForm: function(form)	{
		var me = this,
			result_record = form.getRecord(),
			sm = me.getResultsOrdersGrid().getSelectionModel(),
			order = sm.getSelection(),
			values = form.getValues(),
			observationData = [];

		if(!form.isValid()) return;

		var observationStore = result_record.observations(),
			observations = observationStore.tree.flatten();

		values.order_id = result_record.order_record.get('id');

		result_record.set(values);
		result_record.save({
			success: function(rec){
				for(var i = 1; i < observations.length; i++){
					observations[i].set({result_id: rec.data.id});
				}
				observationStore.sync({
					callback: function(batch, options){

					}
				});
				order[0].set({status: 'Received'});
				order[0].save();
				app.msg(_('sweet'), _('record_saved'));
			}
		});
	},

	saveRadOrderResultForm: function(form){
		if(!form.isValid()) return;

		var me = this,
			result_record = form.getRecord(),
			values = form.getValues(),
			reader = new FileReader(),
			files = me.getResultsRadiologyFormUploadField().extractFileInput().files;

		values.order_id = result_record.order_record.get('id');
		values.code = result_record.order_record.get('code');
		values.code_text = result_record.order_record.get('description');
		values.code_type = result_record.order_record.get('code_type');
		values.report_body = me.getResultsRadiologyReportBody().getValue();

		if(files[0]){
			reader.onload = function(e){
				values.upload = e.target.result;
				result_record.set(values);
				result_record.save({
					callback: function(){
						me.loadRadiologyDocument(result_record);
						app.msg(_('sweet'), _('record_saved'));
					}
				});
			};
			reader.readAsDataURL(me.getResultsRadiologyFormUploadField().extractFileInput().files[0]);
		}else {
			result_record.set(values);
			result_record.save({
				callback: function(){
					me.loadRadiologyDocument(result_record);
					app.msg(_('sweet'), _('record_saved'));
				}
			});
		}
	},

	loadRadiologyDocument: function(result_record){

		var document_id = result_record.get('documentId'),
			frame = this.getResultsRadiologyDocumentIframe();

		if(document_id != ''){
			var doc_id = document_id.split('|');
			if(doc_id.length == 2){
				frame.setSrc(
					Ext.String.format(
						'dataProvider/DocumentViewer.php?site={0}&token={1}&id={2}',
						app.user.site,
						app.user.token,
						doc_id[1]
					)
				);
			}
		}else{
			frame.setSrc('about:blank');
		}
	},

	/**
	 * RESET RESULTS FORM
	 */
	onResultsOrderResetBtnClick: function(){
		this.resetOrderResultForm();
	},

	resetOrderResultForm: function(){
		var form = this.getActiveForm();

		if(form.itemId == 'ResultsLaboratoryForm'){
			this.resetLabOrderResultForm(form.getForm());
		}else if(form.itemId == 'ResultsRadiologyForm'){
			this.resetRadOrderResultForm(form.getForm());
		}

		var card_panel = this.getResultsCardPanel();

		if(card_panel.isVisible()){
			card_panel.setVisible(false);
		}
	},

	resetLabOrderResultForm: function(form){
		var me = this,
			observationGrid = me.getResultsLaboratoryObservationsGrid(),
			store = Ext.create('App.store.patient.PatientsOrderObservations');

		form.reset();
		observationGrid.editingPlugin.cancelEdit();
		observationGrid.reconfigure(store);
	},

	resetRadOrderResultForm: function(form){
		form.reset();
		this.getResultsRadiologyDocumentIframe().setSrc('about:blank');
	},


	getActiveForm: function(){
		return this.getResultsCardPanel().getLayout().getActiveItem().down('form');
	},

	onOrderDocumentViewBtnClicked: function(){
		var me = this,
			form = me.getResultsLaboratoryForm(),
			record = form.getRecord(),
			recordData = record.data.documentId.split('|'),
			type, id;

		if(recordData[0]) type = recordData[0];
		if(recordData[1]) id = recordData[1];

		if(type && id){
			if(type == 'hl7'){
				app.getController('administration.HL7').viewHL7MessageDetailById(id);
			} else if(type == 'doc'){
				app.onDocumentView(id);
			}
		}else{
			app.msg(_('oops'), _('no_document_found'), true)
		}
	},

	onOrderDocumentChange: function(field){
		//		say(field);
		//		say(document.getElementById(field.inputEl.id).files[0]);
		//		say(field.inputEl);
		//
		//		var fr = new FileReader();
		//
		//
		//		fr.onload = function(e) {
		//			say(e.target.result);
		//		};
		//
		//		fr.readAsDataURL( field.value );
	}

});

Ext.define('App.controller.patient.encounter.Encounter', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.ux.combo.ActiveSpecialties'
	],
	refs: [
		{
			ref: 'EncounterPanel',
			selector: '#encounterPanel'
		},
		{
			ref: 'EncounterProgressNotePanel',
			selector: '#EncounterProgressNotePanel'
		},
		{
			ref: 'EncounterDetailWindow',
			selector: '#EncounterDetailWindow'
		},
		{
			ref: 'EncounterProviderCmb',
			selector: '#EncounterProviderCmb'
		},
		{
			ref: 'EncounterSpecialtyCmb',
			selector: '#EncounterSpecialtyCmb'
		},
		{
			ref: 'EncounterDetailForm',
			selector: '#EncounterDetailForm'
		},
		{
			ref: 'EncounterTransferWindow',
			selector: '#EncounterTransferWindow'
		},
		{
			ref: 'EncounterTransferPatientSearchField',
			selector: '#EncounterTransferPatientSearchField'
		},
		{
			ref: 'PatientSummaryEncountersPanel',
			selector: '#PatientSummaryEncountersPanel'
		},
		{
			ref: 'EncounterMedicalToolbarSignBtn',
			selector: '#EncounterMedicalToolbarSignBtn'
		},
		{
			ref: 'EncounterMedicalToolbarAddendumAddBtn',
			selector: '#EncounterMedicalToolbarAddendumAddBtn'
		}
	],

	init: function(){
		var me = this;

		this.control({
			'viewport':{
				patientunset: me.onPatientUnset,
				encounterload: me.onEncounterLoad
			},
			'#EncounterDetailForm combobox[name=visit_category]':{
				select: me.onEncounterDetailFormVisitCategoryComboSelect
			},
			'#EncounterDetailForm combobox[name=referring_physician]':{
				beforerender: me.onEncounterDetailFormReferringComboSelect
			},
			'#EncounterDetailWindow': {
				show: me.onEncounterDetailWindowShow
			},
			'#EncounterProviderCmb': {
				beforerender: me.onEncounterProviderCmbBeforeRender,
				select: me.onEncounterProviderCmbSelect
			},
			'#EncounterCDAImportBtn': {
				click: me.onEncounterCDAImportBtnClick
			},
			'#EncounterDeletetBtn': {
				click: me.onEncounterDeleteBtnClick
			},
			'#EncounterTransferBtn': {
				click: me.onEncounterTransferBtnClick
			},
			'#EncounterTransferWindowCancelBtn': {
				click: me.onEncounterTransferWindowCancelBtnClick
			},
			'#EncounterTransferWindowTransferBtn': {
				click: me.onEncounterTransferWindowTransferBtnlick
			},
			'#EncounterNewProgressNoteBtn': {
				click: me.onEncounterNewProgressNoteBtnClick
			},
			'#PatientSummeryNewProgressNoteBtn': {
				click: me.onPatientSummeryNewProgressNoteBtnClick
			}
		});

		me.importCtrl = this.getController('patient.CCDImport');
		me.auditLogCtrl = this.getController('administration.AuditLog');

		//me.showEncounterTransferWindow();
	},

	doNewEncounterWindow: function(default_values){
		var me = this,
			win = me.getEncounterDetailWindow(),
			form = win.down('form').getForm();

		default_values = default_values || {};

		if(a('add_encounters')){
			win.show();
			form.loadRecord(Ext.create('App.model.patient.Encounter', default_values));
		}else{
			app.accessDenied();
		}
	},

	onEncounterNewProgressNoteBtnClick: function(btn){

		var encounter = this.getEncounterPanel().encounter,
			default_values = {
				pid: app.patient.pid,
				parent_eid: app.patient.eid,
				brief_description: Ext.String.format('FOLLOW-UP: {0}',encounter.get('brief_description')),
				open_uid: app.user.id,
				service_date: app.getDate(),
				onset_date: encounter.get('onset_date'),
				patient_class: encounter.get('patient_class'),
				specialty_id: encounter.get('specialty_id'),
				provider_uid: encounter.get('provider_uid'),
				provider_title: encounter.get('provider_title'),
				provider_fname: encounter.get('provider_fname'),
				provider_mname: encounter.get('provider_mname'),
				provider_lname: encounter.get('provider_lname'),
				priority: encounter.get('priority'),
				facility: encounter.get('facility'),
				referring_physician: encounter.get('referring_physician'),
		};

		this.doNewEncounterWindow(default_values);

	},

	onPatientSummeryNewProgressNoteBtnClick: function(){
		var me = this,
			selected_encounters = me.getPatientSummaryEncountersPanel().getSelectionModel().getSelection(),
			encounter;

		if(selected_encounters.length === 0){
			app.msg(_('oops'), _('no_encounter_selected'), true);
			return;
		}

		var encounter = selected_encounters[0],
			default_values = {
				pid: app.patient.pid,
				parent_eid: app.patient.eid,
				brief_description: Ext.String.format('FOLLOW-UP: {0}',encounter.get('brief_description')),
				open_uid: app.user.id,
				service_date: app.getDate(),
				onset_date: encounter.get('onset_date'),
				patient_class: encounter.get('patient_class'),
				specialty_id: encounter.get('specialty_id'),
				provider_uid: encounter.get('provider_uid'),
				provider_title: encounter.get('provider_title'),
				provider_fname: encounter.get('provider_fname'),
				provider_mname: encounter.get('provider_mname'),
				provider_lname: encounter.get('provider_lname'),
				priority: encounter.get('priority'),
				facility: encounter.get('facility'),
				referring_physician: encounter.get('referring_physician'),
			};

		this.doNewEncounterWindow(default_values);




	},

	onEncounterDeleteBtnClick: function (btn) {
		// TODO
	},

	onEncounterTransferBtnClick: function (btn) {
		this.showEncounterTransferWindow();
	},

	onEncounterTransferWindowCancelBtnClick: function (btn) {
		this.getEncounterTransferPatientSearchField().reset();
		this.getEncounterTransferWindow().close();
	},

	onEncounterTransferWindowTransferBtnlick: function (btn) {

		var me = this,
			patient_field = me.getEncounterTransferPatientSearchField(),
			patient_pid = patient_field.getValue(),
			patient_eid = app.patient.eid,
			patient_record = patient_field.findRecordByValue(patient_pid);

		if(!patient_field.isValid()) return;

		me.getEncounterTransferPatientSearchField().reset();
		me.getEncounterTransferWindow().close();


		var from_name = app.patient.name,
			to_name = patient_record.get('fullname');

		Ext.Msg.show({
			title: _('wait'),
			msg: Ext.String.format(_('encounter_transfer_from_x_to_x_msg'), from_name, to_name),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {

				if(btn !== 'yes') return;

				me.getEncounterDetailWindow().close();

				Ext.getBody().mask(_('be_right_back'));

				Encounter.TransferEncounter(patient_eid, patient_pid, function (success) {
					Ext.getBody().unmask();

					if(success){
						me.auditLogCtrl.addLog(
							patient_pid,
							app.user.id,
							patient_eid,
							patient_eid,
							'encounters',
							'ENCOUNTER_TRANSFER',
							Ext.String.format('Encounter trasnfer from {0} to {1}', from_name, to_name)
						);

						app.setPatient(patient_pid, patient_eid, app.user.site, function () {
							app.openEncounter(patient_eid);
						});
					}
				});
			}
		});

	},

	showEncounterTransferWindow: function () {
		if(!this.getEncounterTransferWindow()){
			Ext.create('App.view.patient.windows.EncounterTransferWindow');
		}
		return this.getEncounterTransferWindow().show();
	},

	onEncounterLoad: function (encounter, encounter_panel) {
		app.onMedicalWin();
		this.setEncounterState(encounter, encounter_panel);
	},

	setEncounterState: function (encounter_record, encounter_panel){
		// say('setEncounterState');
		// say(encounter_record);
		// say(encounter_panel);

		var me = this;

		app.patient.encounterIsClose = encounter_record.isClose();
		app.patient.encounterAllowEdit = app.user.id == encounter_record.get('provider_uid') || !app.patient.encounterIsClose || app.patient.eid == null;;

		/**
		 * set if encounter can be edited
		 */
		me.setEncounterEditState(app.patient.encounterAllowEdit);

		/**
		 * Set Sign or Addendum Btn
		 */
		me.setEncounterSignAddendumState(app.patient.encounterIsClose);


		/**
		 * Set Not Same Day Warning
		 */
		me.setEncounterSayDayWarningState(encounter_record, encounter_panel);
	},

	setEncounterEditState:function(allowEdit){

		var buttons = Ext.ComponentQuery.query('#encounterRecordAdd, button[action=encounterRecordAdd]'),
			forms = Ext.ComponentQuery.query('#encounterPanel form[advanceFormPlugin]');

		buttons.forEach(function (button) {
			button.setDisabled(!allowEdit);
		});

		forms.forEach(function (form) {
			form.advanceFormPlugin.enabled = allowEdit;
		});
	},

	setEncounterSignAddendumState: function (isClose){
		var signBtn = this.getEncounterMedicalToolbarSignBtn(),
			addendumBtn = this.getEncounterMedicalToolbarAddendumAddBtn();

		if(signBtn){
			signBtn.setVisible(!isClose);
		}
		if(addendumBtn) {
			addendumBtn.setVisible(isClose);
		}
	},

	setEncounterSayDayWarningState: function (encounter_record, encounter_panel){
		if(encounter_record.get('service_date').toLocaleDateString() !== new Date().toLocaleDateString()){
			encounter_panel.encounterTabPanel.ownerCt.addBodyCls('encounter-not-same-day');
			encounter_panel.getPageBodyContainer().addCls('encounter-not-same-day');
			app.msg(_('warning'),_('encounter_service_date_error_msg'), true);
		}else{
			encounter_panel.encounterTabPanel.ownerCt.removeBodyCls('encounter-not-same-day');
			encounter_panel.getPageBodyContainer().removeCls('encounter-not-same-day');
		}
	},

	getProgressNote: function(){
		var me = this,
		    encounterPanel = me.getEncounterPanel();

		Encounter.getProgressNoteByEid(encounterPanel.eid, function(provider, response){
			encounterPanel.progressNote.tpl.overwrite(encounterPanel.progressNote.body, response.result);
		});
	},

	/**
	 * set the encounter record to null when the patient is closed
	 */
	onPatientUnset:function(){
		if(this.getEncounterPanel()) this.getEncounterPanel().encounter = null;
	},

	onEncounterDetailFormVisitCategoryComboSelect: function (combo, records) {
		var encounter_record = combo.up('form').getForm().getRecord();

		encounter_record.set({
			visit_category_code: records[0].get('code'),
			visit_category_code_type: records[0].get('code_type')
		});
	},

	/**
	 * get the encounter record form the encounter panel or return null
	 * @returns {*}
	 */
	getEncounterRecord: function(){
		return !Ext.isEmpty(this.getEncounterPanel()) ? this.getEncounterPanel().encounter : null;
	},

	onEncounterProviderCmbBeforeRender: function(cmb){
		var container = cmb.up('container');

		container.setFieldLabel(''); // label showing bug

		container.insert((container.items.indexOf(cmb) + 1), {
			xtype: 'activespecialtiescombo',
			itemId: 'EncounterSpecialtyCmb',
			fieldLabel: _('specialty'),
			labelWidth: cmb.labelWidth,
			width: cmb.width,
			name: 'specialty_id',
			allowBlank: false
		});

	},

	onEncounterDetailFormReferringComboSelect: function(cmb){

	},

	onEncounterProviderCmbSelect: function(cmb, slected){
		var me = this;

		User.getUser(slected[0].data.option_value, function(provider){
			me.setSpecialtyCombo(provider);
		});
	},

	onEncounterDetailWindowShow: function(){
		var me = this,
			record = me.getEncounterDetailForm().getForm().getRecord();

		if(record.data.provider_uid === 0){
			if(me.getEncounterSpecialtyCmb()) me.getEncounterSpecialtyCmb().setVisible(false);

		}else{
			User.getUser(record.data.provider_uid, function(provider){
				me.setSpecialtyCombo(provider, record.data.specialty_id);
			});
		}

	},

	setSpecialtyCombo: function(provider, specialty){
		var show = this.reloadSpecialityCmbBySpecialty(provider.specialty, specialty);
		this.getEncounterSpecialtyCmb().setVisible(show);
		this.getEncounterSpecialtyCmb().setDisabled(!show);
	},

	reloadSpecialityCmbBySpecialty: function(specialties, specialty){
		var me = this,
			show = false;

		if(Ext.isNumeric(specialty) && specialty > 0){
			me.getEncounterSpecialtyCmb().setValue(eval(specialty));

		}else if(Ext.isArray(specialties) && specialties.length == 1){
			me.getEncounterSpecialtyCmb().setValue(eval(specialties[0]));

		}else{
			me.getEncounterSpecialtyCmb().setValue(null);
		}


		if(Ext.isArray(specialties)){

			var store = this.getEncounterSpecialtyCmb().getStore(),
				filters = [],
				show = true;

			for(var i = 0; i < specialties.length; i++){
				Ext.Array.push(filters, specialties[i]);
			}

			store.clearFilter(true);
			store.filter([
				{
					property: 'active',
					value: true
				},
				{
					property: 'id',
					value: new RegExp(filters.join('|'))
				}
			]);
		}

		return show;
	},

	onEncounterCDAImportBtnClick: function(btn){

		var me = this,
			win = Ext.create('App.ux.form.fields.UploadString');

		win.allowExtensions = ['xml','ccd','cda','ccda'];
		win.on('uploadready', function(comp, stringXml){
			me.getDocumentData(stringXml);
		});

		win.show();
	},

	getDocumentData: function(stringXml){
		var me = this;

		CDA_Parser.parseDocument(stringXml, function(ccdData){
			me.importCtrl.validatePosibleDuplicates = false;
			me.importCtrl.CcdImport(ccdData, app.patient.pid, stringXml);
			me.importCtrl.validatePosibleDuplicates = true;
			me.promptCcdScore(stringXml, ccdData);
		});
	},

	promptCcdScore: function(xml, ccdData){

		var me = this;

		Ext.Msg.show({
			title:'C-CDA Score',
			msg: 'Would you like to see this C-CDA score?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn) {
				if(btn === 'yes'){
					me.doCcdScore(xml, ccdData);
				}
			}
		});
	},

	doCcdScore: function (xml, ccdData) {
		CDA_ScoreCard.getScoreDocument(xml, Ext.String.format('{0}, {1} {3} (C-CDA)', ccdData.patient.lname, ccdData.patient.fname, ccdData.patient.title), function (temp_doc) {
			if(temp_doc) {
				app.getController('DocumentViewer').doDocumentView(temp_doc.id, 'temp');
			}
		});
	},



});

Ext.define('App.controller.reports.Reports', {
	extend: 'Ext.app.Controller',
	requires: [
		'App.ux.grid.Printer'
	],
	refs: [
		{
			ref: 'ReportsPanel',
			selector: '#ReportsPanel'
		},
		{
			ref: 'ReportsGrid',
			selector: '#ReportsGrid'
		},
		{
			ref: 'ReportWindow',
			selector: '#ReportWindow'
		},
		{
			ref: 'ReportWindowForm',
			selector: '#ReportWindowForm'
		},
		{
			ref: 'ReportWindowGrid',
			selector: '#ReportWindowGrid'
		},
		{
			ref: 'AdministrationReportWindow',
			selector: '#AdministrationReportWindow'
		},
		{
			ref: 'ReportWindowReloadBtn',
			selector: '#ReportWindowReloadBtn'
		}
	],

	init: function(){

		if(!a('access_reports')) return;

		var me = this;

		me.nav = me.getController('Navigation');
		me.nav.addNavigationNodes('reports', {
			'text': _('reports'),
			'leaf': true,
			'cls': 'file',
			'id': 'App.view.reports.ReportsPanel',
		}, 0);

		me.control({
			'#ReportsGrid': {
				beforerender: me.onReportsGridBeforeRender,
				itemdblclick: me.onReportsGridItemDblClick,
				beforeitemcontextmenu: me.onReportsGridBeforeItemContextMenu
			},
			'#ReportWindowReloadBtn': {
				click: me.onReportWindowReloadBtnClick
			},
			'#ReportWindowGridPrintBtn': {
				click: me.onReportWindowGridPrintBtnClick
			},
			'#AdministrationReportsAddBtn': {
				click: me.onAdministrationReportsAddBtnClick
			},
			'#AdministrationReportCancelBtn': {
				click: me.onAdministrationReportCancelBtnClick
			},
			'#AdministrationReportSaveBtn': {
				click: me.onAdministrationReportSaveBtnClick
			},
			'#ReportWindowGroupByCmb': {
				select: me.onReportWindowGroupByCmbSelect
			}
		});

	},

	showAdministrationReportWindow: function (){

		if(!this.getAdministrationReportWindow()){

			Ext.create('Ext.window.Window',{
				title: _('report'),
				layout: 'fit',
				bodyPadding: 5,
				width: 800,
				itemId: 'AdministrationReportWindow',
				items: [
					{
						xtype: 'form',
						bodyPadding: 10,
						items: [
							{
								xtype: 'textfield',
								fieldLabel: _('title'),
								name: 'title',
								anchor: '100%',
								allowBlank: false
							},
							{
								xtype: 'textfield',
								fieldLabel: _('description'),
								name: 'description',
								anchor: '100%',
								allowBlank: false
							},
							{
								xtype: 'textfield',
								fieldLabel: _('store_procedure_name'),
								name: 'store_procedure_name',
								anchor: '100%',
								allowBlank: false
							},
							{
								xtype: 'textfield',
								fieldLabel: _('group_fields'),
								name: 'group_fields',
								anchor: '100%'
							},
							{
								xtype: 'aclpermissions',
								fieldLabel: _('permission'),
								name: 'report_perm',
								anchor: '100%'
							},
							{
								xtype: 'textareafield',
								fieldLabel: _('columns'),
								name: 'columns',
								height: 500,
								anchor: '100%',
								allowBlank: false,
								enableKeyEvents: true,
								fieldStyle: { 'fontFamily': 'Courier', 'fontSize': '12px'},
								listeners: {
									specialkey: function(field, e){

										if (e.getKey() == e.TAB) {
											e.stopEvent();
											var el = field.inputEl.dom;
											if (el.setSelectionRange) {
												var withIns = el.value.substring(0, el.selectionStart) + '    ';
												var pos = withIns.length;
												el.value = withIns + el.value.substring(el.selectionEnd, el.value.length);
												el.setSelectionRange(pos, pos);
											}
											else if (document.selection) {
												document.selection.createRange().text = '    ';
											}
										}
									}
								}
							}
						]
					}
				],
				buttons: [
					{
						xtype: 'button',
						text: _('cancel'),
						itemId: 'AdministrationReportCancelBtn'
					},
					{
						xtype: 'button',
						text: _('save'),
						itemId: 'AdministrationReportSaveBtn'
					}
				]
			});

		}
		return this.getAdministrationReportWindow().show();
	},

	onReportsGridBeforeItemContextMenu: function (grid, report_record, item,index, e){
		e.preventDefault();
		if(a('access_admin_reports')){
			var win = this.showAdministrationReportWindow();
			win.down('form').getForm().loadRecord(report_record);
		}
	},

	onAdministrationReportsAddBtnClick: function () {
		var win = this.showAdministrationReportWindow(),
			added_records = this.getReportsGrid().getStore().add({
				workflow: 'PRE-REGISTRATION',
				days_valid_for: 365,
				version: '1.0',
				active: false
			});

		win.down('form').getForm().loadRecord(added_records[0]);

	},

	onAdministrationReportCancelBtnClick: function (btn){
		var win = btn.up('window');
		win.down('form').getForm().reset(true);
		this.getReportsGrid().getStore().rejectChanges();
		win.close();
	},

	onAdministrationReportSaveBtnClick: function (btn){
		var win = btn.up('window'),
			form = win.down('form').getForm(),
			record = form.getRecord(),
			values = form.getValues()

		if(!form.isValid()){
			return;
		}

		record.set(values);

		if(record.store.getModifiedRecords().length > 0){
			record.store.sync({
				callback: function (){
					win.close();
				}
			});
		}else{
			win.close();
		}
	},




	onReportWindowGridPrintBtnClick: function(btn){

		var report_grid = btn.up('grid'),
			report_win = report_grid.up('window'),
			report_form = report_win.down('form').getForm(),
			filters = [];

		if(!report_grid.filters){
			app.msg(_('oops'), 'No Filters Found', true);
			return;
		}

		Ext.Object.each(report_grid.filters, function (property, filter) {
			var val = filter ? filter : 'None';
			filters.push(Ext.String.format('<b>{0}</b>: {1}', _(property), val));
		});

		App.ux.grid.Printer.mainTitle = Ext.String.format('{0} Report', report_win.title);
		App.ux.grid.Printer.filtersHtml = 'Filters: ' + filters.join(', ');
		App.ux.grid.Printer.print(report_grid);

	},

	onReportsGridBeforeRender: function (grid) {
		grid.store.load();
	},

	onReportsGridItemDblClick: function (grid, record) {
		var me = this,
			win = me.showReportsWindow(),
			form = win.down('form'),
			report_grid = win.down('grid'),
			group_fields = record.get('group_fields'),
			model_fields = [], search_fields = [], columns, group_by;

		report_grid.filters = undefined;
		win.setTitle('Report Viewer');
		win.el.mask('Getting Things Ready');

		report_grid.setTitle(record.get('title'));

		Reports.getReport(record.get('id'), function (response) {

			win.el.unmask();
			if(response === false) {
				win.close();
				return;
			}

			response.parameters.forEach(function (parameter) {

				// fire event... any module can listen for this event and handle the search field
				// just make sure the listener function return false to continue to the next field
				if(app.fireEvent('beforereportfilteradd', me, parameter, search_fields) === false){
					return;
				}

				if(parameter.DATA_TYPE === 'date' || parameter.DATA_TYPE === 'datetime'){
					search_fields.push({
						xtype: 'datefield',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						name: parameter.PARAMETER_NAME
					});
					return;
				}
				if(parameter.PARAMETER_NAME === 'facility_id'){
					search_fields.push({
						xtype: 'mitos.facilitiescombo',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						name: parameter.PARAMETER_NAME
					});
					return;
				}
				if(parameter.PARAMETER_NAME === 'specialty_id'){
					search_fields.push({
						xtype: 'specialtiescombo',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						name: parameter.PARAMETER_NAME
					});
					return;
				}
				if(parameter.PARAMETER_NAME === 'department_id'){
					search_fields.push({
						xtype: 'depatmentscombo',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						name: parameter.PARAMETER_NAME
					});
					return;
				}
				if(parameter.PARAMETER_NAME === 'insurance_id'){
					search_fields.push({
						xtype: 'insurancescombo',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						name: parameter.PARAMETER_NAME
					});
					return;
				}
				// any parameter ending in _uid will add a user search field
				if(parameter.PARAMETER_NAME.search(/_uid$/) !== -1){
					search_fields.push({
						xtype: 'userlivetsearch',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						hideLabel: false,
						name: parameter.PARAMETER_NAME
					});
					return;
				}

				// any pid field or ending in _pid will add a patient live search
				if(parameter.PARAMETER_NAME.search(/^pid$|_pid$/) !== -1){
					search_fields.push({
						xtype: 'patienlivetsearch',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						hideLabel: false,
						name: parameter.PARAMETER_NAME
					});
					return;
				}

				if(parameter.PARAMETER_NAME === 'insurance_type'){
					search_fields.push({
						xtype: 'gaiaehr.combo',
						listKey: 'ins_type',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						editable: false,
						name: parameter.PARAMETER_NAME
					});
					return;
				}

				if(parameter.PARAMETER_NAME === 'claim_payment_type'){
					search_fields.push({
						xtype: 'gaiaehr.combo',
						listKey: 'clm_pay',
						fieldLabel: _(parameter.PARAMETER_NAME),
						labelAlign: 'top',
						margin: '0 5 0 0',
						multiSelect: true,
						editable: false,
						name: parameter.PARAMETER_NAME
					});
					return;
				}

				// by default add the text field
				search_fields.push({
					xtype: 'textfield',
					fieldLabel: _(parameter.PARAMETER_NAME),
					labelAlign: 'top',
					margin: '0 5 0 0',
					name: parameter.PARAMETER_NAME
				});


			});

			if(group_fields !== ''){
				group_fields = group_fields.split(',');
				var data = [];

				group_fields.forEach(function (group_field) {
					if(group_by == null) {
						group_by = group_field;
					}
					data.push([group_field, _(group_field)]);
				});

				search_fields.push({
					xtype: 'combo',
					fieldLabel: _('group_by'),
					labelAlign: 'top',
					margin: '0 5 0 0',
					itemId: 'ReportWindowGroupByCmb',
					submitValue: false,
					value: group_by,
					store: data
				});
			}

			// add fields to the form
			form.add(search_fields);

			columns = eval('(' + response.columns + ')');
			columns.forEach(function (column) {

				model_fields.push({
					type: column.dataType,
					name: column.dataIndex
				});

			});

			if(group_by){
				report_grid.reconfigure(Ext.create('Ext.data.Store',{ fields: model_fields, groupField: group_by  }), columns);
			}else{
				report_grid.reconfigure(Ext.create('Ext.data.Store',{ fields: model_fields }), columns);
			}
		});

	},

	onReportWindowGroupByCmbSelect: function (cmb, selection){

		// say(cmb);
		// say(selection);
		// var me = this,
		// 	win = cmb.up('window'),
		// 	filter_form = win.down('form').getForm(),
		// 	group_field =  win.down('form').down('#ReportWindowGroupByCmb'),
		// 	report_grid = win.down('grid');
		//
		// report_grid.getStore().group(selection[0].data.field1);

	},

	onReportWindowReloadBtnClick: function(btn){

		var me = this,
			win = btn.up('window'),
			filter_form = win.down('form').getForm(),
			group_field =  win.down('form').down('#ReportWindowGroupByCmb'),
			report_grid = win.down('grid'),
			report_store = report_grid.getStore(),
			filters = filter_form.getValues(),
			report_record = me.getReportsGrid().getSelectionModel().getSelection()[0],
			reload_button = me.getReportWindowReloadBtn();

		Ext.Object.each(filters, function (property, value) {
			if(Ext.isArray(value)){
				filters[property] = value.join(',');
			}
		});

		report_grid.el.mask('Loading!!!');
		report_grid.filters = filters;

		report_store.removeAll();

		if(group_field){
			report_store.group(group_field.getValue());
		}

		reload_button.setDisabled(true);
		Reports.runReportByIdAndFilters(report_record.get('id'), filters, function (response) {
			report_store.loadRawData(response);
			report_grid.el.unmask();
			reload_button.setDisabled(false);
		});

	},

	showReportsWindow: function () {
		if(!this.getReportWindow()){
			Ext.create('App.view.reports.ReportWindow');
		}
		return this.getReportWindow().show();
	}

});
Ext.define('App.view.patient.ActiveProblems', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.RowFormEditing',
		'App.ux.LiveSnomedProblemSearch',
		'App.ux.combo.CodesTypes',
		'App.ux.combo.Occurrence',
		'App.ux.combo.Outcome2'
	],
	xtype: 'patientactiveproblemspanel',
	title: _('act_prob'),
	columnLines: true,
	store: Ext.create('App.store.patient.PatientActiveProblems', {
		remoteFilter: true,
		autoSync: false
	}),
	columns: [
		{
			xtype: 'griddeletecolumn',
			acl: a('delete_active_problem'),
			width: 25
		},
		{
			xtype: 'actioncolumn',
			width: 25,
			items: [
				{
					icon: 'resources/images/icons/blueInfo.png',  // Use a URL in the icon config
					tooltip: 'Get Info',
					handler: function(grid, rowIndex, colIndex, item, e, record){
						App.app.getController('InfoButton').doGetInfo(record.data.code, record.data.code_type, record.data.code_text);
					}
				}
			]
		},
		{
			header: _('type'),
			width: 150,
			dataIndex: 'problem_type'
		},
		{
			header: _('problem'),
			flex: 1,
			dataIndex: 'code_text',
			renderer: function(v, meta, record){
				return v + ' (' + record.data.code + ')';
			}
		},
		{
			header: _('occurrence'),
			width: 200,
			dataIndex: 'occurrence'
		},
		{
			xtype: 'datecolumn',
			header: _('begin_date'),
			width: 100,
			format: 'Y-m-d',
			dataIndex: 'begin_date'
		},
		{
			xtype: 'datecolumn',
			header: _('end_date'),
			width: 100,
			format: 'Y-m-d',
			dataIndex: 'end_date'
		},
        {
            header: _('status'),
            groupable: false,
            width: 60,
            dataIndex: 'status'
        }
	],
	plugins: Ext.create('App.ux.grid.RowFormEditing', {
		autoCancel: false,
		errorSummary: false,
		clicksToEdit: 2,
		items: [
			{
				xtype:'container',
				layout:{
					type:'hbox',
					align:'stretch'
				},
				items:[
					{
						xtype: 'container',
						padding: 10,
						layout: 'vbox',
						items: [
							{
								xtype: 'fieldcontainer',
								layout: 'hbox',
								defaults: {
									margin: '0 10 0 0'
								},
								items: [
									{
										xtype: 'gaiaehr.combo',
										listKey: 'problems_types',
										name: 'problem_type_code',
										itemId: 'ActiveProblemTypeCmb',
										labelWidth: 70,
										width: 250,
										fieldLabel: _('type'),
										editable: false
									},
									// {
									// 	xtype: 'snomedliveproblemsearch',
									// 	fieldLabel: _('problem'),
									// 	name: 'code_text',
									// 	hideLabel: false,
									// 	itemId: 'activeProblemLiveSearch',
									// 	enableKeyEvents: true,
									// 	displayField: 'Term',
									// 	valueField: 'Term',
									// 	width: 460,
									// 	labelWidth: 70,
									// 	margin: '0 10 0 0',
									// 	allowBlank: false
									// },
									{
										xtype: 'liveicdxsearch',
										fieldLabel: _('problem'),
										name: 'code_text',
										hideLabel: false,
										itemId: 'activeProblemLiveSearch',
										enableKeyEvents: true,
										displayField: 'code_text',
										valueField: 'code_text',
										width: 460,
										labelWidth: 70,
										margin: '0 10 0 0',
										allowBlank: false
									},
								]
							},

							{
								xtype: 'fieldcontainer',
								layout: 'hbox',
								defaults: {
									margin: '0 10 0 0'
								},
								items: [
									{
										fieldLabel: _('occurrence'),
										width: 250,
										labelWidth: 70,
										xtype: 'mitos.occurrencecombo',
										name: 'occurrence',
										allowBlank: false
									},
									{
										xtype: 'textfield',
										width: 460,
										labelWidth: 70,
										fieldLabel: _('referred_by'),
										name: 'referred_by'
									}
								]
							},
							{
								fieldLabel: _('note'),
								xtype: 'textfield',
								width: 720,
								labelWidth: 70,
								name: 'note'
							}
						]
					},
					{
						xtype: 'container',
						padding: 10,
						layout: 'vbox',
						defaults: {
							labelWidth: 70,
							margin: '0 0 5 0',
							width: 200
						},
						items: [
							{
								fieldLabel: _('status'),
								xtype: 'gaiaehr.combo',
								name: 'status',
								itemId: 'ActiveProblemStatusCombo',
								list: 112
							},
							{
								fieldLabel: _('begin_date'),
								xtype: 'datefield',
								format: 'Y-m-d',
								name: 'begin_date'
							},
							{
								fieldLabel: _('end_date'),
								xtype: 'datefield',
								format: 'Y-m-d',
								name: 'end_date'
							}
						]
					}
				]
			}
		]
	}),
	tbar: [
		'->',
		{
			text: _('add_new'),
			action: 'encounterRecordAdd',
			itemId: 'addActiveProblemBtn',
			iconCls: 'icoAdd'
		}
	],
	bbar: [
        '-',
        {
            text: _('reconciled'),
            itemId: 'PatientProblemsReconciledBtn',
            enableToggle: true,
            pressed: true
        },
        '-',
        {
            text: _('active'),
            itemId: 'PatientProblemsActiveBtn',
            enableToggle: true,
            pressed: false
        },
        '->',
        {
		    text: _('review'),
		    itemId: 'ActiveProblemsReviewBtn',
		    action: 'encounterRecordAdd'
	    }
    ]
});

Ext.define('App.view.patient.ProceduresHistoryGrid', {
	extend: 'Ext.grid.Panel',
	requires: [
		'Ext.grid.plugin.RowEditing',
		'App.ux.LiveSnomedProcedureSearch',
		'App.ux.LiveReferringPhysicianSearch',
		'App.ux.LiveSnomedBodySiteSearch'
	],
	xtype: 'patientprocedureshistorygrid',
	title: _('proc_hx'),
	columnLines: true,
	store: Ext.create('App.store.patient.ProcedureHistory', {
		remoteFilter: true,
	}),
	plugins: [
		{
			ptype: 'rowediting',
			clicksToEdit: 2
		}
	],
	columns: [
		{
			xtype: 'griddeletecolumn',
			acl: a('delete_procedures_history'),
			width: 25
		},
		{
			xtype: 'datecolumn',
			header: _('performed_date'),
			width: 150,
			dataIndex: 'performed_date',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield'
			}
		},
		{
			header: _('procedure'),
			width: 300,
			dataIndex: 'procedure',
			editor:{
				xtype: 'snomedliveproceduresearch',
				itemId: 'ProceduresHistoryGridProcedureField',
				valueField: 'Term',
			}
		},
		{
			header: _('body_site'),
			width: 200,
			dataIndex: 'target_site_code_text',
			editor:{
				xtype: 'snomedlivebodysitesearch',
				itemId: 'ProceduresHistoryGridTargetSiteField',
				valueField: 'Term',
			}
		},
		{
			header: _('performer'),
			width: 200,
			dataIndex: 'performer',
			editor:{
				xtype: 'referringphysicianlivetsearch',
				itemId: 'ProceduresHistoryGridPerformerField',
				valueField: 'fullname',
			}
		},
		{
			header: _('service_location'),
			width: 200,
			dataIndex: 'service_location',
			editor:{
				xtype: 'referringphysicianlivetsearch',
				itemId: 'ProceduresHistoryGridServiceLocationField',
				valueField: 'fullname',
			}
		},
		{
			header: _('notes'),
			flex: 1,
			dataIndex: 'notes',
            editor:{
                xtype: 'textfield'
            }
		}
	],
	tbar: [
		'->',
		{
			text: _('procedure'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId:'ProceduresHistoryGridAddBtn'
		}
	]
});

Ext.define('App.view.patient.CognitiveAndFunctionalStatus', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.RowFormEditing',
		'App.ux.LiveSnomedSearch',
		'App.store.patient.CognitiveAndFunctionalStatus'
	],
	xtype: 'patientcognitiveandfunctionalstatuspanel',
	title: _('func_stat'),
	columnLines: true,
	store: Ext.create('App.store.patient.CognitiveAndFunctionalStatus', {
		remoteFilter: true
	}),
	plugins: [
		{
			ptype: 'rowediting',
			errorSummary: false
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove')
				}
			]
		},
		{
			header: _('category'),
			width: 150,
			dataIndex: 'category',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 117,
				itemId: 'functionalStatusCategoryCombo',
				allowBlank: false
			}
		},
		{
			header: _('description'),
			flex: 1,
			dataIndex: 'code_text',
			editor: {
				xtype: 'snomedlivesearch',
				itemId: 'functionalStatusCodeCombo',
				displayField: 'Term',
				valueField: 'Term',
				allowBlank: false
			}
		},
		{
			header: _('note'),
			flex: 2,
			dataIndex: 'note',
			editor: {
				xtype: 'textfield'
			}
		},
		{
			xtype: 'datecolumn',
			header: _('begin_date'),
			dataIndex: 'begin_date',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield',
				format: 'Y-m-d'
			}
		},
		{
			xtype: 'datecolumn',
			header: _('end_date'),
			dataIndex: 'end_date',
			format: 'Y-m-d',
			editor: {
				xtype: 'datefield',
				format: 'Y-m-d'
			}
		},
		{
			header: _('status'),
			dataIndex: 'status',
			editor: {
				xtype: 'gaiaehr.combo',
				list: 118,
				itemId: 'functionalStatusSatausCombo',
				allowBlank: false
			}
		}
	],
	tbar: [
		'->',
		'-',
		{
			text: _('add_new'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId: 'newFunctionalStatusBtn'
		}
	]
});
Ext.define('App.view.patient.SocialPanel', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.view.patient.SmokingStatus',
		'App.view.patient.SocialHistory'
	],
	xtype: 'patientsocialpanel',
	title: _('soc_hx'),
	border: false,
	bodyBorder: false,
	layout: {
		type: 'vbox',
		align: 'stretch'
	},
	items: [
		{
			xtype: 'patientsmokingstatusgrid',
			margin: '0 0 5 0',
			flex: 1
		},
		{
			xtype: 'patientsocialhistorypanel',
			flex: 2
		}
	]
});
Ext.define('App.ux.combo.MedicationInstructions', {
	extend: 'Ext.form.ComboBox',
	xtype: 'medicationinstructionscombo',
	queryMode: 'local',
	displayField: 'instruction',
	valueField: 'instruction',
	store: Ext.create('App.store.administration.MedicationInstructions')
});
Ext.define('App.ux.form.fields.plugin.HelpIcon', {
	extend: 'Ext.AbstractPlugin',
	alias: 'plugin.helpicon',
	iconSrc: 'resources/images/icons/icohelp.png',
	iconHeight: 16,
	iconWidth: 16,
	iconMargin: '0 5',
	init: function(field){
		field.on('render', this.addHelpIcon, this);
	},
	addHelpIcon: function(field){
		var me = this,
			tpl = '<td><img src="' + me.iconSrc + '" height="' + me.iconHeight + '" width="' + me.iconWidth + '" style="margin:' + me.iconMargin + '"></td>',
			tplDom;

		tplDom = Ext.DomHelper.append(field.inputRow, tpl, true);

		Ext.create('Ext.tip.ToolTip', {
			target: tplDom,
			dismissDelay: 0,
			html: me.helpMsg || field.helpMsg || 'Help Message...'
		});
	}
});
Ext.define('App.ux.combo.AllergiesReaction',{
		extend: 'Ext.form.ComboBox',
		alias: 'widget.mitos.allergiesreactioncombo',
		initComponent: function(){
			var me = this;

			// Define the Model on the Fly
			Ext.define('allergiesreactionModel',{
				extend: 'Ext.data.Model',
				fields: [
					{
						name: 'option_name',
						type: 'string'
					},
					{
						name: 'option_value',
						type: 'string'
					}
				],
				proxy: {
					type: 'direct',
					api: {
						read: 'CombosData.getOptionsByListId'
					}
				}
			});

			Ext.apply(this,{
				editable: false,
				queryMode: 'local',
				displayField: 'option_name',
				valueField: 'option_value',
				emptyText: _('select'),
				store: Ext.create('Ext.data.Store',{
					model: 'allergiesreactionModel',
					autoLoad: false
				})
			});
			me.callParent(arguments);
		}
	});
Ext.define('App.ux.combo.Insurances', {
	extend: 'App.ux.combo.ComboResettable',
	alias: 'widget.insurancescombo',
	displayField: 'combo_text',
	valueField: 'id',
	emptyText: _('select'),
	editable: false,

	store: Ext.create('App.store.administration.InsuranceCompanies', {
		autoLoad: true,
		pageSize: 500
	})
}); 
Ext.define('App.ux.combo.Burners', {
    extend: 'Ext.form.ComboBox',
    xtype: 'burnerscombo',
    editable: false,
    queryMode: 'local',
    valueField: 'id',
    displayField: 'description',
    emptyText: _('select_burner'),
    initComponent: function () {
        var me = this;

        Ext.define('BurnersComboModel', {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'id', type: 'int'},
                {name: 'facility_id', type: 'int'},
                {name: 'description', type: 'string'},
                {name: 'aet', type: 'string'},
                {name: 'ip', type: 'string'},
                {name: 'port', type: 'string'},
                {name: 'path', type: 'string'},
                {name: 'url', type: 'string'},
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'WorkListPacs.getFacilityBurners'
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'BurnersComboModel',
            autoLoad: true
        });

        app.on('appfacilitychanged', function () {
            me.store.load(function (records, operation, success) {
                if (me.store.getCount() > 0) {
                	me.setValue(me.store.first());
                } else {
					me.setValue(null);
                }
            });
        });

        me.callParent(arguments);
    }
});
/*!
 * Ext.ux.RatingField
 *
 * Copyright 2011, Dan Harabagiu
 * Licenced under the Apache License Version 2.0
 * See LICENSE
 *
 *
 * Version : 0.1 - Initial coding
 * Version : 0.2
 *  - Added Field reset button
 *  - Added CSS class for reset button
 *  - Added reset function for the field
 *  - Minimum number of stars is 2
 *  - On creation default value is now 0, was null
 *  - Option to choose left / right for the reset button position
 */
/*global Ext : false, */
Ext.define('App.ux.TopazSignature', {
	extend: 'Ext.Img',
	xtype: 'topazsignature',

	signatureObj: undefined,
	extensionDataElement: undefined,
	signatureEvt: undefined,

	style: 'background-color:white;border:solid 1px #1a9bfc',

	firstName: '',
	lastName: '',
	eMail: '',

	initComponent: function () {

		var me = this;

		me.callParent();
		me.on('afterrender', function () {

			Ext.Function.defer(function () {

				Ext.create('Ext.tip.ToolTip', {
					target: me.imgEl,
					html: 'Double Click to Capture Signature',
					showDelay: 10,
					hideDelay: 10,
					trackMouse: true
				});

			}, 250, me);

			me.el.on('dblclick', me.StartSignature, me);

		}, me);



	},

	onDestroy: function () {
		delete this.signatureObj;
		delete this.extensionDataElement;
		delete this.signatureEvt;
		this.callParent();
	},

	StartSignature: function(){

		if(this.fireEvent('beforesignature', this) === false) return;

		var me = this,
			message = {
				firstName: me.firstName || '',
				lastName: me.lastName || '',
				eMail: me.email || '',
				location: "",
				imageFormat: 1,
				imageX: me.getWidth(),
				imageY: me.getHeight(),
				imageTransparency: false,
				imageScaling: false,
				maxUpScalePercent: 0.0,
				rawDataFormat: "ENC",
				minSigPoints: 25
				// "displayCustomTextDetails": 1,
				// "customTextPercent": 50,
				// "customTextLine1": 'Text One',
				// "customTextLine2": 'Text Two',
			};

		document.addEventListener('SignResponse', function (event) {
			me.SignResponse(event);
		}, false);

		var messageData = JSON.stringify(message);

		me.imgEl.dom.setAttribute("messageAttribute", messageData);
		me.signatureEvt = document.createEvent("Events");
		me.signatureEvt.initEvent("SignStartEvent", true, false);
		me.imgEl.dom.dispatchEvent(me.signatureEvt);
	},

	SignResponse: function (event) {
		var me = this,
			str = event.target.getAttribute("msgAttribute"),
			obj = JSON.parse(str);

		this.SetValues(obj);
	},

	SetValues: function (objResponse) {

		var me = this,
			obj = JSON.parse(JSON.stringify(objResponse));

		if (obj.errorMsg != null && obj.errorMsg != "" && obj.errorMsg != "undefined") {
			app.msg(_('oops'), obj.errorMsg, true);
		}
		else {
			if (obj.isSigned) {

				me.signatureObj = obj;
				me.setSrc("data:image/png;base64," + obj.imageData);

				if(this.fireEvent('signature', me, me.signatureObj) === false) return;

			}
		}
	}
});
Ext.define('App.ux.form.SearchField', {
	extend: 'Ext.form.field.Trigger',

	alias: 'widget.gaiasearchfield',

	trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',

	trigger2Cls: Ext.baseCSSPrefix + 'form-search-trigger',

	hasSearch : false,
	paramName : 'query',

	filterFn: null,
	autoSearch: false,
	autoSearchDelay: 500,

	initComponent: function() {
		var me = this;

		me.callParent(arguments);

		if(me.autoSearch){
			me.initAutoSearch();
		}else{
			me.initSpecialKey();
		}

		// We're going to use filtering
		me.store.remoteFilter = me.filterFn === null;

		if(!me.store.remoteFilter) return;

		// Set up the proxy to encode the filter in the simplest way as a name/value pair

		// If the Store has not been *configured* with a filterParam property, then use our filter parameter name
		if (!me.store.proxy.hasOwnProperty('filterParam')) {
			me.store.proxy.filterParam = me.paramName;
		}
		me.store.proxy.encodeFilters = function(filters) {
			return filters[0].value;
		}
	},

	initSpecialKey: function(){
		this.on('specialkey', function(f, e){
			if (e.getKey() == e.ENTER) {
				this.onTrigger2Click();
			}
		}, this);
	},

	initAutoSearch: function(){
		var bufferedFn = Ext.Function.createBuffered(function () {
				this.onTrigger2Click();
			}, this.autoSearchDelay, this);

		this.enableKeyEvents = true;
		this.on('keyup', function(f, e){
			bufferedFn();
		}, this);
	},

	afterRender: function(){
		this.callParent();
		this.triggerCell.item(0).setDisplayed(false);
	},

	updateLayout: function () {
		say('updateLayout');
		say(this);

		if(this.hasSearch){
			this.inputEl.applyStyles({
				backgroundColor: 'yellow',
				backgroundImage: 'none',
				color: 'black'
			});
		}else {
			this.inputEl.applyStyles({
				backgroundColor: null,
				backgroundImage: null,
				color: null
			});
		}

		this.callParent();
	},

	onTrigger1Click : function(){
		var me = this;

		if (me.hasSearch) {
			me.setValue('');
			me.store.clearFilter();
			me.hasSearch = false;
			me.triggerCell.item(0).setDisplayed(false);
			me.updateLayout();
		}
	},

	onTrigger2Click : function(){
		var me = this,
			value = me.getValue();

		if (value.length > 0) {
			// Param name is ignored here since we use custom encoding in the proxy.
			// id is used by the Store to replace any previous filter

			if(me.store.remoteFilter){
				me.store.filter({
					id: me.paramName,
					property: me.paramName,
					value: value
				});
			}else{
				me.store.filter({
					id: me.paramName,
					filterFn: function(record){
						return me.filterFn(record, value);
					}
				});
			}

			me.hasSearch = true;
			me.triggerCell.item(0).setDisplayed(true);
			me.updateLayout();
		}else{
			me.onTrigger1Click();
		}
	}
});
Ext.define('App.model.administration.EducationResource', {
	extend: 'Ext.data.Model',
	table: {
		name: 'education_resources'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'code',
			type: 'string',
			len: 40
		},
		{
			name: 'code_text',
			type: 'string',
			len: 300
		},
		{
			name: 'code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'title',
			type: 'string',
			len: 180
		},
		{
			name: 'publication_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'publication_date_formatted',
			type: 'string',
			store: false,
			convert: function(val, rec){
				return Ext.Date.format(rec.get('publication_date'), g('date_display_format'));
			}
		},
		{
			name: 'version',
			type: 'string',
			len: 10
		},
		{
			name: 'path',
			type: 'string',
			len: 600
		},
		{
			name: 'activve',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'EducationResources.getEducationResources'
		}
	}
});
Ext.define('App.model.administration.Allergies', {
	extend: 'Ext.data.Model',
	table: {
		name: 'allergies',
		comment: 'Allergies'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'allergy',
			type: 'string',
			len: 500,
			comment: 'Allergy Name'
		},
		{
			name: 'allergy_term',
			type: 'string'
		},
		{
			name: 'allergy_code',
			type: 'string',
			len: 20
		},
		{
			name: 'allergy_code_type',
			type: 'string',
			len: 15
		},
		{
			name: 'allergy_type',
			type: 'string',
			len: 5,
			comment: 'PT = Preferred Term, SN = Systematic Name, SY = Synonym, CD = Code, TR = Trade'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Allergies.searchAllergiesData'
		},
		reader: {
			root: 'data'
		}
	}
});
Ext.define('App.model.administration.CPT', {
	extend: 'Ext.data.Model',
	table: {
		name: 'cpt_codes'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'ConceptID',
			type: 'int',
			dataType: 'bigint'
		},
		{
			name: 'code',
			type: 'string',
			len: 50
		},
		{
			name: 'code_text',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'code_text_medium',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'code_text_short',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'code_type',
			type: 'string',
			store: false
		},
		{
			name: 'isRadiology',
			type: 'bool'
		},
		{
			name: 'modality',
			type: 'string'
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'CPT.getCPTs',
			create: 'CPT.addCPT',
			update: 'CPT.updateCPT',
			destroy: 'CPT.deleteCPT'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.view.patient.RxOrders', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.ux.grid.RowFormEditing',
		'Ext.grid.feature.Grouping',
		'Ext.selection.CheckboxModel',
		'App.ux.combo.PrescriptionHowTo',
		'App.ux.combo.PrescriptionTypes',
		'App.ux.combo.EncounterICDS',
		'App.ux.combo.MedicationInstructions',
		'App.ux.LiveRXNORMSearch',
		'App.ux.form.fields.plugin.HelpIcon'
	],
	xtype: 'patientrxorderspanel',
	title: _('rx_orders'),
	columnLines: true,
	tabConfig: {
		cls: 'order-tab'
	},
	itemId: 'RxOrderGrid',
	store: Ext.create('App.store.patient.RxOrders', {
		storeId: 'RxOrderStore',
		remoteFilter: true,
		pageSize: 200,
		sorters: [
			{
				property: 'date_ordered',
				direction: 'DESC'
			}
		]
	}),
	selModel: Ext.create('Ext.selection.CheckboxModel', {
		showHeaderCheckbox: false
	}),
	plugins: [
		{
			ptype: 'rowformediting',
			clicksToEdit: 2,
			items: [
				{
					xtype: 'container',
					layout: {
						type: 'hbox',
						align: 'stretch'
					},
					itemId: 'RxOrderGridFormContainer',
					items: [
						{
							xtype: 'container',
							layout: 'anchor',
							itemId: 'RxOrderGridFormContainerOne',
							items: [
								{
									xtype: 'container',
									margin: '5 0',
									layout: {
										type: 'hbox'
									},
									items: [
										{
											xtype: 'datefield',
											fieldLabel: _('order_date'),
											format: 'Y-m-d',
											name: 'date_ordered',
											width: 200,
											allowBlank: false,
											margin: '0 10 0 0'
										},
										{
											xtype: 'gaiaehr.combo',
											fieldLabel: _('unable_to_perform'),
											labelWidth: 120,
											width: 310,
											editable: false,
											labelAlign: 'right',
											listKey: 'unable_to_perform_rx',
											name: 'not_performed_code',
											itemId: 'RxOrderGridFormUnableToPerformField',
											resetable: true
										},
										{
											xtype: 'checkboxfield',
											fieldLabel: _('administer_in_house'),
											tooltip: _('administer_in_house'),
											labelWidth: 120,
											labelAlign: 'right',
											name: 'administer_in_house'
										}
									]
								},

								{
									xtype: 'rxnormlivetsearch',
									itemId: 'RxNormOrderLiveSearch',
									hideLabel: false,
									fieldLabel: _('medication'),
									width: 700,
									name: 'STR',
									maxLength: 255,
									displayField: 'STR',
									valueField: 'STR',
									vtype: 'nonspecialcharactersrequired',
									allowBlank: false
								},
								{
									xtype: 'container',
									margin: '5 0',
									layout: {
										type: 'hbox'
									},
									items: [
										{
											xtype: 'numberfield',
											width: 170,
											fieldLabel: _('dispense'),
											minValue: 0,
											maxValue: 99999,
											name: 'dispense',
											decimalPrecision: 3,
											maxLength: 10,
											allowBlank: false,
											fixPrecision: function (value) {
												var me = this,
													nan = isNaN(value),
													precision = me.decimalPrecision,
													num,
													numArr;

												if (nan || !value) {
													return nan ? '' : value;
												} else if (!me.allowDecimals || precision <= 0) {
													precision = 0;
												}
												num = String(value);
												if (num.indexOf('.') !== -1) {
													numArr = num.split(".");
													if (numArr.length == 1) {
														return Number(num);
													} else {
														return Number(numArr[0] + "." + numArr[1].charAt(0) + numArr[1].charAt(1) + numArr[1].charAt(2));
													}
												} else {
													return Number(num);
												}
											}
										},
										{
											xtype: 'numberfield',
											width: 120,
											fieldLabel: _('days_supply'),
											labelAlign: 'right',
											labelWidth: 75,
											minValue: 1,
											maxValue: 630,
											allowDecimals: false,
											name: 'days_supply'
										},
										{
											xtype: 'numberfield',
											width: 90,
											fieldLabel: _('refill'),
											labelAlign: 'right',
											labelWidth: 40,
											maxValue: 99,
											minValue: 0,
											name: 'refill',
											vtype: 'numeric',
											allowBlank: false
										},
										{
											xtype: 'numberfield',
											width: 90,
											fieldLabel: _('dose'),
											labelAlign: 'right',
											labelWidth: 40,
											maxValue: 99,
											minValue: 0,
											name: 'dose',
											vtype: 'numeric'
										},
										{
											xtype: 'combobox',
											width: 222,
											fieldLabel: _('route'),
											labelAlign: 'right',
											labelWidth: 40,
											name: 'route',
											editable: false,
											store: [
												['C38238', 'Intradermal'],
												['C28161', 'Intramuscular'],
												['C38276', 'Intravenous'],
												['C38284', 'Nasal'],
												['C38288', 'Oral'],
												['C38676', 'Percutaneous'],
												['C38299', 'Subcutaneous'],
												['C38305', 'Transdermal']
											]
										},
									]
								},
								{
									xtype: 'encountericdscombo',
									itemId: 'RxEncounterDxCombo',
									fieldLabel: _('dx'),
									labelAlign: 'right',
									labelWidth: 30,
									width: 295,
									name: 'dxs'
								},
								{
									xtype: 'medicationinstructionscombo',
									itemId: 'RxOrderMedicationInstructionsCombo',
									width: 700,
									fieldLabel: _('instructions'),
									name: 'directions',
									maxLength: 255,
									validateOnBlur: true,
									vtype: 'nonspecialcharactersrequired',
									allowBlank: false
								},
								{
									xtype: 'textfield',
									width: 680,
									fieldLabel: '*' + _('notes_to_pharmacist'),
									itemId: 'RxOrderGridFormNotesField',
									name: 'notes',
									plugins: [
										{
											ptype: 'helpicon',
											helpMsg: _('rx_notes_to_pharmacist_warning')
										}
									],
									maxLength: 210
								},
								{
									xtype: 'container',
									html: ' *' + _('rx_notes_to_pharmacist_warning'),
									margin: '0 0 0 100'
								}
							]
						},
						{
							xtype: 'container',
							layout: 'anchor',
							itemId: 'RxOrderGridFormContainerTwo',
							padding: '25 0 0 0',
							items: [
								{
									xtype: 'container',
									layout: 'hbox',
									items: [
										{
											xtype: 'checkboxfield',
											fieldLabel: _('daw'),
											tooltip: _('dispensed_as_written'),
											width: 90,
											labelWidth: 70,
											labelAlign: 'right',
											name: 'daw',
											margin: '0 0 5 0'
										},
										{
											xtype: 'checkboxfield',
											fieldLabel: _('is_comp'),
											tooltip: _('is_compound'),
											width: 85,
											labelWidth: 65,
											labelAlign: 'right',
											name: 'is_compound',
											itemId: 'RxOrderCompCheckBox',
											margin: '0 0 5 0'
										},
										{
											xtype: 'checkboxfield',
											fieldLabel: _('is_sply'),
											tooltip: _('is_supply'),
											width: 85,
											labelWidth: 65,
											labelAlign: 'right',
											name: 'is_supply',
											itemId: 'RxOrderSplyCheckBox',
											margin: '0 0 5 0'
										}
									]
								},
								{
									xtype: 'datefield',
									fieldLabel: _('begin_date'),
									labelWidth: 70,
									labelAlign: 'right',
									width: 258,
									format: 'Y-m-d',
									name: 'begin_date',
									margin: '0 0 5 0',
									allowBlank: false
								},
								{
									xtype: 'datefield',
									fieldLabel: _('end_date'),
									labelWidth: 70,
									labelAlign: 'right',
									format: 'Y-m-d',
									width: 258,
									name: 'end_date',
									itemId: 'RxOrderEndDateField'
								}
							]
						},
						{
							xtype: 'fieldset',
							title: _('active_drug_allergies'),
							html: _('none'),
							margin: '25 0 5 10',
							flex: 1,
							itemId: 'RxOrderActiveDrugAllergyFieldset'
						}
					]
				}
			]
		}
	],
	columns: [
		{
			xtype: 'actioncolumn',
			width: 20,
			items: [
				{
					icon: 'resources/images/icons/cross.png',
					tooltip: _('remove'),
					handler: function (grid, rowIndex, colIndex, item, e, record) {
						App.app.getController('patient.RxOrders').onRxOrdersDeleteActionHandler(grid, rowIndex, colIndex, item, e, record);
					}
				}
			]
		},
		{
			xtype: 'datecolumn',
			header: _('date_ordered'),
			dataIndex: 'date_ordered',
			format: 'Y-m-d'
		},
		{
			header: _('medication'),
			flex: 1,
			dataIndex: 'STR'
		},
		{
			header: _('daw'),
			width: 40,
			dataIndex: 'daw',
			tooltip: _('dispensed_as_written'),
			renderer: function (v) {
				return app.boolRenderer(v);
			}
		},
		{
			header: _('dispense'),
			width: 60,
			dataIndex: 'dispense'
		},
		{
			header: _('refill'),
			width: 50,
			dataIndex: 'refill'
		},
		{
			header: _('instructions'),
			flex: 1,
			dataIndex: 'directions'
		},
		{
			header: _('related_dx'),
			width: 200,
			dataIndex: 'dxs',
			renderer: function (v) {
				return v == false || v == 'false' || v[0] == false ? '' : v;
			}
		},
		{
			xtype: 'datecolumn',
			format: 'Y-m-d',
			header: _('begin_date'),
			width: 75,
			dataIndex: 'begin_date'
		},
		{
			xtype: 'datecolumn',
			header: _('end_date'),
			width: 75,
			format: 'Y-m-d',
			dataIndex: 'end_date'
		},
		{
			header: _('active?'),
			width: 60,
			dataIndex: 'is_active',
			renderer: function (v){
				return app.boolRenderer(v);
			}
		}
	],

	dockedItems: [
		{
			xtype: 'toolbar',
			dock: 'top',
			itemId: 'RxOrdersGridTopToolbar',
			items: [
				'Show: ',
				{
					text: _('all'),
					action: 'rx_show',
					action2: 'all',
					pressed: true,
					enableToggle: true,
					toggleGroup: 'rxshowgroup'
				},
				'-',
				{
					text: _('last_6_months'),
					action: 'rx_show',
					action2: 'last_6_months',
					enableToggle: true,
					toggleGroup: 'rxshowgroup'
				},
				'-',
				{
					text: _('last_year'),
					action: 'rx_show',
					action2: 'last_year',
					enableToggle: true,
					toggleGroup: 'rxshowgroup'
				},
				'-',
				'->',
				'-',
				{
					text: _('new_order'),
					iconCls: 'icoAdd',
					action: 'encounterRecordAdd',
					itemId: 'newRxOrderBtn'
				},
				'-',
				{
					text: _('clone_order'),
					iconCls: 'icoAdd',
					disabled: true,
					margin: '0 5 0 0',
					action: 'encounterRecordAdd',
					itemId: 'cloneRxOrderBtn'
				},
				'-',
				{
					text: _('print'),
					iconCls: 'icoPrint',
					disabled: true,
					margin: '0 5 0 0',
					itemId: 'printRxOrderBtn'
				}]
		},
		{
			xtype: 'toolbar',
			dock: 'bottom',
			itemId: 'RxOrdersGridBottomToolbar',
			items: [
				{
					xtype: 'button',
					text: _('show_all_medicatios'),
					enableToggle: true,
					stateful: true,
					stateEvents: ['press'],
					stateId: 'RxOrdersShowAllMedicationsBtnState',
					itemId: 'RxOrdersShowAllMedicationsBtn',
					getState: function () {
						return {pressed: this.pressed};
					},
					applyState: function (state) {
						this.toggle(state.pressed);
					},
					listeners: {
						toggle: function (self, pressed, eOpts) {
							this.fireEvent('press');
						}
					}
				}
			]
		}
	]
});

Ext.define('App.view.patient.encounter.ProgressNotesHistory', {
	extend: 'Ext.tree.Panel',
	requires: [
		'App.ux.form.SearchField'
	],
	xtype: 'progressnoteshistory',
	title: _('history'),
	hideHeaders: true,
	cls: 'progress-motes-history-grid',
	useArrows: true,
	lines: true,
	rootVisible: false,
	multiSelect: false,
	singleExpand: false,
	initComponent: function(){

		var me = this;

		me.store = Ext.create('App.store.patient.ProgressNotesHistory',{
			sorters: [
				{
					property: 'service_date',
					direction: 'desc'
				}
			]
		});

		me.columns = [
			{
				xtype: 'treecolumn',
				dataIndex: 'progress',
				flex: 1,
				renderer: function (v, meta, record) {
					return v;
				}
			}
		];

		me.tbar = [
			{
				xtype: 'gaiasearchfield',
				emptyText: _('search'),
				flex: 1,
				itemId: 'ProgressNotesHistorySearchField',
				store: me.store,
				filterFn: function(record, value){
					return record.data.progress.search(new RegExp(value, 'ig')) !== -1;

				}
			},
			'-',
			{
				xtype: 'button',
				text: _('provider'),
				tooltip: _('show_only_same_provider_notes'),
				itemId: 'ProgressNotesHistoryMineBtn',
				enableToggle: true,
				toggleGroup: 'ProgressNotesHistoryMineBtnGroup'
			},
			'-',
			{
				xtype: 'button',
				text: _('specialty'),
				tooltip: _('show_only_same_specialty_notes'),
				itemId: 'ProgressNotesHistorySpecialtyBtn',
				enableToggle: true,
				toggleGroup: 'ProgressNotesHistorySpecialtyBtnGroup'
			}
		];

		me.callParent();
	}

});
Ext.define('App.view.patient.Encounter', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('encounter'),
	pageLayout: 'border',
	itemId: 'encounterPanel',
	requires: [
		'App.store.patient.Encounters',
		'App.store.patient.Vitals',
        'App.store.administration.EncounterEventHistory',
		'App.view.patient.encounter.SOAP',
		'App.view.patient.encounter.HealthCareFinancingAdministrationOptions',
		'App.view.patient.encounter.CurrentProceduralTerminology',
		'App.view.patient.encounter.ProgressNotesHistory',
		'App.view.patient.encounter.DictationPanel',
		'App.view.patient.encounter.NursesNotesGrid',
		'App.view.patient.ProgressNote',
		'App.view.patient.DecisionSupportWarningPanel',
		'App.ux.combo.EncounterPriority',
		'App.ux.combo.ActiveProviders'
	],

	enableCPT: eval(g('enable_encounter_cpt')),
	enableHCFA: eval(g('enable_encounter_hcfa')),
	enableSOAP: eval(g('enable_encounter_soap')),
	enableNurseNotes: true, // eval(g('enable_encounter_nurse_notes')),
	enableVitals: eval(g('enable_encounter_vitals')),
	enableEncHistory: eval(g('enable_encounter_history')),
	enableFamilyHistory: eval(g('enable_encounter_family_history')),
	enableItemsToReview: eval(g('enable_encounter_items_to_review')),
	enableReviewOfSystem: eval(g('enable_encounter_review_of_systems')),
	enableReviewOfSystemChecks: eval(g('enable_encounter_review_of_systems_cks')),
	enableClinicalDecisionSupport: eval(g('enable_clinical_decision_support')),

	showRating: true,
	conversionMethod: 'english',

	pid: null,
	eid: null,
	encounter: null,
	timerStartTime: null,
	timerWarning: 5,

	encounterServiceDate: null,

	initComponent: function(){
		var me = this;

		say('ReviewOfSystems');
		say(App.model.patient.ReviewOfSystems);
		App.model.patient.ReviewOfSystems.getFields().forEach(function(field){
			field.useNull = true;
		});


		me.renderAdministrative = a('access_enc_hcfa') || a('access_enc_cpt') || a('access_enc_history');
		me.encounterCtrl = app.getController('patient.encounter.Encounter');

		me.timerTask = {
			scope: me,
			run: me.encounterTimer,
			interval: 1000 //1 second
		};

		/**
		 * stores
		 * @type {*}
		 */
		me.encounterStore = Ext.create('App.store.patient.Encounters', {
			listeners: {
				scope: me,
				datachanged: me.getProgressNote
			}
		});

        me.encounterEventHistoryStore = Ext.create('App.store.administration.EncounterEventHistory');

		if(me.renderAdministrative){
			me.centerPanel = Ext.create('Ext.tab.Panel', {
				region: 'center',
				margin: '1 0 0 0',
				activeTab: 0,
				bodyPadding: 5,
				listeners: {
					render: function(){
						this.items.each(function(i){
							i.tab.on('click', function(){
								me.onTapPanelChange(this);
							});
						});
					}
				}
			});
		}else{
			me.centerPanel = Ext.create('Ext.panel.Panel', {
				region: 'center',
				margin: '1 0 0 0',
				layout: 'fit',
				bodyPadding: 5
			});
		}

		/**
		 * Encounter Tab Panel and its Panels...
		 * @type {*}
		 */
		me.encounterTabPanel = me.centerPanel.add(
			Ext.create('Ext.tab.Panel', {
				title: me.renderAdministrative ? _('encounter') : false,
				itemId: 'encounter',
				plain: true,
				activeItem: 0,
				border: false,
				action: 'encounterTabPanel',
				defaults: {
					bodyStyle: 'padding:15px',
					bodyBorder: true,
					layout: 'fit'
				}
			})
		);

		if(me.enableClinicalDecisionSupport && a('access_clinical_decision_support')){
			me.encounterTabPanel.addDocked({
				xtype: 'decisionsupportwarningpanel',
				itemId: 'DecisionSupportWarningPanel',
				dock: 'top'
			});
		}

		if(me.enableVitals && a('access_patient_vitals')){
			me.vitalsPanel = me.encounterTabPanel.add(
				Ext.create('App.view.patient.Vitals')
			);
		}

		//if(me.enableNurseNotes && a('access_enc_nurse_notes')){
			me.encounterTabPanel.add(
				Ext.create('App.view.patient.encounter.NursesNotesGrid', {
					padding: 0,
					bodyPadding: 0
				})
			);
		//}

		if(me.enableReviewOfSystem && a('access_review_of_systems')){
			me.reviewSysPanel = me.encounterTabPanel.add(
				Ext.create('Ext.form.Panel', {
					autoScroll: true,
					action: 'encounter',
					itemId: 'ReviewOfSystemForm',
					title: _('review_of_systems'),
					frame: true,
					bodyPadding: 5,
					//bodyStyle: 'background-color:white',
					fieldDefaults: {
						msgTarget: 'side'
					},

					plugins: {
						ptype: 'advanceform',
						autoSync: g('autosave'),
						syncAcl: a('edit_encounters')
					},
					buttons: [
						{
							xtype: 'button',
							icon: 'resources/images/icons/gear.png',
							itemId: 'ReviewOfSystemSetupBtn',
							minWidth: null
						},
						'->',
						{
							text: _('save'),
							iconCls: 'save',
							action: 'reviewOfSystems',
							scope: me,
							itemId: 'encounterRecordAdd',
							handler: me.onEncounterUpdate
						}
					]
				})
			);
		}

		if(me.enableReviewOfSystemChecks && a('access_review_of_systems_checks')){
			me.reviewSysCkPanel = me.encounterTabPanel.add(
				Ext.create('Ext.form.Panel', {
					autoScroll: true,
					action: 'encounter',
					title: _('review_of_systems_checks'),
					frame: true,
					bodyPadding: 5,
					bodyStyle: 'background-color:white',
					fieldDefaults: {
						msgTarget: 'side'
					},
					plugins: {
						ptype: 'advanceform',
						autoSync: g('autosave'),
						syncAcl: a('edit_encounters')
					},
					buttons: [
						{
							text: _('save'),
							iconCls: 'save',
							action: 'reviewOfSystemsChecks',
							scope: me,
							itemId: 'encounterRecordAdd',
							handler: me.onEncounterUpdate
						}
					]
				})
			);
		}

		if(me.enableItemsToReview && a('access_itmes_to_review')){
			me.itemsToReview = me.encounterTabPanel.add(
				Ext.create('App.view.patient.ItemsToReview', {
					title: _('items_to_review'),
					bodyPadding: '7 5 2 5'
				})
			);
		}

		if(a('access_patient_psy_behavioral')){
			me.encounterTabPanel.add(
				Ext.create('App.view.patient.SocialPsychologicalBehavioral', {
					itemId: 'SocialPsychologicalBehavioralPanel',
					bodyPadding: '7 5 2 5'
				})
			);
		}

		if(a('access_patient_mini_mental_state_exam')){
			me.encounterTabPanel.add(
				Ext.create('App.view.patient.MiniMentalStateExam', {
					padding: 0,
					bodyPadding: 0
				})
			);
		}

		if(me.enableSOAP && a('access_soap')){
			me.soapPanel = me.encounterTabPanel.add(
				Ext.create('App.view.patient.encounter.SOAP', {
					bodyStyle: 'padding:0',
					enc: me
				})
			);
		}

		if(me.enableSOAP && a('access_dictation')){
			me.dicatationPanel = me.encounterTabPanel.add(
				Ext.create('App.view.patient.encounter.DictationPanel', {
					bodyStyle: 'padding:0',
					enc: me
				})
			);
		}

		/**
		 * Administravive Tab Panel and its Panels
		 * @type {*}
		 */
		if((me.enableHCFA && a('access_enc_hcfa')) ||
			(me.enableCPT && a('access_enc_cpt')) ||
			(me.enableEncHistory && a('access_enc_history'))){
			me.administrativeTabPanel = me.centerPanel.add(
				Ext.create('Ext.tab.Panel', {
					title: _('administrative'),
					itemId: 'administrative',
					plain: true,
					activeItem: 0,
					defaults: {
						bodyStyle: 'padding:15px',
						bodyBorder: true,
						layout: 'fit'
					}
				})
			);
		}

		if(me.enableHCFA && a('access_enc_hcfa')){
			me.MiscBillingOptionsPanel = me.administrativeTabPanel.add(
				Ext.create('App.view.patient.encounter.HealthCareFinancingAdministrationOptions', {
					autoScroll: true,
					title: _('misc_billing_options_HCFA_1500'),
					frame: true,
					bodyPadding: 5,
					bodyStyle: 'background-color:white',
					fieldDefaults: {
						msgTarget: 'side'
					},
					plugins: {
						ptype: 'advanceform',
						autoSync: g('autosave'),
						syncAcl: a('edit_enc_hcfa')
					},
					buttons: [
						{
							text: _('save'),
							iconCls: 'save',
							action: 'soap',
							scope: me,
							handler: me.onEncounterUpdate
						}
					]
				})
			);
		}

		if(me.enableCPT && a('access_enc_cpt')){
			me.CurrentProceduralTerminology = me.administrativeTabPanel.add(
				Ext.create('App.view.patient.encounter.CurrentProceduralTerminology', {
					title: _('current_procedural_terminology')
				})
			);
		}

		if(me.enableEncHistory && a('access_enc_history')){
			me.EncounterEventHistory = me.administrativeTabPanel.add(
				Ext.create('App.ux.grid.EventHistory', {
					bodyStyle: 0,
					title: _('encounter_history'),
					store: me.encounterEventHistoryStore
				})
			);
		}

		/**
		 * Progress Note
		 */
		me.rightPanel = Ext.create('Ext.tab.Panel', {
			title: _('encounter_progress_note'),
			width: 500,
			region: 'east',
			split: true,
			collapsible: true,
			animCollapse: false,
			collapsed: true,
			deferredRender: false,
			bodyPadding: 0,
			margin: 0,
			padding: 0,
			stateful: true,
			stateId: 'EncounterProgressNotesPanel',
			itemId: 'EncounterProgressNotesPanel',
			listeners: {
				scope: this,
				collapse: me.progressNoteCollapseExpand,
				expand: me.progressNoteCollapseExpand
			},
			items: [
				{
					xtype:'progressnoteshistory',
					itemId: 'EncounterProgressNotesHistoryGrid'
				},
				me.progressNote = Ext.create('App.view.patient.ProgressNote', {
					title: _('progress_note'),
					itemId: 'EncounterProgressNotePanel',
					autoScroll: true,
					bodyPadding: 0,
					margin: 0,
					padding: 0,
					cls: 'progress-motes-history',
					tbar: [
						'->',
						{
							xtype: 'button',
							type: 'print',
							text: _('print'),
							icon: 'resources/images/icons/printer.png',
							tooltip: _('print_progress_note'),
							scope: me,
							handler: function(){
								var win = window.open(
                                    'print.html',
                                    'win',
                                    'left=20,top=20,width=700,height=700,toolbar=0,resizable=1,location=1,scrollbars=1,menubar=0,directories=0'
                                );
								var dom = me.progressNote.body.dom;
								var wrap = document.createElement('div');
								var html = wrap.appendChild(dom.cloneNode(true));
								win.document.write(html.innerHTML);
								Ext.Function.defer(function(){
									win.print();
								}, 1000);
							}
						}
					]
				}),
				{
					xtype: 'patientdocumentspanel',
					orientation: 'east'
				}
			]
		});

		var medical_btns = app.getController('patient.Medical').getMedicalTabButtons();

		Ext.Array.push(medical_btns, [
			'-',
			'->',
			'-',
			{
				xtype:'button',
				action: 'ccda',
				itemId: 'EncounterCDAImportBtn',
				tooltip: _('ccda_import'),
				icon: 'resources/images/icons/icoOutbox.png'
			},
			'-',
			{
				xtype:'button',
				itemId: 'EncounterNewProgressNoteBtn',
				text: _('new_progress_note')
			},
			'-',
			{
				xtype:'button',
				action: 'encounter',
				text: _('encounter_details')
			},
			'-',
			me.priorityCombo = Ext.create('App.ux.combo.EncounterPriority', {
				listeners: {
					scope: me,
					select: me.prioritySelect
				}
			}),
			'-'
		]);

		me.panelToolBar = Ext.create('Ext.toolbar.Toolbar', {
			dock: 'top',
			itemId: 'EncounterMedicalToolbar',
			defaults: {
				scope: me,
				handler: me.onToolbarBtnHandler
			},
			items: medical_btns
		});

		if(a('access_encounter_checkout')){
			me.panelToolBar.add({
				text: _('sign'),
				icon: 'resources/images/icons/edit.png',
				itemId: 'EncounterMedicalToolbarSignBtn',
				handler: me.onSignEncounter
			}, '-');
		}
		if(a('access_encounter_addenda')){
			me.panelToolBar.add({
				text: _('addendum'),
				iconCls: 'far fa-plus-circle',
				cls: 'btnRedBackground',
				itemId: 'EncounterMedicalToolbarAddendumAddBtn'
			}, '-');
		}

		me.panelToolBar.add({
			xtype: 'combobox',
			tooltip: 'Timer Warning',
			value: me.timerWarning,
			editable: false,
			width: 75,
			store: [
				[5, '5 min'],
				[10, '10 min'],
				[15, '15 min'],
				[20, '20 min'],
				[30, '30 min'],
				[45, '45 min'],
				[60, '60 min'],
			],
			listeners: {
				change: function (cmb, value) {
					me.timerWarning = value;
				}
			}
		}, '-');

		me.pageBody = [me.centerPanel, me.rightPanel];

		me.listeners = {
			beforerender: me.beforePanelRender
		};

		me.callParent();
		me.down('panel').addDocked(me.panelToolBar);

	},

	/**
	 * opens the Medical window
	 * @param btn
	 */
	onToolbarBtnHandler: function(btn){
		if(btn.action === 'encounter'){
			app.updateEncounter(this.encounter);
		}else if(btn.action === 'ccda'){
			// this will be handled at controller/CCDImport.js
		}else if(btn.itemId === 'EncounterPatientDocumentsBtn'){
			// do nothing
		}else{
			app.onMedicalWin(btn.action);
		}
	},

	/**
	 * opens the Chart window
	 */
	onChartWindowShow: function(){
		app.onChartsWin();
	},

	prioritySelect: function(cmb, records){
		this.changeEncounterPriority(records[0].data.option_value);
	},

	changeEncounterPriority: function(priority){
		var me = this, params = {
			pid: me.pid,
			eid: me.eid,
			priority: priority
		};
		Encounter.updateEncounterPriority(params, function(){
			app.patientButtonRemoveCls();
			app.patientBtn.addCls(priority);
		});
		me.getProgressNote();
	},

	/**
	 * Sends the data to the server to be saved.
	 * This function needs the button action to determine
	 * which form  to save.
	 * @param SaveBtn
	 */
	onEncounterUpdate: function(SaveBtn){
		var me = this,
			form,
            values,
            store,
            record,
            storeIndex;

		if(SaveBtn.action === "encounter"){
			form = me.newEncounterWindow.down('form').getForm();
		}else{
			form = SaveBtn.up('form').getForm();
		}

		if(form.isValid()){
			values = form.getValues(false, true);

			if(SaveBtn.action === 'encounter'){

				if(a('add_encounters')){
					record = form.getRecord();
					record.set(values);
					record.save({
						callback: function(record){
							var data = record.data;
							app.patientButtonRemoveCls();
							app.patientBtn.addCls(data.priority);
							me.openEncounter(data.eid);
							SaveBtn.up('window').hide();
						}
					});
				}else{
					SaveBtn.up('window').close();
					app.accessDenied();
				}

			}else{

				if(a('edit_encounters')){
					record = form.getRecord();
					store = record.store;
					values = me.addDefaultData(values);
					record.set(values);
					app.fireEvent('encounterbeforesync', me, store, form, record);
					store.sync({
						callback: function(){
							app.fireEvent('encountersync', me, store, form, record);
							me.msg(_('sweet'), _('encounter_updated'));
						}
					});

					me.encounterEventHistoryStore.load({
						filters: [
							{
								property: 'eid',
								value: me.eid
							}
						]
					});

				}else{
					app.accessDenied();
				}
			}
		}
	},

	/**
	 * Takes the form data to be send and adds the default
	 * data used by every encounter form. For example
	 * pid (Patient ID), eid (Encounter ID), uid (User ID),
	 * and date (Current datetime as 00-00-00 00:00:00)
	 * @param data
	 */
	addDefaultData: function(data){
		data.pid = this.pid;
		data.eid = this.eid;
		data.uid = user.id;
		data.date = Ext.Date.format(new Date(), 'Y-m-d H:i:s');
		return data;
	},

	/**
	 *
	 * @param eid
	 */
	openEncounter: function(eid){
		var me = this,
			vitals,
			record,
			store;

		me.el.mask(_('loading...') + ' ' + _('encounter') + ' - ' + eid);
		me.resetTabs();

		if(me.encounter) delete me.encounter;

		App.model.patient.Encounter.load(eid, {
			scope: me,
			callback: function(record){
				var timer,
					data;

				if(record.get('is_private') && record.get('provider_uid') !== app.user.id && !a('global_private_encounter_access')){
					// go back...
					app.msg('Private Encounter', Ext.String.format('Encounter can only be accessed by {0}, {1}', record.get('provider_lname'), record.get('provider_fname')), true);
					app.getController('Navigation').goBack();
					return;
				}

				// TODO: add permission... disabled it for now....
				if(false && app.user.is_attending && record.get('provider_uid') !== app.user.id){
					// go back...
					app.msg('Oops!', Ext.String.format('This encounter is owned by {0}, {1}', record.get('provider_lname'), record.get('provider_fname')), true);
					app.getController('Navigation').goBack();
					return;
				}

				me.encounter = record;
				data = me.encounter.data;

				// set pid globally for convenient use
				me.pid = data.pid;
				me.eid = data.eid;

				me.encounterServiceDate = data.service_date;

				app.fireEvent('beforeencounterload', me.encounter, me);

				/** get progress note **/
				me.getProgressNote();
				var patient = app.patient;

				me.pageTitle = _('encounter');

				if(!data.close_date){
					me.pageTitle =  patient.name + ' - ' + patient.sexSymbol + ' - ' + patient.age.str + ' - ' + Ext.Date.format(data.service_date, 'F j, Y, g:i:s a');
					if(me.encounter.get('is_private')){
						me.pageTitle += ' <img height="20px" src="resources/images/icons/icoShield.png" data-qtip="Private Encounter">';
					}
					me.updateTitle(me.pageTitle, app.patient.readOnly, '');
					me.askStartTimer();
					me.setButtonsDisabled(me.getButtonsToDisable());
				}else{
					me.stopTimer()

					me.pageTitle =  patient.name + ' - ' + patient.sexSymbol + ' - ' + patient.age.str + ' - ' + Ext.Date.format(data.service_date, 'F j, Y, g:i:s a') + ' (' + _('closed_encounter') + ')';
					if(me.encounter.get('is_private')){
						me.pageTitle += ' <img src="resources/images/icons/icoShield.png">';
					}
					me.updateTitle(me.pageTitle, app.patient.readOnly, '');
					me.setButtonsDisabled(me.getButtonsToDisable(), true);
				}

				if(me.reviewSysPanel){
					store = me.encounter.reviewofsystems();
					store.on('write', me.getProgressNote, me);
					me.reviewSysPanel.getForm().loadRecord(store.getAt(0));
				}

				if(me.reviewSysCkPanel){
					store = me.encounter.reviewofsystemschecks();
					store.on('write', me.getProgressNote, me);
					me.reviewSysCkPanel.getForm().loadRecord(store.getAt(0));
				}

				if(me.soapPanel){
					store = me.encounter.soap();
					store.on('write', me.getProgressNote, me);
					me.soapPanel.down('form').getForm().loadRecord(store.getAt(0));
				}

				if(me.MiscBillingOptionsPanel){
					store = me.encounter.hcfaoptions();
					me.MiscBillingOptionsPanel.getForm().loadRecord(store.getAt(0));
				}

				me.priorityCombo.setValue(data.priority);

				me.encounterEventHistoryStore.load({
					filters: [
						{
							property: 'eid', value: me.eid
						}
					]
				});

				if(me.CurrentProceduralTerminology){
					me.CurrentProceduralTerminology.encounterCptStoreLoad(me.pid, me.eid, function(){
						me.CurrentProceduralTerminology.setDefaultQRCptCodes();
					});
				}

				// App.app.getController('patient.ProgressNotesHistory').loadPatientProgressHistory(data.pid, data.eid);

				app.fireEvent('encounterload', me.encounter, me);
				me.el.unmask();

			}
		});

	},

	/**
	 * Function to close the encounter..
	 */
	doSignEncounter: function(isSupervisor, callback){
		var me = this,
			form,
			values;

		if(app.fireEvent('beforeecountersign', me, me.encounter) === false) return;

		me.passwordVerificationWin(function(btn, password){
			if(btn === 'ok'){

				form = app.checkoutWindow.down('form').getForm();
				values = form.getValues();
				values.eid = me.eid;
				values.close_date = new Date();
				values.signature = password;
				values.isSupervisor = isSupervisor;

				if(a('require_enc_supervisor') || isSupervisor){
					var cmb = app.checkoutWindow.query('#EncounterCoSignSupervisorCombo')[0];
					values.requires_supervisor = true;
					values.supervisor_uid = cmb.getValue();
				}else if(!isSupervisor && !a('require_enc_supervisor')){
					values.requires_supervisor = false;
				}

				Encounter.signEncounter(values, function(provider, response){
                    var params;
					if(response.result.success){

						app.fireEvent('aferecountersign', me, me.encounter);

						me.stopTimer()

						/** default data for notes and reminder **/
						params = {
							pid: me.pid,
							eid: me.eid,
							uid: app.user.id,
							type: 'checkout',
							date: new Date()
						};

						/** create a new note if not blank **/
						params.body = values.note;
						if(params.body !== '') Ext.create('App.model.patient.Notes', params).save();
						/** create a new reminder if not blank **/
						params.body = values.reminder;
						if(params.body !== '') Ext.create('App.model.patient.Reminders', params).save();

						me.msg(_('sweet'), _('encounter_closed'));
						app.checkoutWindow.close();
						app.stowPatientRecord();
						app.getController('areas.PatientPoolAreas').doSendPatientToNextArea(me.pid);

					}else{
						Ext.Msg.show({
							title: _('oops'),
							msg: _(response.result.error),
							buttons: Ext.Msg.OK,
							icon: Ext.Msg.ERROR
						});
					}
				});
			}
		});
	},

	/**
	 * CheckOut Functions
	 */
	onSignEncounter: function(){
		var title = app.patient.name + ' #' + app.patient.pid + ' - ' + Ext.Date.format(this.encounterServiceDate, 'F j, Y, g:i:s a') + ' (' + _('checkout') + ')';
		app.checkoutWindow.enc = this;
		app.checkoutWindow.setTitle(title);
		app.checkoutWindow.show();
	},

	isClose: function(){
		return typeof this.encounter.data.close_date != 'undefined' && this.encounter.data.close_date != null;
	},

	isPrivate: function(){
		return this.encounter.get('is_private');
	},

	isSigned: function(){
		return typeof this.encounter.data.provider_uid != 'undefined' && this.encounter.data.provider_uid != null && this.encounter.data.provider_uid != 0;
	},

	/**
	 * listen for the progress note panel and runs the
	 * doLayout function to re-adjust the dimensions.
	 */
	progressNoteCollapseExpand: function(){
		this.centerPanel.doLayout();
	},

	getProgressNote: function(){
		var me = this;
		Encounter.getProgressNoteByEid(me.eid, function(provider, response){
			me.progressNote.tpl.overwrite(me.progressNote.body, response.result);
		});
	},

	onTapPanelChange: function(panel){
		//if(panel.card.itemId == 'encounter'){
		//	this.setEncounterProgressCollapsed(false);
		//}else{
		//	this.setEncounterProgressCollapsed(true);
		//}
	},

	//setEncounterProgressCollapsed: function(ans){
	//	//ans ? this.rightPanel.collapse() : this.rightPanel.expand();
	//},

	//***************************************************************************************************//
	//***************************************************************************************************//
	//*********    *****  ******    ****** **************************************************************//
	//*********  *  ****  ****  ***  ***** **************************************************************//
	//*********  **  ***  ***  *****  **** **************************************************************//
	//*********  ***  **  ***  *****  **** **************************************************************//
	//*********  ****  *  ****  ***  ********************************************************************//
	//*********  *****    *****    ******* **************************************************************//
	//***************************************************************************************************//
	//***************************************************************************************************//

	/**
	 * Start the timerTask
	 */
	askStartTimer: function(){
		var me = this;

		if(!a('use_encounter_timer')){
			return;
		}

		Ext.Msg.show({
			title: 'Encounter Timer',
			msg: 'Would you like to start encounter timer?',
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function (btn){
				if(btn === 'yes'){
					me.startTimer();
				}
			}
		});
	},
	/**
	 * Start the timerTask
	 */
	startTimer: function(){
		this.timerStartTime = app.getDate();
		Ext.TaskManager.start(this.timerTask);
		return true;
	},

	/**
	 * stops the timerTask
	 */
	stopTimer: function(){
		Ext.TaskManager.stop(this.timerTask);
		return true;
	},

	/**
	 * This will update the timer every sec
	 */
	encounterTimer: function(){
		var me = this, timer = me.timer(me.timerStartTime, app.getDate());
		if(app.patient.pid !== null){
			me.updateTitle(me.pageTitle, app.patient.readOnly, timer);
		}else{
			me.stopTimer();
		}
	},

	/**
	 * This function use the "start time" and "stop time"
	 * and gets the time elapsed between the two then
	 * returns it as a timer (00:00:00)  or (1 day(s) 00:00:00)
	 * if more than 24 hrs
	 *
	 * @param start
	 * @param stop
	 */
	timer: function(start, stop){
		var ms = Ext.Date.getElapsed(start, stop), t, sec = Math.floor(ms / 1000);

		function twoDigit(d){
			return (d >= 10) ? d : '0' + d;
		}

		var min = Math.floor(sec / 60);
		sec = sec % 60;
		t = twoDigit(sec);
		var hr = Math.floor(min / 60);

		if(min >= this.timerWarning && sec % 10 === 0){
			app.msg('INFO', 'Encounter Time Expired', 'yellow');
		}

		min = min % 60;
		t = twoDigit(min) + ":" + t;
		var day = Math.floor(hr / 24);
		hr = hr % 24;
		t = twoDigit(hr) + ":" + t;
		t = (day === 0 ) ? '<span class="time">' + t + '</span>' : '<span class="day">' + day + ' ' + _('day_s') + '</span><span class="time">' + t + '</span>';
		return t;
	},

	/**
	 * After this panel is render add the forms and listeners for conventions
	 */
	beforePanelRender: function(){
		var me = this,
			form,
			defaultFields = function(){
				return [
					{
						name: 'id',
						type: 'int'
					},
					{
						name: 'pid',
						type: 'int'
					},
					{
						name: 'eid',
						type: 'int'
					},
					{
						name: 'uid',
						type: 'int'
					}
				]
			};

		/**
		 * Get 'Review of Systems' Form and define the Model using the form fields
		 */
		if(me.reviewSysPanel){
			me.getFormItems(me.reviewSysPanel, 8, function(){

			});
		}

		/**
		 * Get 'Review of Systems Check' Form and define the Model using the form fields
		 */
		if(me.reviewSysCkPanel){
			me.getFormItems(me.reviewSysCkPanel, 9, function(){
				var formFields = me.reviewSysCkPanel.getForm().getFields(), modelFields = new defaultFields;
				for(var i = 0; i < formFields.items.length; i++){
					modelFields.push({
						name: formFields.items[i].name,
						type: 'auto'
					});
				}
				Ext.define('App.model.patient.ReviewOfSystemsCheck', {
					extend: 'Ext.data.Model',
					fields: modelFields,
					proxy: {
						type: 'direct',
						api: {
							update: 'Encounter.updateReviewOfSystemsChecks'
						}
					},
					belongsTo: {
						model: 'App.model.patient.Encounter',
						foreignKey: 'eid'
					}
				});
			});
		}
	},

	getButtonsToDisable: function(){
		var me = this,
			buttons = [];

		if(me.ButtonsToDisable === null || typeof me.ButtonsToDisable == 'undefined'){
			if(me.vitalsPanel) buttons.concat(buttons, me.vitalsPanel.query('button'));
			if(me.reviewSysPanel) buttons.concat(buttons, me.reviewSysPanel.query('button'));
			if(me.reviewSysCkPanel) buttons.concat(buttons, me.reviewSysCkPanel.query('button'));
			if(me.soapPanel) buttons.concat(buttons, me.soapPanel.down('form').query('button'));
			if(me.MiscBillingOptionsPanel) buttons.concat(buttons, me.MiscBillingOptionsPanel.query('button'));
			if(me.CurrentProceduralTerminology) buttons.concat(buttons, me.CurrentProceduralTerminology.query('button'));
			if(me.EncounterEventHistory) buttons.concat(buttons, me.EncounterEventHistory.query('button'));
			if(me.newEncounterWindow) buttons.concat(buttons, me.newEncounterWindow.query('button'));
			if(app.checkoutWindow) buttons.concat(buttons, app.checkoutWindow.query('button'));
			me.ButtonsToDisable = buttons;
		}

		return me.ButtonsToDisable;
	},

	resetTabs: function(){
		var me = this;
		if(me.renderAdministrative) me.centerPanel.setActiveTab(0);
		if(me.encounterTabPanel) me.encounterTabPanel.setActiveTab(0);
		if(me.administrativeTabPanel) me.administrativeTabPanel.setActiveTab(0);
		if(me.rightPanel) me.rightPanel.setActiveTab(0);
	},

	onDocumentView: function(grid, rowIndex){
		var rec = grid.getStore().getAt(rowIndex), src = rec.data.url;
		app.onDocumentView(src);
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		var me = this,
			patient = app.patient;

		if(patient.pid && patient.eid){
			me.updateTitle(patient.name + ' (' + _('visits') + ')', patient.readOnly, null);
			me.setReadOnly(patient.readOnly);
			callback(true);
		}else{
			callback(false);
			var msg = patient.eid === null ? 'Please create a new encounter or select one from the patient encounter history' : null;
			me.currPatientError(msg);
		}
	}
});

Ext.define('App.view.patient.DisclosuresGrid', {
    extend: 'Ext.grid.Panel',
    requires: [
        'App.ux.TopazSignature',
        'App.ux.combo.Burners'
    ],
    xtype: 'patientdisclosuresgrid',
    selType: 'checkboxmodel',
    title: _('disclosures'),
    itemId: 'PatientDisclosuresGrid',
    bodyPadding: 0,
    tbar: [
        {
            xtype: 'container',
            items: [
                {
                    xtype: 'printerscombo',
                    itemId: 'PatientDisclosuresPrinterCmb',
                    emptyText: 'Select Printer',
                    fieldLabel: 'Printer',
                    labelWidth: 45,
                    width: 250,
                    margin: '0 5 0 5'
                }
                // {
                //     xtype: 'combobox',
                //     itemId: 'PatientDisclosuresPrinterCmb',
                //     store: Ext.create('App.store.administration.Printer'),
                //     queryMode: 'local',
                //     editable: false,
                //     forceSelection: true,
                //     autoSelect: true,
                //     valueField: 'id',
                //     displayField: 'printer_description',
                //     emptyText: 'Select Printer',
                //     fieldLabel: 'Printer',
                //     // labelPad: 1,
                //     width: 200
                // }
            ]
        },
        {
            xtype: 'container',
            items: [
                {
                    xtype: 'burnerscombo',
                    itemId: 'PatientDisclosuresBurnersCmb',
                    fieldLabel: 'Burner',
                    forceSelection: true,
                    autoSelect: true,
                    labelWidth: 45,
                    width: 250
                }
            ]
        },
        '->',
        {
            xtype: 'button',
            text: _('print'),
            itemId: 'PatientDisclosuresPrintBtn',
        },
        {
            xtype: 'button',
            text: _('download'),
            itemId: 'PatientDisclosuresDownloadBtn',
        },
        {
            xtype: 'button',
            text: _('burn'),
            itemId: 'PatientDisclosuresBurnBtn',
        },
        '-',
        {
            text: _('disclosure'),
            iconCls: 'icoAdd',
            itemId: 'PatientDisclosuresGridAddBtn',
        }
    ],
    columns: [
        {
            text: _('description'),
            dataIndex: 'description',
            flex: 1,
        },
        {
            header: _('recipient'),
            dataIndex: 'recipient',
            flex: 1,
        },
        {
            xtype: 'datecolumn',
            format: 'F j, Y',
            text: _('request_date'),
            dataIndex: 'request_date',
            flex: 1,
        },
        {
            xtype: 'datecolumn',
            format: 'F j, Y',
            text: _('fulfil_date'),
            dataIndex: 'fulfil_date',
            flex: 1,
        },
        {
            xtype: 'datecolumn',
            format: 'F j, Y',
            text: _('pickup_date'),
            dataIndex: 'pickup_date',
            flex: 1,
        },
        {
            text: _('signature'),
            dataIndex: 'signature',
            flex: 1,
            renderer: function (v, meta, record) {
                meta.tdCls = record.data.rowClasses;

                var signature =  record.get('signature');

                if(signature){
                    signature = '<img src="' + signature + '" height="30" >';
                    return Ext.String.format('<div><b>Signature By:</b></div> {0}', signature);
                }

                return '';

            }
        },
        {
            xtype: 'numbercolumn',
            text: _('document_attached'),
            dataIndex: 'document_inventory_count',
            flex: 1,
            format: '0'
        }
    ],

    initComponent: function () {
        var me = this;

        me.store = Ext.create('App.store.patient.Disclosures', {
            autoSync: false,
            autoLoad: false
        });

        me.callParent();


    }
});
Ext.define('App.ux.combo.EducationResources', {
	extend: 'Ext.form.ComboBox',
	xtype: 'educationresourcescombo',
	editable: false,
	queryMode: 'local',
	displayField: 'title',
	valueField: 'id',
	emptyText: _('select'),
	loadStore: true,
	triggerAction: 'all',
	requires: [
		'App.model.administration.EducationResource'
	],
	codeType: undefined,
	tpl: Ext.create('Ext.XTemplate',
		'<tpl for=".">',
		'<div class="x-boundlist-item">{title} - {publication_date_formatted}</div>',
		'</tpl>'
	),
	initComponent: function(){
		var me = this,
			filters;

		if(me.codeType){
			filters = [
				{
					property: 'code_type',
					value: me.codeType
				}
			];
		}
		
		me.store = Ext.create('App.store.administration.EducationResources', {
			autoLoad: me.loadStore,
			filters: filters
		});

		me.callParent(arguments);
	}
});
Ext.define('App.view.patient.Immunizations', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.ux.combo.CVXManufacturersForCvx',
		'App.ux.LiveImmunizationSearch',
		'App.ux.LiveImmunizationNdcSearch',
		'App.ux.grid.RowFormEditing',
		'App.store.patient.CVXCodes',
		'App.ux.form.fields.DateTime',
		'App.ux.LiveUserSearch',
		'App.ux.combo.EducationResources'
	],
	xtype: 'patientimmunizationspanel',
	title: _('vaccs'),
	layout: 'border',
	border: false,
	items: [
		{
			xtype: 'grid',
			region: 'center',
			itemId: 'patientImmunizationsGrid',
			selModel: Ext.create('Ext.selection.CheckboxModel'),
			columnLines: true,
			store: this.store = Ext.create('App.store.patient.PatientImmunization', {
				groupField: 'vaccine_name',
				sorters: [
					'vaccine_name',
					'administered_date'
				],
				remoteFilter: true,
				autoSync: false
			}),
			features: Ext.create('Ext.grid.feature.Grouping', {
				groupHeaderTpl: _('immunization') + ': {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})'
			}),
			columns: [
				{
					xtype: 'griddeletecolumn',
					acl: a('delete_patient_immunizations'),
					width: 25
				},
				{
					text: _('code'),
					dataIndex: 'code',
					width: 50,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('immunization_name'),
					dataIndex: 'vaccine_name',
					flex: 1,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('lot_number'),
					dataIndex: 'lot_number',
					width: 100,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('amount'),
					dataIndex: 'administer_amount',
					width: 100,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('units'),
					dataIndex: 'administer_units',
					width: 100,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('notes'),
					dataIndex: 'note',
					flex: 1,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('status'),
					dataIndex: 'status',
					width: 100,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					text: _('administered_by'),
					dataIndex: 'administered_by',
					width: 150,
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				},
				{
					xtype: 'datecolumn',
					text: _('date'),
					format: 'Y-m-d',
					width: 100,
					dataIndex: 'administered_date',
					renderer: function(v, meta, record){
						if(!record.data.is_error) return v;
						return '<span class="is_error_data">' + v + '</span>'
					}
				}
			],
			plugins: Ext.create('App.ux.grid.RowFormEditing', {
				autoCancel: false,
				errorSummary: false,
				clicksToEdit: 2,
				items: [
					{
						xtype: 'container',
						layout: 'hbox',
						items: [
							{
								xtype: 'container',
								layout: 'vbox',
								items: [
									{
										/**
										 * Line one
										 */
										xtype: 'container',
										layout: 'hbox',
										items: [
											{
												xtype: 'container',
												layout: 'vbox',
												margin: '0 0 10 0',
												items: [
													{
														xtype: 'gaiaehr.combo',
														itemId: 'ImmunizationsInformationSourceCombo',
														list: 138,
														width: 475,
														name: 'information_source_code',
														fieldLabel: _('source'),
														margin: '0 0 5 0',
														loadStore: true,
														editable: false
													},
													{
														xtype: 'immunizationlivesearch',
														itemId: 'ImmunizationsImmunizationSearch',
														fieldLabel: _('name'),
														name: 'vaccine_name',
														valueField: 'name',
														hideLabel: false,
														allowBlank: false,
														enableKeyEvents: true,
														width: 475
													},
													{
														xtype: 'immunizationndclivesearch',
														itemId: 'ImmunizationsImmunizationNdcSearch',
														fieldLabel: _('name'),
														name: 'vaccine_name',
														valueField: 'UseUnitPropName',
														hideLabel: false,
														allowBlank: false,
														enableKeyEvents: true,
														width: 475
													},
													{
														xtype: 'gaiaehr.combo',
														fieldLabel: _('disorder'),
														itemId: 'ImmunizationsDisorderCombo',
														width: 475,
														list: 140,
														queryMode: 'local',
														loadStore: true,
														editable: false,
														allowBlank: false,
														name: 'presumed_immunity_code'
													}
												]
											},
											{
												xtype: 'combobox',
												margin: '0 0 0 10',
												emptyText: _('status'),
												displayField: 'option',
												valueField: 'value',
												name: 'status',
												store: Ext.create('Ext.data.Store',{
													fields: ['option', 'value'],
													data: [
														{ option: _('completed'), value: 'complete' },
														{ option: _('cancelled'), value: 'cancelled' }
													]
												})
											}
										]
									},
									{
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											xtype: 'textfield'
										},
										items: [

											{
												xtype: 'numberfield',
												fieldLabel: _('amount'),
												name: 'administer_amount',
												width: 160
											},
											{
                                                xtype: 'gaiaehr.listcombo',
												fieldLabel: _('units'),
												name: 'administer_units',
												labelWidth: 30,
												width: 150,
                                                loadStore: true,
                                                queryMode: 'local',
                                                list: 131
											},
											{
                                                xtype: 'gaiaehr.combo',
												fieldLabel: _('administration_site'),
												width: 295,
												labelWidth: 110,
												listKey: 'admin_sites',
												queryMode: 'local',
												loadStore: true,
												name: 'administration_site'
											}
										]

									},
									{
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											xtype: 'textfield'
										},
										items: [
											{
												fieldLabel: _('route'),
												xtype: 'gaiaehr.combo',
												listKey: 'route_of_administration',
												queryMode: 'local',
												loadStore: true,
												width: 295,
												name: 'route'
											},
											{
                                                xtype: 'mitos.datetime',
												fieldLabel: _('date_administered'),
												width: 320,
												labelWidth: 115,
												dateTimeFormat: 'Y-m-d H:i:s',
												name: 'administered_date',
                                                vtype: 'date'
                                            }
										]

									},
									{
										fieldLabel: _('administered_by'),
										xtype: 'userlivetsearch',
										itemId: 'patientImmunizationsEditFormAdministeredByField',
										name: 'administered_by',
										margin: '0 10 5 0',
										width: 625,
										hideLabel: false,
										forceSelection: false,
										acl: 'administer_patient_immunizations'
									},
									{
										fieldLabel: _('notes'),
										xtype: 'textfield',
										name: 'note',
										width: 625
									}
								]
							},
							{
								xtype: 'container',
								items: [
									{
										xtype: 'fieldset',
										title: _('substance_data'),
										defaults: {
											margin: '0 0 5 0',
											width: 250
										},
										margin: '0 15 5 0',
										items: [
											{
												fieldLabel: _('lot_number'),
												xtype: 'textfield',
												name: 'lot_number'
											},
											{
												fieldLabel: _('exp_date'),
												xtype: 'datefield',
												format: 'Y-m-d',
												name: 'exp_date'
											},
											{
												xtype: 'cvxmanufacturersforcvxcombo',
												fieldLabel: _('manufacturer'),
												margin: '0 0 8 0',
												name: 'manufacturer'
											}
										]
									},
									{
										xtype: 'checkbox',
										name: 'is_presumed_immunity',
										fieldLabel: 'Presumed Immunity',
										width: 145,
										itemId: 'ImmunizationsPresumedImmunityCheckbox',
										labelAlign: 'right',
										labelWidth: 125
									},
									{
										xtype: 'checkboxfield',
										fieldLabel: _('entered_in_error'),
										name: 'is_error'
									}
								]
							},
							{
								xtype: 'container',
								items: [
									{
										xtype: 'gaiaehr.combo',
										list: 139,
										width: 550,
										name: 'refusal_reason_code',
										fieldLabel: _('refusal_reason'),
										margin: '0 0 5 0',
										loadStore: true,
										editable: false
									},
									{
										xtype: 'gaiaehr.combo',
										fieldLabel: _('unable_to_perform'),
										width: 550,
										margin: '0 0 5 0',
										loadStore: true,
										editable: false,
										listKey: 'unable_to_perform_vac',
										name: 'not_performed_code',
										itemId: 'ImmunizationsUnableToPerformField'
									},
									{
										xtype: 'gaiaehr.combo',
										fieldLabel: _('vfc'),
										name: 'vfc_code',
										list: 135,
										width: 550,
										margin: '0 0 5 0',
										loadStore: true,
										editable: false
									},
									{
										xtype: 'container',
									    layout: 'hbox',
										items: [
											{
												xtype: 'container',
												items: [
													{
														xtype: 'educationresourcescombo',
														width: 250,
														margin: '0 5 5 0',
														fieldLabel: _('publication'),
														name: 'education_resource_1_id',
														codeType: 'cdcgs1vis'
													},
													{
														xtype: 'datefield',
														width: 250,
														margin: '0 5 5 0',
														fieldLabel: _('given_date'),
														name: 'education_presented_1_date',
														submitFormat: 'Y-m-d H:i:s'
													}
												]
											},
											{
												xtype: 'container',
												items: [
													{
														xtype: 'educationresourcescombo',
														width: 145,
														margin: '0 5 5 0',
														name: 'education_resource_2_id',
														codeType: 'cdcgs1vis'
													},
													{
														xtype: 'datefield',
														width: 145,
														margin: '0 5 5 0',
														name: 'education_presented_2_date',
														submitFormat: 'Y-m-d H:i:s'
													}
												]
											},
											{
												xtype: 'container',
												items: [
													{
														xtype: 'educationresourcescombo',
														width: 145,
														margin: '0 0 5 0',
														name: 'education_resource_3_id',
														codeType: 'cdcgs1vis'
													},
													{
														xtype: 'datefield',
														width: 145,
														margin: '0 0 5 0',
														name: 'education_presented_3_date',
														submitFormat: 'Y-m-d H:i:s'
													}
												]
											}
										]
									}
								]
							}
						]
					}
				]
			}),
			tbar: [
				'->',
				{
					xtype: 'button',
					text: _('quick'),
					iconCls: 'icoAdd',
					margin : '0 3 0 0',
					acl: a('add_patient_immunizations'),
					itemId: 'ImmunizationPanelQuickAddBtn'
				},
				'-',
				{
					text: _('add_new'),
					action: 'encounterRecordAdd',
					itemId: 'addImmunizationBtn',
					iconCls: 'icoAdd'
				}
			],
			bbar: [
				'-',
				{
					xtype: 'button',
					text: _('submit_hl7_vxu'),
					disabled: true,
					itemId: 'submitVxuBtn'
				},
				{
					xtype: 'button',
					text: _('immunization_registry_history'),
					itemId: 'ImmunizationHistorySearchBtn'
				},
				'-',
				'->',
				{
					text: _('review'),
					itemId: 'reviewImmunizationsBtn',
					action: 'encounterRecordAdd'
				}
			]
		},
		{
			xtype: 'grid',
			title: _('immunization_list'),
			itemId: 'cvxGrid',
			collapseMode: 'mini',
			region: 'east',
			collapsible: true,
			collapsed: true,
			width: 300,
			split: true,
			store: Ext.create('App.store.patient.CVXCodes'),
			columns: [
				{
					text: _('code'),
					dataIndex: 'cvx_code',
					width: 50
				},
				{
					text: _('immunization_name'),
					dataIndex: 'name',
					flex: 1
				}
			]
		}
	]
});

Ext.define('App.ux.LiveAllergiesSearch', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.allergieslivesearch',
	requires: [
		'App.model.administration.Allergies'
	],
	hideLabel: true,
	displayField: 'allergy',
	valueField: 'allergy',
	initComponent: function(){
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			model: 'App.model.administration.Allergies',
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			emptyText: _('allergy_search') + '...',
			typeAhead: false,
			hideTrigger: true,
			minChars: 3,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><h3>{allergy}<span style="font-weight: normal"> ({allergy_code}) </span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();
	}
});

Ext.define('App.view.patient.Allergies', {
	extend: 'Ext.grid.Panel',
	requires: [
		'App.store.patient.Allergies',
		'App.ux.grid.RowFormEditing',
		'App.ux.LiveRXNORMAllergySearch',
		'App.ux.LiveAllergiesSearch',
		'App.ux.LiveImmunizationSearch',
		'App.ux.combo.Allergies',
		'App.ux.combo.AllergiesReaction',
		'App.ux.combo.AllergiesTypes',
		'App.ux.combo.AllergiesLocation',
		'App.ux.combo.AllergiesSeverity'
	],
	xtype: 'patientallergiespanel',
	title: _('al'),
	columnLines: true,
	store: Ext.create('App.store.patient.Allergies', {
		remoteFilter: true,
		autoSync: false
	}),
	columns: [
		{
			xtype: 'griddeletecolumn',
			acl: a('delete_patient_allergy'),
			width: 25
		},
		{
			text: _('type'),
			width: 100,
			dataIndex: 'allergy_type'
		},
		{
			text: _('name'),
			flex: 1,
			dataIndex: 'allergy',
			renderer:function(v, meta, record){
				var codes = '';
				if(record.data.allergy_code != ''){
					codes += ' ( <b>'+ record.data.allergy_code_type + ':</b> ' + record.data.allergy_code +' )';
				}
				return v + codes;
			}
		},
		{
			text: _('location'),
			width: 220,
			dataIndex: 'location'
		},
		{
			text: _('reaction'),
			width: 220,
			dataIndex: 'reaction'
		},
		{
			text: _('severity'),
			width: 220,
			dataIndex: 'severity'
		},
		{
			text: _('status'),
			width: 55,
			dataIndex: 'status'
		}
	],
	plugins: Ext.create('App.ux.grid.RowFormEditing', {
		autoCancel: false,
        itemId: 'allergiesGridRowEditor',
		errorSummary: false,
		clicksToEdit: 2,
		items: [
			{
				title: _('general'),
				xtype: 'container',
				padding: '0 10',
				layout: 'vbox',
				items: [
					{
						/**
						 * Line one
						 */
						xtype: 'fieldcontainer',
						layout: 'hbox',
						defaults: {
							margin: '0 10 0 0'
						},
						items:[
							{
								xtype: 'gaiaehr.combo',
								fieldLabel: _('type'),
								itemId:'allergyTypeCombo',
								name: 'allergy_type',
								allowBlank: false,
								labelWidth: 70,
								width: 700,
								list: 85,
								enableKeyEvents: true
							},
							{
								xtype: 'gaiaehr.combo',
								fieldLabel: _('status'),
								name: 'status',
								list: 113,
								itemId: 'allergyStatusCombo',
								labelWidth: 80,
								allowBlank: false
							}
						]
					},
					{
						/**
						 * Line two
						 */
						xtype: 'fieldcontainer',
						layout: 'hbox',
						defaults: {
							margin: '0 10 0 0'
						},
						items: [
							{
								xtype: 'allergieslivesearch',
								fieldLabel: _('allergy'),
								itemId: 'allergySearchCombo',
								name: 'allergy',
								hideLabel: false,
								enableKeyEvents: true,
								width: 700,
								labelWidth: 70,
								allowBlank: false
							},
							{
								xtype: 'immunizationlivesearch',
								fieldLabel: _('allergy'),
								itemId: 'allergyCvxLiveSearch',
								name: 'allergy',
								valueField: 'name',
								hideLabel: false,
								enableKeyEvents: true,
								width: 700,
								labelWidth: 70,
								multiSelect: false,
								allowBlank: false
							},
							{
								xtype:'rxnormallergylivetsearch',
								fieldLabel: _('allergy'),
								itemId:'allergyMedicationCombo',
								name: 'allergy',
								hideLabel: false,
								hidden: true,
								disabled: true,
								enableKeyEvents: true,
								width: 700,
								labelWidth: 70,
								allowBlank: false
							},
							{
								xtype:'gaiaehr.combo',
								fieldLabel: _('allergy'),
								itemId:'allergyFoodCombo',
								name: 'allergy',
								hideLabel: false,
								hidden: true,
								disabled: true,
								enableKeyEvents: true,
								width: 700,
								labelWidth: 70,
								allowBlank: false,
								listKey: 'food_aller'
							},
							{
								xtype:'allergiesmetalcombo',
								fieldLabel: _('allergy'),
								itemId:'allergyMetalCombo',
								name: 'allergy',
								hideLabel: false,
								displayField: 'Term',
								valueField: 'Term',
								hidden: true,
								disabled: true,
								enableKeyEvents: true,
								width: 700,
								labelWidth: 70,
								allowBlank: false
							},
							{
								fieldLabel: _('begin_date'),
								xtype: 'datefield',
								format: 'Y-m-d',
								name: 'begin_date',
								labelWidth: 80

							}
						]

					},
					{
						/**
						 * Line three
						 */
						xtype: 'fieldcontainer',
						layout: 'hbox',
						defaults: {
							margin: '0 10 0 0'
						},
						items: [
							{
								xtype: 'gaiaehr.combo',
								fieldLabel: _('location'),
								name: 'location',
								action: 'location',
								itemId: 'allergyLocationCombo',
								addUnknownOption: true,
								width: 225,
								list: 79,
								labelWidth: 70
							},
							{
								xtype: 'gaiaehr.combo',
								fieldLabel: _('reaction'),
								itemId: 'allergyReactionCombo',
								addUnknownOption: true,
								name: 'reaction',
								width: 230,
								queryMode : 'local',
								labelWidth: 70,
								allowBlank: true
							},
							{
								xtype: 'gaiaehr.combo',
								fieldLabel: _('severity'),
								name: 'severity',
								itemId: 'allergySeverityCombo',
								addUnknownOption: true,
								width: 225,
								list: 84,
								labelWidth: 70,
								allowBlank: true
							},
							{
								fieldLabel: _('end_date'),
								xtype: 'datefield',
								format: 'Y-m-d',
								name: 'end_date',
								labelWidth: 80
							}
						]
					}
				]
			}
		]
	}),
	tbar:[
		'->',
		{
			text: _('add_new'),
			itemId: 'addAllergyBtn',
			action: 'encounterRecordAdd',
			iconCls: 'icoAdd'
		}
	],
	bbar: [
		{
			text: _('reconciled'),
			itemId: 'PatientAllergyReconciledBtn',
			enableToggle: true,
			pressed: true
		},
		{
			text: _('only_active'),
			enableToggle: true,
			itemId: 'activeAllergyBtn'
		},
		'->',
		{
			text: (_('no_known_allergies') + '/' + _('review')) ,
			action: 'encounterRecordAdd',
			itemId: 'reviewAllergiesBtn'
		}
	]
});

Ext.define('App.view.patient.windows.Medical', {
	extend: 'App.ux.window.Window',
	title: _('medical_window'),
	itemId: 'MedicalWindow',
	closeAction: 'hide',
	//bodyStyle: 'background-color:#fff',
	modal: true,
	requires: [
		'App.view.patient.Results',
		'App.view.patient.Referrals',
		'App.view.patient.Immunizations',
		'App.view.patient.Medications',
		'App.view.patient.ActiveProblems',
		'App.view.patient.ProceduresHistoryGrid',
		'App.view.patient.SocialPanel',
		'App.view.patient.Allergies',
		'App.view.patient.AdvanceDirectives',
		'App.view.patient.CognitiveAndFunctionalStatus',
		'App.view.patient.LabOrders',
		'App.view.patient.RadOrders',
		'App.view.patient.RxOrders',
		'App.view.patient.DoctorsNotes',
		'App.view.patient.FamilyHistory',
		'App.view.patient.ImplantableDevice',
		'App.view.patient.SocialPsychologicalBehavioral',
		'App.view.patient.PainScale'
	],

	initComponent: function(){
		var me = this,
			tapPanelItems = app.getController('patient.Medical').getMedicalTabPanelItems();

		if(a('access_clinical_decision_support')){
			me.tbar = [{
				xtype: 'decisionsupportwarningpanel',
				itemId: 'MedicalDecisionSupportWarningPanel',
				flex: 1
			}];
		}


		me.items = [
			{
				xtype:'tabpanel',
				border:false,
				bodyBorder:false,
				plain: true,
				margin: 5,
				itemId: 'MedicalWindowTabPanel',
				tabBar: {
					plugins : Ext.create('Ext.ux.BoxReorderer', {
						listeners: {
							Drop: function (plugin, container, dragCmp, startIdx, idx, eOpts) {
								app.getController('patient.Medical').onMedicalWindowTabPanelDrop(plugin, container, dragCmp, startIdx, idx, eOpts);
							}
						}
					})
				},
				width: Ext.getBody().getWidth() < 1550 ? (Ext.getBody().getWidth() - 50) : 1500,
				height: Ext.getBody().getHeight() < 1050 ? (Ext.getBody().getHeight() - 50) : 1000,
				items: tapPanelItems
			}
		];

		me.buttons = [
			{
				text: _('close'),
				scope: me,
				handler: function(){
					me.close();
				}
			}
		];

		me.listeners = {
			scope: me,
			close: me.onMedicalWinClose,
			show: me.onMedicalWinShow
		};

		me.callParent(arguments);
	},

	cardSwitch:function(action){
		var me = this,
			tabPanel = me.down('tabpanel'),
			activePanel = tabPanel.getActiveTab(),
			toPanel = tabPanel.query('#' + action)[0];

		if(activePanel == toPanel){
			activePanel.fireEvent('activate', activePanel);
		}else{
			tabPanel.setActiveTab(toPanel);
			me.setWindowTitle(toPanel.title);
		}
	},

	setWindowTitle:function(title){
		this.setTitle(title);
	},

	onMedicalWinShow: function(){
		var p = this.down('tabpanel'),
			w = Ext.getBody().getWidth() < 1550 ? (Ext.getBody().getWidth() - 50) : 1500,
			h = Ext.getBody().getHeight() < 850 ? (Ext.getBody().getHeight() - 50) : 800;
		p.setSize(w, h);
		this.alignTo(Ext.getBody(), 'c-c');
	},

	onMedicalWinClose: function(){
		var panel = app.getActivePanel();

		if(panel.$className === 'App.view.patient.Summary'){
			panel.loadStores();
		}else if(panel.$className === 'App.view.patient.Encounter'){
			panel.getProgressNote();
		}
	}
});

Ext.define('App.store.administration.CPT', {
	extend: 'Ext.data.Store',
	model: 'App.model.administration.CPT'
});
Ext.define('App.view.administration.CPT', {
	extend: 'Ext.grid.Panel',
	requires:[
		'Ext.grid.plugin.RowEditing',
		'App.store.administration.CPT'
	],
	xtype: 'cptadmingrid',
	title: _('cpt4'),
	columns: [
		{
			width: 60,
			header: _('code'),
			dataIndex: 'code'
		},
		{
			header: _('short_name'),
			dataIndex: 'code_text_short',
			width: 100,
			flex: 1,
			editor:{
				xtype:'textfield'
			}
		},
		{
			header: _('long_name'),
			dataIndex: 'code_text',
			flex: 2,
			editor:{
				xtype:'textfield'
			}
		},
		{
			header: _('radiology'),
			dataIndex: 'isRadiology',
			editor:{
				xtype:'checkbox'
			},
			renderer: function(v){
				return this.boolRenderer(v);
			}
		},
		{
			width: 60,
			header: _('active'),
			dataIndex: 'active',
			editor:{
				xtype:'checkbox'
			},
			renderer: function(v){
				return this.boolRenderer(v);
			}
		}
	],
	plugins: [
		{
			ptype:'rowediting',
			errorSummary: false,
			clicksToEdit: 1
		}
	],
	initComponent: function(){
		var me = this;
		me.store = Ext.create('App.store.administration.CPT',{
			remoteSort: true
		});
		me.tbar = Ext.create('Ext.PagingToolbar', {
			store: me.store,
			displayInfo: true,
			emptyMsg: _('no_office_notes_to_display'),
			plugins: Ext.create('Ext.ux.SlidingPager'),
			items: [
				'-',
				{
					xtype: 'textfield',
					emptyText: _('search'),
					width: 200,
					enableKeyEvents: true,
					itemId: 'adminCpt4CodeSearchField'
				},
				'-',
				{
					xtype: 'button',
					text: _('only_active'),
					enableToggle: true,
					itemId: 'adminCpt4CodeOnlyActiveBtn'
				},
				'-'
			]
		});

		me.callParent();
	}
});

Ext.define('App.view.administration.DataManager', {
    extend: 'App.ux.RenderPanel',
    pageTitle: 'Data Manager',
    requires: [
        'App.view.administration.CPT',
        'App.view.administration.ICD10',
        'App.ux.combo.CodesTypes',
        'App.ux.combo.Titles'
    ],

    initComponent: function () {
        var me = this;

        me.active = 1;
        me.dataQuery = '';
        me.code_type = 'LOINC';


        me.store = Ext.create('App.store.administration.Services');
        me.activeProblemsStore = Ext.create('App.store.administration.ActiveProblems');
        me.medicationsStore = Ext.create('App.store.administration.Medications');
        me.ImmuRelationStore = Ext.create('App.store.administration.ImmunizationRelations');
        me.labObservationsStore = Ext.create('App.store.administration.LabObservations');

        function code_type(val) {
            if (val == '1') {
                return 'CPT4';
            }
            else if (val == '3') {
                return 'HCPCS';
            }
            else if (val == '100') {
                return 'CVX';
            }
            return val;
        }

        /**
         * CPT Container
         */
        me.cptContainer = Ext.create('Ext.container.Container', {
            layout: 'column',
            action: 'CPT4',
            //hidden: true,
            items: [
                {
                    xtype: 'fieldcontainer',
                    msgTarget: 'under',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            fieldLabel: 'Type',
                            xtype: 'mitos.codestypescombo',
                            name: 'code_type'
                        },
                        {
                            fieldLabel: 'Code',
                            xtype: 'textfield',
                            name: 'code'
                        }
                    ]
                },
                {
                    xtype: 'fieldcontainer',
                    margin: '0 0 0 10',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            fieldLabel: _('description'),
                            xtype: 'textfield',
                            name: 'code_text',
                            width: 500
                        }
                    ]
                },
                {
                    xtype: 'fieldcontainer',
                    margin: '0 0 0 20',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            boxLabel: _('radiology'),
                            xtype: 'checkboxfield',
                            name: 'isRadiology'
                        },
                        {
                            boxLabel: _('active'),
                            labelWidth: 75,
                            xtype: 'checkboxfield',
                            name: 'active'
                        }
                    ]
                }
            ]
        });
        /**
         * HCPSC Container
         */
        me.hpccsContainer = Ext.create('Ext.container.Container', {
            layout: 'column',
            action: 'HCPCS',
            //hidden: true,
            items: [
                {
                    xtype: 'fieldcontainer',
                    msgTarget: 'under',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            fieldLabel: _('type'),
                            xtype: 'mitos.codestypescombo',
                            name: 'code_type'
                        },
                        {
                            fieldLabel: _('code'),
                            xtype: 'textfield',
                            name: 'code'
                        },
                        {
                            fieldLabel: _('modifier'),
                            xtype: 'textfield',
                            name: 'mod'
                        }
                    ]
                },
                {
                    xtype: 'fieldcontainer',
                    margin: '0 0 0 10',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            fieldLabel: _('description'),
                            xtype: 'textfield',
                            name: 'code_text'
                        },
                        {
                            fieldLabel: _('category'),
                            xtype: 'mitos.titlescombo',
                            name: 'title'
                        }
                    ]
                },
                {
                    xtype: 'fieldcontainer',
                    margin: '0 0 0 20',
                    defaults: {
                        action: 'field'
                    },
                    items: [
                        {
                            boxLabel: _('reportable'),
                            xtype: 'checkboxfield',
                            name: 'reportable'
                        },
                        {
                            boxLabel: _('active'),
                            labelWidth: 75,
                            xtype: 'checkboxfield',
                            name: 'active'
                        }
                    ]
                }
            ]
        });
        /**
         * CVX Container
         */
        me.cvxCintainer = Ext.create('Ext.container.Container', {
            action: _('immunizations'),
            layout: 'fit',
            items: [
                {}
            ]

        });
        /**
         * Labs Container
         */
        me.labContainer = Ext.create('Ext.container.Container', {
            action: _('laboratories'),
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: [
                {
                    /**
                     * line One
                     */
                    xtype: 'fieldcontainer',
                    layout: 'hbox',
                    defaults: {
                        margin: '0 10 5 0',
                        action: 'field'
                    },
                    items: [
                        {
                            xtype: 'textfield',
                            fieldLabel: _('short_name_alias'),
                            name: 'code_text_short',
                            labelWidth: 130,
                            width: 500
                        },
                        {
                            xtype: 'checkbox',
                            fieldLabel: _('active'),
                            name: 'active',
                            anchor: '100%',
                            labelWidth: 50

                        }
                    ]
                },
                {
                    xtype: 'grid',
                    frame: true,
                    title: _('children'),
                    store: me.labObservationsStore,
                    plugins: Ext.create('Ext.grid.plugin.CellEditing', {
                        clicksToEdit: 2
                    }),
                    columns: [
                        {
                            header: _('label_alias'),
                            dataIndex: 'code_text_short',
                            width: 150,
                            editor: {
                                xtype: 'textfield'
                            }
                        },
                        {
                            header: _('loinc_name'),
                            dataIndex: 'loinc_name',
                            flex: 1
                        },
                        {
                            header: _('loinc_number'),
                            dataIndex: 'loinc_number',
                            width: 100
                        },
                        {
                            header: _('default_unit'),
                            dataIndex: 'default_unit',
                            width: 100,
                            editor: {
                                xtype: 'mitos.unitscombo'
                            }
                        },
                        {
                            header: _('req_opt'),
                            dataIndex: 'required_in_panel',
                            width: 75
                        },
                        {
                            header: _('range_start'),
                            dataIndex: 'range_start',
                            width: 100,
                            editor: {
                                xtype: 'numberfield'
                            }
                        },
                        {
                            header: _('range_end'),
                            dataIndex: 'range_end',
                            width: 100,
                            editor: {
                                xtype: 'numberfield'
                            }
                        },
                        {
                            header: _('description'),
                            dataIndex: 'description',
                            flex: 1,
                            editor: {
                                xtype: 'textfield'
                            }
                        },
                        {
                            width: 60,
                            header: _('active'),
                            dataIndex: 'active',
                            renderer: me.boolRenderer,
                            editor: {
                                xtype: 'checkbox'
                            }
                        }
                    ]
                    //                    tbar:[
                    //                        {
                    //                            xtype:'labobservationscombo',
                    //                            fieldLabel:'Add Observation',
                    //                            width:300,
                    //                            listeners: {
                    //                                scope : me,
                    //                                select: me.onObservationSelect
                    //                            }
                    //                        },
                    //                        {
                    //                            text:'Add Observation',
                    //                            iconCls:'icoAddRecord',
                    //                            scope:me,
                    //                            handler:me.addLabObservation
                    //                        }
                    //                    ]
                }
            ]
        });

        me.dataManagerGrid = Ext.create('Ext.grid.Panel', {
            title: 'Codes',
            region: 'center',
            store: me.store,
            viewConfig: {
                loadMask: true
            },
            columns: [
                {
                    width: 50,
//					header: _('code_type'),
                    sortable: false,
                    dataIndex: 'code_type',
                    renderer: code_type
                },
                {
                    width: 60,
                    header: _('code'),
                    sortable: true,
                    dataIndex: 'code'
                },
                {
                    header: _('short_name'),
                    dataIndex: 'code_text_short',
                    width: 100,
                    flex: 1
                },
                {
                    header: _('long_name'),
                    sortable: true,
                    dataIndex: 'code_text',
                    flex: 2
                },
                {
                    width: 60,
                    header: _('active'),
                    sortable: true,
                    dataIndex: 'active',
                    renderer: me.boolRenderer
                }
            ],
            plugins: Ext.create('App.ux.grid.RowFormEditing', {
                autoCancel: false,
                errorSummary: false,
                clicksToEdit: 1,
                listeners: {
                    scope: me,
                    beforeedit: me.beforeServiceEdit
                }
            }),
            tbar: this.bar = Ext.create('Ext.PagingToolbar', {
                store: me.store,
                displayInfo: true,
                emptyMsg: _('no_office_notes_to_display'),
                plugins: Ext.create('Ext.ux.SlidingPager'),
                items: [
                    '-',
                    {
                        xtype: 'mitos.codestypescombo',
                        width: 150,
                        listeners: {
                            scope: me,
                            select: me.onCodeTypeSelect
                        }
                    }, '-',
                    {
                        text: _('add'),
                        iconCls: 'icoAddRecord',
                        scope: me,
                        handler: me.onAddData
                    }, '-',
                    {
                        xtype: 'textfield',
                        emptyText: _('search'),
                        width: 200,
                        enableKeyEvents: true,
                        listeners: {
                            scope: me,
                            keyup: me.onSearch,
                            buffer: 500
                        }
                    }, '-',
                    {
                        xtype: 'button',
                        text: _('show_inactive_codes_only'),
                        enableToggle: true,
                        listeners: {
                            scope: me,
                            toggle: me.onActivePressed
                        }
                    }
                ]
            })
        });
        // END GRID

        me.tabPanel = Ext.widget('tabpanel', {
            items: [
                {
                    xtype: 'cptadmingrid',
                },
                {
                    xtype: 'icd10admingrid'
                },
                me.dataManagerGrid
            ]
        });

        me.pageBody = [me.tabPanel];


        me.callParent();
    },


    onAddData: function () {
        var me = this;
        if (me.code_type == 'Laboratories') {
            Ext.Msg.alert('Opps!', _('ops_laboratories'));
        } else {
            me.dataManagerGrid.plugins[0].cancelEdit();
            me.store.add({
                code_type: me.code_type
            });
            me.dataManagerGrid.plugins[0].startEdit(0, 0);
        }
    },


    beforeServiceEdit: function (context, e) {

        var me = this,
            editor = context.editor,
            code_type = e.record.data.code_type,
            grids,
            thisForm;

        if (code_type == 'CPT4') {
            thisForm = me.cptContainer;
        } else if (code_type == 'HCPCS') {
            thisForm = me.hpccsContainer;
        } else if (code_type == 'CVX') {
            thisForm = me.cvxCintainer;
        } else if (code_type == 'LOINC') {

            me.labContainer.down('grid').setTitle(
                e.record.data.has_children ? _('observations') : _('observation')
            );

            me.labContainer.down('grid').setVisible(e.record.data.class != 'RAD');
            thisForm = me.labContainer;
        }

        if (!editor.items.length) {
            editor.add(thisForm);
            editor.setFields();
        } else if (this.currForm != thisForm) {
            editor.remove(0, false);
            editor.add(thisForm);
            editor.setFields();
        }

        /**
         * find grids inside the form and load the its store with the row ID
         * @type {*}
         */
        if (thisForm) {
            grids = thisForm.query('grid');
            for (var i = 0; i < grids.length; i++) {
                grids[i].getStore().load({
                    params: {
                        selectedId: me.getSelectId()
                    }
                });
            }
            this.currForm = thisForm;
        }
    },

    onSearch: function (field) {
        var me = this,
            store = me.store;

        me.dataQuery = field.getValue();
        store.proxy.extraParams = {
            active: me.active,
            code_type: me.code_type,
            query: me.dataQuery
        };
        me.store.loadPage(1);
    },

    onCodeTypeSelect: function (combo, record) {
        var me = this,
            store = me.store;

        me.code_type = record[0].data.option_value;
        store.proxy.extraParams = {
            active: me.active,
            code_type: me.code_type,
            query: me.dataQuery
        };
        me.store.loadPage(1);
    },

    onActivePressed: function (btn, pressed) {
        var me = this,
            store = me.store;

        me.active = !pressed;
        store.proxy.extraParams = {
            active: me.active,
            code_type: me.code_type,
            query: me.dataQuery
        };
        me.store.load();
    },

    getSelectId: function () {
        var row = this.dataManagerGrid.getSelectionModel().getLastSelected();
        return row.data.id;
    },


    /**
     * This function is called from Viewport.js when
     * this panel is selected in the navigation panel.
     * place inside this function all the functions you want
     * to call every this panel becomes active
     */
    onActive: function (callback) {
        this.bar.query('combobox')[0].setValue("CPT4");
        this.store.proxy.extraParams = {
            active: this.active,
            code_type: this.code_type,
            query: this.dataQuery
        };
        this.store.load();
        callback(true);
    }
});
//ens servicesPage class

Ext.define('App.view.patient.InsuranceForm', {
    extend: 'Ext.form.Panel',
    requires: [
        'Ext.grid.plugin.RowEditing',
        'App.ux.grid.RowFormEditing',
        'Ext.grid.plugin.CellEditing',
        'App.ux.combo.Insurances',
        'App.ux.combo.Combo',
        'App.ux.form.fields.InputTextMask',
        'Modules.billing.view.patient.BillingPatientInsuranceCoverInformation'
    ],


    xtype: 'patientinsuranceform',
    border: false,
    bodyBorder: false,
    closable: true,
    fieldDefaults: {
        labelAlign: 'top'
    },

    initComponent: function () {
        var me = this;

        me.dateFormat = Ext.Date.defaultFormat;
        me.today = new Date();
        me.todaysDate = Ext.util.Format.date(me.today, 'm/d/Y');
        me.oneHour = 60 * 60 * 1000;
        me.days = 0;

        me.colorEqualZero = 'color: #000000;';
        me.colorLessThanZero = 'color: #FF4500;';
        me.colorGreaterThanZero = 'color: #000000;';

        me.textRight = 'text-align:right;';
        me.textLeft = 'text-align:left;';
        me.textCenter = 'text-align:center;';

        me.stateful = true;
        me.stateId = me.itemId + '_State_' + app.user.id;

        me.items = [
            {
                xtype: 'container',
                padding: '0 0 0 0',
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                items: [
                    {
                        xtype: 'fieldset',
                        title: _('card_information'),
                        itemId: 'PatientInsurancesForm',
                        padding: '0 0 10 0',
                        layout: {
                            type: 'vbox',
                            align: 'stretch'
                        },
                        items: [
                            {
                                xtype: 'fieldset',
                                cls: 'highlight_fieldset',
                                layout: {
                                    type: 'hbox',
                                    align: 'stretch'
                                },
                                width: 1100,
                                margin: '0 5 5 5',
                                items: [
                                    {
                                        xtype: 'fieldcontainer',
                                        layout: {
                                            type: 'vbox',
                                            align: 'stretch'
                                        },
                                        defaults: {
                                            margin: '0 10 0 2'
                                        },
                                        items: [
                                            {
                                                xtype: 'fieldcontainer',
                                                layout: 'hbox',
                                                enableKeyEvents: true,
                                                width: 650,
                                                defaults: {
                                                    margin: '0 10 0 2'
                                                },
                                                items: [
                                                    {
                                                        xtype: 'insurancescombo',
                                                        name: 'insurance_id',
                                                        fieldLabel: _('insurance'),
                                                        labelWidth: 120,
                                                        width: 410,
                                                        queryMode: 'local',
                                                        editable: true,
                                                        allowBlank: false,
                                                        forceSelection: true,
                                                        typeAhead: true
                                                    },
                                                    {
                                                        xtype: 'gaiaehr.combo',
                                                        emptyText: _('type'),
                                                        fieldLabel: _('type'),
                                                        labelWidth: 100,
                                                        flex: 1,
                                                        name: 'insurance_type',
                                                        listKey: 'ins_type',
                                                        queryMode: 'local',
                                                        allowBlank: false,
                                                        editable: false,
                                                        loadStore: true
                                                    }
                                                ]
                                            },  //Insurance Name, Type (Primary,Complementary...)
                                            {
                                                xtype: 'fieldcontainer',
                                                layout: {
                                                    type: 'hbox',
                                                    align: 'bottom'
                                                },
                                                hideLabel: false,
                                                width: 650,
                                                defaults: {
                                                    margin: '0 10 0 2'
                                                },
                                                items: [
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'policy_number',
                                                        itemId: 'PatientInsuranceID',
                                                        emptyText: _('policy_number'),
                                                        fieldLabel: _('id'),
                                                        allowBlank: false,
                                                        width: 200
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'group_number',
                                                        emptyText: _('group_number'),
                                                        fieldLabel: _('group'),
                                                        width: 200
                                                    },
                                                    {
                                                        xtype: 'datefield',
                                                        name: 'effective_date',
                                                        itemId: 'PatientInsurancesFormEffectiveDate',
                                                        labelAlign: 'top',
                                                        emptyText: _('effective') + ' ' + _('date'),
                                                        fieldLabel: _('effective'),
                                                        labelWidth: 60,
                                                        allowBlank: false,
                                                        width: 100
                                                    },
                                                    {
                                                        xtype: 'checkboxfield',
                                                        name: 'active',
                                                        checked: false,
                                                        itemId: 'PatientInsurancesFormIsActiveCkBox',
                                                        fieldLabel: _('active'),
                                                        margin: '0 0 0 25',
                                                        labelAlign: 'right',
                                                        labelWidth: 60
                                                    }
                                                    // {
                                                    //     xtype: 'datefield',
                                                    //     name: 'expiration_date',
                                                    //     labelAlign: 'left',
                                                    //     emptyText: _('expiration'),
                                                    //     fieldLabel: _('expiration'),
                                                    //     labelWidth: 60,
                                                    //     width: 160
                                                    // }
                                                ]
                                            },  //Insurance Card Container Policy Number, Group, Effective, Expiration
                                            {
                                                xtype: 'fieldcontainer',
                                                layout: {
                                                    type: 'hbox',
                                                    align: 'bottom'
                                                },
                                                width: 650,
                                                defaults: {
                                                    margin: '0 10 0 2'
                                                },
                                                items: [
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'card_first_name',
                                                        emptyText: _('first_name'),
                                                        fieldLabel: _('card_name'),
                                                        itemId: 'InsuranceCardFirstNameField',
                                                        allowBlank: false,
                                                        width: 120
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'card_middle_name',
                                                        emptyText: _('middle_name'),
                                                        itemId: 'InsuranceCardMiddleNameField',
                                                        width: 70
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'card_last_name',
                                                        emptyText: _('last_name'),
                                                        itemId: 'InsuranceCardLastNameField',
                                                        allowBlank: false,
                                                        width: 200
                                                    },
                                                    {
                                                        xtype: 'datefield',
                                                        name: 'subscriber_dob',
                                                        emptyText: _('dob'),
                                                        fieldLabel: _('dob'),
                                                        allowBlank: false,
                                                        flex: 1
                                                    },
                                                    {
                                                        xtype: 'gaiaehr.combo',
                                                        name: 'subscriber_sex',
                                                        emptyText: _('sex'),
                                                        fieldLabel: _('sex'),
                                                        labelWidth: 30,
                                                        listKey: 'sex',
                                                        queryMode: 'local',
                                                        flex: 1,
                                                        loadStore: true,
                                                        editable: false
                                                    }
                                                ]
                                            },  //Insurance Card Container Name, DOB, Sex
                                            {
                                                xtype: 'fieldcontainer',
                                                layout: {
                                                    type: 'hbox'
                                                },
                                                width: 650,
                                                defaults: {
                                                    margin: '0 10 0 2'
                                                },
                                                items: [
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'rx_group',
                                                        fieldLabel: _('rx_group'),
                                                        flex: 1
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'rx_bin',
                                                        fieldLabel: _('rx_bin'),
                                                        flex: 1
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'rx_pcn',
                                                        fieldLabel: _('rx_pcn'),
                                                        flex: 1
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        name: 'rx_member_id',
                                                        fieldLabel: _('rx_member_id'),
                                                        flex: 1
                                                    }
                                                ]
                                            },  //Insurance Card Container Name, DOB, Sex
                                            {
                                                xtype: 'billingpatientinsurancecoverinformation',
                                                itemId: 'BillingPatientInsuranceCoverInformationxtype',
                                                margin: '5 0 0 2',
                                                flex: 1
                                            }
                                        ]
                                    }, //Primary Insurance Informacion Fields
                                    {
                                        xtype: 'container',
                                        layout: {
                                            type: 'vbox',
                                            align: 'stretch'
                                        },
                                        margin: '10 0 5 15',
                                        items: [
                                            {
                                                xtype: 'panel',
                                                cls: 'highlight_fieldset',
                                                margin: '0 0 0 0',
                                                width: 380,
                                                height: 250,
                                                layout: 'fit',
                                                itemId: 'PatientInsuranceFormCardContainer',
                                                items: [
                                                    {
                                                        xtype: 'image',
                                                        action: 'insImage',
                                                        // width: 380,
                                                        // height: 250,
                                                        src: 'data:image/jpeg;base64,/9j/4QtvRXhpZgAATU0AKgAAAAgADAEAAAMAAAABAOYAAAEBAAMAAAABAIIAAAECAAMAAAADAAAAngEGAAMAAAABAAIAAAESAAMAAAABAAEAAAEVAAMAAAABAAMAAAEaAAUAAAABAAAApAEbAAUAAAABAAAArAEoAAMAAAABAAIAAAExAAIAAAAeAAAAtAEyAAIAAAAUAAAA0odpAAQAAAABAAAA6AAAASAACAAIAAgACvyAAAAnEAAK/IAAACcQQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykAMjAxMzowOToxNiAxMTowMTozMAAAAAAEkAAABwAAAAQwMjIxoAEAAwAAAAEAAQAAoAIABAAAAAEAAAD9oAMABAAAAAEAAACZAAAAAAAAAAYBAwADAAAAAQAGAAABGgAFAAAAAQAAAW4BGwAFAAAAAQAAAXYBKAADAAAAAQACAAACAQAEAAAAAQAAAX4CAgAEAAAAAQAACekAAAAAAAAASAAAAAEAAABIAAAAAf/Y/+0ADEFkb2JlX0NNAAH/7gAOQWRvYmUAZIAAAAAB/9sAhAAMCAgICQgMCQkMEQsKCxEVDwwMDxUYExMVExMYEQwMDAwMDBEMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAQ0LCw0ODRAODhAUDg4OFBQODg4OFBEMDAwMDBERDAwMDAwMEQwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCABhAKADASIAAhEBAxEB/90ABAAK/8QBPwAAAQUBAQEBAQEAAAAAAAAAAwABAgQFBgcICQoLAQABBQEBAQEBAQAAAAAAAAABAAIDBAUGBwgJCgsQAAEEAQMCBAIFBwYIBQMMMwEAAhEDBCESMQVBUWETInGBMgYUkaGxQiMkFVLBYjM0coLRQwclklPw4fFjczUWorKDJkSTVGRFwqN0NhfSVeJl8rOEw9N14/NGJ5SkhbSVxNTk9KW1xdXl9VZmdoaWprbG1ub2N0dXZ3eHl6e3x9fn9xEAAgIBAgQEAwQFBgcHBgU1AQACEQMhMRIEQVFhcSITBTKBkRShsUIjwVLR8DMkYuFygpJDUxVjczTxJQYWorKDByY1wtJEk1SjF2RFVTZ0ZeLys4TD03Xj80aUpIW0lcTU5PSltcXV5fVWZnaGlqa2xtbm9ic3R1dnd4eXp7fH/9oADAMBAAIRAxEAPwD1VJJQtuppbvusbWyY3PIaJPaXJKZpKt+0unf9yqf+3G/+SS/aXTv+5VP/AG43/wAkkpspKt+0unf9yqf+3G/+SR2Pa9oewhzXAFrgZBB4IKSmSSSSSlJJJJKUkkkkpSSSSSlJJJJKUkkkkpSSSSSn/9D1VZ/Vq67fsddrWvY7JaHMcAQfZby1y0FR6n/OYP8A4ab/ANRakpn+yul/9w6P+2mf+RS/ZXS/+4dH/bTP/Iq2kkpqfsrpf/cOj/tpn/kU3R/+SMH/AML1f9Q1XFT6P/yRg/8Aher/AKhqSmzdX6tL6tzq97S3eww5siNzHfmvb+as39gn/wAss7/t4f8ApNaVzrG1PdUz1LGtJZWTt3OA9rN+uzd+8s37f17/AMqmf+xLf/SSSlfsE/8Allnf9vD/ANJpfsE/+WWd/wBvD/0mn+39e/8AKpn/ALEt/wDSSX2/r3/lUz/2Jb/6SSUt+wT/AOWWd/28P/SaX7BP/llnf9vD/wBJp/t/Xv8AyqZ/7Et/9JJfb+vf+VTP/Ylv/pJJS37BP/llnf8Abw/9JpfsE/8Allnf9vD/ANJp/t/Xv/Kpn/sS3/0kl9v69/5VM/8AYlv/AKSSUt+wT/5ZZ3/bw/8ASaX7BP8A5ZZ3/bw/9Jp/t/Xv/Kpn/sS3/wBJJfb+vf8AlUz/ANiW/wDpJJS37BP/AJZZ3/bw/wDSaX7BP/llnf8Abw/9Jp/t/Xv/ACqZ/wCxLf8A0kl9v69/5VM/9iW/+kklNzCxPslJq9e3Ilxdvvdvdr+buhvtVhV8K3LtpLsvHGNZuIFYeLNOzt7WsVhJT//R9VVHqf8AOYP/AIab/wBRaryrZ2E3MrYw22UOreLGWVEBwIBb+e2xv5ySmyksz9jW/wDlnm/59f8A6QS/Y1v/AJZ5v+fX/wCkElOmqfR/+SMH/wAL1f8AUNQP2Nb/AOWeb/n1/wDpBXsahmNjVYzCSylja2l0SQ0bBu27fBJSRzmtaXOIa1okk6AAdyg/bsL/ALkVf57f70Wytltbq7Gh9bwWvY4SCDo5rmn95VP2J0b/ALgY3/bTP/IpKTfbsL/uRV/nt/vS+3YX/cir/Pb/AHoP7E6N/wBwMb/tpn/kUv2J0b/uBjf9tM/8ikpN9uwv+5FX+e3+9L7dhf8Acir/AD2/3oP7E6N/3Axv+2mf+RS/YnRv+4GN/wBtM/8AIpKTfbsL/uRV/nt/vS+3YX/cir/Pb/eg/sTo3/cDG/7aZ/5FL9idG/7gY3/bTP8AyKSk327C/wC5FX+e3+9L7dhf9yKv89v96D+xOjf9wMb/ALaZ/wCRS/YnRv8AuBjf9tM/8ikpN9uwv+5FX+e3+9L7dhf9yKv89v8Aeg/sTo3/AHAxv+2mf+RS/YnRv+4GN/20z/yKSm1XbVa3dU9tjZiWkET/AGVNCx8XGxa/TxqmUVklxZW0NEnl21kIqSn/0vVUHKyBjUOvNdlobHsqaXvMkM9tbfc76SMkkpy/2/X/ANwc7/2Gel+36/8AuDnf+wz1qJJKcv8Ab9f/AHBzv/YZ6X7fr/7g53/sM9aiSSnL/b9f/cHO/wDYZ6X7fr/7g53/ALDPWokkpy/2/X/3Bzv/AGGel+36/wDuDnf+wz1qJJKcv9v1/wDcHO/9hnpft+v/ALg53/sM9aiSSnL/AG/X/wBwc7/2Gel+36/+4Od/7DPWokkpy/2/X/3Bzv8A2Gel+36/+4Od/wCwz1qJJKcv9v1/9wc7/wBhnpft+v8A7g53/sM9aiSSmvh5Yy6jaKraQHFuy9hrdp+dsf8Amqwkkkp//9P1VBy8THzMd2Nks9Sl8bmyRO0h7dWFrvpNRkHKdlNoccRjLL9NjbHFrTqN+5zWvd9Dd+akpof81+hf9xf+nZ/6US/5r9C/7i/9Oz/0on9b6y/9xsT/ALes/wDSKXrfWX/uNif9vWf+kUlLf81+hf8AcX/p2f8ApRL/AJr9C/7i/wDTs/8ASif1vrL/ANxsT/t6z/0il631l/7jYn/b1n/pFJS3/NfoX/cX/p2f+lEv+a/Qv+4v/Ts/9KJ/W+sv/cbE/wC3rP8A0il631l/7jYn/b1n/pFJS3/NfoX/AHF/6dn/AKUS/wCa/Qv+4v8A07P/AEon9b6y/wDcbE/7es/9Ipet9Zf+42J/29Z/6RSUt/zX6F/3F/6dn/pRL/mv0L/uL/07P/Sif1vrL/3GxP8At6z/ANIpet9Zf+42J/29Z/6RSUt/zX6F/wBxf+nZ/wClEv8Amv0L/uL/ANOz/wBKJ/W+sv8A3GxP+3rP/SKXrfWX/uNif9vWf+kUlLf81+hf9xf+nZ/6US/5r9C/7i/9Oz/0on9b6y/9xsT/ALes/wDSKXrfWX/uNif9vWf+kUlLf81+hf8AcX/p2f8ApRL/AJr9C/7i/wDTs/8ASif1vrL/ANxsT/t6z/0il631l/7jYn/b1n/pFJTcwsHEwKTTiM9OsuLi2S7U8n3lysKvhOznVE5zK67dxhtTi9u3807ntr9ysJKf/9T1VJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJT//V9VSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp//Z/+0TXFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAAAPHAFaAAMbJUccAgAAAgAAADhCSU0EJQAAAAAAEM3P+n2ox74JBXB2rq8Fw044QklNBDoAAAAAAOUAAAAQAAAAAQAAAAAAC3ByaW50T3V0cHV0AAAABQAAAABQc3RTYm9vbAEAAAAASW50ZWVudW0AAAAASW50ZQAAAABDbHJtAAAAD3ByaW50U2l4dGVlbkJpdGJvb2wAAAAAC3ByaW50ZXJOYW1lVEVYVAAAAAEAAAAAAA9wcmludFByb29mU2V0dXBPYmpjAAAADABQAHIAbwBvAGYAIABTAGUAdAB1AHAAAAAAAApwcm9vZlNldHVwAAAAAQAAAABCbHRuZW51bQAAAAxidWlsdGluUHJvb2YAAAAJcHJvb2ZDTVlLADhCSU0EOwAAAAACLQAAABAAAAABAAAAAAAScHJpbnRPdXRwdXRPcHRpb25zAAAAFwAAAABDcHRuYm9vbAAAAAAAQ2xicmJvb2wAAAAAAFJnc01ib29sAAAAAABDcm5DYm9vbAAAAAAAQ250Q2Jvb2wAAAAAAExibHNib29sAAAAAABOZ3R2Ym9vbAAAAAAARW1sRGJvb2wAAAAAAEludHJib29sAAAAAABCY2tnT2JqYwAAAAEAAAAAAABSR0JDAAAAAwAAAABSZCAgZG91YkBv4AAAAAAAAAAAAEdybiBkb3ViQG/gAAAAAAAAAAAAQmwgIGRvdWJAb+AAAAAAAAAAAABCcmRUVW50RiNSbHQAAAAAAAAAAAAAAABCbGQgVW50RiNSbHQAAAAAAAAAAAAAAABSc2x0VW50RiNQeGxAUgAAAAAAAAAAAAp2ZWN0b3JEYXRhYm9vbAEAAAAAUGdQc2VudW0AAAAAUGdQcwAAAABQZ1BDAAAAAExlZnRVbnRGI1JsdAAAAAAAAAAAAAAAAFRvcCBVbnRGI1JsdAAAAAAAAAAAAAAAAFNjbCBVbnRGI1ByY0BZAAAAAAAAAAAAEGNyb3BXaGVuUHJpbnRpbmdib29sAAAAAA5jcm9wUmVjdEJvdHRvbWxvbmcAAAAAAAAADGNyb3BSZWN0TGVmdGxvbmcAAAAAAAAADWNyb3BSZWN0UmlnaHRsb25nAAAAAAAAAAtjcm9wUmVjdFRvcGxvbmcAAAAAADhCSU0D7QAAAAAAEABIAAAAAQABAEgAAAABAAE4QklNBCYAAAAAAA4AAAAAAAAAAAAAP4AAADhCSU0D8gAAAAAACgAA////////AAA4QklNBA0AAAAAAAQAAAB4OEJJTQQZAAAAAAAEAAAAHjhCSU0D8wAAAAAACQAAAAAAAAAAAQA4QklNJxAAAAAAAAoAAQAAAAAAAAABOEJJTQP1AAAAAABIAC9mZgABAGxmZgAGAAAAAAABAC9mZgABAKGZmgAGAAAAAAABADIAAAABAFoAAAAGAAAAAAABADUAAAABAC0AAAAGAAAAAAABOEJJTQP4AAAAAABwAAD/////////////////////////////A+gAAAAA/////////////////////////////wPoAAAAAP////////////////////////////8D6AAAAAD/////////////////////////////A+gAADhCSU0EAAAAAAAAAgAIOEJJTQQCAAAAAAASAAAAAAAAAAAAAAAAAAAAAAAAOEJJTQQwAAAAAAAJAQEBAQEBAQEBADhCSU0ELQAAAAAAAgAAOEJJTQQIAAAAAAAQAAAAAQAAAkAAAAJAAAAAADhCSU0EHgAAAAAABAAAAAA4QklNBBoAAAAAA0cAAAAGAAAAAAAAAAAAAACZAAAA/QAAAAkAaQBuAHMAdQByAGEAbgBjAGUAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAP0AAACZAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAEAAAAAAABudWxsAAAAAgAAAAZib3VuZHNPYmpjAAAAAQAAAAAAAFJjdDEAAAAEAAAAAFRvcCBsb25nAAAAAAAAAABMZWZ0bG9uZwAAAAAAAAAAQnRvbWxvbmcAAACZAAAAAFJnaHRsb25nAAAA/QAAAAZzbGljZXNWbExzAAAAAU9iamMAAAABAAAAAAAFc2xpY2UAAAASAAAAB3NsaWNlSURsb25nAAAAAAAAAAdncm91cElEbG9uZwAAAAAAAAAGb3JpZ2luZW51bQAAAAxFU2xpY2VPcmlnaW4AAAANYXV0b0dlbmVyYXRlZAAAAABUeXBlZW51bQAAAApFU2xpY2VUeXBlAAAAAEltZyAAAAAGYm91bmRzT2JqYwAAAAEAAAAAAABSY3QxAAAABAAAAABUb3AgbG9uZwAAAAAAAAAATGVmdGxvbmcAAAAAAAAAAEJ0b21sb25nAAAAmQAAAABSZ2h0bG9uZwAAAP0AAAADdXJsVEVYVAAAAAEAAAAAAABudWxsVEVYVAAAAAEAAAAAAABNc2dlVEVYVAAAAAEAAAAAAAZhbHRUYWdURVhUAAAAAQAAAAAADmNlbGxUZXh0SXNIVE1MYm9vbAEAAAAIY2VsbFRleHRURVhUAAAAAQAAAAAACWhvcnpBbGlnbmVudW0AAAAPRVNsaWNlSG9yekFsaWduAAAAB2RlZmF1bHQAAAAJdmVydEFsaWduZW51bQAAAA9FU2xpY2VWZXJ0QWxpZ24AAAAHZGVmYXVsdAAAAAtiZ0NvbG9yVHlwZWVudW0AAAARRVNsaWNlQkdDb2xvclR5cGUAAAAATm9uZQAAAAl0b3BPdXRzZXRsb25nAAAAAAAAAApsZWZ0T3V0c2V0bG9uZwAAAAAAAAAMYm90dG9tT3V0c2V0bG9uZwAAAAAAAAALcmlnaHRPdXRzZXRsb25nAAAAAAA4QklNBCgAAAAAAAwAAAACP/AAAAAAAAA4QklNBBQAAAAAAAQAAAAOOEJJTQQMAAAAAAoFAAAAAQAAAKAAAABhAAAB4AAAteAAAAnpABgAAf/Y/+0ADEFkb2JlX0NNAAH/7gAOQWRvYmUAZIAAAAAB/9sAhAAMCAgICQgMCQkMEQsKCxEVDwwMDxUYExMVExMYEQwMDAwMDBEMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAQ0LCw0ODRAODhAUDg4OFBQODg4OFBEMDAwMDBERDAwMDAwMEQwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCABhAKADASIAAhEBAxEB/90ABAAK/8QBPwAAAQUBAQEBAQEAAAAAAAAAAwABAgQFBgcICQoLAQABBQEBAQEBAQAAAAAAAAABAAIDBAUGBwgJCgsQAAEEAQMCBAIFBwYIBQMMMwEAAhEDBCESMQVBUWETInGBMgYUkaGxQiMkFVLBYjM0coLRQwclklPw4fFjczUWorKDJkSTVGRFwqN0NhfSVeJl8rOEw9N14/NGJ5SkhbSVxNTk9KW1xdXl9VZmdoaWprbG1ub2N0dXZ3eHl6e3x9fn9xEAAgIBAgQEAwQFBgcHBgU1AQACEQMhMRIEQVFhcSITBTKBkRShsUIjwVLR8DMkYuFygpJDUxVjczTxJQYWorKDByY1wtJEk1SjF2RFVTZ0ZeLys4TD03Xj80aUpIW0lcTU5PSltcXV5fVWZnaGlqa2xtbm9ic3R1dnd4eXp7fH/9oADAMBAAIRAxEAPwD1VJJQtuppbvusbWyY3PIaJPaXJKZpKt+0unf9yqf+3G/+SS/aXTv+5VP/AG43/wAkkpspKt+0unf9yqf+3G/+SR2Pa9oewhzXAFrgZBB4IKSmSSSSSlJJJJKUkkkkpSSSSSlJJJJKUkkkkpSSSSSn/9D1VZ/Vq67fsddrWvY7JaHMcAQfZby1y0FR6n/OYP8A4ab/ANRakpn+yul/9w6P+2mf+RS/ZXS/+4dH/bTP/Iq2kkpqfsrpf/cOj/tpn/kU3R/+SMH/AML1f9Q1XFT6P/yRg/8Aher/AKhqSmzdX6tL6tzq97S3eww5siNzHfmvb+as39gn/wAss7/t4f8ApNaVzrG1PdUz1LGtJZWTt3OA9rN+uzd+8s37f17/AMqmf+xLf/SSSlfsE/8Allnf9vD/ANJpfsE/+WWd/wBvD/0mn+39e/8AKpn/ALEt/wDSSX2/r3/lUz/2Jb/6SSUt+wT/AOWWd/28P/SaX7BP/llnf9vD/wBJp/t/Xv8AyqZ/7Et/9JJfb+vf+VTP/Ylv/pJJS37BP/llnf8Abw/9JpfsE/8Allnf9vD/ANJp/t/Xv/Kpn/sS3/0kl9v69/5VM/8AYlv/AKSSUt+wT/5ZZ3/bw/8ASaX7BP8A5ZZ3/bw/9Jp/t/Xv/Kpn/sS3/wBJJfb+vf8AlUz/ANiW/wDpJJS37BP/AJZZ3/bw/wDSaX7BP/llnf8Abw/9Jp/t/Xv/ACqZ/wCxLf8A0kl9v69/5VM/9iW/+kklNzCxPslJq9e3Ilxdvvdvdr+buhvtVhV8K3LtpLsvHGNZuIFYeLNOzt7WsVhJT//R9VVHqf8AOYP/AIab/wBRaryrZ2E3MrYw22UOreLGWVEBwIBb+e2xv5ySmyksz9jW/wDlnm/59f8A6QS/Y1v/AJZ5v+fX/wCkElOmqfR/+SMH/wAL1f8AUNQP2Nb/AOWeb/n1/wDpBXsahmNjVYzCSylja2l0SQ0bBu27fBJSRzmtaXOIa1okk6AAdyg/bsL/ALkVf57f70Wytltbq7Gh9bwWvY4SCDo5rmn95VP2J0b/ALgY3/bTP/IpKTfbsL/uRV/nt/vS+3YX/cir/Pb/AHoP7E6N/wBwMb/tpn/kUv2J0b/uBjf9tM/8ikpN9uwv+5FX+e3+9L7dhf8Acir/AD2/3oP7E6N/3Axv+2mf+RS/YnRv+4GN/wBtM/8AIpKTfbsL/uRV/nt/vS+3YX/cir/Pb/eg/sTo3/cDG/7aZ/5FL9idG/7gY3/bTP8AyKSk327C/wC5FX+e3+9L7dhf9yKv89v96D+xOjf9wMb/ALaZ/wCRS/YnRv8AuBjf9tM/8ikpN9uwv+5FX+e3+9L7dhf9yKv89v8Aeg/sTo3/AHAxv+2mf+RS/YnRv+4GN/20z/yKSm1XbVa3dU9tjZiWkET/AGVNCx8XGxa/TxqmUVklxZW0NEnl21kIqSn/0vVUHKyBjUOvNdlobHsqaXvMkM9tbfc76SMkkpy/2/X/ANwc7/2Gel+36/8AuDnf+wz1qJJKcv8Ab9f/AHBzv/YZ6X7fr/7g53/sM9aiSSnL/b9f/cHO/wDYZ6X7fr/7g53/ALDPWokkpy/2/X/3Bzv/AGGel+36/wDuDnf+wz1qJJKcv9v1/wDcHO/9hnpft+v/ALg53/sM9aiSSnL/AG/X/wBwc7/2Gel+36/+4Od/7DPWokkpy/2/X/3Bzv8A2Gel+36/+4Od/wCwz1qJJKcv9v1/9wc7/wBhnpft+v8A7g53/sM9aiSSmvh5Yy6jaKraQHFuy9hrdp+dsf8Amqwkkkp//9P1VBy8THzMd2Nks9Sl8bmyRO0h7dWFrvpNRkHKdlNoccRjLL9NjbHFrTqN+5zWvd9Dd+akpof81+hf9xf+nZ/6US/5r9C/7i/9Oz/0on9b6y/9xsT/ALes/wDSKXrfWX/uNif9vWf+kUlLf81+hf8AcX/p2f8ApRL/AJr9C/7i/wDTs/8ASif1vrL/ANxsT/t6z/0il631l/7jYn/b1n/pFJS3/NfoX/cX/p2f+lEv+a/Qv+4v/Ts/9KJ/W+sv/cbE/wC3rP8A0il631l/7jYn/b1n/pFJS3/NfoX/AHF/6dn/AKUS/wCa/Qv+4v8A07P/AEon9b6y/wDcbE/7es/9Ipet9Zf+42J/29Z/6RSUt/zX6F/3F/6dn/pRL/mv0L/uL/07P/Sif1vrL/3GxP8At6z/ANIpet9Zf+42J/29Z/6RSUt/zX6F/wBxf+nZ/wClEv8Amv0L/uL/ANOz/wBKJ/W+sv8A3GxP+3rP/SKXrfWX/uNif9vWf+kUlLf81+hf9xf+nZ/6US/5r9C/7i/9Oz/0on9b6y/9xsT/ALes/wDSKXrfWX/uNif9vWf+kUlLf81+hf8AcX/p2f8ApRL/AJr9C/7i/wDTs/8ASif1vrL/ANxsT/t6z/0il631l/7jYn/b1n/pFJTcwsHEwKTTiM9OsuLi2S7U8n3lysKvhOznVE5zK67dxhtTi9u3807ntr9ysJKf/9T1VJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJSkkkklKSSSSUpJJJJT//V9VSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp+qkl8qpJKfqpJfKqSSn6qSXyqkkp//ZADhCSU0EIQAAAAAAVQAAAAEBAAAADwBBAGQAbwBiAGUAIABQAGgAbwB0AG8AcwBoAG8AcAAAABMAQQBkAG8AYgBlACAAUABoAG8AdABvAHMAaABvAHAAIABDAFMANgAAAAEAOEJJTQQGAAAAAAAHAAgAAAABAQD/4Q7caHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjMtYzAxMSA2Ni4xNDU2NjEsIDIwMTIvMDIvMDYtMTQ6NTY6MjcgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAxMy0wNi0wNlQyMzo1OTo1NS0wNDowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAxMy0wOS0xNlQxMTowMTozMC0wNDowMCIgeG1wOk1vZGlmeURhdGU9IjIwMTMtMDktMTZUMTE6MDE6MzAtMDQ6MDAiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6Rjg2RjNEOTVEQjFFRTMxMThBNTM5OTE5MTgzMjBCMEUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RkE5ODgwNUMyNUNGRTIxMUEzM0FBQ0U5MEZCMDc0MTUiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQTk4ODA1QzI1Q0ZFMjExQTMzQUFDRTkwRkIwNzQxNSIgZGM6Zm9ybWF0PSJpbWFnZS9qcGVnIiBwaG90b3Nob3A6TGVnYWN5SVBUQ0RpZ2VzdD0iMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDEiIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6RkE5ODgwNUMyNUNGRTIxMUEzM0FBQ0U5MEZCMDc0MTUiIHN0RXZ0OndoZW49IjIwMTMtMDYtMDZUMjM6NTk6NTUtMDQ6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpGQjk4ODA1QzI1Q0ZFMjExQTMzQUFDRTkwRkIwNzQxNSIgc3RFdnQ6d2hlbj0iMjAxMy0wNi0wNlQyMzo1OTo1NS0wNDowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHN0RXZ0OmNoYW5nZWQ9Ii8iLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOkY4NkYzRDk1REIxRUUzMTE4QTUzOTkxOTE4MzIwQjBFIiBzdEV2dDp3aGVuPSIyMDEzLTA5LTE2VDExOjAxOjMwLTA0OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ1M2IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPD94cGFja2V0IGVuZD0idyI/Pv/iDFhJQ0NfUFJPRklMRQABAQAADEhMaW5vAhAAAG1udHJSR0IgWFlaIAfOAAIACQAGADEAAGFjc3BNU0ZUAAAAAElFQyBzUkdCAAAAAAAAAAAAAAABAAD21gABAAAAANMtSFAgIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEWNwcnQAAAFQAAAAM2Rlc2MAAAGEAAAAbHd0cHQAAAHwAAAAFGJrcHQAAAIEAAAAFHJYWVoAAAIYAAAAFGdYWVoAAAIsAAAAFGJYWVoAAAJAAAAAFGRtbmQAAAJUAAAAcGRtZGQAAALEAAAAiHZ1ZWQAAANMAAAAhnZpZXcAAAPUAAAAJGx1bWkAAAP4AAAAFG1lYXMAAAQMAAAAJHRlY2gAAAQwAAAADHJUUkMAAAQ8AAAIDGdUUkMAAAQ8AAAIDGJUUkMAAAQ8AAAIDHRleHQAAAAAQ29weXJpZ2h0IChjKSAxOTk4IEhld2xldHQtUGFja2FyZCBDb21wYW55AABkZXNjAAAAAAAAABJzUkdCIElFQzYxOTY2LTIuMQAAAAAAAAAAAAAAEnNSR0IgSUVDNjE5NjYtMi4xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYWVogAAAAAAAA81EAAQAAAAEWzFhZWiAAAAAAAAAAAAAAAAAAAAAAWFlaIAAAAAAAAG+iAAA49QAAA5BYWVogAAAAAAAAYpkAALeFAAAY2lhZWiAAAAAAAAAkoAAAD4QAALbPZGVzYwAAAAAAAAAWSUVDIGh0dHA6Ly93d3cuaWVjLmNoAAAAAAAAAAAAAAAWSUVDIGh0dHA6Ly93d3cuaWVjLmNoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGRlc2MAAAAAAAAALklFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQgAAAAAAAAAAAAAALklFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQgAAAAAAAAAAAAAAAAAAAAAAAAAAAABkZXNjAAAAAAAAACxSZWZlcmVuY2UgVmlld2luZyBDb25kaXRpb24gaW4gSUVDNjE5NjYtMi4xAAAAAAAAAAAAAAAsUmVmZXJlbmNlIFZpZXdpbmcgQ29uZGl0aW9uIGluIElFQzYxOTY2LTIuMQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdmlldwAAAAAAE6T+ABRfLgAQzxQAA+3MAAQTCwADXJ4AAAABWFlaIAAAAAAATAlWAFAAAABXH+dtZWFzAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAACjwAAAAJzaWcgAAAAAENSVCBjdXJ2AAAAAAAABAAAAAAFAAoADwAUABkAHgAjACgALQAyADcAOwBAAEUASgBPAFQAWQBeAGMAaABtAHIAdwB8AIEAhgCLAJAAlQCaAJ8ApACpAK4AsgC3ALwAwQDGAMsA0ADVANsA4ADlAOsA8AD2APsBAQEHAQ0BEwEZAR8BJQErATIBOAE+AUUBTAFSAVkBYAFnAW4BdQF8AYMBiwGSAZoBoQGpAbEBuQHBAckB0QHZAeEB6QHyAfoCAwIMAhQCHQImAi8COAJBAksCVAJdAmcCcQJ6AoQCjgKYAqICrAK2AsECywLVAuAC6wL1AwADCwMWAyEDLQM4A0MDTwNaA2YDcgN+A4oDlgOiA64DugPHA9MD4APsA/kEBgQTBCAELQQ7BEgEVQRjBHEEfgSMBJoEqAS2BMQE0wThBPAE/gUNBRwFKwU6BUkFWAVnBXcFhgWWBaYFtQXFBdUF5QX2BgYGFgYnBjcGSAZZBmoGewaMBp0GrwbABtEG4wb1BwcHGQcrBz0HTwdhB3QHhgeZB6wHvwfSB+UH+AgLCB8IMghGCFoIbgiCCJYIqgi+CNII5wj7CRAJJQk6CU8JZAl5CY8JpAm6Cc8J5Qn7ChEKJwo9ClQKagqBCpgKrgrFCtwK8wsLCyILOQtRC2kLgAuYC7ALyAvhC/kMEgwqDEMMXAx1DI4MpwzADNkM8w0NDSYNQA1aDXQNjg2pDcMN3g34DhMOLg5JDmQOfw6bDrYO0g7uDwkPJQ9BD14Peg+WD7MPzw/sEAkQJhBDEGEQfhCbELkQ1xD1ERMRMRFPEW0RjBGqEckR6BIHEiYSRRJkEoQSoxLDEuMTAxMjE0MTYxODE6QTxRPlFAYUJxRJFGoUixStFM4U8BUSFTQVVhV4FZsVvRXgFgMWJhZJFmwWjxayFtYW+hcdF0EXZReJF64X0hf3GBsYQBhlGIoYrxjVGPoZIBlFGWsZkRm3Gd0aBBoqGlEadxqeGsUa7BsUGzsbYxuKG7Ib2hwCHCocUhx7HKMczBz1HR4dRx1wHZkdwx3sHhYeQB5qHpQevh7pHxMfPh9pH5Qfvx/qIBUgQSBsIJggxCDwIRwhSCF1IaEhziH7IiciVSKCIq8i3SMKIzgjZiOUI8Ij8CQfJE0kfCSrJNolCSU4JWgllyXHJfcmJyZXJocmtyboJxgnSSd6J6sn3CgNKD8ocSiiKNQpBik4KWspnSnQKgIqNSpoKpsqzysCKzYraSudK9EsBSw5LG4soizXLQwtQS12Last4S4WLkwugi63Lu4vJC9aL5Evxy/+MDUwbDCkMNsxEjFKMYIxujHyMioyYzKbMtQzDTNGM38zuDPxNCs0ZTSeNNg1EzVNNYc1wjX9Njc2cjauNuk3JDdgN5w31zgUOFA4jDjIOQU5Qjl/Obw5+To2OnQ6sjrvOy07azuqO+g8JzxlPKQ84z0iPWE9oT3gPiA+YD6gPuA/IT9hP6I/4kAjQGRApkDnQSlBakGsQe5CMEJyQrVC90M6Q31DwEQDREdEikTORRJFVUWaRd5GIkZnRqtG8Ec1R3tHwEgFSEtIkUjXSR1JY0mpSfBKN0p9SsRLDEtTS5pL4kwqTHJMuk0CTUpNk03cTiVObk63TwBPSU+TT91QJ1BxULtRBlFQUZtR5lIxUnxSx1MTU19TqlP2VEJUj1TbVShVdVXCVg9WXFapVvdXRFeSV+BYL1h9WMtZGllpWbhaB1pWWqZa9VtFW5Vb5Vw1XIZc1l0nXXhdyV4aXmxevV8PX2Ffs2AFYFdgqmD8YU9homH1YklinGLwY0Njl2PrZEBklGTpZT1lkmXnZj1mkmboZz1nk2fpaD9olmjsaUNpmmnxakhqn2r3a09rp2v/bFdsr20IbWBtuW4SbmtuxG8eb3hv0XArcIZw4HE6cZVx8HJLcqZzAXNdc7h0FHRwdMx1KHWFdeF2Pnabdvh3VnezeBF4bnjMeSp5iXnnekZ6pXsEe2N7wnwhfIF84X1BfaF+AX5ifsJ/I3+Ef+WAR4CogQqBa4HNgjCCkoL0g1eDuoQdhICE44VHhauGDoZyhteHO4efiASIaYjOiTOJmYn+imSKyoswi5aL/IxjjMqNMY2Yjf+OZo7OjzaPnpAGkG6Q1pE/kaiSEZJ6kuOTTZO2lCCUipT0lV+VyZY0lp+XCpd1l+CYTJi4mSSZkJn8mmia1ZtCm6+cHJyJnPedZJ3SnkCerp8dn4uf+qBpoNihR6G2oiailqMGo3aj5qRWpMelOKWpphqmi6b9p26n4KhSqMSpN6mpqhyqj6sCq3Wr6axcrNCtRK24ri2uoa8Wr4uwALB1sOqxYLHWskuywrM4s660JbSctRO1irYBtnm28Ldot+C4WbjRuUq5wro7urW7LrunvCG8m70VvY++Cr6Evv+/er/1wHDA7MFnwePCX8Lbw1jD1MRRxM7FS8XIxkbGw8dBx7/IPci8yTrJuco4yrfLNsu2zDXMtc01zbXONs62zzfPuNA50LrRPNG+0j/SwdNE08bUSdTL1U7V0dZV1tjXXNfg2GTY6Nls2fHadtr724DcBdyK3RDdlt4c3qLfKd+v4DbgveFE4cziU+Lb42Pj6+Rz5PzlhOYN5pbnH+ep6DLovOlG6dDqW+rl63Dr++yG7RHtnO4o7rTvQO/M8Fjw5fFy8f/yjPMZ86f0NPTC9VD13vZt9vv3ivgZ+Kj5OPnH+lf65/t3/Af8mP0p/br+S/7c/23////uAA5BZG9iZQBkQAAAAAH/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQECAgICAgICAgICAgMDAwMDAwMDAwMBAQEBAQEBAQEBAQICAQICAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA//AABEIAJkA/QMBEQACEQEDEQH/3QAEACD/xAGiAAAABgIDAQAAAAAAAAAAAAAHCAYFBAkDCgIBAAsBAAAGAwEBAQAAAAAAAAAAAAYFBAMHAggBCQAKCxAAAgEDBAEDAwIDAwMCBgl1AQIDBBEFEgYhBxMiAAgxFEEyIxUJUUIWYSQzF1JxgRhikSVDobHwJjRyChnB0TUn4VM2gvGSokRUc0VGN0djKFVWVxqywtLi8mSDdJOEZaOzw9PjKThm83UqOTpISUpYWVpnaGlqdnd4eXqFhoeIiYqUlZaXmJmapKWmp6ipqrS1tre4ubrExcbHyMnK1NXW19jZ2uTl5ufo6er09fb3+Pn6EQACAQMCBAQDBQQEBAYGBW0BAgMRBCESBTEGACITQVEHMmEUcQhCgSORFVKhYhYzCbEkwdFDcvAX4YI0JZJTGGNE8aKyJjUZVDZFZCcKc4OTRnTC0uLyVWV1VjeEhaOzw9Pj8ykalKS0xNTk9JWltcXV5fUoR1dmOHaGlqa2xtbm9md3h5ent8fX5/dIWGh4iJiouMjY6Pg5SVlpeYmZqbnJ2en5KjpKWmp6ipqqusra6vr/2gAMAwEAAhEDEQA/AN/j37r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvdf//Q3+Pfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691//9Hf49+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3X//0t/j37r3XvfuvdEX+d+zMP2Ltn4/bD3A1YmD3d8n+vdv5VsfOlNXLQZPa3YFLUmkqJIaiOGoEch0sUcA/g+/de6Qv/DWXxl/5Xezv/QqxX/2M+/de69/w1l8Zf8Ald7O/wDQqxX/ANjPv3Xuvf8ADWXxl/5Xezv/AEKsV/8AYz7917r3/DWXxl/5Xezv/QqxX/2M+/de6RXZX8tL46bT653/ALqxdX2O2T21srdW4MctVubGTUrV+GwVfkaMVMSbdieWnNRTLrUMpZbgEfX37r3R7fjZ/wBk69Bf+IV6s/8AeGwXv3Xuhq9+690l971W6qHZe767YuNoszvej2vn6rZ2HyUiRY7Lbqp8TVzbexuQlkyGJjjoq7LpDFKzVVMBG5JljHrHuvdV0/6U/wCad/3jZ0r/AOf3D/8A2/ffuvde/wBKf807/vGzpX/z+4f/AO377917r3+lP+ad/wB42dK/+f3D/wD2/ffuvde/0p/zTv8AvGzpX/z+4f8A+377917r3+lP+ad/3jZ0r/5/cP8A/b99+6917/Sn/NO/7xs6V/8AP7h//t++/de69/pT/mnf942dK/8An9w//wBv337r3Xv9Kf8ANO/7xs6V/wDP7h//ALfvv3Xuvf6U/wCad/3jZ0r/AOf3D/8A2/ffuvde/wBKf807/vGzpX/z+4f/AO377917r3+lP+ad/wB42dK/+f3D/wD2/ffuvde/0p/zTv8AvGzpX/z+4f8A+377917r3+lP+ad/3jZ0r/5/cP8A/b99+6917/Sn/NO/7xs6V/8AP7h//t++/de69/pT/mnf942dK/8An9w//wBv337r3Xv9Kf8ANO/7xs6V/wDP7h//ALfvv3Xuvf6U/wCad/3jZ0r/AOf3D/8A2/ffuvde/wBKf807/vGzpX/z+4f/AO377917qz737r3Xvfuvde9+691//9Pf49+691737r3RRPln/wADvit/4t31Z/7z2/ffuvdG79+691737r3Xvfuvde9+690F3eH/ADJXt/8A8Rd2B/7yeW9+690zfGz/ALJ16C/8Qr1Z/wC8NgvfuvdDV7917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuv/1N/j37r3XvfuvdFE+Wf/AAO+K3/i3fVn/vPb99+690bv37r3Xvfuvde9+691737r3QXd4f8AMle3/wDxF3YH/vJ5b37r3TN8bP8AsnXoL/xCvVn/ALw2C9+690NXv3XukvvfPZHa2y937nw+363duX25tfP57F7VxpnGR3NkcRiavIUO38eaWiyVSK3M1NOtNF46aok8kg0xubKfde6rp/2e35Ff96++6v8Aqfvn/wC0r7917r3+z2/Ir/vX33V/1P3z/wDaV9+6917/AGe35Ff96++6v+p++f8A7Svv3Xuvf7Pb8iv+9ffdX/U/fP8A9pX37r3Xv9nt+RX/AHr77q/6n75/+0r7917r3+z2/Ir/AL1991f9T98//aV9+6917/Z7fkV/3r77q/6n75/+0r7917r3+z2/Ir/vX33V/wBT98//AGlffuvde/2e35Ff96++6v8Aqfvn/wC0r7917r3+z2/Ir/vX33V/1P3z/wDaV9+6917/AGe35Ff96++6v+p++f8A7Svv3Xuvf7Pb8iv+9ffdX/U/fP8A9pX37r3Xv9nt+RX/AHr77q/6n75/+0r7917r3+z2/Ir/AL1991f9T98//aV9+6917/Z7fkV/3r77q/6n75/+0r7917r3+z2/Ir/vX33V/wBT98//AGlffuvde/2e35Ff96++6v8Aqfvn/wC0r7917r3+z2/Ir/vX33V/1P3z/wDaV9+691Z97917r3v3Xuve/de6/9Xf49+691737r3RRPln/wADvit/4t31Z/7z2/ffuvdG79+691737r3Xvfuvde9+690F3eH/ADJXt/8A8Rd2B/7yeW9+690zfGz/ALJ16C/8Qr1Z/wC8NgvfuvdDV7917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuve/de697917r3v3Xuv/1t/j37r3XvfuvdFE+Wf/AAO+K3/i3fVn/vPb99+690bv37r3Xvfuvde9+691737r3QXd4f8AMle3/wDxF3YH/vJ5b37r3TN8bP8AsnXoL/xCvVn/ALw2C9+690NXv3XumXcu4sPtDbmf3ZuKs/h239r4TK7izuQ+3qqv7HD4ShnyWTrPtaGCpran7aipnfxwxySvpsisxAPuvdFF/wCHEPh3/wA/f/8AYf8AaP8A9hPv3Xuvf8OIfDv/AJ+//wCw/wC0f/sJ9+6917/hxD4d/wDP3/8A2H/aP/2E+/de69/w4h8O/wDn7/8A7D/tH/7Cffuvde/4cQ+Hf/P3/wD2H/aP/wBhPv3Xuvf8OIfDv/n7/wD7D/tH/wCwn37r3Xv+HEPh3/z9/wD9h/2j/wDYT7917r3/AA4h8O/+fv8A/sP+0f8A7Cffuvde/wCHEPh3/wA/f/8AYf8AaP8A9hPv3Xuvf8OIfDv/AJ+//wCw/wC0f/sJ9+6917/hxD4d/wDP3/8A2H/aP/2E+/de69/w4h8O/wDn7/8A7D/tH/7Cffuvde/4cQ+Hf/P3/wD2H/aP/wBhPv3Xuvf8OIfDv/n7/wD7D/tH/wCwn37r3Xv+HEPh3/z9/wD9h/2j/wDYT7917r3/AA4h8O/+fv8A/sP+0f8A7Cffuvde/wCHEPh3/wA/f/8AYf8AaP8A9hPv3Xuvf8OIfDv/AJ+//wCw/wC0f/sJ9+690dT37r3Xvfuvde9+691//9ff49+691737r3Rdfkt0XmO+9pbTwO3+xazq7ObP7Cw3YOK3Xj8I+drqevwuG3FiqaGkgjz23pKOoEmeEy1AnYoYdOg6tS+690Wf/ZM/k1/3n52d/6COV/+2p7917r3+yZ/Jr/vPzs7/wBBHK//AG1Pfuvde/2TP5Nf95+dnf8AoI5X/wC2p7917r3+yZ/Jr/vPzs7/ANBHK/8A21PfuvdQsl8IvkXmMdX4nKfPHsfIYzKUVVjsjQVWzcnNS1tBWwSU1ZSVML9plJaepp5WR1PDKxB9+690frrXZ/8Ao8662DsD+I/xf+4+ytq7P/i32n8P/in92cFQYX+I/YfdVv2X3v2Xl8Pmm8erTre2o+690tffuvdQsljcdmcdkMPmMfRZbEZaiqsblMXkqWCux2Sx1dBJS12PyFDVRy01ZRVlNK0csUitHJGxVgQSPfuvdBF/stnx1/58F0r/AOis2N/9Yvfuvde/2Wz46/8APgulf/RWbG/+sXv3Xuvf7LZ8df8AnwXSv/orNjf/AFi9+6917/ZbPjr/AM+C6V/9FZsb/wCsXv3Xuvf7LZ8df+fBdK/+is2N/wDWL37r3Xv9ls+Ov/Pgulf/AEVmxv8A6xe/de69/stnx1/58F0r/wCis2N/9Yvfuvde/wBls+Ov/Pgulf8A0Vmxv/rF7917r3+y2fHX/nwXSv8A6KzY3/1i9+6917/ZbPjr/wA+C6V/9FZsb/6xe/de69/stnx1/wCfBdK/+is2N/8AWL37r3Xv9ls+Ov8Az4LpX/0Vmxv/AKxe/de69/stnx1/58F0r/6KzY3/ANYvfuvde/2Wz46/8+C6V/8ARWbG/wDrF7917r3+y2fHX/nwXSv/AKKzY3/1i9+6917/AGWz46/8+C6V/wDRWbG/+sXv3Xuvf7LZ8df+fBdK/wDorNjf/WL37r3Xv9ls+Ov/AD4LpX/0Vmxv/rF7917oavfuvde9+691737r3X//0N/j37r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvdf//R3+Pfuvde9+690GHc2+9x9Z9bbk3vtPr7N9p7gwn8H/h+w9utXLmM7/Es9i8RVfZtjcLuKtH8Loq+Ssk0Uc37VO19C3dfde6Ih/s9vyK/71991f8AU/fP/wBpX37r3Xv9nt+RX/evvur/AKn75/8AtK+/de69/s9vyK/71991f9T98/8A2lffuvde/wBnt+RX/evvur/qfvn/AO0r7917r3+z2/Ir/vX33V/1P3z/APaV9+6917/Z7fkV/wB6++6v+p++f/tK+/de69/s9vyK/wC9ffdX/U/fP/2lffuvde/2e35Ff96++6v+p++f/tK+/de69/s9vyK/71991f8AU/fP/wBpX37r3Xv9nt+RX/evvur/AKn75/8AtK+/de69/s9vyK/71991f9T98/8A2lffuvde/wBnt+RX/evvur/qfvn/AO0r7917r3+z2/Ir/vX33V/1P3z/APaV9+6917/Z7fkV/wB6++6v+p++f/tK+/de69/s9vyK/wC9ffdX/U/fP/2lffuvde/2e35Ff96++6v+p++f/tK+/de69/s9vyK/71991f8AU/fP/wBpX37r3Xv9nt+RX/evvur/AKn75/8AtK+/de69/s9vyK/71991f9T98/8A2lffuvde/wBnt+RX/evvur/qfvn/AO0r7917r3+z2/Ir/vX33V/1P3z/APaV9+6917/Z7fkV/wB6++6v+p++f/tK+/de69/s9vyK/wC9ffdX/U/fP/2lffuvde/2e35Ff96++6v+p++f/tK+/de69/s9vyK/71991f8AU/fP/wBpX37r3Xv9nt+RX/evvur/AKn75/8AtK+/de6s+9+691737r3Xvfuvdf/S3+Pfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691//9Pf49+691737r3QYdzds7c6N623J2luyizeR2/tf+D/AMQo9u01DV5ib+N57F7dpfs6fJZLEUUnjrcvG0muojtErEamAU+690RD/h2P46/88X3V/wCg7sb/AO2N7917r3/Dsfx1/wCeL7q/9B3Y3/2xvfuvde/4dj+Ov/PF91f+g7sb/wC2N7917r3/AA7H8df+eL7q/wDQd2N/9sb37r3Xv+HY/jr/AM8X3V/6Duxv/tje/de69/w7H8df+eL7q/8AQd2N/wDbG9+6917/AIdj+Ov/ADxfdX/oO7G/+2N7917r3/Dsfx1/54vur/0Hdjf/AGxvfuvde/4dj+Ov/PF91f8AoO7G/wDtje/de69/w7H8df8Ani+6v/Qd2N/9sb37r3Xv+HY/jr/zxfdX/oO7G/8Atje/de69/wAOx/HX/ni+6v8A0Hdjf/bG9+6917/h2P46/wDPF91f+g7sb/7Y3v3Xuvf8Ox/HX/ni+6v/AEHdjf8A2xvfuvde/wCHY/jr/wA8X3V/6Duxv/tje/de69/w7H8df+eL7q/9B3Y3/wBsb37r3Xv+HY/jr/zxfdX/AKDuxv8A7Y3v3Xuvf8Ox/HX/AJ4vur/0Hdjf/bG9+6917/h2P46/88X3V/6Duxv/ALY3v3Xuvf8ADsfx1/54vur/ANB3Y3/2xvfuvde/4dj+Ov8AzxfdX/oO7G/+2N7917r3/Dsfx1/54vur/wBB3Y3/ANsb37r3Xv8Ah2P46/8APF91f+g7sb/7Y3v3Xuvf8Ox/HX/ni+6v/Qd2N/8AbG9+6917/h2P46/88X3V/wCg7sb/AO2N7917r3/Dsfx1/wCeL7q/9B3Y3/2xvfuvdWfe/de697917r3v3Xuv/9Tf49+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3X//1d/j37r3XvfuvdMu4ty7c2hh6zcW7M/hNr7fx32/8Qzu4srQ4TD0P3dVBQ0v3mTyU9NRU33NbUxwx63XXLIqC7MAfde6C/8A2ZP46/8AP/elf/Rp7G/+vvv3Xuvf7Mn8df8An/vSv/o09jf/AF99+6917/Zk/jr/AM/96V/9Gnsb/wCvvv3Xuvf7Mn8df+f+9K/+jT2N/wDX337r3Xv9mT+Ov/P/AHpX/wBGnsb/AOvvv3Xuvf7Mn8df+f8AvSv/AKNPY3/199+6917/AGZP46/8/wDelf8A0aexv/r77917r3+zJ/HX/n/vSv8A6NPY3/199+6917/Zk/jr/wA/96V/9Gnsb/6++/de69/syfx1/wCf+9K/+jT2N/8AX337r3Xv9mT+Ov8Az/3pX/0aexv/AK++/de69/syfx1/5/70r/6NPY3/ANfffuvde/2ZP46/8/8Aelf/AEaexv8A6++/de69/syfx1/5/wC9K/8Ao09jf/X337r3Xv8AZk/jr/z/AN6V/wDRp7G/+vvv3Xuvf7Mn8df+f+9K/wDo09jf/X337r3Xv9mT+Ov/AD/3pX/0aexv/r77917r3+zJ/HX/AJ/70r/6NPY3/wBfffuvde/2ZP46/wDP/elf/Rp7G/8Ar77917r3+zJ/HX/n/vSv/o09jf8A199+6917/Zk/jr/z/wB6V/8ARp7G/wDr77917r3+zJ/HX/n/AL0r/wCjT2N/9fffuvde/wBmT+Ov/P8A3pX/ANGnsb/6++/de69/syfx1/5/70r/AOjT2N/9fffuvde/2ZP46/8AP/elf/Rp7G/+vvv3Xuvf7Mn8df8An/vSv/o09jf/AF99+690NXv3Xuve/de697917r//1t/j37r3XvfuvdIrsTrvZ3a+zsxsDf8Ah/4/tLP/AMP/AItif4hlMX93/C8pQ5qg/wAvwtdjsnB4MnjoZf2pk1aNLXQsp917osH/AA3f8O/+fQf+xA7R/wDs29+6917/AIbv+Hf/AD6D/wBiB2j/APZt7917r3/Dd/w7/wCfQf8AsQO0f/s29+6917/hu/4d/wDPoP8A2IHaP/2be/de69/w3f8ADv8A59B/7EDtH/7Nvfuvde/4bv8Ah3/z6D/2IHaP/wBm3v3Xuvf8N3/Dv/n0H/sQO0f/ALNvfuvde/4bv+Hf/PoP/Ygdo/8A2be/de69/wAN3/Dv/n0H/sQO0f8A7Nvfuvde/wCG7/h3/wA+g/8AYgdo/wD2be/de69/w3f8O/8An0H/ALEDtH/7Nvfuvde/4bv+Hf8Az6D/ANiB2j/9m3v3Xuvf8N3/AA7/AOfQf+xA7R/+zb37r3Xv+G7/AId/8+g/9iB2j/8AZt7917r3/Dd/w7/59B/7EDtH/wCzb37r3Xv+G7/h3/z6D/2IHaP/ANm3v3Xuvf8ADd/w7/59B/7EDtH/AOzb37r3Xv8Ahu/4d/8APoP/AGIHaP8A9m3v3Xuvf8N3/Dv/AJ9B/wCxA7R/+zb37r3Xv+G7/h3/AM+g/wDYgdo//Zt7917r3/Dd/wAO/wDn0H/sQO0f/s29+6917/hu/wCHf/PoP/Ygdo//AGbe/de69/w3f8O/+fQf+xA7R/8As29+6917/hu/4d/8+g/9iB2j/wDZt7917r3/AA3f8O/+fQf+xA7R/wDs29+6917/AIbv+Hf/AD6D/wBiB2j/APZt7917o6nv3Xuve/de697917r/19/j37r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvdf//Q3+Pfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691//9Hf49+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3X//0t/j37r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvde9+691737r3Xvfuvdf//Z'
                                                    },
                                                    {
                                                        xtype: 'textareafield',
                                                        action: 'insImage',
                                                        name: 'image',
                                                        hidden: true
                                                    }
                                                ],
                                                bbar: [
                                                    '-',
                                                    {
                                                        text: 'OCR',
                                                        itemId: 'PatientInsuranceFormScannerOcrBtn'
                                                    },
                                                    '-',
                                                    '->',
                                                    '-',
                                                    {
                                                        text: _('scan_image'),
                                                        itemId: 'PatientInsuranceFormScannerBtn'
                                                    },
                                                    '-'
                                                ]
                                            },  //Insurance Card Image and Notes Container
                                            {
                                                xtype: 'textareafield',
                                                fieldLabel: _('notes'),
                                                grow: false,
                                                height: 160,
                                                name: 'notes'
                                            },  //Notes


                                        ]

                                    }  //Insurance Information Card and Notes
                                ]
                            },
                            {
                                xtype: 'fieldset',
                                title: _('subscriber'),
                                cls: 'highlight_fieldset',
                                layout: {
                                    type: 'vbox'
                                },
                                width: 1100,
                                //height: 145,
                                margin: '0 5 0 5',
                                items: [
                                    {
                                        xtype: 'fieldcontainer',
                                        layout: {
                                            type: 'hbox',
                                            align: 'bottom'
                                        },
                                        defaults: {
                                            margin: '0 5 0 2'
                                        },
                                        items: [
                                            {
                                                xtype: 'gaiaehr.combo',
                                                name: 'subscriber_relationship',
                                                itemId: 'PatientInsuranceFormSubscribeRelationshipCmb',
                                                fieldLabel: _('relationship'),
                                                emptyText: _('relationship'),
                                                queryMode: 'local',
                                                listKey: 'relationship_ins',
                                                loadStore: true,
                                                editable: false,
                                                width: 100,
                                                allowBlank: false


                                            },
                                            {
                                                xtype: 'gaiaehr.combo',
                                                name: 'subscriber_title',
                                                fieldLabel: _('name'),
                                                emptyText: _('title'),
                                                queryMode: 'local',
                                                listKey: 'titles',
                                                width: 50,
                                                loadStore: true,
                                                editable: false
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_given_name',
                                                emptyText: _('first_name'),
                                                width: 120,
                                                allowBlank: false
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_middle_name',
                                                emptyText: _('middle_name'),
                                                width: 30
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_surname',
                                                emptyText: _('last_name'),
                                                flex: 2,
                                                allowBlank: false
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_ss',
                                                fieldLabel: _('ssn'),
                                                emptyText: _('ssn'),
                                                labelWidth: 90,
                                                width: 100
                                            },

                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_policy_number',
                                                emptyText: _('policy_number'),
                                                fieldLabel: _('id'),
                                                flex: 1
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_phone',
                                                emptyText: '000-000-0000',
                                                fieldLabel: _('phone'),
                                                plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                labelWidth: 40,
                                                width: 100
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_employer',
                                                emptyText: _('employer'),
                                                fieldLabel: _('employer'),
                                                labelWidth: 60,
                                                flex: 1
                                            }
                                        ]
                                    },  //Subscriber Relationship, Name //Subscriber Phone, SSN, Employer

                                    {
                                        xtype: 'fieldcontainer',
                                        layout: {
                                            type: 'hbox',
                                            align: 'bottom'
                                        },
                                        defaults: {
                                            margin: '5 5 0 2'
                                        },
                                        items: [
                                            {
                                                xtype: 'textfield',
                                                emptyText: _('street'),
                                                fieldLabel: _('street'),
                                                labelWidth: 40,
                                                width: 500,
                                                itemId: 'InsuranceSubscriberStreetField',
                                                name: 'subscriber_street'
                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_city',
                                                emptyText: _('city'),
                                                fieldLabel: _('city'),
                                                itemId: 'InsuranceSubscriberCityField',
                                                width: 120
                                            },
                                            {
                                                xtype: 'gaiaehr.combo',
                                                name: 'subscriber_state',
                                                emptyText: _('state'),
                                                queryMode: 'local',
                                                itemId: 'InsuranceSubscriberStatetField',
                                                listKey: 'state',
                                                width: 120,
                                                loadStore: true,
                                                editable: false

                                            },
                                            {
                                                xtype: 'textfield',
                                                name: 'subscriber_postal_code',
                                                emptyText: _('postal_code'),
                                                itemId: 'InsuranceSubscriberPostalField',
                                                width: 90
                                            },
                                            {
                                                xtype: 'gaiaehr.combo',
                                                name: 'subscriber_country',
                                                emptyText: _('country'),
                                                itemId: 'InsuranceSubscriberCountryField',
                                                queryMode: 'local',
                                                listKey: 'country',
                                                width: 100,
                                                loadStore: true,
                                                editable: false
                                            },
                                            {
                                                xtype: 'button',
                                                text: _('copy_from_patient'),
                                                itemId: 'InsuranceAddressSameAsPatientBtn',
                                            }
                                        ]
                                    }  //Subscriber Address (Street) //Subscriber Address (City, State, Zip, Country)
                                ]
                            }   //Subscriber Container

                        ]
                    }

                ]
            }
        ];


        me.callParent();
    }


});

Ext.define('App.view.patient.Patient', {
	extend: 'Ext.panel.Panel',
	requires: [
		'App.ux.AddTabButton',
		'App.ux.form.fields.InputTextMask',
		'App.view.patient.InsuranceForm',
	],

	layout: 'fit',
	xtype: 'patientdeomgraphics',
	itemId: 'PatientDemographicsPanel',

	newPatient: true,
	pid: null,

	defaultPatientImage: 'resources/images/patientPhotoPlaceholder.jpg',
	defaultQRCodeImage: 'resources/images/QRCodeImage.png',

	initComponent: function(){
		var me = this,
			configs,
			bodyWidth = Ext.getBody().getWidth();

		me.store = Ext.create('App.store.patient.Patient');
		me.patientAlertsStore = Ext.create('App.store.patient.MeaningfulUseAlert');
		// me.patientContacsStore = Ext.create('App.store.patient.PatientContacts', {
		// 	autoLoad: false
		// });

		me.compactDemographics = eval(g('compact_demographics'));

		if(bodyWidth < 1300){
			me.containersWidth = 720;
		}else{
			me.containersWidth = 1000;
		}


		configs = {
			items: [
				me.demoForm = Ext.widget('form', {
					action: 'demoFormPanel',
					itemId: 'PatientDemographicForm',
					border: false,
					padding: (me.compactDemographics ? 0 : 10),
					fieldDefaults: {
						labelAlign: 'right',
						msgTarget: 'side'
					},
					layout: 'fit',
					items: [
						{
							xtype: 'tabpanel',
							itemId: 'Demographics',
							border: false,
							defaults: {
								autoScroll: true
							},
							items: [
								{
									xtype: 'panel',
									title: _('patient_info'),
									layout: {
										type: 'column'
									},
									action: 'DemographicWhoFieldSet',
									border: false,
									bodyBorder: false,
									bodyPadding: 10,
									items: [
										{
											xtype: 'panel',
											action: 'patientImage',
											layout: 'vbox',
											style: 'float:right;',
											bodyPadding: 10,
											//height: 300,
											width:180,
											itemId: 'PatientSummaryImagesPanel',
											items: [
												{
													xtype: 'image',
													itemId: 'PatientSummaryPatientImage',
													imageAlign: 'center',
													width: 150,
													height: 120,
													margin: '0 5 10 5',
													src: me.defaultPatientImage
												},
												{
													xtype: 'textareafield',
													name: 'image',
													hidden: true
												},
												{
													xtype: 'image',
													itemId: 'PatientSummaryQrcodeImage',
													imageAlign: 'center',
													width: 150,
													height: 150,
													margin: '0 5 10 5',
													src: me.defaultQRCodeImage
												}
											],
											dockedItems: [
												{
													xtype: 'toolbar',
													dock: 'bottom',
													items: [
														{
															text: _('take_picture'),
															action: 'onWebCam',
															flex: 1
															//handler: me.getPhotoIdWindow
														},
														'-',
														{
															text: _('print_qrcode'),
															flex: 1,
															itemId: 'PatientSummaryQrcodeImagePrintBtn'
														}
													]
												}
											]
										},
										{
											xtype: 'fieldcontainer',
											layout: 'vbox',
											items: [
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													layout: 'hbox',
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													items:[
														{
															xtype: 'textfield',
															name: 'pubpid',
															fieldLabel: _('medical'), //external_record
															flex: 1,
															enableKeyEvents: true
														},
														{
															xtype: 'textfield',
															name: 'pubaccount',
															fieldLabel: _('account'), //external_account
															flex: 1,
															enableKeyEvents: true
														},
														{
															xtype: 'textfield',
															name: 'interface_number',
															fieldLabel: _('interface_number'), //external_account
															flex: 1,
															enableKeyEvents: true
														}
													]
												},      //MRN ACCNT INTERFACE
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													layout: {
														type: 'vbox',
														align: 'stretch'
													},
													items:[
														{
															xtype: 'fieldcontainer',
															layout: 'hbox',
															defaults: {
																margin: '0 5 0 0',
																labelWidth: 50,
																labelAlign: 'top'
															},
															items: [
																{
																	xtype: 'gaiaehr.combo',
																	name: 'title',
																	fieldLabel: _('title'),
																	width: 75,
																	listKey: 'titles',
																	loadStore: true,
																	editable: false
																},
																{
																	xtype: 'textfield',
																	name: 'fname',
																	fieldLabel: _('first_name'),
																	flex: 1,
																	allowBlank: false,
																	maxLength: 20
																},
																{
																	xtype: 'textfield',
																	name: 'mname',
																	fieldLabel: _('init'),
																	width: 50,
																	enableKeyEvents: true,
																	maxLength: 20
																},
																{
																	xtype: 'textfield',
																	name: 'lname',
																	fieldLabel: _('last_name'),
																	flex: 2,
																	allowBlank: false,
																	maxLength: 40
																},
																{
																	xtype: 'textfield',
																	name: 'suffix',
																	fieldLabel: _('suffix'),
																	width: 50,
																	maxLength: 35
																},
																{
																	xtype: 'gaiaehr.combo',
																	name: 'marital_status',
																	fieldLabel: _('marital_status'),
																	flex: 1,
																	listKey: 'marital_stat',
																	loadStore: true,
																	editable: false
																}
															]
														},
														{
															xtype: 'fieldcontainer',
															layout: 'hbox',
															labelWidth: 50,
															defaults: {
																margin: '0 5 0 0',
																labelWidth: 50,
																labelAlign: 'top'
															},
															items: [
																{
																	xtype: 'gaiaehr.combo',
																	name: 'sex',
																	fieldLabel: _('sex_at_birth'),
																	flex: 1,
																	enableKeyEvents: true,
																	allowBlank: false,
																	listKey: 'sex',
																	loadStore: true,
																	editable: false
																},
																{
																	xtype: 'gaiaehr.combo',
																	name: 'identity',
																	fieldLabel: _('identity'),
																	flex: 2,
																	listKey: 'identity',
																	loadStore: true,
																	editable: false
																},
																{
																	xtype: 'gaiaehr.combo',
																	name: 'orientation',
																	fieldLabel: _('orientation'),
																	flex: 2,
																	listKey: 'orientation',
																	loadStore: true,
																	editable: false
																}
															]
														}
													]
												},      //Name, Sex, Marital Status
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													layout: 'hbox',
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													items:[
														{
															xtype: 'mitos.datetime',
															name: 'DOB',
															format: 'm/d/Y',
															width: 230,
															fieldLabel: _('dob'),
															enableKeyEvents: true,
															allowBlank: false
														},
														{
															xtype:'fieldcontainer',
															layout: 'hbox',
															fieldLabel:_('multiple_birth'),
															items: [
																{
																	xtype: 'combobox',
																	name: 'birth_multiple',
																	editable: false,
																	width: 50,
																	store: [
																		[null, '-'],
																		[true, 'Yes'],
																		[false,  'No']
																	]
																},
																{
																	xtype: 'box',
																	margin: '5 5 5 5',
																	html: ' birth order'
																},
																{
																	xtype: 'numberfield',
																	name: 'birth_order',
																	width: 50,
																	value: 1,
																	maxValue: 15,
																	minValue: 1
																}
															]
														},
														{
															xtype: 'textfield',
															name: 'birth_place',
															fieldLabel: _('birth_place'),
															flex: 1
														}
													]
												},      //DOB, Multiple, Order, Place
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													height: 125,
													layout: {
														type: 'hbox',
														align: 'stretch'
													},
													defaults: {
														labelAlign: 'top',
														flex: 1
													},
													items: [
														{
															xtype: 'fieldcontainer',
															fieldLabel: _('postal_address'),
															margin: '0 5 0 0',
															layout: 'anchor',
															items: [
																{
																	xtype: 'textfield',
																	anchor: '100%',
																	emptyText: _('street'),
																	name: 'postal_address'
																},
																{
																	xtype: 'textfield',
																	anchor: '100%',
																	emptyText: '(' + _('optional') + ')',
																	name: 'postal_address_cont'
																},
																{
																	xtype: 'fieldcontainer',
																	anchor: '100%',
																	layout: 'hbox',
																	defaults: {
																		margin: '0 5 0 0'
																	},
																	items: [
																		{
																			xtype: 'textfield',
																			emptyText: _('city'),
																			width: 119,
																			name: 'postal_city'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('state'),
																			width: 30,
																			name: 'postal_state'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('zip'),
																			width: 80,
																			name: 'postal_zip'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('country'),
																			flex: 1,
																			name: 'postal_country',
																			margin: 0
																		}
																	]
																}
															]
														},
														{
															xtype: 'button',
															itemId: 'DemographicAddressCopyBtn',
															text: '>',
															width: 20,
															flex: null,
															margin: '18 0 4 0',
															tooltip: _('copy_postal_to_physical_address')
														},
														{
															xtype: 'fieldcontainer',
															fieldLabel: _('physical_address'),
															margin: '0 0 0 5',
															layout: 'anchor',
															items: [
																{
																	xtype: 'textfield',
																	emptyText: _('street'),
																	anchor: '100%',
																	name: 'physical_address'
																},
																{
																	xtype: 'textfield',
																	emptyText: '(' + _('optional') + ')',
																	anchor: '100%',
																	name: 'physical_address_cont'
																},
																{
																	xtype: 'container',
																	layout: 'hbox',
																	anchor: '100%',
																	defaults: {
																		margin: '0 5 0 0'
																	},
																	items: [
																		{
																			xtype: 'textfield',
																			emptyText: _('city'),
																			width: 119,
																			name: 'physical_city'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('state'),
																			width: 30,
																			name: 'physical_state'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('zip'),
																			width: 80,
																			name: 'physical_zip'
																		},
																		{
																			xtype: 'textfield',
																			emptyText: _('country'),
																			flex: 1,
																			name: 'physical_country',
																			margin: 0
																		}
																	]
																}
															]
														}
													]
												},      //Postal and Physical Address
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													layout: 'hbox',
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													items: [
														{
															xtype: 'textfield',
															name: 'phone_home',
															emptyText: '000-000-0000',
															fieldLabel: _('home'),
															allowBlank: g('require_patient_home_phone') === "0",
															plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
															flex: 1
														},
														{
															xtype: 'textfield',
															name: 'phone_mobile',
															emptyText: '000-000-0000',
															allowBlank: g('require_patient_mobile_phone') === "0",
															fieldLabel:_('mobile'),
															plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
															flex: 1
														},
														{
															xtype: 'gaiaehr.combo',
															name: 'phone_mobile_supplier',
															emptyText: _('supplier'),
															fieldLabel: _('supplier'),
															flex: 1,
															listKey: 'cellular_prov',
															loadStore: true,
															editable: false
														},
														{
															xtype: 'textfield',
															name: 'email',
															emptyText: 'example@email.com',
															allowBlank: g('require_patient_email') === "0",
															fieldLabel:_('email'),
															flex: 2
														}

													]
												},      //Phones, Emails ....
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													layout: 'hbox',
													width: me.containersWidth,
													defaults: {
														margin: '0 5 0 0'
													},
													items: [
														{
															xtype: 'container',
															layout: {
																type: 'vbox',
																align: 'stretch'
															},
															flex: 1,
															items: [
																{
																	xtype: 'racecombo',
																	name: 'race',
																	fieldLabel: _('race'),
																	labelAlign: 'top',
																	flex: 1
																},
																{
																	xtype: 'racecombo',
																	name: 'secondary_race',
																	fieldLabel: _('secondary_race'),
																	labelAlign: 'top',
																	flex: 1
																}
															]
														},
														{
															xtype: 'container',
															layout: {
																type: 'vbox',
																align: 'stretch'
															},
															flex: 1,
															items: [
																{
																	xtype: 'ethnicitycombo',
																	name: 'ethnicity',
																	fieldLabel: _('ethnicity'),
																	labelAlign: 'top',
																},
																{
																	xtype: 'ethnicitycombo',
																	name: 'secondary_ethnicity',
																	fieldLabel: _('secondary_ethnicity'),
																	labelAlign: 'top',
																},
															]
														},
														{
															xtype: 'container',
															layout: {
																type: 'vbox',
																align: 'stretch'
															},
															flex: 1,
															items: [
																{
																	xtype: 'gaiaehr.combo',
																	name: 'language',
																	fieldLabel: _('language'),
																	labelAlign: 'top',
																	listKey: 'lang',
																	loadStore: true,
																	editable: false
																},
																{
																	xtype: 'gaiaehr.combo',
																	name: 'religion',
																	fieldLabel: _('religion'),
																	labelAlign: 'top',
																	flex: 1,
																	listKey: 'religion',
																	loadStore: true,
																	editable: false
																}
															]
														}
													]
												},      //Race, Ethnicity, Language, Religion...
												{
													xtype: 'fieldset',
													cls: 'highlight_fieldset',
													margin: '5 0 5 0',
													padding: '15 10 10 10',
													width: me.containersWidth,
													layout: 'hbox',
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													items: [
														{
															xtype: 'activefacilitiescombo',
															name: 'primary_facility',
															flex: 1,
															fieldLabel: _('facility'),
															queryMode: 'local',
															forceSelection: true
														},
														{
                                                            xtype: 'datefield',
                                                            name: 'first_visit_date',
                                                            format: 'm/d/Y',
                                                            width: 130,
                                                            fieldLabel: _('first_visit')
														}
													]
												}       //Facility y Provider
											]
										}
									]
								}, //Demographics
                                {
                                    xtype: 'panel',
                                    title: _('contacts'),
                                    itemId: 'DemographicsContactFieldSet',
                                    border: false,
                                    bodyBorder: false,
                                    bodyPadding: 10,
                                    layout: {
                                        type: 'vbox',
                                        align: 'stretch'
                                    },
                                    defaults: {
                                        margin: '0 5 0 0',
                                        labelAlign: 'top'
                                    },
                                    items: [
                                        {
                                            xtype: 'fieldset',
                                            cls: 'highlight_fieldset',
                                            margin: '5 250 5 0',
                                            padding: '15 10 10 10',
                                            width: me.containersWidth,
                                            layout: {
                                                type: 'vbox',
                                                align: 'stretch'
                                            },
                                            items:[
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth,
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 0 5 5',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'father_fname',
                                                            fieldLabel: _('first_name') + ' (' + _('father') + ')',
                                                            flex: 1,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'father_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'father_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            maxLength: 40
                                                        }

                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth,
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 0 5 5',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'mother_fname',
                                                            fieldLabel: _('first_name') + ' (' + _('mother') + ')',
                                                            flex: 1,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'mother_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'mother_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            maxLength: 40
                                                        }

                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth,
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 0 5 5',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'spouse_fname',
                                                            fieldLabel: _('first_name') + ' (' + _('spouse') + ')',
                                                            flex: 1,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'spouse_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            maxLength: 20
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'spouse_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            maxLength: 40
                                                        }

                                                    ]
                                                }
                                            ]
                                        }, //Father and Mother
                                        {
                                            xtype: 'fieldset',
                                            title: _('employer'),
                                            cls: 'highlight_fieldset',
                                            margin: '5 250 5 0',
                                            padding: '15 10 10 10',
                                            width: me.containersWidth,
                                            layout: 'hbox',
                                            defaults: {
                                                margin: '0 5 0 0',
                                                labelAlign: 'top'
                                            },
                                            items: [
                                                {
                                                    xtype: 'textfield',
                                                    name: 'employer_name',
                                                    fieldLabel: _('employer_name'),
                                                    flex: 2
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    name: 'occupation',
                                                    fieldLabel: _('occupation'),
                                                    flex: 1
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    name: 'phone_work',
                                                    fieldLabel: _('phone'),
                                                    emptyText: '000-000-0000',
	                                                plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                    width: 100
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    name: 'phone_work_ext',
                                                    width: 105,
                                                    labelWidth: 30,
                                                    fieldLabel: _('ext') + '.'
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    name: 'phone_fax',
                                                    fieldLabel: _('fax'),
                                                    emptyText: '000-000-0000',
	                                                plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                    width: 160,
                                                    labelWidth: 30
                                                }
                                            ]
                                        }, //Employer
                                        {
                                            xtype: 'fieldset',
                                            title: _('persons_authorized'),
                                            cls: 'highlight_fieldset',
                                            margin: '5 250 5 0',
                                            padding: '15 10 10 10',
                                            layout: {
                                                type: 'vbox',
                                                align: 'stretch'
                                            },
                                            defaults: {
                                                margin: '0 5 0 0',
                                                labelAlign: 'top'
                                            },
                                            items:[
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth,
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_01_relation',
                                                            fieldLabel: _('relationship'),
                                                            width: 125,
                                                            listKey: 'rela_hl70063',
                                                            loadStore: true,
                                                            editable: false
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_01_fname',
                                                            fieldLabel: _('first_name'),
                                                            flex: 1,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_01_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_01_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_01_phone',
                                                            fieldLabel: _('phone'),
                                                            emptyText: '000-000-0000',
	                                                        plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                            width: 115
                                                        },
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_01_phone_type',
                                                            fieldLabel: _('phone_type'),
                                                            width: 120,
                                                            listKey: 'phone_type',
                                                            loadStore: true,
                                                            editable: false
                                                        }
                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_02_relation',
                                                            fieldLabel: _('relationship'),
                                                            width: 125,
                                                            listKey: 'rela_hl70063',
                                                            loadStore: true,
                                                            editable: false
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_02_fname',
                                                            fieldLabel: _('first_name'),
                                                            flex: 1,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_02_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_02_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_02_phone',
                                                            fieldLabel: _('phone'),
                                                            emptyText: '000-000-0000',
	                                                        plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                            width: 115
                                                        },
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_02_phone_type',
                                                            fieldLabel: _('phone_type'),
                                                            width: 120,
                                                            listKey: 'phone_type',
                                                            loadStore: true,
                                                            editable: false
                                                        }
                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    defaults: {
                                                        labelWidth: 50,
                                                        margin: '5 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_03_relation',
                                                            fieldLabel: _('relationship'),
                                                            width: 125,
                                                            listKey: 'rela_hl70063',
                                                            loadStore: true,
                                                            editable: false
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_03_fname',
                                                            fieldLabel: _('first_name'),
                                                            flex: 1,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_03_mname',
                                                            fieldLabel: _('init'),
                                                            width: 50,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_03_lname',
                                                            fieldLabel: _('last_name'),
                                                            flex: 2,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'authorized_03_phone',
                                                            fieldLabel: _('phone'),
                                                            emptyText: '000-000-0000',
	                                                        plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                            width: 115
                                                        },
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'authorized_03_phone_type',
                                                            fieldLabel: _('phone_type'),
                                                            width: 120,
                                                            listKey: 'phone_type',
                                                            loadStore: true,
                                                            editable: false
                                                        }
                                                    ]
                                                } //Persons Authorized to Pickup Results
                                            ]
                                        },
                                        {
                                            xtype: 'fieldset',
                                            title: _('emer_contact'),
                                            cls: 'highlight_fieldset',
                                            margin: '5 250 5 0',
                                            padding: '15 10 10 10',
                                            layout: {
                                                type: 'vbox',
                                                align: 'stretch'
                                            },
                                            defaults: {
                                                margin: '0 5 0 0',
                                                labelAlign: 'top'
                                            },
                                            items: [
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth - 10,
                                                    defaults: {
                                                        margin: '0 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'emergency_contact_relation',
                                                            emptyText: _('relationship'),
                                                            width: 125,
                                                            listKey: 'rela_hl70063',
                                                            loadStore: true,
                                                            editable: false
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_fname',
                                                            emptyText: _('first_name'),
                                                            flex: 1,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_mname',
                                                            emptyText: _('middle_name'),
                                                            width: 50,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_lname',
                                                            emptyText: _('last_name'),
                                                            flex: 2,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_phone',
                                                            emptyText: '000-000-0000',
	                                                        plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                            width: 115
                                                        },
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'emergency_contact_phone_type',
                                                            emptyText: _('phone_type'),
                                                            width: 120,
                                                            listKey: 'phone_type',
                                                            loadStore: true,
                                                            editable: false
                                                        }
                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth - 10,
                                                    defaults: {
                                                        margin: '5 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_address',
                                                            emptyText: _('street'),
                                                            flex: 2
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_address_cont',
                                                            emptyText: '(' + _('optional') + ')',
                                                            flex: 2
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_city',
                                                            emptyText: _('city'),
                                                            flex: 1
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_state',
                                                            emptyText: _('state'),
                                                            width: 30
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_zip',
                                                            emptyText: _('zip'),
                                                            width: 80
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'emergency_contact_country',
                                                            emptyText: _('country'),
                                                            width: 120
                                                        }
                                                    ]
                                                }
                                            ]
                                        }, //Emergency
                                        {
                                            xtype: 'fieldset',
                                            title: _('guardians_contact'),
                                            cls: 'highlight_fieldset',
                                            margin: '5 250 5 0',
                                            padding: '15 10 10 10',
                                            layout: {
                                                type: 'vbox',
                                                align: 'stretch'
                                            },
                                            defaults: {
                                                margin: '0 5 0 0',
                                                labelAlign: 'top'
                                            },
                                            items: [
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth - 10,
                                                    defaults: {
                                                        margin: '0 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'guardians_relation',
                                                            emptyText: _('relationship'),
                                                            width: 125,
                                                            listKey: 'rela_hl70063',
                                                            loadStore: true,
                                                            editable: false
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_fname',
                                                            emptyText: _('first_name'),
                                                            flex: 1,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_mname',
                                                            emptyText: _('middle_name'),
                                                            width: 50,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_lname',
                                                            emptyText: _('last_name'),
                                                            flex: 2,
                                                            enableKeyEvents: true
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_phone',
                                                            emptyText: '000-000-0000',
	                                                        plugins: [Ext.create('App.ux.form.fields.InputTextMask', '999-999-9999')],
                                                            width: 115
                                                        },
                                                        {
                                                            xtype: 'gaiaehr.combo',
                                                            name: 'guardians_phone_type',
                                                            emptyText: _('phone_type'),
                                                            width: 120,
                                                            listKey: 'phone_type',
                                                            loadStore: true,
                                                            editable: false
                                                        }
                                                    ]
                                                },
                                                {
                                                    xtype: 'fieldcontainer',
                                                    layout: 'hbox',
                                                    width: me.containersWidth - 10,
                                                    defaults: {
                                                        margin: '5 5 0 0',
                                                        labelAlign: 'top'
                                                    },
                                                    items: [
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_address',
                                                            emptyText: _('street'),
                                                            flex: 2
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_address_cont',
                                                            emptyText: '(' + _('optional') + ')',
                                                            flex: 2
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_city',
                                                            emptyText: _('city'),
                                                            flex: 1
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_state',
                                                            emptyText: _('state'),
                                                            width: 30
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_zip',
                                                            emptyText: _('zip'),
                                                            width: 80
                                                        },
                                                        {
                                                            xtype: 'textfield',
                                                            name: 'guardians_country',
                                                            emptyText: _('country'),
                                                            width: 120
                                                        }
                                                    ]
                                                }
                                            ]
                                        }  //Guardian
                                    ]
                                }, //Contacts
								{
									xtype: 'panel',
									title: _('communication'),
									action: 'DemographicWhoFieldSet',
                                    margin: '5 250 5 0',
                                    border: false,
                                    bodyBorder: false,
                                    bodyPadding: 10,
                                    layout: {
                                        type: 'vbox',
                                        align: 'stretch'
                                    },
                                    defaults: {
                                        margin: '0 5 0 0',
                                        labelAlign: 'top'
                                    },
									items: [
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
                                            layout: 'hbox',
                                            margin: '5 0 5 0',
                                            padding: '15 10 10 10',
                                            width: me.containersWidth,
                                            defaults: {
                                                margin: '0 5 0 0',
                                                labelAlign: 'top'
                                            },
											items: [
												{
													xtype: 'gaiaehr.combo',
													name: 'phone_publicity',
													fieldLabel: _('publicity'),
													emptyText: _('publicity'),
													width: 450,
													listKey: 'publicity_code',
													loadStore: true,
													editable: false,
													margin: '10 5 5 0'
												},
												{
													xtype: 'datefield',
													fieldLabel: _('effective_date'),
													name: 'phone_publicity_date',
													margin: '10 0 5 0'
												}
											]
										}, //Publicity
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'mitos.pharmaciescombo',
													name: 'pharmacy',
													fieldLabel: _('pharmacy'),
													emptyText: _('pharmacy'),
													width: 450,
													margin: '10 0 5 0',
													forceSelection: true
												}
											]
										}, //Pharmacy
										{
											xtype: 'fieldset',
											title: _('allow'),
											fieldLabel:'allow',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'checkbox',
													name: 'allow_sms',
													flex: 1,
													boxLabel: _('text_mobile_msg'),
													margin: '5 0 0 15',
													labelWidth: 100
												},
												{
													xtype: 'checkbox',
													name: 'allow_voice_msg',
													boxLabel: _('voice_msg'),
													flex: 1,
													labelWidth: 95
												},
												{
													xtype: 'checkbox',
													name: 'allow_email',
													boxLabel: _('email'),
													flex: 1,
													labelWidth: 70
												},
												{
													xtype: 'checkbox',
													name: 'allow_mail_msg',
													boxLabel: _('mail_msg'),
													flex: 1,
													labelWidth: 85
												}
											]
										}, //Allow Phones, Allow Emails
										{
											xtype: 'fieldset',
											title: _('allow'),
											fieldLabel:'allow',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'fieldset',
													checkboxName: 'allow_patient_web_portal',
													title: _('patient_access_web_portal'),
													checkboxToggle: true,
													width: 225,
													margin: '5 0 5 0',
													items: [
														{
															xtype: 'textfield',
															name: 'portal_username',
															fieldLabel: _('username'),
															width: 200,
															labelWidth: 60
														},
														{
															xtype: 'textfield',
															name: 'portal_password',
															fieldLabel: _('password'),
															inputType: 'password',
															width: 200,
															labelWidth: 60
														}
													]
												}, //Access Patient Web Portal
												{
													xtype: 'fieldset',
													title: _('emergency_access_web_portal'),
													checkboxName: 'allow_emergency_contact_web_portal',
													checkboxToggle: true,
													width: 225,
													margin: '5 0 5 10',
													items: [
														{
															xtype: 'textfield',
															name: 'emergency_contact_portal_username',
															fieldLabel: _('username'),
															width: 200,
															labelWidth: 70
														},
														{
															xtype: 'textfield',
															name: 'emergency_contact_portal_password',
															fieldLabel: _('password'),
															inputType: 'password',
															width: 200,
															labelWidth: 70
														},
														{
															xtype: 'checkbox',
															fieldLabel: _('view_record'),
															name: 'allow_emergency_contact_web_portal_cda',
															labelWidth: 70
														}
													]
												}, //Access Emergency Web Portal
												{
													xtype: 'fieldset',
													title: _('guardian_access_web_portal'),
													checkboxName: 'allow_guardian_web_portal',
													checkboxToggle: true,
													collapsible: false,
													width: 225,
													margin: '5 0 5 10',
													items: [
														{
															xtype: 'textfield',
															name: 'guardian_portal_username',
															fieldLabel: _('username'),
															width: 200,
															labelWidth: 70
														},
														{
															xtype: 'textfield',
															name: 'guardian_portal_password',
															fieldLabel: _('password'),
															inputType: 'password',
															width: 200,
															labelWidth: 70
														},
														{
															xtype: 'checkbox',
															fieldLabel: _('view_record'),
															name: 'allow_guardian_web_portal_cda',
															labelWidth: 70
														}
													]
												}  //Guardian Web Portal
											]
										}, //Allow Web Access - Portal
										{
											xtype: 'fieldset',
											title: _('allow'),
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'checkbox',
													name: 'allow_immunization_info_sharing',
													boxLabel: _('immunization_info_sharing'),
													width: 225,
													margin: '0 5 0 15'
												},
												{
													xtype: 'checkbox',
													name: 'allow_immunization_registry',
													boxLabel: _('immunization_registry_use'),
													width: 225,
													margin: '0 5 0 5'
												},
												{
													xtype: 'checkbox',
													name: 'allow_health_info_exchange',
													boxLabel: _('health_information_exchange'),
													width: 225,
													margin: '0 5 0 5'
												}
											]
										} //Allow Immunization Sharing, Registry, HIE
									]
								}, //Communication
								{
									xtype: 'panel',
									title: _('aditional_info')+'.',
									action: 'DemographicWhoFieldSet',
                                    margin: '5 250 5 0',
                                    border: false,
                                    bodyBorder: false,
                                    bodyPadding: 10,
                                    layout: {
                                        type: 'vbox',
                                        align: 'stretch'
                                    },
                                    defaults: {
                                        margin: '0 5 0 0',
                                        labelAlign: 'top'
                                    },
									items: [
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'textfield',
													name: 'birth_fname',
													fieldLabel: _('birth_first_name'),
													flex: 1,
													maxLength: 35
												},
												{
													xtype: 'textfield',
													name: 'birth_mname',
													fieldLabel: _('birth_init'),
													width: 75,
													enableKeyEvents: true,
													maxLength: 35
												},
												{
													xtype: 'textfield',
													name: 'birth_lname',
													fieldLabel: _('birth_last_name'),
													flex: 2,
													maxLength: 35
												},
												{
													xtype: 'textfield',
													name: 'alias',
													fieldLabel: _('alias_name'),
													flex: 1,
													labelWidth: 100,
													hideLabel: false
												},
												{
													xtype: 'gaiaehr.combo',
													name: 'citizenship',
													fieldLabel: _('citizenship'),
													hideLabel: false,
													flex: 1,
													labelWidth: 60,
													listKey: 'citiz',
													loadStore: true,
													editable: false
												},
												{
													xtype: 'gaiaehr.combo',
													fieldLabel: _('veteran'),
													boxLabel: 'Yes',
													name: 'is_veteran',
													flex: 1,
													loadStore: true,
													editable: false
												}
											]
										}, //Alias Name, Citizen, Veteran
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'textfield',
													fieldLabel: _('social_security'),
													emptyText: _('social_security'),
													name: 'SS',
													flex: 1
												},
												{
													xtype: 'textfield',
													emptyText: _('license_no'),
													fieldLabel: _('drivers_info'),
													enableKeyEvents: true,
													flex: 1,
													name: 'drivers_license'
												},
												{
													xtype: 'gaiaehr.combo',
													name: 'drivers_license_state',
													emptyText: _('license'),
													fieldLabel: _('state'),
													flex: 1,
													listKey: 'state',
													loadStore: true,
													editable: false
												},
												{
													xtype: 'datefield',
													name: 'drivers_license_exp',
													fieldLabel: _('expiration'),
													emptyText: _('license'),
													flex: 1,
													format: 'Y-m-d'
												}
											]
										}, //SocSec, Drivers Info
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'combobox',
													name: 'deceased',
													fieldLabel: _('deceased'),
													editable: false,
													width: 100,
													store: [
														['', ' -'],
														['1', 'Yes'],
														['0',  'No']
													]
												},
												{
													xtype: 'mitos.datetime',
													name: 'death_date',
													fieldLabel: _('death_date'),
													hideLabel: false,
													width: 200
												},
												{
													xtype: 'textfield',
													name: 'death_cause',
													fieldLabel: _('cause'),
													flex: 1
												}
											]
										}, //Deceased and Date
										{
											xtype: 'fieldset',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '15 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'gaiaehr.combo',
													fieldLabel: _('hipaa_notice'),
													name: 'hipaa_notice',
													flex: 1,
													listKey: 'boolean',
													loadStore: true,
													editable: false
												},
												{
													xtype: 'gaiaehr.combo',
													name: 'organ_donor_code',
													fieldLabel: _('organ_donor'),
													listKey: 'organ_donor',
													flex: 1,
													loadStore: true,
													editable: false
												}
											]
										}, //Hipaa Notice, Organ Donor
										{
											xtype: 'fieldset',
											title: 'PBM (Pharmacy Benefit Management)',
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '5 10 10 10',
											width: me.containersWidth,
											layout: 'hbox',
											items: [
												{
													xtype: 'container',
													flex: 1,
													layout: {
														type: 'vbox',
														align: 'stretch'
													},
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													items: [
														{
															xtype: 'fieldcontainer',
															layout: {
																type: 'hbox',
																align: 'stretch'
															},
															fieldLabel: _('card_name'),
															items: [
																{
																	xtype: 'textfield',
																	emptyText: _('last_name'),
																	name: 'pbm_card_lname',
																	flex: 1,
																	margin: '0 5 0 0'
																},
																{
																	xtype: 'textfield',
																	fieldLabel: ',',
																	labelSeparator: '',
																	labelWidth: 3,
																	emptyText: _('first_name'),
																	name: 'pbm_card_fname',
																	flex: 1
																}
															]
														},
														{
															xtype: 'textfield',
															fieldLabel: _('member_id'),
															name: 'pbm_member_id',
														}
													]
												},
												{
													xtype: 'container',
													flex: 1,
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top',
														fex: 1
													},
													layout: {
														type: 'vbox',
														align: 'stretch'
													},
													items: [
														{
															xtype: 'textfield',
															fieldLabel: _('group'),
															name: 'pbm_group',
														},
														{
															xtype: 'textfield',
															fieldLabel: _('bin'),
															name: 'pbm_bin',
														},
														{
															xtype: 'textfield',
															fieldLabel: _('pcn'),
															name: 'pbm_pcn',
														}
													]
												},
												{
													xtype: 'container',
													flex: 1,
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													layout: {
														type: 'vbox',
														align: 'stretch'
													},
													items: [
														{
															xtype: 'textfield',
															fieldLabel: _('payer_id'),
															name: 'pbm_payer_id',
														},
														{
															xtype: 'textfield',
															fieldLabel: _('payer_name'),
															name: 'pbm_payer_name',
														}
													]
												},
												{
													xtype: 'textfield',
													fieldLabel: _('consent'),
													name: 'pbm_consent',
													margin: '0 5 0 0',
													labelAlign: 'top',
												}
											]
										}, //PBM Info
										{
											xtype: 'fieldset',
											title: _('immunization_registry_information'),
											cls: 'highlight_fieldset',
											margin: '5 0 5 0',
											padding: '5 10 10 10',
											width: me.containersWidth,
											layout: {
												type: 'vbox',
												align: 'stretch'
											},
											defaults: {
												margin: '0 5 0 0',
												labelAlign: 'top'
											},
											items: [
												{
													xtype: 'container',
													flex: 1,
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													layout: {
														type: 'hbox',
														align: 'stretch'
													},
													items: [
														{
															xtype: 'gaiaehr.combo',
															fieldLabel: _('status'),
															name: 'immunization_registry_status',
															listKey: 'immu_registry_status',
															width: 320
														},
														{
															xtype: 'datefield',
															fieldLabel: _('effective_date'),
															name: 'immunization_registry_status_date',
															margin: '0 10 0 0'
														}
													]
												},
												{
													xtype: 'container',
													flex: 1,
													defaults: {
														margin: '0 5 0 0',
														labelAlign: 'top'
													},
													layout: {
														type: 'hbox',
														align: 'bottom'
													},
													items: [
														{
															xtype: 'combobox',
															fieldLabel: _('protection_indicator'),
															boxLabel: _('enabled'),
															name: 'protection_indicator',
															width: 320,
															editable: false,
															store: [[true, 'Yes'], [false, 'No']]
														},
														{
															xtype: 'datefield',
															fieldLabel: _('effective_date'),
															name: 'protection_indicator_date',
															margin: '0 10 0 0'
														}
													]
												},
											]
										} //Immunization Status
									]
								}  //Additional Info
							]
						}
					]
				}),
			]
		};

		configs.dockedItems = [{
			xtype: 'toolbar',
			dock: 'bottom',
			itemId: 'PatientDemographicsBottomBar',
			items: [
				{
					xtype: 'button',
					action: 'readOnly',
					text: _('possible_duplicates'),
					minWidth: 75,
					itemId: 'PatientPossibleDuplicatesBtn'
				},
				'-',
				{
					xtype: 'button',
					action: 'readOnly',
					text: _('merge_record'),
					minWidth: 75,
					acl: a('allow_merge_patients'),
					itemId: 'PatientMergeBtn'
				},
				'-',
				{
					xtype: 'button',
					action: 'readOnly',
					text: _('ccda_import'),
					minWidth: 75,
					//acl: a('allow_merge_patients'),
					itemId: 'PatientCdaImportBtn'
				},
				'-',
				'->',
				'-',
				{
					xtype: 'button',
					action: 'readOnly',
					text: _('save'),
					itemId: 'PatientDemographicSaveBtn',
					minWidth: 75,
					disableOnCLick: true,
					scope: me,
					handler: me.formSave
				},
				'-',
				{
					xtype: 'button',
					text: _('cancel'),
					action: 'readOnly',
					itemId: 'PatientDemographicCancelBtn',
					minWidth: 75,
					scope: me,
					handler: me.formCancel
				}
			]
		}];

		configs.listeners = {
			scope: me,
			beforerender: me.beforePanelRender
		};

		Ext.apply(me, configs);

		me.callParent(arguments);

		// Ext.Function.defer(function(){
		//
		// 	me.insTabPanel = Ext.widget('tabpanel', {
		// 		itemId: 'PatientInsurancesPanel',
		// 		flex: 1,
		// 		defaults: {
		// 			autoScroll: true,
		// 			padding: 10
		// 		},
		// 		plugins: [
		// 			{
		// 				ptype: 'AddTabButton',
		// 				iconCls: 'icoAdd',
		// 				toolTip: _('new_insurance'),
		// 				btnText: _('add_insurance'),
		// 				forceText: true,
		// 				panelConfig: {
		// 					xtype: 'patientinsuranceform'
		// 				}
		// 			}
		// 		],
		// 		listeners: {
		// 			scope: me,
		// 			beforeadd: me.insurancePanelAdd
		// 		}
		// 	});
		//
		// 	me.insTabPanel.title = _('insurance');
		// 	me.insTabPanel.addDocked({
		// 		xtype: 'toolbar',
		// 		dock: 'bottom',
		// 		items: [
		// 			'->',
		// 			'-',
		// 			{
		// 				xtype: 'button',
		// 				action: 'readOnly',
		// 				text: _('save'),
		// 				minWidth: 75,
		// 				scope: me,
		// 				handler: me.formSave
		// 			},
		// 			'-',
		// 			{
		// 				xtype: 'button',
		// 				text: _('cancel'),
		// 				action: 'readOnly',
		// 				minWidth: 75,
		// 				scope: me,
		// 				handler: me.formCancel
		// 			}
		// 		]
		// 	});
		//
		// 	me.up('tabpanel').insert(1, me.insTabPanel);
		// }, 300);
	},

	beforePanelRender: function(){
		var me = this,
			whoPanel,
			form = me.demoForm.getForm(),
			fname = form.findField('fname'),
			mname = form.findField('mname'),
			lname = form.findField('lname'),
			sex = form.findField('sex'),
			dob = form.findField('DOB'),
			crtl;

		if(fname) fname.vtype = 'nonspecialcharacters';
		if(mname) mname.vtype = 'nonspecialcharacters';
		if(lname) lname.vtype = 'nonspecialcharacters';

		if(dob) dob.setMaxValue(new Date());

	},

	// onAddNewContact: function(btn){
	// 	var grid = btn.up('grid'),
	// 		store = grid.store,
	// 		record;
	//
	// 	record = {
	// 		created_date: new Date(),
	// 		pid: app.patient.pid,
	// 		uid: app.user.id
	// 	};
	//
	// 	grid.plugins[0].cancelEdit();
	// 	store.insert(0, record);
	// 	grid.plugins[0].startEdit(0, 0);
	// },

	// insurancePanelAdd: function(tapPanel, panel){
	// 	var me = this,
	// 		record = panel.insurance || Ext.create('App.model.patient.Insurance', {pid: me.pid});
	//
	// 	panel.title = _('insurance') + ' (' + (record.data.insurance_type ? record.data.insurance_type : _('new')) + ')';
	//
	// 	me.insuranceFormLoadRecord(panel, record);
	// 	if(record.data.image !== '') panel.down('image').setSrc(record.data.image);
	// },

	// insuranceFormLoadRecord: function(form, record){
	// 	form.getForm().loadRecord(record);
	// 	app.fireEvent('insurancerecordload', form, record);
	// },

	// getValidInsurances: function(){
	// 	var me = this,
	// 		forms = me.insTabPanel.items.items,
	// 		records = [],
	// 		form,
	// 		rec;
	//
	// 	for(var i = 0; i < forms.length; i++){
	// 		form = forms[i].getForm();
	// 		if(!form.isValid()){
	// 			me.insTabPanel.setActiveTab(forms[i]);
	// 			return false;
	// 		}
	// 		rec = form.getRecord();
	// 		app.fireEvent('beforepatientinsuranceset', form, rec);
	// 		rec.set(form.getValues());
	// 		app.fireEvent('afterpatientinsuranceset', form, rec);
	// 		records.push(rec);
	// 	}
	// 	return records;
	// },

	// getPatientContacts: function(pid){
	// 	var me = this;
	//
	// 	me.patientContacsStore.clearFilter(true);
	// 	me.patientContacsStore.load({
	// 		params: {
	// 			pid: pid
	// 		},
	// 		filters: [
	// 			{
	// 				property: 'pid',
	// 				value: pid
	// 			}
	// 		]
	// 	});
	// },

	/**
	 * verify the patient required info and add a yellow background if empty
	 */
	verifyPatientRequiredInfo: function(){
		var me = this,
			field;
		me.patientAlertsStore.load({
			scope: me,
			params: {pid: me.pid},
			callback: function(records, operation, success){
				for(var i = 0; i < records.length; i++){
					field = me.demoForm.getForm().findField(records[i].data.name);
					if(records[i].data.val){
						if(field) field.removeCls('x-field-yellow');
					}else{
						if(field) field.addCls('x-field-yellow');
					}
				}
			}
		});
	},

	/**
	 * allow to edit the field if the filed has no data
	 * @param fields
	 */
	readOnlyFields: function(fields){
		// for(var i = 0; i < fields.items.length; i++){
		//    var f = fields.items[i], v = f.getValue(), n = f.name;
		//    if(n == 'SS' || n == 'DOB' || n == 'sex'){
		//        if(v == null || v == ''){
		//            f.setReadOnly(false);
		//        }else{
		//            f.setReadOnly(true);
		//        }
		//    }
		// }
	},

	// getValidInsurances: function(){
	// 	var me = this,
	// 		forms = Ext.ComponentQuery.query('#PatientInsurancesPanel')[0].items.items,
	// 		records = [],
	// 		form,
	// 		rec;
	//
	// 	for(var i = 0; i < forms.length; i++){
	// 		form = forms[i].getForm();
	// 		if(!form.isValid()){
	// 			me.insTabPanel.setActiveTab(forms[i]);
	// 			return false;
	// 		}
	// 		rec = form.getRecord();
	// 		app.fireEvent('beforepatientinsuranceset', form, rec);
	// 		rec.set(form.getValues());
	// 		app.fireEvent('afterpatientinsuranceset', form, rec);
	// 		records.push(rec);
	// 	}
	// 	return records;
	// },

	formSave: function(){
		var me = this,
			form = me.demoForm.getForm(),
			record = form.getRecord(),
			values = form.getValues();

		//insRecs = me.getValidInsurances();

		if(!form.isValid()) {
			me.msg(_('oops'), _('missing_required_data'), true);
			return;
		}


		if(record.isSaving === true){
			return;
		}

		record.set(values);

		// fire global event
		app.fireEvent('beforedemographicssave', record, me);

		record.isSaving = true;

		record.save({
			scope: me,
			callback: function(record){

				app.setPatient(record.data.pid, null, null, function(){

					me.verifyPatientRequiredInfo();
					me.readOnlyFields(form.getFields());

				});

				// fire global event
				app.fireEvent('afterdemographicssave', record, me);
				me.msg(_('sweet'), _('record_saved'));

				record.isSaving = false;
			}
		});

	},

	formCancel: function(btn){
		var me = this,
			form = me.demoForm.getForm(),
			record = form.getRecord();
		form.loadRecord(record);
	},

	loadNew: function(){
		var patient = Ext.create('App.model.patient.Patient', {
			'create_uid': app.user.id,
			'update_uid': app.user.id,
			'create_date': new Date(),
			'update_date': new Date(),
			'DOB': '0000-00-00 00:00:00'
		});
		this.demoForm.getForm().loadRecord(patient);
	},

	loadPatient: function(pid){
		var me = this,
			form = me.demoForm.getForm();

		me.pid = pid;

		form.reset();

		form.loadRecord(app.patient.record);

		app.fireEvent('demographicsrecordload', app.patient.record, me);

		me.setReadOnly(app.patient.readOnly);
		me.setButtonsDisabled(me.query('button[action="readOnly"]'));
		me.verifyPatientRequiredInfo();

		// app.patient.record.insurance().load({
		// 	filters: [
		// 		{
		// 			property: 'pid',
		// 			value: app.patient.record.data.pid
		// 		}
		// 	],
		// 	callback: function(records){
		//
		// 		//form.loadRecord(app.patient.record);
		// 		me.setReadOnly(app.patient.readOnly);
		// 		me.setButtonsDisabled(me.query('button[action="readOnly"]'));
		// 		me.verifyPatientRequiredInfo();
		// 		//me.insTabPanel = Ext.ComponentQuery.query('#PatientInsurancesPanel')[0];
		//
		// 		// set the insurance panel
		// 		// me.insTabPanel.removeAll(true);
		// 		// for(var i = 0; i < records.length; i++){
		// 		// 	me.insTabPanel.add(
		// 		// 		Ext.widget('patientinsuranceform', {
		// 		// 			closable: false,
		// 		// 			insurance: records[i]
		// 		// 		})
		// 		// 	);
		// 		// }
		// 		// if(me.insTabPanel.items.length !== 0) me.insTabPanel.setActiveTab(0);
		// 	}
		// });
	}
});

Ext.define('App.view.patient.InsurancesPanel', {
    extend: 'Ext.tab.Panel',
    xtype: 'insurancestabpanel',
    requires: [
        'App.view.patient.InsuranceForm'
    ],
    title: _('insurance'),
    defaults: {
        autoScroll: true,
        padding: 10
    },
    plugins: [
        {
            ptype: 'AddTabButton',
            iconCls: 'icoAdd',
            toolTip: _('new_insurance'),
            btnText: _('add_insurance'),
            forceText: true,
            panelConfig: {
                xtype: 'patientinsuranceform'
            }
        }
    ],
    bbar: [
        '->',
        '-',
        {
            xtype: 'button',
            text: _('save'),
            minWidth: 75,
            disableOnCLick: true,
            itemId: 'PatientInsurancesPanelSaveBtn'
        },
        '-',
        {
            xtype: 'button',
            text: _('cancel'),
            action: 'readOnly',
            minWidth: 75,
            itemId: 'PatientInsurancesPanelCancelBtn'
        }
    ]
});

Ext.define('App.view.patient.Summary', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('patient_summary'),
	pageLayout: 'border',
	requires: [
		'Ext.XTemplate',
		'Ext.ux.IFrame',
		'App.view.patient.Documents',
		'App.view.patient.CCD',
		'App.ux.ManagedIframe',
		'App.view.patient.Patient',
		'App.view.patient.Reminders',
		'App.view.patient.Alerts',
		'App.view.patient.Amendments',
		'App.view.patient.InsurancesPanel',
		'App.view.patient.CareTeamGrid',
		'App.view.patient.DisclosuresGrid',
		'App.view.patient.EncountersGrid',
		'App.view.patient.LegalLetters',
		'App.view.patient.PatientNotesGrid'
	],
	itemId: 'PatientSummaryPanel',
	showRating: true,
	pid: null,
	demographicsData: null,
	initComponent: function(){
		var me = this;

		me.stores = [];


		me.auditLogCtrl = app.getController('administration.TransactionLog');
		me.patientNotesCtrl = app.getController('patient.PatientNotes');

		app.on('patientset', function(patient){
			if(!me.hidden){
				me.updateTitle(
					patient.name +
					' - ' +
					patient.sexSymbol +
					' - ' +
					patient.age.str +
					' - (' +
					_('patient_summary') +
					')',
					app.patient.readOnly, null
				);
			}

		}, me);

		me.pageBody = [
			me.tabPanel = Ext.widget('tabpanel', {
				flex: 1,
				margin: '3 0 0 0',
				bodyPadding: 0,
				frame: false,
				border: false,
				plain: true,
				region: 'center',
				layout: 'fit',
				itemId: 'PatientSummaryTabPanel'
			})
		];

		me.sidePanelItems = [];

		Ext.Array.push(me.sidePanelItems, {
			xtype: 'patientcareteamgrid',
			itemId: 'PatientSummaryCareTeamGrid'
		});

		if(a('access_patient_visits')){

			me.stores.push(me.patientEncountersStore = Ext.create('App.store.patient.Encounters', {
				autoLoad: false,
                remoteSort: true,
				pageSize: 999,
                sorters: [{
                    property: 'service_date',
                    direction: 'DESC'
                }],
			}));

			Ext.Array.push(me.sidePanelItems, {
				xtype: 'grid',
				title: _('encounters'),
				itemId: 'PatientSummaryEncountersPanel',
				hideHeaders: true,
				scrollable: true,
				maxHeight: 200,
				store: me.patientEncountersStore,
				tools: [
					{
						xtype: 'button',
						text: _('new_progress'),
						itemId: 'PatientSummeryNewProgressNoteBtn',
						acl: a('add_encounters')
					}
				],
				columns: [
					{
						xtype: 'datecolumn',
						width: 90,
						dataIndex: 'service_date',
						format: g('date_display_format'),
						renderer: function (v, meta, rec) {
							var service_date = rec.get('service_date');

							if(!service_date) return v;

							if(service_date.toLocaleDateString() === new Date().toLocaleDateString()){
								meta.style = 'font-weight:bold;background-color:yellow;';
							}

							return Ext.Date.format(v, g('date_display_format'));
						}
					},
					{
						dataIndex: 'brief_description',
						flex: 1,
						renderer: function (v,meta,rec) {
							var service_date = rec.get('service_date'),
								str = v;

							if(rec.isPrivate()){
								str = '<i class="fas fa-shield-check" style="color: red"></i> ' + str;
							}

							if(rec.isClose()){
								str = '<i class="fas fa-shield-check" style="color: #1b9bfc"></i> ' + str;
							}

							if(!service_date) return str;

							if(service_date.toLocaleDateString() === new Date().toLocaleDateString()){
								meta.style = 'font-weight:bold;background-color:yellow;';
							}

							return str;
						}
					}
				]
			});
		}

		if(a('access_patient_medications')){
			me.stores.push(me.patientMedicationsStore = Ext.create('App.store.patient.Medications', {
				autoLoad: false
			}));

			Ext.Array.push(me.sidePanelItems, {
				xtype: 'grid',
				title: _('active_medications'),
				itemId: 'PatientSummaryMedicationsPanel',
				hideHeaders: true,
				scrollable: true,
				maxHeight: 200,
				store: me.patientMedicationsStore,
				tools: [
					{
						xtype: 'button',
						text: _('details'),
						action: 'medications',
						scope: me,
						handler: me.medicalWin
					}
				],
				columns: [
					{
						header: _('name'),
						dataIndex: 'STR',
						flex: 1
					},
					{
						text: _('alert'),
						width: 55,
						dataIndex: 'alert',
						renderer: me.boolRenderer
					}
				]
			});
		}

		if(a('access_patient_immunizations')){

			me.stores.push(me.immuCheckListStore = Ext.create('App.store.patient.ImmunizationCheck', {
				autoLoad: false
			}));

			Ext.Array.push(me.sidePanelItems, {
				xtype: 'grid',
				title: _('immunizations'),
				itemId: 'PatientSummaryImmunizationPanel',
				hideHeaders: true,
				scrollable: true,
				maxHeight: 200,
				store: me.immuCheckListStore,
				region: 'center',
				tools: [
					{
						xtype: 'button',
						text: _('quick'),
						iconCls: 'icoAdd',
						margin : '0 3 0 0',
						acl: a('add_patient_immunizations'),
						itemId: 'PatientSummaryImmunizationPanelQuickAddBtn'
					},
					{
						xtype: 'button',
						text: _('details'),
						action: 'immunization',
						scope: me,
						handler: me.medicalWin
					}
				],
				columns: [
					{
						header: _('name'),
						dataIndex: 'vaccine_name',
						flex: 1
					},
					{
						text: _('alert'),
						width: 55,
						dataIndex: 'alert',
						renderer: me.alertRenderer
					}
				]
			});
		}

		if(a('access_patient_allergies')){

			me.stores.push(me.patientAllergiesListStore = Ext.create('App.store.patient.Allergies', {
				autoLoad: false
			}));

			Ext.Array.push(me.sidePanelItems, {
				xtype: 'grid',
				title: _('allergies'),
				itemId: 'PatientSummaryAllergiesPanel',
				hideHeaders: true,
				scrollable: true,
				maxHeight: 200,
				store: me.patientAllergiesListStore,
				region: 'center',
				tools: [
					{
						xtype: 'button',
						text: _('details'),
						action: 'allergies',
						scope: me,
						handler: me.medicalWin
					}
				],
				columns: [
					{
						header: _('name'),
						dataIndex: 'allergy',
						flex: 1
					},
					{
						text: _('alert'),
						width: 55,
						dataIndex: 'alert',
						renderer: me.boolRenderer
					}
				]
			});
		}

		if(a('access_active_problems')){

			me.stores.push(me.patientActiveProblemsStore = Ext.create('App.store.patient.PatientActiveProblems', {
				autoLoad: false
			}));

			Ext.Array.push(me.sidePanelItems, {
				xtype: 'grid',
				title: _('active_problems'),
				itemId: 'PatientSummaryActiveProblemsPanel',
				hideHeaders: true,
				scrollable: true,
				maxHeight: 200,
				store: me.patientActiveProblemsStore,
				tools: [
					{
						xtype: 'button',
						text: _('details'),
						action: 'issues',
						scope: me,
						handler: me.medicalWin
					}
				],
				columns: [
					{
						header: _('name'),
						dataIndex: 'code_text',
						flex: 1
					},
					{
						text: _('alert'),
						width: 55,
						dataIndex: 'alert',
						renderer: me.boolRenderer
					}
				]

			});
		}

		if(a('access_patient_calendar_events')){

			//me.stores.push(me.patientCalendarEventsStore = Ext.create('App.store.patient.PatientCalendarEvents', {
			//	autoLoad: false
			//}));
			//
			//Ext.Array.push(me.sidePanelItems, {
			//	xtype: 'grid',
			//	title: _('appointments'),
			//	itemId: 'AppointmentsPanel',
			//	hideHeaders: true,
			//	disableSelection: true,
			//	store: me.patientCalendarEventsStore,
			//	columns: [
			//		{
			//			xtype: 'datecolumn',
			//			format: 'F j, Y, g:i a',
			//			dataIndex: 'start',
			//			flex: 1
			//		}
			//	]
			//});
		}

		if(me.sidePanelItems.length > 0){
			me.sidePanel = Ext.widget('panel', {
				width: 250,
				bodyPadding: 0,
				frame: false,
				border: false,
				bodyBorder: true,
				region: 'east',
				split: true,
				layout: {
					type: 'vbox',
					align: 'stretch'
				},
				defaults: {
					margin: '5 5 0 5'
				},
				itemId: 'PatientSummarySidePanel',
				items: me.sidePanelItems
			});

			Ext.Array.push(me.pageBody, me.sidePanel);
		}

		if(a('access_demographics')){
            // Dynamically Generated by Form Builder Engine
            me.demographics = me.tabPanel.add({
				xtype: 'patientdeomgraphics',
				newPatient: false,
				autoScroll: true,
				title: _('demographics')
             });

			me.insTabPanel = me.tabPanel.add({
				xtype: 'insurancestabpanel',
				itemId: 'PatientInsurancesPanel'
			});

			me.tabPanel.add({
				xtype: 'patientlegalletters',
				itemId: 'PatientLegalLettersGrid'
			});
		}



		if(a('access_patient_disclosures')){
			me.tabPanel.add({
				xtype: 'patientdisclosuresgrid',
				bodyPadding: 0
			});
		}

		if(a('access_patient_notes')){
			me.tabPanel.add({
				xtype: 'patientnotesgrid',
				itemId: 'PatientNotesGrid',
				frame: true,
				title: _('notes')
			});
		}

		if(a('access_patient_reminders')){
			me.tabPanel.add({
				itemId: 'PatientSummaryRemindersPanel',
				xtype: 'patientreminderspanel',
				bodyPadding: 0
			});
		}

		if(a('access_patient_alerts')){
			me.tabPanel.add({
				itemId: 'PatientSummaryAlertsPanel',
				xtype: 'patientalertspanel',
				bodyPadding: 0
			});
		}

		//if(a('access_patient_amendments')){
			me.tabPanel.add({
				xtype: 'patientamendmentspanel',
				itemId: 'PatientAmendmentsPanel',
				border: true
			});
		//}

		if(a('access_patient_documents')){
			me.tabPanel.add({
				xtype: 'patientdocumentspanel',
				border: false
			});
		}

		if(a('access_patient_preventive_care_alerts')){
			//me.tabPanel.add({
			//	title: _('dismissed_preventive_care_alerts'),
			//	xtype: 'grid',
			//	itemId: 'PatientSummaryPreventiveCareAlertsPanel',
			//	store: Ext.create('App.store.patient.DismissedAlerts', {
			//		//listeners
			//	}),
			//	columns: [
			//		{
			//			header: _('description'),
			//			dataIndex: 'description'
			//		},
			//		{
			//			xtype: 'datecolumn',
			//			header: _('date'),
			//			dataIndex: 'date',
			//			format: 'Y-m-d'
			//
			//		},
			//		{
			//			header: _('reason'),
			//			dataIndex: 'reason',
			//			flex: true
			//
			//		},
			//		{
			//			header: _('observation'),
			//			dataIndex: 'observation',
			//			flex: true
			//		},
			//		{
			//			header: _('dismissed'),
			//			dataIndex: 'dismiss',
			//			width: 60,
			//			renderer: me.boolRenderer
			//		}
			//	],
			//	plugins: Ext.create('App.ux.grid.RowFormEditing', {
			//		autoCancel: false,
			//		errorSummary: false,
			//		clicksToEdit: 1,
			//		items: [
			//			{
			//				title: 'general',
			//				xtype: 'container',
			//				padding: 10,
			//				layout: 'vbox',
			//				items: [
			//					{
			//						/**
			//						 * Line one
			//						 */
			//						xtype: 'fieldcontainer',
			//						layout: 'hbox',
			//						defaults: {
			//							margin: '0 10 5 0'
			//						},
			//						items: [
			//							{
			//								xtype: 'textfield',
			//								name: 'reason',
			//								fieldLabel: _('reason'),
			//								width: 585,
			//								labelWidth: 70,
			//								action: 'reason'
			//							}
			//						]
			//
			//					},
			//					{
			//						/**
			//						 * Line two
			//						 */
			//						xtype: 'fieldcontainer',
			//						layout: 'hbox',
			//						defaults: {
			//							margin: '0 10 5 0'
			//						},
			//						items: [
			//							{
			//								xtype: 'textfield',
			//								fieldLabel: _('observation'),
			//								name: 'observation',
			//								width: 250,
			//								labelWidth: 70,
			//								action: 'observation'
			//							},
			//							{
			//								fieldLabel: _('date'),
			//								xtype: 'datefield',
			//								action: 'date',
			//								width: 200,
			//								labelWidth: 40,
			//								format: g('date_display_format'),
			//								name: 'date'
			//
			//							},
			//							{
			//								xtype: 'checkboxfield',
			//								name: 'dismiss',
			//								fieldLabel: _('dismiss_alert')
			//
			//							}
			//						]
			//
			//					}
			//				]
			//			}
			//		]
			//
			//	})
			//});
		}

		if(a('access_patient_vitals')){
			me.tabPanel.add({
				xtype: 'vitalspanel',
				border: true
			});
		}

		if(a('access_enc_history')){
			me.tabPanel.add({
				xtype: 'encountersgrid',
				border: true
			});
		}

		// if(a('access_patient_ccd')){
		// 	me.reportPanel = me.tabPanel.add({
		// 		xtype: 'patientccdpanel'
		// 	});
		// }

		me.callParent();
	},

	onAddNew: function(btn){
		var grid = btn.up('grid'),
			store = grid.store,
			record;

		if(btn.action == 'disclosure'){
			record = {
				date: new Date(),
				pid: app.patient.pid,
				global_id: app.uuidv4(),
				active: 1
			};
		}else if(btn.action == 'note'){
			record = {
				date: new Date(),
				create_date: new Date(),
				pid: app.patient.pid,
				create_uid: app.user.id,
				uid: app.user.id,
				eid: app.patient.eid,
				global_id: app.uuidv4(),
				user_fname: app.user.fname,
				user_mname: app.user.mname,
				user_lname: app.user.lname,
			};
		}

		grid.plugins[0].cancelEdit();
		store.insert(0, record);
		grid.plugins[0].startEdit(0, 0);
	},

	onGridBeforeEdit: function(editor, context, eOpts ){
		if (!a('edit_patient_notes')) {
			app.msg(_('oops'), _('not_authorized'), true);
			return false;
		}
	},

	onGridValidateEdit: function(editor, context, eOpts ){
		context.record.data.update_user_fname 	= app.user.fname;
		context.record.data.update_user_mname 	= app.user.mname;
		context.record.data.update_user_lname 	= app.user.lname;
		context.record.data.update_date 		= app.getDate();
		context.record.data.update_uid 			= app.user.id;
	},

	onPatientSummaryNotesGridContextMenu: function (grid, record, item, index, e) {
		e.preventDefault();

		this.showPatientSummaryNotesGridContextMenu(grid,record, e);
	},

	showPatientSummaryNotesGridContextMenu: function (patient_notes_panel_grid, patient_notes_panel_record, e) {
		if (!a('access_patient_notes_transaction_log')) return;

		var me = this;

		me.PatientSummaryNotesGridContextMenu = Ext.widget('menu', {
			margin: '0 0 10 0',
			items: [
				{
					text: _('transaction_log'),
					icon: 'modules/billing/resources/images/icoList.png',
					itemId: 'showPatientSummaryNotesGridContextMenuDetailLog',
					acl: true,
					listeners: {
						click: me.onPatientSummaryNotesGridContextMenuDetailLogClick,
						scope: me
					}
				}
			]
		});

		me.PatientSummaryNotesGridContextMenu.patient_notes_panel_grid = patient_notes_panel_grid;
		me.PatientSummaryNotesGridContextMenu.patient_notes_panel_record = patient_notes_panel_record;

		me.PatientSummaryNotesGridContextMenu.showAt(e.getXY());

		return me.PatientSummaryNotesGridContextMenu;
	},

	onPatientSummaryNotesGridContextMenuDetailLogClick: function(btn) {
		var me = this,
			patient_notes_panel_record = btn.parentMenu.patient_notes_panel_record;

		this.auditLogCtrl.doTransactionLogDetailByTableAndPk(patient_notes_panel_record.table.name, patient_notes_panel_record.get('id'));

	},

	medicalWin: function(btn){
		app.onMedicalWin(btn.action);
	},

	/**
	 * verify the patient required info and add a yellow background if empty
	 */
	verifyPatientRequiredInfo: function(){
		var me = this,
            formPanel = me.query('[action="demoFormPanel"]')[0],
            field,
            i;
		me.patientAlertsStore.load({
			scope: me,
			params: {
				pid: me.pid
			},
			callback: function(records, operation, success){
				for(i = 0; i < records.length; i++){
					field = formPanel.getForm().findField(records[i].data.name);
					if(records[i].data.val){
						if(field) field.removeCls('x-field-yellow');
					}else{
						if(field) field.addCls('x-field-yellow');
					}
				}
			}
		});
	},

	/**
	 * load all the stores in the summaryStores array
	 */
	loadStores: function(){
		var me = this,
            i;

		me.stores.forEach(function (store){
			store.removeAll();
			store.commitChanges();
			store.clearFilter(true);
			store.load({
				params: {
					pid: me.pid,
					active: true
				},
				filters: [
					{
						property: 'pid',
						value: me.pid
					}
				]
			});
		});
	},

	loadPatient: function(){
		var me = this,
            patient;

		me.el.mask(_('loading...'));
		/**
		 * convenient way to refer to current pid within this panel
		 * @type {*}
		 */
		me.pid = app.patient.pid;

		/**
		 * get current set patient info
		 */
		patient = app.patient;

		/**
		 * update panel main title to reflect the patient name and if the patient is read only
		 */
		me.updateTitle(
            patient.name +
            ' - ' +
            patient.sexSymbol +
            ' - ' +
            patient.age.str +
            ' - (' +
            _('patient_summary') +
            ')',
            app.patient.readOnly, null
        );

		/**
		 * verify if the patient is on read only mode
		 */
		me.setReadOnly(app.patient.readOnly);
		me.setButtonsDisabled(me.query('button[action="readOnly"]'));

		if(a('access_demographics')) me.demographics.loadPatient(me.pid);

		/**
		 * reset tab panel to the first tap
		 */
		me.tabPanel.setActiveTab(0);

		/**
		 * load all the stores
		 */
		me.loadStores();

		app.fireEvent('patientsummaryload',me, patient);

		me.el.unmask();
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive: function(callback){
		var me = this;
		if(me.checkIfCurrPatient()){
			me.loadPatient();
			if(typeof callback == 'function') callback(true);
		}else{
			callback(false);
			me.pid = null;
			me.currPatientError();
		}
	}
});

Ext.define('App.ux.grid.exporter.FileSaver', {
    statics: {
        saveAs: function(data, mimeType, charset, filename, link, remote, cb, scope) {
                window.URL = window.URL || window.webkitURL;
                try { //If browser supports Blob(Gecko,Chrome,IE10+)
                    var blob = new Blob([data], { //safari 5 throws error
                        type: mimeType + ";charset=" + charset + ","
                    });
                    if (link && "download" in link) {
                        blobURL = window.URL.createObjectURL(blob);
                        link.href = blobURL;
                        link.download = filename;
                        if(cb) cb.call(scope);
                        this.cleanBlobURL(blobURL);
                        return;
                    } else if (window.navigator.msSaveOrOpenBlob) { //IE 10+
                        window.navigator.msSaveOrOpenBlob(blob, filename);
                        if(cb) cb.call(scope);
                        return;
                    }
                } catch (e) { //open using data:URI 
                	Ext.log("Browser doesn't support Blob: " + e.message);
                }
				//Browser doesn't support Blob save
                if(remote) {//send data to sever to download
                	this.downloadUsingServer(data, mimeType, charset, filename, cb, scope);
                } else{//open data in new window
                	this.openUsingDataURI(data, mimeType, charset);
                	if(cb) cb.call(scope);
                }
        },
        downloadUsingServer: function(data, mimeType, charset, filename, cb, scope) {
        	var form = Ext.getDom('formDummy');
        	if(!form) {
	            form = document.createElement('form');
	            form.id = 'formDummy';
	            form.name = 'formDummy';
	            form.className = 'x-hidden';
	            document.body.appendChild(form);        	
        	}
            Ext.Ajax.request({
                url: '/ExportFileAction',
                method: 'POST',
                form: form,
                isUpload: true,
                params: {
                	userAction: 'download',
                    data: data,
                    mimeType: mimeType,
                    charset: charset,
                    filename: filename
                },
                callback: function() {
                	if(cb) cb.call(scope);
                }
            });
        },
        openUsingDataURI: function(data, mimeType, charset) {
        	if (Ext.isIE9m) { //for IE 9 or lesser
                w = window.open();
                doc = w.document;
                doc.open(mimeType, 'replace');
                doc.charset = charset;
                doc.write(data);
                doc.close();
                doc.execCommand("SaveAs", null, filename);
            } else {
	            window.open("data:" + mimeType + ";charset=" + charset + "," + encodeURIComponent(data), "_blank");
            }
        },
        cleanBlobURL: function(blobURL) {
            // Need a some delay for the revokeObjectURL to work properly.
            setTimeout(function() {
                window.URL.revokeObjectURL(blobURL);
            }, 10000);
        }
    }
});
Ext.define("App.ux.grid.exporter.Formatter", {
    /**
     * Performs the actual formatting. This must be overridden by a subclass
     */
    format: Ext.emptyFn,
    constructor: function(config) {
        config = config || {};

        Ext.applyIf(config, {

        });
    }
});
Ext.define("App.ux.grid.exporter.ExporterButton", {
    extend: "Ext.Button",
    requires: ['App.ux.grid.exporter.Exporter', 'App.ux.grid.exporter.FileSaver'],
    alias: "widget.exporterbutton",
    
    /**
     * @cfg {String} text
     * The button text to be used as innerHTML (html tags are accepted).
     */
    text: 'Download',

    /**
     * @cfg {String} format
     * The Exported File formatter 
     */
    format: 'csv',
    
    /**
     * @cfg {Boolean} preventDefault
     * False to allow default action when the {@link #clickEvent} is processed.
     */
    preventDefault: false,
    
    /**
     * @cfg {Number} saveDelay
     * Increased buffer to avoid clickEvent fired many times within a short period.
     */
    saveDelay: 300,
    
    //iconCls: 'save',
    
    /**
     * @cfg {Boolean} remote
     * To remotely download file only if browser doesn't support locally 
     * otherwise it will try to open in new window
     */
    remote: false,
    /**
     * @cfg {String} title
     * To set name to eported file, extension will be appended based on format  
     */
    title: 'export',
    
    constructor: function(config) {
        var me = this;
        
        App.ux.grid.exporter.ExporterButton.superclass.constructor.call(me, config);
        
        me.on("afterrender", function() { //wait for the button to be rendered, so we can look up to grab the component
            if (me.component) {
                me.component = !Ext.isString(me.component) ? me.component : Ext.ComponentQuery.query(me.component)[0];
            }
            me.setComponent(me.store || me.component || me.up("gridpanel") || me.up("treepanel"), config);
        });
    },
    
    onClick: function(e) {

	    var me = this;

	    var blobURL = "",
		    format = me.format,
		    title = me.title,
		    remote = me.remote,
		    dt = new Date(),
		    link = me.el.dom,
		    res, filename;

	    me.fireEvent('start', me);
	    res = App.ux.grid.exporter.Exporter.exportAny(me.component, format, { title : title });
	    filename = title + "_" + Ext.Date.format(dt, "Y-m-d h:i:s") + "." + res.ext;
	    App.ux.grid.exporter.FileSaver.saveAs(res.data, res.mimeType, res.charset, filename, link, remote, me.onComplete, me);
	    me.callParent(arguments);
    },

    setComponent: function(component, config) {
        var me = this;
        me.component = component;
        me.store = !component.is ? component : component.getStore(); // only components or stores, if it doesn't respond to is method, it's a store        
    },

    onComplete: function() {
        this.fireEvent('complete', this);
    }
});

Ext.define("App.ux.grid.exporter.csvFormatter.CsvFormatter", {
    extend: "App.ux.grid.exporter.Formatter",
    mimeType: 'text/csv',
    charset:'UTF-8',
    separator: ",",
    extension: "csv",
    format: function(store, config) {
        this.columns = config.columns || (store.fields ? store.fields.items : store.model.prototype.fields.items);
        this.parserDiv = document.createElement("div");
        return this.getHeaders() + "\n" + this.getRows(store);
    },
    getHeaders: function(store) {
        var columns = [],
            title;
        Ext.each(this.columns, function(col) {
            var title;
            if (col.getXType() != "rownumberer") {
                if (col.text != undefined) {
                    title = col.text;
                } else if (col.name) {
                    title = col.name.replace(/_/g, " ");
                    title = Ext.String.capitalize(title);
                }
                columns.push(title);
            }
        }, this);
        return columns.join(this.separator);
    },
    getRows: function(store) {
        var rows = [];
        store.each(function(record, index) {
            rows.push(this.getCell(record, index));
        }, this);

        return rows.join("\n");
    },
    getCell: function(record, index) {
        var cells = [];
        Ext.each(this.columns, function(col) {
            var name = col.name || col.dataIndex || col.stateId;
            if (name && col.getXType() != "rownumberer") {
                if (Ext.isFunction(col.renderer)) {
                    var value = col.renderer(record.get(name), {}, record);
                    //to handle specific case if renderer returning html(img tags inside div)
                    this.parserDiv.innerHTML = value;
                    var values = [];
                    var divEls = this.parserDiv.getElementsByTagName('div');
                    if(divEls && divEls.length > 0) {
                        Ext.each(divEls, function(divEl) {
                            var innerValues = [];
                            var imgEls = divEl.getElementsByTagName('img');
                            Ext.each(imgEls, function(imgEl) {
                                innerValues.push(imgEl.getAttribute('title'));
                            });
                            innerValues.push(divEl.innerText || divEl.textContent);
                            values.push(innerValues.join(':'));
                        });
                    } else {
                        values.push(this.parserDiv.innerText || this.parserDiv.textContent);
                    }
                    value = values.join('\n');
                } else {
                    var value = record.get(name);
                }
                cells.push("\""+value+"\"");
            }
        }, this);
        return cells.join(this.separator);
    }
});
Ext.define("App.ux.grid.exporter.excelFormatter.ExcelFormatter", {
    extend: "App.ux.grid.exporter.Formatter",
    uses: [
        "App.ux.grid.exporter.excelFormatter.Cell",
        "App.ux.grid.exporter.excelFormatter.Style",
        "App.ux.grid.exporter.excelFormatter.Worksheet",
        "App.ux.grid.exporter.excelFormatter.Workbook"
    ],
    //contentType: 'data:application/vnd.ms-excel;base64,',
    //contentType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8",
    //mimeType: "application/vnd.ms-excel",
   	mimeType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
   	//charset:"base64",
    charset:"UTF-8",
    extension: "xls",
	
    format: function(store, config) {
      var workbook = new App.ux.grid.exporter.excelFormatter.Workbook(config);
      workbook.addWorksheet(store, config || {});

      return workbook.render();
    }
});
Ext.define("App.ux.grid.exporter.excelFormatter.Cell", {
    constructor: function(config) {
        Ext.applyIf(config, {
          type: "String"
        });

        Ext.apply(this, config);

        App.ux.grid.exporter.excelFormatter.Cell.superclass.constructor.apply(this, arguments);
    },

    render: function() {
        return this.tpl.apply(this);
    },

    tpl: new Ext.XTemplate(
        '<ss:Cell ss:StyleID="{style}">',
          '<ss:Data ss:Type="{type}">{value}</ss:Data>',
        '</ss:Cell>'
    )
});
Ext.define("App.ux.grid.exporter.excelFormatter.Style", {
  constructor: function(config) {
    config = config || {};

    Ext.apply(this, config, {
      parentStyle: '',
      attributes : []
    });

    App.ux.grid.exporter.excelFormatter.Style.superclass.constructor.apply(this, arguments);

    if (this.id == undefined) throw new Error("An ID must be provided to Style");

    this.preparePropertyStrings();
  },

  /**
   * Iterates over the attributes in this style, and any children they may have, creating property
   * strings on each suitable for use in the XTemplate
   */
  preparePropertyStrings: function() {
    Ext.each(this.attributes, function(attr, index) {
      this.attributes[index].propertiesString = this.buildPropertyString(attr);
      this.attributes[index].children = attr.children || [];

      Ext.each(attr.children, function(child, childIndex) {
        this.attributes[index].children[childIndex].propertiesString = this.buildPropertyString(child);
      }, this);
    }, this);
  },

  /**
   * Builds a concatenated property string for a given attribute, suitable for use in the XTemplate
   */
  buildPropertyString: function(attribute) {
    var propertiesString = "";

    Ext.each(attribute.properties || [], function(property) {
      propertiesString += Ext.String.format('ss:{0}="{1}" ', property.name, property.value);
    }, this);

    return propertiesString;
  },

  render: function() {
    return this.tpl.apply(this);
  },

  tpl: new Ext.XTemplate(
    '<tpl if="parentStyle.length == 0">',
      '<ss:Style ss:ID="{id}">',
    '</tpl>',
    '<tpl if="parentStyle.length != 0">',
      '<ss:Style ss:ID="{id}" ss:Parent="{parentStyle}">',
    '</tpl>',
    '<tpl for="attributes">',
      '<tpl if="children.length == 0">',
        '<ss:{name} {propertiesString} />',
      '</tpl>',
      '<tpl if="children.length != 0">',
        '<ss:{name} {propertiesString}>',
          '<tpl for="children">',
            '<ss:{name} {propertiesString} />',
          '</tpl>',
        '</ss:{name}>',
      '</tpl>',
    '</tpl>',
    '</ss:Style>'
  )
});
Ext.define("App.ux.grid.exporter.excelFormatter.Worksheet", {

    constructor: function(store, config) {
        config = config || {};

        this.store = store;

        Ext.applyIf(config, {
            hasTitle: true,
            hasHeadings: true,
            stripeRows: true,
			parserDiv: document.createElement("div"),
            title: "Workbook",
            columns: store.fields == undefined ? {} : store.fields.items
        });

        Ext.apply(this, config);

        App.ux.grid.exporter.excelFormatter.Worksheet.superclass.constructor.apply(this, arguments);
    },

    /**
     * @property dateFormatString
     * @type String
     * String used to format dates (defaults to "Y-m-d"). All other data types are left unmolested
     */
    dateFormatString: "Y-m-d",

    worksheetTpl: new Ext.XTemplate(
        '<ss:Worksheet ss:Name="{title}">',
        '<ss:Names>',
        '<ss:NamedRange ss:Name="Print_Titles" ss:RefersTo="=\'{title}\'!R1:R2" />',
        '</ss:Names>',
        '<ss:Table x:FullRows="1" x:FullColumns="1" ss:ExpandedColumnCount="{colCount}" ss:ExpandedRowCount="{rowCount}">',
        '{columns}',
        '<ss:Row ss:Height="38">',
        '<ss:Cell ss:StyleID="title" ss:MergeAcross="{colCount - 1}">',
        '<ss:Data xmlns:html="http://www.w3.org/TR/REC-html40" ss:Type="String">',
        '<html:B><html:U><html:Font html:Size="15">{title}',
        '</html:Font></html:U></html:B></ss:Data><ss:NamedCell ss:Name="Print_Titles" />',
        '</ss:Cell>',
        '</ss:Row>',
        '<ss:Row ss:AutoFitHeight="1">',
        '{header}',
        '</ss:Row>',
        '{rows}',
        '</ss:Table>',
        '<x:WorksheetOptions>',
        '<x:PageSetup>',
        '<x:Layout x:CenterHorizontal="1" x:Orientation="Landscape" />',
        '<x:Footer x:Data="Page &amp;P of &amp;N" x:Margin="0.5" />',
        '<x:PageMargins x:Top="0.5" x:Right="0.5" x:Left="0.5" x:Bottom="0.8" />',
        '</x:PageSetup>',
        '<x:FitToPage />',
        '<x:Print>',
        '<x:PrintErrors>Blank</x:PrintErrors>',
        '<x:FitWidth>1</x:FitWidth>',
        '<x:FitHeight>32767</x:FitHeight>',
        '<x:ValidPrinterInfo />',
        '<x:VerticalResolution>600</x:VerticalResolution>',
        '</x:Print>',
        '<x:Selected />',
        '<x:DoNotDisplayGridlines />',
        '<x:ProtectObjects>False</x:ProtectObjects>',
        '<x:ProtectScenarios>False</x:ProtectScenarios>',
        '</x:WorksheetOptions>',
        '</ss:Worksheet>'),

    /**
     * Builds the Worksheet XML
     * @param {Ext.data.Store} store The store to build from
     */
    render: function(store) {

        var groupCount = this.isGrouped ? this.store.groups.length : 0;
        var summaryCount = this.hasSummary ? this.store.groups.length : 0;

        return this.worksheetTpl.apply({
            header: this.buildHeader(),
            columns: this.buildColumns().join(""),
            rows: this.buildRows().join(""),
            colCount: this.columns.length,
            rowCount: (this.store.getCount() + groupCount + summaryCount + 10),
            title: this.title
        });
    },

    buildColumns: function() {
        var cols = [];

        Ext.each(this.columns, function(column) {
            cols.push(this.buildColumn());
        }, this);

        return cols;
    },

    buildColumn: function(width) {
        return Ext.String.format('<ss:Column ss:AutoFitWidth="1" ss:Width="{0}" />', width || 164);
    },

    buildRows: function() {
        var rows = [];

        // say('buildRows');
        // say(this);
        // say(this.store);
        // say(this.columns);

        if(this.isGrouped){

            Ext.Object.each(this.store.groups.map, function (group_title, group){

                rows.push(this.buildGroupRow(group_title));

                group.records.forEach(function(record, index) {
                    rows.push(this.buildRow(record, index));
                }, this);

                if(this.hasGroupingSummary && group.aggregate){
                    // say(this.buildSummaryRow(group.aggregate));
                    rows.push(this.buildSummaryRow(group.aggregate));
                }
            }, this);

        }else{
            this.store.each(function(record, index) {
                rows.push(this.buildRow(record, index));
            }, this);
        }

        if(this.hasSummary){
            say('hasSummary');
            say(this);
            rows.push(this.buildSummaryRow(this.summary.summaryRecord));
        }

        return rows;
    },

    buildHeader: function() {
        var cells = [];

        Ext.each(this.columns, function(col) {
            var title;

            //if(col.dataIndex) {
            if (col.text != undefined) {
                title = col.text;
            } else if (col.name) {
                //make columns taken from Record fields (e.g. with a col.name) human-readable
                title = col.name.replace(/_/g, " ");
                title = Ext.String.capitalize(title);
            }

            cells.push(Ext.String.format('<ss:Cell ss:StyleID="headercell"><ss:Data ss:Type="String">{0}</ss:Data><ss:NamedCell ss:Name="Print_Titles" /></ss:Cell>', title));
            //}
        }, this);

        return cells.join("");
    },

    buildGroupRow: function(group_title) {
        return Ext.String.format('<ss:Row ss:Height="25"><ss:Cell ss:StyleID="groupcell" ss:MergeAcross="{0}"><ss:Data ss:Type="String">{1}</ss:Data><ss:NamedCell ss:Name="Print_Titles"/></ss:Cell></ss:Row>', (this.columns.length -1), group_title);
    },

    buildSummaryRow: function (record){
        // say('buildSummaryRow');
        // say(this);
        // say(record);

        var cells = [];

        Ext.each(this.columns, function(col) {
            var name = col.name || col.dataIndex,
                value, type, style = 'summarycell';

            if (name) {
                if(Ext.isFunction(col.summaryRenderer)){
                    value = col.summaryRenderer(record.get(name), {}, record);

                    this.parserDiv.innerHTML = value;
                    value = this.parserDiv.innerText || this.parserDiv.textContent || '';

                    if(Ext.isNumeric(value)){
                        type = 'Number';
                    }else{
                        type = 'String'
                    }
                }else{
                    value = record.get(name) || '';
                    this.parserDiv.innerHTML = value;
                    value = this.parserDiv.innerText || this.parserDiv.textContent || '';
                    type = this.typeMappings[col.type];

                    if(type === undefined){
                        if(Ext.isNumeric(value)){
                            type = 'Number';
                        }else{
                            type = 'String'
                        }
                    }
                }

                cells.push(this.buildCell(value, type, style).render());
            }
        }, this);

        return Ext.String.format('<ss:Row ss:Height="25">{0}</ss:Row>', cells.join(''));
    },

    buildRow: function(record, index) {
        var style,
        cells = [];
        if (this.stripeRows === true) style = index % 2 == 0 ? 'even' : 'odd';

        Ext.each(this.columns, function(col) {
            var name = col.name || col.dataIndex,
                value, type;

            if (name) {
                //if given a renderer via a ColumnModel, use it and ensure data type is set to String
                if (Ext.isFunction(col.renderer)) {
                    value = col.renderer(record.get(name), {}, record);
                    type = "String";

                    var values = [];
					//to extract value if renderers returning html
                    this.parserDiv.innerHTML = value;
                    var divEls = this.parserDiv.getElementsByTagName('div');
                    if (divEls && divEls.length > 0) {
                        Ext.each(divEls, function(divEl) {
                            var innerValues = [];
                            var imgEls = divEl.getElementsByTagName('img');
                            Ext.each(imgEls, function(imgEl) {
                                innerValues.push(imgEl.getAttribute('title'));
                            });
                            innerValues.push(divEl.innerText || divEl.textContent);
                            values.push(innerValues.join(':'));
                        });
                    } else {
                        values.push(this.parserDiv.innerText || this.parserDiv.textContent);
                    }
                    value = values.join(' ').trim();

                    if(Ext.isNumeric(value)){
                        type = 'Number';
                    }

                } else {
                    value = record.get(name);
                    type = this.typeMappings[col.type || record.fields.get(name).type.type];
                }

                cells.push(this.buildCell(value, type, style).render());
            }
        }, this);

        return Ext.String.format('<ss:Row>{0}</ss:Row>', cells.join(''));
    },

    buildCell: function(value, type, style) {
        if (type == "DateTime" && Ext.isFunction(value.format)) value = value.format(this.dateFormatString);

        return new App.ux.grid.exporter.excelFormatter.Cell({
            value: value,
            type: type,
            style: style
        });
    },

    /**
     * @property typeMappings
     * @type Object
     * Mappings from Ext.data.Record types to Excel types
     */
    typeMappings: {
        'int': "Number",
        'string': "String",
        'float': "Number",
        'date': "DateTime"
    }
});
Ext.define("App.ux.grid.exporter.excelFormatter.Workbook", {

  constructor: function(config) {
    config = config || {};

    Ext.apply(this, config, {
      /**
       * @property title
       * @type String
       * The title of the workbook (defaults to "Workbook")
       */
      title: "Workbook",

      /**
       * @property worksheets
       * @type Array
       * The array of worksheets inside this workbook
       */
      worksheets: [],

      /**
       * @property compileWorksheets
       * @type Array
       * Array of all rendered Worksheets
       */
      compiledWorksheets: [],

      /**
       * @property cellBorderColor
       * @type String
       * The colour of border to use for each Cell
       */
      cellBorderColor: "#e4e4e4",

      /**
       * @property styles
       * @type Array
       * The array of App.ux.grid.exporter.ExcelFormatter.Style objects attached to this workbook
       */
      styles: [],

      /**
       * @property compiledStyles
       * @type Array
       * Array of all rendered App.ux.grid.exporter.ExcelFormatter.Style objects for this workbook
       */
      compiledStyles: [],

      /**
       * @property hasDefaultStyle
       * @type Boolean
       * True to add the default styling options to all cells (defaults to true)
       */
      hasDefaultStyle: true,

      /**
       * @property hasStripeStyles
       * @type Boolean
       * True to add the striping styles (defaults to true)
       */
      hasStripeStyles: true,

      windowHeight    : 9000,
      windowWidth     : 50000,
      protectStructure: false,
      protectWindows  : false
    });

    if (this.hasDefaultStyle) this.addDefaultStyle();
    if (this.hasStripeStyles) this.addStripedStyles();

    this.addTitleStyle();
    this.addHeaderStyle();
    this.addGroupStyle();
    this.addSummaryStyle();
  },

  render: function() {
    this.compileStyles();
    this.joinedCompiledStyles = this.compiledStyles.join("");

    this.compileWorksheets();
    this.joinedWorksheets = this.compiledWorksheets.join("");

    return this.tpl.apply(this);
  },

  /**
   * Adds a worksheet to this workbook based on a store and optional config
   * @param {Ext.data.Store} store The store to initialize the worksheet with
   * @param {Object} config Optional config object
   * @return {App.ux.grid.exporter.ExcelFormatter.Worksheet} The worksheet
   */
  addWorksheet: function(store, config) {
    var worksheet = new App.ux.grid.exporter.excelFormatter.Worksheet(store, config);

    this.worksheets.push(worksheet);

    return worksheet;
  },

  /**
   * Adds a new App.ux.grid.exporter.ExcelFormatter.Style to this Workbook
   * @param {Object} config The style config, passed to the Style constructor (required)
   */
  addStyle: function(config) {
    var style = new App.ux.grid.exporter.excelFormatter.Style(config || {});

    this.styles.push(style);

    return style;
  },

  /**
   * Compiles each Style attached to this Workbook by rendering it
   * @return {Array} The compiled styles array
   */
  compileStyles: function() {
    this.compiledStyles = [];

    Ext.each(this.styles, function(style) {
      this.compiledStyles.push(style.render());
    }, this);

    return this.compiledStyles;
  },

  /**
   * Compiles each Worksheet attached to this Workbook by rendering it
   * @return {Array} The compiled worksheets array
   */
  compileWorksheets: function() {
    this.compiledWorksheets = [];

    Ext.each(this.worksheets, function(worksheet) {
      this.compiledWorksheets.push(worksheet.render());
    }, this);

    return this.compiledWorksheets;
  },

  tpl: new Ext.XTemplate(
    '<?xml version="1.0" encoding="utf-8"?>',
    '<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:o="urn:schemas-microsoft-com:office:office">',
      '<o:DocumentProperties>',
        '<o:Title>{title}</o:Title>',
      '</o:DocumentProperties>',
      '<x:ExcelWorkbook>',
         '<x:WindowHeight>{windowHeight}</x:WindowHeight>',
         '<x:WindowWidth>{windowWidth}</x:WindowWidth>',
         '<x:ProtectStructure>{protectStructure}</x:ProtectStructure>',
         '<x:ProtectWindows>{protectWindows}</x:ProtectWindows>',
      '</x:ExcelWorkbook>',
      '<ss:Styles>',
        '{joinedCompiledStyles}',
      '</ss:Styles>',
        '{joinedWorksheets}',
    '</ss:Workbook>'
  ),

  /**
   * Adds the default Style to this workbook. This sets the default font face and size, as well as cell borders
   */
  addDefaultStyle: function() {
    var borderProperties = [
      {name: "Color",     value: this.cellBorderColor},
      {name: "Weight",    value: "1"},
      {name: "LineStyle", value: "Continuous"}
    ];

    this.addStyle({
      id: 'Default',
      attributes: [
        {
          name: "Alignment",
          properties: [
            {name: "Vertical", value: "Top"},
            {name: "WrapText", value: "1"}
          ]
        },
        {
          name: "Font",
          properties: [
            {name: "FontName", value: "arial"},
            {name: "Size",     value: "11"}
          ]
        },
        {name: "Interior"}, {name: "NumberFormat"}, {name: "Protection"},
        {
          name: "Borders",
          children: [
            {
              name: "Border",
              properties: [{name: "Position", value: "Top"}].concat(borderProperties)
            },
            {
              name: "Border",
              properties: [{name: "Position", value: "Bottom"}].concat(borderProperties)
            },
            {
              name: "Border",
              properties: [{name: "Position", value: "Left"}].concat(borderProperties)
            },
            {
              name: "Border",
              properties: [{name: "Position", value: "Right"}].concat(borderProperties)
            }
          ]
        }
      ]
    });
  },

  addTitleStyle: function() {
    this.addStyle({
      id: "title",
      attributes: [
        {name: "Borders"},
        {name: "Font"},
        {
          name: "NumberFormat",
          properties: [
            {name: "Format", value: "@"}
          ]
        },
        {
          name: "Alignment",
          properties: [
            {name: "WrapText",   value: "1"},
            {name: "Horizontal", value: "Left"},
            {name: "Vertical",   value: "Center"}
          ]
        }
      ]
    });
  },

  addHeaderStyle: function() {
    this.addStyle({
      id: "headercell",
      attributes: [
        {
          name: "Font",
          properties: [
            {name: "Bold", value: "1"},
            {name: "Size", value: "12"}
          ]
        },
        {
          name: "Interior",
          properties: [
            {name: "Pattern", value: "Solid"},
            {name: "Color",   value: "#9c9c9c"}
          ]
        },
        {
          name: "Alignment",
          properties: [
            {name: "WrapText",   value: "1"},
            {name: "Horizontal", value: "Center"}
          ]
        }
      ]
    });
  },

  addGroupStyle: function() {
    this.addStyle({
      id: "groupcell",
      attributes: [
        {
          name: "Font",
          properties: [
            {name: "Bold", value: "1"},
            {name: "Size", value: "12"}
          ]
        },
        {
          name: "Interior",
          properties: [
            {name: "Pattern", value: "Solid"},
            {name: "Color", value: "#ffffff"}
          ]
        },
        {
          name: "Alignment",
          properties: [
            {name: "WrapText", value: "1"},
            {name: "Horizontal", value: "Left"}
          ]
        },
        {
          name: "Borders",
          children: [
            {
              name: "Border",
              properties: [
                {name: "Position", value: "Bottom"},
                {name: "LineStyle", value: "Continuous"},
                {name: "Color", value: "#acacac"},
                {name: "Weight", value: "2"}
              ]
            }
          ]
        }
      ]
    });
  },

  addSummaryStyle: function() {
    this.addStyle({
      id: "summarycell",
      attributes: [
        {
          name: "Font",
          properties: [
            {name: "Bold", value: "1"},
            {name: "Size", value: "11"}
          ]
        },
        {
          name: "Interior",
          properties: [
            {name: "Pattern", value: "Solid"},
            {name: "Color", value: "#ffffff"}
          ]
        },
        {
          name: "Alignment",
          properties: [
            {name: "WrapText", value: "1"},
            {name: "Horizontal", value: "Right"},
            {name: "Vertical", value: "Top"}
          ]
        },
        {
          name: "Borders",
          children: [
            {
              name: "Border",
              properties: [
                {name: "Position", value: "Top"},
                {name: "LineStyle", value: "Continuous"},
                {name: "Color", value: "#acacac"},
                {name: "Weight", value: "1"}
              ]
            }
          ]
        }
      ]
    });
  },

  /**
   * Adds the default striping styles to this workbook
   */
  addStripedStyles: function() {
    this.addStyle({
      id: "even",
      attributes: [
        {
          name: "Interior",
          properties: [
            {name: "Pattern", value: "Solid"},
            {name: "Color",   value: "#ffffff"}
          ]
        }
      ]
    });

    this.addStyle({
      id: "odd",
      attributes: [
        {
          name: "Interior",
          properties: [
            {name: "Pattern", value: "Solid"},
            {name: "Color",   value: "#efefef"}
          ]
        }
      ]
    });

    Ext.each(['even', 'odd'], function(parentStyle) {
      this.addChildNumberFormatStyle(parentStyle, parentStyle + 'date', "[ENG][$-409]dd\-mmm\-yyyy;@");
      this.addChildNumberFormatStyle(parentStyle, parentStyle + 'int', "0");
      this.addChildNumberFormatStyle(parentStyle, parentStyle + 'float', "0.00");
    }, this);
  },

  /**
   * Private convenience function to easily add a NumberFormat style for a given parentStyle
   * @param {String} parentStyle The ID of the parentStyle Style
   * @param {String} id The ID of the new style
   * @param {String} value The value of the NumberFormat's Format property
   */
  addChildNumberFormatStyle: function(parentStyle, id, value) {
    this.addStyle({
      id: id,
      parentStyle: "even",
      attributes: [
        {
          name: "NumberFormat",
          properties: [{name: "Format", value: value}]
        }
      ]
    });
  }
});
Ext.define('App.controller.administration.UsersTransaction', {
    extend: 'Ext.app.Controller',
    requires: [

    ],

    refs: [

        //USER TRANSACTIONS WINDOW FORM
        {
            ref: 'UserTransactionWindow',
            selector: '#UserTransactionWindow'
        },
        {
            ref: 'UserTransactionWindowFields',
            selector: '#UserTransactionWindowFields'
        },
        {
            ref: 'UserTransactionWindowCreateDateField',
            selector: '#UserTransactionWindowCreateDateField'
        },
        {
            ref: 'UserTransactionWindowCreateUserNameField',
            selector: '#UserTransactionWindowCreateUserNameField'
        },
        {
            ref: 'UserTransactionWindowUpdateDateField',
            selector: '#UserTransactionWindowUpdateDateField'
        },
        {
            ref: 'UserTransactionWindowButtonCloseBtn',
            selector: '#UserTransactionWindowButtonCloseBtn'
        }

    ],

    init: function(){

        var me = this;

        me.control({

            //WINDOW FORM BUTTONS
            '#UserTransactionWindow': {
                beforerender: me.onUserTransactionWindowBeforeRender
            },
            '#UserTransactionWindowButtonCloseBtn': {
                click: me.onUserTransactionWindowButtonCloseBtnClick
            }

        });
    },

    /**
     * USER TRANSACTIONS WINDOW - FUNCTIONS
     */

    onUserTransactionWindowBeforeRender: function(win){

        var me = this,
            create_date = win.create_date,
            user_username = win.user_username,
            update_date = win.update_date;

        me.getUserTransactionWindowCreateDateField().setValue(create_date);
        me.getUserTransactionWindowCreateUserNameField().setValue(user_username);
        me.getUserTransactionWindowUpdateDateField().setValue(update_date);
    },

    onUserTransactionWindowButtonCloseBtnClick: function(btn){
        var win = btn.up('window');

        win.close();
    }

});
Ext.define('App.model.administration.PrintJob', {
	extend: 'Ext.data.Model',
	table: {
		name: 'print_jobs'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'uid',
			type: 'int'
		},
		{
			name: 'document_id',
			type: 'int'
		},
		{
			name: 'printer_id',
			type: 'string'
		},
		{
			name: 'printer_type',
			type: 'string',
			len: 25
		},
		{
			name: 'print_status',
			type: 'string',
			len: 30
		},
		{
			name: 'priority',
			type: 'int'
		},
		{
			name: 'number_of_copies',
			type: 'int',
			defaultValue: 1
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'user_username',
			type: 'string',
			store: false
		},
		{
			name: 'user_fname',
			type: 'string',
			store: false
		},
		{
			name: 'user_lname',
			type: 'string',
			store: false
		},
		{
			name: 'user_mname',
			type: 'string',
			store: false
		},
		{
			name: 'document_doc_type',
			type: 'string',
			store: false
		},
		{
			name: 'document_title',
			type: 'string',
			store: false
		},
		{
			name: 'document_note',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'PrintJob.getPrintJobs',
			create: 'PrintJob.addPrintJob',
			update: 'PrintJob.updatePrintJob',
			destroy: 'PrintJob.destroyPrintJob'
		},
		reader: {
			root: 'data'
		},
		writer:{
			writeAllFields: true
		}
	}
});
Ext.define('App.store.administration.PrintJob', {
	extend: 'Ext.data.Store',
	requires: ['App.model.administration.PrintJob'],
	model: 'App.model.administration.PrintJob'
});
Ext.define('App.controller.BrowserHelper', {
	extend: 'Ext.app.Controller',
	requires: [],
	refs: [

	],
	socket: undefined,
	host: 'local.tranextgen.com',
	port: 9595,
	connected: false,
	waiting: false,
	callback: undefined,

	reconnect_interval: 1000 * 5, // 5 seconds
	connect_delay: 1000 * 3, // 5 seconds
	debug: false,
	initiated: false,

	init: function(){
		var me = this;

		Ext.Function.defer(me.connect, me.connect_delay, me);
	},

	connect: function () {

		var me = this;

		if(me.socket) return;

		me.socket = new WebSocket('wss://' + me.host +':' + me.port + '/');

		me.socket.onopen = function (event) {
			me.onOpen(event.data);
		};
		me.socket.onclose = function (event) {
			me.onClose(event.data);
		};
		me.socket.onmessage = function (event) {
			me.onMessage(event.data);
		};
		me.socket.onerror = function (event) {
			me.onError(event.data);
		};

	},

	reconnect: function () {
		var me = this;

		if(!me.initiated) return;

		this.log('reconnect');

		me.connected = false;
		delete me.socket;

		Ext.Function.defer(function () {
			me.connect();
		},me.reconnect_interval);
	},

	send: function (message, callback) {
		this.socket.send(message);
		this.callback = callback;
	},

	onOpen: function (data) {
		this.log('onOpen');
		this.log(data);
		this.initiated = true;
		this.connected = true;
		Ext.Function.defer(function () {
			app.fireEvent('browserhelperopen', this);
		},1000, this);
	},

	onClose: function (data) {
		this.log('onClose');
		this.log(data);
		this.reconnect();
		Ext.Function.defer(function () {
			app.fireEvent('browserhelperclose', this);
		},1000, this);
	},

	onMessage: function (data) {
		this.log('onMessage');
		this.log(data);

		data = JSON.parse(data);

		if(data.action && data.action === 'command'){
			this.log('fireEvent: ' + data.msg);
			app.fireEvent(data.msg, this);
		}else if(data.action && data.action === 'burnermsg'){
			this.log('fireEvent: ' + data.msg);
			app.fireEvent('burnermsg', this, data);
		}else if(data.action && data.action === 'printermsg'){
			this.log('fireEvent: ' + data.msg);
			app.fireEvent('printermsg', this, data);
		}else{

			// callback is defined
			if(this.callback){
				this.callback(data);
				this.callback = undefined;
			}
		}

	},

	onError: function (data) {
		this.log('onError');
		this.log(data);
		this.reconnect();
	},


	log: function (msg) {
		if(this.debug){
			say(msg);
		}
	},

	sendMessage: function(message, callback){

		if(this.connected){
			this.send(JSON.stringify(message), callback);
		}else {
			app.msg(_('oops'), _('not_conneted'), true);
		}
	}
});
Ext.define('App.controller.patient.Disclosures', {
    extend: 'Ext.app.Controller',
    requires: [],
    refs: [
        {
            ref: 'PatientDisclosuresGrid',
            selector: '#PatientDisclosuresGrid'
        },
        {
            ref: 'DisclosureEditWindow',
            selector: '#DisclosureEditWindow'
        },
        {
            ref: 'DisclosureEditWindowForm',
            selector: '#DisclosureEditWindowForm'
        },
        {
            ref: 'DisclosuresRecipientWindow',
            selector: '#DisclosuresRecipientWindow'
        },
        {
            ref: 'DisclosuresRecipientForm',
            selector: '#DisclosuresRecipientForm'
        },
        {
            ref: 'DisclosuresRecipientField',
            selector: '#DisclosuresRecipientField'
        },
        {
            ref: 'DisclosuresDescriptionField',
            selector: '#DisclosuresDescriptionField'
        },
        {
            ref: 'DisclosuresRecipientCancelBtn',
            selector: '#DisclosuresRecipientCancelBtn'
        },
        {
            ref: 'DisclosuresRecipientSaveBtn',
            selector: '#DisclosuresRecipientSaveBtn'
        },
        {
            ref: 'PatientDisclosuresPrinterCmb',
            selector: '#PatientDisclosuresPrinterCmb'
        },
        {
            ref: 'PatientDisclosuresBurnersCmb',
            selector: '#PatientDisclosuresBurnersCmb'
        }
    ],

    init: function () {
        var me = this;

        me.control({
            '#PatientDisclosuresGrid': {
                activate: me.onPatientDisclosuresGridActivate,
                beforeitemcontextmenu: me.onPatientDisclosuresGridBeforeItemContextMenu,
                itemdblclick: me.onPatientDisclosuresGridDblClick
            },
            '#PatientDisclosuresGridAddBtn': {
                click: me.onPatientDisclosuresGridAddBtnClick
            },
            '#DisclosureEditWindowFormCancelBtn': {
                click: me.onDisclosureEditWindowFormCancelBtnClick
            },
            '#DisclosureEditWindowFormSaveBtn': {
                click: me.onDisclosureEditWindowFormSaveBtnClick
            },
            // '#DisclosureEditWindowRequestedDate': {
            //     select: me.onDisclosureEditWindowDateSelect
            // },
            // '#DisclosureEditWindowFulfilDate': {
            //     select: me.onDisclosureEditWindowDateSelect
            // },
            // '#DisclosureEditWindowPickupDate': {
            //     select: me.onDisclosureEditWindowDateSelect
            // },
            '#DisclosuresRecipientCancelBtn': {
                click: me.onDisclosuresRecipientCancelBtnClick
            },
            '#DisclosuresRecipientSaveBtn': {
                click: me.onDisclosuresRecipientSaveBtnClick
            },
            '#PatientDisclosuresAttacheDocumentsMenu': {
                click: me.onPatientDisclosuresAttacheDocumentsMenuClick
            },
            '#PatientDisclosuresAttacheDocumentsCancelBtn': {
                click: me.onPatientDisclosuresAttacheDocumentsCancelBtnClick
            },
            '#PatientDisclosuresAttacheDocumentsSaveBtn': {
                click: me.onPatientDisclosuresAttacheDocumentsSaveBtnClick
            },
            '#PatientDisclosuresPrintBtn': {
                click: me.onPatientDisclosuresPrintBtnClick
            },
            '#PatientDisclosuresDownloadBtn': {
                click: me.onPatientDisclosuresDownloadBtnClick
            },
            '#PatientDisclosuresBurnBtn': {
                click: me.onPatientDisclosuresBurnBtnClick
            },
            '#PatientDisclosuresBurnersCmb': {
                beforerender: me.onPatientDisclosuresBurnersCmbBeforeRender
            }
        });
    },

    onPatientDisclosuresPrintBtnClick: function (btn) {
        var me = this,
            grid = me.getPatientDisclosuresGrid(),
            records = grid.getSelectionModel().getSelection(),
            printer_id = me.getPatientDisclosuresPrinterCmb().getValue();

        if (records.length <= 0) {
            app.msg(_('warning'), "No disclosures selected", true);
            return;
        }

        if (printer_id === null) {
            app.msg(_('warning'), "No printer selected", true);
            return;
        }

        app.msg("Printing... ", "Printing disclosure", false);
        records.forEach(function (record) {
            if (record.get('document_inventory_count') > 0) {
                Disclosure.printDisclosure(record.getData(), printer_id, function (response) {
                    if(!response.success) app.msg("Error", response.errorMsg, true);
                });
            }
        });
    },

    onPatientDisclosuresDownloadBtnClick: function (btn) {
        var me = this,
            grid = me.getPatientDisclosuresGrid(),
            records = grid.getSelectionModel().getSelection();

        if (records.length <= 0) {
            app.msg(_('warning'), "No disclosures selected", true);
            return;
        }

        app.msg("Downloading... ", "Downloading disclosure", false);

        records.forEach(function (record, i) {
            Ext.Function.defer(function () {
                me.disclosureDownload(record);
            }, 1000 * i);
        });

    },

    onPatientDisclosuresBurnBtnClick: function (btn) {
        var me = this,
            grid = me.getPatientDisclosuresGrid(),
            records = grid.getSelectionModel().getSelection(),
            burner_id = me.getPatientDisclosuresBurnersCmb().getValue(),
            burner_record = me.getPatientDisclosuresBurnersCmb().findRecordByValue(burner_id);

        if (records.length <= 0) {
            app.msg(_('warning'), "No disclosures selected", true);
            return;
        }

        if (burner_id === null) {
            app.msg(_('warning'), "No burner selected", true);
            return;
        }

        app.msg("Burning... ", "Burning disclosure", false);
        records.forEach(function (record) {
            if (record.get('document_inventory_count') > 0) {
                Disclosure.burnDisclosure(record.getData(), burner_record.getData(), function (response) {
                    if(!response.success) app.msg("Error", response.errorMsg, true);
                });
            }
        });
    },

    onPatientDisclosuresAttacheDocumentsCancelBtnClick: function (btn) {
        btn.up('window').close();
    },

    onPatientDisclosuresAttacheDocumentsSaveBtnClick: function (btn) {
        var win = btn.up('window'),
            grid = win.down('grid'),
            selection = grid.getSelectionModel().getSelection(),
            disclosure_grid = this.getPatientDisclosuresGrid(),
            disclosure_record = disclosure_grid.getSelectionModel().getLastSelected(),
            disclosure_documents = [];

        selection.forEach(function (document_record) {
            disclosure_documents.push({
                disclosure_id: disclosure_record.get('id'),
                document_id: document_record.get('id')
            });
        });

        Disclosure.removeDisclosuresDocumentsById(disclosure_record.get('id'));
        Disclosure.addDisclosuresDocument(disclosure_documents, function (response) {
            win.close();
            disclosure_grid.getStore().reload();
        });

        disclosure_grid.getSelectionModel().deselectAll();
    },

    onDisclosureEditWindowFormSaveBtnClick: function (btn) {
        var me = this,
            grid = me.getPatientDisclosuresGrid(),
            win = me.getDisclosureEditWindow(),
            selection = grid.getSelectionModel().getSelection(),
            values = me.getDisclosureEditWindowForm().getValues(),
            record = me.getDisclosureEditWindowForm().getRecord();
        values.id = null;

        if (selection.length > 0) {
            values.id = selection[0].get('id');
        }


        win.mask('Saving...');
        record.set(values);

        grid.store.sync({
            callback: function () {
                win.unmask();
                win.close();
            }
        });

    },

    onPatientDisclosuresBurnersCmbBeforeRender: function (cmb) {
        var store = cmb.getStore();

        if(store.getCount() > 0){
            cmb.setValue(store.first());
        }
    },

    onDocumentsLoad: function (document_grid, document_store, document_records) {
        // TODO select records already added to disclosure

        var document_sm = document_grid.getSelectionModel(),
            disclosure_grid = this.getPatientDisclosuresGrid(),
            disclosure_record = disclosure_grid.getSelectionModel().getLastSelected(),
            document_inventory_ids = disclosure_record.get('document_inventory_ids').split(','),
            suppress_event = false;

        document_inventory_ids.forEach(function (document_inventory_id) {
            document_sm.select([document_store.getById(parseInt(document_inventory_id))], true, suppress_event);
            suppress_event = true;
        });

    },

    onPatientDisclosuresGridBeforeItemContextMenu: function (grid, record, item, index, e) {
        e.preventDefault();
        this.showPatientDisclosuresGridBeforeItemContextMenu(record, e);
    },

    onPatientDisclosuresGridDblClick: function (grid, record, item, index, e, eOpts) {
        var win = this.showDisclosureEditWindow(),
            form = win.down('form').getForm();
        form.loadRecord(record);
    },

    showPatientDisclosuresGridBeforeItemContextMenu: function (disclosure_record, e) {

        if (!this.patientDisclosuresGridMenu) {
            this.patientDisclosuresGridMenu = Ext.widget('menu', {
                margin: '0 0 10 0',
                items: [
                    {
                        text: _('attach_documents'),
                        itemId: 'PatientDisclosuresAttacheDocumentsMenu'
                    }
                ]
            });
        }

        return this.patientDisclosuresGridMenu.showAt(e.getXY());
    },

    onPatientDisclosuresAttacheDocumentsMenuClick: function () {
        var me = this,
            configs = {
                buttons: [
                    {
                        xtype: 'button',
                        text: _('cancel'),
                        width: 70,
                        itemId: 'PatientDisclosuresAttacheDocumentsCancelBtn'
                    },
                    {
                        xtype: 'button',
                        text: _('save'),
                        width: 70,
                        itemId: 'PatientDisclosuresAttacheDocumentsSaveBtn'
                    }
                ]
            },
            doc_win = me.getController('patient.Documents').showDocumentWindow(configs),
            doc_grid = doc_win.down('grid');

        doc_grid.getStore().on('load', function (store, records) {
            me.onDocumentsLoad(doc_grid, store, records);
        });
    },

    onPatientDisclosuresGridActivate: function (grid) {
        grid.store.load({
            filters: [
                {
                    property: 'pid',
                    value: app.patient.pid
                }
            ]
        });
    },

    onPatientDisclosuresGridAddBtnClick: function (btn) {
        this.getPatientDisclosuresGrid().getSelectionModel().deselectAll();

        var store = this.getPatientDisclosuresGrid().getStore(),
            win = this.showDisclosureEditWindow(),
            form = win.down('form').getForm(),
            records = store.add({
                pid: app.patient.pid,
                uid: app.user.id,
                request_date: app.getDate(),
                active: true
            });
        form.loadRecord(records[0]);
    },

    onDisclosureEditWindowFormCancelBtnClick: function (btn) {
        this.getPatientDisclosuresGrid().getStore().rejectChanges();
        btn.up('window').close();
    },

    showDisclosureEditWindow: function () {
        if (!this.getDisclosureEditWindow()) {
            Ext.create('App.view.patient.DisclosureEditWindow');
        }
        return this.getDisclosureEditWindow().show();
    },

    onDisclosuresRecipientCancelBtnClick: function () {
        this.getDisclosuresRecipientWindow().close();
    },

    onDisclosuresRecipientSaveBtnClick: function () {
        var win = this.getDisclosuresRecipientWindow(),
            form = this.getDisclosuresRecipientForm().getForm(),
            values = form.getValues(),
            disclosure_data = win.disclosure_data;

        if (!form.isValid()) return;

        disclosure_data.recipient = values.recipient;
        disclosure_data.description = values.description;

        Disclosure.addDisclosure(disclosure_data, win.disclosure_callback);

        win.close();

    },

    addRawDisclosure: function (data, callback) {
        var me = this;

        if (!data.pid) return;

        Ext.Msg.show({
            title: _('wait'),
            msg: _('raw_disclosure_message'),
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.QUESTION,
            fn: function (btn) {
                if (btn == 'yes') {
                    me.promptRecipient(data, callback);
                }
            }
        });
    },

    promptRecipient: function (data, callback) {
        var win = this.showRecipientWindow();
        win.disclosure_data = data;
        win.disclosure_callback = callback;

        this.getDisclosuresRecipientField().reset();
        this.getDisclosuresDescriptionField().setValue(data.description);
    },

    showRecipientWindow: function () {

        if (!this.getDisclosuresRecipientWindow()) {
            Ext.create('Ext.window.Window', {
                title: _('disclosures'),
                layout: 'fit',
                itemId: 'DisclosuresRecipientWindow',
                items: [
                    {
                        xtype: 'form',
                        itemId: 'DisclosuresRecipientForm',
                        width: 300,
                        bodyPadding: 10,
                        items: [
                            {
                                xtype: 'combobox',
                                labelAlign: 'top',
                                fieldLabel: 'Choose Recipient',
                                queryMode: 'local',
                                displayField: 'text',
                                valueField: 'value',
                                itemId: 'DisclosuresRecipientField',
                                allowBlank: false,
                                anchor: '100%',
                                editable: false,
                                name: 'recipient',
                                store: Ext.create('Ext.data.Store', {
                                    fields: ['text', 'value'],
                                    data: [
                                        {text: _('emer_contact'), value: 'emer_contact'},
                                        {text: _('father'), value: 'father'},
                                        {text: _('guardian'), value: 'guardian'},
                                        {text: _('mother'), value: 'mother'},
                                        {text: _('patient'), value: 'patient'}
                                    ]
                                })
                            },
                            {
                                xtype: 'textareafield',
                                labelAlign: 'top',
                                fieldLabel: 'Description',
                                name: 'description',
                                itemId: 'DisclosuresDescriptionField',
                                allowBlank: false,
                                anchor: '100%'
                            }
                        ]
                    }
                ],
                buttons: [
                    {
                        text: _('cancel'),
                        itemId: 'DisclosuresRecipientCancelBtn'
                    },
                    {
                        text: _('save'),
                        itemId: 'DisclosuresRecipientSaveBtn'
                    }
                ]
            });
        }

        return this.getDisclosuresRecipientWindow().show();

    },

    disclosureDownload: function (record) {
        var me = this;
        if (record.get('document_inventory_count') > 0) {

            var formPanel = Ext.create('Ext.form.Panel', {
                    url: 'dataProvider/DisclosureDownload.php'
                }),
                form = formPanel.getForm();
            form.standardSubmit = true;
            window.onbeforeunload = null;

            form.submit({
                params: {
                    disclosure: JSON.stringify(record.getData())
                },
                success: function (form, action) {
                    say('success');
                    window.onbeforeunload = function () {
                        return _('you_should_logout_before_quitting');
                    };
                    Ext.destroy(formPanel);
                },
                failure: function (form, action) {
                    switch (action.failureType) {
                        case Ext.form.action.Action.CLIENT_INVALID:
                            Ext.Msg.alert('Failure', 'Form fields may not be submitted with invalid values');
                            break;
                        case Ext.form.action.Action.CONNECT_FAILURE:
                            Ext.Msg.alert('Failure', 'Ajax communication failed');
                            break;
                        case Ext.form.action.Action.SERVER_INVALID:
                            Ext.Msg.alert('Failure', "????");
                    }
                    Ext.destroy(formPanel);
                    window.onbeforeunload = function () {
                        return _('you_should_logout_before_quitting');
                    };
                }
            });
        }
    },

    // onDisclosureEditWindowDateSelect: function (field,value,eOpts) {
    //     var d = new Date();
    //     say(d.getTime());
    //     value.setTime(d.getTime());
    //     field.setValue(value);
    // }
});

Ext.define('App.view.Viewport', {
    extend: 'Ext.Viewport',
    // app settings
    user: window.user, // array defined on _app.php
    version: window.version, // string defined on _app.php
    node_id: window.node_id, // string defined on _app.php
    minWidthToFullMode: 1700, // full mode = nav expanded 1585
    currency: g('gbl_currency_symbol'), // currency used
	patientImage:'resources/images/icons/user-light.svg',
	enablePoolAreaFadeInOut: eval(g('enable_poolarea_fade_in_out')),
	userInteracted : false,
	itemId: 'Viewport',
	ip: null,

	// end app settings
    initComponent: function(){

	    // Ext.state.Manager.setProvider(Ext.create('Ext.state.CookieProvider'));
	    Ext.tip.QuickTipManager.init();
        var me = window.app = this;

	    me.user.getFullName = function(){
		    var fullname = me.user.title + ' ' + me.user.fname + ' ' + me.user.mname + ' ' + me.user.lname;
			return fullname.replace('  ', ' ').trim();
	    };

	    me.nav = me.getController('Navigation');
	    me.cron = me.getController('Cron');
	    me.log = me.getController('LogOut');
	    me.dual = me.getController('DualScreen');
	    me.notification = me.getController('Notification');

	    me.logged = true;

        //if(eval(g('enable_dual_monitor'))) me.dual.startDual();

	    me.lastCardNode = null;
        me.prevNode = null;
        me.fullMode = window.innerWidth >= me.minWidthToFullMode;


	    me.record_flags = {
		    TOTAL_FALGS: 0
	    };
	    me.record_flags_buff = g('record_number_renderer_flags');
	    if(me.record_flags_buff !== false || me.record_flags_buff !== '' && me.record_flags_buff.split){
		    me.record_flags_buff = me.record_flags_buff.split('|');
		    this.record_flags_buff.forEach(function(flag){
			    if(flag.indexOf(':') != -1){
				    var flag_values = flag.split(':');
				    me.record_flags[flag_values[0]] = flag_values[1];
			    }else{
				    me.record_flags[flag] = true;
			    }
			    me.record_flags.TOTAL_FALGS++;
		    });
	    }
	    delete me.record_flags_buff;

	    //say(me.record_flags);

	    me.patient = {
	        pid: null,
	        pubpid: null,
	        name: null,
	        pic: null,
	        sex: null,
	        sexSymbol: null,
	        dob: null,
	        age: null,
	        eid: null,
	        priority: null,
	        readOnly: false,
	        rating: null,
	        covid_status: null,
	        is_pregnant: null
        };

        /**
         * This store will handle the patient pool area
         */
        me.patientPoolStore = Ext.create('App.store.areas.PatientAreas');
        /*
         * TODO: this should be managed by the language files
         * The language file has a definition for this.
         */
        if(me.currency == '$'){
            me.icoMoney = 'icoDollar';
        }else if(me.currency == ''){
            me.icoMoney = 'icoEuro';
        }else if(me.currency == ''){
            me.icoMoney = 'icoLibra';
        }else if(me.currency == ''){
            me.icoMoney = 'icoYen';
        }

        /**
         * header Panel
         */
        me.Header = Ext.create('Ext.container.Container', {
            region: 'north',
            height: 44,
            split: false,
            collapsible: false,
            collapsed: false,
            frame: false,
            border: false,
	        cls: 'appHeader',
            bodyStyle: 'background: transparent',
            margins: '0 0 0 0',
	        layout: 'hbox'
        });

		me.HeaderLeft = Ext.widget('container', {
			margin: 0,
			flex: 1,
			layout: 'hbox',
			itemId: 'AppHeaderLeft'
		});

		me.HeaderRight = Ext.widget('container',{
			margin: 0,
			layout: 'hbox',
			itemId: 'AppHeaderRight'
		});

	    me.HeaderLeft.add({
		    xtype: 'button',
		    scale: 'large',
		    margin: '0 3 0 0',
		    cls: 'headerLargeBtn',
		    padding: 0,
		    iconCls: 'fal fa-home',
		    scope: me,
		    handler: me.openDashboard,
		    tooltip: _('patient_visits_history')
        });

	    me.HeaderLeft.add({
		    xtype: 'button',
		    scale: 'large',
		    margin: '0 3 0 0',
		    cls: 'headerLargeBtn',
		    padding: 0,
		    iconCls: 'fal fa-calendar-alt',
		    scope: me,
		    handler: me.openCalendar,
		    tooltip: _('patient_visits_history')
        });

	    me.HeaderLeft.add({ xtype: 'tbseparator' });

	    me.patientBtn = me.HeaderLeft.add({
            xtype: 'button',
            scale: 'large',
		    margin: '0 3 0 0',
		    style: 'height: 42px',
            tooltip: _('patient_btn_drag'),
            listeners: {
                scope: me,
                afterrender: me.patientBtnRender
            },
            tpl: me.patientBtnTpl()
        });

	    me.HeaderLeft.add({ xtype: 'tbseparator' });

	    me.patientSummaryBtn = me.HeaderLeft.add({
            xtype: 'button',
            scale: 'large',
            margin: '0 3 0 0',
            cls: 'headerLargeBtn',
            padding: 0,
            iconCls: 'fal fa-info-circle',
            scope: me,
            handler: me.openPatientSummary,
            tooltip: _('patient_summary')
        });

	    if(a('access_patient_visits')){
		    me.patientOpenVisitsBtn = me.HeaderLeft.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    cls: 'headerLargeBtn',
			    padding: 0,
			    iconCls: 'fal fa-history',
			    scope: me,
			    handler: me.openPatientVisits,
			    tooltip: _('patient_visits_history')
		    });
	    }

	    if(a('add_encounters')){
            me.patientCreateEncounterBtn = me.HeaderLeft.add({
                xtype: 'button',
                scale: 'large',
	            margin: '0 3 0 0',
                cls: 'headerLargeBtn',
                padding: 0,
                // icon: 'resources/images/icons/new_encounter.png',
                iconCls: 'fal fa-plus-circle',
                scope: me,
                handler: me.createNewEncounter,
	            disableOnCLick: true,
                tooltip: _('new_encounter')
            });
        }

	    me.patientCloseCurrEncounterBtn = me.HeaderLeft.add({
            xtype: 'button',
            scale: 'large',
		    margin: '0 3 0 0',
            cls: 'headerLargeBtn',
            padding: 0,
            iconCls: 'fal fa-folder-download',
            scope: me,
            handler: me.stowPatientRecord,
            tooltip: _('stow_patient_record')
        });

//	    if(a('access_patient_visit_checkout')){
//		    me.patientCheckOutBtn = me.HeaderLeft.add({
//			    xtype: 'button',
//			    scale: 'large',
//			    margin: '0 3 0 0',
//			    cls: 'headerLargeBtn',
//			    padding: 0,
//			    iconCls: 'icoCheckOut',
//			    scope: me,
//			    handler: me.checkOutPatient,
//			    tooltip: _('visit_check_out')
//		    });
//	    }


//	    me.patientChargeBtn = me.Header.add({
//            xtype: 'button',
//            scale: 'large',
//            style: 'float:left',
//            margin: '0 0 0 3',
//            cls: 'headerLargeBtn',
//            padding: 0,
//            iconCls: me.icoMoney,
//            scope: me,
//            handler: me.onPaymentEntryWindow,
//            tooltip: _('payment_entry')
//        });

	    if(a('access_patient_search')){
		    me.HeaderLeft.add({
			    xtype: 'panel',
			    bodyPadding: '8 11 5 11',
			    margin: '0 3 0 0',
			    items: [
				    {
					    xtype: 'patienlivetsearch',
					    emptyText: _('patient_live_search') + '...',
					    width: 300,
						itemId: 'HeaderPatientLiveSearchField',
					    listeners: {
						    scope: me,
						    select: me.liveSearchSelect,
						    blur: function(combo){
							    combo.reset();
						    }
					    }
				    }
			    ]
		    });
	    }

	    if(a('add_patient')){
		    me.HeaderLeft.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    padding: 4,
			    itemId: 'HeaderNewPatientBtn',
			    iconCls: 'fal fa-user-plus',
			    disableOnCLick: true,
			    tooltip: _('create_a_new_patient')
		    });
	    }

	    if(a('create_emergency_encounter')){
		    me.HeaderLeft.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    cls: 'headerLargeBtn emerBtn',
			    overCls: 'emerBtnOver',
			    padding: 0,
			    itemId: 'createEmergency',
			    iconCls: 'fas fa-plus-circle',
			    scope: me,
			    disableOnCLick: true,
			    handler: me.createEmergency,
			    tooltip: _('create_new_emergency')
		    });
	    }

	    if(a('access_floor_plan_panel')){
		    me.HeaderRight.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    cls: 'headerLargeBtn',
			    padding: 0,
			    itemId: 'floorPlans',
			    iconCls: 'icoZoneAreasBig',
			    scope: me,
			    handler: me.goToFloorPlans,
			    tooltip: _('floor_plans')
		    });
	    }

	    if(a('access_pool_areas_panel')){
		    me.HeaderRight.add([
			    {
				    xtype: 'button',
				    scale: 'large',
				    margin: '0 3 0 0',
				    cls: 'headerLargeBtn',
				    padding: 0,
				    itemId: 'HeaderSendToPoolAreaBtn',
				    icon: 'resources/images/icons/next_pool.png',
				    scope: me,
				    tooltip: _('send_to_area')
			    },
		    	{
				    xtype: 'button',
				    scale: 'large',
				    margin: '0 3 0 0',
				    cls: 'headerLargeBtn',
				    padding: 0,
				    itemId: 'patientPoolArea',
				    iconCls: 'icoPoolArea',
				    scope: me,
				    handler: me.goToPoolAreas,
				    tooltip: _('pool_areas')
			    }
		    ]);
	    }

	    if(a('access_poolcheckin')){
		    me.HeaderRight.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    cls: 'headerLargeBtn',
			    padding: 0,
			    itemId: 'patientCheckIn',
			    iconCls: 'icoCheckIn',
			    scope: me,
			    handler: me.onPatientLog,
			    tooltip: _('arrival_log')
		    });
	    }

	    if(a('allow_user_switch')){
		    me.HeaderRight.add({
			    xtype: 'button',
			    scale: 'large',
			    margin: '0 3 0 0',
			    cls: 'headerLargeBtn',
			    padding: 0,
			    itemId: 'SwitchUserBtn',
			    icon: 'resources/images/icons/switch-user.png',
			    scope: me,
			    tooltip: _('switch_user')
		    });
	    }

	    me.userSplitBtn = me.HeaderRight.add({
		    xtype: 'button',
		    text: me.user.title + ' ' + me.user.fname[0] + '.' + me.user.lname,
		    scale: 'large',
		    iconCls: isEmerAccess ? 'icoUnlocked32' : 'icoDoctor',
		    iconAlign: 'left',
		    style: 'height: 42px',
		    plugins:[
			    {
				    ptype:'badgetext',
				    defaultText: 0
			    }
		    ],
		    itemId:'userSplitButton',
		    cls: 'drButton',
            margin: '0 3 0 0',
		    menu: [
			    { xtype: 'menuseparator' },
			    {
				    text: _('help_documents'),
				    itemId:'AppHelpDocumentMenu',
				    icon: 'resources/images/icons/icohelp.png',
				    menu: [
					    {
						    text: 'Appointment Module User Guide',
						    icon: 'resources/images/icons/icohelp.png',
						    documentTitle: 'Appointment Software User Guide',
						    documentUrl: 'https://docs.google.com/document/d/e/2PACX-1vRaSxKq1stGH8zwCRHvXCIfzBVlOlOSehQSctFeEpzZV6x7LJKo3TB9SgN2w54fuHIQ-WMKkgB2QJ8q/pub?embedded=true'
					    },
					    {
						    text: 'Billing Module User Guide',
						    icon: 'resources/images/icons/icohelp.png',
						    documentTitle: 'Appointment Software User Guide',
						    documentUrl: 'https://docs.google.com/document/d/e/2PACX-1vTTgjeV0lX6S9mijo7dnCSAmIcZofMAEY4oGcKd-UNkJ6fzPIPB6X0JXr77AQ8B1SAZO1-lQZSzWSDL/pub?embedded=true'
					    },
					    {
						    text: 'RIS Module User Guide',
						    icon: 'resources/images/icons/icohelp.png',
						    documentTitle: 'RIS Software User Guide',
						    documentUrl: 'https://docs.google.com/document/d/e/2PACX-1vTA3ymEgqFz8JhE0AxcGghVyEkuCxnoiiJmnbcL-FIIz3MIvv8DSHxWi5Xe4Atg8vMus-u9WSgUKjEW/pub?embedded=true'
					    },
				    ]
			    },

			    { xtype: 'menuseparator' },
			    {
				    text: _('my_account'),
				    iconCls: 'icoUser',
				    handler: function(){
					    me.nav.navigateTo('App.view.miscellaneous.MyAccount');
				    }
			    },
			    {
				    text: _('light_theme'),
				    itemId:'AppThemeSwitcher',
				    action: 'light',
				    icon: 'resources/images/icons/theme.png'
			    },
			    {
				    text: _('clear_stateful_state'),
				    itemId:'AppCleatState',
					iconCls: 'fas fa-eraser'
			    },
			    {
				    text: _('logout'),
				    iconCls: 'icoLogout',
				    action:'logout'
			    }
		    ]
	    });

	    if(a('emergency_access')){
		    me.userSplitBtn.menu.insert(0,{
			    text:_('emergency_access'),
			    cls: 'emergency',
			    iconCls:'icoUnlocked',
			    scope:me,
			    handler:me.onEmergencyAccessClick
		    });
	    }

        me.HeaderRight.add({
            xtype: 'box',
            margin: 0,
			itemId: 'AppNetworkStatusBox',
			width: 10,
			height: 42,
			cls: 'x-btn-default-large app-network-status-box'
        });


	    me.Header.add([me.HeaderLeft, me.HeaderRight]);

        /**
         * The panel definition for the the TreeMenu & the support button
         */
        me.navColumn = Ext.create('Ext.panel.Panel', {
            title: _('navigation'),
            action: 'mainNavPanel',
            layout: 'border',
            region: g('main_navigation_menu_left'),
            width: parseFloat(g('gbl_nav_area_width')),
            split: true,
            collapsible: true,
            collapsed: true,
	        animCollapse: false,
	        stateId: 'mainNavPanel',
	        stateful: true,
            items: [
                {
                    xtype: 'treepanel',
                    region: 'center',
	                action:'mainNav',
                    cls: 'nav_tree',
                    hideHeaders: true,
                    rootVisible: false,
                    border: false,
                    width: parseFloat(g('gbl_nav_area_width')),
	                store: Ext.create('App.store.navigation.Navigation', {
		                autoLoad: true
	                })
                },
                me.patientPoolArea = Ext.create('Ext.Panel', {
                    title: _('patient_pool_areas'),
                    region: 'south',
	                action:'patientPoolArea',
	                stateful: true,
	                stateId:'PatientPoolAreaSateId',
                    bodyPadding: 5,
                    height: 200,
                    cls: 'patient-pool',
                    split: true,
                    collapsible: true,
                    border: false,
	                overflowY: 'auto',
                    items: [
                        {
                            xtype: 'dataview',
                            loadMask: false,
                            cls: 'patient-pool-view',
	                        itemId: 'NavigationPatientPoolAreaDatView',
                            tpl: new Ext.XTemplate(
	                            '<tpl for=".">' +
                                '<div class="patient-pool-btn x-btn x-btn-default-large {priority}">' +
                                '<div class="patient_btn_img">' +
	                            '<img src="{[this.getPatientImage(values.patient)]}" width="50" height="50">' +
	                            '</div>' +
                                '<div class="patient_btn_info">' +
                                '<div class="patient-name">{shortName}</div>' +
                                '<div class="patient-name">({poolArea})</div>' +
                                '</div>' +
                                '</div>' +
                                '</tpl>',
	                            {
		                            getPatientImage:function(patient){
										return patient.image ? patient.image : me.patientImage;
		                            }
	                            }
                            ),
                            itemSelector: 'div.patient-pool-btn',
                            overItemCls: 'patient-over',
                            selectedItemClass: 'patient-selected',
                            singleSelect: true,
                            store: me.patientPoolStore,
                            listeners: {
                                scope: me,
                                render: me.onEncounterDragZoneRender
                            }
                        }
                    ],
	                bbar: [
		                {
		                	xtype: 'floorplanazonescombo',
			                multiSelect: true,
			                itemId: 'NavigationPatientPoolAreaFloorPlanZonesCombo',
			                stateful: true,
			                stateId: 'NavigationPatientPoolAreaFloorPlanZonesComboState',
			                flex: 1
		                }
	                ]
                })
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'bottom',
                    border: true,
                    margin: '3 0 0 0',
                    padding: 5,
                    layout: {
                        type: 'hbox',
                        pack: 'center'
                    },
                    items: ['-', {
                        xtype: 'button',
                        frame: true,
                        text: 'MD Timeline Support',
                        iconCls: 'icoHelp',
	                    action: 'supportBtn',
	                    src: 'https://mdtimeline.freshdesk.com/support/login'
                    }, '-']
                }
            ]
        });

        /**
         * MainPanel is where all the pages are displayed
         */
        me.MainPanel = Ext.create('Ext.container.Container', {
            region: 'center',
            layout: 'card',
            border: true,
            itemId: 'MainPanel',
	        deferredRender: true,
            defaults: {
                layout: 'fit',
                xtype: 'container'
            },
            listeners: {
                scope: me,
                afterrender: me.initializeOpenEncounterDropZone
            }
        });

        /**
         * General Area
         */
        me.nav['App_view_dashboard_Dashboard'] = me.MainPanel.add(Ext.create('App.view.dashboard.Dashboard'));
        me.nav['App_view_areas_FloorPlan'] = me.MainPanel.add(Ext.create('App.view.areas.FloorPlan'));
        me.nav['App_view_areas_PatientPoolAreas'] = me.MainPanel.add(Ext.create('App.view.areas.PatientPoolAreas'));

        /**
         * Footer Panel
         */
        me.Footer = Ext.create('Ext.container.Container', {
            height: 30,
            split: false,
            padding: '3 0',
            region: 'south',
	        action:'appFooter',
            items: [
                {
                    xtype: 'dataview',
                    margin: '0 0 3 0',
                    hidden: true,
                    hideMode: 'offsets',
                    cls: 'patient-pool-view-footer x-toolbar x-toolbar-default x-box-layout-ct',
                    tpl: '<div class="x-toolbar-separator x-toolbar-item x-toolbar-separator-horizontal" style="float:left; margin-top:5px;" role="presentation" tabindex="-1"></div>' + '<tpl for=".">' + '<div class="patient-pool-btn-small x-btn x-btn-default-small {priority}" style="float:left">' + '<div class="patient_btn_info">' + '<div class="patient-name">{shortName} ({pid})</div>' + '</div>' + '</div>' + '<div class="x-toolbar-separator x-toolbar-item x-toolbar-separator-horizontal" style="float:left; margin-top:5px; margin-left:3px;" role="presentation" tabindex="-1"></div>' + '</tpl>',
                    itemSelector: 'div.patient-pool-btn-small',
                    overItemCls: 'patient-over',
                    selectedItemClass: 'patient-selected',
                    singleSelect: true,
                    loadMask: false,
                    store: me.patientPoolStore,
                    listeners: {
	                    scope: me,
                        render: me.onEncounterDragZoneRender
                    }
                },
                {
                    xtype: 'toolbar',
                    dock: 'bottom',
                    items: [
	                    {
		                    xtype:'activefacilitiescombo',
		                    emptyText:'Facilities',
		                    width: parseFloat(g('gbl_nav_area_width')) - 4,
		                    hidden: !eval(a('access_to_other_facilities')),
		                    itemId: 'ApplicationFacilityCombo'
	                    },
						'-',
	                    {
		                    xtype: 'button',
		                    text: _('dual_screen'),
		                    itemId: 'ApplicationDualScreenBtn',
							enableToggle: true,
							iconCls: 'fa fa-desktop',
							toggleGroup: 'ApplicationDualScreenBtnGroup',
							stateful: true,
							stateId: ('ApplicationDualScreenBtnState' + app.user.id)
	                    },
	                    '-',
	                    {
							xtype: 'container',
		                    itemId: 'ApplicationFooterContainer',
		                    flex: 1,
							layout: 'hbox',
		                    defaults: {
			                    xtype: 'button',
								minWidth: 70
		                    },
		                    items: [
			                    {
									xtype: 'printerscombo',
				                    fieldLabel: _('default_printer'),
									labelWidth: 80,
									labelAlign: 'right',
				                    itemId: 'ApplicationFooterDefaultPrinterCmb',
				                    stateful: true,
				                    stateId: 'ApplicationFooterDefaultPrinterCmbState',
									margin: '0 5 0 0',
									width: 300,
									emptyText: 'None',
									resetable: true,
			                    },
			                    {
			                    	xtype: 'button',
				                    text: _('print_jobs'),
									iconCls: 'fa fa-briefcase',
				                    itemId: 'ApplicationFooterPrintJobsBtn'
			                    }
		                    ]
	                    },
	                    '-',
                        {
	                        xtype: 'tbtext',
	                        text: 'Copyright (C) 2019 MDTIMELINE, LLC |:| v' + me.version,
                        },
	                    '-',
	                    {
		                    xtype: 'tbtext',
		                    text: 'IP: 0.0.0.0',
		                    itemId: 'ApplicationIpAddress'
	                    },
	                    '-',
	                    {
		                    xtype: 'tbtext',
		                    text: 'NODE: ' + + me.node_id,
		                    itemId: 'ApplicationNodeId'
	                    },
                        '-',
	                    {
		                    xtype: 'container',
		                    itemId: 'ApplicationClockContainer',
		                    margin: '0 10 0 0'
	                    }
                    ]
                }
            ]
        });

        me.layout = {
            type: 'border',
            padding: 3
        };

        me.defaults = {
            split: true
        };

	    me.items = [me.Header, me.navColumn, me.MainPanel, me.Footer];

	    me.listeners = {
	        scope: me,
            render: me.appRender,
            beforerender: me.beforeAppRender
        };
        me.callParent(arguments);

	    me.ChartsWindow = Ext.create('App.view.patient.windows.Charts');
	    me.PaymentEntryWindow = Ext.create('App.view.fees.PaymentEntryWindow');
	    me.newEncounterWindow = Ext.create('App.view.patient.windows.NewEncounter');

	    if(a('access_encounter_checkout')){
		    me.checkoutWindow = Ext.create('App.view.patient.windows.EncounterCheckOut');
	    }

	    me.el.on('click', me.onUserViewportClick, me);

	    // var w = Ext.create('Ext.window.Window', {
	    // 	height: 400,
	    // 	width: 400,
		// 	bodyPadding: 5,
	    // 	items: [
		// 		{
		// 			xtype: 'form',
		// 			items: [
		// 				{
		// 					xtype: 'physicalexamfield',
		// 					fieldLabel: 'General',
		// 					boxLabel: '(Conscious, alert, oriented X3)',
		// 					name: 'testing_one'
		// 				},
		// 				{
		// 					xtype: 'physicalexamfield',
		// 					fieldLabel: 'Head',
		// 					boxLabel: '(Conscious, alert, oriented X3)',
		// 					name: 'testing_two'
		// 				}
		// 			]
		// 		}
		//
		//     ]
	    // }).show();
		//
	    // say(w.down('form').getForm().getValues());



	    // Ext.create('Ext.window.Window',{
		// 	layout: 'fit',
		// 	// width: 600,
		// 	// height: 600,
		// 	items:[
		// 		{
		// 			xtype: 'form',
		// 			layout: 'fit',
		// 			items: [
		// 				Ext.create('App.ux.form.fields.Canvas', {
		// 					width: 600,
		// 					height: 370,
		// 					image: 'modules/worklist/resources/images/breast_profile.png',
		// 					name: 'birads_image'
		// 				}),
		// 				{
		// 					xtype: 'textfield',
		// 					name: 'birads_test'
		// 				}
		// 			]
		// 		}
		// 	],
		// 	buttons: [
		// 		{
		// 			text: 'Save',
		// 			handler: function (btn){
		// 				var form = btn.up('window').down('form').getForm();
		// 				say(form);
		// 				say(form.getValues());
		// 			}
		// 		}
		// 	]
		// }).show();

    },

	setIpAddress: function(ip){
		if(this.ip !== ip){
			this.Footer.query('#ApplicationIpAddress')[0].update('IP: ' + ip);
		}
	},

	onUserViewportClick: function(){
    	this.userInteracted = true;
		this.el.un('click', this.onUserViewportClick, this);
		this.fireEvent('userinteraction', this);
	},

	getUserFullname: function(){
		return this.user.lname + ', ' + this.user.fname + ' ' + this.user.mname
	},

	getController:function(controller){
		return App.Current.getController(controller);
	},

	setWindowTitle:function(facility){
		window.document.title = 'MDTL :: ' + facility;
	},

    /**
     * Show the medical window dialog.
     */
    onMedicalWin: function(action){
    	if(!this.MedicalWindow){
		    this.MedicalWindow = Ext.create('App.view.patient.windows.Medical');
	    }

	    if(!action) return;

        this.MedicalWindow.show();
        this.MedicalWindow.cardSwitch(action);
    },

    /**
     * Show the Charts window dialog.
     */
    onChartsWin: function(){
        this.ChartsWindow.show();
    },

    onWebCamComplete: function(msg){
        var panel = this.getActivePanel();
        if(panel.id == 'panelSummary'){
            panel.demographics.completePhotoId();
        }
        this.msg(_('sweet'), _('patient_image_saved'));
    },

	onPatientLog: function(){
        if(this.patientArrivalLog){
            this.patientArrivalLog.show();
        }else{
            this.patientArrivalLog = Ext.create('App.view.patient.windows.ArrivalLog').show();
        }
    },

    /**
     * Show the Payment Entry window dialog.
     */
    onPaymentEntryWindow: function(){
        this.PaymentEntryWindow.show();
    },

    /**
     * EMERGENCY STUFF
     */
	createEmergency: function(){
        var me = this,
	        emergency;

        Ext.Msg.show({
            title: _('wait') + '!!!',
            msg: _('are_you_sure_you_want_to_create_a_new') + ' <span style="color: red">"' + _('emergency') + '"</span>?',
            buttons: Ext.Msg.YESNO,
            icon: Ext.Msg.WARNING,
            fn: function(btn){
                if(btn == 'yes'){
                    Emergency.createNewEmergency(function(provider, response){
                        emergency = response.result.emergency;
                        if(response.result.success){

                            me.setPatient(emergency.pid, emergency.eid, null, function(){
                                me.openEncounter(emergency.eid);
                            });
                            me.msg(_('sweet'), emergency.name + ' ' + _('created'))
                        }
                    });
                }
            }
        });
    },

	onEmergencyAccessClick:function(){
		var me = this;

		Ext.Msg.show({
			title:_('wait'),
			msg: _('emergency_access_question') + '<br>' + _('emergency_access_disclaimer'),
			buttons: Ext.Msg.YESNO,
			icon: Ext.Msg.QUESTION,
			fn: function(btn){
				if(btn == 'yes') me.doEmergencyAccess();
			}
		});
	},

	doEmergencyAccess:function(){
		ACL.emergencyAccess(app.user.id, function(success){
			if(success){
				window.location.reload();
				return;
			}
			Ext.Msg.alert(_('oops'), _('emergency_access_error'));
		});
	},

	/**
	 * Show the Create New Encounter panel.
	 */
    createNewEncounter: function(){
        var me = this;

        if(a('access_encounters') && a('add_encounters')){
            me.newEncounterWindow.show();
        }else{
            me.accessDenied();
        }
    },

    updateEncounter: function(record){
        var me = this;

        if(a('access_encounters') && a('edit_encounters')){
	        me.newEncounterWindow.loadRecord(record);
            me.newEncounterWindow.show();
        } else{
            me.accessDenied();
        }
    },

	openPatientSummary: function(){
        var me = this,
	        cls = me.nav.getNavRefByClass('App.view.patient.Summary'),
	        panel =  me.nav[cls];
		if(panel && panel == me.nav.activePanel) panel.loadPatient();
        me.nav.navigateTo('App.view.patient.Summary');
    },

	openDashboard: function(){
		// var me = this,
	     //    cls = me.nav.getNavRefByClass('App.view.dashboard.Dashboard'),
	     //    panel =  me.nav[cls];
		// if(panel && panel == me.nav.activePanel) panel.loadPatient();
        this.nav.navigateTo('App.view.dashboard.Dashboard');
    },

	openCalendar: function(){
        var me = this,
	        cls = me.nav.getNavRefByClass('Modules.appointments.view.CalendarPanel'),
	        panel =  me.nav[cls];
		//if(panel && panel == me.nav.activePanel) panel.loadPatient();
        me.nav.navigateTo('Modules.appointments.view.CalendarPanel');
    },

	stowPatientRecord: function(){
        this.unsetPatient(null, true);
        if(app.fireEvent('stowpatientrecord', this) === false){
        	return;
		}
        this.nav.navigateTo('App.view.dashboard.Dashboard');
    },

	openEncounter: function(eid){
        var me = this;
        if(a('access_encounters')){
            app.patient.eid = eid;
            me.nav.navigateTo('App.view.patient.Encounter', function(success){
                if(success){
	                Ext.Function.defer(function() {
		                me.nav.getPanelByCls('App.view.patient.Encounter').openEncounter(eid);
	                }, 100);
                }
            });
        }else{
            me.accessDenied();
        }
    },

	checkOutPatient: function(eid){
		var me = this;
        this.nav.navigateTo('App.view.patient.VisitCheckout', function(success){
	        if(success){
		        Ext.Function.defer(function() {
			        me.nav.getPanelByCls('App.view.patient.VisitCheckout').setVisitPanel();
		        }, 100);
	        }
        });
    },

	openPatientVisits: function(){
        this.nav.navigateTo('App.view.patient.Visits');
    },

	goToPoolAreas: function(){
        this.nav.navigateTo('App.view.areas.PatientPoolAreas');
    },

	goToFloorPlans: function(){
        this.nav.navigateTo('App.view.areas.FloorPlan');
    },

    /**
     * Function to get the current active panel.
     * NOTE: This may be used on all the application.
     */
    getActivePanel: function(){
        return this.MainPanel.getLayout().getActiveItem();
    },

	addPrintJob: function (document_id, printer_record, print_now, priority, number_of_copies){
		this.getController('PrintJob').addPrintJob(document_id, printer_record, print_now, priority, number_of_copies);
	},

    liveSearchSelect: function(combo, selection){
        var me = this,
	        post = selection[0];

        if(post){
            me.setPatient(post.get('pid'), null, null, function(){
	            combo.reset();

	            if(typeof me.onAppPatientSearchCallback === 'function'){
		            me.onAppPatientSearchCallback(me.patient);
	            }else {
		            me.openPatientSummary();
	            }
            });
        }
    },

    setPatient: function(pid, eid, site, callback, force_callback){
        var me = this;
	    me.unsetPatient(null, true);

        Patient.getPatientSetDataByPid({ pid:pid, prevPid:me.patient.pid, site:site }, function(data){
            var msg1,
                msg2;

            if(data.success === false){
	            me.msg(_('oops'), data.error, true);
	            me.nav.navigateTo('App.view.dashboard.Dashboard');
            	return;
            }

            if(data.readOnly){

                msg1 = data.user + ' ' + _('is_currently_working_with') + ' "' +
                data.patient.name + '" ' + _('in') + ' "' + data.area + '" ' + _('area') +
                '.<br>' + _('override_read_mode_will_remove_the_patient_from_previous_user') + '.<br>' +
                _('do_you_would_like_to_override_read_mode');

                msg2 = data.user + ' ' + _('is_currently_working_with') + ' "' + data.patient.name + '" ' + _('in') +
                ' "' + data.area + '" ' + _('area') + '.<br>';

	            Ext.Msg.show({
                        title: _('wait') + '!!!',
                        msg: data.overrideReadOnly ? msg1 : msg2,
                        buttons: data.overrideReadOnly ? Ext.Msg.YESNO : Ext.Msg.OK,
                        icon: Ext.MessageBox.WARNING,
                        fn: function(btn){
                            continueSettingPatient(btn != 'yes');
                        }
                    });
            }else{
                continueSettingPatient(false);
            }

            function continueSettingPatient(readOnly) {
	            me.patient = {
		            pid: data.patient.pid,
		            pubpid: data.patient.pubpid,
		            name: data.patient.name,
		            pic: data.patient.pic,
		            sex: data.patient.sex,
		            sexSymbol: data.patient.sex == 'F' ? '&#9792' : '&#9794',
		            dob: Ext.Date.parse(data.patient.dob, "Y-m-d H:i:s"),
		            age: data.patient.age,
		            eid: eid,
		            priority: data.patient.priority,
		            readOnly: readOnly,
		            rating: data.patient.rating,
		            covid_status: data.patient.covid_status,
		            is_pregnant: data.patient.is_pregnant,
		            record: Ext.create('App.model.patient.Patient', data.patient.record)
	            };

	            // fire global event
	            me.fireEvent('patientset', me.patient);

	            var panels = me.MainPanel.items.items;
	            for (var i = 0; i < panels.length; i++) if (panels[i].pageRankingDiv) panels[i].pageRankingDiv.setValue(me.patient.rating);
	            me.patientButtonSet(me.patient);
	            if (me.patientSummaryBtn) me.patientSummaryBtn.enable();
	            if (me.patientOpenVisitsBtn) me.patientOpenVisitsBtn.enable();
	            if (me.patientCreateEncounterBtn) me.patientCreateEncounterBtn.enable();
	            if (me.patientCloseCurrEncounterBtn) me.patientCloseCurrEncounterBtn.enable();
//                if(me.patientChargeBtn) me.patientChargeBtn.enable();
	            if (me.patientCheckOutBtn) me.patientCheckOutBtn.enable();

	            if(me.fireEvent('beforepatientsetcallback', me.patient) === false && force_callback !== true) return;

	            if (typeof callback === 'function') {
		            callback(me.patient);
	            }
            }
        });
    },

    unsetPatient: function(callback, sendRequest){
        var me = this;
	    if(sendRequest) Patient.unsetPatient(me.patient.pid);
	    me.currEncounterId = null;

	    if(me.patient.record) delete me.patient.record;

	    me.patient = {
		    pid: null,
		    pubpid: null,
		    name: null,
		    pic: null,
		    sex: null,
		    sexSymbol: null,
		    dob: null,
		    age: null,
		    eid: null,
		    priority: null,
		    readOnly: false,
		    rating: null,
		    record: null,
			covid_status: null,
			is_pregnant: null
	    };

	    me.patientButtonRemoveCls();
	    if(typeof callback == 'function'){
		    callback(true);
	    }else{
			// fire global event
		    me.fireEvent('patientunset');

		    var panels = me.MainPanel.items.items;
		    for(var i=0; i<panels.length; i++){
			    if(panels[i].pageRankingDiv) panels[i].pageRankingDiv.setValue(0);
		    }

		    if(me.patientCreateEncounterBtn) me.patientCreateEncounterBtn.disable();
		    if(me.patientSummaryBtn) me.patientSummaryBtn.disable();
		    if(me.patientOpenVisitsBtn) me.patientOpenVisitsBtn.disable();
		    if(me.patientCloseCurrEncounterBtn) me.patientCloseCurrEncounterBtn.disable();
		    if(me.patientChargeBtn) me.patientChargeBtn.disable();
		    if(me.patientCheckOutBtn) me.patientCheckOutBtn.disable();
		    me.patientButtonSet();
	    }
    },

    patientButtonSet: function(data){
        var me = this,
            patient = data || {},
	        displayPid = (eval(g('display_pubpid')) ? me.recordNumberRenderer(patient.pubpid) : patient.pid),
			patient_btn_icons_tpl = '';

	    if(displayPid == null || displayPid == ''){
		    displayPid = patient.pid;
	    }

		if(data){
			if(data.covid_status === 'vaccinated'){
				patient_btn_icons_tpl += '<img src="resources/images/icons/vacuid.png" alt="vaccinated" style="width: 24px; margin: 5px 0 0 -10px" />';
			}else if(data.covid_status === 'partially_vaccinated'){
				patient_btn_icons_tpl += '<img src="resources/images/icons/vacuid_partial.png" alt="partially vaccinated" style="width: 24px; margin: 5px 0 0 -10px;" />';
			}

			if(data.is_pregnant){
				patient_btn_icons_tpl += '<img src="resources/images/icons/pregnant.png" alt="pregnant" style="width: 24px; margin: 5px 0 0 5px" />';
			}else{

			}
		}

        me.patientBtn.update({
            displayPid: displayPid || 'record number',
            pid: patient.pid,
	        pic: patient.pic || me.patientImage,
            name: patient.name || _('no_patient_selected'),
			patient_btn_icons_tpl: patient_btn_icons_tpl,
			covid_status: patient.covid_status ? 'covid_status_' + patient.covid_status : ''
        });

	    me.patientButtonRemoveCls();
        if(patient.priority) me.patientBtn.addCls(data.priority);
        me.patientBtn.setDisabled(!patient.pid);
    },

    patientButtonRemoveCls: function(){
        var me = this;
        me.patientBtn.removeCls('Minimal');
        me.patientBtn.removeCls('Delayed');
        me.patientBtn.removeCls('Immediate');
        me.patientBtn.removeCls('Expectant');
        me.patientBtn.removeCls('Deceased');
    },

    patientBtnTpl: function(){
        return Ext.create('Ext.XTemplate',
            '<div class="patient_btn {priority} {covid_status}">',
            '   <div class="patient_btn_img">' +
            '       <img src="{pic}" width="50" height="50">' +
            '   </div>',
			'   <div class="patient_btn_icons">',
			'      {patient_btn_icons_tpl}',
			'   </div>',
            '   <div class="patient_btn_info">',
            '       <div class="patient_btn_name">{name}</div>',
            '       <div class="patient_btn_record">( {displayPid} )</div>',
            '   </div>',
            '</div>');
    },

    patientBtnRender: function(btn){
        this.patientButtonSet();
        this.initializePatientPoolDragZone(btn)
    },

    getPatientsInPoolArea: function(){

	    if(!a('use_pool_areas')) return;

        var me = this,
	        poolArea = me.patientPoolArea,
	        zones = me.getController('areas.PatientPoolAreas').getSelectedPoolAreaZones(),
	        height = 35;

	    this.patientPoolStore.load({
            params:{ uid: me.user.id, zones: zones },
            callback: function(records){

	            if(records.length >= 1){
                    for(var i = 0; i < records.length; i++){
                        height = height + 45;
                    }
                }else{
                    height = 25;
                }

                if(me.navColumn.collapsed === false && !me.navColumn.isCollapsingOrExpanding){
                    // height = (height > 300) ? 300 : height;
                    poolArea.down('dataview').refresh();
                    // poolArea.setHeight(height);
                }
            }
        });

	    if(me.nav['App_view_areas_PatientPoolAreas'].isVisible()) me.nav['App_view_areas_PatientPoolAreas'].reloadStores();
    },

    initializePatientPoolDragZone: function(panel){
        panel.dragZone = Ext.create('Ext.dd.DragZone', panel.getEl(), {
            ddGroup: 'patientPoolAreas',
            getDragData: function(){

	            if(app.patient.pid){
                    var sourceEl = panel.getEl().dom,
	                    msgDiv, msg;

                    if(sourceEl){
	                    msgDiv = document.createElement('div');
	                    msgDiv.id = Ext.id();
	                    msgDiv.innerHTML = _('drag_patient_to_new_area');

	                    return panel.dragData = {
                            copy: true,
                            sourceEl: sourceEl,
                            repairXY: Ext.fly(sourceEl).getXY(),
                            ddel: msgDiv,
                            records: [ panel.data ],
                            patient: true
                        };
                    }
                }
            },

            getRepairXY: function(){
//                app.nav.goBack();
                return this.dragData.repairXY;
            },

	        onBeforeDrag:function(){
		        app.nav.navigateTo('App.view.areas.PatientPoolAreas');
		        return true;
            }
        });
    },

	onEncounterDragZoneRender:function(panel){
		this.initializeOpenEncounterDragZone(panel);

		if(this.enablePoolAreaFadeInOut){

			panel.el.setStyle({	opacity: 0.1 });

			panel.el.on('mouseenter', function(event, el){
				panel.el.setStyle({	opacity: 1 });
			});

			panel.el.on('mouseleave', function(event, el){
				panel.el.setStyle({	opacity: 0.1 });
			});
		}
	},

    /**
     *
     * @param panel
     */
    initializeOpenEncounterDragZone: function(panel){
        panel.dragZone = Ext.create('Ext.dd.DragZone', panel.getEl(), {
            ddGroup: 'patient',
            newGroupReset: true,
            b4MouseDown: function(e){
                if(this.newGroupReset){
                    var sourceEl = e.getTarget(panel.itemSelector, 10), patientData = panel.getRecord(sourceEl).data;
                    this.removeFromGroup(this.ddGroup);
//                    say('drag record:');
//                    say(patientData);
                    if(patientData.floorPlanId != 0 && patientData.patientZoneId == 0){
                        app.nav.navigateTo('App.view.areas.FloorPlan');
                        this.ddGroup = 'patientPoolAreas';
                    }else{
                        this.ddGroup = 'patient';
                        app.MainPanel.el.mask(_('drop_here_to_open') + ' <strong>"' + panel.getRecord(sourceEl).data.shortName + '"</strong> ' + _('current_encounter'));
                    }
                    this.addToGroup(this.ddGroup);
                    this.newGroupReset = false;
                }
                this.autoOffset(e.getPageX(), e.getPageY());
            },
            endDrag: function(e){
                this.newGroupReset = true;
            },
            getDragData: function(e){
                var sourceEl = e.getTarget(panel.itemSelector, 10),
	                d,
	                patientData = panel.getRecord(sourceEl).data;

                if(sourceEl){
                    d = sourceEl.cloneNode(true);
                    d.id = Ext.id();
                    return panel.dragData = {
                        sourceEl: sourceEl,
                        repairXY: Ext.fly(sourceEl).getXY(),
                        ddel: d,
                        patientData: patientData
                    };
                }
                return false;
            },
            getRepairXY: function(){
                app.MainPanel.el.unmask();
                this.newGroupReset = true;
                return this.dragData.repairXY;
            }
        });
    },

    onDocumentView: function(id, type, site){
	    app.getController('DocumentViewer').doDocumentView(id, type, site);
    },

    /**
     *
     * @param panel
     */
    initializeOpenEncounterDropZone: function(panel){
        var me = this;
        panel.dropZone = Ext.create('Ext.dd.DropZone', panel.getEl(), {
            ddGroup: 'patient',

            notifyOver: function(dd, e, data){
                return Ext.dd.DropZone.prototype.dropAllowed;
            },

            notifyDrop: function(dd, e, data){
                app.MainPanel.el.unmask();

	            if(data.patientData.eid && data.patientData.poolArea == 'Check Out'){
                    //...
	            }else if(data.patientData.eid && a('access_encounters')){
	            }else if(data.patientData.floorPlanId === null || data.patientData.floorPlanId === 0){
	            }

	            me.setPatient(data.patientData.pid, data.patientData.eid, null, function(){
                    // if encounter id is set and pool area is check out....  go to Patient Checkout panel
                    if(data.patientData.eid && data.patientData.poolArea == 'Checkout'){
                        me.checkOutPatient(data.patientData.eid);
                    // if encounter id is set and and user has access to encounter area... go to Encounter panel
                    // and open the encounter
                    }else if(data.patientData.eid && a('access_encounters')){
                        me.openEncounter(data.patientData.eid);
                    // else go to patient summary
                    }else{
                        me.openPatientSummary();
                    }
                });
            }
        });
    },

	/**
     * When the application finishes loading all the MD Timeline core.
     * Then it will load all the modules.
     */
    appRender: function(){
        this.loadModules();
    },

    /**
     * Load all the modules on the modules folder.
     * This folder will hold modules created by third-party.
     */
    loadModules: function(){
        Modules.getEnabledModules(function(provider, response){
            var modules = response.result;
            for(var i = 0; i < modules.length; i++){
	            try{
		            app.getController('Modules.' + modules[i].dir + '.Main');
	            }catch(error){
					app.msg(_('oops'), (_('unable_to_load_module') + ' ' + modules[i].title + '<br>Error: ' +  error), true);
	            }
            }
	        app.doLayout();
        });
    },

    removeAppMask: function(){
        if(Ext.get('mainapp-loading')) Ext.get('mainapp-loading').remove();
        if(Ext.get('mainapp-loading-mask')) Ext.get('mainapp-loading-mask').remove();
    },

    beforeAppRender: function(){
	    var me = this,
		    params = me.nav.getUrlParams();

	    //say(params);

		if(params[1]){
			me.setPatient(params[1], null, null, function(){
				Ext.Function.defer(function(){
					me.nav.navigateTo('App.view.patient.Summary');
				}, 500);

			});
		}else{
			me.unsetPatient(null, false);
		}
    },

    getCurrPatient: function(){
        return this.patient.pid;
    },

    getApp: function(){
        return this;
    },

    /**
     * Access denied massage.
     */
    accessDenied: function(){
        Ext.Msg.show({
            title: _('oops'),
            msg: _('access_denied'),
            buttons: Ext.Msg.OK,
            icon: Ext.Msg.ERROR
        });
    },

	msg: function(title, format, error, persistent) {
		var msgBgCls = (error === true) ? 'msg-red' : 'msg-green';

		if(typeof error === 'string') msgBgCls = 'msg-' + error;

		this.msgCt = Ext.get('msg-div');
		if(!this.msgCt) this.msgCt = Ext.fly('msg-div');

		var s = Ext.String.format.apply(String, Array.prototype.slice.call(arguments, 1)),
			m = Ext.core.DomHelper.append(this.msgCt, {
				html: '<div class="flyMsg ' + msgBgCls + '"><h3>' + (title || '') + '</h3><p>' + s + '</p></div>'
			}, true);

		this.msgCt.alignTo(document, 't-t');

		// if persitent return the message element without the fade animation
		if (persistent === true) return m;

		m.addCls('fadeded');

		Ext.create('Ext.fx.Animator', {
			target: m,
			duration: error ? 8000 : 3000,
			keyframes: {
				0: { opacity: 0 },
				10: { opacity: 1 },
				80: { opacity: 1 },
				100: { opacity: 0, height: 0 }
			},
			listeners: {
				afteranimate: function(anim) {
					anim.target.target.destroy();
				}
			}
		});

		m.on('click', function(){
			m.applyStyles('visibility:hidden; display:none');
		});

		return true;
	},

    alert: function(msg, icon){
        if(icon == 'error'){
            icon = Ext.Msg.ERROR;
        }else if(icon == 'warning'){
            icon = Ext.Msg.WARNING;
        }else if(icon == 'question'){
            icon = Ext.Msg.QUESTION;
        }else{
            icon = Ext.Msg.INFO;
        }

        Ext.Msg.show({
            msg: msg,
            buttons: Ext.Msg.OK,
            icon: icon,
	        maxWidth: 1200,
	        modal: false
        });
    },

	fullname: function(title, fname, name, lname){
		var foo = '';
		if(title){
			foo += title + ' ';
		}
		if(fname){
			foo += fname + ' ';
		}
		if(name){
			foo += name + ' ';
		}
		if(lname){
			foo += lname + ' ';
		}
		return foo;
	},

	recordNumberRenderer: function(record_number){

		if(!record_number) return record_number;
		if(this.record_flags.TOTAL_FALGS === 0) return record_number;

		if(this.record_flags.NUM_LENGTH){
			var rec_buff = record_number.split('-');
			if(rec_buff.length == 3){
				rec_buff[1] = rec_buff[1].substring(rec_buff[1].length - this.record_flags.NUM_LENGTH);
			}
			record_number = rec_buff.join('-');
		}

		if(this.record_flags.STRIP_DASHES){
			record_number = record_number.replace(/-/g,'');
		}

		return record_number;

	},

	getDate: function () {
		return this.getController('Clock').getDate();
	},

    calculateAge: function(base_date, dob_date) {
		var birthday = +new Date(dob_date);
		return~~ ((Ext.Date.now(base_date) - birthday) / (31557600000));
	},

	getAge: function (dob, age_at) {

		var _dob = new Date(dob);
		var _aad = age_at ? new Date(age_at) : new Date();
		var daysInMonth = 30.436875; // Days in a month on average.

		var yearAad = _aad.getFullYear();
		var yearDob = _dob.getFullYear();
		var years = yearAad - yearDob; // Get age in years.
		_dob.setFullYear(yearAad); // Set birthday for this year.
		var aadMillis = _aad.getTime();
		var dobMillis = _dob.getTime();
		if (aadMillis < dobMillis) {
			--years;
			_dob.setFullYear(yearAad - 1); // Set to previous year's birthday
			dobMillis = _dob.getTime();
		}
		var days = (aadMillis - dobMillis) / 86400000;
		var monthsDec = days / daysInMonth; // Months with remainder.
		var months = Math.floor(monthsDec); // Remove fraction from month.
		days = Math.floor(daysInMonth * (monthsDec - months));
		return {years: years, months: months, days: days};
	},

	uuidv4: function () {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}

});

Ext.define('App.ux.combo.ReferringProviders', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.referringproviderscombo',
	displayField: 'fullname',
	valueField: 'id',
	initComponent: function(){
		var me = this;

		Ext.define('ReferringProvidersModel', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id',
					type: 'int'
				},
				{
					name: 'title',
					type: 'string'
				},
				{
					name: 'fname',
					type: 'string'
				},
				{
					name: 'mname',
					type: 'string'
				},
				{
					name: 'lname',
					type: 'string'
				},
				{
					name: 'fullname',
					type: 'string',
					convert: function(v, record){
						return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
					}
				}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'ReferringProviders.getReferringProviders'
				},
				reader: {
					root: 'data'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'ReferringProvidersModel',
			autoLoad: false
		});

		Ext.apply(this, {
			emptyText: _('select'),
			store: me.store
		});

		me.callParent(arguments);
	}
});
Ext.define('App.controller.patient.PatientNotes', {
	extend: 'Ext.app.Controller',
	requires: [

	],
	refs: [
		{
			ref: 'PatientNotesGrid',
			selector: '#PatientNotesGrid'
		},
		{
			ref: 'PatientNotesWindow',
			selector: '#PatientNotesWindow'
		},
		{
			ref: 'PatientNotesGridAddNotesBtn',
			selector: '#PatientNotesGridAddNotesBtn'
		},
		{
			ref: 'PatientNotesWindowCloseBtn',
			selector: '#PatientNotesWindowCloseBtn'
		},
		{
			ref: 'PatientNotesGridNotesContextMenuDetailLog',
			selector: '#PatientNotesGridNotesContextMenuDetailLog'
		}
	],

	init: function(){
		var me = this;
		me.auditLogCtrl = app.getController('administration.TransactionLog');

		me.control({
			'#PatientNotesGrid': {
				activate: me.onPatientNotesGridActivate,
				beforeitemcontextmenu: me.onPatientNotesGridContextMenu,
				beforeedit: me.onPatientNotesGridBeforeEdit,
				validateedit: me.onPatientNotesGridValidateEdit,
				beforerender: me.onPatientNotesGridBeforeRender
			},
			'#PatientNotesWindow': {
				show: me.onPatientNotesWindowShow
			},
			'#PatientNotesWindowCloseBtn': {
				click: me.onPatientNotesWindowCloseBtnClick
			},
			'#PatientNotesGridNotesContextMenuDetailLog': {
				click: me.onPatientNotesGridContextMenuDetailLogClick
			},
			'#PatientNotesGridAddNotesBtn': {
				click: me.onPatientNotesGridAddNotesBtn
			}
		});
	},

	onPatientNotesWindowShow: function (win){
		this.doFilterGrid(win.down('grid'));
	},

	// onDoctorsNotesGridBeforeRender: function(grid){
	// 	app.on('patientunset', function(){
	// 		grid.getStore().removeAll();
	// 	});
	// },

	onPatientNotesGridActivate: function (grid){
		this.doFilterGrid(grid);
	},

	onAddNew: function(btn){
		var grid = btn.up('grid'),
			store = grid.store,
			record;

		if(btn.action == 'disclosure'){
			record = {
				date: new Date(),
				pid: app.patient.pid,
				global_id: app.uuidv4(),
				active: 1
			};
		}else if(btn.action == 'note'){
			record = {
				date: new Date(),
				create_date: new Date(),
				pid: app.patient.pid,
				create_uid: app.user.id,
				uid: app.user.id,
				eid: app.patient.eid,
				global_id: app.uuidv4(),
				user_fname: app.user.fname,
				user_mname: app.user.mname,
				user_lname: app.user.lname,
			};
		}

		grid.plugins[0].cancelEdit();
		store.insert(0, record);
		grid.plugins[0].startEdit(0, 0);
	},

	onPatientNotesGridBeforeEdit: function(editor, context, eOpts ){
		if (!a('edit_patient_notes')) {
			app.msg(_('oops'), _('not_authorized'), true);
			return false;
		}
	},

	onPatientNotesGridValidateEdit: function(editor, context, eOpts ){
		context.record.data.update_user_fname 	= app.user.fname;
		context.record.data.update_user_mname 	= app.user.mname;
		context.record.data.update_user_lname 	= app.user.lname;
		context.record.data.update_date 		= app.getDate();
		context.record.data.update_uid 			= app.user.id;
	},

	onPatientNotesGridContextMenu: function (grid, record, item, index, e) {
		e.preventDefault();

		this.showPatientNotesGridContextMenu(grid,record, e);
	},

	showPatientNotesGridContextMenu: function (patient_notes_panel_grid, patient_notes_panel_record, e) {
		if (!a('access_patient_notes_transaction_log')) return;

		var me = this;

		me.PatientNotesGridContextMenu = Ext.widget('menu', {
			margin: '0 0 10 0',
			items: [
				{
					text: _('transaction_log'),
					icon: 'modules/billing/resources/images/icoList.png',
					itemId: 'PatientNotesGridNotesContextMenuDetailLog',
					acl: true
				}
			]
		});

		me.PatientNotesGridContextMenu.patient_notes_panel_grid = patient_notes_panel_grid;
		me.PatientNotesGridContextMenu.patient_notes_panel_record = patient_notes_panel_record;

		me.PatientNotesGridContextMenu.showAt(e.getXY());

		return me.PatientNotesGridContextMenu;
	},

	onPatientNotesGridContextMenuDetailLogClick: function(btn) {
		var me = this,
			patient_notes_panel_record = btn.parentMenu.patient_notes_panel_record;

		this.auditLogCtrl.doTransactionLogDetailByTableAndPk(patient_notes_panel_record.table.name, patient_notes_panel_record.get('id'));

	},

	onPatientNotesWindowCloseBtnClick: function () {
		//this.getPatientNotesGrid().getStore().rejectChanges();
		this.getPatientNotesWindow().close();
	},

	onPatientNotesGridAddNotesBtn: function(btn){
		var grid = btn.up('grid'),
			store = grid.store,
			record;

		say(btn);

		if(btn.action == 'disclosure'){
			record = {
				date: new Date(),
				pid: app.patient.pid,
				global_id: app.uuidv4(),
				active: 1
			};
		}else if(btn.action == 'note'){
			record = {
				date: new Date(),
				create_date: new Date(),
				pid: app.patient.pid,
				create_uid: app.user.id,
				uid: app.user.id,
				eid: app.patient.eid,
				global_id: app.uuidv4(),
				user_fname: app.user.fname,
				user_mname: app.user.mname,
				user_lname: app.user.lname,
			};
		}

		grid.plugins[0].cancelEdit();
		store.insert(0, record);
		grid.plugins[0].startEdit(0, 0);
	},

	onPatientNotesGridBeforeRender: function(grid) {
		// this.doFilterGrid(grid);
	},

	doFilterGrid: function (grid){
		var store = grid.getStore();
		store.clearFilter(true);
		store.filter([
			{
				property: 'pid',
				value: app.patient.pid
			}
		]);
	},

	showPatientNotesWindow: function () {
		if(!this.getPatientNotesWindow()){
			Ext.create('App.view.patient.windows.PatientNotesWindow');
		}
		return this.getPatientNotesWindow().show();
	}
});
Ext.define('App.ux.combo.RolesGroups', {
	extend: 'Ext.form.ComboBox',
	alias: 'widget.mitos.rolesgroupscombo',
	editable: false,
	queryMode: 'local',
	valueField: 'id',
	displayField: 'title',
	emptyText: _('select'),
	includeAllOption: false,
	initComponent: function () {
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: true,
			fields: [
				{name: 'id', type: 'int'},
				{name: 'title', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'CombosData.getRolesGroups'
				},
				extraParams: {
					includeAllOption: me.includeAllOption
				}
			}
		});

		me.callParent(arguments);
	}
});
Ext.define('App.ux.LiveLoincRadiologyCodesSearch', {
	extend: 'Ext.form.ComboBox',
	requires: [

	],
	xtype: 'liveloincradiologycodessearch',
	hideLabel: true,
	displayField: 'LongCommonName',
	valueField: 'LoincNumber',
	emptyText: _('search') + '...',
	// maxLength: 300,
	typeAhead: false,
	hideTrigger: false,
	minChars: 1,
	queryDelay: 1000,
	forceSelection:true,
	acl: null,

	trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',

	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.administration.LoincRadiologyCodes');

		Ext.apply(me, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><b>{LoincNumber}:</b>  {LongCommonName}</div>'
				}
			},
			pageSize: 10
		});

		me.callParent();
	},

	onTrigger1Click : function(){
		var me = this;
		me.setValue('');
		me.store.removeAll();
		me.store.commitChanges();
		me.updateLayout();
		me.fireEvent('reset', me);

	}
});
Ext.define('App.ux.LiveCPTRadiologyCodesSearch', {
	extend: 'Ext.form.ComboBox',
	requires: [

	],
	xtype: 'livecptradiologycodessearch',
	hideLabel: true,
	displayField: 'code_text_short',
	valueField: 'code',
	emptyText: _('search') + '...',
	typeAhead: false,
	hideTrigger: false,
	minChars: 1,
	queryDelay: 1000,
	acl: null,
	queryParam: 'radiology_query',
	trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',

	initComponent: function(){
		var me = this;

		me.store = Ext.create('App.store.administration.CPT');

		Ext.apply(me, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function(){
					return '<div class="search-item"><b>{code}:</b>  {code_text_short}</div>'
				}
			},
			pageSize: 10
		});

		me.callParent();
	},

	onTrigger1Click : function(){
		var me = this;
		me.setValue('');
		me.store.removeAll();
		me.store.commitChanges();
		me.updateLayout();
		me.fireEvent('reset', me);

	}
});
Ext.define('App.ux.form.fields.HtmlEditor', {
	extend: 'Ext.form.field.HtmlEditor',
	alias: 'widget.customhtmleditor',


	componentTpl: [
		'{beforeTextAreaTpl}',
		'<textarea id="{id}-textareaEl" name="{name}" tabIndex="-1" {inputAttrTpl}',
		' class="{textareaCls}" autocomplete="off" >',
		'{[Ext.util.Format.htmlEncode(values.value)]}',
		'</textarea>',
		'{afterTextAreaTpl}',
		'{beforeIFrameTpl}',
		'<iframe id="{id}-iframeEl" name="{iframeName}" frameBorder="0" data-nusa-enabled="true" data-nusa-custom-container-type="Frame_Type" {iframeAttrTpl}',
		' src="{iframeSrc}" class="{iframeCls}"></iframe>',
		'<div id="{id}-editEl" data-nusa-enabled="true" data-nusa-custom-container-id="{id}-iframeEl" data-nusa-custom-control-type="Control_Type"></div>',
		'{afterIFrameTpl}',
		{
			disableFormats: true
		}
	],

	getDocMarkup: function() {
		var me = this,
			h = me.iframeEl.getHeight() - me.iframePad * 2,
			oldIE = Ext.isIE8m;

		// - IE9+ require a strict doctype otherwise text outside visible area can't be selected.
		// - Opera inserts <P> tags on Return key, so P margins must be removed to avoid double line-height.
		// - On browsers other than IE, the font is not inherited by the IFRAME so it must be specified.
		return Ext.String.format(
				(oldIE ? '' : '<!DOCTYPE html>')
				+ '<html><head><style type="text/css">'
				+ (Ext.isOpera ? 'p{margin:0}' : '')
				+ 'body{border:0;margin:0;padding:{0}px;direction:' + (me.rtl ? 'rtl;' : 'ltr;')
				+ (oldIE ? Ext.emptyString : 'min-')
				+ 'height:{1}px;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;cursor:text;background-color:white;'
				+ (Ext.isIE ? '' : 'font-size:12px;font-family:{2}')
				+ '}</style></head><body contentEditable="true" ></body></html>'
			, me.iframePad, h, me.defaultFont);
	},

	/**
	 * @overriden method
	 * Initialize the events
	 */
	initEvents: function(){
		var me = this;

		me.callParent(arguments);

		me.on({
			scope: me,
			initialize: me.onInitializeHtmlEditor
		});
	},

	/**
	 * Attach the custom events
	 */
	onInitializeHtmlEditor: function(){
		var me = this,
			frameWin = me.getWin(),
			fnBlur = Ext.bind(me.onHtmlEditorBlur, me),
			fnFocus = Ext.bind(me.onHtmlEditorFocus, me);
		if(frameWin.attachEvent){
			frameWin.addEventListener('blur', fnBlur);
			frameWin.addEventListener('focus', fnFocus);
		}
		else{
			frameWin.addEventListener('blur', fnBlur, false);
			frameWin.addEventListener('focus', fnFocus, false);
		}
	},

	/**
	 * Method which will fire the event "blur"
	 */
	onHtmlEditorBlur: function(event){
		this.fireEvent('blur', this);
	},

	/**
	 * Method which will fire the event "blur"
	 */
	onHtmlEditorFocus: function(event){
		this.fireEvent('focus', this);
	}
});

Ext.define('App.ux.form.fields.BoxSelect', {
    extend:'Ext.form.field.ComboBox',
    alias: ['widget.comboboxselect', 'widget.boxselect'],
    requires: ['Ext.selection.Model', 'Ext.data.Store'],

    //
    // Begin configuration options related to the underlying store
    //

    /**
     * @cfg {String} valueParam
     * The name of the parameter used to load unknown records into the store. If left unspecified, {@link #valueField}
     * will be used.
     */

    //
    // End of configuration options related to the underlying store
    //



    //
    // Begin configuration options related to selected values
    //

    /**
     * @cfg {Boolean}
     * If set to `true`, allows the combo field to hold more than one value at a time, and allows selecting multiple
     * items from the dropdown list. The combo's text field will show all selected values using the template
     * defined by {@link #labelTpl}.
     *

     */
    multiSelect: true,

    /**
     * @cfg {String/Ext.XTemplate} labelTpl
     * The [XTemplate](http://docs.sencha.com/ext-js/4-1/#!/api/Ext.XTemplate) to use for the inner
     * markup of the labelled items. Defaults to the configured {@link #displayField}
     */

    /**
	 * @cfg {Boolean}
     * @inheritdoc
     *
     * When {@link #forceSelection} is `false`, new records can be created by the user as they
     * are typed. These records are **not** added to the combo's store. This creation
     * is triggered by typing the configured 'delimiter', and can be further configured using the
     * {@link #createNewOnEnter} and {@link #createNewOnBlur} configuration options.
     *
     * This functionality is primarily useful with BoxSelect components for things
     * such as an email address.
     */
    forceSelection: true,

    /**
	 * @cfg {Boolean}
     * Has no effect if {@link #forceSelection} is `true`.
     *
	 * With {@link #createNewOnEnter} set to `true`, the creation described in
     * {@link #forceSelection} will also be triggered by the 'enter' key.
	 */
    createNewOnEnter: false,

    /**
	 * @cfg {Boolean}
     * Has no effect if {@link #forceSelection} is `true`.
     *
     * With {@link #createNewOnBlur} set to `true`, the creation described in
     * {@link #forceSelection} will also be triggered when the field loses focus.
     *
     * Please note that this behavior is also affected by the configuration options
     * {@link #autoSelect} and {@link #selectOnTab}. If those are true and an existing
     * item would have been selected as a result, the partial text the user has entered will
	 * be discarded and the existing item will be added to the selection.
	 */
    createNewOnBlur: false,

    /**
     * @cfg {Boolean}
     * Has no effect if {@link #multiSelect} is `false`.
     *
     * Controls the formatting of the form submit value of the field as returned by {@link #getSubmitValue}
     *
     * - `true` for the field value to submit as a json encoded array in a single GET/POST variable
     * - `false` for the field to submit as an array of GET/POST variables
     */
    encodeSubmitValue: false,

    //
    // End of configuration options related to selected values
    //



    //
    // Configuration options related to pick list behavior
    //

    /**
     * @cfg {Boolean}
     * `true` to activate the trigger when clicking in empty space in the field. Note that the
     * subsequent behavior of this is controlled by the field's {@link #triggerAction}.
     * This behavior is similar to that of a basic ComboBox with {@link #editable} `false`.
     */
    triggerOnClick: true,

    /**
	 * @cfg {Boolean}
     * - `true` to have each selected value fill to the width of the form field
     * - `false to have each selected value size to its displayed contents
	 */
    stacked: false,

    /**
	 * @cfg {Boolean}
     * Has no effect if {@link #multiSelect} is `false`
     *
     * `true` to keep the pick list expanded after each selection from the pick list
     * `false` to automatically collapse the pick list after a selection is made
	 */
    pinList: true,

    /**
     * @cfg {Boolean}
     * True to hide the currently selected values from the drop down list. These items are hidden via
     * css to maintain simplicity in store and filter management.
     *
     * - `true` to hide currently selected values from the drop down pick list
     * - `false` to keep the item in the pick list as a selected item
     */
    filterPickList: false,

    //
    // End of configuration options related to pick list behavior
    //



    //
    // Configuration options related to text field behavior
    //

    /**
     * @cfg {Boolean}
     * @inheritdoc
     */
    selectOnFocus: true,

    /**
     * @cfg {Boolean}
     *
     * `true` if this field should automatically grow and shrink vertically to its content.
     * Note that this overrides the natural trigger grow functionality, which is used to size
     * the field horizontally.
     */
    grow: true,

    /**
     * @cfg {Number/Boolean}
     * Has no effect if {@link #grow} is `false`
     *
     * The minimum height to allow when {@link #grow} is `true`, or `false` to allow for
     * natural vertical growth based on the current selected values. See also {@link #growMax}.
     */
    growMin: false,

    /**
     * @cfg {Number/Boolean}
     * Has no effect if {@link #grow} is `false`
     *
     * The maximum height to allow when {@link #grow} is `true`, or `false` to allow for
     * natural vertical growth based on the current selected values. See also {@link #growMin}.
     */
    growMax: false,

    /**
     * @cfg growAppend
     * @hide
     * Currently unsupported by BoxSelect since this is used for horizontal growth and
     * BoxSelect only supports vertical growth.
     */
    /**
     * @cfg growToLongestValue
     * @hide
     * Currently unsupported by BoxSelect since this is used for horizontal growth and
     * BoxSelect only supports vertical growth.
     */

    //
    // End of configuration options related to text field behavior
    //


    //
    // Event signatures
    //

    /**
     * @event autosize
     * Fires when the **{@link #autoSize}** function is triggered and the field is resized according to the
     * {@link #grow}/{@link #growMin}/{@link #growMax} configs as a result. This event provides a hook for the
     * developer to apply additional logic at runtime to resize the field if needed.
     * @param {Ext.ux.form.field.BoxSelect} this This BoxSelect field
     * @param {Number} height The new field height
     */

    //
    // End of event signatures
    //



    //
    // Configuration options that will break things if messed with
    //

    /**
     * @private
     */
    fieldSubTpl: [
        '<div id="{cmpId}-listWrapper" class="x-boxselect {fieldCls} {typeCls}">',
        '<ul id="{cmpId}-itemList" class="x-boxselect-list x-tab-default">',
        '<li id="{cmpId}-inputElCt" class="x-boxselect-input">',
        '<div id="{cmpId}-emptyEl" class="{emptyCls}">{emptyText}</div>',
        '<input id="{cmpId}-inputEl" type="{type}" ',
        '<tpl if="name">name="{name}" </tpl>',
        '<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>',
        '<tpl if="size">size="{size}" </tpl>',
        '<tpl if="tabIdx">tabIndex="{tabIdx}" </tpl>',
        '<tpl if="disabled"> disabled="disabled"</tpl>',
        'class="x-boxselect-input-field {inputElCls}" autocomplete="off">',
        '</li>',
        '</ul>',
        '</div>',
        {
            compiled: true,
            disableFormats: true
        }
    ],

    /**
     * @private
     */
    childEls: [ 'listWrapper', 'itemList', 'inputEl', 'inputElCt', 'emptyEl' ],

    /**
     * @private
     */
    componentLayout: 'boxselectfield',

    /**
     * @private
     */
    emptyInputCls: 'x-boxselect-emptyinput',

    /**
     * @inheritdoc
     *
     * Initialize additional settings and enable simultaneous typeAhead and multiSelect support
     * @protected
	 */
    initComponent: function() {
        var me = this,
        typeAhead = me.typeAhead;

        if (typeAhead && !me.editable) {
            Ext.Error.raise('If typeAhead is enabled the combo must be editable: true -- please change one of those settings.');
        }

        Ext.apply(me, {
            typeAhead: false
        });

        me.callParent();

        me.typeAhead = typeAhead;

        me.selectionModel = new Ext.selection.Model({
            store: me.valueStore,
            mode: 'MULTI',
            lastFocused: null,
            onSelectChange: function(record, isSelected, suppressEvent, commitFn) {
                commitFn();
            }
        });

        if (!Ext.isEmpty(me.delimiter) && me.multiSelect) {
            me.delimiterRegexp = new RegExp(String(me.delimiter).replace(/[$%()*+.?\[\\\]{|}]/g, "\\$&"));
        }
    },

    /**
	 * Register events for management controls of labelled items
     * @protected
	 */
    initEvents: function() {
        var me = this;

        me.callParent(arguments);

        if (!me.enableKeyEvents) {
            me.mon(me.inputEl, 'keydown', me.onKeyDown, me);
        }
        me.mon(me.inputEl, 'paste', me.onPaste, me);
        me.mon(me.listWrapper, 'click', me.onItemListClick, me);

        // I would prefer to use relayEvents here to forward these events on, but I want
        // to pass the field instead of exposing the underlying selection model
        me.mon(me.selectionModel, {
            'selectionchange': function(selModel, selectedRecs) {
                me.applyMultiselectItemMarkup();
                me.fireEvent('valueselectionchange', me, selectedRecs);
            },
            'focuschange': function(selectionModel, oldFocused, newFocused) {
                me.fireEvent('valuefocuschange', me, oldFocused, newFocused);
            },
            scope: me
        });
    },

    /**
     * @inheritdoc
     *
	 * Create a store for the records of our current value based on the main store's model
     * @protected
	 */
    onBindStore: function(store, initial) {
        var me = this;

        if (store) {
            me.valueStore = new Ext.data.Store({
                model: store.model,
                proxy: {
                    type: 'memory'
                }
            });
            me.mon(me.valueStore, 'datachanged', me.applyMultiselectItemMarkup, me);
            if (me.selectionModel) {
                me.selectionModel.bindStore(me.valueStore);
            }
        }
    },

    /**
     * @inheritdoc
     *
     * Remove the selected value store and associated listeners
     * @protected
     */
    onUnbindStore: function(store) {
        var me = this,
        valueStore = me.valueStore;

        if (valueStore) {
            if (me.selectionModel) {
                me.selectionModel.setLastFocused(null);
                me.selectionModel.deselectAll();
                me.selectionModel.bindStore(null);
            }
            me.mun(valueStore, 'datachanged', me.applyMultiselectItemMarkup, me);
            valueStore.destroy();
            me.valueStore = null;
        }

        me.callParent(arguments);
    },

    /**
     * @inheritdoc
     *
	 * Add refresh tracking to the picker for selection management
     * @protected
	 */
    createPicker: function() {
        var me = this,
        picker = me.callParent(arguments);

        me.mon(picker, {
            'beforerefresh': me.onBeforeListRefresh,
            scope: me
        });

        if (me.filterPickList) {
            picker.addCls('x-boxselect-hideselections');
        }

        return picker;
    },

    /**
     * @inheritdoc
     *
	 * Clean up selected values management controls
     * @protected
	 */
    onDestroy: function() {
        var me = this;

        Ext.destroyMembers(me, 'valueStore', 'selectionModel');

        me.callParent(arguments);
    },

    /**
     * Add empty text support to initial render.
     * @protected
     */
    getSubTplData: function() {
        var me = this,
            data = me.callParent(),
            isEmpty = me.emptyText && data.value.length < 1;

        data.value = '';
        if (isEmpty) {
            data.emptyText = me.emptyText;
            data.emptyCls = me.emptyCls;
            data.inputElCls = me.emptyInputCls;
        } else {
            data.emptyText = '';
            data.emptyCls = me.emptyInputCls;
            data.inputElCls = '';
        }

        return data;
    },

    /**
     * @inheritdoc
     *
	 * Overridden to avoid use of placeholder, as our main input field is often empty
     * @protected
	 */
    afterRender: function() {
        var me = this;

        if (Ext.supports.Placeholder && me.inputEl && me.emptyText) {
            delete me.inputEl.dom.placeholder;
        }

        me.bodyEl.applyStyles('vertical-align:top');

        if (me.grow) {
            if (Ext.isNumber(me.growMin) && (me.growMin > 0)) {
                me.listWrapper.applyStyles('min-height:'+me.growMin+'px');
            }
            if (Ext.isNumber(me.growMax) && (me.growMax > 0)) {
                me.listWrapper.applyStyles('max-height:'+me.growMax+'px');
            }
        }

        if (me.stacked === true) {
            me.itemList.addCls('x-boxselect-stacked');
        }

        if (!me.multiSelect) {
            me.itemList.addCls('x-boxselect-singleselect');
        }

        me.applyMultiselectItemMarkup();

        me.callParent(arguments);
    },

    /**
	 * Overridden to search entire unfiltered store since already selected values
     * can span across multiple store page loads and other filtering. Overlaps
     * some with {@link #isFilteredRecord}, but findRecord is used by the base component
     * for various logic so this logic is applied here as well.
     * @protected
	 */
    findRecord: function(field, value) {
        var ds = this.store,
        matches;

        if (!ds) {
            return false;
        }

        matches = ds.queryBy(function(rec, id) {
            return rec.isEqual(rec.get(field), value);
        });

        return (matches.getCount() > 0) ? matches.first() : false;
    },

    /**
	 * Overridden to map previously selected records to the "new" versions of the records
	 * based on value field, if they are part of the new store load
     * @protected
	 */
    onLoad: function() {
        var me = this,
        valueField = me.valueField,
        valueStore = me.valueStore,
        changed = false;

        if (valueStore) {
            if (!Ext.isEmpty(me.value) && (valueStore.getCount() == 0)) {
                me.setValue(me.value, false, true);
            }

            valueStore.suspendEvents();
            valueStore.each(function(rec) {
                var r = me.findRecord(valueField, rec.get(valueField)),
                i = r ? valueStore.indexOf(rec) : -1;
                if (i >= 0) {
                    valueStore.removeAt(i);
                    valueStore.insert(i, r);
                    changed = true;
                }
            });
            valueStore.resumeEvents();
            if (changed) {
                valueStore.fireEvent('datachanged', valueStore);
            }
        }

        me.callParent(arguments);
    },

    /**
	 * Used to determine if a record is filtered out of the current store's data set,
     * for determining if a currently selected value should be retained.
     *
     * Slightly complicated logic. A record is considered filtered and should be retained if:
     *
     * - It is not in the combo store and the store has no filter or it is in the filtered data set
     *   (Happens when our selected value is just part of a different load, page or query)
     * - It is not in the combo store and forceSelection is false and it is in the value store
     *   (Happens when our selected value was created manually)
     *
	 * @private
	 */
    isFilteredRecord: function(record) {
        var me = this,
        store = me.store,
        valueField = me.valueField,
        storeRecord,
        filtered = false;

        storeRecord = store.findExact(valueField, record.get(valueField));

        filtered = ((storeRecord === -1) && (!store.snapshot || (me.findRecord(valueField, record.get(valueField)) !== false)));

        filtered = filtered || (!filtered && (storeRecord === -1) && (me.forceSelection !== true) &&
            (me.valueStore.findExact(valueField, record.get(valueField)) >= 0));

        return filtered;
    },

    /**
     * @inheritdoc
     *
	 * Overridden to allow for continued querying with multiSelect selections already made
     * @protected
	 */
    doRawQuery: function() {
        var me = this,
        rawValue = me.inputEl.dom.value;

        if (me.multiSelect) {
            rawValue = rawValue.split(me.delimiter).pop();
        }

        this.doQuery(rawValue, false, true);
    },

    /**
	 * When the picker is refreshing, we should ignore selection changes. Otherwise
	 * the value of our field will be changing just because our view of the choices is.
     * @protected
	 */
    onBeforeListRefresh: function() {
        this.ignoreSelection++;
    },

    /**
	 * When the picker is refreshing, we should ignore selection changes. Otherwise
	 * the value of our field will be changing just because our view of the choices is.
     * @protected
	 */
    onListRefresh: function() {
        this.callParent(arguments);
        if (this.ignoreSelection > 0) {
            --this.ignoreSelection;
        }
    },

    /**
	 * Overridden to preserve current labelled items when list is filtered/paged/loaded
	 * and does not include our current value. See {@link #isFilteredRecord}
     * @private
	 */
    onListSelectionChange: function(list, selectedRecords) {
        var me = this,
        valueStore = me.valueStore,
        mergedRecords = [],
        i;

        // Only react to selection if it is not called from setValue, and if our list is
        // expanded (ignores changes to the selection model triggered elsewhere)
        if ((me.ignoreSelection <= 0) && me.isExpanded) {
            // Pull forward records that were already selected or are now filtered out of the store
            valueStore.each(function(rec) {
                if (Ext.Array.contains(selectedRecords, rec) || me.isFilteredRecord(rec)) {
                    mergedRecords.push(rec);
                }
            });
            mergedRecords = Ext.Array.merge(mergedRecords, selectedRecords);

            i = Ext.Array.intersect(mergedRecords, valueStore.getRange()).length;
            if ((i != mergedRecords.length) || (i != me.valueStore.getCount())) {
                me.setValue(mergedRecords, false);
                if (!me.multiSelect || !me.pinList) {
                    Ext.defer(me.collapse, 1, me);
                }
                if (valueStore.getCount() > 0) {
                    me.fireEvent('select', me, valueStore.getRange());
                }
            }
            me.inputEl.focus();
            if (!me.pinList) {
                me.inputEl.dom.value = '';
            }
            if (me.selectOnFocus) {
                me.inputEl.dom.select();
            }
        }
    },

    /**
     * Overridden to use valueStore instead of valueModels, for inclusion of
     * filtered records. See {@link #isFilteredRecord}
     * @private
     */
    syncSelection: function() {
        var me = this,
        picker = me.picker,
        valueField = me.valueField,
        pickStore, selection, selModel;

        if (picker) {
            pickStore = picker.store;

            // From the value, find the Models that are in the store's current data
            selection = [];
            if (me.valueStore) {
                me.valueStore.each(function(rec) {
                    var i = pickStore.findExact(valueField, rec.get(valueField));
                    if (i >= 0) {
                        selection.push(pickStore.getAt(i));
                    }
                });
            }

            // Update the selection to match
            me.ignoreSelection++;
            selModel = picker.getSelectionModel();
            selModel.deselectAll();
            if (selection.length > 0) {
                selModel.select(selection);
            }
            if (me.ignoreSelection > 0) {
                --me.ignoreSelection;
            }
        }
    },

    /**
	 * Overridden to align to itemList size instead of inputEl
     */
    doAlign: function(){
        var me = this,
            picker = me.picker,
            aboveSfx = '-above',
            isAbove;

        me.picker.alignTo(me.listWrapper, me.pickerAlign, me.pickerOffset);
        // add the {openCls}-above class if the picker was aligned above
        // the field due to hitting the bottom of the viewport
        isAbove = picker.el.getY() < me.inputEl.getY();
        me.bodyEl[isAbove ? 'addCls' : 'removeCls'](me.openCls + aboveSfx);
        picker[isAbove ? 'addCls' : 'removeCls'](picker.baseCls + aboveSfx);
    },

    /**
     * Overridden to preserve scroll position of pick list when list is realigned
     */
    alignPicker: function() {
        var me = this,
            picker = me.picker,
            pickerScrollPos = picker.getTargetEl().dom.scrollTop;

        me.callParent(arguments);

        if (me.isExpanded) {
            if (me.matchFieldWidth) {
                // Auto the height (it will be constrained by min and max width) unless there are no records to display.
                picker.setWidth(me.listWrapper.getWidth());
            }

            picker.getTargetEl().dom.scrollTop = pickerScrollPos;
        }
    },

    /**
	 * Get the current cursor position in the input field, for key-based navigation
	 * @private
	 */
    getCursorPosition: function() {
        var cursorPos;
        if (Ext.isIE) {
            cursorPos = document.selection.createRange();
            cursorPos.collapse(true);
            cursorPos.moveStart("character", -this.inputEl.dom.value.length);
            cursorPos = cursorPos.text.length;
        } else {
            cursorPos = this.inputEl.dom.selectionStart;
        }
        return cursorPos;
    },

    /**
	 * Check to see if the input field has selected text, for key-based navigation
	 * @private
	 */
    hasSelectedText: function() {
        var sel, range;
        if (Ext.isIE) {
            sel = document.selection;
            range = sel.createRange();
            return (range.parentElement() == this.inputEl.dom);
        } else {
            return this.inputEl.dom.selectionStart != this.inputEl.dom.selectionEnd;
        }
    },

    /**
	 * Handles keyDown processing of key-based selection of labelled items.
     * Supported keyboard controls:
     *
     * - If pick list is expanded
     *
     *     - `CTRL-A` will select all the items in the pick list
     *
     * - If the cursor is at the beginning of the input field and there are values present
     *
     *     - `CTRL-A` will highlight all the currently selected values
     *     - `BACKSPACE` and `DELETE` will remove any currently highlighted selected values
     *     - `RIGHT` and `LEFT` will move the current highlight in the appropriate direction
     *     - `SHIFT-RIGHT` and `SHIFT-LEFT` will add to the current highlight in the appropriate direction
     *
     * @protected
	 */
    onKeyDown: function(e, t) {
        var me = this,
        key = e.getKey(),
        rawValue = me.inputEl.dom.value,
        valueStore = me.valueStore,
        selModel = me.selectionModel,
        stopEvent = false;

        if (me.readOnly || me.disabled || !me.editable) {
            return;
        }

        if (me.isExpanded && (key == e.A && e.ctrlKey)) {
            // CTRL-A when picker is expanded - add all items in current picker store page to current value
            me.select(me.getStore().getRange());
            selModel.setLastFocused(null);
            selModel.deselectAll();
            me.collapse();
            me.inputEl.focus();
            stopEvent = true;
        } else if ((valueStore.getCount() > 0) &&
                ((rawValue == '') || ((me.getCursorPosition() === 0) && !me.hasSelectedText()))) {
            // Keyboard navigation of current values
            var lastSelectionIndex = (selModel.getCount() > 0) ? valueStore.indexOf(selModel.getLastSelected() || selModel.getLastFocused()) : -1;

            if ((key == e.BACKSPACE) || (key == e.DELETE)) {
                if (lastSelectionIndex > -1) {
                    if (selModel.getCount() > 1) {
                        lastSelectionIndex = -1;
                    }
                    me.valueStore.remove(selModel.getSelection());
                } else {
                    me.valueStore.remove(me.valueStore.last());
                }
                selModel.clearSelections();
                me.setValue(me.valueStore.getRange());
                if (lastSelectionIndex > 0) {
                    selModel.select(lastSelectionIndex - 1);
                }
                stopEvent = true;
            } else if ((key == e.RIGHT) || (key == e.LEFT)) {
                if ((lastSelectionIndex == -1) && (key == e.LEFT)) {
                    selModel.select(valueStore.last());
                    stopEvent = true;
                } else if (lastSelectionIndex > -1) {
                    if (key == e.RIGHT) {
                        if (lastSelectionIndex < (valueStore.getCount() - 1)) {
                            selModel.select(lastSelectionIndex + 1, e.shiftKey);
                            stopEvent = true;
                        } else if (!e.shiftKey) {
                            selModel.setLastFocused(null);
                            selModel.deselectAll();
                            stopEvent = true;
                        }
                    } else if ((key == e.LEFT) && (lastSelectionIndex > 0)) {
                        selModel.select(lastSelectionIndex - 1, e.shiftKey);
                        stopEvent = true;
                    }
                }
            } else if (key == e.A && e.ctrlKey) {
                selModel.selectAll();
                stopEvent = e.A;
            }
            me.inputEl.focus();
        }

        if (stopEvent) {
            me.preventKeyUpEvent = stopEvent;
            e.stopEvent();
            return;
        }

        // Prevent key up processing for enter if it is being handled by the picker
        if (me.isExpanded && (key == e.ENTER) && me.picker.highlightedItem) {
            me.preventKeyUpEvent = true;
        }

        if (me.enableKeyEvents) {
            me.callParent(arguments);
        }

        if (!e.isSpecialKey() && !e.hasModifier()) {
            me.selectionModel.setLastFocused(null);
            me.selectionModel.deselectAll();
            me.inputEl.focus();
        }
    },

    /**
	 * Handles auto-selection and creation of labelled items based on this field's
     * delimiter, as well as the keyUp processing of key-based selection of labelled items.
     * @protected
	 */
    onKeyUp: function(e, t) {
        var me = this,
        rawValue = me.inputEl.dom.value;

        if (me.preventKeyUpEvent) {
            e.stopEvent();
            if ((me.preventKeyUpEvent === true) || (e.getKey() === me.preventKeyUpEvent)) {
                delete me.preventKeyUpEvent;
            }
            return;
        }

        if (me.multiSelect && (me.delimiterRegexp && me.delimiterRegexp.test(rawValue)) ||
                ((me.createNewOnEnter === true) && e.getKey() == e.ENTER)) {
            rawValue = Ext.Array.clean(rawValue.split(me.delimiterRegexp));
            me.inputEl.dom.value = '';
            me.setValue(me.valueStore.getRange().concat(rawValue));
            me.inputEl.focus();
        }

        me.callParent([e,t]);
    },

    /**
     * Handles auto-selection of labelled items based on this field's delimiter when pasting
     * a list of values in to the field (e.g., for email addresses)
     * @protected
     */
    onPaste: function(e, t) {
        var me = this,
            rawValue = me.inputEl.dom.value,
            clipboard = (e && e.browserEvent && e.browserEvent.clipboardData) ? e.browserEvent.clipboardData : false;

        if (me.multiSelect && (me.delimiterRegexp && me.delimiterRegexp.test(rawValue))) {
            if (clipboard && clipboard.getData) {
                if (/text\/plain/.test(clipboard.types)) {
                    rawValue = clipboard.getData('text/plain');
                } else if (/text\/html/.test(clipboard.types)) {
                    rawValue = clipboard.getData('text/html');
                }
            }

            rawValue = Ext.Array.clean(rawValue.split(me.delimiterRegexp));
            me.inputEl.dom.value = '';
            me.setValue(me.valueStore.getRange().concat(rawValue));
            me.inputEl.focus();
        }
    },

    /**
     * Overridden to handle key navigation of pick list when list is filtered. Because we
     * want to avoid complexity that could be introduced by modifying the store's contents,
     * (e.g., always having to search back through and remove values when they might
     * be re-sent by the server, adding the values back in their previous position when
     * they are removed from the current selection, etc.), we handle this filtering
     * via a simple css rule. However, for the moment since those DOM nodes still exist
     * in the list we have to hijack the highlighting methods for the picker's BoundListKeyNav
     * to appropriately skip over these hidden nodes. This is a less than ideal solution,
     * but it centralizes all of the complexity of this problem in to this one method.
     * @protected
     */
    onExpand: function() {
        var me = this,
            keyNav = me.listKeyNav;

        me.callParent(arguments);

        if (keyNav || !me.filterPickList) {
            return;
        }
        keyNav = me.listKeyNav;
        keyNav.highlightAt = function(index) {
            var boundList = this.boundList,
                item = boundList.all.item(index),
                len = boundList.all.getCount(),
                direction;

            if (item && item.hasCls('x-boundlist-selected')) {
                if ((index == 0) || !boundList.highlightedItem || (boundList.indexOf(boundList.highlightedItem) < index)) {
                    direction = 1;
                } else {
                    direction = -1;
                }
                do {
                    index = index + direction;
                    item = boundList.all.item(index);
                } while ((index > 0) && (index < len) && item.hasCls('x-boundlist-selected'));

                if (item.hasCls('x-boundlist-selected')) {
                    return;
                }
            }

            if (item) {
                item = item.dom;
                boundList.highlightItem(item);
                boundList.getTargetEl().scrollChildIntoView(item, false);
            }
        };
    },

    /**
	 * Overridden to get and set the DOM value directly for type-ahead suggestion (bypassing get/setRawValue)
     * @protected
	 */
    onTypeAhead: function() {
        var me = this,
        displayField = me.displayField,
        inputElDom = me.inputEl.dom,
        valueStore = me.valueStore,
        boundList = me.getPicker(),
        record, newValue, len, selStart;

        if (me.filterPickList) {
            var fn = this.createFilterFn(displayField, inputElDom.value);
            record = me.store.findBy(function(rec) {
                return ((valueStore.indexOfId(rec.getId()) === -1) && fn(rec));
            });
            record = (record === -1) ? false : me.store.getAt(record);
        } else {
            record = me.store.findRecord(displayField, inputElDom.value);
        }

        if (record) {
            newValue = record.get(displayField);
            len = newValue.length;
            selStart = inputElDom.value.length;
            boundList.highlightItem(boundList.getNode(record));
            if (selStart !== 0 && selStart !== len) {
                inputElDom.value = newValue;
                me.selectText(selStart, newValue.length);
            }
        }
    },

    /**
	 * Delegation control for selecting and removing labelled items or triggering list collapse/expansion
     * @protected
	 */
    onItemListClick: function(evt, el, o) {
        var me = this,
        itemEl = evt.getTarget('.x-boxselect-item'),
        closeEl = itemEl ? evt.getTarget('.x-boxselect-item-close') : false;

        if (me.readOnly || me.disabled) {
            return;
        }

        evt.stopPropagation();

        if (itemEl) {
            if (closeEl) {
                me.removeByListItemNode(itemEl);
                if (me.valueStore.getCount() > 0) {
                    me.fireEvent('select', me, me.valueStore.getRange());
                }
            } else {
                me.toggleSelectionByListItemNode(itemEl, evt.shiftKey);
            }
            me.inputEl.focus();
        } else {
            if (me.selectionModel.getCount() > 0) {
                me.selectionModel.setLastFocused(null);
                me.selectionModel.deselectAll();
            }
            if (me.triggerOnClick) {
                me.onTriggerClick();
            }
        }
    },

    /**
	 * Build the markup for the labelled items. Template must be built on demand due to ComboBox initComponent
	 * lifecycle for the creation of on-demand stores (to account for automatic valueField/displayField setting)
     * @private
	 */
    getMultiSelectItemMarkup: function() {
        var me = this;

        if (!me.multiSelectItemTpl) {
            if (!me.labelTpl) {
                me.labelTpl = Ext.create('Ext.XTemplate',
                    '{[values.' + me.displayField + ']}'
                );
            } else if (Ext.isString(me.labelTpl) || Ext.isArray(me.labelTpl)) {
                me.labelTpl = Ext.create('Ext.XTemplate', me.labelTpl);
            }

            me.multiSelectItemTpl = [
            '<tpl for=".">',
            '<li class="x-boxselect-item ',
            '<tpl if="this.isSelected(values.'+ me.valueField + ')">',
            ' selected',
            '</tpl>',
            '" qtip="{[typeof values === "string" ? values : values.' + me.displayField + ']}">' ,
            '<div class="x-boxselect-item-text">{[typeof values === "string" ? values : this.getItemLabel(values)]}</div>',
            '<div class="x-tab-close-btn x-boxselect-item-close"></div>' ,
            '</li>' ,
            '</tpl>',
            {
                compile: true,
                disableFormats: true,
                isSelected: function(value) {
                    var i = me.valueStore.findExact(me.valueField, value);
                    if (i >= 0) {
                        return me.selectionModel.isSelected(me.valueStore.getAt(i));
                    }
                    return false;
                },
                getItemLabel: function(values) {
                    return me.getTpl('labelTpl').apply(values);
                }
            }
            ];
        }

        return this.getTpl('multiSelectItemTpl').apply(Ext.Array.pluck(this.valueStore.getRange(), 'data'));
    },

    /**
	 * Update the labelled items rendering
     * @private
	 */
    applyMultiselectItemMarkup: function() {
        var me = this,
        itemList = me.itemList,
        item;

        if (itemList) {
            while ((item = me.inputElCt.prev()) != null) {
                item.remove();
            }
            me.inputElCt.insertHtml('beforeBegin', me.getMultiSelectItemMarkup());
        }

        Ext.Function.defer(function() {
            if (me.picker && me.isExpanded) {
                me.alignPicker();
            }
            if (me.hasFocus && me.inputElCt && me.listWrapper) {
                me.inputElCt.scrollIntoView(me.listWrapper);
            }
        }, 15);
    },

    /**
	 * Returns the record from valueStore for the labelled item node
	 */
    getRecordByListItemNode: function(itemEl) {
        var me = this,
        itemIdx = 0,
        searchEl = me.itemList.dom.firstChild;

        while (searchEl && searchEl.nextSibling) {
            if (searchEl == itemEl) {
                break;
            }
            itemIdx++;
            searchEl = searchEl.nextSibling;
        }
        itemIdx = (searchEl == itemEl) ? itemIdx : false;

        if (itemIdx === false) {
            return false;
        }

        return me.valueStore.getAt(itemIdx);
    },

    /**
	 * Toggle of labelled item selection by node reference
	 */
    toggleSelectionByListItemNode: function(itemEl, keepExisting) {
        var me = this,
        rec = me.getRecordByListItemNode(itemEl),
        selModel = me.selectionModel;

        if (rec) {
            if (selModel.isSelected(rec)) {
                if (selModel.isFocused(rec)) {
                    selModel.setLastFocused(null);
                }
                selModel.deselect(rec);
            } else {
                selModel.select(rec, keepExisting);
            }
        }
    },

    /**
	 * Removal of labelled item by node reference
	 */
    removeByListItemNode: function(itemEl) {
        var me = this,
        rec = me.getRecordByListItemNode(itemEl);

        if (rec) {
            me.valueStore.remove(rec);
            me.setValue(me.valueStore.getRange());
        }
    },

    /**
     * @inheritdoc
	 * Intercept calls to getRawValue to pretend there is no inputEl for rawValue handling,
	 * so that we can use inputEl for user input of just the current value.
	 */
    getRawValue: function() {
        var me = this,
        inputEl = me.inputEl,
        result;

        me.inputEl = false;
        result = me.callParent(arguments);
        me.inputEl = inputEl;

        return result;
    },

    /**
     * @inheritdoc
	 * Intercept calls to setRawValue to pretend there is no inputEl for rawValue handling,
	 * so that we can use inputEl for user input of just the current value.
	 */
    setRawValue: function(value) {
        var me = this,
        inputEl = me.inputEl,
        result;

        me.inputEl = false;
        result = me.callParent([value]);
        me.inputEl = inputEl;

        return result;
    },

    /**
	 * Adds a value or values to the current value of the field
	 * @param {Mixed} value The value or values to add to the current value, see {@link #setValue}
	 */
    addValue: function(value) {
        var me = this;
        if (value) {
            me.setValue(Ext.Array.merge(me.value, Ext.Array.from(value)));
        }
    },

    /**
	 * Removes a value or values from the current value of the field
	 * @param {Mixed} value The value or values to remove from the current value, see {@link #setValue}
	 */
    removeValue: function(value) {
        var me = this;

        if (value) {
            me.setValue(Ext.Array.difference(me.value, Ext.Array.from(value)));
        }
    },

    /**
     * Sets the specified value(s) into the field. The following value formats are recognised:
     *
     * - Single Values
     *
     *     - A string associated to this field's configured {@link #valueField}
     *     - A record containing at least this field's configured {@link #valueField} and {@link #displayField}
     *
     * - Multiple Values
     *
     *     - If {@link #multiSelect} is `true`, a string containing multiple strings as
     *       specified in the Single Values section above, concatenated in to one string
     *       with each entry separated by this field's configured {@link #delimiter}
     *     - An array of strings as specified in the Single Values section above
     *     - An array of records as specified in the Single Values section above
     *
     * In any of the string formats above, the following occurs if an associated record cannot be found:
     *
     * 1. If {@link #forceSelection} is `false`, a new record of the {@link #store}'s configured model type
     *    will be created using the given value as the {@link #displayField} and {@link #valueField}.
     *    This record will be added to the current value, but it will **not** be added to the store.
     * 2. If {@link #forceSelection} is `true` and {@link #queryMode} is `remote`, the list of unknown
     *    values will be submitted as a call to the {@link #store}'s load as a parameter named by
     *    the {@link #valueParam} with values separated by the configured {@link #delimiter}.
     *    ** This process will cause setValue to asynchronously process. ** This will only be attempted
     *    once. Any unknown values that the server does not return records for will be removed.
     * 3. Otherwise, unknown values will be removed.
     *
     * @param {Mixed} value The value(s) to be set, see method documentation for details
     * @return {Ext.form.field.Field/Boolean} this, or `false` if asynchronously querying for unknown values
	 */
    setValue: function(value, doSelect, skipLoad) {
        var me = this,
        valueStore = me.valueStore,
        valueField = me.valueField,
        record, len, i, valueRecord, h,
        unknownValues = [];

        if (Ext.isEmpty(value)) {
            value = null;
        }
        if (Ext.isString(value) && me.multiSelect) {
            value = value.split(me.delimiter);
        }
        value = Ext.Array.from(value, true);

        for (i = 0, len = value.length; i < len; i++) {
            record = value[i];
            if (!record || !record.isModel) {
                valueRecord = valueStore.findExact(valueField, record);
                if (valueRecord >= 0) {
                    value[i] = valueStore.getAt(valueRecord);
                } else {
                    valueRecord = me.findRecord(valueField, record);
                    if (!valueRecord) {
                        if (me.forceSelection) {
                            unknownValues.push(record);
                        } else {
                            valueRecord = {};
                            valueRecord[me.valueField] = record;
                            valueRecord[me.displayField] = record;
                            valueRecord = new me.valueStore.model(valueRecord);
                        }
                    }
                    if (valueRecord) {
                        value[i] = valueRecord;
                    }
                }
            }
        }

        if ((skipLoad !== true) && (unknownValues.length > 0) && (me.queryMode === 'remote')) {
            var params = {};
            params[me.valueParam || me.valueField] = unknownValues.join(me.delimiter);
            me.store.load({
                params: params,
                callback: function() {
                    if (me.itemList) {
                        me.itemList.unmask();
                    }
                    me.setValue(value, doSelect, true);
                    me.autoSize();
                    me.lastQuery = false;
                }
            });
            return false;
        }

        // For single-select boxes, use the last good (formal record) value if possible
        if (!me.multiSelect && (value.length > 0)) {
            for (i = value.length - 1; i >= 0; i--) {
                if (value[i].isModel) {
                    value = value[i];
                    break;
                }
            }
            if (Ext.isArray(value)) {
                value = value[value.length - 1];
            }
        }

        return me.callParent([value, doSelect]);
    },

    /**
     * Returns the records for the field's current value
     * @return {Array} The records for the field's current value
     */
    getValueRecords: function() {
        return this.valueStore.getRange();
    },

    /**
     * @inheritdoc
     * Overridden to optionally allow for submitting the field as a json encoded array.
     */
    getSubmitData: function() {
        var me = this,
        val = me.callParent(arguments);

        if (me.multiSelect && me.encodeSubmitValue && val && val[me.name]) {
            val[me.name] = Ext.encode(val[me.name]);
        }

        return val;
    },

    /**
	 * Overridden to clear the input field if we are auto-setting a value as we blur.
     * @protected
	 */
    mimicBlur: function() {
        var me = this;

        if (me.selectOnTab && me.picker && me.picker.highlightedItem) {
            me.inputEl.dom.value = '';
        }

        me.callParent(arguments);
    },

    /**
	 * Overridden to handle partial-input selections more directly
	 */
    assertValue: function() {
        var me = this,
        rawValue = me.inputEl.dom.value,
        rec = !Ext.isEmpty(rawValue) ? me.findRecordByDisplay(rawValue) : false,
        value = false;

        if (!rec && !me.forceSelection && me.createNewOnBlur && !Ext.isEmpty(rawValue)) {
            value = rawValue;
        } else if (rec) {
            value = rec;
        }

        if (value) {
            me.addValue(value);
        }

        me.inputEl.dom.value = '';

        me.collapse();
    },

    /**
	 * Expand record values for evaluating change and fire change events for UI to respond to
	 */
    checkChange: function() {
        if (!this.suspendCheckChange && !this.isDestroyed) {
            var me = this,
            valueStore = me.valueStore,
            lastValue = me.lastValue || '',
            valueField = me.valueField,
            newValue = Ext.Array.map(Ext.Array.from(me.value), function(val) {
                if (val.isModel) {
                    return val.get(valueField);
                }
                return val;
            }, this).join(this.delimiter),
            isEqual = me.isEqual(newValue, lastValue);

            if (!isEqual || ((newValue.length > 0 && valueStore.getCount() < newValue.length))) {
                valueStore.suspendEvents();
                valueStore.removeAll();
                if (Ext.isArray(me.valueModels)) {
                    valueStore.add(me.valueModels);
                }
                valueStore.resumeEvents();
                valueStore.fireEvent('datachanged', valueStore);

                if (!isEqual) {
                    me.lastValue = newValue;
                    me.fireEvent('change', me, newValue, lastValue);
                    me.onChange(newValue, lastValue);
                }
            }
        }
    },

    /**
     * Overridden to be more accepting of varied value types
     */
    isEqual: function(v1, v2) {
        var fromArray = Ext.Array.from,
            valueField = this.valueField,
            i, len, t1, t2;

        v1 = fromArray(v1);
        v2 = fromArray(v2);
        len = v1.length;

        if (len !== v2.length) {
            return false;
        }

        for(i = 0; i < len; i++) {
            t1 = v1[i].isModel ? v1[i].get(valueField) : v1[i];
            t2 = v2[i].isModel ? v2[i].get(valueField) : v2[i];
            if (t1 !== t2) {
                return false;
            }
        }

        return true;
    },

    /**
	 * Overridden to use value (selection) instead of raw value and to avoid the use of placeholder
	 */
    applyEmptyText : function() {
        var me = this,
        emptyText = me.emptyText,
        inputEl, isEmpty;

        if (me.rendered && emptyText) {
            isEmpty = Ext.isEmpty(me.value) && !me.hasFocus;
            inputEl = me.inputEl;
            if (isEmpty) {
                inputEl.dom.value = '';
                me.emptyEl.update(emptyText);
                me.emptyEl.addCls(me.emptyCls);
                me.emptyEl.removeCls(me.emptyInputCls);
                me.listWrapper.addCls(me.emptyCls);
                me.inputEl.addCls(me.emptyInputCls);
            } else {
                me.emptyEl.addCls(me.emptyInputCls);
                me.emptyEl.removeCls(me.emptyCls);
                me.listWrapper.removeCls(me.emptyCls);
                me.inputEl.removeCls(me.emptyInputCls);
            }
            me.autoSize();
        }
    },

    /**
	 * Overridden to use inputEl instead of raw value and to avoid the use of placeholder
	 */
    preFocus : function(){
        var me = this,
        inputEl = me.inputEl,
        emptyText = me.emptyText,
        isEmpty = (inputEl.dom.value == '');

        me.emptyEl.addCls(me.emptyInputCls);
        me.emptyEl.removeCls(me.emptyCls);
        me.listWrapper.removeCls(me.emptyCls);
        me.inputEl.removeCls(me.emptyInputCls);

        if (me.selectOnFocus || isEmpty) {
            inputEl.dom.select();
        }
    },

    /**
	 * Intercept calls to onFocus to add focusCls, because the base field
     * classes assume this should be applied to inputEl
	 */
    onFocus: function() {
        var me = this,
        focusCls = me.focusCls,
        itemList = me.itemList;

        if (focusCls && itemList) {
            itemList.addCls(focusCls);
        }

        me.callParent(arguments);
    },

    /**
	 * Intercept calls to onBlur to remove focusCls, because the base field
     * classes assume this should be applied to inputEl
	 */
    onBlur: function() {
        var me = this,
        focusCls = me.focusCls,
        itemList = me.itemList;

        if (focusCls && itemList) {
            itemList.removeCls(focusCls);
        }

        me.callParent(arguments);
    },

    /**
	 * Intercept calls to renderActiveError to add invalidCls, because the base
     * field classes assume this should be applied to inputEl
	 */
    renderActiveError: function() {
        var me = this,
        invalidCls = me.invalidCls,
        itemList = me.itemList,
        hasError = me.hasActiveError();

        if (invalidCls && itemList) {
            itemList[hasError ? 'addCls' : 'removeCls'](me.invalidCls + '-field');
        }

        me.callParent(arguments);
    },

    /**
     * Initiate auto-sizing for height based on {@link #grow}, if applicable.
     */
    autoSize: function() {
        var me = this,
        height;

        if (me.grow && me.rendered) {
            me.autoSizing = true;
            me.updateLayout();
        }

        return me;
    },

    /**
     * Track height change to fire {@link #event-autosize} event, when applicable.
     */
    afterComponentLayout: function() {
        var me = this,
            width;

        if (me.autoSizing) {
            height = me.getHeight();
            if (height !== me.lastInputHeight) {
                if (me.isExpanded) {
                    me.alignPicker();
                }
                me.fireEvent('autosize', me, height);
                me.lastInputHeight = height;
                delete me.autoSizing;
            }
        }
    }
});

/**
 * Ensures the input element takes up the maximum amount of remaining list width,
 * or the entirety of the list width if too little space remains. In this case,
 * the list height will be automatically increased to accomodate the new line. This
 * growth will not occur if {@link Ext.ux.form.field.BoxSelect#multiSelect} or
 * {@link Ext.ux.form.field.BoxSelect#grow} is false.
 */
Ext.define('Ext.ux.layout.component.field.BoxSelectField', {
    /* Begin Definitions */
    alias: ['layout.boxselectfield'],
    extend: 'Ext.layout.component.field.Trigger',

    /* End Definitions */

    type: 'boxselectfield',

    /*For proper calculations we need our field to be sized.*/
    waitForOuterWidthInDom:true,

    beginLayout: function(ownerContext) {
        var me = this,
            owner = me.owner;

        me.callParent(arguments);

        ownerContext.inputElCtContext = ownerContext.getEl('inputElCt');
        owner.inputElCt.setStyle('width','');

        me.skipInputGrowth = !owner.grow || !owner.multiSelect;
    },

    beginLayoutFixed: function(ownerContext, width, suffix) {
        var me = this,
            owner = ownerContext.target;

        owner.triggerEl.setStyle('height', '24px');

        me.callParent(arguments);

        if (ownerContext.heightModel.fixed && ownerContext.lastBox) {
            owner.listWrapper.setStyle('height', ownerContext.lastBox.height+'px');
            owner.itemList.setStyle('height', '100%');
        }
        /*No inputElCt calculations here!*/
    },

    /*Calculate and cache value of input container.*/
    publishInnerWidth:function(ownerContext) {
        //var me = this,
        //    owner = me.owner,
        //    width = owner.itemList.getWidth(true) - 10,
        //    lastEntry = owner.inputElCt.prev(null, true);
        //if (lastEntry && !owner.stacked) {
        //    lastEntry = Ext.fly(lastEntry);
        //    width = width - lastEntry.getOffsetsTo(lastEntry.up(''))[0] - lastEntry.getWidth();
        //}
        //if (!me.skipInputGrowth && (width < 35)) {
        //    width = width - 10;
        //} else if (width < 1) {
        //    width = 1;
        //}
        //ownerContext.inputElCtContext.setWidth(width);
    }
});

Ext.define('App.ux.LiveSnomedProblemMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'livesnomedproblemmultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('problem_search') + '...',
    queryMode: 'remote',
    labelTpl: '{Term} &#60;{ConceptId}&#62;',
    forceSelection: false,
    displayField: 'Term',
    valueField: 'ConceptId',
    pageSize: 25,
    enableReset: false,
    minChars: 3,
    listConfig: {
        tpl: [
            '<tpl for=".">',
            '<div role="option" class="x-boundlist-item">({CodeType}) {Term}  &#60;{ConceptId}&#62;</div>',
            '</tpl>'
        ]
    },
    initComponent: function(){
        var me = this,
            model = 'SnomedProblemsMultipleSearchModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'ConceptId',
                    type: 'string'
                },
                {
                    name: 'Term',
                    type: 'string'
                },
                {
                    name: 'CodeType',
                    type: 'string'
                },
                {
                    name: 'OCCURRENCE',
                    type: 'int'
                }
            ],
            proxy: {
                idProperty: 'ConceptId',
                type: 'direct',
                api: {
                    read: 'SnomedCodes.liveProblemCodeSearch'
                },
                reader: {
                    totalProperty: 'totals',
                    root: 'data'
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'SnomedProblemsMultipleSearchModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...',
                getInnerTpl: function(){
                    return '<div class="search-item"><h3>{Term}<span style="font-weight: normal"> ({ConceptId}) </span></h3></div>';
                }
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveRXNORMAllergyMultipleSearch', {
	extend: 'App.ux.form.fields.BoxSelect',
	xtype: 'liverxnormallergymultiple',
	allowBlank: true,
	editable: true,
	typeAhead: false,
	autoSelect: false,
	emptyText: _('allergy_search') + '...',
	queryMode: 'remote',
	labelTpl: '{STR} &#60;{RXCUI}&#62;',
	forceSelection: false,
	displayField: 'STR',
	valueField: 'STR',
	pageSize: 25,
	enableReset: false,
	initComponent: function () {
		var me = this,
			model = 'RXNORMAllergyMultipleSearchModel' + me.id;

		if (me.enableReset) {
			me.trigger2Cls = 'x-form-clear-trigger';
			me.onTrigger2Click = function () {
				me.reset();
			}
		}

		Ext.define(model, {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'RXCUI', type: 'auto'},
				{name: 'CODE', type: 'auto'},
				{name: 'STR', type: 'auto'},
				{name: 'DST', type: 'auto'},
				{name: 'DRT', type: 'auto'},
				{name: 'DDF', type: 'auto'},
				{name: 'DDFA', type: 'auto'},
				{name: 'RXN_QUANTITY', type: 'auto'},
				{name: 'SAB', type: 'auto'},
				{name: 'RXAUI', type: 'auto'},
				{name: 'CodeType', defaultValue: 'RXNORM'},
				{name: 'occurrences', type: 'int'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'Rxnorm.getRXNORMAllergyLiveSearch'
				},
				reader: {
					totalProperty: 'totals',
					root: 'rows'
				}
			}
		});

		me.store = Ext.create('Ext.data.Store', {
			model: 'RXNORMAllergyMultipleSearchModel' + me.id,
			pageSize: 25,
			autoLoad: false
		});

		Ext.apply(this, {
			store: me.store,
			listConfig: {
				loadingText: _('searching') + '...',
				getInnerTpl: function () {
					return '<div class="search-item"><h3>{STR}<span style="font-weight: normal"> ({RXCUI}) ({occurrences})</span></h3></div>';
				}
			},
			pageSize: 25
		});

		me.callParent();

		me.on('select', me.addOccurrence);
	},

	addOccurrence: function (cmb, records) {
		if (records.length > 0 && records[0].get('RXCUI') !== '') {
			Rxnorm.addOccurrence(records[0].get('RXCUI'));
		}
	}
});

Ext.define('App.ux.LiveRXNORMMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    requires:[
        'App.model.administration.MedicationInstruction'
    ],
    xtype: 'liverxnormmultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('medication_search')+'...',
    queryMode: 'remote',
    labelTpl: '{STR} &#60;{RXCUI}&#62;',
    forceSelection: false,
    displayField: 'STR',
    valueField: 'STR',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'RXNORMMultipleSearchModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'RXCUI',
                    type: 'string'
                },
                {
                    name: 'CODE',
                    type: 'string'
                },
                {
                    name: 'NDC',
                    type: 'string'
                },
                {
                    name: 'STR',
                    type: 'string',
                    convert: function(v){
                        var regex = /\(.*\) | \(.*\)|\(.*\)/g;
                        return v.replace(regex, '');
                    }
                },
                {
                    name: 'DST',
                    type: 'auto'
                },
                {
                    name: 'DRT',
                    type: 'auto'
                },
                {
                    name: 'DDF',
                    type: 'auto'
                },
                {
                    name: 'DDFA',
                    type: 'auto'
                },
                {
                    name: 'RXN_QUANTITY',
                    type: 'auto'
                },
                {
                    name: 'SAB',
                    type: 'auto'
                },
                {
                    name: 'RXAUI',
                    type: 'auto'
                },
                {
                    name: 'CodeType',
                    defaultValue: 'RXNORM'
                },
	            {name: 'occurrences', type: 'int'}
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'Rxnorm.getRXNORMLiveSearch'
                },
                reader: {
                    totalProperty: 'totals',
                    root: 'rows'
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'RXNORMMultipleSearchModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...',
                getInnerTpl: function(){
                    return '<div class="search-item">{STR} ( <b>RxNorm:</b> {RXCUI} <b>NDC:</b> {NDC} ) ({occurrences})</div>';
                }
            },
            pageSize: 25
        });

        me.callParent();

	    me.on('select', me.addOccurrence);
    },

	addOccurrence: function (cmb, records) {
		if (records.length > 0 && records[0].get('RXCUI') !== '') {
			Rxnorm.addOccurrence(records[0].get('RXCUI'));
		}
	}
});

Ext.define('App.ux.LiveProviderMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'liveprovidermultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('select_provider')+'...',
    queryMode: 'remote',
    labelTpl: '{option_name}',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'id',
    pageSize: 25,
    enableReset: true,
    initComponent: function(){
        var me = this,
            model = 'ActiveProvidersMultipleModel' + me.id;

        if(me.enableReset){
	        me.trigger2Cls = 'x-form-clear-trigger';
	        me.onTrigger2Click = function() {
		        me.reset();
	        }
        }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {
                    name: 'id',
                    type: 'int'
                },
                {
                    name: 'title',
                    type: 'string'
                },
                {
                    name: 'fname',
                    type: 'string'
                },
                {
                    name: 'mname',
                    type: 'string'
                },
                {
                    name: 'lname',
                    type: 'string'
                },
                {
                    name: 'fullname',
                    type: 'string',
                    convert: function(v, record){
                        return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
                    }
                },
                {
                    name: 'option_name',
                    type: 'string',
                    convert: function(v, record){
                        return record.data.title + ' ' + record.data.lname + ', ' + record.data.fname + ' ' + record.data.mname;
                    }
                },
                {
                    name: 'option_value',
                    type: 'int',
                    convert: function(v, record){
                        return record.data.id;
                    }
                }
            ],
            proxy: {
                idProperty: 'ConceptId',
                type: 'direct',
                api: {
                    read: 'User.getActiveProviders'
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'ActiveProvidersMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveSexMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'sexmultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('sex_search') + '...',
    queryMode: 'remote',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'SexMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 19
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'SexMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveEthnicityMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'ethnicitymultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('ethnicity_search') + '...',
    queryMode: 'remote',
    minChars: 3,
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'EthnicityMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 59
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'EthnicityMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveRaceMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'racemultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('race_search') + '...',
    queryMode: 'remote',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'RaceMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }


        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 14
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'RaceMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveMaritalMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'maritalmultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('patient_marital_status') + '...',
    queryMode: 'remote',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'MaritalMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 12
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'MaritalMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LiveLanguageMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'languagemultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('language_search') + '...',
    queryMode: 'remote',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'LangMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 10
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'LangMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LivePhoneCommunicationMultipleSearch', {
    extend: 'App.ux.form.fields.BoxSelect',
    xtype: 'communicationmultiple',
    allowBlank: true,
    editable: true,
    typeAhead: false,
    autoSelect: false,
    emptyText: _('communication') + '...',
    queryMode: 'remote',
    forceSelection: false,
    displayField: 'option_name',
    valueField: 'option_value',
    pageSize: 25,
    enableReset: false,
    initComponent: function(){
        var me = this,
            model = 'CommunicationMultipleModel' + me.id;

	    if(me.enableReset){
		    me.trigger2Cls = 'x-form-clear-trigger';
		    me.onTrigger2Click = function() {
			    me.reset();
		    }
	    }

        Ext.define(model, {
            extend: 'Ext.data.Model',
            fields: [
                {name: 'option_name', type: 'string' },
                {name: 'option_value', type: 'string' }
            ],
            proxy: {
                type: 'direct',
                api: {
                    read: 'CombosData.getOptionsByListId'
                },
                extraParams: {
                    list_id: 132
                }
            }
        });

        me.store = Ext.create('Ext.data.Store', {
            model: 'CommunicationMultipleModel' + me.id,
            pageSize: 25,
            autoLoad: false
        });

        Ext.apply(this, {
            store: me.store,
            listConfig: {
                loadingText: _('searching') + '...'
            },
            pageSize: 25
        });

        me.callParent();
    }
});

Ext.define('App.ux.LabResultValuesFilter', {
	extend: 'Ext.form.FieldContainer',
	alias: 'widget.labresultvalues',
	fieldLabel: _('lab_results'),
	labelAlign: 'top',
	layout: 'anchor',

	initComponent: function () {
		var me = this;

        me.addEvents('addItem');
        me.addEvents('removeItem');
        me.addEvents('reset');

		/**
		 * Model & Store for the Laboratory Results combo
		 */
		Ext.define('ReportLabResultValueFilterModel', {
			extend: 'Ext.data.Model',
			fields: [
				{name: 'code', type: 'string'},
				{name: 'code_text', type: 'string'}
			],
			proxy: {
				type: 'direct',
				api: {
					read: 'LabResultsValuesFilter.getDistinctResults'
				},
				reader: {
					root: 'rows',
					totalProperty: 'totals'
				}
			},
			idProperty: 'code'
		});

		me.items = [
			{
				xtype: 'combo',
				store: Ext.create('Ext.data.Store', {
					model: 'ReportLabResultValueFilterModel',
					autoLoad: false
				}),
				anchor: '100%',
				emptyText: _('select_lab_result'),
				itemId: 'LabResultValuesFilterLabField',
				displayField: 'code_text',
				valueField: 'code',
                editable: false,
				submitValue: false
			},
			{
				xtype: 'combo',
				store: Ext.create('Ext.data.Store', {
					fields: ['name', 'value'],
					data: [
						{
							"name": "More than",
							"value": ">"
						},
						{
							"name": "Less than",
							"value": "<"
						},
						{
							"name": "Equal to",
							"value": "="
						}
					]
				}),
				anchor: '100%',
                editable: false,
				emptyText: _('select_comparison'),
				itemId: 'LabResultValuesFilterOperatorField',
				displayField: 'name',
				valueField: 'value',
				submitValue: false
			},
			{
				xtype: 'textfield',
				anchor: '100%',
				itemId: 'LabResultValuesFilterValueField',
				emptyText: _('lab_enter_value'),
				submitValue: false
			},
			{
				xtype: 'container',
				layout: 'hbox',
				anchor: '100%',
				height: 30,
				items: [
					{
						xtype: 'button',
						text: 'Reset Labs',
						flex: 1,
						listeners: {
							click: me.reset,
							scope: me
						}
					},
					{
						xtype: 'button',
						text: 'Add Lab',
						flex: 1,
						listeners: {
							click: me.addFieldValue,
							scope: me
						}
					}
				]
			},
			{
				xtype: 'fieldcontainer',
				itemId: 'LabResultValuesFilterFieldsContainer',
				anchor: '100%'
			}
		];

		me.callParent();

	},

	addFieldValue: function () {
		var me = this,
			lab_code = me.getComponent('LabResultValuesFilterLabField').getValue(),
			lab_name = me.getComponent('LabResultValuesFilterLabField').findRecordByValue(lab_code).get('code_text'),
			operator = me.getComponent('LabResultValuesFilterOperatorField').getValue(),
			value = me.getComponent('LabResultValuesFilterValueField').getValue(),
			fieldContainer = me.getComponent('LabResultValuesFilterFieldsContainer'),
            item;

		if(lab_code == '' || operator == '' || value == ''){
			app.msg(_('oops'),'Laboratory Result, Operator, and Value are required', true);
			return;
		}

        fieldContainer.add({
            xtype: 'checkboxfield',
            boxLabel: Ext.String.format('{0} {1} {2}', lab_name, operator, value),
            name: me.name,
            checked: true,
            inputValue: {
                lab_code: lab_code,
                lab_name: lab_name,
                operator: operator,
                value: value
            },
            listeners: {
                change: function (field, value) {
                    if (!value) {
                        Ext.Function.defer(function () {
                            field.destroy();
                        }, 200);
                        me.fireEvent('removeItem', me, field, value);
                    }
                }
            }
        });
        item = {
            lab_code: lab_code,
            lab_name: lab_name,
            operator: operator,
            value: value
        };
        me.fireEvent('addItem', me, item);

	},

	reset: function () {
		this.getComponent('LabResultValuesFilterLabField').reset();
		this.getComponent('LabResultValuesFilterOperatorField').reset();
		this.getComponent('LabResultValuesFilterValueField').reset();
        this.fireEvent('reset', me);
	}

});

Ext.define('App.view.patient.Search', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('patient_search'),
	pageLayout: 'border',
	itemId: 'PatientSearchPanel',
	requires: [
		'Ext.form.field.Date',
		'Ext.ux.SlidingPager',
		'App.ux.combo.ActiveProviders',
		'App.ux.LiveSnomedProblemMultipleSearch',
		'App.ux.LiveRXNORMAllergyMultipleSearch',
		'App.ux.LiveRXNORMMultipleSearch',
		'App.ux.LiveProviderMultipleSearch',
		'App.ux.LiveSexMultipleSearch',
		'App.ux.LiveEthnicityMultipleSearch',
		'App.ux.LiveRaceMultipleSearch',
		'App.ux.LiveMaritalMultipleSearch',
		'App.ux.LiveLanguageMultipleSearch',
		'App.ux.LivePhoneCommunicationMultipleSearch',
		'App.ux.LabResultValuesFilter'
	],
	initComponent: function () {
		var me = this;

		me.search_store = Ext.create('App.store.patient.PatientSearch', {
			remoteSort: true
		});

		me.pageBody = [
			{
				xtype: 'form',
				region: 'west',
				collapsible: true,
				border: true,
				split: true,
				bodyPadding: 5,
				width: 300,
				itemId: 'PatientSearchFrom',
				defaults: {
					enableReset: true,
					anchor: '100%',
					labelAlign: 'top'
				},
				items: [
					{
						xtype: 'datefield',
						name: 'date_from',
						fieldLabel: _('date_from'),
						labelWidth: 100,
						format: g('date_display_format'),
						allowBlank : false,
						submitFormat: 'Y-m-d',
						value: new Date()
					},
					{
						xtype: 'datefield',
						name: 'date_to',
						fieldLabel: _('date_to'),
						labelWidth: 100,
						allowBlank : false,
						format: g('date_display_format'),
						submitFormat: 'Y-m-d',
						value: new Date()
					},
					{
						xtype:'fieldset',
						title: _('patient'),
						defaults: {
							enableReset: true,
							anchor: '100%',
							labelAlign: 'top'
						},
						items: [
							{
								xtype: 'textfield',
								name: 'lname',
								emptyText: _('last_name')
							},
							{
								xtype: 'textfield',
								name: 'fname',
								emptyText: _('first_name')
							},
							{
								xtype: 'container',
								layout: 'hbox',
								margin: '0 0 5 0',
								items: [
									{
										xtype: 'numberfield',
										flex: 1,
										name: 'ageFrom',
										emptyText: _('ageFrom')
									},
									{
										xtype: 'numberfield',
										flex: 1,
										name: 'ageTo',
										emptyText: _('ageTo')
									}
								]
							},
							{
								xtype: 'racemultiple',
								name: 'race'
							},
							{
								xtype: 'ethnicitymultiple',
								name: 'ethnicity'
							},
							{
								xtype: 'sexmultiple',
								name: 'sex'
							},
							{

								xtype: 'communicationmultiple',
								name: 'phone_publicity'
							},
							{

								xtype: 'maritalmultiple',
								name: 'marital_status'
							},
							{

								xtype: 'languagemultiple',
								name: 'language'
							}
						]
					},

					{
						xtype: 'liveprovidermultiple',
						name: 'providers'
					},
					{
						xtype: 'liverxnormallergymultiple',
						name: 'allergy_codes',
						displayField: 'STR',
						valueField: 'RXCUI'
					},
					{
						xtype: 'livesnomedproblemmultiple',
						name: 'problem_codes'
					},
					{
						xtype: 'liverxnormmultiple',
						name: 'medication_codes',
						displayField: 'STR',
						valueField: 'RXCUI'
					},
					{
						xtype: 'labresultvalues',
						submitValue: true,
						name: 'lab_results'
					}
				],
				bbar: [
					{
						text: _('search'),
						itemId: 'PatientSearchFromSearchBtn',
						flex: 1
					}
				]
			},
			{
				xtype: 'grid',
				region: 'center',
				frame: true,
				title: _('results'),
				itemId: 'PatientSearchGrid',
				store: me.search_store,
				columns: [
					{
						text: _('record_number'),
						dataIndex: 'pubpid'
					},
					{
						text: _('date'),
						dataIndex: 'service_date'
					},
					{
						text: _('patient'),
						dataIndex: 'lname',
						renderer: function (v,meta,rec) {
							return Ext.String.format(
								'{0}, {1} {2}',
								rec.get('lname'),
								rec.get('fname'),
								rec.get('mname')
							);
						}
					},
					{
						text: _('sex'),
						dataIndex: 'sex',
						renderer: function (v) {
							if(v == 'M'){
								return 'Male';
							}else  if(v == 'F'){
								return 'Female';
							}
							return v;
						}
					},
					{
						text: _('language'),
						dataIndex: 'language'
					},
					{
						text: _('dob') + ' (age)',
						dataIndex: 'DOB',
						renderer: function (v,meta,rec) {
							return Ext.String.format(
								'{0} ({1})',
								rec.get('DOBFormatted'),
								rec.getAge(rec.get('DOB'))
							);
						}
					},
					{
						text: _('communication'),
						dataIndex: 'phone_publicity',
						renderer: function (v) {
							if(v == '01'){
								return 'No reminder/recall';
							}else  if(v == '02'){
								return 'Reminder/recall - any method';
							}else  if(v == '03'){
								return 'Reminder/recall - no calls';
							}else  if(v == '04'){
								return 'Reminder only - any method';
							}else  if(v == '05'){
								return 'Reminder only - no calls';
							}else  if(v == '06'){
								return 'Recall only - any method';
							}else  if(v == '07'){
								return 'Recall only - no calls';
							}else  if(v == '08'){
								return 'Reminder/recall - to provider';
							}else  if(v == '09'){
								return 'Reminder to provider';
							}else  if(v == '10'){
								return 'Only reminder to provider no recall';
							}else  if(v == '11'){
								return 'Recall to provider';
							}else  if(v == '12'){
								return 'Only recall to provider no reminder';
							}
							return v;
						}
					},
					{
						text: _('marital_status'),
						dataIndex: 'marital_status',
						renderer: function (v) {
							if(v == 'M'){
								return 'Married';
							}else  if(v == 'S'){
								return 'Single';
							}else  if(v == 'D'){
								return 'Divorced';
							}else  if(v == 'W'){
								return 'Widowed';
							}else  if(v == 'A'){
								return 'Separated';
							}else  if(v == 'P'){
								return 'Domestic Partner';
							}else  if(v == 'O'){
								return 'Other';
							}
							return v;
						}
					},
					{
						text: _('race'),
						dataIndex: 'race',
						renderer: function (v) {
							if(v == '1002-5'){
								return 'American Indian or Alaska Native';
							}else  if(v == '2028-9'){
								return 'Asian';
							}else  if(v == '2054-5'){
								return 'Black or African American';
							}else  if(v == '2076-8'){
								return 'Native Hawaiian or Other Pacific Islander';
							}else  if(v == '2106-3'){
								return 'White';
							}else  if(v == 'ASKU'){
								return 'Declined to specify';
							}else  if(v == '2131-1'){
								return 'Other Race';
							}
							return v;
						}
					},
					{
						text: _('ethnicity'),
						dataIndex: 'ethnicity',
						renderer: function (v) {
							if(v == 'H'){
								return 'Hispanic or Latino';
							}else  if(v == 'N'){
								return 'Not Hispanic or Latino';
							}else  if(v == 'ASKU'){
								return 'Declined to specify';
							}else  if(v == 'U') {
								return 'Unknown';
							}
							return v;
						}
					},
					{
						text: _('providers'),
						dataIndex: 'providers',
						width: 200
					},
					{
						text: _('allergies'),
						dataIndex: 'allergies',
						width: 200
					},
					{
						text: _('problems'),
						dataIndex: 'problems',
						width: 200
					},
					{
						text: _('medications'),
						dataIndex: 'medications',
						width: 200
					},
					{
						text: _('lab_results'),
						dataIndex: 'lab_results',
						width: 200
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					store: me.search_store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager()
				}
			}
		];

		me.callParent(arguments);

	}
});

Ext.define('App.model.patient.PatientSearch',{
    extend: 'Ext.data.Model',
    fields: [
        {
            name: 'pid',
            type: 'int'
        },
        {
            name: 'title',
            type: 'string'
        },
        {
            name: 'fname',
            type: 'string'
        },
        {
            name: 'mname',
            type: 'string'
        },
        {
            name: 'lname',
            type: 'string'
        },
        {
            name: 'sex',
            type: 'string'
        },
        {
            name: 'DOB',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s',
            defaultValue: '0000-00-00 00:00:00'
        },
        {
            name: 'DOBFormatted',
            type: 'string',
            persist: false,
            convert: function (v, record) {
                return Ext.Date.format(record.get('DOB'), g('date_display_format'));
            }
        },
        {
            name: 'marital_status',
            type: 'string',
            comment: 'marital status'
        },
        {
            name: 'pubpid',
            type: 'string',
            index: true,
            comment: 'external reference id'
        },
        {
            name: 'race',
            type: 'string',
            comment: 'race'
        },
        {
            name: 'secondary_race',
            type: 'string',
            comment: 'secondary race'
        },
        {
            name: 'ethnicity',
            type: 'string',
            comment: 'ethnicity'
        },
        {
            name: 'language',
            type: 'string',
            comment: 'language'
        },
        {
            name: 'first_visit_date',
            type: 'date',
            dataType: 'date',
            dateFormat: 'Y-m-d'
        },
        {
            name: 'administrative_status',
            type: 'string',
            comment: 'active | inactive | merged'
        },
	    {
		    name: 'phone_publicity',
		    type: 'string'
	    },
	    {
		    name: 'service_date',
		    ype: 'date',
		    dateFormat: 'Y-m-d H:i:s'
	    },
	    {
		    name: 'providers',
		    type: 'string'
	    },
	    {
		    name: 'allergies',
		    type: 'string'
	    },
	    {
		    name: 'problems',
		    type: 'string'
	    },
	    {
		    name: 'medications',
		    type: 'string'
	    },
	    {
		    name: 'lab_results',
		    type: 'string'
	    }
    ],
    idProperty: 'pid',
    proxy: {
        type: 'direct',
        api: {
            read: 'Patient.search'
        },
	    reader:{
		    root: 'data'
	    }
    },
	getAge: function (birthDate) {
		var today = new Date();
		var age = today.getFullYear() - birthDate.getFullYear();
		var m = today.getMonth() - birthDate.getMonth();
		if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
			age--;
		}
		return age;
	}
});

Ext.define('App.store.patient.PatientSearch', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.PatientSearch',
});

Ext.define('App.model.administration.LegalLetterSignature', {
	extend: 'Ext.data.Model',
	table: {
		name: 'legal_letters_signatures'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'letter_id',
			type: 'int',
			index: true
		},
		{
			name: 'document_id',
			type: 'int',
			index: true
		},
		{
			name: 'letter_version',
			type: 'string',
			index: true,
			len: 20
		},
		{
			name: 'signature',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'signature_ip',
			type: 'string',
			len: 80
		},
		{
			name: 'signature_date',
			type: 'date'
		},
		{
			name: 'signature_hash',
			type: 'string',
			len: 128
		},
		{
			name: 'letter_title',
			type: 'string',
			store: false
		},
		{
			name: 'letter_content',
			type: 'string',
			store: false
		},
		{
			name: 'document_code',
			type: 'string',
			store: false
		},
		{
			name: 'signer_fname',
			type: 'string',
			store: false
		},
		{
			name: 'signer_mname',
			type: 'string',
			store: false
		},
		{
			name: 'signer_lname',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'LegalLetters.getLegalLetterSignatures',
			create: 'LegalLetters.addLegalLetterSignature'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});

Ext.define('App.store.administration.LegalLetterSignatures', {
	model: 'App.model.administration.LegalLetterSignature',
	extend: 'Ext.data.Store'
}); 
Ext.define('App.model.patient.SocialPsychologicalBehavioral', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_social_psycho_behavioral'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'pay_basics',
			type: 'int'
		},
		{
			name: 'edu_highest_grade',
			type: 'int'
		},
		{
			name: 'stress_level',
			type: 'int'
		},
		{
			name: 'stress_sleep',
			type: 'int'
		},
		{
			name: 'interest_pleasure',
			type: 'int'
		},
		{
			name: 'feeling_down_depressed',
			type: 'int'
		},
		{
			name: 'patient_health_score',
			type: 'int',
			comment: 'interest_pleasure + feeling_down_depressed'
		},
		{
			name: 'exercise_past_days_amount',
			type: 'int'
		},
		{
			name: 'exercise_past_days_minutes',
			type: 'int'
		},
		{
			name: 'drink_often',
			type: 'int'
		},
		{
			name: 'drink_per_day',
			type: 'int'
		},
		{
			name: 'drink_more_than_6',
			type: 'int'
		},
		{
			name: 'patient_drink_score',
			type: 'int',
			comment: 'drink_often + drink_per_day + patient_health_score'
		},
		{
			name: 'marital_status',
			type: 'int'
		},
		{
			name: 'phone_family',
			type: 'int'
		},
		{
			name: 'together_friends',
			type: 'int'
		},
		{
			name: 'religious_services',
			type: 'int'
		},
		{
			name: 'belong_organizations',
			type: 'int'
		},
		{
			name: 'patient_isolation_score',
			type: 'int',
			comment: 'marital_status + phone_family + together_friends + religious_services + belong_organizations'
		},
		{
			name: 'abused_by_partner',
			type: 'int'
		},
		{
			name: 'afraid_of_partner',
			type: 'int'
		},
		{
			name: 'raped_by_partner',
			type: 'int'
		},
		{
			name: 'physically_hurt_by_partner',
			type: 'int'
		},
		{
			name: 'patient_humiliation_score',
			type: 'int',
			comment: 'abused_by_partner + afraid_of_partner + raped_by_partner + physically_hurt_by_partner + patient_humiliation_score'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'user ID who created the record'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'user ID who updated the record'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'SocialPsychologicalBehavioral.getSocialPsychologicalBehaviors',
			create: 'SocialPsychologicalBehavioral.addSocialPsychologicalBehavior',
			update: 'SocialPsychologicalBehavioral.updateSocialPsychologicalBehavior'
		}
	}
});
Ext.define('App.store.patient.SocialPsychologicalBehavioral', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.SocialPsychologicalBehavioral'
});



Ext.define('App.view.patient.MiniMentalStateExam', {
	extend: 'Ext.grid.Panel',
	requires: [

	],
	itemId: 'MiniMentalStateExamGridPanel',
	xtype: 'minimentalstateexamgridpanel',
	title: _('mini_mental'),
	tbar: [
		{
			text: _('mini_mental'),
			iconCls: 'icoAdd',
			action: 'encounterRecordAdd',
			itemId: 'MiniMentalStateExamAddBtn'
		}
	],
	initComponent: function () {

		var me = this;

		me.store = Ext.create('App.store.patient.MiniMentalStateExams', {
			remoteFilter: true
		});

		me.columns = [
			{
				xtype: 'datecolumn',
				text: _('observation_date'),
				dataIndex: 'create_date',
				format: 'F j, Y',
				width: 110
			},
			{
				text: _('total_score'),
				dataIndex: 'total_score',
				width: 110,
				renderer: function (v) {

					return v;
				}
			},
			{
				text: _('questionary'),
				dataIndex: 'id',
				flex: 1,
				renderer: function (v, meta, record) {
					var str = '<div style="display: table">';

					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('orientation_time'), record.get('orientation_time_score'), _('notes'), record.get('orientation_time_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('orientation_place'), record.get('orientation_place_score'), _('notes'), record.get('orientation_place_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('registration'), record.get('registration_score'), _('notes'), record.get('registration_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('attention_calculation'), record.get('attention_calculation_score'), _('notes'), record.get('attention_calculation_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('recall'), record.get('recall_score'), _('notes'), record.get('recall_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('language'), record.get('language_score'), _('notes'), record.get('language_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('repetition'), record.get('repetition_score'), _('notes'), record.get('repetition_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"> - {2}: {3}</div></div>',
						_('complex_commands'), record.get('complex_commands_score'), _('notes'), record.get('complex_commands_notes')
					);
					str += Ext.String.format(
						'<div style="display: table-row"><div style="display: table-cell; padding-bottom: 3px;"><b>{0}: </b></div><div style="display: table-cell; padding-left: 5px;">{1}</div> <div style="display: table-cell"></div></div>',
						_('assess_lvl'), record.get('assess_lvl')
					);

					str += '</div>';

					return str;
				}
			}
		];

		me.callParent();
	}

});

Ext.define('App.model.patient.MiniMentalStateExam', {
	extend: 'Ext.data.Model',
	table: {
		name: 'patient_mini_mental_exams'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'orientation_time_score',
			type: 'int'
		},
		{
			name: 'orientation_place_score',
			type: 'int'
		},
		{
			name: 'registration_score',
			type: 'int'
		},
		{
			name: 'attention_calculation_score',
			type: 'int'
		},
		{
			name: 'recall_score',
			type: 'int'
		},
		{
			name: 'language_score',
			type: 'int'
		},
		{
			name: 'repetition_score',
			type: 'int'
		},
		{
			name: 'complex_commands_score',
			type: 'int'
		},
		{
			name: 'total_score',
			type: 'int'
		},
		{
			name: 'orientation_time_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'orientation_place_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'registration_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'attention_calculation_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'recall_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'language_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'repetition_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'complex_commands_notes',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'assess_lvl',
			type: 'string',
			len: 10
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'user ID who created the record'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'user ID who updated the record'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'MiniMentalStateExam.getMiniMentalStateExams',
			create: 'MiniMentalStateExam.addMiniMentalStateExam',
			update: 'MiniMentalStateExam.updateMiniMentalStateExam'
		}
	}
});
Ext.define('App.store.patient.MiniMentalStateExams', {
	extend: 'Ext.data.Store',
	model: 'App.model.patient.MiniMentalStateExam'
});



Ext.define('App.model.administration.EncounterSnippet', {
	extend: 'Ext.data.Model',
	table: {
		name: 'soap_snippets'
	},
	fields: [
		{
			name: 'id',
			type: 'string'
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'specialty_id',
			type: 'int',
			index: true
		},
		{
			name: 'index',
			type: 'int'
		},
		{
			name: 'description',
			type: 'string',
			len: 80
		},
		{
			name: 'category',
			type: 'string',
			len: 50
		},
		{
			name: 'subjective',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'objective',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'assessment',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'instructions',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'diagnoses',
			type: 'string',
			dataType: 'text'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Snippets.getSoapSnippets',
			create: 'Snippets.addSoapSnippets',
			update: 'Snippets.updateSoapSnippets',
			destroy: 'Snippets.deleteSoapSnippets'
		}
	}
});
Ext.define('App.store.administration.EncounterSnippets', {
	model: 'App.model.administration.EncounterSnippet',
	extend: 'Ext.data.Store'
});
Ext.define('App.controller.Speak', {
	extend: 'Ext.app.Controller',

	refs: [

	],

	init: function () {

		var me = this;

		me.voices = [];
        me.voice_enabled = false;
        me.voice_lang = 'en';
        me.voice_gender = 'female';

        if(SpeechSynthesisUtterance){
	        me.voices = window.speechSynthesis.getVoices();
        }

    },

	speak: function(message){
        var me = this, msg, voices;

        if(SpeechSynthesisUtterance){
	        voices = window.speechSynthesis.getVoices();
	        msg = new SpeechSynthesisUtterance();
	        msg.voice = me.voice_gender === 'female' ? voices[32] : voices[0];
	        msg.text = message;
	        window.speechSynthesis.speak(msg);
        }
	}


});
Ext.define('App.model.patient.encounter.Addendum', {
	extend: 'Ext.data.Model',
	table: {
		name: 'encounter_addenda'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'pid',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int'
		},
		{
			name: 'source',
			type: 'string',
			len: 60
		},
		{
			name: 'notes',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'created_by_fname',
			type: 'string',
			store: false
		},
		{
			name: 'created_by_mname',
			type: 'string',
			store: false
		},
		{
			name: 'created_by_lname',
			type: 'string',
			store: false
		},
		{
			name: 'created_by',
			type: 'string',
			convert: function (v,r){
				return Ext.String.format('{0}, {1} {2}', r.get('created_by_lname'), r.get('created_by_fname'), r.get('created_by_mname'))
			},
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'EncounterAddenda.getEncounterAddenda',
			create: 'EncounterAddenda.addEncounterAddendum',
			update: 'EncounterAddenda.updateEncounterAddendum',
			destroy: 'EncounterAddenda.destroyEncounterAddendum'
		}
	}
});

Ext.define('App.store.patient.encounter.Addenda', {
    model: 'App.model.patient.encounter.Addendum',
    extend: 'Ext.data.Store',
	autoLoad: false
});
Ext.define('App.model.patient.ProgressNotesHistory', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'service_date',
			type: 'date'
		},
		{
			name: 'brief_description',
			type: 'string'
		},
		{
			name: 'subjective',
			type: 'string'
		},
		{
			name: 'objective',
			type: 'string'
		},
		{
			name: 'assessment',
			type: 'string'
		},
		{
			name: 'plan',
			type: 'string'
		},
		{
			name: 'addenda',
			type: 'string'
		},
		{
			name: 'instructions',
			type: 'string'
		},
		{
			name: 'specialty_id',
			type: 'int'
		},
		{
			name: 'provider_uid',
			type: 'int'
		},
		{
			name: 'provider_title',
			type: 'string'
		},
		{
			name: 'provider_lname',
			type: 'string'
		},
		{
			name: 'provider_fname',
			type: 'string'
		},
		{
			name: 'provider_mname',
			type: 'string'
		},
		{
			name: 'provider_npi',
			type: 'string'
		},
		{
			name: 'provider',
			type: 'string',
			convert: function(v, record){
				return Ext.String.format(
					'{0}, {1} {2} - {3}',
					record.get('provider_lname'),
					record.get('provider_fname'),
					record.get('provider_mname'),
					record.get('provider_npi')
				)
			}
		},
		{
			name: 'progress',
			type: 'string',
			convert: function(v, record){
				var my_encounter_style = record.get('provider_uid') === app.user.id ? 'background-color:#ffff003d;' : '',
				str = '<div style="width:90%; display: inline-block; font-size: 125%; padding: 5px 0 5px 5px; color: black; ' + my_encounter_style +'">';
				str += '<b>' + _('provider') + ':</b> ' + Ext.String.htmlDecode(record.get('provider')) + '<br>';
				str += '<b>' + _('service_date') + ':</b> ' + Ext.Date.format(record.get('service_date'), 'F j, Y, g:i a (l)') + '<br>';
				str += '--------------------- <br>';
				str += '<b>' + _('chief_complaint') + ':</b> ' + Ext.String.htmlDecode(record.get('brief_description')) + '<br>';
				str += '--------------------- <br>';
				str += '<b>' + _('subjective') + ':</b> ' + Ext.String.htmlDecode(record.get('subjective')) + '<br>';
				str += '<b>' + _('objective') + ':</b> ' + Ext.String.htmlDecode(record.get('objective')) + '<br>';
				str += '<b>' + _('assessment') + ':</b> ' + Ext.String.htmlDecode(record.get('assessment')) + '<br>';
				str += '<b>' + _('plan') + ':</b> ' +  Ext.String.htmlDecode(record.get('plan')) + '<br>';

				if(record.get('addenda') !== 'NONE'){
					str += '<b>' + _('addenda') + ':</b> ' +  Ext.String.htmlDecode(record.get('addenda')) + '<br>';
				}
				// str += '<b>' + _('instructions') + ':</b> ' + Ext.String.htmlDecode(record.data.instructions) + '<br>';
				return str + '</div>';
			}
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Encounter.getSoapHistory'
		}
	}
});
Ext.define('App.store.patient.ProgressNotesHistory', {
	extend: 'Ext.data.TreeStore',
	requires:['App.model.patient.ProgressNotesHistory'],
	model: 'App.model.patient.ProgressNotesHistory',
	remoteFilter: false
});



Ext.define('App.view.administration.ContentManagement', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('content_management'),
    itemId: 'AdministrationContentManagement',
    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.ContentManagement');

        me.grid = Ext.create('Ext.grid.Panel', {
            itemId: 'ContentManagementGrid',
            store: me.store,
            title: _('content_management'),
            columnsLines: true,
            tbar: [
                {
                    xtype: 'button',
                    iconCls: 'icoAdd',
                    itemId: 'ContentManagementAddBtn',
                    text: _('add_content')
                },
            ],
            columns: [
                {
                    xtype: 'griddeletecolumn',
                    acl: true,
                    width: 20
                },
                {
                    text: _('content_type'),
                    dataIndex: 'content_type',
                    flex: 1
                },
                {
                    text: _('content_lang'),
                    dataIndex: 'content_lang',
                    flex: 1
                },
                {
                    text: _('content_body'),
                    dataIndex: 'content_body',
                    flex: 1
                },
                {
                    text: _('content_version'),
                    dataIndex: 'content_version',
                    flex: 1
                }
            ],
            bbar: {
                xtype: 'pagingtoolbar',
                pageSize: 50,
                store: me.store,
                displayInfo: true,
                plugins: new Ext.ux.SlidingPager()
            }
        });

        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    }
});
Ext.define('App.model.administration.ContentManagement', {
    extend: 'Ext.data.Model',
    table: {
        name: 'content_management'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'content_type',
            type: 'string',
            len: 45,
            index: true
        },
        {
            name: 'content_lang',
            type: 'string',
            len: 3,
            index: true
        },
        {
            name: 'content_body',
            type: 'string',
            dataType: 'mediumtext'
        },
        {
            name: 'is_html',
            type: 'bool'
        },
        {
            name: 'content_version',
            type: 'string',
            len:10,
            index: true
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'ContentManagement.getContentManagements',
            create: 'ContentManagement.addContentManagement',
            update: 'ContentManagement.updateContentManagement',
            destroy: 'ContentManagement.destroyContentManagement'
        },
        reader: {
            root: 'data'
        },
        writer: {
            writeAllFields: true
        },
        remoteGroup: false
    }
});

Ext.define('App.store.administration.ContentManagement', {
    extend: 'Ext.data.Store',
    requires: ['App.model.administration.ContentManagement'],
    model: 'App.model.administration.ContentManagement'
});
Ext.define('App.model.administration.DecisionSupportRuleConcept', {
	extend: 'Ext.data.Model',
	table: {
		name: 'support_rule_concepts'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'rule_id',
			type: 'int',
			comment: 'support_rule.id'
		},
		{
			name: 'concept_type',
			type: 'string',
			len: 10,
			comment: 'PROC PROB MEDI SOCI ALLE LAB VITA'
		},
		{
			name: 'concept_text',
			type: 'string',
			len: 25
		},
		{
			name: 'concept_code',
			type: 'string',
			len: 25
		},
		{
			name: 'concept_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'frequency',
			type: 'int',
			len: 3
		},
		{
			name: 'frequency_interval',
			type: 'string',
			len: 3,
			comment: '1D = one day 2M = two month 1Y = one year'
		},
		{
			name: 'frequency_operator',
			type: 'string',
			len: 5,
			comment: '== != <= >= < >',
			convert: function(v){
				return Ext.util.Format.htmlDecode(v);
			}
		},
		{
			name: 'value_operator',
			type: 'string',
			len: 5,
			comment: '== != <= >= < >',
			convert: function(v){
				return Ext.util.Format.htmlDecode(v);
			}
		},
		{
			name: 'value',
			type: 'string',
			len: 10
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DecisionSupport.getDecisionSupportRuleConcepts',
			create: 'DecisionSupport.addDecisionSupportRuleConcept',
			update: 'DecisionSupport.updateDecisionSupportRuleConcept',
			destroy: 'DecisionSupport.deleteDecisionSupportRuleConcept'
		}
	}
});
Ext.define('App.model.administration.DecisionSupportRule', {
	extend: 'Ext.data.Model',
	requires: 'App.model.administration.DecisionSupportRuleConcept',
	table: {
		name: 'support_rules'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'category',
			type: 'string',
			len: 10,
			defaultValue: 'C',
			comment: 'C = Clinical A = Administrative P = Physician N = Nurse'
		},
        {
            name: 'category_name',
            type: 'string',
            store: false
        },
		{
			name: 'alert_type',
			type: 'string',
			len: 2,
			defaultValue: 'P',
			comment: 'A = Active P = Passive'
		},
		{
			name: 'description',
			type: 'string'
		},
		{
			name: 'service_type',
			type: 'string',
			len: 10,
			comment: 'PROC IMMU DX MEDI LAB RAD'
		},
		{
			name: 'service_text',
			type: 'string'
		},
		{
			name: 'service_code',
			type: 'string',
			len: 25
		},
		{
			name: 'service_code_type',
			type: 'string',
			len: 10
		},
		{
			name: 'age_start',
			type: 'int',
			defaultValue: '0'
		},
		{
			name: 'age_end',
			type: 'int',
			defaultValue: '0'
		},
		{
			name: 'sex',
			type: 'string',
			len: 5
		},
		{
			name: 'warning',
			type: 'string',
			len: 5,
			comment: 'examples 1W or 5M or 1Y'
		},
		{
			name: 'past_due',
			type: 'string',
			len: 5,
			comment: 'examples 1W or 5M or 1Y'
		},
		{
			name: 'reference',
			type: 'string'
		},
		{
			name: 'reference_type',
			type: 'string',
			len: 40
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DecisionSupport.getDecisionSupportRules',
			create: 'DecisionSupport.addDecisionSupportRule',
			update: 'DecisionSupport.updateDecisionSupportRule',
			destroy: 'DecisionSupport.deleteDecisionSupportRule'
		},
		reader: {
			root: 'data'
		}
	},
	hasMany: [
		{
			model: 'App.model.administration.DecisionSupportRuleConcept',
			name: 'concepts',
			foreignKey: 'rule_id'
		}
	]
});

Ext.define('App.store.administration.DecisionSupportRules', {
	requires: ['App.model.administration.DecisionSupportRule'],
	model: 'App.model.administration.DecisionSupportRule',
	extend: 'Ext.data.Store'
});
Ext.define('App.store.administration.DecisionSupportRulesConcepts', {
	requires: ['App.model.administration.DecisionSupportRuleConcept'],
	model: 'App.model.administration.DecisionSupportRuleConcept',
	extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.DecisionSupport', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'App.ux.grid.RowFormEditing',
		'Ext.grid.plugin.CellEditing',
		'App.store.administration.DecisionSupportRules',
		'App.store.administration.DecisionSupportRulesConcepts',
		'App.ux.combo.Combo',
		'App.ux.LiveCPTSearch',
		'App.ux.LiveSnomedProblemSearch',
		'App.ux.LiveRXNORMSearch',
		'App.ux.LiveRXNORMAllergySearch'
	],
	itemId: 'decisionSupportAdminPanel',
	pageTitle: _('decision_support'),
	pageBody: [
		{
			xtype: 'grid',
			itemId: 'decisionSupportAdminGrid',
			region: 'center',
			store: this._adminDecisionSupportStore = Ext.create('App.store.administration.DecisionSupportRules'),
			columns: [
				{
					xtype: 'actioncolumn',
					width: 30,
					items: [
						{
							icon: 'resources/images/icons/delete.png', // Use a URL in the icon config
							tooltip: _('remove'),
							handler: function(grid, rowIndex, colIndex, item, e, record){
								App.app.getController('administration.DecisionSupport').doRemoveRule(record);
							}
						}
					]
				},
				{
					flex: 1,
					header: _('description'),
					sortable: true,
					dataIndex: 'description'
				},
                {
                    width: 100,
                    header: _('category'),
                    sortable: true,
                    dataIndex: 'category_name'
                },
				{
					width: 100,
					header: _('age_start'),
					sortable: true,
					dataIndex: 'age_start'
				},
				{
					width: 100,
					header: _('age_end'),
					sortable: true,
					dataIndex: 'age_end'
				},
				{
					width: 100,
					header: _('sex'),
					sortable: true,
					dataIndex: 'sex'
				},
				{
					width: 100,
					header: _('frequency'),
					sortable: true,
					dataIndex: 'frequency'
				},
				{
					width: 50,
					header: _('active'),
					dataIndex: 'active',
					renderer: function(v){
						return app.boolRenderer(v);
					}
				}
			],
			tbar: Ext.create('Ext.PagingToolbar', {
				displayInfo: true,
				emptyMsg: _('no_office_notes_to_display'),
				plugins: Ext.create('Ext.ux.SlidingPager'),
				store: this._adminDecisionSupportStore,
				items: [
					'-',
					{
						xtype: 'button',
						text: _('new_rule'),
						iconCls: 'icoAdd',
						itemId: 'decisionSupportRuleAddBtn'
					}
				]
			}),
			plugins: Ext.create('App.ux.grid.RowFormEditing', {
				autoCancel: false,
				errorSummary: false,
				clicksToEdit: 2,
				items: [
					{
						xtype: 'tabpanel',
						action: _('immunizations'),
						layout: 'fit',
						itemId: 'decisionSupportEditorTabPanel',
						items: [
							// TAB General
							{
								xtype: 'container',
								title: _('general'),
								padding: 10,
								layout: 'vbox',
								items: [
									{
										/**
										 * line One
										 */
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											action: 'field'
										},
										items: [
											{
												xtype: 'textfield',
												fieldLabel: _('description'),
												name: 'description',
												width: 703
											},
											{
												fieldLabel: _('active'),
												xtype: 'checkboxfield',
												labelWidth: 75,
												name: 'active'
											}
										]
									},
									{
										/**
										 * Line two
										 */
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											action: 'field'
										},
										items: [
											{
												xtype: 'mitos.codestypescombo',
												fieldLabel: _('coding_system'),
												name: 'service_code_type'
											},
											{
												xtype: 'textfield',
												fieldLabel: _('code'),
												width: 458,
												name: 'service_code'
											}
										]
									},
									{
										/**
										 * Line three
										 */
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											action: 'field'
										},
										items: [
											{
												xtype: 'numberfield',
												fieldLabel: _('age_start'),
												name: 'age_start',
												value: 0,
												minValue: 0
											},
											{
												xtype: 'gaiaehr.sexcombo',
												fieldLabel: _('sex'),
												name: 'sex',
												margin: '0 10 5 0'
											}
										]

									},
									{
										/**
										 * Line three
										 */
										xtype: 'fieldcontainer',
										layout: 'hbox',
										defaults: {
											margin: '0 10 0 0',
											action: 'field'
										},
										items: [
											{
												xtype: 'numberfield',
												fieldLabel: _('age_end'),
												name: 'age_end',
												value: 0,
												minValue: 0
											},
											{
												xtype: 'textfield',
												fieldLabel: _('reference'),
												name: 'reference',
												width: 458
											}
										]
									},
                                    {
                                        /**
                                         * Line four
                                         */
                                        xtype: 'fieldcontainer',
                                        layout: 'hbox',
                                        defaults: {
                                            margin: '0 10 0 0',
                                            action: 'field'
                                        },
                                        items: [
                                            {
                                                xtype: 'combo',
                                                fieldLabel: _('category'),
                                                name: 'category',
                                                queryMode: 'local',
                                                displayField: 'category_name',
                                                valueField: 'category',
                                                store: Ext.create('Ext.data.Store', {
                                                    fields: [
                                                        'category_name',
                                                        'category'
                                                    ],
                                                    data : [
                                                        {
                                                            "category":"C",
                                                            "category_name":"Clinical"
                                                        },
                                                        {
                                                            "category":"A",
                                                            "category_name":"Administrative"
                                                        },
                                                        {
                                                            "category":"P",
                                                            "category_name":"Physician"
                                                        },
                                                        {
                                                            "category":"N",
                                                            "category_name":"Nurse"
                                                        }
                                                    ]
                                                })
                                            },
	                                        {
		                                        xtype: 'combo',
		                                        fieldLabel: _('reference_type'),
		                                        name: 'reference_type',
		                                        queryMode: 'local',
		                                        displayField: 'option',
		                                        valueField: 'value',
		                                        editable: false,
		                                        width: 458,
		                                        store: Ext.create('Ext.data.Store', {
			                                        fields: [ 'option', 'value' ],
			                                        data : [
				                                        {
					                                        option: 'Diagnostic and Therapeutic Reference',
					                                        value: 'D'
				                                        },
				                                        {
					                                        option: 'Evidence-Based CDS Intervention',
					                                        value: 'E'
				                                        }
			                                        ]
		                                        })
	                                        },
                                        ]
                                    }
								]
							},
							// TAB Procedures
							{
								xtype: 'grid',
								title: _('procedures'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'PROC',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'livecptsearch',
										fieldLabel: _('add_procedure'),
										hideLabel: false,
										margin: '0 0 0 5',
										flex: 1,
										itemId: 'DecisionSupportProcedureCombo'
									}
								]
							},
							// TAB Active Problems
							{
								xtype: 'grid',
								title: _('active_problems'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'PROB',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'snomedliveproblemsearch',
										fieldLabel: _('add_problem'),
										hideLabel: false,
										margin: '0 0 0 5',
										flex: 1,
										itemId: 'DecisionSupportProblemCombo'
									}
								]
							},
							// TAB Social Lifestyle
							{
								xtype: 'grid',
								title: _('social_lifestyle'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'SOCI',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('value'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'value_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('value'),
												dataIndex: 'value',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'gaiaehr.combo',
										fieldLabel: _('add_social_lifestyle'),
										itemId: 'DecisionSupportSocialHistoryCombo',
										margin: '0 0 0 5',
										width: 350,
										list: 101
									},
									{
										xtype: 'button',
										iconCls: 'icoAdd',
										itemId: 'DecisionSupportSocialHistoryAddBtn'
									}
								]
							},
							// TAB Medications
							{
								xtype: 'grid',
								title: _('medications'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'MEDI',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('value'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'value_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('value'),
												dataIndex: 'value',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('within'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'rxnormlivetsearch',
										fieldLabel: _('add_medication'),
										hideLabel: false,
										margin: '0 0 0 5',
										flex: 1,
										itemId: 'DecisionSupportMedicationCombo'
									}
								]
							},
							// TAB Medication Allergies
							{
								xtype: 'grid',
								title: _('medication_allergies'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'ALLE',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('value'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'value_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('value'),
												dataIndex: 'value',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'rxnormallergylivetsearch',
										fieldLabel: _('add_medication'),
										hideLabel: false,
										margin: '0 0 0 5',
										flex: 1,
										itemId: 'DecisionSupportMedicationAllergyCombo'
									}
								]
							},
							// TAB LAB
							{
								xtype: 'grid',
								title: _('labs'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'LAB',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('value'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'value_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('value'),
												dataIndex: 'value',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'labslivetsearch',
										fieldLabel: _('add_labs'),
										hideLabel: false,
										margin: '0 0 0 5',
										flex: 1,
										itemId: 'DecisionSupportLabCombo'
									}
								]
							},
							// TAB
							{
								xtype: 'grid',
								title: _('vitals'),
								store: Ext.create('App.store.administration.DecisionSupportRulesConcepts'),
								action: 'VITA',
								columns: [
									{
										xtype: 'actioncolumn',
										width: 20,
										items: [
											{
												icon: 'resources/images/icons/delete.png',
												tooltip: _('remove'),
												handler: function(grid, rowIndex, colIndex, item, e, record){
													App.app.getController('administration.DecisionSupport').doRemoveRuleConcept(record);
												}
											}
										]
									},
									{
										header: _('concept'),
										flex: 1,
										dataIndex: 'concept_text'
									},
									{
										text: _('value'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'value_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('value'),
												dataIndex: 'value',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									},
									{
										text: _('frequency'),
										columns: [
											{
												header: _('operator'),
												dataIndex: 'frequency_operator',
												width: 180,
												editor: {
													xtype: 'gaiaehr.combo',
													list: 111
												}
											},
											{
												header: _('frequency'),
												dataIndex: 'frequency',
												editor: {
													xtype: 'numberfield'
												}
											},
											{
												header: _('interval'),
												dataIndex: 'frequency_interval',
												editor: {
													xtype: 'textfield'
												}
											}
										]
									}
								],
								plugins: [
									{
										ptype: 'cellediting',
										autoCancel: true,
										errorSummary: false,
										clicksToEdit: 2
									}
								],
								tbar: [
									{
										xtype: 'gaiaehr.combo',
										fieldLabel: _('add_vital'),
										labelWidth: 60,
										hideLabel: false,
										margin: '0 0 0 5',
										list: 110,
										width: 350,
										itemId: 'DecisionSupportVitalCombo'
									},
									{
										xtype: 'button',
										iconCls: 'icoAdd',
										itemId: 'DecisionSupportVitalAddBtn'
									}
								]
							}
						]
					}
				]
			})
		}
	]
});

Ext.define('App.model.administration.DocumentsPdfTemplate', {
	extend: 'Ext.data.Model',
	table: {
		name: 'documents_pdf_templates'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'template',
			type: 'string',
			len: 250
		},
		{
			name: 'body_margin_left',
			type: 'int',
			len: 3
		},
		{
			name: 'body_margin_top',
			type: 'int',
			len: 3
		},
		{
			name: 'body_margin_right',
			type: 'int',
			len: 3
		},
		{
			name: 'body_margin_bottom',
			type: 'int',
			len: 3
		},
		{
			name: 'body_font_family',
			type: 'string',
			len: 60
		},
		{
			name: 'body_font_style',
			type: 'string',
			len: 3
		},
		{
			name: 'body_font_size',
			type: 'string',
			len: 3
		},
		{
			name: 'header_data',
			type: 'array'
		},
		{
			name: 'header_line',
			type: 'bool'
		},
		{
			name: 'footer_margin',
			type: 'int',
			len: 3
		},
		{
			name: 'is_interface_tpl',
			type: 'bool',
			index: true
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DocumentsPdfTemplates.getDocumentsPdfTemplates',
			create: 'DocumentsPdfTemplates.addDocumentsPdfTemplate',
			update: 'DocumentsPdfTemplates.updateDocumentsPdfTemplate',
			destroy: 'DocumentsPdfTemplates.destroyDocumentsPdfTemplate'
		}
	}
});
Ext.define('App.store.administration.DocumentsPdfTemplates', {
	extend: 'Ext.data.Store',
	model: 'App.model.administration.DocumentsPdfTemplate'
}); 
Ext.define('App.view.administration.EmailTemplates', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('email_templates'),
    itemId: 'AdministrationEmailTemplates',
    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.EmailTemplates');

        me.grid = Ext.create('Ext.grid.Panel', {
            itemId: 'AdministrationEmailTemplatesGrid',
            store: me.store,
            columns: [
                {
                    text: _('facility'),
                    width: 200,
                    dataIndex: 'facility_id'
                },
                {
                    text: _('template_type'),
                    sortable: true,
                    dataIndex: 'template_type'
                },
                {
                    text: _('language'),
                    sortable: true,
                    dataIndex: 'language'
                },
                {
                    text: _('subject'),
                    sortable: true,
                    dataIndex: 'subject',
                    flex: 1
                },
                {
                    text: _('from_email'),
                    sortable: true,
                    dataIndex: 'from_email',
                    flex: 1
                },
                {
                    text: _('from_name'),
                    sortable: true,
                    dataIndex: 'from_name',
                    flex: 1
                },
                {
                    text: _('active?'),
                    width: 60,
                    sortable: true,
                    renderer: me.boolRenderer,
                    dataIndex: 'active',
                    editor:{
                        xtype:'checkbox'
                    }
                }
            ],
            bbar: {
                xtype: 'pagingtoolbar',
                pageSize: 25,
                store: me.store,
                displayInfo: true,
                plugins: new Ext.ux.SlidingPager()
            }
        });
        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    }
});

Ext.define('App.model.administration.EmailTemplate', {
	extend: 'Ext.data.Model',
	table: {
		name: 'email_templates'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'template_type',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'language',
			type: 'string',
			len: 5
		},
		{
			name: 'subject',
			type: 'string',
			len: 250
		},
		{
			name: 'from_email',
			type: 'string',
			len: 250
		},
		{
			name: 'from_name',
			type: 'string',
			len: 250
		},
		{
			name: 'body',
			type: 'string',
			dataType: 'mediumtext'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'EmailTemplates.getEmailTemplates',
			create: 'EmailTemplates.addEmailTemplate',
			update: 'EmailTemplates.updateEmailTemplate'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});

Ext.define('App.store.administration.EmailTemplates', {
	model: 'App.model.administration.EmailTemplate',
	extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.EncounterTemplates', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('encounter_templates'),
    itemId: 'AdministrationEncounterTemplatesPanel',
    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.EncounterTemplatePanels');

        me.grid = Ext.create('Ext.grid.Panel', {
            itemId: 'AdministrationEncounterTemplatesGrid',
            store: me.store,
            columns: [
                {
                    text: _('specialty'),
                    width: 200,
                    sortable: true,
                    dataIndex: 'specialty'
                },
                {
                    text: _('description'),
                    flex: 1,
                    sortable: true,
                    dataIndex: 'description'
                },
                {
                    text: _('active?'),
                    width: 60,
                    sortable: true,
                    renderer: me.boolRenderer,
                    dataIndex: 'active',
                    editor:{
                        xtype:'checkbox'
                    }
                }
            ],
            tbar: [
                '->',
                {
                    xtype: 'button',
                    text: _('template'),
                    itemId: 'EncounterTemplatesAddBtn',
                    iconCls: 'icoAdd'
                }
            ],
            bbar: {
                xtype: 'pagingtoolbar',
                pageSize: 25,
                store: me.store,
                displayInfo: true,
                plugins: new Ext.ux.SlidingPager()
            }
        });
        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    }
});

Ext.define('App.store.administration.EncounterTemplatePanels', {
	model: 'App.model.administration.EncounterTemplatePanel',
	extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.Encryption', {
	extend:'App.ux.RenderPanel',
	pageTitle:_('encryption'),
	initComponent:function(){
		var me = this;

		me.container = Ext.widget('container',{
			bodyPadding:10,
			layout:'fit',
			items:[
				me.textbox = Ext.widget('textarea')
			]

		});

		me.pageTBar = [
			{
				text:_('encrypt'),
				enableToggle:true,
				toggleGroup:'encryption',
				scope:me,
				handler:me.onEncrypt
			},
			'-',
			{
				text:_('decrypt'),
				enableToggle:true,
				toggleGroup:'encryption',
				scope:me,
				handler:me.onDecrypt
			}
		];

		me.pageBody = [me.container];
		me.callParent(arguments);
	},

	onEncrypt:function(){
		var me = this,
			value = me.textbox.getValue();

		Encryption.Encrypt(value, function(provider, response){
			me.textbox.setValue(response.result);
		});
	},

	onDecrypt:function(){
		var me = this,
			value = me.textbox.getValue();
		Encryption.Decrypt(value, function(provider, response){
			me.textbox.setValue(response.result);
		});
	},

	/**
	 * This function is called from Viewport.js when
	 * this panel is selected in the navigation panel.
	 * place inside this function all the functions you want
	 * to call every this panel becomes active
	 */
	onActive:function(callback){
		callback(true);
	}
});

Ext.define('App.view.administration.FileSystems', {
	extend: 'App.ux.RenderPanel',
	requires: [

	],
	pageTitle: _('file_systems'),
	itemId: 'AdminFileSystemsPanel',
	pageLayout: {
		type: 'border',
	},
	initComponent: function(){
		var me = this;

		var store = Ext.create('App.store.administration.FileSystems');

		me.pageBody = [
			{
				xtype: 'grid',
				title: 'ONLINE File Systems',
				flex: 1,
				region: 'center',
				padding: 0,
				frame: true,
				store: store,
				itemId: 'FileSystemsGrid',
				plugins: [
					{
						ptype: 'rowediting'
					}
				],
				columns: [
					{
						text: _('id'),
						dataIndex: 'id'
					},
					{
						text: _('next_id'),
						dataIndex: 'next_id',
						editor: {
							xtype: 'textfield'
						}
					},
					{
						text: _('dir_path'),
						dataIndex: 'dir_path',
						flex: 2,
						editor: {
							xtype: 'textfield'
						}
					},
					{
						text: _('status'),
						dataIndex: 'status',
						editor: {
							xtype: 'combobox',
							displayField: 'option',
							valueField: 'value',
							editable: false,
							store: Ext.create('Ext.data.Store',{
								fields: ['option', 'value'],
								data: [
									{ option: 'ACTIVE', value: 'ACTIVE' },
									{ option: 'FULL', value: 'FULL' },
									{ option: 'ONLINE', value: 'ONLINE' },
									{ option: 'OFFLINE', value: 'OFFLINE' }
								]
							})
						}
					},
					{
						text: _('total_space'),
						dataIndex: 'total_space'
					},
					{
						text: _('free_space'),
						dataIndex: 'free_space'
					},
					{
						text: _('percent_used'),
						dataIndex: 'percent',
						renderer: function (v, meta, rec) {
							return Math.floor(Math.abs(((rec.get('free_space') / rec.get('total_space')) * 100) - 100)) + '% Used';
						}
					},
					{
						text: _('error'),
						dataIndex: 'error',
						flex: 1
					},
				],
				tbar: [
					{
						text: _('file_system'),
						itemId: 'FileSystemsAddBtn',
						iconCls: 'icoAdd'
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					store: store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager(),
					items: [
						'-',
						{
							text: _('analyze'),
							itemId: 'FileSystemsAnalyzeBtn'
						},
						'-'
					]
				}
			},
			{
				xtype: 'grid',
				title: 'NEARLINE File Systems',
				flex: 1,
				padding: 0,
				frame: true,
				region: 'south',
				split: true,
				//store: store,
				itemId: 'FileSystemsNearlineGrid',
				plugins: [
					{
						ptype: 'rowediting'
					}
				],
				columns: [
					{
						text: _('id'),
						dataIndex: 'id'
					},
					{
						text: _('next_id'),
						dataIndex: 'next_id',
						editor: {
							xtype: 'textfield'
						}
					},
					{
						text: _('dir_path'),
						dataIndex: 'dir_path',
						flex: 2,
						editor: {
							xtype: 'textfield'
						}
					},
					{
						text: _('status'),
						dataIndex: 'status',
						editor: {
							xtype: 'combobox',
							displayField: 'option',
							valueField: 'value',
							editable: false,
							store: Ext.create('Ext.data.Store',{
								fields: ['option', 'value'],
								data: [
									{ option: 'ACTIVE', value: 'ACTIVE' },
									{ option: 'FULL', value: 'FULL' },
									{ option: 'ONLINE', value: 'ONLINE' },
									{ option: 'OFFLINE', value: 'OFFLINE' }
								]
							})
						}
					},
					{
						text: _('total_space'),
						dataIndex: 'total_space'
					},
					{
						text: _('free_space'),
						dataIndex: 'free_space'
					},
					{
						text: _('percent_used'),
						dataIndex: 'percent',
						renderer: function (v, meta, rec) {
							return Math.floor(Math.abs(((rec.get('free_space') / rec.get('total_space')) * 100) - 100)) + '% Used';
						}
					},
					{
						text: _('error'),
						dataIndex: 'error',
						flex: 1
					},
				],
				tbar: [
					{
						text: _('file_system'),
						itemId: 'FileSystemsNearlineAddBtn',
						iconCls: 'icoAdd'
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					//store: store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager(),
					items: [
						'-',
						{
							text: _('analyze'),
							itemId: 'FileSystemsNearlineAnalyzeBtn'
						},
						'-'
					]
				}
			}
		];

		me.callParent(arguments);
	}

});

Ext.define('App.model.administration.FileSystem', {
	extend: 'Ext.data.Model',
	table: {
		name: 'filesystems'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'next_id',
			type: 'int',
			index: true
		},
		{
			name: 'dir_path',
			type: 'string',
			len: 180
		},
		{
			name: 'status',
			type: 'string',
			len: 15,
			index: true
		},
		{
			name: 'total_space',
			type: 'float',
			len: 11
		},
		{
			name: 'free_space',
			type: 'float',
			len: 11
		},
		{
			name: 'error',
			type: 'string',
			len: 200
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'FileSystem.getFileSystems',
			create: 'FileSystem.addFileSystem',
			update: 'FileSystem.updateFileSystem'
		}
	},
	reader: {
		totalProperty: 'total',
		root: 'data'
	}
});
Ext.define('App.store.administration.FileSystems', {
    model: 'App.model.administration.FileSystem',
    extend: 'Ext.data.Store'
});
Ext.define('App.model.administration.HL7Server', {
	extend: 'Ext.data.Model',
	table: {
		name: 'hl7_servers'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'server_name',
			type: 'string'
		},
		{
			name: 'allow_messages',
			type: 'array',
			dataType: 'longtext'
		},
		{
			name: 'allow_ips',
			type: 'array',
			dataType: 'longtext'
		},
		{
			name: 'ip',
			type: 'string',
			len: 40
		},
		{
			name: 'port',
			type: 'string',
			len: 10
		},
		{
			name: 'allow_messages_string',
			type: 'string',
			store: false,
			convert: function(v, record){
				return Ext.isArray(record.data.allow_messages) ? record.data.allow_messages.join(', ') : record.data.allow_messages;
			}
		},
		{
			name: 'allow_ips_string',
			type: 'string',
			store: false,
			convert: function(v, record){
				return Ext.isArray(record.data.allow_ips) ? record.data.allow_ips.join(', ') : record.data.allow_ips;
			}
		},
		{
			name: 'token',
			type: 'string',
			len: 100
		},
		{
			name: 'config',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'started',
			type: 'bool',
			index: true
		},
		{
			name: 'online',
			type: 'bool',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'HL7Server.getServers',
			create: 'HL7Server.addServer',
			update: 'HL7Server.updateServer',
			destroy: 'HL7Server.deleteServer'
		},
		reader: {
			totalProperty: 'total',
			root: 'data'
		}
	}
});

Ext.define('App.store.administration.HL7Servers', {
	requires:[ 'App.model.administration.HL7Server' ],
    extend: 'Ext.data.Store',
	model: 'App.model.administration.HL7Server'
});
Ext.define('App.model.administration.HL7Client', {
	extend: 'Ext.data.Model',
	table: {
		name: 'hl7_clients',
		comment: 'hl7 Clients'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'facility',
			type: 'string',
			len: 80,
			comment: 'Facility Name'
		},
		{
			name: 'facility_iso_id',
			type: 'string',
			len: 80,
			comment: 'ISO ID'
		},
		{
			name: 'physical_address',
			type: 'string',
			len: 1000,
			comment: 'Facility Name'
		},
		{
			name: 'application_name',
			type: 'string',
			len: 80,
			comment: 'Application Name'
		},
		{
			name: 'application_iso_id',
			type: 'string',
			len: 80,
			comment: 'ISO ID'
		},
		{
			name: 'route',
			type: 'string',
			comment: 'socket or http'
		},
		{
			name: 'allow_messages',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'address',
			type: 'string',
			comment: 'URL IP'
		},
		{
			name: 'port',
			type: 'string',
			len: 10,
			comment: 'url port if any'
		},
		{
			name: 'isSecure',
			type: 'bool',
			comment: 'If secure then user secret_key'
		},
		{
			name: 'secret_key',
			type: 'string'
		},
		{
			name: 'config',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'active',
			type: 'bool'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'HL7Clients.getClients',
			create: 'HL7Clients.addClient',
			update: 'HL7Clients.updateClient',
			destroy: 'HL7Clients.deleteClient'
		},
		reader: {
			totalProperty: 'total',
			root: 'data'
		}
	}
});

Ext.define('App.store.administration.HL7Clients', {
    model: 'App.model.administration.HL7Client',
    extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.HL7', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'Ext.grid.plugin.RowEditing'
	],
	xtype: 'hl7serverspanel',
	pageTitle: _('hl7'),
	pageLayout: {
		type: 'vbox',
		align: 'stretch'
	},
	pageBody: [
		{
			xtype: 'grid',
			title: _('hl7_servers'),
			store: this.sStore = Ext.create('App.store.administration.HL7Servers'),
			itemId: 'hl7serversgrid',
			flex: 1,
			frame: true,
			columnLines: true,
			margin: '0 0 5 0',
			padding: 0,
			columns: [
				{
					text: _('online'),
					dataIndex: 'online',
					width: 50,
					renderer: function(v){
						return app.boolRenderer(v);
					}
				},
				{
					text: _('server_name'),
					dataIndex: 'server_name',
					width: 150
				},
				{
					text: _('server_ip'),
					dataIndex: 'ip',
					width: 110
				},
				{
					text: _('port'),
					dataIndex: 'port',
					width: 70
				},
				{
					text: _('allowed_messages'),
					dataIndex: 'allow_messages_string',
					flex: 1
				},
				{
					text: _('allowed_ips'),
					dataIndex: 'allow_ips_string',
					flex: 1
				},
				{
					xtype: 'actioncolumn',
					width: 50,
					items: [
						{
							icon: 'resources/images/icons/icoDotGreen.png',
							tooltip: _('start'),
							margin: '0 5 0 0',
							handler: function(grid, rowIndex, colIndex, item, e, record){
								App.Current.getController('administration.HL7').serverStartHandler(record);
							}
						},
						{
							icon: 'resources/images/icons/icoDotRed.png',
							tooltip: _('stop'),
							handler: function(grid, rowIndex, colIndex, item, e, record){
								App.Current.getController('administration.HL7').serverStopHandler(record);
							}
						}
					]
				}
			],
			plugins: [
				{
					ptype: 'rowformediting',
					clicksToEdit: 2,
					items: [
						{
							xtype: 'container',
							layout: {
								type: 'hbox'
							},
							items: [
								{
									xtype: 'fieldset',
									layout: 'anchor',
									title: _('general'),
									width: 300,
									margin: '0 5 0 0',
									items: [
										{
											xtype: 'textfield',
											fieldLabel: _('server_name'),
											name: 'server_name',
											anchor: '100%'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('ip'),
											name: 'ip',
											anchor: '100%'
										},
										{
											xtype: 'textfield',
											fieldLabel: _('port'),
											name: 'port',
											anchor: '100%'
										}
									]
								},
								{
									xtype: 'fieldset',
									layout: 'anchor',
									title: _('allow_ips'),
									width: 200,
									margin: '0 5 0 0',
									items: [
										{
											xtype: 'multitextfield',
											numbers: false,
											name: 'allow_ips'
										}
									]
								},
								{
									xtype: 'fieldset',
									title: _('messages'),
									layout: 'fit',
									flex: 1,
									items: [
										{
											xtype: 'checkboxgroup',
											columns: 5,
											vertical: true,
											defaults: {
												xtype: 'checkbox',
												name: 'allow_messages',
												uncheckedValue: null
											},
											items: [
												{
													boxLabel: 'ADT_A01',
													inputValue: 'ADT_A01'
												},
												{
													boxLabel: 'ADT_A04',
													inputValue: 'ADT_A04'
												},
												{
													boxLabel: 'ADT_A08',
													inputValue: 'ADT_A08'
												},
												{
													boxLabel: 'ADT_A09',
													inputValue: 'ADT_A09'
												},
												{
													boxLabel: 'ADT_A10',
													inputValue: 'ADT_A10'
												},
												{
													boxLabel: 'ADT_A18',
													inputValue: 'ADT_A18'
												},
												{
													boxLabel: 'ADT_A28',
													inputValue: 'ADT_A28'
												},
												{
													boxLabel: 'ADT_A29',
													inputValue: 'ADT_A29'
												},
												{
													boxLabel: 'ADT_A31',
													inputValue: 'ADT_A31'
												},
												{
													boxLabel: 'ADT_A32',
													inputValue: 'ADT_A32'
												},
												{
													boxLabel: 'ADT_A33',
													inputValue: 'ADT_A33'
												},
												{
													boxLabel: 'ADT_A39',
													inputValue: 'ADT_A39'
												},
												{
													boxLabel: 'ADT_A40',
													inputValue: 'ADT_A40'
												},
												{
													boxLabel: 'ADT_A41',
													inputValue: 'ADT_A41'
												},
												{
													boxLabel: 'ORU_R01',
													inputValue: 'ORU_R01'
												},
												{
													boxLabel: 'ORU_R21',
													inputValue: 'ORU_R21'
												},
												{
													boxLabel: 'SIU_S12',
													inputValue: 'SIU_S12'
												},
												{
													boxLabel: 'SIU_S13',
													inputValue: 'SIU_S13'
												},
												{
													boxLabel: 'SIU_S14',
													inputValue: 'SIU_S14'
												},
												{
													boxLabel: 'SIU_S15',
													inputValue: 'SIU_S15'
												},
												{
													boxLabel: 'SIU_S22',
													inputValue: 'SIU_S22'
												}
											]
										}
									]
								}
							]
						}
					]
				}
			],
			tbar: Ext.create('Ext.PagingToolbar', {
				store: this.sStore,
				displayInfo: true,
				displayMsg: 'Displaying {0} - {1} of {2}',
				emptyMsg: 'No Servers to display',
				items: [
					'-',
					{
						text: _('add_server'),
						iconCls: 'icoAdd',
						itemId: 'addHL7ServerBtn'
					},
					'-',
					{
						text: _('remove_server'),
						iconCls: 'icoDelete',
						itemId: 'removeHL7ServerBtn',
						disabled: true
					},
					'-',
					{
						text: _('messages'),
						itemId: 'HL7MessagesViewBtn'
					},
					'-',
					{
						text: _('config'),
						itemId: 'HL7ServerConfigBtn'
					},
					'-'
				]
			})
		},
		{
			xtype: 'grid',
			title: _('hl7_clients'),
			store: this.cStore = Ext.create('App.store.administration.HL7Clients'),
			itemId: 'hl7clientsgrid',
			flex: 1,
			columnLines: true,
			frame: true,
			padding: 0,
			columns: [
				{
					text: _('active'),
					dataIndex: 'active',
					width: 50,
					renderer: function(v){
						return app.boolRenderer(v);
					},
					editor: {
						xtype: 'checkbox'
					}
				},
				{
					text: _('facility'),
					dataIndex: 'facility',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('facility_id'),
					dataIndex: 'facility_iso_id',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('application_name'),
					dataIndex: 'application_name',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('application_id'),
					dataIndex: 'application_iso_id',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('physical_address'),
					dataIndex: 'physical_address',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('url_ip_or_domain'),
					dataIndex: 'address',
					flex: 1,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('port'),
					dataIndex: 'port',
					width: 70,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('allow_messages'),
					dataIndex: 'allow_messages',
					width: 200,
					editor: {
						xtype: 'textfield'
					}
				},
				{
					text: _('secret_key'),
					dataIndex: 'secret_key',
					width: 200,
					hidden: true,
					editor: {
						xtype: 'textfield'
					}
				}
			],
			plugins: [
				{
					ptype: 'rowediting',
					clicksToEdit: 2
				}
			],
			tbar: Ext.create('Ext.PagingToolbar', {
				store: this.cStore,
				displayInfo: true,
				displayMsg: 'Displaying {0} - {1} of {2}',
				emptyMsg: 'No Clients to display',
				items: [
					'-',
					{
						text: _('add_client'),
						iconCls: 'icoAdd',
						itemId: 'addHL7ClientBtn'
					},
					'-',
					{
						text: _('remove_client'),
						iconCls: 'icoDelete',
						itemId: 'removeHL7ClientBtn',
						disabled: true
					},
					'-',
					{
						text: _('config'),
						itemId: 'HL7ClientConfigBtn'
					},
					'-'
				]
			})
		}
	]
});

Ext.define('App.view.administration.LegalLetters', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('legal_letters'),
    itemId: 'AdministrationLegalLetters',
    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.LegalLetters');

        me.grid = Ext.create('Ext.grid.Panel', {
            itemId: 'AdministrationLegalLettersGrid',
            store: me.store,
            tools: [
                {
                    xtype:'button',
                    text: _('letter'),
                    iconCls: 'icoAdd',
                    itemId: 'AdministrationLegalLettersAddBtn'
                }
            ],
            columns: [
                {
                    text: _('title'),
                    dataIndex: 'title',
                    flex: 1
                },
                {
                    text: _('facility'),
                    dataIndex: 'facility_id',
                    flex: 1
                },
                {
                    text: _('workflow'),
                    dataIndex: 'workflow',
                    flex: 1
                },
                {
                    text: _('version'),
                    dataIndex: 'version'
                },
                {
                    text: _('days_valid_for'),
                    dataIndex: 'days_valid_for',
                    flex: 1
                },
                {
                    text: _('active'),
                    dataIndex: 'active',
                    renderer: app.boolRenderer
                }
            ],
            bbar: {
                xtype: 'pagingtoolbar',
                pageSize: 50,
                store: me.store,
                displayInfo: true,
                plugins: new Ext.ux.SlidingPager()
            }
        });

        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    }
});
Ext.define('App.model.administration.LegalLetter', {
	extend: 'Ext.data.Model',
	table: {
		name: 'legal_letters'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'workflow',
			type: 'string',
			len: 45,
			index: true
		},
		{
			name: 'title',
			type: 'string',
			len: 120
		},
		{
			name: 'document_code',
			type: 'string',
			len: 20
		},
		{
			name: 'content',
			type: 'string',
			dataType: 'TEXT'
		},
		{
			name: 'version',
			type: 'string',
			len: 20
		},
		{
			name: 'days_valid_for',
			type: 'int'
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'update_date',
			type: 'date'
		},
		{
			name: 'facility',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'LegalLetters.getLegalLetters',
			create: 'LegalLetters.addLegalLetter',
			update: 'LegalLetters.updateLegalLetter'
		},
		reader: {
			root: 'data'
		},
		remoteGroup: false
	}
});

Ext.define('App.store.administration.LegalLetters', {
	model: 'App.model.administration.LegalLetter',
	extend: 'Ext.data.Store'
}); 
Ext.define('App.view.administration.MeasureCalculation', {
	extend: 'App.ux.RenderPanel',
	requires: [
		'App.ux.combo.Insurances'
	],
	pageTitle: 'Measure Calculations',
	itemId: 'MeasureCalculation',
	initComponent: function(){
		var me = this;

		me.pageBody = [
			{
				xtype: 'tabpanel',
				items: [
					{
						xtype: 'grid',
						title: 'Meaningful Use',
						itemId: 'MeaningfulUseGrid',
						store: Ext.create('Ext.data.ArrayStore',{
							fields: [
								{name: 'group', type: 'string'},
								{name: 'provider', type: 'string'},
								{name: 'title', type: 'string'},
								{name: 'denominator', type: 'int'},
								{name: 'numerator', type: 'int'},
								{name: 'goal', type: 'string'},
								{name: 'description', type: 'string'},
								{name: 'description_denominator', type: 'string'},
								{name: 'description_numerator', type: 'string'},
								{name: 'denominator_pids'},
								{name: 'numerator_pids'},
								{name: 'numerator_types'},
							],
							groupers: [
								{
									property: 'group',
									sorterFn: function(o1, o2){
										var getRank = function(o){
												return parseInt(o.get('group').replace(/\..*/,''));
											},
											rank1 = getRank(o1),
											rank2 = getRank(o2);

										if (rank1 === rank2) {
											return 0;
										}
										return rank1 < rank2 ? -1 : 1;
									}
								}
							]
						}),
						features: [
							{
								ftype: 'grouping',
								collapsible: false,
								groupHeaderTpl: '{name}',
							}
						],
						tbar: [
							{
								xtype: 'datefield',
								fieldLabel: _('from'),
								labelWidth: 35,
								width: 135,
								allowBlank: false,
								value: Ext.Date.subtract(new Date(), Ext.Date.YEAR, 1),
								itemId: 'MeaningfulUseFromField'
							},
							{
								xtype: 'datefield',
								fieldLabel: _('to'),
								labelWidth: 25,
								width: 125,
								allowBlank: false,
								value: new Date(),
								itemId: 'MeaningfulUseToField'
							},
							{
								xtype: 'activeproviderscombo',
								fieldLabel: _('provider'),
								labelWidth: 50,
								width: 300,
								allowBlank: false,
								//multiSelect: true,
								itemId: 'MeaningfulUseProviderField'
							},
							'-',
							{
								xtype: 'button',
								text: _('refresh'),
								itemId: 'MeaningfulUseRefreshBtn'
							},
							'->',
							{
								xtype: 'button',
								text: _('print'),
								itemId: 'MeaningfulUseGridPrintBtn'
							}
						],
						columns: [
							{
								text: _('title'),
								dataIndex: 'title',
								flex: 1
							},
							{
								text: _('provider'),
								dataIndex: 'provider',
								flex: 1
							},
							{
								text: _('denominator'),
								dataIndex: 'denominator',
								width: 150
							},
							{
								text: _('numerator'),
								dataIndex: 'numerator',
								width: 150
							},
							{
								text: _('percent'),
								dataIndex: 'goal',
								width: 150,
								renderer: function (v,m,r) {
									var pct = ((r.get('numerator')/r.get('denominator')) * 100);
									return Number.isNaN(pct) ? 'N/A' : pct.toFixed(1) + '%';
								}
							},
							{
								text: _('goal'),
								dataIndex: 'goal',
								width: 150
							}
						]
					},
					{
						xtype: 'grid',
						title: 'MIPS',
						itemId: 'MIPSGrid',
						store: Ext.create('Ext.data.ArrayStore',{
							fields: [
								{name: 'group', type: 'string'},
								{name: 'provider', type: 'string'},
								{name: 'title', type: 'string'},
								{name: 'denominator', type: 'int'},
								{name: 'numerator', type: 'int'},
								{name: 'goal', type: 'string'},
								{name: 'description', type: 'string'},
								{name: 'description_denominator', type: 'string'},
								{name: 'description_numerator', type: 'string'},
								{name: 'denominator_pids'},
								{name: 'numerator_pids'},
								{name: 'numerator_types'},
							],
							groupers: [
								{
									property: 'group',
									sorterFn: function(o1, o2){
										var getRank = function(o){
												return parseInt(o.get('group').replace(/\..*/,''));
											},
											rank1 = getRank(o1),
											rank2 = getRank(o2);

										if (rank1 === rank2) {
											return 0;
										}
										return rank1 < rank2 ? -1 : 1;
									}
								}
							]
						}),
						features: [
							{
								ftype: 'grouping',
								collapsible: false,
								groupHeaderTpl: '{name}',
							}
						],
						tbar: [
							{
								xtype: 'datefield',
								fieldLabel: _('from'),
								labelWidth: 35,
								width: 135,
								allowBlank: false,
								value: Ext.Date.subtract(new Date(), Ext.Date.YEAR, 1),
								itemId: 'MIPSGridFromField'
							},
							{
								xtype: 'datefield',
								fieldLabel: _('to'),
								labelWidth: 25,
								width: 125,
								allowBlank: false,
								value: new Date(),
								itemId: 'MIPSGridToField'
							},
							{
								xtype: 'activeproviderscombo',
								fieldLabel: _('provider'),
								labelWidth: 50,
								width: 300,
								allowBlank: false,
								//multiSelect: true,
								itemId: 'MIPSGridProviderField'
							},
							{
								xtype: 'insurancescombo',
								fieldLabel: _('insurance'),
								labelWidth: 50,
								width: 300,
								//multiSelect: true,
								itemId: 'MIPSGridInsuranceField'
							},
							{
								xtype: 'gaiaehr.combo',
								name: 'sex',
								fieldLabel: _('sex'),
								labelWidth: 25,
								width: 125,
								enableKeyEvents: true,
								allowBlank: false,
								listKey: 'sex',
								loadStore: true,
								editable: false,
								resetable: true,
								itemId: 'MIPSGridSexField'
							},
							{
								xtype: 'ethnicitycombo',
								name: 'ethnicity',
								fieldLabel: _('ethnicity'),
								labelWidth: 45,
								width: 250,
								itemId: 'MIPSGridEthnicityField'
							},
							{
								xtype: 'racecombo',
								name: 'race',
								fieldLabel: _('race'),
								labelWidth: 30,
								width: 250,
								itemId: 'MIPSGridRaceField'
							},
							'-',
							{
								xtype: 'button',
								text: _('refresh'),
								itemId: 'MIPSGridRefreshBtn'
							},
							'->',
							{
								xtype: 'button',
								text: _('print'),
								itemId: 'MIPSGridPrintBtn'
							}
						],
						columns: [
							{
								text: _('title'),
								dataIndex: 'title',
								flex: 1
							},
							{
								text: _('provider'),
								dataIndex: 'provider',
								flex: 1
							},
							{
								text: _('denominator'),
								dataIndex: 'denominator',
								width: 150
							},
							{
								text: _('numerator'),
								dataIndex: 'numerator',
								width: 150
							},
							{
								text: _('percent'),
								dataIndex: 'goal',
								width: 150,
								renderer: function (v,m,r) {
									var pct = ((r.get('numerator')/r.get('denominator')) * 100);
									return Number.isNaN(pct) ? 'N/A' : pct.toFixed(1) + '%';
								}
							},
							{
								text: _('goal'),
								dataIndex: 'goal',
								width: 150
							}
						]
					}
				]
			}

		];
		me.callParent(arguments);

	}

});

Ext.define('App.view.administration.DataPortability', {
    extend: 'App.ux.RenderPanel',
    requires: [
        'App.ux.form.fields.BoxSelect'
    ],
	pageTitle: _('patients_export'),
	pageBody: [

		{
			xtype: 'panel',
			itemId: 'DataPortabilityPanel',
			layout: 'fit',
			items: [
				{
					xtype: 'miframe',
					itemId: 'DataPortabilityPanelIFrame'
				}
			],
			tbar: [
                {
                    xtype:'form',
                    itemId: 'ExportFilterForm',
                    items:[
                        {
                            xtype: 'label',
                            text: _('service_date')
                        },
                        {
                            xtype: 'datefield',
                            name: 'service_from',
                            text: _('from'),
                            itemId: 'ServiceFromDate'
                        },
                        {
                            xtype: 'datefield',
                            name: 'service_to',
                            text: _('to'),
                            itemId: 'ServiceToDate'
                        }
                    ]
                },
                '-',
				{
                    xtype: 'button',
					text: _('export'),
					itemId: 'DataPortabilityExportBtn'
				},
				{
                    xtype: 'button',
					text: _('import'),
					itemId: 'DataPortabilityImportBtn'
				}
			]
		}
	]
});

Ext.define('App.model.administration.DocumentForm', {
	extend: 'Ext.data.Model',
	table: {
		name: 'documents_pdf_forms'
	},
	fields: [
		{
			name: 'id',
			type: 'int',
			index: true
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'document_type',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'document_title',
			type: 'string',
			len: 80
		},
		{
			name: 'document_path',
			type: 'string',
			len: 300
		},
		{
			name: 'document_path',
			type: 'string',
			len: 300
		},
		{
			name: 'signature_x',
			type: 'int',
			len: 6
		},
		{
			name: 'signature_y',
			type: 'int',
			len: 6
		},
		{
			name: 'signature_w',
			type: 'int',
			len: 6
		},
		{
			name: 'signature_h',
			type: 'int',
			len: 6
		},
		{
			name: 'flatten',
			type: 'bool'
		},
		{
			name: 'is_active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DocumentPdfForms.getDocumentPdfForms',
			create: 'DocumentPdfForms.addDocumentPdfForm',
			update: 'DocumentPdfForms.updateDocumentPdfForm'
		}
	}
});
Ext.define('App.store.administration.DocumentForms', {
    model: 'App.model.administration.DocumentForm',
    extend: 'Ext.data.Store'
});
Ext.define('App.view.administration.PoolAreas', {
	extend: 'App.ux.RenderPanel',
	itemId: 'PoolAreasPanel',
	pageTitle: _('pool_areas'),

	initComponent: function(){
		var me = this;

		var store = Ext.create('App.store.areas.PoolAreas',{
			groupField: 'facility_name',
		});

		me.pageBody = [
			{
				xtype: 'grid',
				itemId: 'PoolAreasGrid',
				store: store,
				features: [{
					ftype:'grouping',
					groupHeaderTpl: '{name}',

				}],
				plugins: [{ ptype: 'rowediting' }],
				columns: [
					{
						text: _('title'),
						dataIndex: 'title',
						flex: 1,
						editor: {
							xtype: 'textfield',
							allowBlank: false
						}
					},
					{
						text: _('concept'),
						dataIndex: 'concept',
						flex: 1,
						editor: {
							xtype: 'combobox',
							queryMode: 'local',
							editable: false,
							allowBlank: false,
							store: [
								'CHECKIN',
								'TRIAGE',
								'PHYSICIAN',
								'TREATMENT',
								'CHECKOUT'
							]
						}
					},
					{
						text: _('facility'),
						dataIndex: 'facility_id',
						flex: 1,
						editor: {
							xtype: 'mitos.facilitiescombo',
							allowBlank: false
						},
						renderer: function (v,m,r) {
							return r.get('facility_name');
						}
					},
					{
						text: _('floor_plan'),
						dataIndex: 'floor_plan_id',
						flex: 1,
						editor: {
							xtype: 'floorplanareascombo'
						},
						renderer: function (v,m,r) {
							return r.get('floor_plan_title');
						}
					},
					{
						text: _('sort'),
						dataIndex: 'sequence',
						editor: {
							xtype: 'numberfield',
							allowBlank: false,
							minValue: 0,
							maxValue: 99
						}
					},
					{
						text: _('active'),
						dataIndex: 'active',
						editor: {
							xtype: 'checkboxfield'
						}
					}
				],
				tbar: [
					'->',
					{
						xtype: 'button',
						text: _('pool_area'),
						iconCls: 'icoAdd',
						itemId: 'PoolAreasPanelAddBtn'
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					store: store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager()
				}
			}
		];

		me.callParent();
	}


});
Ext.define('App.store.administration.ReferringProviders', {
    model: 'App.model.administration.ReferringProvider',
    extend: 'Ext.data.Store'
});
Ext.define('App.model.administration.DecisionAids', {
	extend: 'Ext.data.Model',
	table: {
		name: 'decision_aids_instructions'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'trigger_code',
			type: 'string',
			len: 40,
			index: true
		},
		{
			name: 'instruction_code',
			type: 'string',
			len: 40
		},
		{
			name: 'instruction_code_type',
			type: 'string',
			len: 40
		},
		{
			name: 'instruction_code_description',
			type: 'string',
			len: 600
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'DecisionAids.getDecisionAids',
			create: 'DecisionAids.addDecisionAid',
			update: 'DecisionAids.updateDecisionAid',
			destroy: 'DecisionAids.destroyDecisionAid'
		}
	}
});
Ext.define('App.store.administration.DecisionAids', {
	model: 'App.model.administration.DecisionAids',
	extend: 'Ext.data.Store'
});

Ext.define('App.view.administration.Printers', {
    extend: 'App.ux.RenderPanel',
    pageTitle: _('printers'),
    itemId: 'AdministrationPrinters',
    initComponent: function(){
        var me = this;

        me.store = Ext.create('App.store.administration.Printer', {
            autoSync: false,
            autoLoad: true
        });

        me.grid = Ext.create('Ext.grid.Panel', {
            requires: [
                'Ext.grid.plugin.CellEditing'
            ],
            itemId: 'AdministrationPrintersGrid',
            store: me.store,
            title: _('printers'),
            columnsLines: true,
            plugins: [
                {
                    ptype: 'rowediting'
                }
            ],

            tbar: [
                '->',
                {
                    xtype: 'button',
                    text: _('remove_printer'),
                    iconCls: 'icoDelete',
                    itemId: 'AdministrationPrintersRemoveBtn'
                },
                {
                    xtype: 'button',
                    text: _('add_printer'),
                    iconCls: 'icoAdd',
                    itemId: 'AdministrationPrintersAddBtn'
                }
            ],
            columns: [
                {
                    text: _('facility_id'),
                    dataIndex: 'facility_id',
                    flex: 1,
                    editor: 'mitos.facilitiescombo'
                },
                {
                    text: _('department_id'),
                    dataIndex: 'department_id',
                    flex: 1,
                    editor: 'depatmentscombo'
                },
                {
                    text: _('printer_description'),
                    dataIndex: 'printer_description',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 120
                    }
                },
                {
                    text: _('printer_name'),
                    dataIndex: 'printer_name',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 80
                    }
                },
                {
                    text: _('printer_protocol'),
                    dataIndex: 'printer_protocol',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 10
                    }
                },
                {
                    text: _('printer_options'),
                    dataIndex: 'printer_options',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 250
                    }
                },
                {
                    text: _('printer_host'),
                    dataIndex: 'printer_host',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 180
                    }
                },
                {
                    text: _('printer_port'),
                    dataIndex: 'printer_port',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 10
                    }
                },
                {
                    text: _('printer_uri'),
                    dataIndex: 'printer_uri',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 180
                    }
                },
                {
                    text: _('printer_user'),
                    dataIndex: 'printer_user',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 40
                    }
                },
                {
                    text: _('printer_pass'),
                    dataIndex: 'printer_pass',
                    flex: 1,
                    editor: {
                        xtype: 'textfield',
                        maxLength: 20
                    }
                },
                {
                    text: _('active'),
                    width: 60,
                    sortable: true,
                    renderer: me.boolRenderer,
                    dataIndex: 'active',
                    editor: 'checkbox'
                }
            ],
            bbar: {
                xtype: 'pagingtoolbar',
                pageSize: 50,
                store: me.store,
                displayInfo: true,
                plugins: new Ext.ux.SlidingPager()
            }
        });

        me.pageBody = [ me.grid ];
        me.callParent(arguments);
    }
});
Ext.define('App.model.administration.Printer', {
	extend: 'Ext.data.Model',
	table: {
		name: 'printers'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'facility_id',
			type: 'int',
			index: true
		},
		{
			name: 'department_id',
			type: 'int',
			index: true
		},
		{
			name: 'printer_description',
			type: 'string',
			len: 120
		},
		{
			name: 'printer_name',
			type: 'string',
			len: 80
		},
		{
			name: 'printer_protocol',
			type: 'string',
			len: 10,
			comment: 'lpr or ipp'
		},
		{
			name: 'printer_options',
			type: 'string',
			len: 250
		},
		{
			name: 'printer_host',
			type: 'string',
			len: 180
		},
		{
			name: 'printer_uri',
			type: 'string',
			len: 180
		},
		{
			name: 'printer_user',
			type: 'string',
			len: 40
		},
		{
			name: 'printer_pass',
			type: 'string',
			len: 20
		},
		{
			name: 'active',
			type: 'bool',
			index: true
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'Printer.getPrinters',
			create: 'Printer.addPrinter',
			update: 'Printer.updatePrinter',
			destroy: 'Printer.destroyPrinter'
		}
	}
});
Ext.define('App.store.administration.Printer', {
	extend: 'Ext.data.Store',
	requires: ['App.model.administration.Printer'],
	model: 'App.model.administration.Printer'
});
Ext.define('App.view.administration.SnippetsManager', {
    extend: 'App.ux.RenderPanel',
    pageTitle: 'Snippets Manager',
    requires: [


    ],

    initComponent: function () {
        var me = this;


        me.nurse_store = Ext.create('App.store.administration.NursesNoteSnippets',{
            groupField: 'category'
        });
        me.provider_store = Ext.create('App.store.administration.EncounterSnippets', {
            autoLoad: false,
            pageSize: 1000,
            groupField: 'category'
        });

        me.pageBody = [
            {
                xtype: 'tabpanel',
                items: [
                    {
                        xtype: 'grid',
                        title: 'Nurse Snippets',
                        itemId: 'NursesNoteSnippetsGrid',
                        region: 'west',
                        store: me.nurse_store,
                        features: [{ ftype:'grouping' }],
                        tools: [
                            {
                                xtype: 'button',
                                text: _('snippet'),
                                iconCls: 'icoAdd',
                                itemId: 'NursesNoteSnippetAddBtn'
                            }
                        ],
                        columns: [
                            {
                                text: _('edit'),
                                width: 25,
                                menuDisabled: true,
                                xtype: 'actioncolumn',
                                tooltip: 'Edit Snippet',
                                align: 'center',
                                icon: 'resources/images/icons/edit.png',
                                handler: function(grid, rowIndex, colIndex, actionItem, event, record){
                                    var snippetCtrl = app.getController('patient.NursesNotes');
                                    snippetCtrl.onSnippetBtnEdit(grid, rowIndex, colIndex, actionItem, event, record);
                                }
                            },
                            {
                                text: _('description'),
                                dataIndex: 'description',
                                flex: 1
                            }
                        ],
                        tbar: [
                            '->',
                            {
                                xtype: 'button',
                                text: _('snippet'),
                                iconCls: 'icoAdd',
                                itemId: 'NursesNoteSnippetAddBtn'
                            }
                        ],
                        bbar: {
                            xtype: 'pagingtoolbar',
                            pageSize: 10,
                            store: me.nurse_store,
                            displayInfo: true,
                            plugins: new Ext.ux.SlidingPager()
                        }
                    },
                    {
                        xtype: 'grid',
                        title: 'Provider Snippets',
                        itemId: 'SnippetsTreePanel',
                        store: me.provider_store,
                        features: [{ ftype:'grouping' }],
                        tools: [
                            {
                                xtype: 'button',
                                text: _('snippet'),
                                iconCls: 'icoAdd',
                                itemId: 'SnippetAddBtn'
                            }
                        ],
                        columns: [
                            {
                                text: _('edit'),
                                width: 25,
                                menuDisabled: true,
                                xtype: 'actioncolumn',
                                tooltip: 'Edit Snippet',
                                align: 'center',
                                icon: 'resources/images/icons/edit.png',
                                handler: function(grid, rowIndex, colIndex, actionItem, event, record){
                                    var snippetCtrl = app.getController('administration.EncounterSnippets');
                                    snippetCtrl.onSnippetBtnEdit(grid, rowIndex, colIndex, actionItem, event, record);
                                }
                            },
                            {
                                text: _('description'),
                                dataIndex: 'description',
                                flex: 1
                            }
                        ],
                        tbar: [
                            {
                                xtype: 'specialtiescombo',
                                itemId: 'SoapTemplateSpecialtiesCombo',
                                flex: 1
                            },
                            {
                                xtype: 'button',
                                text: _('snippet'),
                                iconCls: 'icoAdd',
                                itemId: 'SnippetAddBtn'
                            }
                        ],
                        bbar: {
                            xtype: 'pagingtoolbar',
                            pageSize: 10,
                            store: me.provider_store,
                            displayInfo: true,
                            plugins: new Ext.ux.SlidingPager()
                        }
                    }
                ]
            }

        ];

        me.callParent();
    }
});
//ens servicesPage class

Ext.define('App.model.administration.NursesNoteSnippet', {
	extend: 'Ext.data.Model',
	table: {
		name: 'nurses_note_snippets'
	},
	fields: [
		{
			name: 'id',
			type: 'string'
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'index',
			type: 'int'
		},
		{
			name: 'description',
			type: 'string',
			len: 80
		},
		{
			name: 'category',
			type: 'string',
			len: 50
		},
		{
			name: 'snippet',
			type: 'string',
			dataType: 'text'
		},
		{
			name: 'create_uid',
			type: 'int'
		},
		{
			name: 'update_uid',
			type: 'int'
		},
		{
			name: 'create_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			dateFormat: 'Y-m-d H:i:s'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'NursesNotes.getNursesNoteSnippets',
			create: 'NursesNotes.addNursesNoteSnippet',
			update: 'NursesNotes.updateNursesNoteSnippet',
			destroy: 'NursesNotes.deleteNursesNoteSnippet'
		}
	}
});
Ext.define('App.store.administration.NursesNoteSnippets', {
	model: 'App.model.administration.NursesNoteSnippet',
	extend: 'Ext.data.Store'
});

Ext.define('App.model.administration.AuditLog', {
	extend: 'Ext.data.Model',
	table: {
		name: 'audit_log'
	},
	fields: [
		{
			name: 'id',
			type: 'int'
		},
		{
			name: 'eid',
			type: 'int',
			index: true
		},
		{
			name: 'pid',
			type: 'int',
			index: true
		},
		{
			name: 'uid',
			type: 'int',
			index: true
		},
		{
			name: 'foreign_id',
			type: 'string',
			index: true
		},
		{
			name: 'foreign_table',
			type: 'string',
			len: 80
		},
		{
			name: 'event',
			type: 'string',
			index: true,
			len: 80
		},
		{
			name: 'event_description',
			type: 'string',
			index: true,
			len: 200
		},
		{
			name: 'event_date',
			type: 'date',
			format: 'Y-m-d H:i:s'
		},
		{
			name: 'ip',
			type: 'string',
			len: 40
		},
		{
			name: 'user_fname',
			type: 'string',
			store: false
		},
		{
			name: 'user_mname',
			type: 'string',
			store: false
		},
		{
			name: 'user_lname',
			type: 'string',
			store: false
		},
		{
			name: 'user_name',
			type: 'string',
			convert: function(val, rec){
				return rec.data.user_lname + ', ' + rec.data.user_fname + ' ' + rec.data.user_mname
			},
			store: false
		},
		{
			name: 'patient_lname',
			type: 'string',
			store: false
		},
		{
			name: 'patient_fname',
			type: 'string',
			store: false
		},
		{
			name: 'patient_mname',
			type: 'string',
			store: false
		},
		{
			name: 'patient_name',
			type: 'string',
			convert: function (v, record) {
				var str = '';
				if (record.data.patient_lname) str += record.data.patient_lname + ', ';
				if (record.data.patient_fname) str += record.data.patient_fname + ' ';
				if (record.data.patient_mname) str += record.data.patient_mname;
				return str;
			},
			store: false
		},
		{
			name: 'site',
			type: 'string',
			store: false
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'AuditLog.getLog'
		},
		reader: {
			root: 'data'
		}
	}
});

Ext.define('App.store.administration.AuditLogs', {
    model: 'App.model.administration.AuditLog',
    extend: 'Ext.data.Store'
});
Ext.define('App.ux.combo.LayoutForms', {
	extend: 'Ext.form.ComboBox',
	xtype: 'layoutformscombo',
	editable: false,
	valueField: 'id',
	displayField: 'name',
	emptyText: _('select'),
	initComponent: function(){
		var me = this;

		me.store = Ext.create('Ext.data.Store', {
			autoLoad: true,
			model : 'App.model.administration.FormsList'
		});

		me.callParent();
	}
});

Ext.define("App.model.miscellaneous.webSearch",
	{
		extend: 'Ext.data.Model',
		table: {
			name: 'websearch',
			comment: 'Web Search'
		},
		fields: [
			{
				name: 'id',
				type: 'int',
				comment: 'Web Search ID'
			},
			{
				name: 'title',
				type: 'string'
			},
			{
				name: 'source',
				type: 'string'
			},
			{
				name: 'FullSummary',
				type: 'string'
			},
			{
				name: 'snippet',
				type: 'string'
			}
		]
	});
Ext.define('App.store.miscellaneous.webSearch', {
    model: 'App.model.miscellaneous.webSearch',
    extend: 'Ext.data.Store',
    proxy :
    {
        type : 'ajax',
        url : 'dataProvider/WebSearch.php',
        noCache : false,
        startParam : 'retstart',
        limitParam : 'retmax',
        pageParam : 'file',
        reader :
        {
            type : 'json',
            root : 'row',
            totalProperty : 'totals',
            idProperty : 'id'
        }
    }
});
Ext.define('App.model.miscellaneous.Users', {
	extend: 'Ext.data.Model',
	fields: [
		{
			name: 'id',
			type: 'int',
			comment: 'User Account ID'
		},
		{
			name: 'create_uid',
			type: 'int',
			comment: 'create user ID'
		},
		{
			name: 'update_uid',
			type: 'int',
			comment: 'update user ID'
		},
		{
			name: 'create_date',
			type: 'date',
			comment: 'create date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'update_date',
			type: 'date',
			comment: 'last update date',
			dateFormat: 'Y-m-d H:i:s'
		},
		{
			name: 'username',
			type: 'string',
			comment: 'username'
		},
		{
			name: 'title',
			type: 'string',
			comment: 'title (Mr. Mrs.)'
		},
		{
			name: 'fname',
			type: 'string',
			comment: 'first name'
		},
		{
			name: 'mname',
			type: 'string',
			comment: 'middle name'
		},
		{
			name: 'lname',
			type: 'string',
			comment: 'last name'
		},
		{
			name: 'pin',
			type: 'string',
			comment: 'pin number'
		},
		{
			name: 'npi',
			type: 'string',
			comment: 'National Provider Identifier'
		},
		{
			name: 'fedtaxid',
			type: 'string',
			comment: 'federal tax id'
		},
		{
			name: 'feddrugid',
			type: 'string',
			comment: 'federal drug id'
		},
		{
			name: 'email',
			type: 'string',
			comment: 'email'
		},
		{
			name: 'specialty',
			type: 'string',
			comment: 'specialty'
		},
		{
			name: 'taxonomy',
			type: 'string',
			comment: 'taxonomy',
			defaultValue: '207Q00000X'
		},
		{
			name: 'facility_id',
			type: 'int'
		}
	],
	proxy: {
		type: 'direct',
		api: {
			read: 'User.getCurrentUserData',
			update: 'User.updateUser'
		}
	}
});
Ext.define('App.store.miscellaneous.Users', {
    model     : 'App.model.miscellaneous.Users',
    extend    : 'Ext.data.Store',
    proxy :
    {
        type : 'direct',
        api :
        {
            read : User.getCurrentUserData,
            update : User.getCurrentUserData
        }
    }
});
Ext.define('App.view.reports.ReportsPanel', {
	extend: 'App.ux.RenderPanel',
	pageTitle: _('reports'),
	itemId: 'ReportsPanel',
	requires: [

	],
	initComponent: function () {
		var me = this;

		me.store = Ext.create('App.store.reports.Reports', {
			remoteFilter: true,
			remoteSort: true,
			groupField: 'category'
		});

		me.pageBody = [
			{
				xtype: 'grid',
				frame: true,
				title: _('reports'),
				itemId: 'ReportsGrid',
				store: me.store,
				features: [{ftype:'grouping'}],
				tools: [
					{
						xtype:'button',
						text: _('report'),
						iconCls: 'icoAdd',
						itemId: 'AdministrationReportsAddBtn',
						acl: a('access_admin_reports')
					}
				],
				columns: [
					{
						text: _('category'),
						dataIndex: 'category',
						width: 300
					},
					{
						text: _('title'),
						dataIndex: 'title',
						width: 300
					},
					{
						text: _('description'),
						dataIndex: 'description',
						flex: 1
					},
					{
						text: _('description'),
						dataIndex: 'store_procedure_name',
						width: 300,
						hidden: true
					}
				],
				bbar: {
					xtype: 'pagingtoolbar',
					pageSize: 10,
					store: me.store,
					displayInfo: true,
					plugins: new Ext.ux.SlidingPager()
				}
			}
		];

		me.callParent(arguments);

	}
});

Ext.define('App.model.reports.Report',{
    extend: 'Ext.data.Model',
    table: {
        name: 'reports'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'category',
            type: 'string'
        },
        {
            name: 'title',
            type: 'string'
        },
        {
            name: 'description',
            type: 'string'
        },
        {
            name: 'store_procedure_name',
            type: 'string'
        },
        {
            name: 'parameters',
            type: 'auto'
        },
        {
            name: 'group_fields',
            type: 'string'
        },
        {
            name: 'report_perm',
            type: 'string'
        },
        {
            name: 'columns',
            type: 'string'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Reports.getReports',
            create: 'Reports.addReport',
            update: 'Reports.updateReport',
            destroy: 'Reports.deleteReport'
        },
	    reader:{
		    root: 'data'
	    }
    }
});

Ext.define('App.store.reports.Reports', {
    model: 'App.model.reports.Report',
    extend: 'Ext.data.Store'
});
Ext.define('App.view.patient.AlertWindow', {
	extend: 'Ext.window.Window',
	requires: [
		'Ext.grid.plugin.RowEditing'
	],
	title: _('reminders_alerts'),
	width: 700,
	closeAction: 'hide',
	initComponent: function(){

		var me = this;

		me.items = [
			{
				xtype: 'grid',
				itemId: 'AlertsAlertGrid',
				margin: 5,
				frame : true,
				store: Ext.create('App.store.patient.Alerts'),
				plugins: {
					ptype: 'cellediting',
					autoCancel: false,
					errorSummary: false,
					clicksToEdit: 2
				},
				columns: [
					{
						xtype: 'datecolumn',
						text: _('date'),
						format: g('date_display_format'),
						dataIndex: 'date'
					},
					{
						text: _('note'),
						dataIndex: 'body',
						flex: 1
					},
					{
						text: _('active'),
						width: 50,
						dataIndex: 'active',
						renderer: function(v, m, r){
							return app.boolRenderer(v, m, r);
						},
						editor: {
							xtype: 'checkbox'
						}
					}
				]
			}
		];

		me.callParent();

	},
	buttons: [
		'->',
		{
			text: _('ok'),
			itemId: 'AlertsAlertOkBtn'
		},
		'-',
		{
			text: _('cancel'),
			itemId: 'AlertsAlertCancelBtn'
		}
	]
});
Ext.define('App.model.patient.InsuranceCover',{
    extend: 'Ext.data.Model',
    table: {
        name: 'patient_insurance_covers',
        comment: 'Patient Insurance_covers'
    },
    fields: [
        {
            name: 'id',
            type: 'int'
        },
        {
            name: 'patient_insurance_id',
            type: 'int'
        },
        {
            name: 'service_type_id',
            type: 'int'
        },
        {
            name: 'isDollar',
            type: 'bool'
        },
        {
            name: 'copay',
            type: 'float'
        },
        {
            name: 'exception_isDollar',
            type: 'bool'
        },
        {
            name: 'exception_copay',
            type: 'float'
        },
        {
            name: 'exception',
            type: 'bool'
        },
        {
            name: 'active',
            type: 'bool'
        },
        {
            name: 'create_uid',
            type: 'int'
        },
        {
            name: 'update_uid',
            type: 'int'
        },
        {
            name: 'department_id',
            type: 'string',
            store: false
        },
        {
            name: 'department_title',
            type: 'string',
            store: false
        },
        {
            name: 'specialty_id',
            type: 'string',
            store: false
        },
        {
            name: 'specialty_title',
            type: 'string',
            store: false
        },
        {
            name: 'service_type_description',
            type: 'string',
            store: false
        },
        {
            name: 'create_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        },
        {
            name: 'update_date',
            type: 'date',
            dateFormat: 'Y-m-d H:i:s'
        }
    ],
    proxy: {
        type: 'direct',
        api: {
            read: 'Insurance.getInsuranceCovers',
            create: 'Insurance.addInsuranceCover',
            update: 'Insurance.updateInsuranceCover',
            destroy: 'Insurance.destroyInsuranceCover'
        },
        writer: {
            writeAllFields: true
        }
    },
    associations: [
        {
            type: 'belongsTo',
            model: 'App.model.patient.Patient',
            associationKey: 'pid',
            foreignKey: 'pid'
        }
    ]
});

Ext.define('App.store.patient.InsuranceCovers', {
    extend: 'Ext.data.Store',
    model: 'App.model.patient.InsuranceCover'
});

Ext.define('App.view.patient.windows.EncounterTemplatePanels', {
	extend: 'App.ux.window.Window',
	title: _('templates'),
	closeAction: 'hide',
	layout: 'fit',
	modal: true,
	width: 600,
	height: 500,
	itemId: 'TemplatePanelsWindow',
	bodyPadding: 5,
	tbar: [
		{
			xtype: 'combobox',
			store: Ext.create('App.store.administration.EncounterTemplatePanels'),
			displayField: 'description',
			valueField: 'id',
			itemId: 'TemplatePanelsCombo',
			width: 300,
			editable: false,
			allowBlank: false,
			queryMode: 'local'
		}
	],
	items: [
		{
			xtype: 'grid',
			frame: true,
			itemId: 'TemplatePanelsGrid',
			selType: 'checkboxmodel',
			features: [
				{
					ftype:'grouping',
					groupHeaderTpl: '{name}',
					collapsible: false
				}
			],
			columns: [
				{
					text: _('description'),
					dataIndex: 'description',
					flex: 1,
					sortable: false,
					groupable: false,
					hideable: false,
					menuDisabled: true
				}
			]
		}
	],
	buttons: [
		{
			text: _('add'),
			itemId: 'TemplatePanelsAddBtn'
		},
		{
			text: _('cancel'),
			itemId: 'TemplatePanelsCancelBtn'
		}
	]
});

Ext.define('App.view.patient.windows.DocumentWindow', {
	extend: 'Ext.window.Window',
	requires: [
		'App.view.patient.Documents'
	],
	title: _('patient_documents'),
	itemId: 'DocumentWindow',
	layout: 'fit',
	height: 700,
	width: 1000,
	// closeAction: 'hide',
	maximizable: true,
	items: [
		{
			xtype: 'patientdocumentspanel',
			title: null
		}
	]
});
Ext.define('App.ux.form.fields.plugin.MacroRecorder', {
	extend: 'Ext.AbstractPlugin',
	alias: 'plugin.macrorecorder',

	init: function (field) {
		field.recording = false;
		field.enableKeyEvents = true;
		field.on('keydown', this.onKeyDown, this);
		field.on('keyup', this.onKeyUp, this);
	},
	
	metaKey: false,

	isFKey: function (key) {
		return key >= 112 && key <= 123;
	},

	onKeyUp: function (field, e) {
		if(e.getKey() == 91){
			this.metaKey = false;
		}
	},

	onKeyDown: function (field, e) {

		e.preventDefault();

		var key = e.getKey(),
			char = String.fromCharCode(e.getKey()),
			isFKey = this.isFKey(key),
			value = [];

		say(key);
		say(char);

		if(key == 91 || key == 224) {
			this.metaKey = true;
		}
		if(key == 8){
			field.setValue('');
			return;
		}

		if(!isFKey && (e.isSpecialKey() || char.search(/[A-Z0-9]/) === -1)){
			return;
		}

		if(this.metaKey){
			value.push('META');
		}
		if(e.altKey){
			value.push('ALT');
		}
		if(e.ctrlKey && !this.metaKey){
			value.push('CTRL');
		}
		if(e.shiftKey){
			value.push('SHIFT');
		}

		if(value.length === 0 && !isFKey){
			return;
		}

		value = value.sort();

		if(isFKey){
			switch (key){
				case 112:
					value.push('F1');
					break;
				case 113:
					value.push('F2');
					break;
				case 114:
					value.push('F3');
					break;
				case 115:
					value.push('F4');
					break;
				case 116:
					value.push('F5');
					break;
				case 117:
					value.push('F6');
					break;
				case 118:
					value.push('F7');
					break;
				case 119:
					value.push('F8');
					break;
				case 120:
					value.push('F9');
					break;
				case 121:
					value.push('F10');
					break;
				case 122:
					value.push('F11');
					break;
				case 123:
					value.push('F12');
					break;
			}
		}else {
			value.push(char);
		}

		field.setValue(value.join('-'));
	}
});