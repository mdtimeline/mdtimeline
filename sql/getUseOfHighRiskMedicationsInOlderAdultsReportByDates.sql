DROP PROCEDURE IF EXISTS `getUseOfHighRiskMedicationsInOlderAdultsReportByDates`;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `getUseOfHighRiskMedicationsInOlderAdultsReportByDates`(IN provider_id INT, IN insurance_id INT, IN start_date DATE, IN end_date DATE, IN sex CHAR)
BEGIN

    DROP TABLE IF EXISTS report_ds;
    DROP TABLE IF EXISTS report_denominator_ds;
    DROP TABLE IF EXISTS report_numerator_ds;

#     SET @provider_id = 2619;
#     SET @insurance_id = 1;
#     SET @start_date = '2020-01-01';
#     SET @end_date = '2024-01-01';

    SET @provider = (SELECT CONCAT(title, ' ', lname, ', ', fname, ' ', mname, ' (NPI:', npi, ')') FROM users WHERE id = provider_id);
    SET @insurance = (SELECT CONCAT(name, ' ', ' (CODE:', insurance_companies.code, ')') FROM insurance_companies WHERE id = insurance_id);

    IF insurance_id > 0
        THEN
            CREATE TEMPORARY TABLE report_ds
            SELECT
                e.pid,
                IF( e.RXCUI IN ('1000351', '1000352', '1000355', '1000356', '1000395', '1000398', '1000486',
                                '1000490', '1000496', '1010696', '1012904', '1013619', '1014331', '1020477',
                                '1037234', '1041814', '1042684', '1042688', '1042693', '1043400', '1046384',
                                '1046751', '1046770', '1046781', '1046787', '1046799', '1046815', '1046982',
                                '1046985', '1046997', '1047786', '1047881', '1047895', '1047905', '1047916',
                                '1048124', '1048147', '1048307', '1048336', '1049289', '1049630', '1049633',
                                '1049900', '1049906', '1049909', '1050325', '1050385', '1052462', '1052467',
                                '1052679', '1052928', '1053258', '1053618', '1053624', '1085945', '1086443',
                                '1086463', '1086720', '1086750', '1086991', '1087365', '1087459', '1087607',
                                '1088934', '1088936', '1089968', '1090443', '1090463', '1090699', '1092189',
                                '1092373', '1092398', '1092566', '1093098', '1094131', '1094434', '1094549',
                                '1098443', '1098496', '1098497', '1098498', '1099288', '1099292', '1099296',
                                '1099300', '1099304', '1099308', '1099316', '1099446', '1099653', '1099668',
                                '1099872', '1099948', '1101555', '1111065', '1111171', '1111440', '1112220',
                                '1112489', '1112864', '1112906', '1112908', '1113397', '1113522', '1113998',
                                '1114361', '1114838', '1116173', '1117245', '1117392', '1147619', '1147795',
                                '1148155', '1149632', '1190174', '1190448', '1190538', '1190540', '1190542',
                                '1190546', '1190551', '1190552', '1190568', '1190572', '1190580', '1190600',
                                '1190738', '1190748', '1190776', '1190793', '1190795', '1190931', '1192477',
                                '1193293', '1233546', '1233575', '1234386', '1234941', '1236048', '1242240',
                                '1244523', '1244951', '1245184', '1245291', '1245706', '1245722', '1248057',
                                '1248354', '1249617', '1250907', '1250983', '1251493', '1251499', '1251614',
                                '1251802', '1251811', '1251928', '1292342', '1293239', '1293344', '1293487',
                                '1294201', '1294348', '1294567', '1297288', '1297390', '1297404', '1297517',
                                '1297947', '1298226', '1298348', '1298433', '1298799', '1298834', '1299143',
                                '1299646', '1299662', '1300164', '1300195', '1303797', '1304105', '1310503',
                                '1313969', '1356113', '1356797', '1356800', '1356804', '1356807', '1356812',
                                '1356815', '1356838', '1356841', '1356848', '1357010', '1357013', '1357553',
                                '1357883', '1357894', '1359114', '1359123', '1359124', '1359126', '1359127',
                                '1363288', '1363306', '1363309', '1363513', '1363752', '1363780', '1366022',
                                '1366653', '1366825', '1366948', '1367219', '1367225', '1367227', '1368963',
                                '1369403', '1369424', '1369971', '1369972', '1370125', '1370963', '1372265',
                                '1372312', '1374770', '1375932', '1421985', '1423702', '1423711', '1424551',
                                '1424850', '1424872', '1428880', '1428927', '1429345', '1430122', '1430522',
                                '1431286', '1440003', '1440869', '1441376', '1441392', '1483549', '1483550',
                                '1483552', '1483553', '1486964', '1489310', '1490671', '1490727', '1491529',
                                '1491637', '1491649', '1492052', '1492380', '1535609', '1535923', '1536477',
                                '1536840', '1536862', '1536931', '1536999', '1537029', '1537095', '1537767',
                                '1537803', '1537807', '1537811', '1539185', '1541630', '1545306', '1545309',
                                '1546700', '1546881', '1550957', '1551286', '1593105', '1593110', '1595631',
                                '1598634', '1606291', '1652087', '1655058', '1655060', '1659175', '1659960',
                                '1661319', '1663815', '1664543', '1665459', '1665461', '1665675', '1665679',
                                '1665682', '1665685', '1665690', '1665697', '1665699', '1665701', '1666116',
                                '1666781', '1723740', '1723776', '1724446', '1727571', '1730190', '1730192',
                                '1738483', '1738495', '1738503', '1738511', '1738515', '1738519', '1738523',
                                '1738527', '1738803', '1738805', '1738807', '1741529', '1789508', '1789740',
                                '1794552', '1794554', '1795581', '1797855', '1798453', '1799180', '1800670',
                                '1801964', '1803669', '1804449', '1807886', '1812101', '1855193', '1876117',
                                '1926601', '1926926', '1939343', '1939354', '1944254', '1946979', '197363',
                                '197364', '197365', '197366', '197426', '197446', '197447', '197495', '197496',
                                '197501', '197502', '197622', '197657', '197658', '197659', '197660', '197661',
                                '197662', '197666', '197667', '197668', '197669', '197670', '197737', '197745',
                                '197746', '197817', '197818', '197928', '197929', '197935', '197943', '197944',
                                '197956', '197958', '197960', '197963', '198032', '198033', '198045', '198046',
                                '198047', '198083', '198085', '198086', '198089', '198165', '198277', '198278',
                                '198368', '198602', '198603', '1990881', '199164', '199167', '199168', '1993219',
                                '1993220', '1996098', '2003130', '2003179', '2049841', '205333', '2056893',
                                '208545', '2108924', '2121065', '2167740', '2173662', '2173667', '2181304',
                                '2181307', '2183687', '2183697', '2183701', '2183907', '2184108', '2371764',
                                '2371767', '238003', '238004', '238006', '238134', '238135', '238153', '238154',
                                '2383312', '2391334', '241527', '241946', '242333', '242891', '242892', '248478',
                                '309913', '309914', '309952', '309955', '309958', '309960', '310197', '310212',
                                '310213', '310215', '310534', '310536', '310537', '310539', '310991', '310992',
                                '312036', '312242', '312357', '312362', '312370', '313385', '313386', '313387',
                                '313389', '313391', '313393', '313396', '313496', '313498', '313499', '314000',
                                '314267', '315234', '315235', '317136', '347151', '348906', '351254', '359281',
                                '359329', '402250', '403849', '403922', '403923', '476545', '477045', '577027',
                                '577029', '577154', '604664', '636568', '636793', '636794', '700851', '700949',
                                '702519', '727415', '728118', '728581', '730794', '731032', '749850', '828299',
                                '828320', '828348', '828353', '828358', '834022', '835564', '835568', '835572',
                                '835577', '835589', '835591', '835593', '856706', '856720', '856762', '856769',
                                '856773', '856783', '856792', '856797', '856825', '856834', '856840', '856845',
                                '856853', '857297', '857301', '857305', '857416', '857420', '857430', '857461',
                                '857510', '857512', '860092', '860096', '860113', '860114', '860115', '860215',
                                '860221', '860225', '860792', '861447', '861455', '861459', '861463', '861467',
                                '861473', '861476', '861479', '861493', '861494', '861743', '861748', '861753',
                                '862006', '862013', '862019', '862025', '866021', '866144', '882504', '885209',
                                '885213', '885219', '889520', '889614', '895664', '901814', '905168', '905172',
                                '905269', '905273', '905283', '978941', '978944', '978946', '978948', '978949',
                                '991061', '991065', '991082', '991086', '991486', '991528', '992432', '992438',
                                '992447', '992460', '992475', '992858', '993943', '994226', '994289', '994402',
                                '995041', '995065', '995068', '995071', '995075', '995079', '995082', '995086',
                                '995093', '995108', '995116', '995120', '995123', '995128', '995218', '995232',
                                '995241', '995258', '995270', '995278', '995281', '995285', '995624', '995632',
                                '995666', '995686', '996757', '996998', '998254', '998726')
                        AND e.total > 1,
                    '1', '0') as medication_was_prescribed
            FROM
                (SELECT enc.pid, pm.RXCUI, COUNT(pm.RXCUI) AS total
                FROM encounters as enc
                INNER JOIN patient p ON enc.pid = p.pid
                LEFT JOIN patient_medications AS pm ON enc.pid = pm.pid AND enc.eid = pm.eid
                INNER JOIN patient_insurances AS pi ON p.pid = pi.pid
                WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND (sex IS NULL OR p.sex = sex)
                AND YEAR(enc.service_date) - YEAR(p.DOB) - (RIGHT(enc.service_date, 5) < RIGHT(p.DOB, 5)) >= 65
                AND pi.insurance_id = insurance_id
                GROUP BY enc.pid, pm.RXCUI) e;
        ELSE

            CREATE TEMPORARY TABLE report_ds
            SELECT
                e.pid,
                IF( e.RXCUI IN ('1000351', '1000352', '1000355', '1000356', '1000395', '1000398', '1000486',
                                '1000490', '1000496', '1010696', '1012904', '1013619', '1014331', '1020477',
                                '1037234', '1041814', '1042684', '1042688', '1042693', '1043400', '1046384',
                                '1046751', '1046770', '1046781', '1046787', '1046799', '1046815', '1046982',
                                '1046985', '1046997', '1047786', '1047881', '1047895', '1047905', '1047916',
                                '1048124', '1048147', '1048307', '1048336', '1049289', '1049630', '1049633',
                                '1049900', '1049906', '1049909', '1050325', '1050385', '1052462', '1052467',
                                '1052679', '1052928', '1053258', '1053618', '1053624', '1085945', '1086443',
                                '1086463', '1086720', '1086750', '1086991', '1087365', '1087459', '1087607',
                                '1088934', '1088936', '1089968', '1090443', '1090463', '1090699', '1092189',
                                '1092373', '1092398', '1092566', '1093098', '1094131', '1094434', '1094549',
                                '1098443', '1098496', '1098497', '1098498', '1099288', '1099292', '1099296',
                                '1099300', '1099304', '1099308', '1099316', '1099446', '1099653', '1099668',
                                '1099872', '1099948', '1101555', '1111065', '1111171', '1111440', '1112220',
                                '1112489', '1112864', '1112906', '1112908', '1113397', '1113522', '1113998',
                                '1114361', '1114838', '1116173', '1117245', '1117392', '1147619', '1147795',
                                '1148155', '1149632', '1190174', '1190448', '1190538', '1190540', '1190542',
                                '1190546', '1190551', '1190552', '1190568', '1190572', '1190580', '1190600',
                                '1190738', '1190748', '1190776', '1190793', '1190795', '1190931', '1192477',
                                '1193293', '1233546', '1233575', '1234386', '1234941', '1236048', '1242240',
                                '1244523', '1244951', '1245184', '1245291', '1245706', '1245722', '1248057',
                                '1248354', '1249617', '1250907', '1250983', '1251493', '1251499', '1251614',
                                '1251802', '1251811', '1251928', '1292342', '1293239', '1293344', '1293487',
                                '1294201', '1294348', '1294567', '1297288', '1297390', '1297404', '1297517',
                                '1297947', '1298226', '1298348', '1298433', '1298799', '1298834', '1299143',
                                '1299646', '1299662', '1300164', '1300195', '1303797', '1304105', '1310503',
                                '1313969', '1356113', '1356797', '1356800', '1356804', '1356807', '1356812',
                                '1356815', '1356838', '1356841', '1356848', '1357010', '1357013', '1357553',
                                '1357883', '1357894', '1359114', '1359123', '1359124', '1359126', '1359127',
                                '1363288', '1363306', '1363309', '1363513', '1363752', '1363780', '1366022',
                                '1366653', '1366825', '1366948', '1367219', '1367225', '1367227', '1368963',
                                '1369403', '1369424', '1369971', '1369972', '1370125', '1370963', '1372265',
                                '1372312', '1374770', '1375932', '1421985', '1423702', '1423711', '1424551',
                                '1424850', '1424872', '1428880', '1428927', '1429345', '1430122', '1430522',
                                '1431286', '1440003', '1440869', '1441376', '1441392', '1483549', '1483550',
                                '1483552', '1483553', '1486964', '1489310', '1490671', '1490727', '1491529',
                                '1491637', '1491649', '1492052', '1492380', '1535609', '1535923', '1536477',
                                '1536840', '1536862', '1536931', '1536999', '1537029', '1537095', '1537767',
                                '1537803', '1537807', '1537811', '1539185', '1541630', '1545306', '1545309',
                                '1546700', '1546881', '1550957', '1551286', '1593105', '1593110', '1595631',
                                '1598634', '1606291', '1652087', '1655058', '1655060', '1659175', '1659960',
                                '1661319', '1663815', '1664543', '1665459', '1665461', '1665675', '1665679',
                                '1665682', '1665685', '1665690', '1665697', '1665699', '1665701', '1666116',
                                '1666781', '1723740', '1723776', '1724446', '1727571', '1730190', '1730192',
                                '1738483', '1738495', '1738503', '1738511', '1738515', '1738519', '1738523',
                                '1738527', '1738803', '1738805', '1738807', '1741529', '1789508', '1789740',
                                '1794552', '1794554', '1795581', '1797855', '1798453', '1799180', '1800670',
                                '1801964', '1803669', '1804449', '1807886', '1812101', '1855193', '1876117',
                                '1926601', '1926926', '1939343', '1939354', '1944254', '1946979', '197363',
                                '197364', '197365', '197366', '197426', '197446', '197447', '197495', '197496',
                                '197501', '197502', '197622', '197657', '197658', '197659', '197660', '197661',
                                '197662', '197666', '197667', '197668', '197669', '197670', '197737', '197745',
                                '197746', '197817', '197818', '197928', '197929', '197935', '197943', '197944',
                                '197956', '197958', '197960', '197963', '198032', '198033', '198045', '198046',
                                '198047', '198083', '198085', '198086', '198089', '198165', '198277', '198278',
                                '198368', '198602', '198603', '1990881', '199164', '199167', '199168', '1993219',
                                '1993220', '1996098', '2003130', '2003179', '2049841', '205333', '2056893',
                                '208545', '2108924', '2121065', '2167740', '2173662', '2173667', '2181304',
                                '2181307', '2183687', '2183697', '2183701', '2183907', '2184108', '2371764',
                                '2371767', '238003', '238004', '238006', '238134', '238135', '238153', '238154',
                                '2383312', '2391334', '241527', '241946', '242333', '242891', '242892', '248478',
                                '309913', '309914', '309952', '309955', '309958', '309960', '310197', '310212',
                                '310213', '310215', '310534', '310536', '310537', '310539', '310991', '310992',
                                '312036', '312242', '312357', '312362', '312370', '313385', '313386', '313387',
                                '313389', '313391', '313393', '313396', '313496', '313498', '313499', '314000',
                                '314267', '315234', '315235', '317136', '347151', '348906', '351254', '359281',
                                '359329', '402250', '403849', '403922', '403923', '476545', '477045', '577027',
                                '577029', '577154', '604664', '636568', '636793', '636794', '700851', '700949',
                                '702519', '727415', '728118', '728581', '730794', '731032', '749850', '828299',
                                '828320', '828348', '828353', '828358', '834022', '835564', '835568', '835572',
                                '835577', '835589', '835591', '835593', '856706', '856720', '856762', '856769',
                                '856773', '856783', '856792', '856797', '856825', '856834', '856840', '856845',
                                '856853', '857297', '857301', '857305', '857416', '857420', '857430', '857461',
                                '857510', '857512', '860092', '860096', '860113', '860114', '860115', '860215',
                                '860221', '860225', '860792', '861447', '861455', '861459', '861463', '861467',
                                '861473', '861476', '861479', '861493', '861494', '861743', '861748', '861753',
                                '862006', '862013', '862019', '862025', '866021', '866144', '882504', '885209',
                                '885213', '885219', '889520', '889614', '895664', '901814', '905168', '905172',
                                '905269', '905273', '905283', '978941', '978944', '978946', '978948', '978949',
                                '991061', '991065', '991082', '991086', '991486', '991528', '992432', '992438',
                                '992447', '992460', '992475', '992858', '993943', '994226', '994289', '994402',
                                '995041', '995065', '995068', '995071', '995075', '995079', '995082', '995086',
                                '995093', '995108', '995116', '995120', '995123', '995128', '995218', '995232',
                                '995241', '995258', '995270', '995278', '995281', '995285', '995624', '995632',
                                '995666', '995686', '996757', '996998', '998254', '998726')
                        AND e.total > 1,
                    '1', '0') as medication_was_prescribed
            FROM
                (SELECT enc.pid, pm.RXCUI, COUNT(pm.RXCUI) AS total
                FROM encounters as enc
                INNER JOIN patient p ON enc.pid = p.pid
                LEFT JOIN patient_medications AS pm ON enc.pid = pm.pid AND enc.eid = pm.eid
                WHERE enc.provider_uid = provider_id
                AND enc.service_date BETWEEN start_date AND end_date
                AND (sex IS NULL OR p.sex = sex)
                AND YEAR(enc.service_date) - YEAR(p.DOB) - (RIGHT(enc.service_date, 5) < RIGHT(p.DOB, 5)) >= 65
                GROUP BY enc.pid, pm.RXCUI) e;
        END IF;


        CREATE TEMPORARY TABLE report_denominator_ds
        SELECT 1 as `value`, pid FROM report_ds  GROUP BY pid;

        CREATE TEMPORARY TABLE report_numerator_ds
        SELECT 1 as `value`, pid FROM report_ds WHERE medication_was_prescribed = '1' GROUP BY pid;

        SET @denominator = (SELECT sum(`value`) FROM report_denominator_ds);
        SET @numerator = (SELECT sum(`value`) FROM report_numerator_ds);
        SET @denominator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_denominator_ds GROUP BY pid) as d);
        SET @numerator_pids = (SELECT group_concat(pid) FROM (SELECT pid FROM report_numerator_ds GROUP BY pid) as n);

        SELECT
            @provider as provider,
            @insurance as insurance,
            'MIPS' as title,
            @denominator as denominator,
            @denominator_pids as denominator_pids,
            @numerator as numerator,
            @numerator_pids as numerator_pids;

END$$

DELIMITER ;